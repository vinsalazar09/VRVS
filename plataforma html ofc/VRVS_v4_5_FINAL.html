<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† VRVS v4.4 ‚Äî TEOT 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-turquesa: #0d9488;
            --bg-turquesa-dark: #0f766e;
            --ambar-lightest: #fde68a;
            --ambar-light: #fbbf24;
            --ambar-main: #f59e0b;
            --ambar-medium: #d97706;
            --ambar-dark: #b45309;
            --ambar-darkest: #92400e;
            --box-bg: linear-gradient(145deg, rgba(55, 65, 81, 0.85), rgba(45, 55, 71, 0.85));
            --box-border: rgba(251, 191, 36, 0.5);
            --text-light: rgba(255, 255, 255, 0.95);
            --text-dark: rgba(30, 30, 30, 0.95);
        }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-turquesa) !important;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body { position: relative; background: var(--bg-turquesa) !important; }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-turquesa);
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            z-index: 1;
        }
        .container { position: relative; z-index: 2; padding-bottom: 80px; background: transparent; }
        .header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 18px 20px;
            text-align: center;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, var(--ambar-lightest) 0%, var(--ambar-main) 50%, var(--ambar-darkest) 100%) 1;
        }
        .header-title {
            background: linear-gradient(135deg, var(--ambar-lightest) 0%, var(--ambar-light) 25%, var(--ambar-main) 50%, var(--ambar-dark) 75%, var(--ambar-darkest) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 5px;
        }
        .header-subtitle {
            color: var(--text-light);
            font-size: 12px;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(0, 0, 0, 0.3);
        }
        .tabs::-webkit-scrollbar { height: 0; }
        .tab {
            background: linear-gradient(145deg, rgba(60, 70, 85, 0.7), rgba(50, 60, 75, 0.7));
            color: var(--text-light);
            border: 2px solid rgba(251, 191, 36, 0.3);
            padding: 11px 22px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--ambar-lightest) 0%, var(--ambar-light) 30%, var(--ambar-main) 60%, var(--ambar-dark) 100%);
            border-color: var(--ambar-main);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        .content { padding: 0 15px; background: transparent; }
        .section { display: none; background: transparent; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: var(--box-bg);
            border: 2px solid var(--box-border);
            border-radius: 18px;
            padding: 22px;
            margin-bottom: 18px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        .card-title {
            background: linear-gradient(135deg, var(--ambar-lightest) 0%, var(--ambar-light) 30%, var(--ambar-main) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 18px;
        }
        .form-group { margin-bottom: 18px; }
        .form-label {
            display: block;
            color: var(--text-light);
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(30, 30, 40, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 12px;
            padding: 13px 16px;
            color: var(--text-light);
            font-size: 15px;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--ambar-main);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.15);
        }
        .form-textarea {
            resize: vertical;
            min-height: 90px;
            font-family: inherit;
        }
        .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--ambar-light) 0%, var(--ambar-main) 50%, var(--ambar-dark) 100%);
            color: var(--text-dark);
            border: none;
            border-radius: 14px;
            padding: 15px 24px;
            font-size: 15px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-secondary {
            background: linear-gradient(145deg, rgba(60, 70, 85, 0.8), rgba(50, 60, 75, 0.8));
            color: var(--text-light);
        }
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 50%, #B91C1C 100%);
            color: white;
            margin-top: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 22px;
        }
        .stat-card {
            background: rgba(30, 30, 40, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--ambar-light);
            margin-bottom: 6px;
        }
        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
        }
        .chart-container {
            position: relative;
            height: 280px;
            margin-bottom: 22px;
            background: rgba(30, 30, 40, 0.4);
            border-radius: 14px;
            padding: 16px;
        }
        .chart-title {
            color: var(--ambar-light);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }
        
        /* NOVO ESTILO PARA TAREFAS/AGENDA */
        .task-item {
            background: rgba(30, 30, 40, 0.6);
            border-left: 4px solid var(--ambar-main);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .task-item.priority-5 { border-left-color: #EF4444; }
        .task-item.priority-4 { border-left-color: #F59E0B; }
        .task-item.priority-3 { border-left-color: var(--ambar-main); }
        .task-item.priority-2 { border-left-color: #10B981; }
        .task-item.priority-1 { border-left-color: #3B82F6; }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .task-name {
            color: var(--ambar-light);
            font-size: 16px;
            font-weight: 700;
            flex: 1;
        }
        .task-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            font-weight: 600;
            background: rgba(251, 191, 36, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            margin-left: 10px;
        }
        
        .task-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .task-detail-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-tipo {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.15);
            border-radius: 8px;
            color: var(--ambar-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .task-suggestion {
            margin-top: 12px;
            padding: 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--ambar-main);
        }
        .task-suggestion-label {
            color: var(--ambar-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .task-suggestion-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(30, 30, 40, 0.4);
            border-radius: 14px;
            overflow: hidden;
        }
        .data-table thead {
            background: rgba(251, 191, 36, 0.2);
        }
        .data-table th {
            padding: 12px 8px;
            text-align: left;
            color: var(--ambar-light);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .data-table td {
            padding: 10px 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .data-table tr:hover {
            background: rgba(251, 191, 36, 0.05);
        }
        
        .message {
            padding: 14px 18px;
            border-radius: 12px;
            margin-top: 14px;
            font-size: 14px;
            font-weight: 600;
        }
        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10B981;
            color: #10B981;
        }
        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #EF4444;
            color: #EF4444;
        }
        .message.info {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3B82F6;
            color: #3B82F6;
        }
        
        .backup-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            z-index: 1000;
            animation: slideIn 0.5s ease;
            display: none;
        }
        .backup-notification.show {
            display: block;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .task-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="backupNotification" class="backup-notification">
        ‚úÖ Backup autom√°tico realizado!
    </div>

    <div class="container">
        <div class="header">
            <div class="header-title">üß† VRVS ‚Äî TEOT 2026</div>
            <div class="header-subtitle">Plataforma v4.4 ULTRA FIXED</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showSection('dados')">üìä Dados</div>
            <div class="tab" onclick="showSection('cadastro')">‚ûï Cadastro</div>
            <div class="tab" onclick="showSection('feedback')">üìù Feedback</div>
            <div class="tab" onclick="showSection('tarefa')">üìã Tarefa</div>
            <div class="tab" onclick="showSection('agenda')">üìÖ Agenda</div>
            <div class="tab" onclick="showSection('stats')">üìà Estat√≠sticas</div>
            <div class="tab" onclick="showSection('historico')">üìú Hist√≥rico</div>
            <div class="tab" onclick="showSection('importar')">üì• Importar</div>
            <div class="tab" onclick="showSection('exportar')">üì§ Exportar</div>
        </div>
        
        <div class="content">
            <!-- DADOS -->
            <div id="dados" class="section active">
                <div class="card">
                    <div class="card-title">üìä TODOS OS TEMAS</div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√Årea</th>
                                    <th>Tema</th>
                                    <th>Status</th>
                                    <th>Prior.</th>
                                    <th>Rend.</th>
                                    <th>Sess√µes</th>
                                    <th>√ölt.Estudo</th>
                                    <th>Agenda</th>
                                </tr>
                            </thead>
                            <tbody id="dadosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- TAREFA -->
            <div id="tarefa" class="section">
                <div class="card">
                    <div class="card-title">üìã TAREFAS DE HOJE</div>
                    <div id="tarefasContainer"></div>
                </div>
            </div>
            
            <!-- AGENDA -->
            <div id="agenda" class="section">
                <div class="card">
                    <div class="card-title">üìÖ AGENDA COMPLETA</div>
                    <div id="agendaContainer"></div>
                </div>
            </div>
            
            <!-- CADASTRO -->
            <div id="cadastro" class="section">
                <div class="card">
                    <div class="card-title">‚ûï CADASTRAR NOVO TEMA</div>
                    <form id="cadastroForm">
                        <div class="form-group">
                            <label class="form-label">√Årea</label>
                            <input type="text" class="form-input" id="novaArea" placeholder="Ex: Ombro e Cotovelo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tema</label>
                            <input type="text" class="form-input" id="novoTema" placeholder="Ex: Sd manguito rotador" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prioridade (1-5)</label>
                            <input type="number" class="form-input" id="novaPrioridade" min="1" max="5" value="3" required>
                        </div>
                        <button type="submit" class="btn">‚úÖ CADASTRAR TEMA</button>
                    </form>
                </div>
            </div>
            
            <!-- FEEDBACK -->
            <div id="feedback" class="section">
                <div class="card">
                    <div class="card-title">üìù REGISTRAR FEEDBACK</div>
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label class="form-label">Tema</label>
                            <select class="form-select" id="feedbackTema" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rendimento (0-100)</label>
                            <input type="number" class="form-input" id="feedbackRendimento" min="0" max="100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tempo (minutos)</label>
                            <input type="number" class="form-input" id="feedbackTempo" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sugest√£o (pr√≥xima sess√£o)</label>
                            <input type="text" class="form-input" id="feedbackSugestao" placeholder="Ex: revisar flash cards">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observa√ß√µes (sess√£o atual)</label>
                            <textarea class="form-textarea" id="feedbackObs" placeholder="Ex: 30min teoria + 30min quest√µes"></textarea>
                        </div>
                        <button type="submit" class="btn">‚úÖ REGISTRAR SESS√ÉO</button>
                    </form>
                    <button class="btn btn-danger" onclick="desfazerUltimoFeedback()">‚Ü©Ô∏è DESFAZER √öLTIMO FEEDBACK</button>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div id="stats" class="section">
                <div class="card">
                    <div class="card-title">üìä RESUMO GERAL</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTemas">0</div>
                            <div class="stat-label">Temas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessoes">0</div>
                            <div class="stat-label">Sess√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRendimento">0%</div>
                            <div class="stat-label">Rendimento</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTempo">0h</div>
                            <div class="stat-label">Horas</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-title">üìä Rendimento M√©dio por √Årea (Top 10)</div>
                    <div class="chart-container">
                        <canvas id="chartBarras"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-title">üìà Evolu√ß√£o do Rendimento por √Årea</div>
                    <div class="chart-container">
                        <canvas id="chartLinha"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-title">üéØ Rendimento M√©dio por √Årea</div>
                    <div class="chart-container">
                        <canvas id="chartRadar"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- HIST√ìRICO -->
            <div id="historico" class="section">
                <div class="card">
                    <div class="card-title">üìú HIST√ìRICO DE SESS√ïES</div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tema</th>
                                    <th>√Årea</th>
                                    <th>Rend.</th>
                                    <th>Tempo</th>
                                    <th>Observa√ß√µes</th>
                                    <th>Sugest√£o</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- IMPORTAR -->
            <div id="importar" class="section">
                <div class="card">
                    <div class="card-title">üì• IMPORTAR CSV</div>
                    <div class="form-group">
                        <label class="form-label">DADOS.csv</label>
                        <input type="file" class="form-input" id="importDados" accept=".csv">
                    </div>
                    <div class="form-group">
                        <label class="form-label">HISTORICO.csv</label>
                        <input type="file" class="form-input" id="importHistorico" accept=".csv">
                    </div>
                    <button class="btn" onclick="processarImport()">üîÑ ATUALIZAR</button>
                    <div id="importMessage"></div>
                </div>
            </div>
            
            <!-- EXPORTAR -->
            <div id="exportar" class="section">
                <div class="card">
                    <div class="card-title">üì§ EXPORTAR DADOS</div>
                    <button class="btn btn-secondary" onclick="exportarDados()">üìä DADOS.csv</button>
                    <button class="btn btn-secondary" onclick="exportarHistorico()" style="margin-top: 12px;">üìú HISTORICO.csv</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
        let historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
        
        // üßπ LIMPEZA AGRESSIVA DE DADOS CORROMPIDOS
        function limparDadosCorretos() {
            const dadosOriginais = dados.length;
            dados = dados.filter(t => {
                // Remove se √°rea √© inv√°lida ou data
                if (!t.area || t.area.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                // Remove se √°rea cont√©m "sugest√£o"
                if (t.area && t.area.toLowerCase().includes('sugest')) return false;
                // Remove se tema √© "revis√£o ativa" ou similar
                if (!t.tema || t.tema.toLowerCase().includes('revisao ativa') || t.tema.toLowerCase().includes('revis√£o ativa')) return false;
                // Remove se tema √© muito longo (provavelmente observa√ß√£o)
                if (t.tema.length > 100) return false;
                // Remove se tema cont√©m data no in√≠cio
                if (t.tema.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                // Remove se tema parece observa√ß√£o (tem "Sugest√£o:")
                if (t.tema.includes('Sugest√£o:') || t.tema.includes('sugest√£o:')) return false;
                // Remove se tema parece ser parte de observa√ß√£o (cont√©m m√∫ltiplos "|")
                if ((t.tema.match(/\|/g) || []).length > 2) return false;
                return true;
            });
            
            if (dados.length < dadosOriginais) {
                console.log(`üßπ Limpeza: removidos ${dadosOriginais - dados.length} registros corrompidos`);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            }
        }
        
        // Executar limpeza ao carregar
        limparDadosCorretos();
        
        // üîß NORMALIZAR √ÅREAS DE DADOS EXISTENTES
        function normalizarDadosExistentes() {
            let dadosCorrigidos = false;
            dados = dados.map(t => {
                if (!t.area || t.area.trim() === '' || t.area === '-') {
                    // Se √°rea est√° vazia, tentar normalizar usando o tema
                    const areaNormalizada = normalizeArea('', t.tema);
                    if (areaNormalizada && areaNormalizada.trim() !== '') {
                        t.area = areaNormalizada;
                        dadosCorrigidos = true;
                    }
                } else {
                    // Normalizar √°rea existente
                    const areaNormalizada = normalizeArea(t.area, t.tema);
                    if (areaNormalizada !== t.area) {
                        t.area = areaNormalizada;
                        dadosCorrigidos = true;
                    }
                }
                return t;
            });
            
            // Normalizar hist√≥rico tamb√©m
            historico = historico.map(h => {
                if (!h.area || h.area.trim() === '' || h.area === '-') {
                    const areaNormalizada = normalizeArea('', h.tema);
                    if (areaNormalizada && areaNormalizada.trim() !== '') {
                        h.area = areaNormalizada;
                        dadosCorrigidos = true;
                    }
                } else {
                    const areaNormalizada = normalizeArea(h.area, h.tema);
                    if (areaNormalizada !== h.area) {
                        h.area = areaNormalizada;
                        dadosCorrigidos = true;
                    }
                }
                return h;
            });
            
            if (dadosCorrigidos) {
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                console.log('‚úÖ √Åreas normalizadas e dados salvos');
            }
        }
        
        // üîÑ BACKUP AUTOM√ÅTICO DI√ÅRIO
        function verificarBackupAutomatico() {
            const ultimoBackup = localStorage.getItem('ultimoBackup');
            const hoje = new Date().toISOString().split('T')[0];
            
            if (ultimoBackup !== hoje && dados.length > 0) {
                console.log('üì¶ Executando backup autom√°tico...');
                exportarDados();
                exportarHistorico();
                localStorage.setItem('ultimoBackup', hoje);
                mostrarNotificacaoBackup();
            }
        }
        
        function mostrarNotificacaoBackup() {
            const notif = document.getElementById('backupNotification');
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 5000);
        }
        
        // üÜï EXTRAIR √öLTIMA SUGEST√ÉO DAS OBSERVA√á√ïES
        function extrairUltimaSugestao(observacoes) {
            if (!observacoes) return '';
            
            // Pega todas as linhas
            const linhas = observacoes.split('\n');
            
            // Percorre de tr√°s pra frente procurando por "Sugest√£o:"
            for (let i = linhas.length - 1; i >= 0; i--) {
                const linha = linhas[i];
                if (linha.includes('Sugest√£o:') || linha.includes('sugest√£o:')) {
                    // Extrai o que vem depois de "Sugest√£o:"
                    const partes = linha.split(/[Ss]ugest√£o:/);
                    if (partes.length > 1) {
                        // Remove poss√≠vel " | " no final ou in√≠cio
                        return partes[1].trim().replace(/^\|/, '').replace(/\|$/, '').trim();
                    }
                }
            }
            
            return '';
        }
        
        // üî• NOVA FUN√á√ÉO: Obter sugest√£o do tema (prioriza campo separado)
        function obterSugestaoTema(tema) {
            // Se tema n√£o existe, retorna vazio
            if (!tema) return '';
            
            // PRIORIDADE 1: Campo sugestao separado
            if (tema.sugestao && tema.sugestao !== '-' && tema.sugestao.trim() !== '') {
                return tema.sugestao.trim();
            }
            
            // PRIORIDADE 2: Extrair das observa√ß√µes
            return extrairUltimaSugestao(tema.observacoes);
        }
        
        // Normaliza√ß√£o de √°reas
        function normalizeArea(rawArea, tema) {
            if (!rawArea && !tema) return '';
            let area = String(rawArea || '').trim().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            let temaLower = String(tema || '').toLowerCase();
            
            const areaMap = {
                'trauma mmss': 'Trauma MMSS',
                'trauma membros superiores': 'Trauma MMSS',
                'trauma mmii': 'Trauma MMII',
                'trauma membros inferiores': 'Trauma MMII',
                'trauma ped': 'Trauma Pedi√°trico',
                'trauma pediatrico': 'Trauma Pedi√°trico',
                'trauma pedi√°trico': 'Trauma Pedi√°trico',
                'trauma pediatria': 'Trauma Pedi√°trico',
                'ombro e cotovelo': 'Ombro e Cotovelo',
                'ombro': 'Ombro e Cotovelo',
                'cotovelo': 'Ombro e Cotovelo',
                'mao': 'M√£o',
                'punho': 'M√£o',
                'joelho': 'Joelho',
                'quadril': 'Quadril',
                'pelve': 'Quadril',
                'pe e tornozelo': 'P√© e Tornozelo',
                'tornozelo': 'P√© e Tornozelo',
                'coluna': 'Coluna',
                'oncologia': 'Oncologia',
                'tumores': 'Oncologia',
                'ortopedia pediatrica': 'Ortopedia Pedi√°trica',
                'ortopedia pedi√°trica': 'Ortopedia Pedi√°trica'
            };
            
            if (areaMap[area]) return areaMap[area];
            
            // Inferir √°rea por tema se cont√©m "fratura"
            if (/fratura/i.test(temaLower)) {
                // Fraturas pedi√°tricas espec√≠ficas
                if (/supracondiliana|epifisiolise|epifisiolistese|fratura.*pediatric|fratura.*pediatri|fratura.*infantil/.test(temaLower)) {
                    return 'Trauma Pedi√°trico';
                }
                if (/clavicula|umero|cotovelo|mao|punho/.test(temaLower)) return 'Trauma MMSS';
                if (/femur|joelho|tibia/.test(temaLower)) return 'Trauma MMII';
            }
            
            // Verificar se tema cont√©m palavras-chave pedi√°tricas mesmo sem "fratura"
            if (/pediatric|pediatri|infantil|supracondiliana|epifisiolise|epifisiolistese/.test(temaLower)) {
                return 'Trauma Pedi√°trico';
            }
            
            return area.replace(/\b\w/g, m => m.toUpperCase());
        }
        
        // Executar normaliza√ß√£o ao carregar (ap√≥s normalizeArea estar definida)
        normalizarDadosExistentes();
        
        // Calcular pr√≥xima revis√£o
        function calcularProximaRevisao(tema) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            if (!tema.sessoes || tema.sessoes === 0) {
                const proxima = new Date(hoje);
                proxima.setDate(proxima.getDate() + 1);
                return proxima.toISOString().split('T')[0];
            }
            
            const rendimento = Math.round((tema.rendimento || 0) * 100);
            const prioridade = parseInt(tema.prioridade) || 3;
            const contador80 = parseInt(tema.contador80) || 0;
            let intervalo = 1;
            
            if (rendimento < 50) {
                intervalo = 1;
            } else if (rendimento >= 50 && rendimento < 80) {
                intervalo = 3;
            } else {
                if (contador80 === 0) intervalo = 7;
                else if (contador80 === 1) intervalo = 14;
                else if (contador80 === 2) intervalo = 30;
                else intervalo = 60;
                
                if (prioridade === 5 && intervalo > 30) {
                    intervalo = 30;
                }
            }
            
            const proxima = new Date(hoje);
            proxima.setDate(proxima.getDate() + intervalo);
            return proxima.toISOString().split('T')[0];
        }
        
        // üÜï RENDERIZAR TAREFAS - VERS√ÉO COMPLETA
        function renderTarefas() {
            const hoje = new Date().toISOString().split('T')[0];
            const tarefas = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                return t.agenda <= hoje;
            });
            
            const container = document.getElementById('tarefasContainer');
            if (tarefas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma tarefa para hoje!</div></div>';
                return;
            }
            
            tarefas.sort((a, b) => (b.prioridade || 0) - (a.prioridade || 0));
            
            container.innerHTML = tarefas.map(t => {
                const sugestao = obterSugestaoTema(t); // üî• CORRIGIDO
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#10B981' : rendPct >= 50 ? '#FBBF24' : '#EF4444';
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-name">${t.tema}</div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üî¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${t.tipoRevisao ? `<div class="task-tipo">${t.tipoRevisao}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">üí° Sugest√£o:</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }
        
        // üÜï RENDERIZAR AGENDA - VERS√ÉO COMPLETA
        function renderAgenda() {
            const hoje = new Date().toISOString().split('T')[0];
            const agendadas = dados
                .filter(t => t.agenda && t.agenda >= hoje && t.status !== 'Conclu√≠do')
                .sort((a, b) => a.agenda.localeCompare(b.agenda));
            
            const container = document.getElementById('agendaContainer');
            if (agendadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div>Nenhuma revis√£o agendada!</div></div>';
                return;
            }
            
            container.innerHTML = agendadas.map(t => {
                const sugestao = obterSugestaoTema(t); // üî• CORRIGIDO
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#10B981' : rendPct >= 50 ? '#FBBF24' : '#EF4444';
                const dataFormatada = new Date(t.agenda + 'T00:00:00').toLocaleDateString('pt-BR');
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-date">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üî¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${t.tipoRevisao ? `<div class="task-tipo">${t.tipoRevisao}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">üí° Sugest√£o:</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }
        
        // Renderizar dados
        function renderDados() {
            const tbody = document.getElementById('dadosTableBody');
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">Nenhum tema cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = dados.map(t => {
                const ultEstudo = t.ultEstudo ? new Date(t.ultEstudo + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                const agenda = t.agenda ? new Date(t.agenda + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                const rend = t.rendimento ? Math.round(t.rendimento * 100) + '%' : '-';
                const rendColor = t.rendimento >= 0.8 ? '#10B981' : t.rendimento >= 0.5 ? '#FBBF24' : '#EF4444';
                
                return `
                    <tr>
                        <td style="padding: 8px; color: rgba(255,255,255,0.8);">${t.area || '-'}</td>
                        <td style="padding: 8px; color: var(--ambar-light); font-weight: 600;">${t.tema || '-'}</td>
                        <td style="padding: 8px; text-align: center; color: rgba(255,255,255,0.7);">${t.status || 'N√£o iniciado'}</td>
                        <td style="padding: 8px; text-align: center; color: var(--ambar-main);">${t.prioridade || 3}</td>
                        <td style="padding: 8px; text-align: center; color: ${rendColor};">${rend}</td>
                        <td style="padding: 8px; text-align: center; color: rgba(255,255,255,0.7);">${t.sessoes || 0}</td>
                        <td style="padding: 8px; text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${ultEstudo}</td>
                        <td style="padding: 8px; text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${agenda}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Cadastro
        document.getElementById('cadastroForm').onsubmit = function(e) {
            e.preventDefault();
            const area = document.getElementById('novaArea').value.trim();
            const tema = document.getElementById('novoTema').value.trim();
            const prioridade = parseInt(document.getElementById('novaPrioridade').value);
            
            const novoTema = {
                id: Date.now(),
                area: normalizeArea(area, tema),
                tema: tema,
                status: 'Planejado',
                prioridade: prioridade,
                dificuldade: 'M√©dia',
                rendimento: 0,
                sessoes: 0,
                ultEstudo: '',
                agenda: '',
                tempo: 0,
                observacoes: '',
                contador80: 0,
                tipoRevisao: ''
            };
            
            dados.push(novoTema);
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            this.reset();
            alert('‚úÖ Tema cadastrado com sucesso!');
            renderDados();
            updateFeedbackSelect();
        };
        
        // Atualizar dropdown de feedback
        function updateFeedbackSelect() {
            const select = document.getElementById('feedbackTema');
            select.innerHTML = '<option value="">Selecione...</option>' +
                dados.map(t => `<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
        }
        
        // üÜï REGISTRAR FEEDBACK - VERS√ÉO CORRIGIDA
        document.getElementById('feedbackForm').onsubmit = function(e) {
            e.preventDefault();
            const temaId = parseInt(document.getElementById('feedbackTema').value);
            const rendimento = parseInt(document.getElementById('feedbackRendimento').value);
            const tempo = parseInt(document.getElementById('feedbackTempo').value);
            const sugestao = document.getElementById('feedbackSugestao').value.trim();
            const obs = document.getElementById('feedbackObs').value.trim();
            
            const tema = dados.find(t => t.id === temaId);
            if (!tema) return;
            
            // üîß CORRE√á√ÉO: Calcular intervalo ANTES de atualizar contador80
            // O contador80 deve representar quantas vezes consecutivas atingiu 80%
            // ANTES desta sess√£o, para ser usado no c√°lculo correto do intervalo
            
            // Salvar valores atuais
            const sessoesAntes = tema.sessoes || 0;
            const contador80Atual = parseInt(tema.contador80) || 0;
            
            // Atualizar dados do tema (mas ainda n√£o o contador80)
            tema.rendimento = rendimento / 100;
            tema.sessoes = sessoesAntes + 1;
            tema.ultEstudo = new Date().toISOString().split('T')[0];
            
            // üîß IMPORTANTE: Na segunda sess√£o (primeira vez no algoritmo), 
            // o contador80 deve ser 0 para o c√°lculo, independente do valor anterior
            // (porque a primeira sess√£o n√£o conta para o algoritmo)
            if (sessoesAntes === 1) {
                // Segunda sess√£o: primeira vez no algoritmo, contador80 = 0
                tema.contador80 = 0;
            }
            // Se sessoesAntes > 1, mant√©m o contador80Atual (j√° est√° correto)
            
            // Calcular pr√≥xima revis√£o usando o contador80 correto
            tema.agenda = calcularProximaRevisao(tema);
            
            // AGORA atualizar contador80 ap√≥s calcular o intervalo
            // Importante: contador80 s√≥ conta a partir da segunda sess√£o (quando entra no algoritmo)
            if (tema.sessoes >= 2) {
                if (rendimento >= 80) {
                    // Se √© segunda sess√£o, estava em 0 (zerado acima), ent√£o incrementa para 1
                    // Se √© terceira+ sess√£o, incrementa do valor atual
                    tema.contador80 = (sessoesAntes === 1 ? 0 : contador80Atual) + 1;
                } else {
                    tema.contador80 = 0;
                }
            } else {
                // Primeira sess√£o: sempre zera o contador80 (n√£o conta para o algoritmo)
                tema.contador80 = 0;
            }
            tema.tempo = (tema.tempo || 0) + tempo;
            tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
            
            // Determinar tipo de revis√£o
            if (tema.sessoes === 1) {
                tema.tipoRevisao = 'Primeira';
            } else if (rendimento < 50) {
                tema.tipoRevisao = 'Refor√ßo';
            } else if (rendimento < 80) {
                tema.tipoRevisao = 'Intermedi√°ria';
            } else {
                tema.tipoRevisao = 'Consolida√ß√£o';
            }
            
            // Adicionar observa√ß√µes E sugest√£o (separados)
            const hoje = tema.ultEstudo;
            let novaObs = '';
            if (obs) novaObs = `${hoje}: ${obs}`;
            if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
            
            if (novaObs) {
                tema.observacoes = tema.observacoes 
                    ? tema.observacoes + '\n' + novaObs
                    : novaObs;
            }
            
            // üî• SALVAR SUGEST√ÉO NO TEMA TAMB√âM (campo separado)
            tema.sugestao = sugestao || '';
            
            // üÜï ADICIONAR AO HIST√ìRICO COM DATA E SUGEST√ÉO CORRETAS
            historico.push({
                id: Date.now(),
                temaId: tema.id,
                area: tema.area,
                tema: tema.tema,
                rendimento: rendimento / 100,
                tempo: tempo,
                data: tema.ultEstudo, // ‚Üê GARANTIR QUE DATA SEJA SALVA
                observacoes: obs || '-',
                sugestao: sugestao || '-' // ‚Üê SUGEST√ÉO SEPARADA
            });
            
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            
            this.reset();
            alert('‚úÖ Feedback registrado!\nüìÖ Pr√≥xima revis√£o: ' + new Date(tema.agenda + 'T00:00:00').toLocaleDateString('pt-BR'));
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
        };
        
        // üÜï DESFAZER √öLTIMO FEEDBACK
        function desfazerUltimoFeedback() {
            if (historico.length === 0) {
                alert('‚ùå Nenhum feedback para desfazer!');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja desfazer o √∫ltimo feedback registrado?')) {
                return;
            }
            
            // Pegar √∫ltima sess√£o
            const ultimaSessao = historico[historico.length - 1];
            const tema = dados.find(t => t.id === ultimaSessao.temaId);
            
            if (!tema) {
                alert('‚ùå Tema n√£o encontrado!');
                return;
            }
            
            // Remover do hist√≥rico
            historico.pop();
            
            // Recalcular dados do tema
            tema.sessoes = Math.max(0, (tema.sessoes || 1) - 1);
            tema.tempo = Math.max(0, (tema.tempo || ultimaSessao.tempo) - ultimaSessao.tempo);
            
            // Recalcular rendimento m√©dio
            const sessoesRestantes = historico.filter(h => h.temaId === tema.id);
            if (sessoesRestantes.length > 0) {
                const somaRend = sessoesRestantes.reduce((sum, h) => sum + (h.rendimento || 0), 0);
                tema.rendimento = somaRend / sessoesRestantes.length;
            } else {
                tema.rendimento = 0;
                tema.status = 'Planejado';
                tema.ultEstudo = '';
            }
            
            // Recalcular contador80
            let contador = 0;
            for (let i = sessoesRestantes.length - 1; i >= 0; i--) {
                if ((sessoesRestantes[i].rendimento || 0) >= 0.8) {
                    contador++;
                } else {
                    break;
                }
            }
            tema.contador80 = contador;
            
            // Recalcular pr√≥xima agenda
            if (tema.sessoes > 0) {
                tema.agenda = calcularProximaRevisao(tema);
                const ultimaSessaoRestante = sessoesRestantes[sessoesRestantes.length - 1];
                tema.ultEstudo = ultimaSessaoRestante ? ultimaSessaoRestante.data : '';
            } else {
                tema.agenda = '';
            }
            
            // Salvar
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            
            alert('‚úÖ √öltimo feedback desfeito com sucesso!');
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
        }
        
        // üÜï RENDERIZAR HIST√ìRICO - VERS√ÉO CORRIGIDA
        function renderHistorico() {
            const tbody = document.getElementById('historicoTableBody');
            if (historico.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">Nenhuma sess√£o registrada</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historico].sort((a, b) => {
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                const data = h.data ? new Date(h.data + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#10B981';
                else if (h.rendimento >= 0.5) rendColor = '#FBBF24';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                return `
                    <tr>
                        <td style="padding: 8px; color: rgba(255,255,255,0.6); font-size: 11px;">${data}</td>
                        <td style="padding: 8px; color: var(--ambar-light); font-weight: 600;">${h.tema || '-'}</td>
                        <td style="padding: 8px; color: rgba(255,255,255,0.8);">${h.area || '-'}</td>
                        <td style="padding: 8px; text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="padding: 8px; text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="padding: 8px; color: rgba(255,255,255,0.7); font-size: 12px;">${h.observacoes || '-'}</td>
                        <td style="padding: 8px; color: rgba(255,255,255,0.7); font-size: 12px;">${h.sugestao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Stats e gr√°ficos (mantidos iguais da v4.3)
        function updateStats() {
            document.getElementById('statTemas').textContent = dados.length;
            const totalSessoes = historico.length;
            document.getElementById('statSessoes').textContent = totalSessoes;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historico.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            document.getElementById('statRendimento').textContent = rendimentoMedio + '%';
            const totalMinutos = historico.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            document.getElementById('statTempo').textContent = totalHoras + 'h';
            
            renderChartBarras();
            renderChartLinha();
            renderChartRadar();
        }
        
        // [GR√ÅFICOS - mantidos da v4.3]
        const COLORS_PALETTE = [
            '#1E88E5', '#43A047', '#FB8C00', '#8E24AA', '#E53935',
            '#00ACC1', '#7CB342', '#F4511E', '#5E35B1', '#3949AB',
            '#00897B', '#FDD835', '#6D4C41', '#546E7A', '#EC407A'
        ];
        let areaColorMap = {};
        let colorIndex = 0;
        function getColorForArea(area) {
            if (!areaColorMap[area]) {
                areaColorMap[area] = COLORS_PALETTE[colorIndex % COLORS_PALETTE.length];
                colorIndex++;
            }
            return areaColorMap[area];
        }
        let chartBarrasInst = null;
        let chartLinhaInst = null;
        let chartRadarInst = null;
        
        function renderChartBarras() {
            const ctx = document.getElementById('chartBarras');
            if (!ctx) return;
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                const areaNormalizada = normalizeArea(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                if (!areaStats[areaNormalizada]) {
                    areaStats[areaNormalizada] = { total: 0, count: 0 };
                }
                areaStats[areaNormalizada].total += h.rendimento * 100;
                areaStats[areaNormalizada].count += 1;
            });
            const areaRendimento = [];
            for (let area in areaStats) {
                const media = Math.round(areaStats[area].total / areaStats[area].count);
                areaRendimento.push([area, media]);
            }
            const sorted = areaRendimento.sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (sorted.length === 0) {
                if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
                return;
            }
            if (chartBarrasInst) { chartBarrasInst.destroy(); }
            const backgroundColors = sorted.map(s => getColorForArea(s[0]));
            chartBarrasInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Rendimento M√©dio (%)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rendimento: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Rendimento (%)', color: 'rgba(255,255,255,0.7)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function renderChartLinha() {
            const ctx = document.getElementById('chartLinha');
            if (!ctx) return;
            const areaData = {};
            const historicoOrdenado = [...historico].sort((a, b) => new Date(a.data) - new Date(b.data));
            historicoOrdenado.forEach((h, index) => {
                if (!h.rendimento) return;
                const areaNormalizada = normalizeArea(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                if (!areaData[areaNormalizada]) { areaData[areaNormalizada] = []; }
                areaData[areaNormalizada].push({
                    x: areaData[areaNormalizada].length + 1,
                    y: Math.round(h.rendimento * 100)
                });
            });
            const areas = Object.keys(areaData);
            if (areas.length === 0) {
                if (chartLinhaInst) { chartLinhaInst.destroy(); chartLinhaInst = null; }
                return;
            }
            if (chartLinhaInst) { chartLinhaInst.destroy(); }
            const datasets = areas.map(area => ({
                label: area,
                data: areaData[area],
                borderColor: getColorForArea(area),
                backgroundColor: getColorForArea(area) + '40',
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            }));
            chartLinhaInst = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: 'rgba(255,255,255,0.7)' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Rendimento (%)', color: 'rgba(255,255,255,0.7)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'N√∫mero da Sess√£o', color: 'rgba(255,255,255,0.7)' },
                            ticks: { color: 'rgba(255,255,255,0.7)', stepSize: 1 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function renderChartRadar() {
            const ctx = document.getElementById('chartRadar');
            if (!ctx) return;
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                const areaNormalizada = normalizeArea(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                if (!areaStats[areaNormalizada]) {
                    areaStats[areaNormalizada] = { total: 0, count: 0 };
                }
                areaStats[areaNormalizada].total += h.rendimento * 100;
                areaStats[areaNormalizada].count += 1;
            });
            const areas = Object.keys(areaStats);
            if (areas.length === 0) {
                if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
                return;
            }
            if (chartRadarInst) { chartRadarInst.destroy(); }
            const rendimentoMedios = areas.map(a => Math.round(areaStats[a].total / areaStats[a].count));
            chartRadarInst = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'Rendimento M√©dio (%)',
                        data: rendimentoMedios,
                        borderColor: 'rgba(251, 191, 36, 1)',
                        backgroundColor: 'rgba(251, 191, 36, 0.2)',
                        pointBackgroundColor: 'rgba(251, 191, 36, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(251, 191, 36, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rendimento: ${context.parsed.r}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: 'rgba(255,255,255,0.7)',
                                callback: function(value) { return value + '%'; }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: 'rgba(255,255,255,0.7)' }
                        }
                    }
                }
            });
        }
        
        // Import/Export (mantidos da v4.3)
        function processarImport() {
            const dadosFile = document.getElementById('importDados').files[0];
            const historicoFile = document.getElementById('importHistorico').files[0];
            if (!dadosFile || !historicoFile) {
                showMessage('error', '‚ùå Selecione ambos os arquivos!');
                return;
            }
            showMessage('info', '‚è≥ Processando...');
            Promise.all([parseCSV(dadosFile), parseCSV(historicoFile)])
            .then(([dadosCSV, historicoCSV]) => {
                dados = dadosCSV;
                historico = historicoCSV;
                limparDadosCorretos();
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                renderTarefas();
                renderAgenda();
                renderDados();
                updateFeedbackSelect();
                updateStats();
                renderHistorico();
                showMessage('success', `‚úÖ Importado! ${dados.length} temas e ${historico.length} sess√µes.`);
            }).catch(err => {
                showMessage('error', `‚ùå Erro: ${err.message}`);
            });
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Falha ao ler arquivo.'));
                reader.onload = e => {
                    try {
                        const text = e.target.result;
                        const rows = parseCSVText(text);
                        if (!rows.length) return reject(new Error('CSV vazio'));
                        const headers = rows[0].map(h => stripOuterQuotes(h).replace(/\uFEFF/g, '').trim());
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx]) {
                                    return stripOuterQuotes(r[idx]);
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            return {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                status: getVal(r, 'status', 'estado') || 'N√£o iniciado',
                                prioridade: parseInt(getVal(r, 'prioridade', 'prior')) || 3,
                                dificuldade: getVal(r, 'dificuldade', 'dific') || 'M√©dia',
                                rendimento: (() => {
                                    const valStr = getVal(r, 'rendimento', 'rend');
                                    if (!valStr) return 0;
                                    const cleanStr = valStr.replace('%', '').replace(',', '.');
                                    const val = parseFloat(cleanStr) || 0;
                                    return val > 1 ? val / 100 : val;
                                })(),
                                sessoes: parseInt(getVal(r, 'sessoes', 'sessao')) || 0,
                                ultEstudo: getVal(r, 'ultestudo', 'ultest', 'ultimoestudo', 'ultimo_estudo'),
                                agenda: getVal(r, 'dataagenda', 'agenda', 'data_agenda'),
                                tempo: parseInt(getVal(r, 'tempomin', 'tempo')) || 0,
                                observacoes: getVal(r, 'observacoes', 'obs', 'observacao'),
                                contador80: parseInt(getVal(r, 'contador80')) || 0,
                                tipoRevisao: getVal(r, 'tiporevisao', 'tipo_revisao', 'tipo'),
                                sugestao: getVal(r, 'sugestao', 'sugestoes'),
                                data: getVal(r, 'data') // ‚Üê Importante para hist√≥rico
                            };
                        }).filter(obj => obj.tema && obj.tema.trim() !== '');
                        resolve(data);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function parseCSVText(input) {
            let text = String(input || '').replace(/^\uFEFF/, '');
            const rows = [];
            let row = [];
            let cell = '';
            let i = 0;
            let inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    if (ch === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            cell += '"';
                            i += 2;
                        } else {
                            inQuotes = false;
                            i += 1;
                        }
                    } else {
                        cell += ch;
                        i += 1;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                        i += 1;
                    } else if (ch === ',') {
                        row.push(cell);
                        cell = '';
                        i += 1;
                    } else if (ch === '\r') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        if (text[i + 1] === '\n') i += 2; else i += 1;
                    } else if (ch === '\n') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        i += 1;
                    } else {
                        cell += ch;
                        i += 1;
                    }
                }
            }
            row.push(cell);
            rows.push(row);
            return rows;
        }
        
        function stripOuterQuotes(s) {
            const str = String(s ?? '');
            if (str.length >= 2 && str[0] === '"' && str[str.length - 1] === '"') {
                return str.slice(1, -1).replace(/""/g, '"');
            }
            return str;
        }
        
        function showMessage(type, text) {
            const container = document.getElementById('importMessage');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function exportarDados() {
            const csv = dados2CSV(dados);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_DADOS_${hoje}.csv`);
        }
        
        function exportarHistorico() {
            const csv = dados2CSV(historico);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_HISTORICO_${hoje}.csv`);
        }
        
        function dados2CSV(arr) {
            if (arr.length === 0) return '';
            const headers = Object.keys(arr[0]);
            const rows = arr.map(obj => headers.map(h => {
                const val = obj[h] || '';
                const escaped = String(val).replace(/"/g, '""');
                return (escaped.includes(',') || escaped.includes('\n')) ? `"${escaped}"` : escaped;
            }).join(','));
            return [headers.join(','), ...rows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // Navega√ß√£o entre abas
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            if (sectionId === 'dados') renderDados();
            if (sectionId === 'tarefa') renderTarefas();
            if (sectionId === 'agenda') renderAgenda();
            if (sectionId === 'stats') updateStats();
            if (sectionId === 'historico') renderHistorico();
        }
        
        // üß™ FUN√á√ÉO DE TESTE DO ALGORITMO (executar no console)
        window.testarAlgoritmo = function() {
            console.log('üß™ TESTE DO ALGORITMO DE REVIS√ÉO\n');
            
            // Simular um tema novo
            let temaTeste = {
                id: 999999,
                sessoes: 0,
                contador80: 0,
                rendimento: 0,
                prioridade: 3
            };
            
            console.log('üìã CEN√ÅRIO 1: Primeira sess√£o (rendimento >= 80%)');
            temaTeste.sessoes = 0;
            temaTeste.contador80 = 0;
            temaTeste.rendimento = 0.85;
            let agenda1 = calcularProximaRevisao(temaTeste);
            let intervalo1 = Math.round((new Date(agenda1) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 1 dia | Resultado: ${intervalo1} dia(s) | ${intervalo1 === 1 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\nüìã CEN√ÅRIO 2: Segunda sess√£o (rendimento >= 80%)');
            temaTeste.sessoes = 1;
            temaTeste.contador80 = 0; // Deve ser 0 porque primeira sess√£o n√£o conta
            temaTeste.rendimento = 0.85;
            let agenda2 = calcularProximaRevisao(temaTeste);
            let intervalo2 = Math.round((new Date(agenda2) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 7 dias | Resultado: ${intervalo2} dia(s) | ${intervalo2 === 7 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\nüìã CEN√ÅRIO 3: Terceira sess√£o (rendimento >= 80%, segunda vez consecutiva)');
            temaTeste.sessoes = 2;
            temaTeste.contador80 = 1; // Primeira vez que atingiu 80% no algoritmo
            temaTeste.rendimento = 0.85;
            let agenda3 = calcularProximaRevisao(temaTeste);
            let intervalo3 = Math.round((new Date(agenda3) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 14 dias | Resultado: ${intervalo3} dia(s) | ${intervalo3 === 14 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\nüìã CEN√ÅRIO 4: Quarta sess√£o (rendimento >= 80%, terceira vez consecutiva)');
            temaTeste.sessoes = 3;
            temaTeste.contador80 = 2;
            temaTeste.rendimento = 0.85;
            let agenda4 = calcularProximaRevisao(temaTeste);
            let intervalo4 = Math.round((new Date(agenda4) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 30 dias | Resultado: ${intervalo4} dia(s) | ${intervalo4 === 30 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\nüìã CEN√ÅRIO 5: Segunda sess√£o com rendimento < 50%');
            temaTeste.sessoes = 1;
            temaTeste.contador80 = 0;
            temaTeste.rendimento = 0.40;
            let agenda5 = calcularProximaRevisao(temaTeste);
            let intervalo5 = Math.round((new Date(agenda5) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 1 dia | Resultado: ${intervalo5} dia(s) | ${intervalo5 === 1 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\nüìã CEN√ÅRIO 6: Segunda sess√£o com rendimento entre 50-80%');
            temaTeste.sessoes = 1;
            temaTeste.contador80 = 0;
            temaTeste.rendimento = 0.65;
            let agenda6 = calcularProximaRevisao(temaTeste);
            let intervalo6 = Math.round((new Date(agenda6) - new Date()) / (1000 * 60 * 60 * 24));
            console.log(`   ‚úÖ Esperado: 3 dias | Resultado: ${intervalo6} dia(s) | ${intervalo6 === 3 ? '‚úì CORRETO' : '‚úó ERRO'}`);
            
            console.log('\n‚úÖ Teste conclu√≠do! Verifique os resultados acima.');
        };
        
        // Inicializa√ß√£o
        window.onload = function() {
            verificarBackupAutomatico();
            renderTarefas();
            renderAgenda();
            renderDados();
            updateFeedbackSelect();
            updateStats();
            renderHistorico();
        };
    </script>
</body>
</html>
