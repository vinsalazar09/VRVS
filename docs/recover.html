<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRVS - Recovery</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 50%, #0a1a1f 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 400px;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        button:hover {
            background: #45a049;
        }
        .warning {
            color: #ff9800;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß VRVS Recovery</h1>
        
        <!-- Modo Storage Doctor (quando ?mode=storage) -->
        <div id="storageDoctor" style="display: none;">
            <h2 style="color: #ff6b6b; margin-top: 20px;">üíæ Storage Doctor</h2>
            <p style="font-size: 14px; margin-bottom: 20px;">localStorage est√° cheio ou corrompido. Analise e limpe dados n√£o essenciais.</p>
            
            <!-- Mostrar reason se presente -->
            <div id="reasonDisplay" style="background: rgba(255,152,0,0.2); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; display: none;"></div>
            
            <!-- Top chaves por tamanho -->
            <div style="margin-top: 20px; text-align: left;">
                <h3 style="font-size: 14px; margin-bottom: 10px;">üìä Top Chaves por Tamanho</h3>
                <!-- S3N: Diagn√≥stico QUOTA no topo -->
                <div id="quotaDiagnostics" style="background: rgba(255,152,0,0.15); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 11px; font-family: monospace; color: rgba(255,255,255,0.9);">
                    <div style="color: rgba(255,255,255,0.6);">Carregando diagn√≥stico...</div>
                </div>
                <div id="storageKeysList" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-size: 12px; font-family: monospace;">
                    <div style="color: rgba(255,255,255,0.6);">Carregando...</div>
                </div>
            </div>
            
            <!-- S3N: Bot√µes de limpeza r√°pida -->
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="clearFlags()" style="background: #9C27B0; flex: 1; margin: 0;">
                    üè≥Ô∏è Limpar FLAGS
                </button>
                <button onclick="clearCacheStorage()" style="background: #607D8B; flex: 1; margin: 0;">
                    üóëÔ∏è Limpar Cache Storage
                </button>
            </div>
            
            <!-- S3N: Resultado do teste de escrita -->
            <div id="writeTestResult" style="margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 12px; display: none;"></div>
            
            <!-- Bot√£o Baixar Backup Essenciais -->
            <button onclick="downloadEssentialData()" style="background: #2196F3; margin-top: 15px;">
                üì• Exportar dados essenciais
            </button>
            
            <!-- Preset Seguro Limpeza -->
            <div style="margin-top: 20px; text-align: left;">
                <h3 style="font-size: 14px; margin-bottom: 10px;">üßπ Limpeza Segura</h3>
                <div style="background: rgba(255,152,0,0.1); padding: 15px; border-radius: 8px; font-size: 13px;">
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="cleanBackups" checked style="margin-right: 8px;">
                            <span>Limpar BACKUPS (vrvs_backup_*)</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="cleanDebug" checked style="margin-right: 8px;">
                            <span>Limpar DEBUG/TRACE/TEMP (__vrvs*, vrvs_boot*, vrvs_trace*, vrvs_tmp*)</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="cleanLarge" checked style="margin-right: 8px;">
                            <span>Limpar chaves grandes n√£o protegidas (>200KB)</span>
                        </label>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); color: #4CAF50; font-weight: 600;">
                        ‚úÖ PROTEGIDAS (n√£o ser√£o removidas): vrvs_dados, vrvs_historico, vrvs_diario, vrvs_anotacoes, vrvs_lembretes, vrvs_config, vrvs_areas_custom
                    </div>
                </div>
            </div>
            
            <!-- Bot√£o Executar Limpeza -->
            <button onclick="executeStorageCleanup()" style="background: #ff9800; margin-top: 15px;">
                üßπ Executar limpeza selecionada
            </button>
            
            <!-- S3N FIX: Bot√£o para remover backup grande manualmente -->
            <button onclick="removeLargeBackup()" style="background: #f44336; margin-top: 10px;">
                üî¥ Remover Backup Grande (vrvs_backup_*)
            </button>
            
            <!-- Bot√£o Voltar -->
            <button onclick="goBackToApp()" style="background: rgba(255,255,255,0.2); margin-top: 10px;">
                ‚Üê Voltar para o app
            </button>
        </div>
        
        <!-- Modo Recovery Normal (quando n√£o √© ?mode=storage) -->
        <div id="normalRecovery">
            <p>Se o aplicativo estiver travado, clique no bot√£o abaixo para limpar o Service Worker e caches.</p>
            <p class="warning">‚ö†Ô∏è Seus dados (localStorage) N√ÉO ser√£o apagados.</p>
            <button onclick="recover()">Limpar Cache e Recarregar</button>
        </div>
        
        <div id="status" style="margin-top: 20px; font-size: 14px;"></div>
    </div>
    <script>
        // Detectar modo storage doctor
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isStorageMode = urlParams.get('mode') === 'storage';
            const reason = urlParams.get('reason');
            
            if (isStorageMode) {
                document.getElementById('storageDoctor').style.display = 'block';
                document.getElementById('normalRecovery').style.display = 'none';
                
                // Mostrar reason se presente
                if (reason) {
                    const reasonDisplay = document.getElementById('reasonDisplay');
                    if (reasonDisplay) {
                        let reasonText = 'Motivo: ';
                        if (reason === 'quota' || reason.startsWith('quota_')) {
                            reasonText += 'Quota de armazenamento excedida';
                        } else if (reason === 'parse_fail' || reason.startsWith('parse_fail')) {
                            reasonText += 'Dados corrompidos (erro ao parsear JSON)';
                        } else if (reason === 'too_big' || reason.startsWith('too_big')) {
                            reasonText += 'Chave muito grande (>4MB)';
                        } else {
                            reasonText += reason.replace(/_/g, ' ');
                        }
                        reasonDisplay.textContent = reasonText;
                        reasonDisplay.style.display = 'block';
                    }
                }
                
                loadStorageKeys();
            } else {
                document.getElementById('storageDoctor').style.display = 'none';
                document.getElementById('normalRecovery').style.display = 'block';
            }
        })();
        
        // Chaves cr√≠ticas protegidas (NUNCA deletar)
        const PROTECTED_KEYS = [
            'vrvs_dados',
            'vrvs_historico',
            'vrvs_diario',
            'vrvs_anotacoes',
            'vrvs_lembretes',
            'vrvs_config',
            'vrvs_areas_custom'
        ];
        
        // S3N: Carregar lista de chaves por tamanho com diagn√≥stico completo
        function loadStorageKeys() {
            const listEl = document.getElementById('storageKeysList');
            const diagEl = document.getElementById('quotaDiagnostics');
            if (!listEl) return;
            
            try {
                const keys = [];
                let totalBytes = 0;
                let nullCount = 0;
                let emptyCount = 0;
                let maiorChave = { key: '', size: 0 };
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    try {
                        const value = localStorage.getItem(key);
                        // S3N: Ajustar c√°lculo - value === null √© diferente de value === ''
                        const sizeBytes = (value === null) ? 0 : (value.length * 2);
                        
                        // Contadores
                        if (value === null) nullCount++;
                        else if (value === '') emptyCount++;
                        
                        totalBytes += sizeBytes;
                        
                        // Maior chave
                        if (sizeBytes > maiorChave.size) {
                            maiorChave = { key: key, size: sizeBytes };
                        }
                        
                        const isProtected = PROTECTED_KEYS.includes(key);
                        keys.push({ key: key, size: sizeBytes, protected: isProtected });
                    } catch(e) {
                        keys.push({ key: key, size: 0, protected: false });
                    }
                }
                
                // S3N: Renderizar diagn√≥stico no topo
                if (diagEl) {
                    const totalKB = (totalBytes / 1024).toFixed(3);
                    const totalMB = (totalBytes / (1024 * 1024)).toFixed(3);
                    const totalStr = totalBytes >= 1024 * 1024 ? totalMB + ' MB' : totalKB + ' KB';
                    const maiorKB = (maiorChave.size / 1024).toFixed(3);
                    const maiorMB = (maiorChave.size / (1024 * 1024)).toFixed(3);
                    const maiorStr = maiorChave.size >= 1024 * 1024 ? maiorMB + ' MB' : maiorKB + ' KB';
                    
                    diagEl.innerHTML = 
                        '<div><strong>Total:</strong> ' + keys.length + ' chaves | ' + totalBytes.toLocaleString() + ' bytes (' + totalStr + ')</div>' +
                        '<div style="margin-top: 4px;"><strong>Null:</strong> ' + nullCount + ' | <strong>Vazias:</strong> ' + emptyCount + '</div>' +
                        '<div style="margin-top: 4px;"><strong>Maior:</strong> ' + escapeHtml(maiorChave.key) + ' = ' + maiorChave.size.toLocaleString() + ' bytes (' + maiorStr + ')</div>';
                }
                
                // Ordenar por tamanho (desc)
                keys.sort((a, b) => b.size - a.size);
                
                // Renderizar lista
                if (keys.length === 0) {
                    listEl.innerHTML = '<div style="color: rgba(255,255,255,0.6);">Nenhuma chave encontrada</div>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="border-bottom: 1px solid rgba(255,255,255,0.2);"><th style="text-align: left; padding: 5px;">Chave</th><th style="text-align: right; padding: 5px;">Bytes</th><th style="text-align: right; padding: 5px;">KB</th><th style="text-align: center; padding: 5px;">Status</th></tr>';
                
                keys.forEach(function(item) {
                    // S3N: Exibir bytes e KB com 3 casas
                    const sizeKB = (item.size / 1024).toFixed(3);
                    const sizeMB = (item.size / (1024 * 1024)).toFixed(3);
                    const sizeKBStr = item.size >= 1024 * 1024 ? sizeMB + ' MB' : sizeKB + ' KB';
                    const statusStr = item.protected ? '<span style="color: #4CAF50;">PROTEGIDA</span>' : (item.size > 200 * 1024 ? '<span style="color: #ff9800;">SUSPEITA</span>' : '');
                    html += '<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">';
                    html += '<td style="padding: 5px; word-break: break-all;">' + escapeHtml(item.key) + '</td>';
                    html += '<td style="padding: 5px; text-align: right; font-family: monospace;">' + item.size.toLocaleString() + '</td>';
                    html += '<td style="padding: 5px; text-align: right; font-family: monospace;">' + sizeKBStr + '</td>';
                    html += '<td style="padding: 5px; text-align: center;">' + statusStr + '</td>';
                    html += '</tr>';
                });
                
                html += '</table>';
                listEl.innerHTML = html;
            } catch(e) {
                listEl.innerHTML = '<div style="color: #ff6b6b;">Erro ao carregar chaves: ' + escapeHtml(String(e)) + '</div>';
                if (diagEl) {
                    diagEl.innerHTML = '<div style="color: #ff6b6b;">Erro no diagn√≥stico: ' + escapeHtml(String(e)) + '</div>';
                }
            }
        }
        
        // Escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Baixar backup apenas das chaves essenciais protegidas
        function downloadEssentialData() {
            try {
                const backup = {};
                PROTECTED_KEYS.forEach(function(key) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value !== null) {
                            backup[key] = value;
                        }
                    } catch(e) {
                        backup[key] = null;
                    }
                });
                
                const jsonStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vrvs_essential_data_' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                const status = document.getElementById('status');
                status.textContent = '‚úÖ Dados essenciais exportados com sucesso!';
                status.style.color = '#4CAF50';
            } catch(e) {
                const status = document.getElementById('status');
                status.textContent = '‚ùå Erro ao exportar: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        }
        
        // Executar limpeza selecionada
        function executeStorageCleanup() {
            const status = document.getElementById('status');
            const cleanBackups = document.getElementById('cleanBackups').checked;
            const cleanDebug = document.getElementById('cleanDebug').checked;
            const cleanLarge = document.getElementById('cleanLarge').checked;
            
            if (!cleanBackups && !cleanDebug && !cleanLarge) {
                status.textContent = '‚ö†Ô∏è Selecione pelo menos uma op√ß√£o de limpeza.';
                status.style.color = '#ff9800';
                return;
            }
            
            // Confirma√ß√£o expl√≠cita
            const confirmMsg = 'Tem certeza que deseja executar a limpeza selecionada?\n\n' +
                              'Isso ir√° remover:\n' +
                              (cleanBackups ? '- Backups antigos\n' : '') +
                              (cleanDebug ? '- Chaves de debug/trace/temp\n' : '') +
                              (cleanLarge ? '- Chaves grandes n√£o protegidas\n' : '') +
                              '\nChaves protegidas N√ÉO ser√£o removidas.';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Padr√µes seguros para limpeza
            const patterns = [];
            if (cleanBackups) {
                patterns.push(/^vrvs_backup_/);
            }
            if (cleanDebug) {
                patterns.push(/^__vrvs/);
                patterns.push(/^vrvs_boot/);
                patterns.push(/^vrvs_trace/);
                patterns.push(/^vrvs_tmp/);
            }
            
            let removedCount = 0;
            let removedSize = 0;
            
            try {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    
                    // Pular chaves protegidas
                    if (PROTECTED_KEYS.includes(key)) continue;
                    
                    let shouldRemove = false;
                    
                    // Verificar padr√µes
                    if (patterns.some(p => p.test(key))) {
                        shouldRemove = true;
                    }
                    
                    // Verificar tamanho grande (se op√ß√£o marcada)
                    if (cleanLarge && !shouldRemove) {
                        try {
                            const value = localStorage.getItem(key);
                            // S3N: Ajustar c√°lculo - value === null √© diferente de value === ''
                            const size = (value === null) ? 0 : (value.length * 2);
                            if (size > 200 * 1024) {
                                shouldRemove = true;
                            }
                        } catch(e) {
                            // Ignorar erros ao ler
                        }
                    }
                    
                    if (shouldRemove) {
                        try {
                            const value = localStorage.getItem(key);
                            // S3N: Ajustar c√°lculo - value === null √© diferente de value === ''
                            const size = (value === null) ? 0 : (value.length * 2);
                            keysToRemove.push({ key: key, size: size });
                        } catch(e) {
                            keysToRemove.push({ key: key, size: 0 });
                        }
                    }
                }
                
                // Remover chaves
                keysToRemove.forEach(function(item) {
                    try {
                        localStorage.removeItem(item.key);
                        removedCount++;
                        removedSize += item.size;
                    } catch(e) {
                        // Ignorar erros de remo√ß√£o
                    }
                });
                
                const sizeMB = (removedSize / (1024 * 1024)).toFixed(2);
                const sizeKB = (removedSize / 1024).toFixed(2);
                const sizeStr = removedSize >= 1024 * 1024 ? sizeMB + ' MB' : sizeKB + ' KB';
                
                status.textContent = '‚úÖ Limpeza conclu√≠da! ' + removedCount + ' chave(s) removida(s), ' + sizeStr + ' liberados.';
                status.style.color = '#4CAF50';
                
                // S3N: Teste de escrita ap√≥s limpeza
                testQuotaWrite();
                
                // Recarregar lista
                loadStorageKeys();
                
                // Redirecionar ap√≥s 2 segundos
                setTimeout(function() {
                    goBackToApp();
                }, 2000);
            } catch(e) {
                status.textContent = '‚ùå Erro durante limpeza: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        }
        
        // S3N: Limpar FLAGS (chaves n√£o essenciais)
        function clearFlags() {
            const FLAGS_TO_REMOVE = [
                'vrvs_disable_sw',
                'vrvs_mostrar_changelog',
                'vrvs_versao_anterior',
                'vrvs_tutorial_completo',
                'vrvs_last_boot_step',
                'vrvs_last_boot_err'
            ];
            
            if (!confirm('Tem certeza que deseja remover as FLAGS?\n\nIsso ir√° remover: ' + FLAGS_TO_REMOVE.join(', ') + '\n\nChaves protegidas N√ÉO ser√£o removidas.')) {
                return;
            }
            
            const status = document.getElementById('status');
            let removedCount = 0;
            
            try {
                FLAGS_TO_REMOVE.forEach(function(key) {
                    try {
                        if (localStorage.getItem(key) !== null) {
                            localStorage.removeItem(key);
                            removedCount++;
                        }
                    } catch(e) {
                        // Ignorar erros
                    }
                });
                
                status.textContent = '‚úÖ ' + removedCount + ' FLAG(s) removida(s).';
                status.style.color = '#4CAF50';
                
                // S3N: Teste de escrita ap√≥s limpeza
                testQuotaWrite();
                
                // Recarregar lista
                loadStorageKeys();
            } catch(e) {
                status.textContent = '‚ùå Erro ao remover FLAGS: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        }
        
        // S3N: Limpar Cache Storage (caches.keys() e deletar todos)
        async function clearCacheStorage() {
            if (!('caches' in window)) {
                const status = document.getElementById('status');
                status.textContent = '‚ö†Ô∏è Cache Storage n√£o dispon√≠vel neste navegador.';
                status.style.color = '#ff9800';
                return;
            }
            
            if (!confirm('Tem certeza que deseja limpar TODOS os caches do Cache Storage?\n\nIsso ir√° remover todos os caches, mas N√ÉO afeta localStorage.')) {
                return;
            }
            
            const status = document.getElementById('status');
            status.textContent = 'Processando...';
            
            try {
                const cacheNames = await caches.keys();
                let deletedCount = 0;
                
                for (let name of cacheNames) {
                    try {
                        await caches.delete(name);
                        deletedCount++;
                    } catch(e) {
                        // Ignorar erros individuais
                    }
                }
                
                status.textContent = '‚úÖ ' + deletedCount + ' cache(s) removido(s) do Cache Storage.';
                status.style.color = '#4CAF50';
                
                // S3N: Teste de escrita ap√≥s limpeza
                testQuotaWrite();
            } catch(e) {
                status.textContent = '‚ùå Erro ao limpar Cache Storage: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        }
        
        // S3N FIX: Remover backup grande manualmente
        function removeLargeBackup() {
            if (!confirm('Tem certeza que deseja remover TODOS os backups (vrvs_backup_*)?\n\nIsso ir√° liberar espa√ßo significativo.')) {
                return;
            }
            
            const status = document.getElementById('status');
            status.textContent = 'Processando...';
            
            try {
                const keysToRemove = [];
                let totalSize = 0;
                
                // Encontrar todos os backups
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    
                    if (key.startsWith('vrvs_backup_')) {
                        try {
                            const value = localStorage.getItem(key);
                            const size = (value === null) ? 0 : (value.length * 2);
                            keysToRemove.push({ key: key, size: size });
                            totalSize += size;
                        } catch(e) {
                            keysToRemove.push({ key: key, size: 0 });
                        }
                    }
                }
                
                if (keysToRemove.length === 0) {
                    status.textContent = '‚ö†Ô∏è Nenhum backup encontrado.';
                    status.style.color = '#ff9800';
                    return;
                }
                
                // Remover backups
                let removedCount = 0;
                keysToRemove.forEach(function(item) {
                    try {
                        localStorage.removeItem(item.key);
                        removedCount++;
                    } catch(e) {
                        // Ignorar erros
                    }
                });
                
                const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                const sizeKB = (totalSize / 1024).toFixed(2);
                const sizeStr = totalSize >= 1024 * 1024 ? sizeMB + ' MB' : sizeKB + ' KB';
                
                status.textContent = '‚úÖ ' + removedCount + ' backup(s) removido(s), ' + sizeStr + ' liberados.';
                status.style.color = '#4CAF50';
                
                // Teste de escrita
                testQuotaWrite();
                
                // Recarregar lista
                loadStorageKeys();
                
                // Redirecionar ap√≥s 2 segundos
                setTimeout(function() {
                    goBackToApp();
                }, 2000);
            } catch(e) {
                status.textContent = '‚ùå Erro ao remover backups: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        }
        
        // S3N: Teste de escrita ap√≥s qualquer limpeza
        function testQuotaWrite() {
            const resultEl = document.getElementById('writeTestResult');
            if (!resultEl) return;
            
            try {
                localStorage.setItem('vrvs_tmp_quota_test', '1');
                localStorage.removeItem('vrvs_tmp_quota_test');
                
                resultEl.style.display = 'block';
                resultEl.style.background = 'rgba(76, 175, 80, 0.2)';
                resultEl.style.color = '#4CAF50';
                resultEl.textContent = '‚úÖ Teste de escrita: PASS (localStorage tem espa√ßo dispon√≠vel)';
            } catch(e) {
                resultEl.style.display = 'block';
                resultEl.style.background = 'rgba(244, 67, 54, 0.2)';
                resultEl.style.color = '#f44336';
                
                if (e.name === 'QuotaExceededError' || e.code === 22 || (e.message && e.message.toLowerCase().includes('quota'))) {
                    resultEl.textContent = '‚ùå Teste de escrita: FAIL (QuotaExceededError - localStorage ainda est√° cheio)';
                } else {
                    resultEl.textContent = '‚ùå Teste de escrita: FAIL (' + escapeHtml(String(e)) + ')';
                }
            }
        }
        
        // Voltar para o app com cache-bust
        function goBackToApp() {
            const timestamp = Date.now();
            window.location.href = './index.html?recovered=1&v=' + timestamp;
        }
        
        async function recover() {
            const status = document.getElementById('status');
            status.textContent = 'Processando...';
            try {
                // 1. Unregister Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let reg of registrations) {
                        await reg.unregister();
                        status.textContent += ' ‚úì SW removido';
                    }
                }
                // 2. Limpar todos os caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        status.textContent += ' ‚úì Cache ' + name + ' removido';
                    }
                }
                // 3. Aguardar um pouco
                await new Promise(resolve => setTimeout(resolve, 500));
                // 4. Redirect para index.html com flag de recovery
                status.textContent = '‚úì Conclu√≠do! Redirecionando...';
                setTimeout(() => {
                    window.location.href = './index.html?recovered=1';
                }, 1000);
            } catch(e) {
                status.textContent = '‚ùå Erro: ' + e.message;
                console.error('[RECOVERY] Erro:', e);
            }
        }
    </script>
</body>
</html>
