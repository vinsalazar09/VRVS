<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1a1f">
<title>VRVS v5.1.1 â€“ Circuit Final (stable)</title>
<style>
/* ======== CIRCUIT THEME (Ã¢mbar + turquesa) â€“ compacto e estÃ¡vel ======== */
:root{
  --bg:#0a1a1f; --bg2:#0c1418; --panel:#112129; --grid:#0f2a30;
  --txt:#e8fbff; --muted:#9ac2c9;
  --tz:#00ced1; --tz2:#00ffe0;
  --am:#ff7f50; --am2:#ffa366; --warn:#e55100;
  --ok:#14c38e; --err:#ef4444;
  --glass:rgba(17,33,41,.6); --glass2:rgba(17,33,41,.9);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{background:var(--bg);color:var(--txt);font:14px/1.5 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;min-height:100%}
.header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,26,31,.95),rgba(10,26,31,.7));backdrop-filter:saturate(140%) blur(10px);padding:16px 14px;border-bottom:1px solid rgba(0,206,209,.18)}
.h1{font-weight:900;font-size:20px;letter-spacing:.4px;background:linear-gradient(90deg,var(--tz2),var(--am2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.h2{color:var(--tz);font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;opacity:.9}
.tabs{display:flex;gap:8px;overflow-x:auto;padding:12px 10px;border-bottom:1px solid rgba(0,206,209,.1)}
.tab{flex:0 0 auto;background:var(--glass);border:1px solid rgba(0,206,209,.25);color:var(--tz);padding:8px 12px;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap}
.tab.active{border-color:var(--am);color:var(--am2);box-shadow:0 0 0 1px rgba(255,127,80,.18) inset}
.content{padding:18px 10px 80px}
.card{background:linear-gradient(180deg,rgba(17,33,41,.72),rgba(17,33,41,.55));border:1px solid rgba(0,206,209,.2);border-radius:16px;padding:18px;margin:10px 0}
.card .title{font-weight:900;color:var(--tz2);margin-bottom:12px}
.form-group{margin:10px 0}
.form-label{display:block;color:var(--tz);font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;background:rgba(10,26,31,.7);border:1px solid rgba(0,206,209,.25);color:var(--txt);border-radius:10px;padding:10px 12px}
.form-textarea{min-height:96px;resize:vertical}
.row{display:grid;gap:10px}
@media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
.btn{background:linear-gradient(90deg,var(--am),var(--warn));border:0;color:white;font-weight:900;padding:12px 16px;border-radius:12px;cursor:pointer}
.btn.secondary{background:linear-gradient(90deg,rgba(0,206,209,.25),rgba(0,206,209,.18));color:var(--tz)}
.btn.small{font-size:12px;padding:8px 10px;border-radius:8px}
.data-table{width:100%;border-collapse:separate;border-spacing:0 8px}
.data-table th{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--tz);text-align:left;padding:10px;border-bottom:1px solid rgba(0,206,209,.22)}
.data-table td{background:rgba(17,33,41,.45);padding:10px;border-top:1px solid rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.03)}
.message{position:fixed;right:16px;top:86px;z-index:99;background:var(--glass2);border:1px solid rgba(0,206,209,.3);border-left:4px solid var(--ok);padding:10px 12px;border-radius:10px}
.message.error{border-left-color:var(--err)}
.empty{opacity:.7;text-align:center;padding:24px}
.badge{display:inline-block;padding:4px 8px;border-radius:8px;border:1px solid rgba(0,206,209,.25);color:var(--tz);font-size:11px;font-weight:700}
.grid-bg{position:fixed;inset:0;z-index:-1;background-image:linear-gradient(rgba(0,206,209,.07) 1px,transparent 1px),linear-gradient(90deg,rgba(0,206,209,.07) 1px,transparent 1px);background-size:50px 50px}
hr.sep{border:0;border-top:1px dashed rgba(0,206,209,.2);margin:12px 0}
</style>
</head>
<body>
<div class="grid-bg"></div>
<header class="header">
  <div class="h1">ğŸ§  VRVS CIRCUIT TECH</div>
  <div class="h2">TEOT 2026 â€¢ v5.1.1</div>
</header>

<nav class="tabs" id="tabs">
  <button class="tab active" data-target="dados">ğŸ“Š Dados</button>
  <button class="tab" data-target="cadastro">â• Cadastro</button>
  <button class="tab" data-target="feedback">ğŸ“ Feedback</button>
  <button class="tab" data-target="tarefa">ğŸ“‹ Tarefa</button>
  <button class="tab" data-target="agenda">ğŸ“… Agenda</button>
  <button class="tab" data-target="pendencias">ğŸ”” PendÃªncias</button>
  <button class="tab" data-target="stats">ğŸ“ˆ EstatÃ­sticas</button>
  <button class="tab" data-target="historico">ğŸ“œ HistÃ³rico</button>
  <button class="tab" data-target="relatorios">ğŸ“Š RelatÃ³rios</button>
  <button class="tab" data-target="importar">ğŸ“¥ Importar</button>
  <button class="tab" data-target="exportar">ğŸ“¤ Exportar</button>
</nav>

<main class="content">

<section id="dados" class="card">
  <div class="title">ğŸ“Š Banco de dados</div>
  <div style="overflow-x:auto">
    <table class="data-table">
      <thead><tr>
        <th>Ãrea</th><th>Tema</th><th>Status</th><th>Prior.</th><th>Rend.</th>
        <th>SessÃµes</th><th>Ãšlt.Estudo</th><th>Agenda</th><th style="text-align:center">AÃ§Ãµes</th>
      </tr></thead>
      <tbody id="dadosTable"></tbody>
    </table>
  </div>
</section>

<section id="cadastro" class="card" hidden>
  <div class="title">â• Adicionar tema</div>
  <form id="formCadastro" class="row row-3">
    <div class="form-group">
      <label class="form-label">Ãrea</label>
      <input id="cadArea" class="form-input" placeholder="Ex: Ombro e Cotovelo" required>
    </div>
    <div class="form-group">
      <label class="form-label">Tema</label>
      <input id="cadTema" class="form-input" placeholder="Ex: Sd manguito rotador" required>
    </div>
    <div class="form-group">
      <label class="form-label">Prioridade</label>
      <input id="cadPrior" type="number" min="1" max="5" value="3" class="form-input" required>
    </div>
    <div class="form-group">
      <label class="form-label">Data inicial (opcional)</label>
      <input id="cadData" type="date" class="form-input">
    </div>
    <div class="form-group"><label class="form-label">&nbsp;</label>
      <button class="btn" type="submit">âœ… Adicionar</button>
    </div>
  </form>
</section>

<section id="feedback" class="card" hidden>
  <div class="title">ğŸ“ Registrar performance</div>
  <form id="formFeedback" class="row">
    <div class="row row-2">
      <div class="form-group">
        <label class="form-label">Ãrea</label>
        <select id="fbArea" class="form-select"></select>
      </div>
      <div class="form-group">
        <label class="form-label">MÃ³dulo (Tema)</label>
        <select id="fbTema" class="form-select"></select>
      </div>
    </div>
    <div class="row row-3">
      <div class="form-group">
        <label class="form-label">Data da sessÃ£o</label>
        <input id="fbData" type="date" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label">Performance (%)</label>
        <input id="fbRend" type="number" min="0" max="100" class="form-input" placeholder="0-100" required>
      </div>
      <div class="form-group">
        <label class="form-label">DuraÃ§Ã£o (min)</label>
        <input id="fbTempo" type="number" min="0" class="form-input" placeholder="Minutos" required>
      </div>
    </div>
    <div class="row row-2">
      <div class="form-group">
        <label class="form-label">Diretriz prÃ³xima sessÃ£o</label>
        <input id="fbSug" class="form-input" placeholder="Ex: Revisar flashcards + questÃµes">
      </div>
      <div class="form-group">
        <label class="form-label">Log da sessÃ£o</label>
        <textarea id="fbObs" class="form-textarea" placeholder="Ex: Q17/20 em 30min | FC8/10 em 15min"></textarea>
      </div>
    </div>
    <div class="row row-2">
      <button class="btn" type="submit">âœ… Salvar performance</button>
      <button class="btn secondary" id="btnDesfazer" type="button">â†©ï¸ Desfazer Ãºltimo</button>
    </div>
  </form>
</section>

<section id="tarefa" class="card" hidden>
  <div class="title">ğŸ“‹ MissÃµes do dia</div>
  <div id="tarefasBox"></div>
</section>

<section id="agenda" class="card" hidden>
  <div class="title">ğŸ“… Timeline</div>
  <div class="row row-3">
    <div class="form-group">
      <label class="form-label">InÃ­cio</label>
      <input id="agIni" type="date" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Fim</label>
      <input id="agFim" type="date" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Filtros rÃ¡pidos</label>
      <div class="row row-3">
        <button class="btn small secondary" type="button" data-range="today">Hoje</button>
        <button class="btn small secondary" type="button" data-range="week">Semana</button>
        <button class="btn small secondary" type="button" data-range="7d">PrÃ³x. 7 dias</button>
      </div>
    </div>
  </div>
  <hr class="sep">
  <div id="agendaBox"></div>
</section>

<section id="pendencias" class="card" hidden>
  <div class="title">ğŸ”” Alertas do sistema</div>
  <div id="pendBox"></div>
</section>

<section id="stats" class="card" hidden>
  <div class="title">ğŸ“ˆ Analytics</div>
  <div class="row row-3">
    <div class="card"><div class="h2">MÃ³dulos ativos</div><div class="h1" id="sTemas">0</div></div>
    <div class="card"><div class="h2">SessÃµes</div><div class="h1" id="sSess">0</div></div>
    <div class="card"><div class="h2">Tempo</div><div class="h1" id="sTempo">0h</div></div>
  </div>
  <div class="card"><canvas id="cBarras" height="220"></canvas></div>
  <div class="card"><canvas id="cLinha"  height="220"></canvas></div>
  <div class="card"><canvas id="cRadar"  height="300"></canvas></div>
</section>

<section id="historico" class="card" hidden>
  <div class="title">ğŸ“œ Registro completo</div>
  <div class="card">
    <div class="form-label">Corrigir datas antigas</div>
    <div class="row row-3">
      <select id="histSemData" class="form-select"></select>
      <input id="histNovaData" type="date" class="form-input">
      <button class="btn small" id="btnCorrigirData" type="button">Salvar</button>
    </div>
  </div>
  <div style="overflow-x:auto">
    <table class="data-table">
      <thead><tr>
        <th>Data</th><th>Tema</th><th>Ãrea</th><th>Rend.</th><th>Tempo</th><th>ObservaÃ§Ãµes</th><th>SugestÃ£o</th>
      </tr></thead>
      <tbody id="histTable"></tbody>
    </table>
  </div>
</section>

<section id="relatorios" class="card" hidden>
  <div class="title">ğŸ“Š AnÃ¡lise por perÃ­odo</div>
  <div class="row row-3">
    <input id="rIni" type="date" class="form-input">
    <input id="rFim" type="date" class="form-input">
    <button id="btnRel" class="btn small" type="button">Gerar</button>
  </div>
  <div id="relBox" style="margin-top:12px"></div>
  <button id="btnRelExp" class="btn secondary" style="margin-top:12px" type="button" hidden>ğŸ“¥ Exportar perÃ­odo</button>
</section>

<section id="importar" class="card" hidden>
  <div class="title">ğŸ“¥ Importar dados</div>
  <div class="form-group"><label class="form-label">DADOS.csv</label><input id="inDados" type="file" accept=".csv" class="form-input"></div>
  <div class="form-group"><label class="form-label">HISTORICO.csv</label><input id="inHist" type="file" accept=".csv" class="form-input"></div>
  <div class="row row-2">
    <button class="btn" id="btnProcessar" type="button">ğŸ“¥ Processar importaÃ§Ã£o</button>
    <button class="btn secondary" id="btnReset" type="button">ğŸ—‘ï¸ Reset completo</button>
  </div>
</section>

<section id="exportar" class="card" hidden>
  <div class="title">ğŸ“¤ Backup</div>
  <div class="row row-2">
    <button class="btn secondary" id="btnExpDados" type="button">ğŸ“Š Baixar DADOS.csv</button>
    <button class="btn secondary" id="btnExpHist"  type="button">ğŸ“œ Baixar HISTORICO.csv</button>
  </div>
</section>

<div id="toast" class="message" style="display:none"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ========================= VRVS CORE â€“ v5.1.1 ========================= */
let dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
let historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');

function save(){ localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                 localStorage.setItem('vrvs_historico', JSON.stringify(historico)); }

function toast(msg, ok=true){ const el = document.getElementById('toast');
  el.className = 'message'+(ok?'':' error'); el.innerHTML = msg; el.style.display='block';
  clearTimeout(el._t); el._t = setTimeout(()=>el.style.display='none',4200);
}

/* ====== NormalizaÃ§Ã£o / Util ====== */
function normalizeArea(raw){
  let a = String(raw||'').trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const map = {
    'trauma mmss':'Trauma MMSS','trauma membros superiores':'Trauma MMSS',
    'trauma mmii':'Trauma MMII','trauma membros inferiores':'Trauma MMII',
    'ombro':'Ombro e Cotovelo','cotovelo':'Ombro e Cotovelo','ombro e cotovelo':'Ombro e Cotovelo',
    'mao':'MÃ£o','punho':'MÃ£o','pe e tornozelo':'PÃ© e Tornozelo','tornozelo':'PÃ© e Tornozelo',
    'quadril':'Quadril','pelve':'Quadril','coluna':'Coluna',
    'oncologia':'Oncologia','tumores':'Oncologia','trauma':'Trauma'
  };
  return map[a] || a.replace(/\b\w/g,m=>m.toUpperCase());
}
function extrairUltimaSugestao(obs){
  if(!obs) return '';
  const linhas = String(obs).split('\n');
  for(let i=linhas.length-1;i>=0;i--){
    const m = linhas[i].match(/[Ss]ugest(Ã£o|ao)\s*:\s*(.*)$/);
    if(m) return m[2].trim();
  }
  return '';
}
function tipoRevisao(t){
  const r = Math.round((t.rendimento||0)*100), s = t.sessoes||0;
  if(s===0) return 'ğŸ†• Primeira sessÃ£o';
  if(s===1) return 'âš¡ QuestÃµes/flashcards';
  if(r<50) return 'ğŸ“š Revisar teoria completa';
  if(r<60) return 'ğŸ“¹ Aula + questÃµes';
  if(r<80) return 'ğŸ“– Resumo + questÃµes';
  return 'âš¡ QuestÃµes/flashcards';
}

/* ====== Spaced Repetition ====== */
const _origCalc = function(tema){
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  if(!tema.sessoes || tema.sessoes===0){ const p = new Date(hoje); p.setDate(p.getDate()+1); return p.toISOString().split('T')[0];}
  const r = Math.round((tema.rendimento||0)*100);
  const pr = parseInt(tema.prioridade)||3;
  let int=1;
  if(r<50) int=1; else if(r<80) int=3; else {
    const c = parseInt(tema.contador80)||0;
    int = [7,14,30,60,90][Math.min(c,4)];
    if(pr===5 && int>30) int=30;
  }
  const p = new Date(hoje); p.setDate(p.getDate()+int);
  return p.toISOString().split('T')[0];
};
function calcularProximaRevisao(t){ // 2Âª sessÃ£o = amanhÃ£
  if(Number(t.sessoes)===1){ const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().split('T')[0]; }
  return _origCalc(t);
}

/* ====== Cores determinÃ­sticas por Ãrea ====== */
const _areaColor = {};
function colorFor(area){
  const key = String(area||'').toLowerCase().trim();
  if(_areaColor[key]) return _areaColor[key];
  let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
  const hue = h%360, sat=66, lig=52;
  return _areaColor[key] = `hsl(${hue} ${sat}% ${lig}%)`;
}

/* ====== Fix antigo de Ãreaâ†”Tema (sem quebrar) ====== */
function fixAreaTema(o){
  if(!o || typeof o!=='object') return o;
  const a = String(o.area||'').trim().toLowerCase();
  const t = String(o.tema||'').trim().toLowerCase();
  if(a==='Ã¡rea' || a==='area') return null;
  if(t==='tema') return null;
  const areas = ['ombro','cotovelo','ombro e cotovelo','joelho','quadril','mÃ£o','mao','punho','tornozelo','pÃ©','pe','coluna','oncologia','trauma','pediÃ¡trico','pediatrico','infecÃ§Ã£o','infeccao','medicina esportiva'];
  const areaLonga = a.length>28;
  const temaTemArea = areas.some(k=>t.includes(k));
  if(areaLonga && temaTemArea){ const tmp=o.area; o.area=o.tema; o.tema=tmp; }
  return o;
}

/* ====== Dados iniciais (normalizaÃ§Ã£o + limpeza leve) ====== */
function sanitizeAll(){
  dados = (Array.isArray(dados)?dados:[]).map(fixAreaTema).filter(Boolean).map(t=>{
    t.area = normalizeArea(t.area);
    t.prioridade = parseInt(t.prioridade)||3;
    t.sessoes = parseInt(t.sessoes)||0;
    t.tempo = parseInt(t.tempo)||0;
    t.contador80 = parseInt(t.contador80)||0;
    t.rendimento = (t.rendimento>1)?(t.rendimento/100):(+t.rendimento||0);
    if(!t.id) t.id = Date.now()+Math.random();
    if(!t.sugestao || t.sugestao==='-') t.sugestao = extrairUltimaSugestao(t.observacoes);
    return t;
  });
  historico = (Array.isArray(historico)?historico:[]).map(fixAreaTema).filter(Boolean).map(h=>{
    h.area = normalizeArea(h.area);
    h.tempo = parseInt(h.tempo)||0;
    h.rendimento = (h.rendimento>1)?(h.rendimento/100):(+h.rendimento||0);
    if(!h.id) h.id = Date.now()+Math.random();
    if(!h.data || h.data==='-'){
      const m = (h.observacoes||'').match(/^(\d{4}-\d{2}-\d{2}):/); if(m) h.data = m[1];
    }
    if(!h.sugestao || h.sugestao==='-') h.sugestao = extrairUltimaSugestao(h.observacoes);
    return h;
  });
  save();
}
sanitizeAll();

/* ========================= UI / NavegaÃ§Ã£o ========================= */
const sections = Array.from(document.querySelectorAll('main > section'));
document.getElementById('tabs').addEventListener('click',e=>{
  if(!e.target.matches('.tab')) return;
  const id = e.target.dataset.target;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===e.target));
  sections.forEach(s=>s.hidden = (s.id!==id));
  // render on demand
  if(id==='dados') renderDados();
  if(id==='tarefa') renderTarefas();
  if(id==='agenda') { initAgendaFilters(); renderAgenda(); }
  if(id==='pendencias') renderPendencias();
  if(id==='stats') renderStats();
  if(id==='historico') renderHistorico();
});

/* ========================= Render â€“ Dados ========================= */
function renderDados(){
  const tb = document.getElementById('dadosTable');
  if(!dados.length){ tb.innerHTML = `<tr><td colspan="9"><div class="empty">Sem dados</div></td></tr>`; return; }
  tb.innerHTML = dados.map(t=>{
    const rend = t.rendimento?Math.round(t.rendimento*100)+'%':'-';
    const rendColor = t.rendimento>=.8? 'style="color:'+colorFor(t.area)+'"' :
                       t.rendimento>=.5? 'style="color:#ffa366"':'style="color:#ef4444"';
    const ue = t.ultEstudo? new Date(t.ultEstudo+'T00:00:00').toLocaleDateString('pt-BR'):'-';
    const ag = t.agenda? new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR'):'-';
    return `<tr>
      <td style="color:${colorFor(t.area)}">${t.area||'-'}</td>
      <td style="font-weight:700;color:#ffa366">${t.tema||'-'}</td>
      <td>${t.status||'NÃ£o iniciado'}</td>
      <td style="text-align:center">${t.prioridade||3}</td>
      <td ${rendColor} style="text-align:center">${rend}</td>
      <td style="text-align:center">${t.sessoes||0}</td>
      <td style="text-align:center">${ue}</td>
      <td style="text-align:center">${ag}</td>
      <td style="text-align:center"><button class="btn small secondary" onclick="openEdit(${t.id})">âœï¸</button></td>
    </tr>`;
  }).join('');
}
window.openEdit = function(id){
  const t = dados.find(x=>String(x.id)===String(id)); if(!t) return;
  const novo = prompt('Editar: Ãrea | Tema | Prioridade | Status', `${t.area}|${t.tema}|${t.prioridade}|${t.status||'Planejado'}`);
  if(!novo) return;
  const [a,tem,p,s] = novo.split('|').map(v=>String(v||'').trim());
  t.area = normalizeArea(a||t.area); t.tema = tem||t.tema; t.prioridade=parseInt(p)||t.prioridade; t.status=s||t.status;
  if(t.sessoes>0) t.agenda = calcularProximaRevisao(t);
  save(); renderDados(); renderPendencias(); updateFeedbackSelects();
};

/* ========================= Render â€“ Tarefa (corrigido) ========================= */
function renderTarefas(){
  const box = document.getElementById('tarefasBox');
  const hoje = new Date().toISOString().split('T')[0];
  const tarefas = dados.filter(t=>{
    // Mostrar se jÃ¡ tem agenda vencida/hoje ou planejado sem agenda mas com prioridade alta
    if(t.status!=='Planejado' && t.status!=='Em estudo') return false;
    if(t.agenda) return t.agenda<=hoje;
    return (t.sessoes===0 && (t.prioridade||0)>=3); // primeira sessÃ£o pendente
  }).sort((a,b)=>{
    if(a.agenda!==b.agenda) return String(a.agenda||'9999').localeCompare(String(b.agenda||'9999'));
    return (b.prioridade||0)-(a.prioridade||0);
  });

  if(!tarefas.length){ box.innerHTML = `<div class="empty">Nenhuma missÃ£o pendente</div>`; return; }

  box.innerHTML = tarefas.map(t=>{
    const r = Math.round((t.rendimento||0)*100);
    const cor = r>=80? colorFor(t.area) : (r>=50? '#ffa366' : '#ef4444');
    const sug = (t.sugestao && t.sugestao!=='-')? t.sugestao : extrairUltimaSugestao(t.observacoes);
    const isHoje = t.agenda===hoje;
    return `<div class="card" style="border-color:${colorFor(t.area)}">
      <div class="row row-3">
        <div><div class="h2">Tema</div><div class="h1" style="font-size:16px">${t.tema} ${isHoje?'ğŸ¯':''}</div></div>
        <div><div class="h2">Ãrea</div><span class="badge" style="border-color:${colorFor(t.area)};color:${colorFor(t.area)}">${t.area}</span></div>
        <div><div class="h2">Quando</div>${t.agenda? new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR'):'â€”'}</div>
      </div>
      <div class="row row-3" style="margin-top:8px">
        <div class="badge">â­ Pri: ${t.prioridade||3}</div>
        <div class="badge" style="color:${cor}">ğŸ“Š ${r||0}%</div>
        <div class="badge">ğŸ“¢ ${t.sessoes||0} sessÃµes</div>
      </div>
      <hr class="sep">
      <div class="badge">${tipoRevisao(t)}</div>
      ${sug? `<div style="margin-top:8px"><span class="form-label" style="display:inline">Diretriz</span> ${sug}</div>`:''}
    </div>`;
  }).join('');
}

/* ========================= Render â€“ Agenda + filtros ========================= */
let agIni='', agFim='';
function initAgendaFilters(){
  const i = document.getElementById('agIni'), f = document.getElementById('agFim');
  if(!i.value && !f.value){
    const d=new Date(), w=d.getDay()||7, ini=new Date(d); ini.setDate(d.getDate()-(w-1));
    const fim=new Date(ini); fim.setDate(ini.getDate()+6);
    i.value = ini.toISOString().split('T')[0];
    f.value = fim.toISOString().split('T')[0];
    agIni=i.value; agFim=f.value;
  }
  document.querySelectorAll('[data-range]').forEach(btn=>{
    btn.onclick=()=>{
      const d=new Date(); d.setHours(0,0,0,0);
      if(btn.dataset.range==='today'){
        i.value=f.value=d.toISOString().split('T')[0];
      }else if(btn.dataset.range==='7d'){
        const e=new Date(d); e.setDate(d.getDate()+7);
        i.value=d.toISOString().split('T')[0]; f.value=e.toISOString().split('T')[0];
      }else{ // week
        const w=d.getDay()||7, ini=new Date(d); ini.setDate(d.getDate()-(w-1));
        const e=new Date(ini); e.setDate(ini.getDate()+6);
        i.value=ini.toISOString().split('T')[0]; f.value=e.toISOString().split('T')[0];
      }
      agIni=i.value; agFim=f.value; renderAgenda();
    }
  });
  i.onchange=()=>{agIni=i.value; renderAgenda();}
  f.onchange=()=>{agFim=f.value; renderAgenda();}
}
function renderAgenda(){
  const box=document.getElementById('agendaBox');
  let lista = dados.filter(t=> t.agenda && (!agIni || t.agenda>=agIni) && (!agFim || t.agenda<=agFim) && t.status!=='ConcluÃ­do')
                   .sort((a,b)=>a.agenda.localeCompare(b.agenda));
  if(!lista.length){ box.innerHTML = `<div class="empty">Timeline vazia</div>`; return; }
  box.innerHTML = lista.map(t=>{
    const r = Math.round((t.rendimento||0)*100);
    return `<div class="card" style="border-color:${colorFor(t.area)}">
      <div class="row row-3">
        <div><div class="h2">Data</div>${new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR')}</div>
        <div><div class="h2">Tema</div><b style="color:#ffa366">${t.tema}</b></div>
        <div><div class="h2">Ãrea</div><span class="badge" style="border-color:${colorFor(t.area)};color:${colorFor(t.area)}">${t.area}</span></div>
      </div>
      <div class="row row-3" style="margin-top:6px">
        <div class="badge">â­ Pri: ${t.prioridade||3}</div>
        <div class="badge">ğŸ“¢ ${t.sessoes||0} sessÃµes</div>
        <div class="badge" style="color:${r>=80?colorFor(t.area):(r>=50?'#ffa366':'#ef4444')}">ğŸ“Š ${r||0}%</div>
      </div>
    </div>`;
  }).join('');
}

/* ========================= Render â€“ PendÃªncias ========================= */
function renderPendencias(){
  const box=document.getElementById('pendBox'), hoje=new Date().toISOString().split('T')[0];
  const atras = dados.filter(t=> t.agenda && t.agenda<hoje && t.status!=='ConcluÃ­do');
  const planos = dados.filter(t=> t.status==='Planejado' && t.sessoes===0);
  const sData = historico.filter(h=>!h.data || h.data==='-');
  const itens=[];
  if(atras.length) itens.push({tipo:'urgent',t:`âš ï¸ ${atras.length} mÃ³dulos em atraso`,d:atras.map(x=>`â€¢ ${x.tema} (${x.agenda})`).join('<br>')});
  if(planos.length) itens.push({tipo:'',t:`ğŸ“‹ ${planos.length} aguardando 1Âª sessÃ£o`,d:planos.map(x=>`â€¢ ${x.tema}`).join('<br>')});
  if(sData.length) itens.push({tipo:'',t:`ğŸ“… ${sData.length} registros sem data`,d:'Use o seletor em HistÃ³rico'});
  if(!itens.length){ box.innerHTML=`<div class="empty">Sistema operacional</div>`; return; }
  box.innerHTML = itens.map(n=>`<div class="card" style="border-color:${n.tipo==='urgent'?'#ff7f50': 'rgba(0,206,209,.35)'}">
    <div class="h1" style="font-size:16px">${n.t}</div><div style="margin-top:6px">${n.d}</div></div>`).join('');
}

/* ========================= Feedback (Ãrea + Tema) ========================= */
function areasUnicas(){ return Array.from(new Set(dados.map(d=>d.area))).sort((a,b)=>a.localeCompare(b,'pt-BR')); }
function updateFeedbackSelects(){
  const sA = document.getElementById('fbArea'), sT = document.getElementById('fbTema');
  const as = areasUnicas();
  sA.innerHTML = `<option value="">Selecione a Ã¡rea...</option>` + as.map(a=>`<option>${a}</option>`).join('');
  const cur = sA.value;
  const base = dados.filter(t=> !cur || t.area===cur);
  sT.innerHTML = `<option value="">Selecione o mÃ³dulo...</option>` + base.map(t=>`<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
}
document.getElementById('fbArea').onchange = updateFeedbackSelects;

document.getElementById('formFeedback').onsubmit = e=>{
  e.preventDefault();
  const temaId = document.getElementById('fbTema').value;
  const data = document.getElementById('fbData').value;
  const rend = parseInt(document.getElementById('fbRend').value)||0;
  const tempo = parseInt(document.getElementById('fbTempo').value)||0;
  const sug = document.getElementById('fbSug').value.trim();
  const obs = document.getElementById('fbObs').value.trim();

  const t = dados.find(x=>String(x.id)===String(temaId));
  if(!t){ toast('âš ï¸ Selecione um mÃ³dulo vÃ¡lido', false); return; }

  // contador80
  if(rend>=80) t.contador80 = (t.contador80||0)+1; else t.contador80 = 0;

  t.rendimento = rend/100; t.sessoes=(t.sessoes||0)+1; t.ultEstudo=data; t.tempo=(t.tempo||0)+tempo;
  t.status = t.sessoes===1 ? 'Em estudo' : t.status;
  t.agenda = calcularProximaRevisao(t);

  let novaObs = obs? `${data}: ${obs}` : '';
  if(sug) novaObs += (novaObs?' | ':'')+`SugestÃ£o: ${sug}`;
  if(novaObs) t.observacoes = t.observacoes? (t.observacoes+'\n'+novaObs) : novaObs;
  t.sugestao = sug||t.sugestao||'';

  historico.push({id:Date.now(), temaId:t.id, area:t.area, tema:t.tema, rendimento:t.rendimento, tempo, data, observacoes:obs||'-', sugestao:sug||'-'});
  save();

  // reset + prÃ³xima data
  document.getElementById('formFeedback').reset();
  document.getElementById('fbData').value = new Date().toISOString().split('T')[0];

  toast(`âœ… Performance registrada! ğŸ“… PrÃ³xima: ${new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR')}`);
  renderTarefas(); renderAgenda(); renderDados(); renderHistorico(); renderPendencias(); renderStats(); updateFeedbackSelects();
};
document.getElementById('btnDesfazer').onclick = ()=>{
  if(!historico.length){ toast('Nada para desfazer', false); return; }
  if(!confirm('Desfazer o Ãºltimo registro?')) return;
  const h = historico.pop();
  const t = dados.find(x=>String(x.id)===String(h.temaId));
  if(t){
    t.sessoes = Math.max(0,(t.sessoes||1)-1);
    t.tempo = Math.max(0,(t.tempo||0)-(h.tempo||0));
    const rest = historico.filter(x=>String(x.temaId)===String(t.id));
    if(rest.length){
      const soma = rest.reduce((s,x)=>s+(x.rendimento||0),0); t.rendimento = soma/rest.length;
      let c=0; for(let i=rest.length-1;i>=0;i--){ if((rest[i].rendimento||0)>=.8) c++; else break; } t.contador80=c;
      const u = rest[rest.length-1]; t.ultEstudo=u?u.data:''; t.agenda=calcularProximaRevisao(t);
    }else{
      t.rendimento=0; t.status='Planejado'; t.ultEstudo=''; t.agenda=''; t.contador80=0;
    }
  }
  save(); toast('âœ… Ãšltimo feedback desfeito'); renderTarefas(); renderAgenda(); renderDados(); renderHistorico(); renderPendencias(); renderStats(); updateFeedbackSelects();
};

/* ========================= HistÃ³rico ========================= */
function renderHistorico(){
  const tb=document.getElementById('histTable');
  if(!historico.length){ tb.innerHTML=`<tr><td colspan="7"><div class="empty">Sem registros</div></td></tr>`; updateHistSemData(); return; }
  const ord=[...historico].sort((a,b)=>{
    if(!a.data || a.data==='-') return 1;
    if(!b.data || b.data==='-') return -1;
    return new Date(b.data)-new Date(a.data);
  });
  tb.innerHTML = ord.map(h=>{
    const d = h.data ? new Date(h.data+'T00:00:00').toLocaleDateString('pt-BR'):'-';
    const r = h.rendimento?Math.round(h.rendimento*100)+'%':'-';
    let cor = '#9ca3af'; if(h.rendimento>=.8) cor=colorFor(h.area); else if(h.rendimento>=.5) cor='#ffa366'; else if(h.rendimento>0) cor='#ef4444';
    return `<tr>
      <td style="color:${(!h.data||h.data==='-')?'#ef4444':'#9ac2c9'}">${d}</td>
      <td style="color:#ffa366;font-weight:700">${h.tema||'-'}</td>
      <td style="color:${colorFor(h.area)}">${h.area||'-'}</td>
      <td style="text-align:center;color:${cor};font-weight:700">${r}</td>
      <td style="text-align:center">${h.tempo? h.tempo+' min':'-'}</td>
      <td>${h.observacoes||'-'}</td>
      <td>${h.sugestao||'-'}</td>
    </tr>`;
  }).join('');
  updateHistSemData();
}
function updateHistSemData(){
  const sel=document.getElementById('histSemData');
  const lista=historico.filter(h=>!h.data || h.data==='-');
  sel.innerHTML = `<option value="">Selecione sessÃ£o sem data...</option>` + lista.map(h=>`<option value="${h.id}">${h.tema} (${Math.round((h.rendimento||0)*100)}%)</option>`).join('');
}
document.getElementById('btnCorrigirData').onclick=()=>{
  const id=document.getElementById('histSemData').value, d=document.getElementById('histNovaData').value;
  if(!id||!d){ toast('Selecione sessÃ£o e data',false); return; }
  const h=historico.find(x=>String(x.id)===String(id)); if(!h) return;
  h.data=d; save(); toast('âœ… Data atualizada'); document.getElementById('histSemData').value=''; document.getElementById('histNovaData').value=''; renderHistorico(); renderPendencias();
};

/* ========================= EstatÃ­sticas + GrÃ¡ficos ========================= */
let gBar=null,gLin=null,gRad=null;
function renderStats(){
  document.getElementById('sTemas').textContent = dados.length;
  document.getElementById('sSess').textContent  = historico.length;
  const min = historico.reduce((s,h)=>s+(h.tempo||0),0); document.getElementById('sTempo').textContent = Math.round(min/60)+'h';
  if(!window.Chart){ console.warn('Chart.js offline'); return; }

  // Barras: mÃ©dia por Ã¡rea
  const porArea = {};
  historico.forEach(h=>{ if(!h.area||!h.rendimento) return; const a=h.area; (porArea[a]||(porArea[a]={sum:0,c:0})); porArea[a].sum+=h.rendimento*100; porArea[a].c++; });
  const labels=Object.keys(porArea), media=labels.map(a=>Math.round(porArea[a].sum/porArea[a].c)), cores=labels.map(colorFor);
  if(gBar) gBar.destroy();
  gBar = new Chart(document.getElementById('cBarras'), {type:'bar', data:{labels,datasets:[{data:media,backgroundColor:cores,borderColor:cores}]}, options:{responsive:true,plugins:{legend:{display:false}}} });

  // Linha: evoluÃ§Ã£o por Ã¡rea (sessÃ£o vs rendimento)
  const evo={}; historico.forEach(h=>{ if(!h.area) return; (evo[h.area]||(evo[h.area]=[])).push(h); });
  const ds = Object.entries(evo).map(([a,arr])=>{
    const sorted = arr.map((x,i)=>({x:i+1,y:Math.round((x.rendimento||0)*100)}));
    const c=colorFor(a); return {label:a,data:sorted,borderColor:c,backgroundColor:c+'33',tension:.3};
  });
  if(gLin) gLin.destroy(); gLin=new Chart(document.getElementById('cLinha'),{type:'line',data:{datasets:ds},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});

  // Radar: mÃ©dia por Ã¡rea
  if(gRad) gRad.destroy(); gRad=new Chart(document.getElementById('cRadar'),{type:'radar',data:{labels,datasets:[{data:media,borderColor:'#00ffe0',backgroundColor:'rgba(0,255,224,.2)'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

/* ========================= RelatÃ³rios ========================= */
let ultimoPeriodo=null;
document.getElementById('btnRel').onclick=()=>{
  const ini=document.getElementById('rIni').value, fim=document.getElementById('rFim').value;
  if(!ini||!fim){ toast('Defina perÃ­odo completo',false); return; }
  const lista = historico.filter(h=>h.data && h.data>=ini && h.data<=fim);
  const box=document.getElementById('relBox');
  if(!lista.length){ box.innerHTML=`<div class="empty">Sem dados no perÃ­odo</div>`; document.getElementById('btnRelExp').hidden=true; return; }
  const sess=lista.length, tempo=lista.reduce((s,h)=>s+(h.tempo||0),0), rend=Math.round(lista.reduce((s,h)=>s+(h.rendimento||0),0)/sess*100);
  const porArea={}; lista.forEach(h=>{const a=h.area||'Sem Ã¡rea'; (porArea[a]||(porArea[a]={c:0,t:0,r:0})); porArea[a].c++; porArea[a].t+=h.tempo||0; porArea[a].r+=h.rendimento||0;});
  box.innerHTML = `<div class="row row-3">
    <div class="card"><div class="h2">SessÃµes</div><div class="h1">${sess}</div></div>
    <div class="card"><div class="h2">Tempo</div><div class="h1">${Math.round(tempo/60)}h</div></div>
    <div class="card"><div class="h2">Performance</div><div class="h1">${rend}%</div></div>
  </div>
  <div class="card"><div class="title">Detalhamento por Ã¡rea</div>
    <table class="data-table"><thead><tr><th>Ãrea</th><th>SessÃµes</th><th>Tempo</th><th>Rendimento</th></tr></thead>
    <tbody>${
      Object.entries(porArea).map(([a,v])=>`<tr>
        <td style="color:${colorFor(a)}">${a}</td>
        <td style="text-align:center">${v.c}</td>
        <td style="text-align:center">${v.t} min</td>
        <td style="text-align:center">${Math.round(v.r/v.c*100)}%</td>
      </tr>`).join('')
    }</tbody></table>
  </div>`;
  ultimoPeriodo={ini,fim,lista}; document.getElementById('btnRelExp').hidden=false;
};
document.getElementById('btnRelExp').onclick=()=>{
  if(!ultimoPeriodo){ toast('Gere o relatÃ³rio primeiro',false); return; }
  const csv = toCSV(ultimoPeriodo.lista); downloadCSV(csv, `VRVS_RELATORIO_${ultimoPeriodo.ini}_${ultimoPeriodo.fim}.csv`);
};

/* ========================= Import / Export ========================= */
document.getElementById('btnReset').onclick=()=>{
  if(!confirm('Apagar TODOS os dados?')) return;
  if(!confirm('Confirma?')) return;
  dados=[]; historico=[]; save(); toast('ğŸ—‘ï¸ Reset completo'); renderDados(); renderHistorico(); renderTarefas(); renderAgenda(); renderPendencias(); renderStats(); updateFeedbackSelects();
};
document.getElementById('btnProcessar').onclick=async()=>{
  const fD=document.getElementById('inDados').files[0], fH=document.getElementById('inHist').files[0];
  if(!fD && !fH){ toast('Selecione arquivo',false); return; }
  try{
    if(fD){
      const arr = await parseCSVFile(fD);
      dados = arr.map(r=>{
        const t={
          id: r.id || (Date.now()+Math.random()),
          area: normalizeArea(r.area||r.topico),
          tema: r.tema||r.assunto||r.titulo,
          status: r.status||'NÃ£o iniciado',
          prioridade: parseInt(r.prioridade||r.prior)||3,
          dificuldade: r.dificuldade||'MÃ©dia',
          rendimento: (r.rendimento? (String(r.rendimento).includes('%')? parseFloat(String(r.rendimento).replace('%','').replace(',','.'))/100 : (+r.rendimento>1? +r.rendimento/100 : +r.rendimento)) : 0),
          sessoes: parseInt(r.sessoes||r.sessao)||0,
          ultEstudo: r.ultestudo||r.ultimoestudo||r.ultimo_estudo||'',
          agenda: r.dataagenda||r.agenda||r.data_agenda||'',
          tempo: parseInt(r.tempomin||r.tempo)||0,
          observacoes: r.observacoes||r.obs||r.observacao||'',
          contador80: parseInt(r.contador80)||0,
          sugestao: r.sugestao||r.sugestoes||''
        };
        if(!t.sugestao) t.sugestao = extrairUltimaSugestao(t.observacoes);
        return t;
      }).filter(o=>o.tema && o.tema.trim()!=='');
      save();
    }
    if(fH){
      const arr = await parseCSVFile(fH);
      historico = arr.map(r=>{
        const h={
          id: r.id || (Date.now()+Math.random()),
          temaId: r.temaid || r.temaId || '',
          area: normalizeArea(r.area),
          tema: r.tema,
          rendimento: (r.rendimento? (String(r.rendimento).includes('%')? parseFloat(String(r.rendimento).replace('%','').replace(',','.'))/100 : (+r.rendimento>1? +r.rendimento/100 : +r.rendimento)) : 0),
          tempo: parseInt(r.tempo)||0,
          data: r.data||'',
          observacoes: r.observacoes||r.obs||'',
          sugestao: r.sugestao||''
        };
        if(!h.data || h.data==='-'){ const m=(h.observacoes||'').match(/^(\d{4}-\d{2}-\d{2}):/); if(m) h.data=m[1]; }
        if(!h.sugestao) h.sugestao = extrairUltimaSugestao(h.observacoes);
        return h;
      }).filter(o=>o.tema && o.tema.trim()!=='');
      save();
    }
    sanitizeAll(); toast('âœ… ImportaÃ§Ã£o concluÃ­da');
    renderDados(); renderHistorico(); renderTarefas(); renderAgenda(); renderPendencias(); renderStats(); updateFeedbackSelects();
  }catch(e){ console.error(e); toast('Erro ao importar: '+e.message,false); }
};
document.getElementById('btnExpDados').onclick=()=>downloadCSV(toCSV(dados),'VRVS_DADOS_'+today()+'.csv');
document.getElementById('btnExpHist').onclick=()=>downloadCSV(toCSV(historico),'VRVS_HISTORICO_'+today()+'.csv');

function today(){ return new Date().toISOString().split('T')[0]; }
function toCSV(arr){
  if(!arr.length) return '';
  const headers = Object.keys(arr[0]);
  const rows = arr.map(o=>headers.map(h=>{
    const v = o[h]??''; const s = String(v).replace(/"/g,'""');
    return (s.includes(',')||s.includes('\n'))? `"${s}"` : s;
  }).join(','));
  return [headers.join(','),...rows].join('\n');
}
function downloadCSV(csv, name){
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; a.click();
}
function parseCSVFile(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onerror=()=>rej(new Error('Leitura falhou'));
    r.onload=()=>{ try{ res(parseCSVText(r.result)); }catch(e){ rej(e); } };
    r.readAsText(file,'UTF-8');
  });
}
function parseCSVText(txt){
  txt=String(txt||'').replace(/^\uFEFF/,''); const rows=[]; let row=[],cell='',i=0,q=false;
  while(i<txt.length){ const ch=txt[i];
    if(q){ if(ch=='"'){ if(txt[i+1]=='"'){cell+='"'; i+=2;} else {q=false; i++;} }
          else {cell+=ch; i++;} }
    else { if(ch=='"'){ q=true; i++; }
           else if(ch==','){ row.push(cell); cell=''; i++; }
           else if(ch=='\r'){ row.push(cell); rows.push(row); row=[]; cell=''; if(txt[i+1]=='\n') i+=2; else i++; }
           else if(ch=='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; i++; }
           else { cell+=ch; i++; } }
  }
  row.push(cell); rows.push(row);
  if(rows.length<2) return [];
  const heads = rows[0].map(h=>String(h).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').replace(/[().]/g,''));
  const map={}; heads.forEach((h,i)=>map[h]=i);
  const get=(r,...names)=>{ for(const n of names){ const ix=map[n]; if(ix!=null && r[ix]!=null && r[ix]!=='') return strip(r[ix]); } return ''; };
  function strip(s){ const t=String(s); if(t.startsWith('"')&&t.endsWith('"')) return t.slice(1,-1).replace(/""/g,'"'); return t; }
  const out = rows.slice(1).map((r,k)=>({
    id:get(r,'id')||`${Date.now()}_${k}`,
    area:get(r,'area','topico'), tema:get(r,'tema','assunto','titulo'), status:get(r,'status','estado'),
    prioridade:get(r,'prioridade','prior'), dificuldade:get(r,'dificuldade','dific'),
    rendimento:get(r,'rendimento','rend'), sessoes:get(r,'sessoes','sessao'),
    ultestudo:get(r,'ultestudo','ultest','ultimoestudo','ultimo_estudo'),
    dataagenda:get(r,'dataagenda','agenda','data_agenda'), tempomin:get(r,'tempomin','tempo'),
    observacoes:get(r,'observacoes','obs','observacao'), contador80:get(r,'contador80'),
    sugestao:get(r,'sugestao','sugestoes'), data:get(r,'data'), temaid:get(r,'temaid')
  }));
  return out;
}

/* ====== InicializaÃ§Ã£o ====== */
(function init(){
  // Data default no Feedback
  document.getElementById('fbData').value = today();
  renderDados(); renderPendencias(); renderTarefas(); updateFeedbackSelects(); renderStats();
})();
</script>
</body>
</html>
