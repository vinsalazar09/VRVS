<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#17121d">
    
    <!-- Favicon para MacBook e navegadores - m√∫ltiplos formatos e caminhos -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=3">
    <link rel="shortcut icon" href="./favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico?v=3" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png?v=3">
    <link rel="icon" type="image/png" href="./logo.png?v=3">
    
    <!-- Apple Touch Icon para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png?v=3">
    <link rel="apple-touch-icon" href="./logo.png?v=3">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VRVS">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üß† VRVS v5.1 ‚Äì Sistema de Gest√£o de Estudos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* CORES CIRCUIT TECH */
            --bg-dark: #0a1a1f;
            --bg-darker: #051015;
            
            /* TURQUESA TECH */
            --turquesa-neon: #00FFE0;
            --turquesa-light: #00CED1;
            --turquesa-main: #0d9488;
            --turquesa-dark: #0f766e;
            --turquesa-darker: #134e4a;
            
            /* √ÇMBAR COBRE TECH */
            --cobre-neon: #FFAA00;
            --cobre-light: #FFA366;
            --cobre-main: #FF7F50;
            --cobre-dark: #E55100;
            --cobre-darker: #B23A00;
            
            /* GLASSMORPHISM */
            --glass-bg: rgba(20, 35, 45, 0.4);
            --glass-border: rgba(255, 127, 80, 0.3);
            --text-light: rgba(255, 255, 255, 0.95);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-dark) !important;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* CIRCUIT BOARD BACKGROUND */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(13, 148, 136, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 127, 80, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 206, 209, 0.1) 0%, transparent 70%),
                var(--bg-dark);
            pointer-events: none;
            z-index: 1;
        }
        
        /* GRID CIRCUIT ANIMADO */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(rgba(255, 127, 80, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 127, 80, 0.05) 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 100px 100px, 100px 100px;
            pointer-events: none;
            z-index: 1;
            animation: gridPulse 6s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; transform: translate(0, 0); }
            50% { opacity: 0.6; transform: translate(-2px, -2px); }
        }
        
        .container {
            position: relative;
            z-index: 2;
            padding-bottom: 100px;
        }
        
        /* HEADER NEON TECH */
        .header {
            background: rgba(10, 26, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 22px 20px;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, 
                var(--turquesa-main) 50%,
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            ) 1;
            animation: borderFlow 4s linear infinite;
        }
        
        @keyframes borderFlow {
            0% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, var(--cobre-main) 25%, 
                var(--turquesa-main) 50%, var(--cobre-neon) 75%, var(--turquesa-neon) 100%); }
            100% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 100%, var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, var(--turquesa-main) 50%, var(--cobre-neon) 75%); }
        }
        
        .header-title {
            background: linear-gradient(135deg, 
                var(--turquesa-neon) 0%, 
                var(--turquesa-light) 25%, 
                var(--cobre-light) 50%, 
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(255, 170, 0, 0.8));
                transform: scale(1.02);
            }
        }
        
        .header-subtitle {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 206, 209, 0.7);
        }
        
        /* TABS GLASSMORPHISM - SEM SCROLL CORTADO */
        .tabs {
            display: flex;
            gap: 12px;
            padding: 20px 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(10, 26, 31, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--turquesa-light);
            border: 1px solid rgba(0, 206, 209, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .tab:hover {
            border-color: var(--cobre-main);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, 
                rgba(255, 127, 80, 0.2), 
                rgba(0, 206, 209, 0.2)
            );
            color: var(--cobre-light);
            border-color: var(--cobre-main);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.4),
                0 0 40px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* CONTENT SECTIONS */
        .content {
            padding: 20px 15px;
        }
        
        .section {
            display: none;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .section.active { display: block; }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        /* CARDS GLASSMORPHISM NEON - SEM HOVER MANCHADO */
        .card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(0, 206, 209, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .card-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 127, 80, 0.3);
        }
        
        /* FORM ELEMENTS NEON */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(10, 26, 31, 0.6);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-light);
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cobre-main);
            box-shadow: 
                0 0 20px rgba(255, 127, 80, 0.3),
                inset 0 0 20px rgba(255, 127, 80, 0.05);
            background: rgba(10, 26, 31, 0.8);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        /* BUTTONS NEON */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, 
                var(--cobre-main) 0%, 
                var(--cobre-dark) 100%
            );
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(255, 127, 80, 0.4),
                0 0 30px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            pointer-events: auto !important;
            z-index: 10;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.5),
                0 0 40px rgba(255, 127, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.3),
                rgba(0, 148, 136, 0.3)
            );
            box-shadow: 
                0 4px 15px rgba(0, 206, 209, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, 
                var(--cobre-dark) 0%, 
                var(--cobre-darker) 100%
            );
            margin-top: 12px;
        }
        
        .btn-small {
            width: auto;
            padding: 10px 16px;
            font-size: 11px;
        }
        
        .btn-edit {
            background: transparent;
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--turquesa-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-edit:hover {
            border-color: var(--cobre-main);
            color: var(--cobre-light);
            background: rgba(255, 127, 80, 0.1);
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 6px 10px;
            border-radius: 8px;
            color: #EF4444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #EF4444;
            transform: scale(1.1);
        }
        
        .btn-save-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 206, 209, 0.15);
            color: rgba(0, 206, 209, 0.8);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            /* Fix para iOS - elementos fixos */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            will-change: transform;
        }
        
        .btn-save-floating:hover {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.25) 0%, rgba(0, 206, 209, 0.35) 100%);
            color: #00FFE0;
            border-color: rgba(0, 206, 209, 0.5);
            box-shadow: 0 4px 20px rgba(0, 206, 209, 0.3);
            transform: translateZ(0) translateY(-2px);
        }
        
        .btn-save-floating:active {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.4) 0%, rgba(0, 206, 209, 0.5) 100%);
            color: #00FFE0;
            box-shadow: 0 6px 25px rgba(0, 206, 209, 0.5);
            transform: translateZ(0) translateY(0) scale(0.98);
        }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.7),
                rgba(30, 50, 60, 0.5)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 127, 80, 0.1) 0%, 
                transparent 70%
            );
            animation: statPulse 4s ease-in-out infinite;
        }
        
        @keyframes statPulse {
            0%, 100% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(255, 127, 80, 0.5));
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(0, 206, 209, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* TASK ITEMS - CORES AJUSTADAS */
        .task-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item.priority-5 {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .task-item.priority-4 {
            border-color: var(--cobre-light);
            box-shadow: 0 0 20px rgba(255, 163, 102, 0.2);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .task-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(255, 127, 80, 0.5);
        }
        
        .task-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            font-weight: 600;
        }
        
        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .task-detail-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            padding: 4px 8px;
            background: rgba(0, 206, 209, 0.1);
            border-radius: 6px;
        }
        
        .task-tipo {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.2),
                rgba(13, 148, 136, 0.1)
            );
            color: var(--turquesa-light);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 10px;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .task-suggestion {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .task-suggestion::before {
            content: 'üí°';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            animation: lampadaBrilho 2s ease-in-out infinite;
        }
        
        @keyframes lampadaBrilho {
            0%, 100% { 
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            }
            50% { 
                opacity: 0.9;
                filter: drop-shadow(0 0 12px rgba(255, 255, 0, 1)) drop-shadow(0 0 16px rgba(255, 255, 224, 0.8));
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .task-suggestion-label {
            color: var(--turquesa-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        .task-suggestion-text {
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
        }
        
        .campos-tempo {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 206, 209, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .campos-tempo.ativo {
            display: block;
        }
        
        .campo-tempo-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .campo-tempo-row:last-child {
            margin-bottom: 0;
        }
        
        .campo-tempo-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .campo-tempo-item label {
            font-size: 10px;
            color: rgba(0, 206, 209, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .campo-tempo-item input {
            padding: 6px 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 4px;
            color: var(--text-light);
        }
        
        .campo-tempo-item input:focus {
            outline: none;
            border-color: rgba(0, 206, 209, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0, 206, 209, 0.5);
            font-size: 15px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 20px rgba(0, 206, 209, 0.3));
        }
        
        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 13px;
        }
        
        .data-table th {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            color: var(--turquesa-light);
            padding: 12px 8px;
            font-weight: 700;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .data-table td {
            padding: 12px 8px;
            background: rgba(20, 35, 45, 0.3);
            border-top: 1px solid rgba(0, 206, 209, 0.1);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .data-table td:first-child {
            border-left: 1px solid rgba(0, 206, 209, 0.1);
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .data-table td:last-child {
            border-right: 1px solid rgba(0, 206, 209, 0.1);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .data-table tr:hover td {
            background: rgba(0, 206, 209, 0.05);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.1);
        }
        
        /* MESSAGES */
        #importMessage, #feedbackMessage {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
        }
        
        .message {
            background: linear-gradient(135deg,
                rgba(10, 26, 31, 0.95),
                rgba(20, 35, 45, 0.95)
            );
            backdrop-filter: blur(20px);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            animation: slideInMessage 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInMessage {
            from { 
                transform: translateX(120%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            border-left: 4px solid var(--turquesa-neon);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.3);
        }
        
        .message.error {
            border-left: 4px solid var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(255, 127, 80, 0.3);
        }
        
        /* NOTIFICATION ITEMS */
        .notification-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-item.urgent {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .notification-title {
            color: var(--cobre-light);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.5);
        }
        
        .notification-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        
        /* DATE RANGE CONTROLS */
        .date-range-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .date-range-controls .form-input {
            flex: 1;
        }
        
        /* EDIT DATE FORM */
        .edit-date-form {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.05),
                rgba(13, 148, 136, 0.02)
            );
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .edit-date-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .edit-date-row select {
            flex: 2;
        }
        
        .edit-date-row input {
            flex: 1;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        .modal:not(.active) {
            display: none;
            pointer-events: none;
        }
        
        .modal-content {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.95)
            );
            backdrop-filter: blur(20px);
            border: 1px solid var(--cobre-main);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1001;
            pointer-events: auto;
        }
        
        @keyframes modalSlide {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            font-weight: 800;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--cobre-light);
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1001;
            pointer-events: auto;
            user-select: none;
        }
        
        .modal-close:hover {
            color: var(--cobre-neon);
            transform: rotate(90deg) scale(1.1);
            background: rgba(255, 170, 0, 0.1);
            border-radius: 50%;
        }
        
        .modal-close:active {
            transform: rotate(90deg) scale(0.9);
        }
        
        /* MODAL BODY - CORES CLARAS PARA LEGIBILIDADE */
        .modal-body {
            color: #FDF6E3; /* Luz solarizada claro */
        }
        
        .modal-body p,
        .modal-body li,
        .modal-body strong {
            color: #FDF6E3; /* Luz solarizada claro */
        }
        
        .modal-body ul {
            color: #FDF6E3; /* Luz solarizada claro */
        }
        
        #tutorialConteudo {
            color: #FDF6E3 !important; /* Luz solarizada claro - for√ßa cor */
        }
        
        #tutorialConteudo p,
        #tutorialConteudo li,
        #tutorialConteudo strong,
        #tutorialConteudo ul {
            color: #FDF6E3 !important; /* Luz solarizada claro */
        }
        
        /* SCROLL BAR CUSTOM */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                var(--turquesa-dark), 
                var(--cobre-dark)
            );
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                var(--turquesa-main), 
                var(--cobre-main)
            );
        }
        /* ==================== SPLASH SCREEN ==================== */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 50%, #0a1a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }
        
        #splashScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        #splashScreen.hidden {
            display: none;
        }
        
        .splash-logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.3));
            object-fit: contain;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--turquesa-neon);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 224, 0.5);
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .splash-subtitle {
            font-size: 14px;
            color: var(--turquesa-light);
            margin-bottom: 40px;
            opacity: 0.8;
        }
        
        .splash-loader {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .splash-loader::before,
        .splash-loader::after {
            content: '';
            position: absolute;
            border: 3px solid transparent;
            border-top-color: var(--turquesa-neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .splash-loader::before {
            width: 60px;
            height: 60px;
            animation-duration: 1s;
        }
        
        .splash-loader::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border-top-color: var(--cobre-light);
            animation-duration: 0.8s;
            animation-direction: reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .splash-progress {
            width: 200px;
            height: 3px;
            background: rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--turquesa-neon), var(--cobre-light));
            border-radius: 10px;
            width: 0%;
            animation: progressLoad 2s ease-out forwards;
            box-shadow: 0 0 10px rgba(0, 255, 224, 0.6);
        }
        
        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        body.splash-loading {
            overflow: hidden;
        }
    </style>
</head>
<body class="splash-loading">
    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <img src="./logo.png?v=3" alt="VRVS Logo" class="splash-logo" onerror="this.onerror=null; this.src='./logo.jpeg?v=3';">
        <div class="splash-title">VRVS</div>
        <div class="splash-subtitle">Sistema de Revis√£o e Performance</div>
        <div class="splash-loader"></div>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>
    
    <div id="importMessage"></div>
    <div id="feedbackMessage"></div>
    
    <!-- Bot√£o flutuante de salvar (sempre vis√≠vel) -->
    <button class="btn-save-floating" onclick="salvarDadosManualmente()" title="Salvar todos os dados">
        üíæ SALVAR
    </button>
    
    <!-- MODAL DE EDI√á√ÉO -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è EDITAR TEMA</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">√Årea</label>
                    <input type="text" class="form-input" id="editArea" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tema</label>
                    <input type="text" class="form-input" id="editTema" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-input" id="editPrioridade" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="Planejado">Planejado</option>
                        <option value="Em estudo">Em estudo</option>
                        <option value="Suspenso">Suspenso</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                </div>
                <button type="submit" class="btn">üíæ SALVAR ALTERA√á√ïES</button>
            </form>
        </div>
    </div>
    
    <!-- BOX DE D√öVIDAS FLUTUANTE -->
    <div id="boxDuvidas" style="
        position: fixed;
        top: 20px;
        right: 20px;
        width: 280px;
        max-width: calc(100vw - 40px);
        background: rgba(20, 35, 45, 0.95);
        border: 1px solid rgba(0, 206, 209, 0.3);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 9998;
        backdrop-filter: blur(10px);
        display: none;
    ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: var(--turquesa-light); font-size: 14px; margin: 0;">‚ùì D√∫vidas R√°pidas</h4>
            <button onclick="fecharBoxDuvidas()" style="
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='#fff'" onmouseout="this.style.background='transparent'; this.style.color='rgba(255,255,255,0.6)'">√ó</button>
        </div>
        <input type="text" id="perguntaBoxDuvidas" class="form-input" placeholder="Digite sua d√∫vida..." style="margin-bottom: 10px; font-size: 12px; padding: 8px;">
        <button class="btn btn-small" onclick="responderDuvidaBox()" style="width: 100%; font-size: 12px; padding: 8px;">üîç Buscar</button>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,206,209,0.2);">
            <button class="btn btn-small" onclick="showSection('tutorial')" style="width: 100%; font-size: 11px; padding: 6px; background: rgba(0,206,209,0.1);">Ver Tutorial Completo</button>
        </div>
    </div>
    
    <!-- MENU DE OP√á√ïES DO BOT√ÉO DE D√öVIDAS -->
    <div id="menuDuvidas" style="
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 200px;
        background: rgba(20, 35, 45, 0.98);
        border: 1px solid rgba(0, 206, 209, 0.3);
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        z-index: 9999;
        backdrop-filter: blur(10px);
        display: none;
    ">
        <button onclick="abrirBoxDuvidas()" style="
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 206, 209, 0.2);
            border: 1px solid rgba(0, 206, 209, 0.4);
            border-radius: 8px;
            color: var(--turquesa-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        " onmouseover="this.style.background='rgba(0,206,209,0.3)'" onmouseout="this.style.background='rgba(0,206,209,0.2)'">
            ‚ùì Abrir D√∫vidas
        </button>
        <button onclick="fecharMenuDuvidas()" style="
            width: 100%;
            padding: 12px;
            background: rgba(255, 127, 80, 0.2);
            border: 1px solid rgba(255, 127, 80, 0.4);
            border-radius: 8px;
            color: var(--cobre-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        " onmouseover="this.style.background='rgba(255,127,80,0.3)'" onmouseout="this.style.background='rgba(255,127,80,0.2)'">
            ‚úï Fechar Bot√£o
        </button>
    </div>
    
    <!-- BOT√ÉO PARA ABRIR MENU DE D√öVIDAS -->
    <button id="btnAbrirDuvidas" onclick="mostrarMenuDuvidas()" style="
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--turquesa-main), var(--turquesa-dark));
        border: 2px solid var(--turquesa-light);
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
        z-index: 9996;
        transition: all 0.3s ease;
        display: block;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="D√∫vidas">
        ‚ùì
    </button>
    
    <style>
        /* Fix para iOS - elementos fixos devem usar transform para funcionar corretamente */
        #btnAbrirDuvidas,
        #menuDuvidas,
        #boxDuvidas {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            will-change: transform;
        }
        
        /* Desktop - bot√£o no topo */
        @media (min-width: 768px) {
            #btnAbrirDuvidas {
                top: 20px !important;
                bottom: auto !important;
                width: 48px !important;
                height: 48px !important;
                font-size: 20px !important;
            }
            #boxDuvidas {
                top: 20px !important;
                bottom: auto !important;
            }
            #menuDuvidas {
                top: 80px !important;
                bottom: auto !important;
            }
        }
        
        /* Mobile - bot√£o abaixo do salvar */
        @media (max-width: 767px) {
            #btnAbrirDuvidas {
                bottom: 90px !important;
                top: auto !important;
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
                position: fixed !important;
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            }
            #menuDuvidas {
                bottom: 90px !important;
                top: auto !important;
                position: fixed !important;
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            }
            #boxDuvidas {
                bottom: 90px !important;
                top: auto !important;
                width: calc(100vw - 40px) !important;
                max-width: 320px;
                position: fixed !important;
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            }
            
        }
        
        /* Garantir que elementos fixos n√£o sejam afetados por scroll no iOS */
        @supports (-webkit-overflow-scrolling: touch) {
            body {
                -webkit-overflow-scrolling: touch;
            }
            #btnAbrirDuvidas,
            #menuDuvidas,
            #boxDuvidas {
                position: fixed !important;
                -webkit-transform: translate3d(0, 0, 0) !important;
                transform: translate3d(0, 0, 0) !important;
            }
        }
    </style>
    
    <!-- MODAL TUTORIAL INTERATIVO -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="tutorialTitulo">üéØ Tour Guiado - VRVS</h2>
                <button class="modal-close" onclick="fecharTutorial()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="tutorialConteudo" style="min-height: 200px;">
                    <!-- Conte√∫do din√¢mico do tutorial -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-secondary" onclick="pularTutorial()">Pular Tutorial</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btnAnterior" onclick="tutorialAnterior()">‚óÄ Anterior</button>
                        <button class="btn" id="btnProximo" onclick="tutorialProximo()">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                <div id="tutorialProgresso" style="margin-top: 15px; text-align: center; font-size: 12px; color: rgba(0,206,209,0.7);">
                    <!-- Passo X de Y -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL ENCERRAR SESS√ÉO -->
    <div id="encerrarSessaoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Resumo da Sess√£o</h2>
                <button class="modal-close" onclick="closeEncerrarSessaoModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,206,209,0.3);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo Total</div>
                            <div id="modalTempoTotal" style="font-size: 20px; font-weight: bold; color: #00FFE0;">00:00:00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Intervalos</div>
                            <div id="modalNumIntervalos" style="font-size: 20px; font-weight: bold; color: #00FFE0;">0</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Tempo Total de Intervalos</div>
                        <div id="modalTempoIntervalos" style="font-size: 16px; font-weight: bold; color: #FFA366;">00:00:00</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">üìù Preencha os dados da sess√£o:</div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Tempo em Quest√µes (min)</label>
                        <input type="number" class="form-input" id="modalTempoQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Quantidade de Quest√µes</label>
                        <input type="number" class="form-input" id="modalQuantQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">üÉè Tempo em Flashcards (min)</label>
                        <input type="number" class="form-input" id="modalTempoFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">üÉè Quantidade de Flashcards</label>
                        <input type="number" class="form-input" id="modalQuantFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="preencherDadosSessao()" style="flex: 1;">‚úÖ Preencher Formul√°rio</button>
                    <button class="btn btn-secondary" onclick="closeEncerrarSessaoModal()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirma√ß√£o de Feedback -->
    <div id="confirmarFeedbackModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Confirmar Dados da Sess√£o</h2>
                <button class="modal-close" onclick="closeConfirmarFeedbackModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,206,209,0.3);">
                    <div style="font-size: 13px; color: rgba(0,206,209,0.8); margin-bottom: 15px; font-weight: 600;">üìä Revise e ajuste os dados antes de salvar:</div>
                    
                    <div style="display: grid; gap: 12px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üìÖ Data da Sess√£o</label>
                            <input type="date" id="confirmarData" class="form-input" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üìä Performance (%)</label>
                            <input type="number" id="confirmarRendimento" class="form-input" min="0" max="100" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">‚è±Ô∏è Tempo Total (min)</label>
                            <input type="number" id="confirmarTempo" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">‚è∏Ô∏è Tempo de Intervalos (min)</label>
                            <input type="number" id="confirmarTempoIntervalo" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üî¢ N√∫mero de Intervalos</label>
                            <input type="number" id="confirmarNumIntervalos" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">‚ùì Tempo em Quest√µes (min)</label>
                            <input type="number" id="confirmarTempoQuestoes" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">‚ùì Quantidade de Quest√µes</label>
                            <input type="text" id="confirmarQuestoes" class="form-input" placeholder="Ex: 15/20" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üÉè Tempo em Flashcards (min)</label>
                            <input type="number" id="confirmarTempoFlashcards" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üÉè Quantidade de Flashcards</label>
                            <input type="number" id="confirmarFlashcards" class="form-input" min="0" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üí° Diretriz Pr√≥xima Sess√£o</label>
                            <input type="text" id="confirmarSugestao" class="form-input" style="font-size: 12px; padding: 8px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üìù Log da Sess√£o</label>
                            <textarea id="confirmarObs" class="form-textarea" style="font-size: 12px; padding: 8px; min-height: 60px;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="salvarFeedbackConfirmado()" style="flex: 1;">‚úÖ CONFIRMAR E SALVAR</button>
                    <button class="btn btn-secondary" onclick="closeConfirmarFeedbackModal()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-title">üß† VRVS CIRCUIT TECH</div>
            <div class="header-subtitle">Sistema de Gest√£o de Estudos ‚Ä¢ v5.1</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showSection('dados')">üìä Dados</div>
            <div class="tab" onclick="showSection('cadastro')">‚ûï Cadastro</div>
            <div class="tab" onclick="showSection('feedback')">üìù Feedback</div>
            <div class="tab" onclick="showSection('tarefa')">üìã Tarefa</div>
            <div class="tab" onclick="showSection('agenda')">üìÖ Agenda</div>
            <div class="tab" onclick="showSection('pendencias')">üîî Pend√™ncias</div>
            <div class="tab" onclick="showSection('stats')">üìà Estat√≠sticas</div>
            <div class="tab" onclick="showSection('analises')">üîç An√°lises</div>
            <div class="tab" onclick="showSection('historico')">üìú Hist√≥rico</div>
            <div class="tab" onclick="showSection('lembretes')">üìå Lembretes</div>
            <div class="tab" onclick="showSection('caderno')">üìî Caderno</div>
            <div class="tab" onclick="showSection('relatorios')">üìä Relat√≥rios</div>
            <div class="tab" onclick="showSection('importar')">üì• Importar</div>
            <div class="tab" onclick="showSection('exportar')">üì§ Exportar</div>
            <div class="tab" onclick="showSection('tutorial')">‚ùì Tutorial</div>
        </div>
        
        <div class="content">
            <!-- DADOS -->
            <div id="dados" class="section active">
                <div class="card">
                    <div class="card-title">üìä BANCO DE DADOS</div>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="background: rgba(0, 206, 209, 0.15); color: rgba(0, 206, 209, 0.8); border: 1px solid rgba(0, 206, 209, 0.3); font-weight: 500;">
                            üíæ SALVAR DADOS AGORA
                        </button>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">
                            üí° Salva tudo automaticamente no navegador
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√Årea</th>
                                    <th>Tema</th>
                                    <th>Status</th>
                                    <th>Prior.</th>
                                    <th>Rend.</th>
                                    <th>Sess√µes</th>
                                    <th>√ölt.Estudo</th>
                                    <th>Agenda</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="dadosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- TAREFA -->
            <div id="tarefa" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìã MISS√ïES DO DIA</span>
                        <button class="btn btn-small" onclick="toggleCamposTempo()" style="font-size: 11px; padding: 6px 12px;">
                            <span id="toggleTempoText">‚è±Ô∏è Mostrar Tempos</span>
                        </button>
                    </div>
                    <div id="tarefasContainer"></div>
                </div>
            </div>
            
            <!-- AGENDA -->
            <div id="agenda" class="section">
                <div class="card">
                    <div class="card-title">üìÖ TIMELINE</div>
                    <div class="edit-date-row" style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="date" id="agendaDataInicio" class="form-input" style="flex: 1; max-width: 180px;">
                        <input type="date" id="agendaDataFim" class="form-input" style="flex: 1; max-width: 180px;">
                        <button class="btn btn-small" onclick="filtrarSemanaAtual()">üìÖ Semana Atual</button>
                        <button class="btn btn-small btn-secondary" onclick="renderAgenda()">Aplicar</button>
                    </div>
                    <div id="agendaContainer"></div>
                </div>
            </div>

            <!-- PEND√äNCIAS -->
            <div id="pendencias" class="section">
                <div class="card">
                    <div class="card-title">üîî ALERTAS DO SISTEMA</div>
                    <div id="pendenciasContainer"></div>
                </div>
            </div>
            
            <!-- CADASTRO -->
            <div id="cadastro" class="section">
                <div class="card">
                    <div class="card-title">‚ûï ADICIONAR TEMA</div>
                    <form id="cadastroForm">
                        <div class="form-group">
                            <label class="form-label">√Årea de Conhecimento</label>
                            <input type="text" class="form-input" id="novaArea" placeholder="Ex: Ombro e Cotovelo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tema Espec√≠fico</label>
                            <input type="text" class="form-input" id="novoTema" placeholder="Ex: Sd manguito rotador" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√≠vel de Prioridade</label>
                            <input type="number" class="form-input" id="novaPrioridade" min="1" max="5" value="3" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="novaStatus">
                                <option value="Planejado">Planejado</option>
                                <option value="Em estudo">Em estudo</option>
                                <option value="Suspenso">Suspenso</option>
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de In√≠cio</label>
                            <input type="date" class="form-input" id="novaDataInicio">
                        </div>
                        <button type="submit" class="btn">‚úÖ ADICIONAR TEMA</button>
                    </form>
                </div>
            </div>
            
            <!-- FEEDBACK -->
            <div id="feedback" class="section">
                <div class="card">
                    <div class="card-title">üìù REGISTRAR PERFORMANCE</div>
                    
                    <!-- CRON√îMETRO DA SESS√ÉO -->
                    <div id="cronometroContainer" style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo da Sess√£o</div>
                                <div id="cronometroDisplay" style="font-size: 28px; font-weight: bold; color: #00FFE0; font-family: 'Courier New', monospace;">00:00:00</div>
                                <div id="tempoIntervaloTotal" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                    ‚è∏Ô∏è Intervalo acumulado: <span id="tempoIntervaloTotalDisplay">00:00:00</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button id="cronometroToggle" class="btn btn-small" onclick="toggleCronometro()">‚è±Ô∏è Iniciar Cron√¥metro</button>
                                <button id="cronometroPausa" class="btn btn-small" onclick="pausarCronometro()">‚è∏Ô∏è Pausar</button>
                                <button id="cronometroIntervalo" class="btn btn-small" onclick="iniciarIntervalo()">‚è∏Ô∏è Intervalo</button>
                                <button id="cronometroReset" class="btn btn-small" onclick="resetCronometro()">üîÑ Resetar</button>
                                <button id="cronometroEncerrar" class="btn btn-small" onclick="encerrarSessao()" style="background: rgba(0,206,209,0.2); color: #00FFE0; border: 1px solid rgba(0,206,209,0.4);">‚úÖ Encerrar Sess√£o</button>
                            </div>
                            <div id="tempoIntervalo" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                ‚è∏Ô∏è Em intervalo: <span id="tempoIntervaloDisplay">00:00:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label class="form-label">√Årea</label>
                            <select class="form-select" id="feedbackArea" onchange="updateFeedbackTemaSelect()">
                                <option value="">Selecione a √°rea...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√≥dulo Estudado</label>
                            <select class="form-select" id="feedbackTema" required>
                                <option value="">Selecione o m√≥dulo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data da Sess√£o</label>
                            <input type="date" class="form-input" id="feedbackData" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Performance (%)</label>
                            <input type="number" class="form-input" id="feedbackRendimento" min="0" max="100" placeholder="0-100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dura√ß√£o (min) <span style="font-size: 11px; color: rgba(255,255,255,0.5);">(opcional)</span></label>
                            <input type="number" class="form-input" id="feedbackTempo" min="0" placeholder="Minutos">
                        </div>
                        
                        <!-- Boxes discretos de tempo para quest√µes e flashcards -->
                        <div class="form-group" style="background: rgba(0,206,209,0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.15);">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 10px;">‚è±Ô∏è Tempo por atividade (opcional)</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">‚ùì Tempo Quest√µes (min)</label>
                                    <input type="number" class="form-input" id="feedbackTempoQuestoes" min="0" placeholder="0" style="font-size: 12px; padding: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 4px;">üÉè Tempo Flashcards (min)</label>
                                    <input type="number" class="form-input" id="feedbackTempoFlashcards" min="0" placeholder="0" style="font-size: 12px; padding: 6px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">‚ùì Quest√µes (opcional)</label>
                            <input type="text" class="form-input" id="feedbackQuestoes" placeholder="Ex: 15/20 (acertos/total)" pattern="[0-9]+/[0-9]+">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Formato: acertos/total (ex: 17/20)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üÉè Flashcards (opcional)</label>
                            <input type="number" class="form-input" id="feedbackFlashcards" min="0" placeholder="Quantidade revisada">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Quantidade de flashcards revisados na sess√£o
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diretriz Pr√≥xima Sess√£o</label>
                            <input type="text" class="form-input" id="feedbackSugestao" placeholder="Ex: Revisar flashcards + quest√µes">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Log da Sess√£o</label>
                            <textarea class="form-textarea" id="feedbackObs" placeholder="Ex: Q17/20 em 30min | FC8/10 em 15min"></textarea>
                        </div>
                        <button type="button" class="btn" id="btnSalvarFeedback" onclick="processarFeedbackForm()">‚úÖ SALVAR PERFORMANCE</button>
                    </form>
                    <button class="btn btn-danger" onclick="desfazerUltimoFeedback()">‚Ü©Ô∏è DESFAZER √öLTIMO</button>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div id="stats" class="section">
                <div class="card">
                    <div class="card-title">üìä ANALYTICS</div>
                    
                    <!-- Filtros de tempo -->
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                        <div style="font-size: 12px; color: rgba(0,206,209,0.8); margin-bottom: 10px; font-weight: 500;">‚è±Ô∏è Filtrar por Per√≠odo</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <input type="date" id="statsDataInicio" class="form-input" style="flex: 1; min-width: 140px; font-size: 12px; padding: 8px;">
                            <input type="date" id="statsDataFim" class="form-input" style="flex: 1; min-width: 140px; font-size: 12px; padding: 8px;">
                            <button class="btn btn-small" onclick="filtrarStatsSemanaAtual()" style="font-size: 11px; padding: 8px 12px;">üìÖ Semana</button>
                            <button class="btn btn-small" onclick="filtrarStatsMesAtual()" style="font-size: 11px; padding: 8px 12px;">üìÜ M√™s</button>
                            <button class="btn btn-small btn-secondary" onclick="aplicarFiltroStats()" style="font-size: 11px; padding: 8px 12px;">Aplicar</button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTemas">0</div>
                            <div class="stat-label">M√≥dulos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessoes">0</div>
                            <div class="stat-label">Sess√µes Totais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRendimento">0%</div>
                            <div class="stat-label">Performance M√©dia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTempo">0h</div>
                            <div class="stat-label">Tempo Investido</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statQuestoes">0</div>
                            <div class="stat-label">Quest√µes Resolvidas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statFlashcards">0</div>
                            <div class="stat-label">Flashcards Revisados</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìà VISUALIZA√á√ïES</div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartBarras" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartLinha" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartRadar" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- AN√ÅLISES DETALHADAS -->
            <div id="analises" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üîç AN√ÅLISES DETALHADAS</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                                <option value="">Todos os temas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Per√≠odo</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                                <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">Semana Atual</button>
                                <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">M√™s Atual</button>
                                <button class="btn btn-small" onclick="limparFiltrosAnalise()">Limpar Filtros</button>
                            </div>
                        </div>
                        
                        <!-- Filtro de Tempo (Opcional) -->
                        <div style="margin-top: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: rgba(0,206,209,0.9); font-weight: 500;">
                                    ‚è±Ô∏è An√°lises de Tempo (Opcional)
                                </div>
                                <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px; padding: 6px 12px;">
                                    <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar</span>
                                </button>
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">
                                Visualize tempo m√©dio por sess√£o, flashcards, intervalos e mais
                            </div>
                        </div>
                    </div>
                    
                    <div id="analiseResultados" style="margin-top: 30px;">
                        <!-- Resultados ser√£o renderizados aqui -->
                    </div>
                    
                    <div id="analiseTempo" style="display: none; margin-top: 30px;">
                        <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- HIST√ìRICO -->
            <div id="historico" class="section">
                <div class="card">
                    <div class="card-title">üìú REGISTRO COMPLETO</div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tema</th>
                                    <th>√Årea</th>
                                    <th>Rend.</th>
                                    <th>Tempo</th>
                                    <th>Observa√ß√µes</th>
                                    <th>Sugest√£o</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISE POR PER√çODO</div>
                    <div class="date-range-controls">
                        <input type="date" class="form-input" id="relatorioDataInicio">
                        <input type="date" class="form-input" id="relatorioDataFim">
                        <button class="btn btn-small" onclick="gerarRelatorio()">Gerar</button>
                    </div>
                    <div id="relatorioResultado"></div>
                    <button class="btn btn-secondary" onclick="exportarRelatorioPeriodo()" style="display:none; margin-top: 20px;" id="btnExportarRelatorio">
                        üì• Exportar Per√≠odo
                    </button>
                </div>
            </div>
            
            <!-- IMPORTAR -->
            <div id="importar" class="section">
                <div class="card">
                    <div class="card-title">üì• IMPORTAR DADOS</div>
                    <div class="form-group">
                        <label class="form-label">Arquivo DADOS.csv</label>
                        <input type="file" class="form-input" id="importDados" accept=".csv">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Arquivo HISTORICO.csv</label>
                        <input type="file" class="form-input" id="importHistorico" accept=".csv">
                    </div>
                    <button class="btn" onclick="importarArquivos()">üì• PROCESSAR IMPORTA√á√ÉO</button>
                    <button class="btn btn-danger" onclick="limparTudo()">üóëÔ∏è RESET COMPLETO</button>
                </div>
            </div>
            
            <!-- EXPORTAR -->
            <div id="exportar" class="section">
                <div class="card">
                    <div class="card-title">üì§ BACKUP DE DADOS</div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="margin-bottom: 12px;">üíæ SALVAR DADOS AGORA</button>
                        <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 20px;">
                            üí° Salva todos os dados no navegador (dados, hist√≥rico, lembretes, anota√ß√µes)
                        </div>
                    </div>
                    <div class="card-title" style="margin-top: 30px; margin-bottom: 15px; font-size: 14px;">üìä EXPORTAR PARA ARQUIVO</div>
                    <button class="btn btn-secondary" onclick="exportarDados()">üìä Baixar DADOS.csv</button>
                    <button class="btn btn-secondary" onclick="exportarHistorico()" style="margin-top: 12px;">üìú Baixar HISTORICO.csv</button>
                </div>
            </div>
            
            <!-- TUTORIAL E AJUDA -->
            <div id="tutorial" class="section">
                <div class="card">
                    <div class="card-title">‚ùì TUTORIAL E AJUDA</div>
                    
                    <!-- Tour Guiado -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado Interativo</h3>
                        <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                            Um guia passo a passo por todas as funcionalidades
                        </p>
                    </div>
                    
                    <!-- Assistente de D√∫vidas -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üí¨ Assistente de D√∫vidas</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                            <input type="text" id="perguntaAssistente" class="form-input" placeholder="Digite sua d√∫vida aqui... Ex: Como adicionar um tema?" style="margin-bottom: 15px;">
                            <button class="btn btn-secondary" onclick="responderDuvida()">üîç Buscar Resposta</button>
                            <div id="respostaAssistente" style="margin-top: 20px; display: none;">
                                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--turquesa-light);">
                                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                                    <div id="textoResposta" style="color: var(--text-light); font-size: 14px; line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ R√°pido -->
                    <div>
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Perguntas Frequentes</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-small" onclick="mostrarResposta('adicionar')" style="text-align: left; justify-content: flex-start;">‚ùì Como adicionar um tema?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('feedback')" style="text-align: left; justify-content: flex-start;">‚ùì Como registrar uma sess√£o de estudos?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('agenda')" style="text-align: left; justify-content: flex-start;">‚ùì Como usar a agenda?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('stats')" style="text-align: left; justify-content: flex-start;">‚ùì Como ver minhas estat√≠sticas?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('backup')" style="text-align: left; justify-content: flex-start;">‚ùì Como fazer backup dos dados?</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LEMBRETES -->
            <div id="lembretes" class="section">
                <div class="card">
                    <div class="card-title">üìå LEMBRETES E ANOTA√á√ïES</div>
                    <div style="margin-bottom: 20px;">
                        <form id="lembreteForm">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo do Lembrete</label>
                                <input type="text" class="form-input" id="lembreteTitulo" placeholder="Ex: Revisar vias de acesso do cotovelo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descri√ß√£o (opcional)</label>
                                <textarea class="form-input" id="lembreteDescricao" rows="3" placeholder="Detalhes adicionais..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Periodicidade</label>
                                <select class="form-select" id="lembretePeriodicidade" required>
                                    <option value="pontual">Pontual (apenas uma vez)</option>
                                    <option value="diaria">Di√°ria</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="quinzenal">Quinzenal (15 dias)</option>
                                    <option value="mensal">Mensal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vincular ao Tema (opcional)</label>
                                <select class="form-select" id="lembreteTemaId">
                                    <option value="">Nenhum (lembrete geral)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Inicial</label>
                                <input type="date" class="form-input" id="lembreteDataInicial" required>
                            </div>
                            <button type="submit" class="btn">‚ûï Adicionar Lembrete</button>
                        </form>
                    </div>
                    <div id="lembretesContainer"></div>
                </div>
            </div>
            
            <!-- CADERNO -->
            <div id="caderno" class="section">
                <div class="card">
                    <div class="card-title">üìî CADERNO DE ANOTA√á√ïES</div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="cadernoFiltroArea" onchange="atualizarSelectTemaPorArea(); filtrarCaderno();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="cadernoFiltroTema" onchange="filtrarCaderno()" disabled>
                                <option value="">Selecione uma √°rea primeiro</option>
                            </select>
                        </div>
                    </div>
                    <div id="cadernoContainer"></div>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== PROTE√á√ÉO GLOBAL CONTRA ERROS ====================
        // Garantir que splash screen sempre esconde, mesmo com erro JavaScript
        window.addEventListener('error', function(e) {
            console.error('‚ùå Erro JavaScript capturado:', e.error);
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.style.display = 'none';
                    splash.classList.add('hidden');
                }
                document.body.classList.remove('splash-loading');
            }, 1000);
        });
        
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        // Fun√ß√£o para corrigir invers√£o √°rea‚Üîtema ANTES de carregar dados
        function fixAreaTemaObjeto(obj) {
            if (!obj) return obj;
            const area = String(obj.area || '');
            const tema = String(obj.tema || '');
            // Se √°rea est√° muito longa (>20) E tema cont√©m palavra-chave de √°rea, inverter
            const areaLikeKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'mao', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'pe', 'tornozelo', 'coluna', 'oncologia', 'tumores', 'mmss', 'mmii'];
            const temaPareceArea = areaLikeKeywords.some(k => tema.toLowerCase().includes(k));
            if (area.length > 20 && temaPareceArea) {
                const tmp = obj.area;
                obj.area = obj.tema;
                obj.tema = tmp;
            }
            return obj;
        }
        
        let dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
        let historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
        let lembretes = JSON.parse(localStorage.getItem('vrvs_lembretes') || '[]');
        let anotacoes = JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]'); // Anota√ß√µes por tema
        
        // Aplicar corre√ß√£o de invers√£o √°rea/tema nos dados carregados
        if (Array.isArray(dados)) {
            dados = dados.map(d => fixAreaTemaObjeto(d));
        }
        
        // Limpar dados corrompidos
        function limparDadosCorretos() {
            const dadosOriginais = dados.length;
            dados = dados.filter(t => {
                if (!t.area || t.area.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.area && t.area.toLowerCase().includes('sugest')) return false;
                if (!t.tema || t.tema.toLowerCase().includes('revisao ativa') || t.tema.toLowerCase().includes('revis√£o ativa')) return false;
                if (t.tema.length > 100) return false;
                if (t.tema.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.tema.includes('Sugest√£o:') || t.tema.includes('sugest√£o:')) return false;
                if ((t.tema.match(/\|/g) || []).length > 2) return false;
                return true;
            });
            
            if (dados.length < dadosOriginais) {
                console.log(`üßπ Limpeza: removidos ${dadosOriginais - dados.length} registros corrompidos`);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            }
        }
        
        limparDadosCorretos();
        
        // Fun√ß√£o para limpar hist√≥rico inv√°lido (usada na inicializa√ß√£o e ap√≥s importa√ß√£o)
        function limparHistoricoInvalido() {
            const historicoOriginal = historico.length;
            
            historico = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historico.length < historicoOriginal) {
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                console.log(`üßπ Limpeza: removidos ${historicoOriginal - historico.length} registros inv√°lidos do hist√≥rico`);
            }
        }
        
        limparHistoricoInvalido(); // Limpar hist√≥rico inv√°lido na inicializa√ß√£o
        
        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function mostrarNotificacaoFeedback(mensagem, tipo = 'success') {
            const container = document.getElementById('feedbackMessage');
            container.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function extrairUltimaSugestao(observacoes) {
            if (!observacoes) return '';
            const linhas = observacoes.split('\n');
            for (let i = linhas.length - 1; i >= 0; i--) {
                const linha = linhas[i];
                if (linha.includes('Sugest√£o:') || linha.includes('sugest√£o:')) {
                    const partes = linha.split(/[Ss]ugest√£o:/);
                    if (partes.length > 1) {
                        return partes[1].trim().replace(/^\|/, '').replace(/\|$/, '').trim();
                    }
                }
            }
            return '';
        }
        
        function obterSugestaoTema(tema) {
            if (!tema) return '';
            if (tema.sugestao && tema.sugestao !== '-' && tema.sugestao.trim() !== '') {
                return tema.sugestao.trim();
            }
            return extrairUltimaSugestao(tema.observacoes);
        }

        function calcularTipoRevisao(tema) {
            const rend = tema.rendimento || 0;
            const sess = tema.sessoes || 0;
            
            if (sess === 0) return 'üÜï Primeira sess√£o';
            if (sess === 1) return '‚ö° Quest√µes/flashcards';
            if (rend < 0.50) return 'üìö Revisar teoria completa';
            if (rend < 0.60) return 'üìπ Aula + quest√µes';
            if (rend < 0.80) return 'üìñ Resumo + quest√µes';
            return '‚ö° Quest√µes/flashcards';
        }
        
        function normalizeArea(rawArea, tema) {
            if (!rawArea && !tema) return '';
            let area = String(rawArea || '').trim().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // APENAS 3 √ÅREAS V√ÅLIDAS
            const areasValidas = {
                'ombro e cotovelo': 'Ombro e Cotovelo',
                'trauma mmss': 'Trauma MMSS',
                'ortopedia pediatrica': 'Ortopedia Pedi√°trica',
                'ortopedia pedi√°trica': 'Ortopedia Pedi√°trica'
            };
            
            // Verificar correspond√™ncia exata ou parcial
            for (const [key, value] of Object.entries(areasValidas)) {
                if (area === key || area.includes(key) || key.includes(area)) {
                    return value;
                }
            }
            
            // Se n√£o for uma √°rea v√°lida, retornar vazio
            return '';
        }
        
        function fixAreaTema(area, tema) {
            if (!area || !tema) return { area: area || '', tema: tema || '' };
            
            const areaLower = String(area).toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const temaLower = String(tema).toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // √ÅREAS V√ÅLIDAS (apenas 3)
            const areasValidas = ['ombro e cotovelo', 'trauma mmss', 'ortopedia pediatrica', 'ortopedia pedi√°trica'];
            
            // Verificar se √°rea √© v√°lida
            const areaEhValida = areasValidas.some(a => areaLower === a || areaLower.includes(a) || a.includes(areaLower));
            const temaEhArea = areasValidas.some(a => temaLower === a || temaLower.includes(a) || a.includes(temaLower));
            
            // Se tema parece ser √°rea e √°rea n√£o √© v√°lida, est√£o invertidos
            if (temaEhArea && !areaEhValida) {
                return { area: normalizeArea(tema, ''), tema: area };
            }
            
            // Normalizar √°rea para uma das 3 v√°lidas
            const areaNormalizada = normalizeArea(area, tema);
            if (!areaNormalizada && temaEhArea) {
                // Se √°rea n√£o normalizou mas tema √© √°rea v√°lida, trocar
                return { area: normalizeArea(tema, ''), tema: area };
            }
            
            return { area: areaNormalizada || area, tema: tema };
        }
        
        // ==================== TIMEZONE BRAS√çLIA ====================
        // Fun√ß√£o helper para obter data atual no timezone de Bras√≠lia (UTC-3)
        function obterDataBrasilia() {
            const agora = new Date();
            // Converter para timezone de Bras√≠lia (UTC-3)
            // Criar uma data no formato ISO com timezone de Bras√≠lia
            const offsetBrasilia = -3; // UTC-3
            const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
            const dataBrasilia = new Date(utc + (3600000 * offsetBrasilia));
            return dataBrasilia;
        }
        
        // Fun√ß√£o para obter string de data no formato YYYY-MM-DD no timezone de Bras√≠lia
        function obterDataBrasiliaString() {
            const dataBrasilia = obterDataBrasilia();
            const ano = dataBrasilia.getFullYear();
            const mes = String(dataBrasilia.getMonth() + 1).padStart(2, '0');
            const dia = String(dataBrasilia.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }
        
        function dataValida(data) {
            if (!data || data === '-' || String(data).trim() === '') return false;
            try {
                const dt = new Date(data + 'T00:00:00');
                return !isNaN(dt.getTime());
            } catch (e) {
                return false;
            }
        }
        
        function formatarDataBR(data) {
            if (!dataValida(data)) return '-';
            try {
                return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            } catch (e) {
                return '-';
            }
        }
        
        function formatarData(dataStr) {
            // Mantida para compatibilidade - usa formatarDataBR internamente
            return formatarDataBR(dataStr);
        }
        
        function calcularProximaRevisao(tema, dataSessao = null) {
            // CORRE√á√ÉO: Conclu√≠do n√£o entra no algoritmo - retornar vazio
            if (tema.status === 'Conclu√≠do') {
                return '';
            }
            
            // CORRE√á√ÉO: Usar data da sess√£o se fornecida, sen√£o usar data atual (Bras√≠lia)
            const dataBase = dataSessao ? new Date(dataSessao + 'T00:00:00') : obterDataBrasilia();
            dataBase.setHours(0, 0, 0, 0);
            
            // CORRE√á√ÉO CR√çTICA: Se √© PRIMEIRA sess√£o (contador = 1 OU √∫ltima data = null), sempre +1 dia
            const sessoes = tema.sessoes || 0;
            const ultEstudo = tema.ultEstudo || null;
            
            if (sessoes === 0 || sessoes === 1 || !ultEstudo || ultEstudo === null || ultEstudo === '') {
                const proxima = new Date(dataBase);
                proxima.setDate(proxima.getDate() + 1);
                return proxima.toISOString().split('T')[0];
            }
            
            // SOMENTE ap√≥s segunda sess√£o em diante: aplicar algoritmo normal
            const rendimento = Math.round((tema.rendimento || 0) * 100);
            const prioridade = parseInt(tema.prioridade) || 3;
            const contador80 = parseInt(tema.contador80) || 0;
            let intervalo = 1;
            
            if (rendimento < 50) {
                intervalo = 1;
            } else if (rendimento >= 50 && rendimento < 80) {
                intervalo = 3;
            } else {
                if (contador80 === 0) intervalo = 7;
                else if (contador80 === 1) intervalo = 14;
                else if (contador80 === 2) intervalo = 30;
                else intervalo = 60;
                
                if (prioridade === 5 && intervalo > 30) {
                    intervalo = 30;
                }
            }
            
            const proxima = new Date(dataBase);
            proxima.setDate(proxima.getDate() + intervalo);
            return proxima.toISOString().split('T')[0];
        }

        // ==================== MODAL DE EDI√á√ÉO ====================
        
        function openEditModal(id) {
            const tema = dados.find(t => t.id == id);
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            document.getElementById('editId').value = tema.id;
            document.getElementById('editArea').value = tema.area;
            document.getElementById('editTema').value = tema.tema;
            document.getElementById('editPrioridade').value = tema.prioridade || 3;
            document.getElementById('editStatus').value = tema.status || 'Planejado';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ==================== RENDERIZA√á√ÉO DE COMPONENTES ====================
        
        function renderPendencias() {
            const hoje = obterDataBrasiliaString();
            const container = document.getElementById('pendenciasContainer');
            const notificacoes = [];
            
            const atrasadas = dados.filter(t => {
                if (!t.agenda || t.status === 'Conclu√≠do') return false;
                const diasAtraso = Math.floor((new Date(hoje) - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
                return diasAtraso > 7;
            });
            
            if (atrasadas.length > 0) {
                notificacoes.push({
                    tipo: 'urgent',
                    titulo: `‚ö†Ô∏è ${atrasadas.length} m√≥dulos em atraso cr√≠tico`,
                    texto: atrasadas.map(t => `‚Ä¢ ${t.tema} (${Math.floor((new Date(hoje) - new Date(t.agenda)) / (1000 * 60 * 60 * 24))} dias)`).join('\n')
                });
            }
            
            const planejados = dados.filter(t => t.status === 'Planejado' && t.sessoes === 0);
            if (planejados.length > 0) {
                notificacoes.push({
                    tipo: 'normal',
                    titulo: `üìã ${planejados.length} m√≥dulos aguardando inicializa√ß√£o`,
                    texto: planejados.map(t => `‚Ä¢ ${t.tema}`).join('\n')
                });
            }
            
            const semData = historico.filter(h => !h.data || h.data === '-').length;
            if (semData > 0) {
                notificacoes.push({
                    tipo: 'normal',
                    titulo: `üìÖ ${semData} registros sem timestamp`,
                    texto: 'Acesse Hist√≥rico para corrigir datas'
                });
            }
            
            if (notificacoes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Sistema operacional</div></div>';
                return;
            }
            
            container.innerHTML = notificacoes.map(n => `
                <div class="notification-item ${n.tipo}">
                    <div class="notification-title">${n.titulo}</div>
                    <div class="notification-text" style="white-space: pre-line;">${n.texto}</div>
                </div>
            `).join('');
        }
        
        // Vari√°vel global para controlar visibilidade dos campos de tempo
        window.camposTempoVisiveis = false;
        
        function toggleCamposTempo() {
            window.camposTempoVisiveis = !window.camposTempoVisiveis;
            const toggleText = document.getElementById('toggleTempoText');
            if (toggleText) {
                toggleText.textContent = window.camposTempoVisiveis ? '‚è±Ô∏è Ocultar Tempos' : '‚è±Ô∏è Mostrar Tempos';
            }
            renderTarefas();
            renderAgenda();
        }
        
        function renderTarefas() {
            const hoje = obterDataBrasilia();
            const hojeStr = obterDataBrasiliaString();
            
            // Calcular data limite: 7 dias atr√°s
            const dataLimite = new Date(hoje);
            dataLimite.setDate(hoje.getDate() - 7);
            const dataLimiteStr = dataLimite.toISOString().split('T')[0];
            
            // Filtrar: s√≥ hoje e at√© 7 dias acumulados (n√£o futuras)
            const tarefas = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                if (!dataValida(t.agenda)) return false;
                
                // S√≥ atividades de hoje ou at√© 7 dias atr√°s (acumuladas)
                // N√ÉO mostrar atividades futuras (essas v√£o para agenda)
                return t.agenda >= dataLimiteStr && t.agenda <= hojeStr;
            });
            
            const container = document.getElementById('tarefasContainer');
            if (tarefas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                return;
            }
            
            // Calcular data de ontem (Bras√≠lia)
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1);
            const ontemStr = ontem.toISOString().split('T')[0];
            
            // Ordenar por prioridade:
            // 1. Tema iniciado no dia anterior (primeira sess√£o) - maior prioridade
            // 2. Prioridade alta (5) com menor rendimento
            // 3. Hoje primeiro, depois por data (mais recente primeiro)
            tarefas.sort((a, b) => {
                // Verificar se √© tema iniciado no dia anterior (primeira sess√£o)
                const aPrimeiraSessaoOntem = (a.sessoes === 1 && a.ultEstudo === ontemStr);
                const bPrimeiraSessaoOntem = (b.sessoes === 1 && b.ultEstudo === ontemStr);
                
                // Prioridade 1: Tema iniciado no dia anterior
                if (aPrimeiraSessaoOntem && !bPrimeiraSessaoOntem) return -1;
                if (!aPrimeiraSessaoOntem && bPrimeiraSessaoOntem) return 1;
                
                // Prioridade 2: Prioridade alta (5) com menor rendimento
                const aPrioridadeAlta = (a.prioridade || 0) === 5;
                const bPrioridadeAlta = (b.prioridade || 0) === 5;
                
                if (aPrioridadeAlta && !bPrioridadeAlta) return -1;
                if (!aPrioridadeAlta && bPrioridadeAlta) return 1;
                
                // Se ambos s√£o prioridade alta, ordenar por menor rendimento
                if (aPrioridadeAlta && bPrioridadeAlta) {
                    return (a.rendimento || 0) - (b.rendimento || 0);
                }
                
                // Prioridade 3: Hoje primeiro
                if (a.agenda === hojeStr && b.agenda !== hojeStr) return -1;
                if (a.agenda !== hojeStr && b.agenda === hojeStr) return 1;
                
                // Prioridade 4: Por data (mais recente primeiro)
                if (a.agenda !== b.agenda) return b.agenda.localeCompare(a.agenda);
                
                // Prioridade 5: Por prioridade num√©rica
                return (b.prioridade || 0) - (a.prioridade || 0);
            });
            
            container.innerHTML = tarefas.map((t, index) => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const isHoje = t.agenda === hoje;
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-name">${t.tema} ${isHoje ? 'üéØ' : ''}</div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                        <div class="task-detail-item">üìÖ ${formatarDataBR(t.agenda)}</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderAgenda() {
            const hoje = obterDataBrasilia();
            const hojeStr = obterDataBrasiliaString();
            
            // Calcular semana atual (segunda a domingo)
            const diaSemana = hoje.getDay(); // 0=Dom, 1=Seg, ...
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            const segundaStr = segunda.toISOString().split('T')[0];
            const domingoStr = domingo.toISOString().split('T')[0];
            
            // Per√≠odo: inputs ou default semana atual
            const inputInicio = document.getElementById('agendaDataInicio');
            const inputFim = document.getElementById('agendaDataFim');
            let dataInicio = inputInicio && inputInicio.value ? inputInicio.value : segundaStr;
            let dataFim = inputFim && inputFim.value ? inputFim.value : domingoStr;
            
            // Se n√£o tiver valores, usar semana atual
            if (!inputInicio.value) {
                inputInicio.value = segundaStr;
                dataInicio = segundaStr;
            }
            if (!inputFim.value) {
                inputFim.value = domingoStr;
                dataFim = domingoStr;
            }
            
            // Filtrar: s√≥ atividades FUTURAS (ap√≥s hoje)
            const agendadas = dados
                .filter(t => {
                    if (!t || !t.agenda || t.status === 'Conclu√≠do') return false;
                    if (!dataValida(t.agenda) || !dataValida(dataInicio) || !dataValida(dataFim)) return false;
                    // S√≥ atividades futuras (ap√≥s hoje) dentro do per√≠odo selecionado
                    return t.agenda > hojeStr && t.agenda >= dataInicio && t.agenda <= dataFim;
                })
                .sort((a, b) => a.agenda.localeCompare(b.agenda));
            
            const container = document.getElementById('agendaContainer');
            if (agendadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div>Timeline vazia</div></div>';
                return;
            }
            
            container.innerHTML = agendadas.map(t => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const dataFormatada = formatarDataBR(t.agenda);
                const tipo = calcularTipoRevisao(t);
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-date">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function filtrarSemanaAtual() {
            const hoje = obterDataBrasilia();
            const diaSemana = hoje.getDay(); // 0=Dom, 1=Seg, ...
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            
            document.getElementById('agendaDataInicio').value = segunda.toISOString().split('T')[0];
            document.getElementById('agendaDataFim').value = domingo.toISOString().split('T')[0];
            renderAgenda();
        }
        
        function renderDados() {
            // SEMPRE recarregar dados do localStorage antes de renderizar (fix para iOS cache)
            const dadosRaw = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
            
            console.log(`üîç [MACBOOK DEBUG] Carregando dados do localStorage:`, {
                dadosRawLength: dadosRaw.length,
                dadosRaw: dadosRaw,
                localStorageKey: 'vrvs_dados',
                localStorageValue: localStorage.getItem('vrvs_dados') ? 'existe' : 'n√£o existe'
            });
            
            if (!Array.isArray(dadosRaw)) {
                console.error('‚ùå Dados n√£o s√£o um array:', dadosRaw);
                dados = [];
            } else {
                // Aplicar corre√ß√£o de invers√£o √°rea/tema
                dados = dadosRaw.map(d => {
                    try {
                        const corrigido = fixAreaTemaObjeto(d);
                        // Aplicar fixAreaTema para garantir √°rea/tema corretos
                        const { area, tema } = fixAreaTema(corrigido.area || '', corrigido.tema || '');
                        corrigido.area = area;
                        corrigido.tema = tema;
                        return corrigido;
                    } catch (e) {
                        console.error('‚ùå Erro ao corrigir objeto:', d, e);
                        return d; // Retornar objeto original se houver erro
                    }
                }).filter(d => d && d.tema && d.tema.trim() !== ''); // Filtrar apenas objetos v√°lidos com tema
            }
            
            // REMOVER DUPLICATAS: manter apenas o primeiro tema com mesma √°rea+tema
            const temasUnicos = [];
            const chavesVistas = new Set();
            dados.forEach(t => {
                const chave = `${String(t.area).toLowerCase().trim()}_${String(t.tema).toLowerCase().trim()}`;
                if (!chavesVistas.has(chave)) {
                    chavesVistas.add(chave);
                    temasUnicos.push(t);
                } else {
                    console.log(`‚ö†Ô∏è Removendo duplicata: ${t.area} - ${t.tema}`);
                }
            });
            dados = temasUnicos;
            
            // LIMPAR DADOS INCONSISTENTES: se sessoes === 0 e status √© 'N√£o iniciado' ou 'Planejado', rendimento deve ser 0
            let dadosCorrigidos = false;
            dados.forEach((t, index) => {
                const sessoesZero = (t.sessoes === 0 || !t.sessoes || t.sessoes === '0');
                const statusInvalido = (t.status === 'N√£o iniciado' || t.status === 'Planejado');
                const temRendimentoInvalido = (t.rendimento && t.rendimento > 0);
                
                // LOG DETALHADO PARA DEBUG
                if (sessoesZero && temRendimentoInvalido) {
                    console.log(`üîç [DEBUG] Tema ${index}: ${t.tema}`, {
                        sessoes: t.sessoes,
                        status: t.status,
                        rendimento: t.rendimento,
                        sessoesZero,
                        statusInvalido,
                        temRendimentoInvalido
                    });
                }
                
                if (sessoesZero && statusInvalido && temRendimentoInvalido) {
                    console.log(`üîß [MACBOOK FIX] Corrigindo rendimento inconsistente: ${t.tema} (sessoes: ${t.sessoes}, status: ${t.status}, rendimento: ${t.rendimento} -> 0)`);
                    t.rendimento = 0;
                    dadosCorrigidos = true;
                } else if (sessoesZero && temRendimentoInvalido) {
                    // CASO ESPECIAL: Se sessoes === 0 mas status n√£o √© 'N√£o iniciado'/'Planejado', tamb√©m corrigir
                    console.log(`üîß [MACBOOK FIX] Corrigindo rendimento (sessoes=0): ${t.tema} (sessoes: ${t.sessoes}, status: ${t.status}, rendimento: ${t.rendimento} -> 0)`);
                    t.rendimento = 0;
                    dadosCorrigidos = true;
                }
            });
            
            // Se corrigiu dados, salvar imediatamente
            if (dadosCorrigidos) {
                console.log('üíæ [MACBOOK FIX] Salvando dados corrigidos no localStorage');
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            }
            
            // Sempre salvar dados limpos (mesmo sem corre√ß√µes)
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            
            // Atualizar vari√°vel global
            window.dados = dados;
            
            console.log(`‚úÖ [MACBOOK FIX] Total de temas processados: ${dados.length}, Dados corrigidos: ${dadosCorrigidos}`);
            
            const tbody = document.getElementById('dadosTableBody');
            if (!tbody) {
                console.error('‚ùå Elemento dadosTableBody n√£o encontrado');
                return;
            }
            
            console.log(`üìä Renderizando ${dados.length} temas √∫nicos na aba Dados`);
            
            tbody.innerHTML = dados.map(t => {
                const ultEstudo = formatarDataBR(t.ultEstudo);
                const agenda = formatarDataBR(t.agenda);
                
                // N√ÉO mostrar rendimento se sessoes === 0 e status √© 'N√£o iniciado' ou 'Planejado'
                const sessoesZero = (t.sessoes === 0 || !t.sessoes || t.sessoes === '0');
                const statusInvalido = (t.status === 'N√£o iniciado' || t.status === 'Planejado');
                const deveMostrarRendimento = !(sessoesZero && statusInvalido);
                
                // LOG PARA DEBUG SE HOUVER PROBLEMA
                if (sessoesZero && t.rendimento && t.rendimento > 0) {
                    console.log(`‚ö†Ô∏è [RENDER DEBUG] Tema com sessoes=0 mas rendimento>0: ${t.tema}`, {
                        sessoes: t.sessoes,
                        status: t.status,
                        rendimento: t.rendimento,
                        deveMostrarRendimento
                    });
                }
                
                const rend = (deveMostrarRendimento && t.rendimento) ? Math.round(t.rendimento * 100) + '%' : '-';
                const rendColor = (deveMostrarRendimento && t.rendimento) 
                    ? (t.rendimento >= 0.8 ? '#00FFE0' : t.rendimento >= 0.5 ? '#FFA366' : '#EF4444')
                    : 'rgba(255,255,255,0.5)';
                
                return `
                    <tr>
                        <td style="color: rgba(0,206,209,0.8);">${t.area || '-'}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${t.tema || '-'}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.status || 'N√£o iniciado'}</td>
                        <td style="text-align: center; color: var(--cobre-main);">${t.prioridade || 3}</td>
                        <td style="text-align: center; color: ${rendColor};">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.sessoes || 0}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${ultEstudo}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${agenda}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit" onclick="openEditModal(${t.id})" title="Editar">üîß</button>
                            <button class="btn-delete" onclick="deletarTema(${t.id})" title="Excluir tema permanentemente">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Se n√£o houver dados, mostrar mensagem
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhum tema cadastrado ainda. Use a aba ‚ûï Cadastro para adicionar temas.</td></tr>';
            }
        }
        
        // REMOVIDO: Fun√ß√£o que criava temas duplicados do hist√≥rico
        // A aba Dados mostra apenas temas cadastrados, n√£o sess√µes do hist√≥rico
        
        function updateFeedbackSelect() {
            // SEMPRE recarregar dados do localStorage antes de atualizar selects (fix para iOS cache)
            dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
            if (Array.isArray(dados)) {
                dados = dados.map(d => {
                    try {
                        const corrigido = fixAreaTemaObjeto(d);
                        // Aplicar fixAreaTema para garantir √°rea/tema corretos
                        const { area, tema } = fixAreaTema(corrigido.area || '', corrigido.tema || '');
                        corrigido.area = area;
                        corrigido.tema = tema;
                        return corrigido;
                    } catch (e) {
                        return d;
                    }
                }).filter(d => d && d.tema && d.tema.trim() !== '');
            }
            
            // Atualizar vari√°vel global
            window.dados = dados;
            
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            
            if (!areaSelect || !temaSelect) {
                console.error('‚ùå Elementos de select n√£o encontrados');
                return;
            }
            
            // Obter √°reas √∫nicas (apenas √°reas v√°lidas)
            const areas = [...new Set(dados.map(t => t.area).filter(a => a && a.trim()))].sort();
            areaSelect.innerHTML = '<option value="">Selecione a √°rea...</option>' +
                areas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Atualizar temas baseado na √°rea selecionada
            updateFeedbackTemaSelect();
            
            console.log(`üìã Atualizados selects de feedback: ${dados.length} temas dispon√≠veis`);
        }
        
        function updateFeedbackTemaSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            const areaSelecionada = areaSelect.value;
            
            temaSelect.innerHTML = '<option value="">Selecione o m√≥dulo...</option>';
            
            if (!areaSelecionada) {
                // Se nenhuma √°rea selecionada, mostrar todos os temas
                temaSelect.innerHTML += dados.map(t => `<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
            } else {
                // Filtrar temas pela √°rea selecionada
                const temasFiltrados = dados.filter(t => t.area === areaSelecionada);
                temaSelect.innerHTML += temasFiltrados.map(t => `<option value="${t.id}">${t.tema}</option>`).join('');
            }
        }
        
        function deletarTema(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Confirmar exclus√£o
            const confirmacao = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO: Excluir tema "${tema.tema}"?\n\n` +
                `Isso ir√° REMOVER PERMANENTEMENTE:\n` +
                `‚Ä¢ O tema dos dados\n` +
                `‚Ä¢ Todo o hist√≥rico relacionado\n` +
                `‚Ä¢ Lembretes vinculados\n` +
                `‚Ä¢ Anota√ß√µes do caderno\n\n` +
                `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
                `Confirmar exclus√£o?`
            );
            
            if (!confirmacao) return;
            
            // Contar quantos registros ser√£o removidos
            const historicoRelacionado = historico.filter(h => String(h.temaId) === String(temaId));
            const lembretesRelacionados = lembretes.filter(l => String(l.temaId) === String(temaId));
            const anotacoesRelacionadas = anotacoes.filter(a => String(a.temaId) === String(temaId));
            
            // Remover tema dos dados
            dados = dados.filter(t => String(t.id) !== String(temaId));
            
            // Remover hist√≥rico relacionado
            historico = historico.filter(h => String(h.temaId) !== String(temaId));
            
            // Remover lembretes relacionados
            lembretes = lembretes.filter(l => String(l.temaId) !== String(temaId));
            
            // Remover anota√ß√µes relacionadas
            anotacoes = anotacoes.filter(a => String(a.temaId) !== String(temaId));
            
            // Salvar tudo no localStorage
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            
            // Mostrar resumo do que foi removido
            const resumo = [
                `‚úÖ Tema removido`,
                historicoRelacionado.length > 0 ? `${historicoRelacionado.length} registro(s) de hist√≥rico` : '',
                lembretesRelacionados.length > 0 ? `${lembretesRelacionados.length} lembrete(s)` : '',
                anotacoesRelacionadas.length > 0 ? `${anotacoesRelacionadas.length} anota√ß√£o(√µes)` : ''
            ].filter(r => r).join('\n');
            
            mostrarNotificacaoFeedback(resumo);
            
            // Atualizar todas as visualiza√ß√µes
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            renderLembretes();
            renderCaderno();
        }
        
        function desfazerUltimoFeedback() {
            if (historico.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum feedback para desfazer!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Confirma revers√£o do √∫ltimo registro?')) {
                return;
            }
            
            const ultimaSessao = historico[historico.length - 1];
            
            // CORRE√á√ÉO: Buscar tema comparando IDs como strings
            const tema = dados.find(t => String(t.id) === String(ultimaSessao.temaId));
            
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado!', 'error');
                return;
            }
            
            historico.pop();
            tema.sessoes = Math.max(0, (tema.sessoes || 1) - 1);
            tema.tempo = Math.max(0, (tema.tempo || 0) - (ultimaSessao.tempo || 0));
            
            const sessoesRestantes = historico.filter(h => String(h.temaId) === String(tema.id));
            
            if (sessoesRestantes.length > 0) {
                const somaRend = sessoesRestantes.reduce((sum, h) => sum + (h.rendimento || 0), 0);
                tema.rendimento = somaRend / sessoesRestantes.length;
                
                // Recalcular contador80
                let contador = 0;
                for (let i = sessoesRestantes.length - 1; i >= 0; i--) {
                    if ((sessoesRestantes[i].rendimento || 0) >= 0.8) {
                        contador++;
                    } else {
                        break;
                    }
                }
                tema.contador80 = contador;
                
                // Atualizar √∫ltima data e agenda
                const ultimaSessaoRestante = sessoesRestantes[sessoesRestantes.length - 1];
                tema.ultEstudo = ultimaSessaoRestante ? ultimaSessaoRestante.data : '';
                tema.agenda = calcularProximaRevisao(tema);
            } else {
                tema.rendimento = 0;
                tema.status = 'Planejado';
                tema.ultEstudo = '';
                tema.agenda = '';
                tema.contador80 = 0;
            }
            
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            
            mostrarNotificacaoFeedback('‚úÖ Revers√£o executada com sucesso!');
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
            renderPendencias();
        }

        function renderHistorico() {
            const tbody = document.getElementById('historicoTableBody');
            
            // CORRE√á√ÉO: Filtrar hist√≥rico inv√°lido (√°rea "Tema" e linhas sem dados v√°lidos)
            const historicoFiltrado = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                // CORRE√á√ÉO: Aplicar fixAreaTema para corrigir invers√µes
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${h.observacoes || '-'}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${h.sugestao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Defina per√≠odo completo!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= dataInicio && h.data <= dataFim;
            });
            
            if (sessoesNoPeriodo.length === 0) {
                document.getElementById('relatorioResultado').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Sem dados no per√≠odo</div></div>';
                document.getElementById('btnExportarRelatorio').style.display = 'none';
                return;
            }
            
            const totalSessoes = sessoesNoPeriodo.length;
            const totalTempo = sessoesNoPeriodo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const rendimentoMedio = Math.round((sessoesNoPeriodo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100);
            
            const porArea = {};
            sessoesNoPeriodo.forEach(h => {
                const area = h.area || 'Sem √°rea';
                if (!porArea[area]) {
                    porArea[area] = { sessoes: 0, tempo: 0, rendimento: 0 };
                }
                porArea[area].sessoes++;
                porArea[area].tempo += h.tempo || 0;
                porArea[area].rendimento += h.rendimento || 0;
            });
            
            const resultado = `
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 12px;">
                        An√°lise: ${formatarDataBR(dataInicio)} - ${formatarDataBR(dataFim)}
                    </h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalSessoes}</div>
                            <div class="stat-label">Sess√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(totalTempo / 60)}h</div>
                            <div class="stat-label">Tempo Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rendimentoMedio}%</div>
                            <div class="stat-label">Performance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(porArea).length}</div>
                            <div class="stat-label">√Åreas</div>
                        </div>
                    </div>
                    <h5 style="color: var(--turquesa-light); margin: 20px 0 12px;">Detalhamento por √Årea:</h5>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√Årea</th>
                                <th>Sess√µes</th>
                                <th>Tempo</th>
                                <th>Rendimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(porArea).map(([area, stats]) => `
                                <tr>
                                    <td style="color: var(--turquesa-light);">${area}</td>
                                    <td style="text-align: center;">${stats.sessoes}</td>
                                    <td style="text-align: center;">${stats.tempo} min</td>
                                    <td style="text-align: center;">${Math.round(stats.rendimento / stats.sessoes * 100)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('relatorioResultado').innerHTML = resultado;
            document.getElementById('btnExportarRelatorio').style.display = 'block';
            
            localStorage.setItem('relatorioPeriodo', JSON.stringify({ dataInicio, dataFim }));
        }

        function exportarRelatorioPeriodo() {
            const periodo = JSON.parse(localStorage.getItem('relatorioPeriodo') || '{}');
            if (!periodo.dataInicio || !periodo.dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Gere relat√≥rio primeiro!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= periodo.dataInicio && h.data <= periodo.dataFim;
            });
            
            const csv = dados2CSV(sessoesNoPeriodo);
            const filename = `VRVS_RELATORIO_${periodo.dataInicio}_${periodo.dataFim}.csv`;
            downloadCSV(csv, filename);
        }
        
        function updateStats() {
            // Obter filtros de per√≠odo (se existirem)
            const inputInicio = document.getElementById('statsDataInicio');
            const inputFim = document.getElementById('statsDataFim');
            let dataInicio = inputInicio && inputInicio.value ? inputInicio.value : null;
            let dataFim = inputFim && inputFim.value ? inputFim.value : null;
            
            // CORRE√á√ÉO: Suspenso n√£o aparece em estat√≠sticas
            const temasAtivos = dados.filter(t => t.status !== 'Suspenso');
            document.getElementById('statTemas').textContent = temasAtivos.length;
            
            // Filtrar hist√≥rico de temas suspensos E por per√≠odo (se filtro aplicado)
            let historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                // Aplicar filtro de per√≠odo se existir
                if (dataInicio && dataFim && dataValida(h.data)) {
                    return h.data >= dataInicio && h.data <= dataFim;
                }
                return true;
            });
            
            const totalSessoes = historicoAtivo.length;
            document.getElementById('statSessoes').textContent = totalSessoes;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            document.getElementById('statRendimento').textContent = rendimentoMedio + '%';
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            document.getElementById('statTempo').textContent = totalHoras + 'h';
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes)
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoAtivo.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
                // Tamb√©m considerar tempoQuestoes e quantQuestoes se existirem
                if (h.tempoQuestoes && h.quantQuestoes) {
                    totalQuestoesTotal += parseInt(h.quantQuestoes) || 0;
                    totalQuestoesAcertos += parseInt(h.quantQuestoesAcertos) || 0;
                }
            });
            document.getElementById('statQuestoes').textContent = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular flashcards totais
            const totalFlashcards = historicoAtivo.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            document.getElementById('statFlashcards').textContent = totalFlashcards.toLocaleString();
            
            renderChartBarras();
            renderChartLinha();
            renderChartRadar();
        }
        
        // Fun√ß√µes de filtro para estat√≠sticas
        function filtrarStatsSemanaAtual() {
            const hoje = obterDataBrasilia();
            const diaSemana = hoje.getDay();
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            
            document.getElementById('statsDataInicio').value = segunda.toISOString().split('T')[0];
            document.getElementById('statsDataFim').value = domingo.toISOString().split('T')[0];
            aplicarFiltroStats();
        }
        
        function filtrarStatsMesAtual() {
            const hoje = obterDataBrasilia();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('statsDataInicio').value = primeiroDia.toISOString().split('T')[0];
            document.getElementById('statsDataFim').value = ultimoDia.toISOString().split('T')[0];
            aplicarFiltroStats();
        }
        
        function aplicarFiltroStats() {
            updateStats();
        }
        
        // ==================== GR√ÅFICOS POR √ÅREA! ====================
        
        const COLORS_PALETTE = [
            '#FFD700', '#FFA07A', '#F5DEB3', '#FF69B4', '#20B2AA', '#87CEEB',
            '#00FFE0', '#00CED1', '#FFA366', '#FF7F50', '#E55100', '#0d9488'
        ];
        let areaColorMap = {};
        let colorIndex = 0;
        
        function getColorForArea(area) {
            if (!areaColorMap[area]) {
                areaColorMap[area] = COLORS_PALETTE[colorIndex % COLORS_PALETTE.length];
                colorIndex++;
            }
            return areaColorMap[area];
        }
        
        let chartBarrasInst = null;
        let chartLinhaInst = null;
        let chartRadarInst = null;
        
        // GR√ÅFICO 1: Performance m√©dia POR √ÅREA
        function renderChartBarras() {
            const ctx = document.getElementById('chartBarras');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area: areaNormalizada } = fixAreaTema(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (areaNormalizada.toLowerCase() === 'tema') return;
                
                if (!areaStats[areaNormalizada]) {
                    areaStats[areaNormalizada] = { total: 0, count: 0 };
                }
                areaStats[areaNormalizada].total += h.rendimento * 100;
                areaStats[areaNormalizada].count += 1;
            });
            
            const areaRendimento = [];
            for (let area in areaStats) {
                const media = Math.round(areaStats[area].total / areaStats[area].count);
                areaRendimento.push([area, media]);
            }
            const sorted = areaRendimento.sort((a, b) => b[1] - a[1]);
            
            if (sorted.length === 0) {
                if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
                return;
            }
            if (chartBarrasInst) { chartBarrasInst.destroy(); }
            
            const backgroundColors = sorted.map(s => getColorForArea(s[0]));
            
            chartBarrasInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Performance M√©dia (%)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Performance M√©dia por √Årea',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
        }
        
        // GR√ÅFICO 2: Evolu√ß√£o POR √ÅREA
        function renderChartLinha() {
            const ctx = document.getElementById('chartLinha');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areasSessoes = {};
            historico.forEach(h => {
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                if (!areasSessoes[area]) {
                    areasSessoes[area] = [];
                }
                areasSessoes[area].push({
                    rendimento: (h.rendimento || 0) * 100,
                    sessao: areasSessoes[area].length + 1
                });
            });
            
            const datasets = Object.entries(areasSessoes).map(([area, sessoes]) => {
                const color = getColorForArea(area);
                return {
                    label: area,
                    data: sessoes.map(s => ({ x: s.sessao, y: s.rendimento })),
                    borderColor: color,
                    backgroundColor: color + '33',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            if (datasets.length === 0) {
                if (chartLinhaInst) { chartLinhaInst.destroy(); chartLinhaInst = null; }
                return;
            }
            
            if (chartLinhaInst) { chartLinhaInst.destroy(); }
            chartLinhaInst = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o da Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const area = context[0].dataset.label;
                                    const sessao = context[0].parsed.x;
                                    return `${area} - Sess√£o ${sessao}`;
                                },
                                label: function(context) {
                                    return `Performance: ${Math.round(context.parsed.y)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'N√∫mero da Sess√£o',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', stepSize: 1 },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Rendimento (%)',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
        }
        
        // GR√ÅFICO 3: Radar POR √ÅREA
        function renderChartRadar() {
            const ctx = document.getElementById('chartRadar');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                if (!areaStats[area]) {
                    areaStats[area] = { total: 0, count: 0 };
                }
                areaStats[area].total += h.rendimento * 100;
                areaStats[area].count += 1;
            });
            
            const areas = [];
            const rendimentos = [];
            for (let area in areaStats) {
                areas.push(area);
                rendimentos.push(Math.round(areaStats[area].total / areaStats[area].count));
            }
            
            if (areas.length === 0) {
                if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
                return;
            }
            
            if (chartRadarInst) { chartRadarInst.destroy(); }
            chartRadarInst = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'Performance M√©dia',
                        data: rendimentos,
                        borderColor: '#FFA500',
                        backgroundColor: 'rgba(255, 165, 0, 0.8)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#FFA500',
                        pointBorderColor: '#0a1a1f',
                        pointHoverBackgroundColor: '#FFA500',
                        pointHoverBorderColor: '#0a1a1f'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Mapa de Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(10, 26, 31, 0.95)',
                            borderColor: '#00CED1',
                            borderWidth: 2,
                            padding: 12,
                            titleColor: '#00CED1',
                            bodyColor: '#FFFFFF',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.r + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#00CED1',
                                backdropColor: 'rgba(10, 26, 31, 0.8)',
                                backdropPadding: 4,
                                stepSize: 20,
                                font: { size: 12, weight: 'bold' },
                                callback: function(val) {
                                    return val + '%';
                                }
                            },
                            grid: { 
                                color: 'rgba(0,206,209,0.3)',
                                lineWidth: 1
                            },
                            angleLines: { 
                                color: 'rgba(0,206,209,0.2)',
                                lineWidth: 1
                            },
                            pointLabels: {
                                color: '#00CED1',
                                font: { size: 12, weight: 'bold' },
                                padding: 15
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== IMPORTA√á√ÉO/EXPORTA√á√ÉO ====================
        
        function limparTudo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Apagar TODOS os dados?')) return;
            if (!confirm('‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Opera√ß√£o irrevers√≠vel!')) return;
            
            localStorage.removeItem('vrvs_dados');
            localStorage.removeItem('vrvs_historico');
            localStorage.removeItem('ultimoBackup');
            dados = [];
            historico = [];
            
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            
            mostrarNotificacaoFeedback('üóëÔ∏è Reset completo executado');
        }
        
        function importarArquivos() {
            const dadosFile = document.getElementById('importDados').files[0];
            const historicoFile = document.getElementById('importHistorico').files[0];
            
            if (!dadosFile && !historicoFile) {
                mostrarNotificacaoFeedback('‚ùå Selecione arquivo para importar!', 'error');
                return;
            }
            
            const promises = [];
            
            if (dadosFile) {
                promises.push(parseCSV(dadosFile).then(dadosCSV => {
                    console.log(`üì• [IMPORT DEBUG] Dados CSV parseados:`, {
                        total: dadosCSV.length,
                        primeiroItem: dadosCSV[0],
                        campos: dadosCSV[0] ? Object.keys(dadosCSV[0]) : []
                    });
                    
                    // CARREGAR DADOS EXISTENTES DO LOCALSTORAGE (N√ÉO SUBSTITUIR!)
                    const dadosExistentes = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                    console.log(`üì• [IMPORT DEBUG] Dados existentes no localStorage:`, {
                        total: dadosExistentes.length
                    });
                    
                    // Processar dados importados
                    const dadosImportados = dadosCSV.map(t => {
                        if (!t.id) t.id = Date.now() + Math.random();
                        // Normalizar √°rea/tema corretamente
                        const { area, tema } = fixAreaTema(t.area || '', t.tema || '');
                        t.area = area;
                        t.tema = tema;
                        
                        // PRESERVAR TODOS OS CAMPOS DO CSV DE DADOS
                        // Rendimento: se > 1, dividir por 100 (est√° em %)
                        if (t.rendimento !== undefined) {
                            t.rendimento = (t.rendimento > 1) ? t.rendimento / 100 : t.rendimento;
                        } else {
                            t.rendimento = 0;
                        }
                        
                        // Garantir tipos corretos com valores padr√£o se n√£o existirem
                        t.prioridade = (t.prioridade !== undefined) ? parseInt(t.prioridade) || 3 : 3;
                        t.sessoes = (t.sessoes !== undefined) ? parseInt(t.sessoes) || 0 : 0;
                        t.tempo = (t.tempo !== undefined) ? parseInt(t.tempo) || 0 : 0;
                        t.contador80 = (t.contador80 !== undefined) ? parseInt(t.contador80) || 0 : 0;
                        
                        // Status: preservar se existir, sen√£o calcular baseado em sessoes
                        if (!t.status) {
                            t.status = t.sessoes > 0 ? 'Em estudo' : 'N√£o iniciado';
                        }
                        
                        // Preservar ultEstudo e agenda se existirem (n√£o sobrescrever)
                        if (!t.ultEstudo && t.sessoes === 0) t.ultEstudo = '';
                        if (!t.agenda && t.sessoes === 0) t.agenda = '';
                        
                        // Preservar dificuldade se existir
                        if (!t.dificuldade) t.dificuldade = '';
                        
                        // Sugest√£o: extrair de observacoes se n√£o existir
                        if (!t.sugestao || t.sugestao === '-') {
                            t.sugestao = extrairUltimaSugestao(t.observacoes);
                        }
                        
                        // REMOVER apenas campos que n√£o pertencem a DADOS (caso CSV tenha campos mistos)
                        delete t.tempoIntervalo;
                        delete t.numeroIntervalos;
                        delete t.intervalos;
                        delete t.tempoQuestoes;
                        delete t.quantQuestoes;
                        delete t.quantQuestoesAcertos;
                        delete t.tempoFlashcards;
                        delete t.quantFlashcards;
                        delete t.questoes;
                        delete t.flashcards;
                        delete t.data; // 'data' em DADOS √© campo vazio, n√£o deve existir
                        
                        delete t.tipoRevisao; // Campo antigo que n√£o existe mais
                        
                        // PRESERVAR CAMPOS EXTRAS que possam existir no CSV
                        // (n√£o deletar campos que n√£o conhecemos - podem ser dados importantes)
                        
                        return t;
                    });
                    
                    // MESCLAR dados existentes com dados importados
                    // Estrat√©gia: usar √°rea+tema como chave √∫nica
                    const dadosMesclados = [...dadosExistentes];
                    const chavesExistentes = new Set();
                    dadosExistentes.forEach(d => {
                        const chave = `${String(d.area).toLowerCase().trim()}_${String(d.tema).toLowerCase().trim()}`;
                        chavesExistentes.add(chave);
                    });
                    
                    dadosImportados.forEach(d => {
                        const chave = `${String(d.area).toLowerCase().trim()}_${String(d.tema).toLowerCase().trim()}`;
                        if (chavesExistentes.has(chave)) {
                            // Tema j√° existe: MESCLAR campos (preservar dados existentes, atualizar com dados importados)
                            const index = dadosMesclados.findIndex(ex => {
                                const chaveEx = `${String(ex.area).toLowerCase().trim()}_${String(ex.tema).toLowerCase().trim()}`;
                                return chaveEx === chave;
                            });
                            if (index >= 0) {
                                // Mesclar: dados importados t√™m prioridade, mas preservar campos extras existentes
                                const existente = dadosMesclados[index];
                                Object.keys(d).forEach(key => {
                                    if (d[key] !== undefined && d[key] !== null && d[key] !== '') {
                                        existente[key] = d[key];
                                    }
                                });
                                // Preservar campos extras do existente que n√£o est√£o no importado
                                Object.keys(existente).forEach(key => {
                                    if (d[key] === undefined && existente[key] !== undefined) {
                                        // Campo existe apenas no existente, preservar
                                    }
                                });
                            }
                        } else {
                            // Tema novo: ADICIONAR
                            dadosMesclados.push(d);
                            chavesExistentes.add(chave);
                        }
                    });
                    
                    dados = dadosMesclados;
                    
                    console.log(`üì• [IMPORT DEBUG] Dados processados e mesclados:`, {
                        totalExistente: dadosExistentes.length,
                        totalImportado: dadosImportados.length,
                        totalFinal: dados.length,
                        primeiroItem: dados[0],
                        campos: dados[0] ? Object.keys(dados[0]) : []
                    });
                    
                    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                    // Atualizar vari√°vel global
                    window.dados = dados;
                    
                    console.log(`‚úÖ [IMPORT DEBUG] Dados salvos no localStorage:`, {
                        total: dados.length,
                        primeiroItem: dados[0]
                    });
                    
                    return 'dados';
                }));
            }
            
            if (historicoFile) {
                promises.push(parseCSV(historicoFile).then(historicoCSV => {
                    console.log(`üì• [IMPORT DEBUG] Hist√≥rico CSV parseado:`, {
                        total: historicoCSV.length,
                        primeiroItem: historicoCSV[0],
                        campos: historicoCSV[0] ? Object.keys(historicoCSV[0]) : []
                    });
                    
                    // CARREGAR HIST√ìRICO EXISTENTE DO LOCALSTORAGE (N√ÉO SUBSTITUIR!)
                    const historicoExistente = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
                    console.log(`üì• [IMPORT DEBUG] Hist√≥rico existente no localStorage:`, {
                        total: historicoExistente.length
                    });
                    
                    // Processar hist√≥rico importado
                    const historicoImportado = historicoCSV.map(h => {
                        if (!h.id) h.id = Date.now() + Math.random();
                        // Normalizar √°rea/tema corretamente
                        const { area, tema } = fixAreaTema(h.area || '', h.tema || '');
                        
                        // CRIAR OBJETO LIMPO APENAS COM CAMPOS DO HIST√ìRICO
                        // Mas preservar campos extras que possam existir no CSV
                        const historicoLimpo = {
                            id: h.id,
                            temaId: h.temaId || '',
                            area: area,
                            tema: tema,
                            rendimento: (h.rendimento !== undefined && h.rendimento > 1) ? h.rendimento / 100 : (h.rendimento || 0),
                            tempo: parseInt(h.tempo) || 0,
                            tempoIntervalo: parseInt(h.tempoIntervalo) || 0,
                            numeroIntervalos: parseInt(h.numeroIntervalos) || 0,
                            intervalos: h.intervalos || '',
                            tempoQuestoes: parseInt(h.tempoQuestoes) || 0,
                            quantQuestoes: parseInt(h.quantQuestoes) || 0,
                            quantQuestoesAcertos: parseInt(h.quantQuestoesAcertos) || 0,
                            tempoFlashcards: parseInt(h.tempoFlashcards) || 0,
                            quantFlashcards: parseInt(h.quantFlashcards) || 0,
                            questoes: h.questoes || '',
                            flashcards: parseInt(h.flashcards) || 0,
                            data: h.data || '',
                            observacoes: h.observacoes || '',
                            sugestao: h.sugestao || ''
                        };
                        
                        // PRESERVAR CAMPOS EXTRAS que possam existir no CSV
                        Object.keys(h).forEach(key => {
                            // Campos conhecidos j√° foram mapeados acima
                            const camposConhecidos = ['id', 'temaId', 'area', 'tema', 'rendimento', 'tempo',
                                'tempoIntervalo', 'numeroIntervalos', 'intervalos', 'tempoQuestoes',
                                'quantQuestoes', 'quantQuestoesAcertos', 'tempoFlashcards', 'quantFlashcards',
                                'questoes', 'flashcards', 'data', 'observacoes', 'sugestao'];
                            if (!camposConhecidos.includes(key) && h[key] !== undefined && h[key] !== null) {
                                historicoLimpo[key] = h[key];
                            }
                        });
                        
                        // Extrair data de observacoes se n√£o existir
                        if (!historicoLimpo.data || historicoLimpo.data === '-') {
                            const obsMatch = (historicoLimpo.observacoes || '').match(/^(\d{4}-\d{2}-\d{2}):/);
                            if (obsMatch) {
                                historicoLimpo.data = obsMatch[1];
                            }
                        }
                        
                        // Extrair sugest√£o de observacoes se n√£o existir
                        if (!historicoLimpo.sugestao || historicoLimpo.sugestao === '-') {
                            historicoLimpo.sugestao = extrairUltimaSugestao(historicoLimpo.observacoes);
                        }
                        
                        return historicoLimpo;
                    });
                    
                    // MESCLAR hist√≥rico existente com hist√≥rico importado
                    // Estrat√©gia: usar ID como chave √∫nica (se ID existe e √© v√°lido)
                    const historicoMesclado = [...historicoExistente];
                    const idsExistentes = new Set();
                    historicoExistente.forEach(h => {
                        if (h.id) idsExistentes.add(String(h.id));
                    });
                    
                    historicoImportado.forEach(h => {
                        if (h.id && idsExistentes.has(String(h.id))) {
                            // Registro j√° existe: MESCLAR (preservar dados existentes, atualizar com dados importados)
                            const index = historicoMesclado.findIndex(ex => String(ex.id) === String(h.id));
                            if (index >= 0) {
                                const existente = historicoMesclado[index];
                                Object.keys(h).forEach(key => {
                                    if (h[key] !== undefined && h[key] !== null && h[key] !== '') {
                                        existente[key] = h[key];
                                    }
                                });
                                // Preservar campos extras do existente
                                Object.keys(existente).forEach(key => {
                                    if (h[key] === undefined && existente[key] !== undefined) {
                                        // Campo existe apenas no existente, preservar
                                    }
                                });
                            }
                        } else {
                            // Registro novo: ADICIONAR
                            historicoMesclado.push(h);
                            if (h.id) idsExistentes.add(String(h.id));
                        }
                    });
                    
                    historico = historicoMesclado;
                    
                    console.log(`üì• [IMPORT DEBUG] Hist√≥rico processado e mesclado:`, {
                        totalExistente: historicoExistente.length,
                        totalImportado: historicoImportado.length,
                        totalFinal: historico.length,
                        primeiroItem: historico[0],
                        campos: historico[0] ? Object.keys(historico[0]) : []
                    });
                    
                    localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                    // Atualizar vari√°vel global
                    window.historico = historico;
                    
                    console.log(`‚úÖ [IMPORT DEBUG] Hist√≥rico salvo no localStorage:`, {
                        total: historico.length,
                        primeiroItem: historico[0]
                    });
                    
                    return 'historico';
                }));
            }
            
            Promise.all(promises)
                .then(results => {
                    // CORRE√á√ÉO: Limpar hist√≥rico inv√°lido ap√≥s importa√ß√£o
                    limparHistoricoInvalido();
                    
                    // Atualizar vari√°vel global de hist√≥rico
                    historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
                    
                    // FOR√áAR atualiza√ß√£o da vari√°vel global de dados
                    dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                    window.dados = dados;
                    
                    console.log('üì• Dados importados:', dados.length, 'temas');
                    console.log('üì• Primeiros 3 temas:', dados.slice(0, 3).map(t => ({
                        tema: t.tema,
                        sessoes: t.sessoes,
                        rendimento: t.rendimento,
                        status: t.status
                    })));
                    
                    const msg = results.map(r => r === 'dados' ? 'Dados' : 'Hist√≥rico').join(' e ');
                    mostrarNotificacaoFeedback(`‚úÖ ${msg} importados com sucesso!`);
                    document.getElementById('importDados').value = '';
                    document.getElementById('importHistorico').value = '';
                    
                    // Re-renderizar TUDO ap√≥s importa√ß√£o (com pequeno delay para garantir que localStorage foi atualizado)
                    setTimeout(() => {
                        console.log('üîÑ Renderizando ap√≥s importa√ß√£o...');
                        renderDados();
                        renderTarefas();
                        renderAgenda();
                        renderHistorico();
                        renderPendencias();
                        updateFeedbackSelect();
                        updateStats();
                    }, 100);
                })
                .catch(error => {
                    mostrarNotificacaoFeedback(`‚ùå Erro: ${error.message}`, 'error');
                });
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = parseCSVText(text);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo vazio ou inv√°lido'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        
                        // DETECTAR TIPO DE CSV UMA VEZ NO IN√çCIO
                        // CSV de DADOS tem campos: status, prioridade, sessoes, ultEstudo, agenda
                        // CSV de HIST√ìRICO tem campos: temaId, tempoIntervalo, numeroIntervalos, data
                        const temStatus = headerMap['status'] !== undefined;
                        const temPrioridade = headerMap['prioridade'] !== undefined;
                        const temSessoes = headerMap['sessoes'] !== undefined;
                        const temUltEstudo = headerMap['ultestudo'] !== undefined;
                        const temAgenda = headerMap['agenda'] !== undefined;
                        const temTemaId = headerMap['temaid'] !== undefined;
                        const temTempoIntervalo = headerMap['tempointervalo'] !== undefined;
                        const temNumeroIntervalos = headerMap['numerointervalos'] !== undefined;
                        const temData = headerMap['data'] !== undefined;
                        
                        const isCSVDados = (temStatus || temPrioridade || temSessoes || temUltEstudo || temAgenda) && !temTemaId;
                        const isCSVHistorico = temTemaId && (temData || temTempoIntervalo || temNumeroIntervalos);
                        
                        console.log(`üì• [CSV DEBUG] Tipo detectado:`, {
                            tipo: isCSVDados ? 'DADOS' : (isCSVHistorico ? 'HISTORICO' : 'INDETERMINADO'),
                            headers: headers,
                            temStatus,
                            temPrioridade,
                            temSessoes,
                            temUltEstudo,
                            temAgenda,
                            temTemaId,
                            temTempoIntervalo,
                            temNumeroIntervalos,
                            temData
                        });
                        
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx] !== undefined && r[idx] !== '') {
                                    return stripOuterQuotes(r[idx]);
                                }
                            }
                            return '';
                        };
                        
                        const data = rows.slice(1).map((r, lineNum) => {
                            
                            // OBJETO BASE COM CAMPOS COMUNS
                            const obj = {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                area: getVal(r, 'area'),
                                tema: getVal(r, 'tema'),
                                rendimento: (() => {
                                    const valStr = getVal(r, 'rendimento', 'rend');
                                    if (!valStr) return 0;
                                    const cleanStr = valStr.replace('%', '').replace(',', '.');
                                    const val = parseFloat(cleanStr) || 0;
                                    return val > 1 ? val / 100 : val;
                                })(),
                                tempo: parseInt(getVal(r, 'tempo', 'tempomin')) || 0,
                                observacoes: getVal(r, 'observacoes', 'obs', 'observacao') || '',
                                sugestao: getVal(r, 'sugestao', 'sugestoes') || ''
                            };
                            
                            // CAMPOS ESPEC√çFICOS DO CSV DE DADOS
                            if (isCSVDados) {
                                obj.status = getVal(r, 'status') || 'N√£o iniciado';
                                obj.prioridade = parseInt(getVal(r, 'prioridade', 'prior')) || 3;
                                obj.sessoes = parseInt(getVal(r, 'sessoes', 'sessao')) || 0;
                                obj.ultEstudo = getVal(r, 'ultestudo', 'ultimoestudo') || '';
                                obj.agenda = getVal(r, 'agenda') || '';
                                obj.dificuldade = getVal(r, 'dificuldade', 'dific') || '';
                                obj.contador80 = parseInt(getVal(r, 'contador80', 'contador')) || 0;
                                obj.temaId = getVal(r, 'temaid') || '';
                                // Campos de hist√≥rico n√£o devem estar em DADOS
                                obj.tempoIntervalo = undefined;
                                obj.numeroIntervalos = undefined;
                                obj.intervalos = undefined;
                                obj.tempoQuestoes = undefined;
                                obj.quantQuestoes = undefined;
                                obj.quantQuestoesAcertos = undefined;
                                obj.tempoFlashcards = undefined;
                                obj.quantFlashcards = undefined;
                                obj.questoes = undefined;
                                obj.flashcards = undefined;
                                obj.data = undefined;
                            }
                            
                            // CAMPOS ESPEC√çFICOS DO CSV DE HIST√ìRICO
                            if (isCSVHistorico) {
                                obj.temaId = getVal(r, 'temaid') || '';
                                obj.tempoIntervalo = parseInt(getVal(r, 'tempointervalo')) || 0;
                                obj.numeroIntervalos = parseInt(getVal(r, 'numerointervalos')) || 0;
                                obj.intervalos = getVal(r, 'intervalos') || '';
                                obj.tempoQuestoes = parseInt(getVal(r, 'tempoquestoes')) || 0;
                                obj.quantQuestoes = parseInt(getVal(r, 'quantquestoes')) || 0;
                                obj.quantQuestoesAcertos = parseInt(getVal(r, 'quantquestoesacertos')) || 0;
                                obj.tempoFlashcards = parseInt(getVal(r, 'tempoflashcards')) || 0;
                                obj.quantFlashcards = parseInt(getVal(r, 'quantflashcards')) || 0;
                                obj.questoes = getVal(r, 'questoes') || '';
                                obj.flashcards = parseInt(getVal(r, 'flashcards')) || 0;
                                obj.data = getVal(r, 'data') || '';
                                // Campos de dados n√£o devem estar em HIST√ìRICO
                                obj.status = undefined;
                                obj.prioridade = undefined;
                                obj.sessoes = undefined;
                                obj.ultEstudo = undefined;
                                obj.agenda = undefined;
                                obj.dificuldade = undefined;
                                obj.contador80 = undefined;
                            }
                            
                            // Remover campos undefined para manter objeto limpo
                            Object.keys(obj).forEach(key => {
                                if (obj[key] === undefined) delete obj[key];
                            });
                            
                            return obj;
                        }).filter(obj => obj.tema && obj.tema.trim() !== '');
                        resolve(data);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function parseCSVText(input) {
            let text = String(input || '').replace(/^\uFEFF/, '');
            const rows = [];
            let row = [];
            let cell = '';
            let i = 0;
            let inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    if (ch === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            cell += '"';
                            i += 2;
                        } else {
                            inQuotes = false;
                            i += 1;
                        }
                    } else {
                        cell += ch;
                        i += 1;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                        i += 1;
                    } else if (ch === ',') {
                        row.push(cell);
                        cell = '';
                        i += 1;
                    } else if (ch === '\r') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        if (text[i + 1] === '\n') i += 2; else i += 1;
                    } else if (ch === '\n') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        i += 1;
                    } else {
                        cell += ch;
                        i += 1;
                    }
                }
            }
            row.push(cell);
            rows.push(row);
            return rows;
        }
        
        function stripOuterQuotes(s) {
            const str = String(s ?? '');
            if (str.length >= 2 && str[0] === '"' && str[str.length - 1] === '"') {
                return str.slice(1, -1).replace(/""/g, '"');
            }
            return str;
        }
        
        function exportarDados() {
            // ESTRUTURA FIXA E COMPLETA PARA EXPORTA√á√ÉO DE DADOS
            // Garantir ordem consistente e todos os campos necess√°rios
            // IMPORTANTE: Preservar TODOS os campos, incluindo campos extras n√£o mapeados
            const dadosExport = dados.map(t => {
                const obj = {
                    id: t.id || '',
                    area: t.area || '',
                    tema: t.tema || '',
                    status: t.status || 'N√£o iniciado',
                    prioridade: t.prioridade !== undefined ? t.prioridade : 3,
                    dificuldade: t.dificuldade || '',
                    rendimento: t.rendimento !== undefined ? t.rendimento : 0,
                    sessoes: t.sessoes !== undefined ? t.sessoes : 0,
                    ultEstudo: t.ultEstudo || '',
                    agenda: t.agenda || '',
                    tempo: t.tempo !== undefined ? t.tempo : 0,
                    observacoes: t.observacoes || '',
                    contador80: t.contador80 !== undefined ? t.contador80 : 0,
                    sugestao: t.sugestao || '',
                    data: '', // Campo vazio para compatibilidade
                    temaId: t.temaId || '' // Campo opcional
                };
                
                // PRESERVAR CAMPOS EXTRAS que possam existir (para n√£o perder dados)
                Object.keys(t).forEach(key => {
                    if (!obj.hasOwnProperty(key) && t[key] !== undefined && t[key] !== null) {
                        obj[key] = t[key];
                    }
                });
                
                return obj;
            });
            
            // Ordem fixa dos headers principais, mas incluir campos extras
            const headersBase = [
                'id', 'area', 'tema', 'status', 'prioridade', 'dificuldade',
                'rendimento', 'sessoes', 'ultEstudo', 'agenda', 'tempo',
                'observacoes', 'contador80', 'sugestao', 'data', 'temaId'
            ];
            
            // Adicionar campos extras encontrados nos dados
            const headersExtras = new Set();
            dadosExport.forEach(obj => {
                Object.keys(obj).forEach(key => {
                    if (!headersBase.includes(key)) {
                        headersExtras.add(key);
                    }
                });
            });
            
            const headers = [...headersBase, ...Array.from(headersExtras)];
            
            const csv = dados2CSVComHeaders(dadosExport, headers);
            const hoje = obterDataBrasiliaString();
            downloadCSV(csv, `VRVS_DADOS_${hoje}.csv`);
        }
        
        function exportarHistorico() {
            // ESTRUTURA FIXA E COMPLETA PARA EXPORTA√á√ÉO DE HIST√ìRICO
            // Garantir ordem consistente e todos os campos necess√°rios
            // IMPORTANTE: Preservar TODOS os campos, incluindo campos extras n√£o mapeados
            const historicoExport = historico.map(h => {
                const obj = {
                    id: h.id || '',
                    temaId: h.temaId || '',
                    area: h.area || '',
                    tema: h.tema || '',
                    rendimento: h.rendimento !== undefined ? h.rendimento : 0,
                    tempo: h.tempo !== undefined ? h.tempo : 0,
                    tempoIntervalo: h.tempoIntervalo !== undefined ? h.tempoIntervalo : 0,
                    numeroIntervalos: h.numeroIntervalos !== undefined ? h.numeroIntervalos : 0,
                    intervalos: h.intervalos || '',
                    tempoQuestoes: h.tempoQuestoes !== undefined ? h.tempoQuestoes : 0,
                    quantQuestoes: h.quantQuestoes !== undefined ? h.quantQuestoes : 0,
                    quantQuestoesAcertos: h.quantQuestoesAcertos !== undefined ? h.quantQuestoesAcertos : 0,
                    tempoFlashcards: h.tempoFlashcards !== undefined ? h.tempoFlashcards : 0,
                    quantFlashcards: h.quantFlashcards !== undefined ? h.quantFlashcards : 0,
                    questoes: h.questoes || '',
                    flashcards: h.flashcards !== undefined ? h.flashcards : 0,
                    data: h.data || '',
                    observacoes: h.observacoes || '',
                    sugestao: h.sugestao || ''
                };
                
                // PRESERVAR CAMPOS EXTRAS que possam existir (para n√£o perder dados)
                Object.keys(h).forEach(key => {
                    if (!obj.hasOwnProperty(key) && h[key] !== undefined && h[key] !== null) {
                        obj[key] = h[key];
                    }
                });
                
                return obj;
            });
            
            // Ordem fixa dos headers principais, mas incluir campos extras
            const headersBase = [
                'id', 'temaId', 'area', 'tema', 'rendimento', 'tempo',
                'tempoIntervalo', 'numeroIntervalos', 'intervalos',
                'tempoQuestoes', 'quantQuestoes', 'quantQuestoesAcertos',
                'tempoFlashcards', 'quantFlashcards', 'questoes', 'flashcards',
                'data', 'observacoes', 'sugestao'
            ];
            
            // Adicionar campos extras encontrados no hist√≥rico
            const headersExtras = new Set();
            historicoExport.forEach(obj => {
                Object.keys(obj).forEach(key => {
                    if (!headersBase.includes(key)) {
                        headersExtras.add(key);
                    }
                });
            });
            
            const headers = [...headersBase, ...Array.from(headersExtras)];
            
            const csv = dados2CSVComHeaders(historicoExport, headers);
            const hoje = obterDataBrasiliaString();
            downloadCSV(csv, `VRVS_HISTORICO_${hoje}.csv`);
        }
        
        // Fun√ß√£o auxiliar para CSV com headers fixos
        function dados2CSVComHeaders(arr, headers) {
            if (arr.length === 0) {
                return headers.join(',');
            }
            
            const rows = arr.map(obj => {
                return headers.map(h => {
                    const val = (obj && obj[h] != null) ? obj[h] : '';
                    const strVal = String(val);
                    // Escapar aspas duplas
                    const escaped = strVal.replace(/"/g, '""');
                    // Se cont√©m v√≠rgula, quebra de linha ou aspas, precisa estar entre aspas
                    if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) {
                        return `"${escaped}"`;
                    }
                    return escaped;
                }).join(',');
            });
            
            return [headers.join(','), ...rows].join('\n');
        }
        
        function salvarDadosManualmente() {
            try {
                // Salvar todos os dados no localStorage
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                mostrarNotificacaoFeedback('‚úÖ Todos os dados salvos com sucesso!');
            } catch (e) {
                mostrarNotificacaoFeedback('‚ùå Erro ao salvar: ' + e.message, 'error');
            }
        }
        
        function dados2CSV(arr) {
            if (arr.length === 0) return '';
            // Uni√£o de todas as chaves para garantir todas as colunas
            const headerSet = new Set();
            arr.forEach(obj => {
                if (obj) Object.keys(obj).forEach(k => headerSet.add(k));
            });
            // Garantir que observacoes e sugestao est√£o sempre presentes
            headerSet.add('observacoes');
            headerSet.add('sugestao');
            const headers = Array.from(headerSet);
            
            const rows = arr.map(obj => headers.map(h => {
                const val = (obj && obj[h] != null) ? obj[h] : '';
                const strVal = String(val);
                // Escapar aspas duplas
                const escaped = strVal.replace(/"/g, '""');
                // Se cont√©m v√≠rgula, quebra de linha ou aspas, precisa estar entre aspas
                if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) {
                    return `"${escaped}"`;
                }
                return escaped;
            }).join(','));
            return [headers.join(','), ...rows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // ==================== NAVEGA√á√ÉO ====================
        
        // Fun√ß√£o GLOBAL para navega√ß√£o - FUNCIONA GARANTIDAMENTE
        window.showSection = function(sectionId) {
            console.log('üìÇ Navegando para se√ß√£o:', sectionId);
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // Encontrar e ativar a tab correspondente (sem usar event.target que pode n√£o existir)
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                const text = tab.textContent.toLowerCase();
                const sectionMap = {
                    'dados': 'dados',
                    'cadastro': 'cadastro',
                    'feedback': 'feedback',
                    'tarefa': 'tarefa',
                    'agenda': 'agenda',
                    'pendencias': 'pend√™ncias',
                    'stats': 'estat√≠sticas',
                    'analises': 'an√°lises',
                    'historico': 'hist√≥rico',
                    'lembretes': 'lembretes',
                    'caderno': 'caderno',
                    'relatorios': 'relat√≥rios',
                    'importar': 'importar',
                    'exportar': 'exportar',
                    'tutorial': 'tutorial'
                };
                if (text.includes(sectionMap[sectionId] || '')) {
                    tab.classList.add('active');
                }
            });
            
            // Renderizar se√ß√µes espec√≠ficas quando necess√°rio
            if (sectionId === 'dados' && typeof renderDados === 'function') renderDados();
            if (sectionId === 'tarefa' && typeof renderTarefas === 'function') renderTarefas();
            if (sectionId === 'agenda') {
                const inputInicio = document.getElementById('agendaDataInicio');
                const inputFim = document.getElementById('agendaDataFim');
                if (inputInicio && inputFim && (!inputInicio.value || !inputFim.value)) {
                    if (typeof filtrarSemanaAtual === 'function') filtrarSemanaAtual();
                } else {
                    if (typeof renderAgenda === 'function') renderAgenda();
                }
            }
            if (sectionId === 'feedback' && typeof updateFeedbackSelect === 'function') updateFeedbackSelect();
            if (sectionId === 'historico' && typeof renderHistorico === 'function') renderHistorico();
            if (sectionId === 'pendencias' && typeof renderPendencias === 'function') renderPendencias();
            if (sectionId === 'lembretes') {
                if (typeof atualizarSelectsLembrete === 'function') atualizarSelectsLembrete();
                if (typeof renderLembretes === 'function') renderLembretes();
            }
            if (sectionId === 'caderno') {
                if (typeof atualizarSelectsCaderno === 'function') atualizarSelectsCaderno();
                if (typeof renderCaderno === 'function') renderCaderno();
            }
            if (sectionId === 'analises') {
                if (typeof atualizarSelectsAnalise === 'function') atualizarSelectsAnalise();
                if (typeof atualizarAnalises === 'function') atualizarAnalises();
            }
            if (sectionId === 'stats' && typeof updateStats === 'function') updateStats();
        };
        
        // ==================== AN√ÅLISES DETALHADAS ====================
        
        function atualizarSelectsAnalise() {
            // Atualizar select de √°reas
            const areaSelect = document.getElementById('analiseFiltroArea');
            const areas = [...new Set(dados.filter(t => t.status !== 'Suspenso').map(t => t.area))].sort();
            areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
            areas.forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
            
            // Atualizar select de temas baseado na √°rea selecionada
            atualizarSelectTemaAnalise();
        }
        
        function atualizarSelectTemaAnalise() {
            const temaSelect = document.getElementById('analiseFiltroTema');
            const areaSelecionada = document.getElementById('analiseFiltroArea').value;
            
            let temasFiltrados = dados.filter(t => t.status !== 'Suspenso');
            if (areaSelecionada) {
                temasFiltrados = temasFiltrados.filter(t => t.area === areaSelecionada);
            }
            
            const temas = [...new Set(temasFiltrados.map(t => `${t.area} - ${t.tema}`))].sort();
            temaSelect.innerHTML = '<option value="">Todos os temas</option>';
            temas.forEach(tema => {
                temaSelect.innerHTML += `<option value="${tema}">${tema}</option>`;
            });
        }
        
        function atualizarAnalises() {
            calcularAnalises();
            // Se an√°lises de tempo estiverem vis√≠veis, recalcular tamb√©m
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        // Vari√°vel global para controlar visibilidade das an√°lises de tempo
        window.analisesTempoVisiveis = false;
        
        function toggleAnalisesTempo() {
            window.analisesTempoVisiveis = !window.analisesTempoVisiveis;
            const toggleText = document.getElementById('toggleAnalisesTempoText');
            const analiseTempoDiv = document.getElementById('analiseTempo');
            
            if (toggleText) {
                toggleText.textContent = window.analisesTempoVisiveis ? '‚è±Ô∏è Ocultar' : '‚è±Ô∏è Mostrar';
            }
            
            if (analiseTempoDiv) {
                analiseTempoDiv.style.display = window.analisesTempoVisiveis ? 'block' : 'none';
            }
            
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function calcularAnalisesTempo() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico (mesma l√≥gica de calcularAnalises)
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseTempo').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">‚è±Ô∏è</div><div>Nenhum dado de tempo encontrado</div></div>';
                return;
            }
            
            // Calcular m√©dias de tempo
            const sessoesComTempo = historicoFiltrado.filter(h => h.tempo && h.tempo > 0);
            const tempoMedioSessao = sessoesComTempo.length > 0
                ? Math.round(sessoesComTempo.reduce((sum, h) => sum + (h.tempo || 0), 0) / sessoesComTempo.length)
                : 0;
            
            // Tempo m√©dio em quest√µes
            const sessoesComTempoQuestoes = historicoFiltrado.filter(h => h.tempoQuestoes && h.tempoQuestoes > 0);
            const tempoMedioQuestoes = sessoesComTempoQuestoes.length > 0
                ? Math.round(sessoesComTempoQuestoes.reduce((sum, h) => sum + (h.tempoQuestoes || 0), 0) / sessoesComTempoQuestoes.length)
                : 0;
            
            // Tempo m√©dio em flashcards
            const sessoesComTempoFlashcards = historicoFiltrado.filter(h => h.tempoFlashcards && h.tempoFlashcards > 0);
            const tempoMedioFlashcards = sessoesComTempoFlashcards.length > 0
                ? Math.round(sessoesComTempoFlashcards.reduce((sum, h) => sum + (h.tempoFlashcards || 0), 0) / sessoesComTempoFlashcards.length)
                : 0;
            
            // M√©dia de intervalos por sess√£o
            const sessoesComIntervalos = historicoFiltrado.filter(h => h.numeroIntervalos && h.numeroIntervalos > 0);
            const mediaIntervalosPorSessao = sessoesComIntervalos.length > 0
                ? (sessoesComIntervalos.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0) / sessoesComIntervalos.length).toFixed(1)
                : '0';
            
            // Tempo m√©dio de cada intervalo
            const intervalosIndividuais = [];
            historicoFiltrado.forEach(h => {
                if (h.intervalos && h.tempoIntervalo && h.numeroIntervalos) {
                    const numIntervalos = parseInt(h.numeroIntervalos) || 0;
                    const tempoTotalIntervalos = parseInt(h.tempoIntervalo) || 0;
                    if (numIntervalos > 0 && tempoTotalIntervalos > 0) {
                        intervalosIndividuais.push(tempoTotalIntervalos / numIntervalos);
                    }
                }
            });
            const tempoMedioIntervalo = intervalosIndividuais.length > 0
                ? Math.round(intervalosIndividuais.reduce((sum, t) => sum + t, 0) / intervalosIndividuais.length)
                : 0;
            
            // Renderizar an√°lises de tempo
            const html = `
                <div style="background: rgba(0,206,209,0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 16px;">‚è±Ô∏è AN√ÅLISES DE TEMPO</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioSessao} min</div>
                            <div class="stat-label">Tempo M√©dio por Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioQuestoes} min</div>
                            <div class="stat-label">Tempo M√©dio em Quest√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioFlashcards} min</div>
                            <div class="stat-label">Tempo M√©dio em Flashcards</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${mediaIntervalosPorSessao}</div>
                            <div class="stat-label">M√©dia de Intervalos/Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioIntervalo} min</div>
                            <div class="stat-label">Tempo M√©dio por Intervalo</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analiseTempo').innerHTML = html;
        }
        
        function calcularAnalises() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                // Filtrar por √°rea
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                // Filtrar por tema
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                // Filtrar por per√≠odo
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseResultados').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Nenhum dado encontrado para os filtros selecionados</div></div>';
                return;
            }
            
            // Calcular estat√≠sticas
            const totalSessoes = historicoFiltrado.length;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoFiltrado.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            const totalMinutos = historicoFiltrado.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            const totalMinutosResto = totalMinutos % 60;
            
            // Calcular quest√µes
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                // Verificar campo questoes (formato string "15/20")
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
                // CORRE√á√ÉO: Tamb√©m considerar quantQuestoes e quantQuestoesAcertos se existirem
                if (h.quantQuestoes && parseInt(h.quantQuestoes) > 0) {
                    totalQuestoesTotal += parseInt(h.quantQuestoes) || 0;
                    totalQuestoesAcertos += parseInt(h.quantQuestoesAcertos) || 0;
                }
            });
            const taxaAcertoQuestoes = totalQuestoesTotal > 0 
                ? Math.round((totalQuestoesAcertos / totalQuestoesTotal) * 100)
                : 0;
            
            // Calcular flashcards
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            // Calcular intervalos
            const totalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0);
            const tempoTotalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.tempoIntervalo) || 0), 0);
            
            // Agrupar por √°rea (se n√£o filtrado por √°rea espec√≠fica)
            let porArea = {};
            if (!areaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema && tema.area) {
                        if (!porArea[tema.area]) {
                            porArea[tema.area] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porArea[tema.area].sessoes++;
                        porArea[tema.area].tempo += h.tempo || 0;
                        porArea[tema.area].rendimento += h.rendimento || 0;
                        
                        // Verificar campo questoes (formato string "15/20")
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porArea[tema.area].questoes.acertos += parseInt(match[1]);
                                porArea[tema.area].questoes.total += parseInt(match[2]);
                            }
                        }
                        // CORRE√á√ÉO: Tamb√©m considerar quantQuestoes e quantQuestoesAcertos se existirem
                        if (h.quantQuestoes && parseInt(h.quantQuestoes) > 0) {
                            porArea[tema.area].questoes.total += parseInt(h.quantQuestoes) || 0;
                            porArea[tema.area].questoes.acertos += parseInt(h.quantQuestoesAcertos) || 0;
                        }
                        
                        porArea[tema.area].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porArea).forEach(area => {
                    porArea[area].rendimento = porArea[area].sessoes > 0 
                        ? Math.round((porArea[area].rendimento / porArea[area].sessoes) * 100)
                        : 0;
                    porArea[area].tempoHoras = Math.round(porArea[area].tempo / 60);
                });
            }
            
            // Agrupar por tema (se n√£o filtrado por tema espec√≠fico)
            let porTema = {};
            if (!temaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema) {
                        const temaKey = `${tema.area} - ${tema.tema}`;
                        if (!porTema[temaKey]) {
                            porTema[temaKey] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porTema[temaKey].sessoes++;
                        porTema[temaKey].tempo += h.tempo || 0;
                        porTema[temaKey].rendimento += h.rendimento || 0;
                        
                        // Verificar campo questoes (formato string "15/20")
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porTema[temaKey].questoes.acertos += parseInt(match[1]);
                                porTema[temaKey].questoes.total += parseInt(match[2]);
                            }
                        }
                        // CORRE√á√ÉO: Tamb√©m considerar quantQuestoes e quantQuestoesAcertos se existirem
                        if (h.quantQuestoes && parseInt(h.quantQuestoes) > 0) {
                            porTema[temaKey].questoes.total += parseInt(h.quantQuestoes) || 0;
                            porTema[temaKey].questoes.acertos += parseInt(h.quantQuestoesAcertos) || 0;
                        }
                        
                        porTema[temaKey].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porTema).forEach(temaKey => {
                    porTema[temaKey].rendimento = porTema[temaKey].sessoes > 0 
                        ? Math.round((porTema[temaKey].rendimento / porTema[temaKey].sessoes) * 100)
                        : 0;
                    porTema[temaKey].tempoHoras = Math.round(porTema[temaKey].tempo / 60);
                });
            }
            
            // Renderizar resultados
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHoras}h${totalMinutosResto > 0 ? ' ' + totalMinutosResto + 'm' : ''}</div>
                        <div class="stat-label">Tempo Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoesTotal > 0 ? totalQuestoesAcertos + '/' + totalQuestoesTotal : '0'}</div>
                        <div class="stat-label">Quest√µes (${taxaAcertoQuestoes}% acerto)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalIntervalos}</div>
                        <div class="stat-label">Intervalos (${Math.round(tempoTotalIntervalos)} min)</div>
                    </div>
                </div>
            `;
            
            // Detalhamento por √°rea (com temas colaps√°veis)
            if (!areaFiltro && Object.keys(porArea).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìä Detalhamento por √Årea:</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th style="width: 30px;"></th><th>√Årea</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porArea).sort().forEach((area, index) => {
                    const stats = porArea[area];
                    const temasDaArea = Object.keys(porTema).filter(t => t.startsWith(area + ' - '));
                    
                    html += '<tr style="background: rgba(0,206,209,0.15); cursor: pointer;" onclick="toggleTemasArea(\'' + area.replace(/'/g, "\\'") + '\')">';
                    html += `<td style="text-align: center; color: var(--turquesa-light); font-weight: bold;">${temasDaArea.length > 0 ? '‚ñ∂' : ''}</td>`;
                    html += `<td><strong style="color: var(--turquesa-light);">${area}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                    
                    // Temas da √°rea (inicialmente ocultos)
                    if (temasDaArea.length > 0) {
                        html += `<tr id="temas-${area.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: none;">`;
                        html += '<td colspan="7" style="padding: 0; background: rgba(0,0,0,0.3);">';
                        html += '<table style="width: 100%; margin: 0;"><tbody>';
                        
                        temasDaArea.forEach(temaKey => {
                            const temaStats = porTema[temaKey];
                            const temaNome = temaKey.replace(area + ' - ', '');
                            html += '<tr style="border-top: 1px solid rgba(0,206,209,0.2);">';
                            html += `<td style="padding-left: 40px; color: rgba(0,206,209,0.8); font-weight: 500;">${temaNome}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.sessoes}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.tempoHoras}h</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.rendimento}%</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.questoes.total > 0 ? temaStats.questoes.acertos + '/' + temaStats.questoes.total + ' (' + Math.round((temaStats.questoes.acertos / temaStats.questoes.total) * 100) + '%)' : '-'}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.flashcards > 0 ? temaStats.flashcards.toLocaleString() : '-'}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></td></tr>';
                    }
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema (apenas quando filtrar por √°rea espec√≠fica)
            if (areaFiltro && !temaFiltro && Object.keys(porTema).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìö Temas da √Årea "' + areaFiltro + '":</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th>Tema</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porTema).filter(t => t.startsWith(areaFiltro + ' - ')).sort().forEach(temaKey => {
                    const stats = porTema[temaKey];
                    const temaNome = temaKey.replace(areaFiltro + ' - ', '');
                    html += '<tr>';
                    html += `<td><strong style="color: var(--turquesa-light);">${temaNome}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema quando filtrado por tema espec√≠fico (n√£o mostrar, j√° est√° no resumo geral)
            
            document.getElementById('analiseResultados').innerHTML = html;
            
            // Se an√°lises de tempo est√£o vis√≠veis, recalcular
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function filtrarAnaliseSemanaAtual() {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            
            document.getElementById('analiseDataInicio').value = inicioSemana.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimSemana.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function filtrarAnaliseMesAtual() {
            const hoje = obterDataBrasilia();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('analiseDataInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimMes.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function limparFiltrosAnalise() {
            document.getElementById('analiseFiltroArea').value = '';
            document.getElementById('analiseFiltroTema').value = '';
            document.getElementById('analiseDataInicio').value = '';
            document.getElementById('analiseDataFim').value = '';
            atualizarSelectsAnalise();
            atualizarAnalises();
        }
        
        // Fun√ß√£o para expandir/colapsar temas de uma √°rea
        function toggleTemasArea(area) {
            const areaId = 'temas-' + area.replace(/[^a-zA-Z0-9]/g, '-');
            const row = document.getElementById(areaId);
            if (!row) return;
            
            const isVisible = row.style.display !== 'none';
            row.style.display = isVisible ? 'none' : 'table-row';
            
            // Atualizar √≠cone
            const areaRow = row.previousElementSibling;
            if (areaRow) {
                const iconCell = areaRow.querySelector('td:first-child');
                if (iconCell) {
                    iconCell.textContent = isVisible ? '‚ñ∂' : '‚ñº';
                }
            }
        }
        
        // ==================== CRON√îMETRO DA SESS√ÉO ====================
        
        let cronometroInterval = null;
        let cronometroSegundos = 0;
        let cronometroRodando = false;
        let intervaloAtivo = false;
        let intervaloSegundos = 0;
        let intervaloInterval = null;
        let tempoTotalIntervalo = 0; // Tempo total de intervalo acumulado (n√£o conta no estudo)
        let cronometroInicioTimestamp = null; // Timestamp de quando o cron√¥metro foi iniciado (para rodar em segundo plano)
        let intervalosIndividuais = []; // Array para armazenar cada intervalo individualmente [{tempo: segundos, inicio: timestamp}, ...]
        let intervaloInicioTimestamp = null; // Timestamp de quando o intervalo atual come√ßou
        
        // Restaurar cron√¥metro do localStorage se existir
        function restaurarCronometro() {
            const salvo = localStorage.getItem('vrvs_cronometro');
            if (salvo) {
                try {
                    const dados = JSON.parse(salvo);
                    if (dados.timestamp) {
                        // Calcular tempo decorrido desde que foi salvo (BASEADO EM TIMESTAMP)
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - dados.timestamp) / 1000);
                        
                        // Atualizar valores
                        cronometroSegundos = dados.segundos + tempoDecorrido;
                        tempoTotalIntervalo = dados.tempoIntervalo || 0;
                        intervalosIndividuais = dados.intervalosIndividuais || []; // Restaurar intervalos individuais
                        intervaloInicioTimestamp = dados.intervaloInicioTimestamp || null;
                        
                        // Se estava em intervalo, restaurar estado do intervalo APENAS se n√£o foi encerrado
                        if (dados.intervaloAtivo && !dados.sessaoEncerrada) {
                            intervaloAtivo = true;
                            intervaloSegundos = dados.intervaloSegundos + tempoDecorrido;
                            document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                            document.getElementById('tempoIntervalo').style.display = 'block';
                            document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                            
                            // Reiniciar intervalo timer
                            if (intervaloInterval) {
                                clearInterval(intervaloInterval);
                            }
                            intervaloInicioTimestamp = dados.intervaloInicioTimestamp || Date.now();
                            intervaloInterval = setInterval(() => {
                                if (intervaloInicioTimestamp) {
                                    const agora = Date.now();
                                    intervaloSegundos = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                                } else {
                                    intervaloSegundos++;
                                }
                                document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                            }, 100);
                        } else {
                            // Garantir que intervalo est√° desativado se sess√£o foi encerrada
                            intervaloAtivo = false;
                            intervaloSegundos = 0;
                            intervaloInicioTimestamp = null;
                            if (intervaloInterval) {
                                clearInterval(intervaloInterval);
                                intervaloInterval = null;
                            }
                            document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                            document.getElementById('tempoIntervalo').style.display = 'none';
                        }
                        
                        // Se estava rodando, reiniciar contagem COM TIMESTAMP PRECISO
                        if (dados.rodando && !cronometroRodando) {
                            cronometroRodando = true;
                            cronometroInicioTimestamp = dados.timestamp; // Usar timestamp original
                            localStorage.setItem('vrvs_cronometro_timestamp', String(dados.timestamp));
                            localStorage.setItem('vrvs_cronometro_segundos', String(dados.segundos));
                            iniciarCronometroContagem();
                            document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                        }
                        
                        atualizarDisplayCronometro();
                    }
                } catch (e) {
                    console.log('Erro ao restaurar cron√¥metro:', e);
                }
            }
        }
        
        // Salvar estado do cron√¥metro
        function salvarEstadoCronometro() {
            if (cronometroRodando || intervaloAtivo) {
                // CR√çTICO: Salvar timestamp original, n√£o atualizar
                const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                
                localStorage.setItem('vrvs_cronometro', JSON.stringify({
                    rodando: cronometroRodando,
                    segundos: segundosOriginais ? parseInt(segundosOriginais) : cronometroSegundos,
                    timestamp: timestampOriginal ? parseInt(timestampOriginal) : cronometroInicioTimestamp || Date.now(),
                    tempoIntervalo: tempoTotalIntervalo,
                    intervaloAtivo: intervaloAtivo,
                    intervaloSegundos: intervaloSegundos,
                    intervalosIndividuais: intervalosIndividuais, // Salvar array de intervalos individuais
                    intervaloInicioTimestamp: intervaloInicioTimestamp,
                    sessaoEncerrada: false // Marcar que sess√£o n√£o foi encerrada
                }));
            } else {
                localStorage.removeItem('vrvs_cronometro');
            }
        }
        
        // Iniciar contagem do cron√¥metro
        function iniciarCronometroContagem() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            
            // CR√çTICO: Manter timestamp original se j√° existe, sen√£o criar novo
            let timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
            let segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
            
            if (!timestampOriginal) {
                // Primeira vez iniciando
                cronometroInicioTimestamp = Date.now();
                timestampOriginal = String(cronometroInicioTimestamp);
                segundosOriginais = String(cronometroSegundos);
            } else {
                // Continuando contagem - usar timestamp original
                cronometroInicioTimestamp = parseInt(timestampOriginal);
            }
            
            // Salvar no localStorage
            localStorage.setItem('vrvs_cronometro_timestamp', timestampOriginal);
            localStorage.setItem('vrvs_cronometro_segundos', segundosOriginais);
            
            // Atualizar display periodicamente (mas c√°lculo sempre baseado em timestamp)
            cronometroInterval = setInterval(() => {
                atualizarDisplayCronometro();
            }, 100); // Atualizar a cada 100ms para maior precis√£o visual
            
            cronometroRodando = true;
            salvarEstadoCronometro();
        }
        
        // Fun√ß√£o para calcular tempo decorrido baseado em timestamp (n√£o depende de intervalos)
        function calcularTempoDecorrido() {
            const timestampSalvo = localStorage.getItem('vrvs_cronometro_timestamp');
            const segundosSalvos = parseInt(localStorage.getItem('vrvs_cronometro_segundos') || '0');
            
            if (timestampSalvo && cronometroRodando) {
                const agora = Date.now();
                const tempoDecorrido = Math.floor((agora - parseInt(timestampSalvo)) / 1000);
                return segundosSalvos + tempoDecorrido;
            }
            return cronometroSegundos;
        }
        
        function formatarTempoCronometro(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }
        
        function atualizarDisplayCronometro() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando
            if (cronometroRodando) {
                cronometroSegundos = calcularTempoDecorrido();
            }
            
            document.getElementById('cronometroDisplay').textContent = formatarTempoCronometro(cronometroSegundos);
            // Atualizar display de tempo total de intervalo acumulado
            if (tempoTotalIntervalo > 0) {
                document.getElementById('tempoIntervaloTotal').style.display = 'block';
                document.getElementById('tempoIntervaloTotalDisplay').textContent = formatarTempoCronometro(tempoTotalIntervalo);
            } else {
                document.getElementById('tempoIntervaloTotal').style.display = 'none';
            }
        }
        
        // Fun√ß√µes GLOBAIS do cron√¥metro - FUNCIONAM GARANTIDAMENTE
        window.toggleCronometro = function() {
            if (intervaloAtivo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Termine o intervalo primeiro!', 'error');
                return;
            }
            
            if (cronometroRodando) {
                // Pausar - calcular tempo final baseado em timestamp
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                
                // Calcular tempo final preciso
                cronometroSegundos = calcularTempoDecorrido();
                
                cronometroRodando = false;
                cronometroInicioTimestamp = null;
                localStorage.removeItem('vrvs_cronometro_timestamp');
                
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                salvarEstadoCronometro();
                atualizarDisplayCronometro();
            } else {
                // Iniciar - salvar timestamp preciso
                cronometroInicioTimestamp = Date.now();
                localStorage.setItem('vrvs_cronometro_timestamp', String(cronometroInicioTimestamp));
                localStorage.setItem('vrvs_cronometro_segundos', String(cronometroSegundos));
                
                iniciarCronometroContagem();
                document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        };
        
        window.pausarCronometro = function() {
            if (cronometroRodando) {
                toggleCronometro();
            }
        };
        
        window.iniciarIntervalo = function() {
            if (!cronometroRodando && cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Inicie o cron√¥metro primeiro!', 'error');
                return;
            }
            
            if (intervaloAtivo) {
                // Finalizar intervalo - calcular tempo baseado em timestamp e salvar individualmente
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                // Calcular tempo preciso do intervalo baseado em timestamp
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                // Salvar intervalo individual
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal; // Acumular tempo de intervalo
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
                
                document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'none';
                atualizarDisplayCronometro(); // Atualizar display com tempo acumulado
                salvarEstadoCronometro(); // Salvar estado atualizado
                mostrarNotificacaoFeedback(`‚úÖ Intervalo finalizado (${formatarTempoCronometro(tempoIntervaloFinal)} - Total: ${formatarTempoCronometro(tempoTotalIntervalo)})`);
            } else {
                // Iniciar intervalo (pausa o cron√¥metro mas n√£o conta)
                intervaloAtivo = true;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = Date.now(); // Salvar timestamp de in√≠cio do intervalo
                
                document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'block';
                
                intervaloInterval = setInterval(() => {
                    // Calcular baseado em timestamp para maior precis√£o
                    if (intervaloInicioTimestamp) {
                        const agora = Date.now();
                        intervaloSegundos = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                    } else {
                        intervaloSegundos++;
                    }
                    document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                }, 100);
                
                // Pausar cron√¥metro durante intervalo
                if (cronometroRodando) {
                    clearInterval(cronometroInterval);
                    cronometroInterval = null;
                    cronometroRodando = false;
                    document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                }
                
                salvarEstadoCronometro(); // Salvar estado quando inicia intervalo
            }
        };
        
        window.resetCronometro = function() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
            }
            if (intervaloInterval) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
            }
            cronometroRodando = false;
            intervaloAtivo = false;
            cronometroSegundos = 0;
            intervaloSegundos = 0;
            tempoTotalIntervalo = 0; // Resetar tempo total de intervalo
            intervalosIndividuais = []; // Resetar array de intervalos individuais
            intervaloInicioTimestamp = null;
            cronometroInicioTimestamp = null;
            atualizarDisplayCronometro();
            document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
            document.getElementById('tempoIntervalo').style.display = 'none';
            localStorage.removeItem('vrvs_cronometro'); // Limpar do localStorage
            localStorage.removeItem('vrvs_cronometro_timestamp');
            localStorage.removeItem('vrvs_cronometro_segundos');
        }
        
        // Fun√ß√£o para encerrar sess√£o e mostrar modal
        window.encerrarSessao = function() {
            // FINALIZAR INTERVALO SE ESTIVER ATIVO (n√£o deixar rodando)
            if (intervaloAtivo) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal;
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
                
                document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'none';
            }
            
            // Salvar tempo final antes de zerar
            let tempoFinalSalvo = 0;
            
            // Parar cron√¥metro completamente se estiver rodando
            if (cronometroRodando) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                tempoFinalSalvo = calcularTempoDecorrido();
                cronometroRodando = false;
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            } else {
                tempoFinalSalvo = cronometroSegundos;
            }
            
            if (tempoFinalSalvo === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è O cron√¥metro n√£o est√° rodando!', 'error');
                return;
            }
            
            // Preencher dados do modal com o tempo salvo
            document.getElementById('modalTempoTotal').textContent = formatarTempoCronometro(tempoFinalSalvo);
            document.getElementById('modalNumIntervalos').textContent = intervalosIndividuais.length;
            document.getElementById('modalTempoIntervalos').textContent = formatarTempoCronometro(tempoTotalIntervalo);
            
            // Limpar campos do modal
            document.getElementById('modalTempoQuestoes').value = '';
            document.getElementById('modalQuantQuestoes').value = '';
            document.getElementById('modalTempoFlashcards').value = '';
            document.getElementById('modalQuantFlashcards').value = '';
            
            // ZERAR CRON√îMETRO COMPLETAMENTE ap√≥s salvar o tempo
            // Manter o tempo salvo em vari√°vel separada para uso no feedback
            const tempoParaFeedback = tempoFinalSalvo;
            const intervalosParaFeedback = tempoTotalIntervalo;
            
            // Zerar cron√¥metro completamente (n√£o continua rodando)
            cronometroSegundos = 0;
            tempoTotalIntervalo = 0;
            intervalosIndividuais = [];
            intervaloAtivo = false; // GARANTIR que intervalo est√° desativado
            intervaloSegundos = 0;
            intervaloInicioTimestamp = null;
            // Limpar timestamps e estado do cron√¥metro
            localStorage.removeItem('vrvs_cronometro');
            localStorage.removeItem('vrvs_cronometro_timestamp');
            localStorage.removeItem('vrvs_cronometro_segundos');
            
            // Atualizar display do cron√¥metro para mostrar 00:00:00
            document.getElementById('cronometroDisplay').textContent = '00:00:00';
            document.getElementById('tempoIntervaloTotal').style.display = 'none';
            document.getElementById('tempoIntervalo').style.display = 'none';
            
            // Guardar tempo salvo no modal para uso no feedback
            const modal = document.getElementById('encerrarSessaoModal');
            modal.dataset.tempoSalvo = tempoParaFeedback;
            modal.dataset.intervalosSalvos = intervalosParaFeedback;
            
            // Mostrar modal
            document.getElementById('encerrarSessaoModal').classList.add('active');
        }
        
        function closeEncerrarSessaoModal() {
            document.getElementById('encerrarSessaoModal').classList.remove('active');
        }
        
        function preencherDadosSessao() {
            const tempoQuestoes = parseInt(document.getElementById('modalTempoQuestoes').value) || 0;
            const quantQuestoes = parseInt(document.getElementById('modalQuantQuestoes').value) || 0;
            const tempoFlashcards = parseInt(document.getElementById('modalTempoFlashcards').value) || 0;
            const quantFlashcards = parseInt(document.getElementById('modalQuantFlashcards').value) || 0;
            
            // Preencher campos do formul√°rio
            const tempoTotal = tempoQuestoes + tempoFlashcards;
            if (tempoTotal > 0) {
                document.getElementById('feedbackTempo').value = tempoTotal;
            }
            
            // Preencher campos de tempo discretos (boxes discretos)
            const tempoQuestoesInput = document.getElementById('feedbackTempoQuestoes');
            const tempoFlashcardsInput = document.getElementById('feedbackTempoFlashcards');
            if (tempoQuestoesInput && tempoQuestoes > 0) {
                tempoQuestoesInput.value = tempoQuestoes;
            }
            if (tempoFlashcardsInput && tempoFlashcards > 0) {
                tempoFlashcardsInput.value = tempoFlashcards;
            }
            
            // Preencher quest√µes (formato: acertos/total)
            if (quantQuestoes > 0) {
                document.getElementById('feedbackQuestoes').value = quantQuestoes + '/' + quantQuestoes;
            }
            
            // Preencher flashcards
            if (quantFlashcards > 0) {
                document.getElementById('feedbackFlashcards').value = quantFlashcards;
            }
            
            // Preencher intervalo se houver
            const numeroIntervalos = intervalosIndividuais.length;
            if (numeroIntervalos > 0) {
                const temposIntervalos = intervalosIndividuais.map(i => formatarTempoCronometro(i.tempo)).join(', ');
                document.getElementById('feedbackNumeroIntervalos').value = numeroIntervalos;
                document.getElementById('feedbackIntervalos').value = temposIntervalos;
            }
            
            // Guardar valores no modal para uso posterior (atrav√©s de atributos data)
            const modal = document.getElementById('encerrarSessaoModal');
            modal.dataset.tempoQuestoes = tempoQuestoes;
            modal.dataset.quantQuestoes = quantQuestoes;
            modal.dataset.tempoFlashcards = tempoFlashcards;
            modal.dataset.quantFlashcards = quantFlashcards;
            
            // Fechar modal
            closeEncerrarSessaoModal();
            
            // Scroll para o formul√°rio
            setTimeout(() => {
                document.getElementById('feedbackForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        function obterTempoCronometroMinutos() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando (n√£o depende de intervalos)
            const segundosPrecisos = cronometroRodando ? calcularTempoDecorrido() : cronometroSegundos;
            return Math.floor(segundosPrecisos / 60);
        }
        
        function obterTempoIntervaloMinutos() {
            return Math.floor(tempoTotalIntervalo / 60);
        }
        
        // ==================== LEMBRETES E ANOTA√á√ïES ====================
        
        function calcularProximaDataLembrete(lembrete) {
            if (lembrete.periodicidade === 'pontual') {
                return null; // N√£o tem pr√≥xima data
            }
            
            const hoje = obterDataBrasilia();
            hoje.setHours(0, 0, 0, 0);
            const dataInicial = new Date(lembrete.dataInicial + 'T00:00:00');
            const ultimaData = lembrete.ultimaData ? new Date(lembrete.ultimaData + 'T00:00:00') : dataInicial;
            
            let proximaData = new Date(ultimaData);
            
            switch(lembrete.periodicidade) {
                case 'diaria':
                    proximaData.setDate(proximaData.getDate() + 1);
                    break;
                case 'semanal':
                    proximaData.setDate(proximaData.getDate() + 7);
                    break;
                case 'quinzenal':
                    proximaData.setDate(proximaData.getDate() + 15);
                    break;
                case 'mensal':
                    proximaData.setMonth(proximaData.getMonth() + 1);
                    break;
            }
            
            return proximaData.toISOString().split('T')[0];
        }
        
        function renderLembretes() {
            const container = document.getElementById('lembretesContainer');
            if (!container) return;
            
            const hoje = new Date().toISOString().split('T')[0];
            
            // Separar lembretes ativos e conclu√≠dos
            const lembretesAtivos = lembretes.filter(l => !l.concluido && (!l.proximaData || l.proximaData <= hoje));
            const lembretesFuturos = lembretes.filter(l => !l.concluido && l.proximaData && l.proximaData > hoje);
            const lembretesConcluidos = lembretes.filter(l => l.concluido);
            
            if (lembretes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìå</div><div>Nenhum lembrete cadastrado</div></div>';
                return;
            }
            
            let html = '';
            
            // Lembretes ativos (para hoje)
            if (lembretesAtivos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: var(--turquesa-light); margin-bottom: 10px;">üìå Para Hoje</h3>';
                html += lembretesAtivos.map(l => {
                    const proximaDataFormatada = l.proximaData ? formatarData(l.proximaData) : 'Pontual';
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade === 'pontual' ? 'Pontual' : l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.periodicidade !== 'pontual' ? `<button class="btn-edit" onclick="marcarLembreteConcluido(${l.id})" title="Marcar como conclu√≠do">‚úÖ</button>` : ''}
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes futuros
            if (lembretesFuturos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ Pr√≥ximos</h3>';
                html += lembretesFuturos.map(l => {
                    const proximaDataFormatada = formatarData(l.proximaData);
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes conclu√≠dos (opcional, pode ser ocultado)
            if (lembretesConcluidos.length > 0 && false) { // Desabilitado por enquanto
                html += '<div><h3 style="color: rgba(255,255,255,0.3); margin-bottom: 10px;">‚úÖ Conclu√≠dos</h3>';
                html += lembretesConcluidos.map(l => {
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.5;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="text-decoration: line-through; color: rgba(255,255,255,0.3);">${l.titulo}</div>
                                </div>
                                <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function marcarLembreteConcluido(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            
            if (lembrete.periodicidade === 'pontual') {
                lembrete.concluido = true;
            } else {
                // Atualizar √∫ltima data e calcular pr√≥xima
                const hoje = obterDataBrasiliaString();
                lembrete.ultimaData = hoje;
                lembrete.proximaData = calcularProximaDataLembrete(lembrete);
            }
            
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('‚úÖ Lembrete atualizado!');
        }
        
        function deletarLembrete(id) {
            if (!confirm('Tem certeza que deseja deletar este lembrete?')) return;
            
            lembretes = lembretes.filter(l => l.id !== id);
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('üóëÔ∏è Lembrete deletado!');
        }
        
        // ==================== CADERNO DE ANOTA√á√ïES ====================
        
        function obterOuCriarAnotacao(temaId) {
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (!anotacao) {
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) return null;
                
                anotacao = {
                    id: Date.now(),
                    temaId: temaId,
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    ultimaAtualizacao: obterDataBrasiliaString()
                };
                anotacoes.push(anotacao);
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            }
            return anotacao;
        }
        
        function navegarParaAnotacao(temaId) {
            // Criar anota√ß√£o se n√£o existir
            obterOuCriarAnotacao(temaId);
            
            // Encontrar a √°rea do tema
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            // Filtrar caderno para mostrar apenas este tema
            document.getElementById('cadernoFiltroArea').value = tema.area;
            atualizarSelectTemaPorArea(); // Atualizar select de tema
            document.getElementById('cadernoFiltroTema').value = String(temaId);
            
            // Mostrar se√ß√£o caderno
            showSection('caderno');
            
            // Scroll para anota√ß√£o
            setTimeout(() => {
                const elemento = document.querySelector(`[data-tema-id="${temaId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    elemento.style.background = 'rgba(0,206,209,0.2)';
                    setTimeout(() => {
                        elemento.style.background = '';
                    }, 2000);
                }
            }, 100);
        }
        
        function atualizarSelectsLembrete() {
            const select = document.getElementById('lembreteTemaId');
            if (!select) return;
            
            select.innerHTML = '<option value="">Nenhum (lembrete geral)</option>';
            
            dados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.area} - ${t.tema}`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectsCaderno() {
            const selectArea = document.getElementById('cadernoFiltroArea');
            const selectTema = document.getElementById('cadernoFiltroTema');
            
            if (selectArea) {
                const areas = [...new Set(dados.map(t => t.area))].sort();
                selectArea.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    selectArea.appendChild(option);
                });
            }
            
            // Resetar select de tema para desabilitado
            if (selectTema) {
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
            }
        }
        
        function atualizarSelectTemaPorArea() {
            const selectTema = document.getElementById('cadernoFiltroTema');
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            if (!selectTema) return;
            
            if (!filtroArea) {
                // Se n√£o h√° √°rea selecionada, desabilitar select de tema
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
                return;
            }
            
            // Habilitar e popular com temas da √°rea selecionada
            selectTema.disabled = false;
            selectTema.innerHTML = '<option value="">Todos os temas desta √°rea</option>';
            
            const temasFiltrados = dados.filter(t => t.area === filtroArea);
            
            temasFiltrados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.tema; // Mostrar apenas o nome do tema, sem repetir √°rea
                selectTema.appendChild(option);
            });
        }
        
        function filtrarCaderno() {
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            
            renderCaderno(filtroArea, filtroTema);
        }
        
        function renderCaderno(filtroArea = '', filtroTema = '') {
            const container = document.getElementById('cadernoContainer');
            if (!container) return;
            
            // Se n√£o houver tema selecionado, mostrar mensagem para selecionar
            if (!filtroTema) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Selecione uma √°rea e um tema para visualizar as anota√ß√µes</div></div>';
                return;
            }
            
            // Garantir que o tema selecionado tenha anota√ß√£o
            const tema = dados.find(t => String(t.id) === String(filtroTema));
            if (!tema) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Tema n√£o encontrado</div></div>';
                return;
            }
            
            const anotacao = obterOuCriarAnotacao(tema.id);
            
            // Renderizar apenas o tema selecionado
            const html = `
                <div class="task-item" style="margin-bottom: 20px;" data-tema-id="${anotacao.temaId}">
                    <div style="margin-bottom: 10px;">
                        <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                            üìö ${tema.area} - üìù ${anotacao.tema}
                        </div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.6); margin-bottom: 10px;">
                            √öltima atualiza√ß√£o: ${formatarData(anotacao.ultimaAtualizacao)}
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <textarea 
                            id="anotacao_${anotacao.temaId}" 
                            class="form-input" 
                            rows="10" 
                            style="width: 100%; font-family: inherit; resize: vertical;"
                            placeholder="Digite suas anota√ß√µes aqui..."
                            onblur="salvarAnotacao(${anotacao.temaId})"
                        >${anotacao.conteudo || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-edit" onclick="salvarAnotacao(${anotacao.temaId})" title="Salvar">üíæ</button>
                        <button class="btn-edit" onclick="limparAnotacao(${anotacao.temaId})" title="Limpar">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function salvarAnotacao(temaId) {
            const textarea = document.getElementById(`anotacao_${temaId}`);
            if (!textarea) return;
            
            const anotacao = obterOuCriarAnotacao(temaId);
            if (!anotacao) return;
            
            anotacao.conteudo = textarea.value.trim();
            anotacao.ultimaAtualizacao = obterDataBrasiliaString();
            
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
            
            // Atualizar renderiza√ß√£o
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            renderCaderno(filtroArea, filtroTema);
        }
        
        function limparAnotacao(temaId) {
            if (!confirm('Tem certeza que deseja limpar esta anota√ß√£o?')) return;
            
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (anotacao) {
                anotacao.conteudo = '';
                anotacao.ultimaAtualizacao = obterDataBrasiliaString();
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                const textarea = document.getElementById(`anotacao_${temaId}`);
                if (textarea) textarea.value = '';
                
                mostrarNotificacaoFeedback('üóëÔ∏è Anota√ß√£o limpa!');
                
                const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
                const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
                renderCaderno(filtroArea, filtroTema);
            }
        }
        
        // ==================== INICIALIZA√á√ÉO ====================
        
        // Garantir carregamento da logo no MacBook
        function garantirLogoCarregada() {
            const logoImg = document.querySelector('.splash-logo');
            if (!logoImg) return;
            
            // For√ßar recarregamento com timestamp √∫nico para evitar cache
            const timestamp = new Date().getTime();
            const logoPath = './logo.png?v=' + timestamp;
            const logoFallback = './logo.jpeg?v=' + timestamp;
            
            // Criar nova imagem para testar
            const testImg = new Image();
            testImg.onload = function() {
                logoImg.src = logoPath;
            };
            testImg.onerror = function() {
                // Tentar fallback
                const testFallback = new Image();
                testFallback.onload = function() {
                    logoImg.src = logoFallback;
                };
                testFallback.onerror = function() {
                    console.warn('Logo n√£o encontrada, usando fallback');
                };
                testFallback.src = logoFallback;
            };
            testImg.src = logoPath;
        }
        
        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', garantirLogoCarregada);
        } else {
            garantirLogoCarregada();
        }
        
        // ==================== SISTEMA DE TUTORIAL E AJUDA ====================
        
        const passosTutorial = [
            {
                titulo: "üéØ Bem-vindo ao VRVS!",
                conteudo: `
                    <p style="margin-bottom: 15px; color: #FDF6E3 !important;">Ol√°! Este √© o <strong style="color: #FDF6E3 !important;">VRVS</strong> - seu sistema de gest√£o de estudos.</p>
                    <p style="margin-bottom: 15px; color: #FDF6E3 !important;">Vou te mostrar rapidamente como usar cada funcionalidade.</p>
                    <p style="color: #B58900 !important;">üì± Dica: Voc√™ pode instalar como app no seu celular!</p>
                `
            },
            {
                titulo: "üìä Banco de Dados",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Aqui voc√™:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">‚úÖ Adiciona novos temas para estudar</li>
                        <li style="color: #FDF6E3 !important;">‚úÖ Define √°rea, status e prioridade</li>
                        <li style="color: #FDF6E3 !important;">‚úÖ Visualiza todos seus temas</li>
                        <li style="color: #FDF6E3 !important;">‚úÖ Edita ou remove temas</li>
                    </ul>
                    <p style="margin-top: 15px; color: #B58900 !important;">√â a base de tudo!</p>
                `
            },
            {
                titulo: "üìã Miss√µes do Dia",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Tarefas de hoje e atrasadas:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">üéØ Mostra o que voc√™ precisa estudar HOJE</li>
                        <li style="color: #FDF6E3 !important;">‚è±Ô∏è Op√ß√£o de registrar tempo por atividade</li>
                        <li style="color: #FDF6E3 !important;">üí° Diretrizes personalizadas para cada tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìÖ Agenda",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Timeline dos pr√≥ximos dias:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">üìÜ Filtre por per√≠odo (semana, m√™s)</li>
                        <li style="color: #FDF6E3 !important;">üîç Visualize o que vem pela frente</li>
                        <li style="color: #FDF6E3 !important;">üìå Organize suas revis√µes</li>
                    </ul>
                `
            },
            {
                titulo: "üí¨ Feedback de Sess√£o",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Registre cada sess√£o de estudos:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">‚è±Ô∏è Use o cron√¥metro integrado</li>
                        <li style="color: #FDF6E3 !important;">üìä Avalie seu rendimento</li>
                        <li style="color: #FDF6E3 !important;">‚ùì Registre quest√µes e flashcards</li>
                        <li style="color: #FDF6E3 !important;">üìù Adicione observa√ß√µes</li>
                    </ul>
                    <p style="margin-top: 15px; color: #B58900 !important;">Todos os dados s√£o salvos automaticamente!</p>
                `
            },
            {
                titulo: "üìà Estat√≠sticas e An√°lises",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Acompanhe seu progresso:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">üìä Gr√°ficos de performance</li>
                        <li style="color: #FDF6E3 !important;">‚è±Ô∏è An√°lises de tempo (opcional)</li>
                        <li style="color: #FDF6E3 !important;">üìâ Identifica√ß√£o de pontos fracos</li>
                        <li style="color: #FDF6E3 !important;">üéØ M√©tricas por √°rea e tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìå Extras e Backup",
                conteudo: `
                    <p style="margin-bottom: 10px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Outras funcionalidades:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">üìå Lembretes personalizados</li>
                        <li style="color: #FDF6E3 !important;">üìî Caderno de anota√ß√µes</li>
                        <li style="color: #FDF6E3 !important;">üì§ Exportar dados (CSV)</li>
                        <li style="color: #FDF6E3 !important;">üì• Importar dados</li>
                    </ul>
                    <p style="margin-top: 15px; color: #B58900 !important;">üíæ Tudo √© salvo localmente no seu navegador!</p>
                `
            },
            {
                titulo: "‚úÖ Pronto para come√ßar!",
                conteudo: `
                    <p style="margin-bottom: 15px; color: #FDF6E3 !important;">Agora voc√™ conhece todas as funcionalidades!</p>
                    <p style="margin-bottom: 15px; color: #FDF6E3 !important;"><strong style="color: #FDF6E3 !important;">Pr√≥ximos passos:</strong></p>
                    <ol style="margin-left: 20px; line-height: 1.8; color: #FDF6E3 !important;">
                        <li style="color: #FDF6E3 !important;">Adicione seus primeiros temas na aba "Dados"</li>
                        <li style="color: #FDF6E3 !important;">Configure a agenda</li>
                        <li style="color: #FDF6E3 !important;">Comece a estudar e registre suas sess√µes</li>
                    </ol>
                    <p style="margin-top: 15px; color: #B58900 !important;">‚ùì D√∫vidas? Use o bot√£o de ajuda no canto da tela!</p>
                `
            }
        ];
        
        let passoAtual = 0;
        
        function iniciarTutorial() {
            passoAtual = 0;
            mostrarPassoTutorial();
            document.getElementById('tutorialModal').style.display = 'flex';
        }
        
        function mostrarPassoTutorial() {
            const passo = passosTutorial[passoAtual];
            document.getElementById('tutorialTitulo').textContent = passo.titulo;
            document.getElementById('tutorialConteudo').innerHTML = passo.conteudo;
            document.getElementById('tutorialProgresso').textContent = `Passo ${passoAtual + 1} de ${passosTutorial.length}`;
            
            // Atualizar bot√µes
            document.getElementById('btnAnterior').style.display = passoAtual === 0 ? 'none' : 'block';
            document.getElementById('btnProximo').textContent = passoAtual === passosTutorial.length - 1 ? 'Finalizar ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function tutorialProximo() {
            if (passoAtual < passosTutorial.length - 1) {
                passoAtual++;
                mostrarPassoTutorial();
            } else {
                finalizarTutorial();
            }
        }
        
        function tutorialAnterior() {
            if (passoAtual > 0) {
                passoAtual--;
                mostrarPassoTutorial();
            }
        }
        
        function pularTutorial() {
            if (confirm('Tem certeza que deseja pular o tutorial?')) {
                finalizarTutorial();
            }
        }
        
        function fecharTutorial() {
            finalizarTutorial();
        }
        
        function finalizarTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            localStorage.setItem('vrvs_tutorial_completo', 'true');
        }
        
        // ==================== BOX DE D√öVIDAS FLUTUANTE ====================
        
        function mostrarMenuDuvidas() {
            const menu = document.getElementById('menuDuvidas');
            menu.style.display = 'block';
        }
        
        function fecharMenuDuvidas() {
            const menu = document.getElementById('menuDuvidas');
            const btn = document.getElementById('btnAbrirDuvidas');
            
            menu.style.display = 'none';
            btn.style.display = 'none';
            
            // Salvar prefer√™ncia do usu√°rio
            localStorage.setItem('vrvs_botao_duvidas_fechado', 'true');
            
            // Mostrar pop-up informativo
            mostrarNotificacaoFeedback('üí° Dica: Qualquer d√∫vida pode ser encontrada na aba ‚ùì Tutorial!', 4000);
        }
        
        function abrirBoxDuvidas() {
            const box = document.getElementById('boxDuvidas');
            const menu = document.getElementById('menuDuvidas');
            
            // Fechar menu
            menu.style.display = 'none';
            
            // Abrir box
            box.style.display = 'block';
        }
        
        function fecharBoxDuvidas() {
            const box = document.getElementById('boxDuvidas');
            const btn = document.getElementById('btnAbrirDuvidas');
            
            // Mostrar pop-up informativo
            mostrarNotificacaoFeedback('üí° Dica: Qualquer d√∫vida pode ser encontrada na aba ‚ùì Tutorial!', 4000);
            
            box.style.display = 'none';
            
            // Se o bot√£o n√£o foi fechado permanentemente, mostrar novamente
            const botaoFechado = localStorage.getItem('vrvs_botao_duvidas_fechado');
            if (botaoFechado !== 'true') {
                btn.style.display = 'block';
            }
        }
        
        function responderDuvidaBox() {
            const pergunta = document.getElementById('perguntaBoxDuvidas').value.toLowerCase();
            let resposta = '';
            
            // Sistema simples de palavras-chave (mesma l√≥gica do responderDuvida)
            if (pergunta.includes('adicionar') || pergunta.includes('novo') || pergunta.includes('criar') || pergunta.includes('tema')) {
                resposta = faqRespostas.adicionar.texto;
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registrar') || pergunta.includes('cron√¥metro')) {
                resposta = faqRespostas.feedback.texto;
            } else if (pergunta.includes('agenda') || pergunta.includes('timeline') || pergunta.includes('pr√≥xim')) {
                resposta = faqRespostas.agenda.texto;
            } else if (pergunta.includes('estat√≠stica') || pergunta.includes('gr√°fico') || pergunta.includes('an√°lise') || pergunta.includes('performance')) {
                resposta = faqRespostas.stats.texto;
            } else if (pergunta.includes('backup') || pergunta.includes('exportar') || pergunta.includes('salvar') || pergunta.includes('perder')) {
                resposta = faqRespostas.backup.texto;
            } else if (pergunta.includes('tempo') || pergunta.includes('quest√µes') || pergunta.includes('flashcard')) {
                resposta = `
                    <strong>Registrando tempo por atividade:</strong><br><br>
                    1. Na aba <strong>üìã Miss√µes</strong> ou <strong>üìÖ Agenda</strong><br>
                    2. Clique no bot√£o <strong>‚è±Ô∏è Mostrar Tempos</strong><br>
                    3. Preencha os campos opcionais de cada tema<br>
                    4. Os dados ser√£o inclu√≠dos nas an√°lises<br><br>
                    Voc√™ tamb√©m pode registrar no Feedback de Sess√£o!
                `;
            } else if (pergunta.includes('como') || pergunta.includes('usar') || pergunta.includes('funciona')) {
                resposta = `
                    <strong>N√£o encontrei uma resposta espec√≠fica.</strong><br><br>
                    Tente uma destas op√ß√µes:<br>
                    ‚Ä¢ Clique nos bot√µes de perguntas frequentes<br>
                    ‚Ä¢ Inicie o <strong>Tour Guiado</strong> na aba Tutorial<br>
                    ‚Ä¢ Seja mais espec√≠fico na pergunta<br><br>
                    <strong>Exemplos:</strong><br>
                    "Como adicionar tema?"<br>
                    "Como fazer backup?"<br>
                    "Como ver estat√≠sticas?"
                `;
            } else {
                resposta = `
                    <strong>Desculpe, n√£o entendi sua d√∫vida.</strong><br><br>
                    Clique em uma das <strong>Perguntas Frequentes</strong> ou<br>
                    inicie o <strong>üöÄ Tour Guiado</strong> na aba Tutorial!
                `;
            }
            
            // Mostrar resposta em um alerta ou abrir a aba tutorial
            mostrarNotificacaoFeedback('üí° ' + resposta.replace(/<[^>]*>/g, '').substring(0, 100) + '...', 5000);
            showSection('tutorial');
        }
        
        // Enter para buscar resposta no box
        document.addEventListener('DOMContentLoaded', function() {
            const inputBoxDuvidas = document.getElementById('perguntaBoxDuvidas');
            if (inputBoxDuvidas) {
                inputBoxDuvidas.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        responderDuvidaBox();
                    }
                });
            }
            
            // Verificar se o usu√°rio j√° fechou o box antes
            const boxFechado = localStorage.getItem('vrvs_box_duvidas_fechado');
            if (boxFechado === 'true') {
                document.getElementById('boxDuvidas').style.display = 'none';
                document.getElementById('btnAbrirDuvidas').style.display = 'block';
            }
            
            // Verificar se o bot√£o foi fechado permanentemente
            const botaoFechado = localStorage.getItem('vrvs_botao_duvidas_fechado');
            if (botaoFechado === 'true') {
                document.getElementById('btnAbrirDuvidas').style.display = 'none';
                document.getElementById('menuDuvidas').style.display = 'none';
            }
            
            // Fechar menu ao clicar fora dele
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('menuDuvidas');
                const btn = document.getElementById('btnAbrirDuvidas');
                
                if (menu && menu.style.display === 'block') {
                    if (!menu.contains(event.target) && !btn.contains(event.target)) {
                        menu.style.display = 'none';
                    }
                }
            });
        });
        
        // ==================== FAQ INTELIGENTE ====================
        
        const faqRespostas = {
            adicionar: {
                titulo: "Como adicionar um tema?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üìä Dados</strong><br>
                    2. Preencha o formul√°rio no topo:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea (ex: Ortopedia)<br>
                       &nbsp;&nbsp;‚Ä¢ Tema (ex: Fraturas do √∫mero)<br>
                       &nbsp;&nbsp;‚Ä¢ Status, Prioridade, Data<br>
                    3. Clique em <strong>üíæ SALVAR</strong><br><br>
                    Pronto! O tema aparecer√° na tabela abaixo.
                `
            },
            feedback: {
                titulo: "Como registrar uma sess√£o?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üí¨ Feedback</strong><br>
                    2. Use o <strong>‚è±Ô∏è Cron√¥metro</strong> durante o estudo<br>
                    3. Ao terminar, clique em <strong>Encerrar Sess√£o</strong><br>
                    4. Preencha:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea e Tema estudado<br>
                       &nbsp;&nbsp;‚Ä¢ Tempo, rendimento<br>
                       &nbsp;&nbsp;‚Ä¢ Quest√µes e flashcards<br>
                       &nbsp;&nbsp;‚Ä¢ Observa√ß√µes<br>
                    5. Clique em <strong>SALVAR FEEDBACK</strong><br><br>
                    Seus dados s√£o salvos automaticamente!
                `
            },
            agenda: {
                titulo: "Como usar a agenda?",
                texto: `
                    <strong>A agenda mostra suas pr√≥ximas revis√µes:</strong><br><br>
                    ‚Ä¢ Filtre por per√≠odo usando os campos de data<br>
                    ‚Ä¢ Clique em <strong>Semana Atual</strong> para ver os pr√≥ximos 7 dias<br>
                    ‚Ä¢ Cada tema mostra: √°rea, prioridade, rendimento<br>
                    ‚Ä¢ A data de agenda √© definida ao adicionar/editar o tema<br><br>
                    <strong>Dica:</strong> Use para planejar sua semana de estudos!
                `
            },
            stats: {
                titulo: "Como ver estat√≠sticas?",
                texto: `
                    <strong>V√°rias formas de analisar seus dados:</strong><br><br>
                    üìà <strong>Aba Gr√°ficos:</strong> Visualiza√ß√µes gerais<br>
                    üîç <strong>Aba An√°lises:</strong> Dados detalhados por √°rea/tema<br>
                    ‚è±Ô∏è <strong>An√°lises de Tempo:</strong> Clique no bot√£o para mostrar<br>
                    üìú <strong>Aba Hist√≥rico:</strong> Todas as sess√µes registradas<br><br>
                    Use os filtros para focar em per√≠odos espec√≠ficos!
                `
            },
            backup: {
                titulo: "Como fazer backup?",
                texto: `
                    <strong>Seus dados j√° s√£o salvos automaticamente!</strong><br><br>
                    Mas voc√™ pode fazer backup extra:<br><br>
                    1. V√° para a aba <strong>üì§ Exportar</strong><br>
                    2. Clique em <strong>üìä Baixar DADOS.csv</strong><br>
                    3. Ou <strong>üìú Baixar HISTORICO.csv</strong><br><br>
                    Os arquivos CSV podem ser abertos no Excel ou Google Sheets.<br><br>
                    <strong>Importante:</strong> Dados ficam no navegador. Se limpar cache, pode perder tudo!
                `
            }
        };
        
        function mostrarResposta(tipo) {
            const resposta = faqRespostas[tipo];
            document.getElementById('perguntaAssistente').value = resposta.titulo;
            document.getElementById('textoResposta').innerHTML = resposta.texto;
            document.getElementById('respostaAssistente').style.display = 'block';
            
            // Scroll suave at√© a resposta
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function responderDuvida() {
            const pergunta = document.getElementById('perguntaAssistente').value.toLowerCase();
            let resposta = '';
            
            // Sistema simples de palavras-chave
            if (pergunta.includes('adicionar') || pergunta.includes('novo') || pergunta.includes('criar') || pergunta.includes('tema')) {
                resposta = faqRespostas.adicionar.texto;
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registrar') || pergunta.includes('cron√¥metro')) {
                resposta = faqRespostas.feedback.texto;
            } else if (pergunta.includes('agenda') || pergunta.includes('timeline') || pergunta.includes('pr√≥xim')) {
                resposta = faqRespostas.agenda.texto;
            } else if (pergunta.includes('estat√≠stica') || pergunta.includes('gr√°fico') || pergunta.includes('an√°lise') || pergunta.includes('performance')) {
                resposta = faqRespostas.stats.texto;
            } else if (pergunta.includes('backup') || pergunta.includes('exportar') || pergunta.includes('salvar') || pergunta.includes('perder')) {
                resposta = faqRespostas.backup.texto;
            } else if (pergunta.includes('tempo') || pergunta.includes('quest√µes') || pergunta.includes('flashcard')) {
                resposta = `
                    <strong>Registrando tempo por atividade:</strong><br><br>
                    1. Na aba <strong>üìã Miss√µes</strong> ou <strong>üìÖ Agenda</strong><br>
                    2. Clique no bot√£o <strong>‚è±Ô∏è Mostrar Tempos</strong><br>
                    3. Preencha os campos opcionais de cada tema<br>
                    4. Os dados ser√£o inclu√≠dos nas an√°lises<br><br>
                    Voc√™ tamb√©m pode registrar no Feedback de Sess√£o!
                `;
            } else if (pergunta.includes('como') || pergunta.includes('usar') || pergunta.includes('funciona')) {
                resposta = `
                    <strong>N√£o encontrei uma resposta espec√≠fica.</strong><br><br>
                    Tente uma destas op√ß√µes:<br>
                    ‚Ä¢ Clique nos bot√µes de perguntas frequentes acima<br>
                    ‚Ä¢ Inicie o <strong>Tour Guiado</strong> no topo da p√°gina<br>
                    ‚Ä¢ Seja mais espec√≠fico na pergunta<br><br>
                    <strong>Exemplos de perguntas:</strong><br>
                    "Como adicionar tema?"<br>
                    "Como fazer backup?"<br>
                    "Como ver estat√≠sticas?"
                `;
            } else {
                resposta = `
                    <strong>Desculpe, n√£o entendi sua d√∫vida.</strong><br><br>
                    Clique em uma das <strong>Perguntas Frequentes</strong> acima ou<br>
                    inicie o <strong>üöÄ Tour Guiado</strong> para conhecer a plataforma!
                `;
            }
            
            document.getElementById('textoResposta').innerHTML = resposta;
            document.getElementById('respostaAssistente').style.display = 'block';
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Enter para buscar resposta
        document.addEventListener('DOMContentLoaded', function() {
            const inputPergunta = document.getElementById('perguntaAssistente');
            if (inputPergunta) {
                inputPergunta.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        responderDuvida();
                    }
                });
            }
        });
        
        // ==================== WINDOW ONLOAD ====================
        
        // FUN√á√ÉO DE LIMPEZA AGRESSIVA DE DADOS INCONSISTENTES (executa no carregamento)
        function limparDadosInconsistentes() {
            console.log('üîç [MACBOOK FIX] Iniciando limpeza de dados inconsistentes...');
            
            // VERIFICAR SE H√Å DADOS NO LOCALSTORAGE
            const dadosRaw = localStorage.getItem('vrvs_dados');
            console.log(`üîç [MACBOOK DEBUG] localStorage.getItem('vrvs_dados'):`, {
                existe: dadosRaw !== null,
                tamanho: dadosRaw ? dadosRaw.length : 0,
                preview: dadosRaw ? dadosRaw.substring(0, 200) : 'null'
            });
            
            dados = JSON.parse(dadosRaw || '[]');
            
            console.log(`üîç [MACBOOK DEBUG] Dados parseados:`, {
                isArray: Array.isArray(dados),
                length: dados.length,
                primeiroItem: dados.length > 0 ? dados[0] : null
            });
            
            if (!Array.isArray(dados)) {
                console.error('‚ùå [MACBOOK FIX] Dados n√£o s√£o um array');
                dados = [];
                return;
            }
            
            if (dados.length === 0) {
                console.warn('‚ö†Ô∏è [MACBOOK FIX] localStorage est√° VAZIO! N√£o h√° dados para limpar.');
                console.log('üí° [MACBOOK FIX] Dica: Os dados precisam ser importados ou criados neste navegador.');
                return;
            }
            
            let corrigidos = 0;
            dados.forEach((t, index) => {
                const sessoesZero = (t.sessoes === 0 || !t.sessoes || t.sessoes === '0');
                const temRendimentoInvalido = (t.rendimento && t.rendimento > 0);
                
                if (sessoesZero && temRendimentoInvalido) {
                    console.log(`üîß [MACBOOK FIX] Limpeza inicial - Corrigindo: ${t.tema}`, {
                        sessoes: t.sessoes,
                        status: t.status,
                        rendimento: t.rendimento
                    });
                    t.rendimento = 0;
                    corrigidos++;
                }
            });
            
            if (corrigidos > 0) {
                console.log(`üíæ [MACBOOK FIX] Limpeza inicial - ${corrigidos} temas corrigidos, salvando...`);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                window.dados = dados;
            } else {
                console.log('‚úÖ [MACBOOK FIX] Limpeza inicial - Nenhum dado inconsistente encontrado');
            }
        }
        
        window.onload = function() {
            // LIMPEZA INICIAL ANTES DE QUALQUER COISA
            limparDadosInconsistentes();
            
            // Garantir logo novamente ap√≥s carregamento completo
            garantirLogoCarregada();
            
            // Restaurar cron√¥metro se estava rodando antes
            restaurarCronometro();
            
            // Verificar se √© primeira vez e mostrar tutorial
            const tutorialCompleto = localStorage.getItem('vrvs_tutorial_completo');
            if (!tutorialCompleto) {
                setTimeout(() => {
                    if (confirm('üëã Primeira vez aqui? Gostaria de fazer um tour r√°pido pela plataforma?')) {
                        iniciarTutorial();
                    } else {
                        localStorage.setItem('vrvs_tutorial_completo', 'true');
                    }
                }, 1000);
            }
            
            // Page Visibility API - Detectar quando aba sai/volta ao foco
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Aba saiu de foco - salvar estado atual (funciona offline)
                    if (cronometroRodando || intervaloAtivo) {
                        salvarEstadoCronometro();
                        console.log('üì± Aba em segundo plano - cron√¥metro continua contando');
                    }
                } else {
                    // Aba voltou ao foco - atualizar dados do localStorage (fix para iOS)
                    dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                    if (Array.isArray(dados)) {
                        dados = dados.map(d => {
                            try {
                                const corrigido = fixAreaTemaObjeto(d);
                                const { area, tema } = fixAreaTema(corrigido.area || '', corrigido.tema || '');
                                corrigido.area = area;
                                corrigido.tema = tema;
                                return corrigido;
                            } catch (e) {
                                return d;
                            }
                        }).filter(d => d && d.tema && d.tema.trim() !== '');
                    }
                    historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
                    
                    // Atualizar vari√°vel global
                    window.dados = dados;
                    
                    // Se estiver na aba dados, atualizar a visualiza√ß√£o
                    const abaAtiva = document.querySelector('.section.active');
                    if (abaAtiva && abaAtiva.id === 'dados') {
                        renderDados();
                    }
                    // Se estiver na aba feedback, atualizar selects
                    if (abaAtiva && abaAtiva.id === 'feedback') {
                        updateFeedbackSelect();
                    }
                    
                    // Restaurar e calcular tempo decorrido BASEADO EM TIMESTAMP ORIGINAL
                    const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                    const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                    
                    if (timestampOriginal && segundosOriginais) {
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - parseInt(timestampOriginal)) / 1000);
                        
                        // Atualizar cron√¥metro principal baseado no timestamp original
                        cronometroSegundos = parseInt(segundosOriginais) + tempoDecorrido;
                        
                        // Restaurar outros dados
                        const salvo = localStorage.getItem('vrvs_cronometro');
                        if (salvo) {
                            try {
                                const dados = JSON.parse(salvo);
                                tempoTotalIntervalo = dados.tempoIntervalo || 0;
                                
                                // Se estava em intervalo, atualizar intervalo tamb√©m
                                if (dados.intervaloAtivo) {
                                    intervaloAtivo = true;
                                    const intervaloOriginal = dados.intervaloSegundos || 0;
                                    intervaloSegundos = intervaloOriginal + tempoDecorrido;
                                    
                                    // Reiniciar timer do intervalo se necess√°rio
                                    if (intervaloInterval) {
                                        clearInterval(intervaloInterval);
                                    }
                                    intervaloInterval = setInterval(() => {
                                        // Calcular baseado em timestamp para intervalo tamb√©m
                                        const agoraIntervalo = Date.now();
                                        const tempoDecorridoIntervalo = Math.floor((agoraIntervalo - parseInt(timestampOriginal)) / 1000);
                                        intervaloSegundos = intervaloOriginal + tempoDecorridoIntervalo;
                                        document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                                    }, 100);
                                    
                                    document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                                    document.getElementById('tempoIntervalo').style.display = 'block';
                                    document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                                }
                                
                                // Se estava rodando, garantir que continue rodando
                                if (dados.rodando && !cronometroRodando) {
                                    cronometroInicioTimestamp = parseInt(timestampOriginal);
                                    iniciarCronometroContagem();
                                    document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                                } else if (dados.rodando && cronometroRodando) {
                                    // J√° est√° rodando, apenas atualizar display
                                    atualizarDisplayCronometro();
                                }
                                
                                console.log('üì± Aba voltou ao foco - cron√¥metro atualizado (+' + tempoDecorrido + 's)');
                            } catch (e) {
                                console.log('Erro ao restaurar:', e);
                            }
                        }
                    }
                }
            });
            
            // Tamb√©m salvar antes de fechar a p√°gina
            window.addEventListener('beforeunload', function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            });
            
            // Salvar periodicamente enquanto est√° rodando (a cada 30 segundos)
            setInterval(function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            }, 30000); // Salvar a cada 30 segundos
            
            // Registrar Service Worker para funcionamento offline e atualiza√ß√µes autom√°ticas
            if ('serviceWorker' in navigator) {
                // FOR√áAR limpeza completa: desregistrar service workers antigos antes de registrar novo
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    return Promise.all(registrations.map(registration => {
                        console.log('üóëÔ∏è Removendo service worker antigo:', registration.scope);
                        return registration.unregister();
                    }));
                }).then(() => {
                    // Limpar TODOS os caches antigos (incluindo vers√µes antigas)
                    return caches.keys().then(cacheNames => {
                        console.log('üóëÔ∏è Caches encontrados:', cacheNames);
                        return Promise.all(cacheNames.map(cacheName => {
                            console.log('üóëÔ∏è Removendo cache:', cacheName);
                            return caches.delete(cacheName);
                        }));
                    });
                }).then(() => {
                    // Pequeno delay para garantir que limpeza foi conclu√≠da
                    return new Promise(resolve => setTimeout(resolve, 100));
                }).then(() => {
                    // Agora registrar novo service worker com timestamp para evitar cache
                    const swUrl = './sw.js?v=' + Date.now();
                    return navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' });
                }).then((registration) => {
                    console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
                    
                    // For√ßar atualiza√ß√£o imediata
                    registration.update();
                    
                    // Detectar quando h√° nova vers√£o dispon√≠vel
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nova vers√£o dispon√≠vel!
                                    console.log('üîÑ Nova vers√£o dispon√≠vel! Atualizando...');
                                    mostrarNotificacaoFeedback('üîÑ Nova vers√£o dispon√≠vel! Atualizando automaticamente...', 'success');
                                    
                                    // For√ßar atualiza√ß√£o imediata
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    
                                    // Recarregar p√°gina ap√≥s 2 segundos para aplicar atualiza√ß√£o
                                    setTimeout(() => {
                                        window.location.reload(true); // true = for√ßa reload sem cache
                                    }, 2000);
                                }
                            });
                        }
                    });
                    
                    // Verificar atualiza√ß√µes periodicamente (a cada 30 segundos)
                    setInterval(() => {
                        registration.update();
                    }, 30000);
                    
                    // Verificar atualiza√ß√£o quando p√°gina volta ao foco (√∫til para iPhone)
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            registration.update();
                        }
                    });
                    
                }).catch((error) => {
                    console.log('‚ö†Ô∏è Erro ao registrar Service Worker:', error);
                });
            }
            
            // Splash Screen - Esconder ap√≥s carregar
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.classList.add('fade-out');
                    document.body.classList.remove('splash-loading');
                    setTimeout(() => {
                        splash.classList.add('hidden');
                    }, 800);
                }
            }, 2500);
            
            // Inicializar campo de data com hoje (s√≥ se elemento existir)
            const feedbackData = document.getElementById('feedbackData');
            if (feedbackData) {
                feedbackData.value = obterDataBrasiliaString();
            }
            
            // Inicializar data inicial do lembrete com hoje (s√≥ se elemento existir)
            const lembreteDataInicial = document.getElementById('lembreteDataInicial');
            if (lembreteDataInicial) {
                lembreteDataInicial.value = obterDataBrasiliaString();
            }
            
            // Event listeners para filtros de agenda (s√≥ se elementos existirem)
            const agendaDataInicio = document.getElementById('agendaDataInicio');
            const agendaDataFim = document.getElementById('agendaDataFim');
            if (agendaDataInicio) {
                agendaDataInicio.addEventListener('change', renderAgenda);
            }
            if (agendaDataFim) {
                agendaDataFim.addEventListener('change', renderAgenda);
            }
            
            // CADASTRO FORM (s√≥ se elemento existir)
            const cadastroForm = document.getElementById('cadastroForm');
            if (cadastroForm) {
                cadastroForm.onsubmit = function(e) {
                    e.preventDefault();
                const area = document.getElementById('novaArea').value.trim();
                const tema = document.getElementById('novoTema').value.trim();
                const prioridade = parseInt(document.getElementById('novaPrioridade').value);
                const status = document.getElementById('novaStatus').value;
                const dataInicio = document.getElementById('novaDataInicio').value;
                
                const novoTema = {
                    id: Date.now(),
                    area: normalizeArea(area, tema), // Normalizar para uma das 3 √°reas v√°lidas
                    tema: tema,
                    status: status,
                    prioridade: prioridade,
                    dificuldade: 'M√©dia',
                    rendimento: 0,
                    sessoes: 0,
                    ultEstudo: '',
                    agenda: dataInicio || '',
                    tempo: 0,
                    observacoes: '',
                    contador80: 0,
                    sugestao: ''
                };
                
                // Garantir que √°rea/tema est√£o corretos
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(novoTema.area, novoTema.tema);
                novoTema.area = areaCorrigida;
                novoTema.tema = temaCorrigido;
                
                // Recarregar dados do localStorage antes de adicionar (garantir sincroniza√ß√£o)
                dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                if (Array.isArray(dados)) {
                    dados = dados.map(d => fixAreaTemaObjeto(d));
                }
                
                dados.push(novoTema);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                
                // IMPORTANTE: Garantir que a vari√°vel global est√° sincronizada
                window.dados = dados;
                
                this.reset();
                mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
                
                // Atualizar selects e renderiza√ß√µes - renderDados() j√° recarrega do localStorage, mas garantimos que est√° atualizado
                renderDados();
                updateFeedbackSelect();
                renderPendencias();
                
                // Se estiver na aba cadastro, mudar para aba dados para ver o tema adicionado
                const abaAtiva = document.querySelector('.section.active');
                if (abaAtiva && abaAtiva.id === 'cadastro') {
                    setTimeout(() => {
                        showSection('dados');
                    }, 500);
                }
            };
            }
            
            // FUN√á√ÉO GLOBAL PARA PROCESSAR FEEDBACK - FUNCIONA GARANTIDAMENTE
            window.processarFeedbackForm = function() {
                console.log('üöÄ processarFeedbackForm() chamada diretamente');
                
                try {
                    // Validar campos obrigat√≥rios
                    const temaId = document.getElementById('feedbackTema').value;
                    if (!temaId) {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione um m√≥dulo!', 'error');
                        return false;
                    }
                    
                    const dataSessao = document.getElementById('feedbackData').value;
                    if (!dataSessao) {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione uma data para a sess√£o!', 'error');
                        return false;
                    }
                    
                    const rendimentoInput = document.getElementById('feedbackRendimento');
                    const rendimento = parseInt(rendimentoInput.value);
                    if (!rendimento || rendimento < 0 || rendimento > 100) {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha a performance (0-100)!', 'error');
                        return false;
                    }
                    
                    // Coletar todos os dados do formul√°rio
                    const tempoInput = document.getElementById('feedbackTempo');
                    const modal = document.getElementById('encerrarSessaoModal');
                    let tempo = 0;
                    if (modal && modal.dataset.tempoSalvo) {
                        tempo = Math.floor(parseInt(modal.dataset.tempoSalvo) / 60);
                    } else if (cronometroSegundos > 0) {
                        tempo = obterTempoCronometroMinutos();
                    } else {
                        tempo = parseInt(tempoInput.value) || 0;
                    }
                    
                    // Tempo √© opcional - se n√£o tiver preenchido, usar 0
                    if (tempo < 0) tempo = 0;
                    
                    // Obter tempo de intervalo
                    let tempoIntervalo = 0;
                    if (modal && modal.dataset.intervalosSalvos) {
                        tempoIntervalo = Math.floor(parseInt(modal.dataset.intervalosSalvos) / 60);
                    } else {
                        tempoIntervalo = obterTempoIntervaloMinutos();
                    }
                    
                    const numeroIntervalosEl = document.getElementById('feedbackNumeroIntervalos');
                    const intervalosTextoEl = document.getElementById('feedbackIntervalos');
                    const questoesTextoEl = document.getElementById('feedbackQuestoes');
                    const flashcardsEl = document.getElementById('feedbackFlashcards');
                    const sugestaoEl = document.getElementById('feedbackSugestao');
                    const obsEl = document.getElementById('feedbackObs');
                    
                    const numeroIntervalos = numeroIntervalosEl ? parseInt(numeroIntervalosEl.value) || 0 : 0;
                    const intervalosTexto = intervalosTextoEl ? intervalosTextoEl.value.trim() || '' : '';
                    const questoesTexto = questoesTextoEl ? questoesTextoEl.value.trim() || '' : '';
                    const flashcards = flashcardsEl ? parseInt(flashcardsEl.value) || 0 : 0;
                    const sugestao = sugestaoEl ? sugestaoEl.value.trim() : '';
                    const obs = obsEl ? obsEl.value.trim() : '';
                    
                    // Processar campos de tempo de quest√µes e flashcards
                    const tempoQuestoesInput = document.getElementById('feedbackTempoQuestoes');
                    const tempoFlashcardsInput = document.getElementById('feedbackTempoFlashcards');
                    let tempoQuestoes = tempoQuestoesInput ? parseInt(tempoQuestoesInput.value) || 0 : 0;
                    let tempoFlashcards = tempoFlashcardsInput ? parseInt(tempoFlashcardsInput.value) || 0 : 0;
                    
                    // Extrair dados de quest√µes
                    let quantQuestoes = 0;
                    let quantQuestoesAcertos = 0;
                    if (questoesTexto && questoesTexto.includes('/')) {
                        const partes = questoesTexto.split('/');
                        quantQuestoesAcertos = parseInt(partes[0]) || 0;
                        quantQuestoes = parseInt(partes[1]) || 0;
                    }
                    
                    // Extrair dados de flashcards
                    let quantFlashcards = 0;
                    if (flashcards > 0) {
                        quantFlashcards = flashcards;
                    }
                    
                    // Se n√£o tiver dados nos boxes mas tiver no modal, usar do modal
                    if (tempoQuestoes === 0 && modal && modal.dataset.tempoQuestoes) {
                        tempoQuestoes = parseInt(modal.dataset.tempoQuestoes) || 0;
                    }
                    if (tempoFlashcards === 0 && modal && modal.dataset.tempoFlashcards) {
                        tempoFlashcards = parseInt(modal.dataset.tempoFlashcards) || 0;
                    }
                    if (quantQuestoes === 0 && modal && modal.dataset.quantQuestoes) {
                        quantQuestoes = parseInt(modal.dataset.quantQuestoes) || 0;
                    }
                    if (quantFlashcards === 0 && modal && modal.dataset.quantFlashcards) {
                        quantFlashcards = parseInt(modal.dataset.quantFlashcards) || 0;
                    }
                    
                    console.log('üìä Dados coletados:', { temaId, dataSessao, rendimento, tempo, tempoIntervalo });
                    
                    // Preencher modal de confirma√ß√£o com os dados coletados - VERIFICAR CADA ELEMENTO
                    try {
                        const confirmarData = document.getElementById('confirmarData');
                        const confirmarRendimento = document.getElementById('confirmarRendimento');
                        const confirmarTempo = document.getElementById('confirmarTempo');
                        const confirmarTempoIntervalo = document.getElementById('confirmarTempoIntervalo');
                        const confirmarNumIntervalos = document.getElementById('confirmarNumIntervalos');
                        const confirmarTempoQuestoes = document.getElementById('confirmarTempoQuestoes');
                        const confirmarQuestoes = document.getElementById('confirmarQuestoes');
                        const confirmarTempoFlashcards = document.getElementById('confirmarTempoFlashcards');
                        const confirmarFlashcards = document.getElementById('confirmarFlashcards');
                        const confirmarSugestao = document.getElementById('confirmarSugestao');
                        const confirmarObs = document.getElementById('confirmarObs');
                        
                        if (!confirmarData) throw new Error('confirmarData n√£o encontrado');
                        if (!confirmarRendimento) throw new Error('confirmarRendimento n√£o encontrado');
                        if (!confirmarTempo) throw new Error('confirmarTempo n√£o encontrado');
                        if (!confirmarTempoIntervalo) throw new Error('confirmarTempoIntervalo n√£o encontrado');
                        if (!confirmarNumIntervalos) throw new Error('confirmarNumIntervalos n√£o encontrado');
                        if (!confirmarTempoQuestoes) throw new Error('confirmarTempoQuestoes n√£o encontrado');
                        if (!confirmarQuestoes) throw new Error('confirmarQuestoes n√£o encontrado');
                        if (!confirmarTempoFlashcards) throw new Error('confirmarTempoFlashcards n√£o encontrado');
                        if (!confirmarFlashcards) throw new Error('confirmarFlashcards n√£o encontrado');
                        if (!confirmarSugestao) throw new Error('confirmarSugestao n√£o encontrado');
                        if (!confirmarObs) throw new Error('confirmarObs n√£o encontrado');
                        
                        confirmarData.value = dataSessao;
                        confirmarRendimento.value = rendimento;
                        confirmarTempo.value = tempo;
                        confirmarTempoIntervalo.value = tempoIntervalo;
                        confirmarNumIntervalos.value = numeroIntervalos;
                        confirmarTempoQuestoes.value = tempoQuestoes;
                        confirmarQuestoes.value = questoesTexto || (quantQuestoes > 0 ? `${quantQuestoesAcertos}/${quantQuestoes}` : '');
                        confirmarTempoFlashcards.value = tempoFlashcards;
                        confirmarFlashcards.value = quantFlashcards;
                        confirmarSugestao.value = sugestao;
                        confirmarObs.value = obs;
                        
                        console.log('‚úÖ Campos do modal preenchidos');
                    } catch (error) {
                        console.error('‚ùå Erro ao preencher campos do modal:', error);
                        throw error;
                    }
                    
                    // Guardar temaId no modal para uso posterior
                    const confirmarModal = document.getElementById('confirmarFeedbackModal');
                    console.log('üîç Procurando modal de confirma√ß√£o:', confirmarModal);
                    if (!confirmarModal) {
                        throw new Error('Modal confirmarFeedbackModal n√£o encontrado no DOM');
                    }
                    
                    confirmarModal.dataset.temaId = temaId;
                    
                    // Mostrar modal de confirma√ß√£o
                    confirmarModal.classList.add('active');
                    confirmarModal.style.display = 'flex';
                    console.log('‚úÖ Modal de confirma√ß√£o aberto - classes:', confirmarModal.className);
                    
                    return false;
                } catch (error) {
                    console.error('‚ùå Erro ao processar feedback:', error);
                    console.error('‚ùå Stack trace:', error.stack);
                    mostrarNotificacaoFeedback(`‚ùå Erro: ${error.message || 'Erro desconhecido'}. Verifique o console (F12) para mais detalhes.`, 'error');
                    return false;
                }
            };
            
            // FEEDBACK FORM - 100% FUNCIONANDO! (Garantir que DOM est√° pronto)
            function inicializarFeedbackForm() {
                const feedbackArea = document.getElementById('feedbackArea');
                if (feedbackArea) {
                    feedbackArea.addEventListener('change', updateFeedbackTemaSelect);
                }
                
                // Garantir que o formul√°rio existe e est√° funcionando
                const feedbackForm = document.getElementById('feedbackForm');
                if (!feedbackForm) {
                    console.error('‚ùå Formul√°rio de feedback n√£o encontrado!');
                    return;
                }
                
                console.log('‚úÖ Formul√°rio de feedback encontrado');
                
                // Adicionar listener de submit no formul√°rio tamb√©m (fallback)
                feedbackForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üìù Submit do formul√°rio capturado - chamando processarFeedbackForm()');
                    processarFeedbackForm();
                    return false;
                });
                
                // Garantir que o bot√£o tem o listener tamb√©m
                const submitBtn = document.getElementById('btnSalvarFeedback');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîò Bot√£o clicado - chamando processarFeedbackForm()');
                        processarFeedbackForm();
                    });
                    console.log('‚úÖ Listener adicionado ao bot√£o de submit');
                } else {
                    console.error('‚ùå Bot√£o btnSalvarFeedback n√£o encontrado!');
                }
                
                console.log('‚úÖ Formul√°rio de feedback inicializado com sucesso');
            }
            
            // Inicializar quando DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializarFeedbackForm);
            } else {
                inicializarFeedbackForm();
            }
            
            // Fun√ß√£o auxiliar para salvar feedback diretamente (fallback se modal n√£o existir)
            function salvarFeedbackDireto(temaId, dataSessao, rendimento, tempo, tempoIntervalo, numeroIntervalos, intervalosTexto, tempoQuestoes, quantQuestoes, quantQuestoesAcertos, tempoFlashcards, quantFlashcards, questoesTexto, sugestao, obs) {
                try {
                    // IMPORTANTE: Recarregar dados do localStorage antes de processar feedback (fix para iOS)
                    dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                    if (Array.isArray(dados)) {
                        dados = dados.map(d => fixAreaTemaObjeto(d));
                    }
                    historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
                    
                    // CORRE√á√ÉO: Compara√ß√£o correta de IDs
                    const tema = dados.find(t => String(t.id) === String(temaId));
                    if (!tema) {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado! Selecione um m√≥dulo v√°lido.', 'error');
                        return false;
                    }
                    
                    // Atualizar contador80
                    if (rendimento >= 80) {
                        tema.contador80 = (tema.contador80 || 0) + 1;
                    } else {
                        tema.contador80 = 0;
                    }
                    
                    // Atualizar dados do tema
                    tema.rendimento = rendimento / 100;
                    tema.sessoes = (tema.sessoes || 0) + 1;
                    tema.ultEstudo = dataSessao;
                    tema.agenda = calcularProximaRevisao(tema, dataSessao);
                    tema.tempo = (tema.tempo || 0) + tempo;
                    tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
                    
                    // Adicionar observa√ß√µes E sugest√£o
                    let novaObs = '';
                    if (obs) novaObs = `${dataSessao}: ${obs}`;
                    
                    // Adicionar novos dados √†s observa√ß√µes se preenchidos
                    if (questoesTexto) {
                        novaObs += (novaObs ? ' | ' : '') + `Q${questoesTexto}`;
                    }
                    if (quantFlashcards > 0) {
                        novaObs += (novaObs ? ' | ' : '') + `FC${quantFlashcards}`;
                    }
                    
                    if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
                    
                    if (novaObs) {
                        tema.observacoes = tema.observacoes 
                            ? tema.observacoes + '\n' + novaObs
                            : novaObs;
                    }
                    
                    // SALVAR SUGEST√ÉO NO TEMA
                    tema.sugestao = sugestao || '';
                    
                    // ADICIONAR AO HIST√ìRICO
                    const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(tema.area, tema.tema);
                    historico.push({
                        id: Date.now(),
                        temaId: tema.id,
                        area: areaCorrigida,
                        tema: temaCorrigido,
                        rendimento: rendimento / 100,
                        tempo: tempo,
                        tempoIntervalo: tempoIntervalo,
                        numeroIntervalos: numeroIntervalos,
                        intervalos: intervalosTexto,
                        tempoQuestoes: tempoQuestoes,
                        quantQuestoes: quantQuestoes,
                        quantQuestoesAcertos: quantQuestoesAcertos,
                        tempoFlashcards: tempoFlashcards,
                        quantFlashcards: quantFlashcards,
                        questoes: questoesTexto,
                        flashcards: quantFlashcards,
                        data: dataSessao,
                        observacoes: obs || '-',
                        sugestao: sugestao || '-'
                    });
                    
                    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                    localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                    
                    mostrarNotificacaoFeedback('‚úÖ Feedback salvo com sucesso!');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar feedback direto:', error);
                    mostrarNotificacaoFeedback('‚ùå Erro ao salvar feedback. Tente novamente.', 'error');
                    return false;
                }
            }
            
            // Fun√ß√£o GLOBAL para salvar feedback ap√≥s confirma√ß√£o - FUNCIONA GARANTIDAMENTE
            window.salvarFeedbackConfirmado = function() {
                console.log('üíæ salvarFeedbackConfirmado() chamada');
                try {
                    // IMPORTANTE: Recarregar dados do localStorage antes de processar feedback (fix para iOS)
                    dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
                    if (Array.isArray(dados)) {
                        dados = dados.map(d => fixAreaTemaObjeto(d));
                    }
                    historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
                    
                    const modal = document.getElementById('confirmarFeedbackModal');
                    if (!modal) {
                        throw new Error('Modal de confirma√ß√£o n√£o encontrado');
                    }
                    
                    const temaId = modal.dataset.temaId;
                    if (!temaId) {
                        throw new Error('TemaId n√£o encontrado no modal');
                    }
                    
                    // Obter dados do modal de confirma√ß√£o (com ajustes manuais do usu√°rio)
                    const confirmarDataEl = document.getElementById('confirmarData');
                    const confirmarRendimentoEl = document.getElementById('confirmarRendimento');
                    const confirmarTempoEl = document.getElementById('confirmarTempo');
                    const confirmarTempoIntervaloEl = document.getElementById('confirmarTempoIntervalo');
                    const confirmarNumIntervalosEl = document.getElementById('confirmarNumIntervalos');
                    const confirmarTempoQuestoesEl = document.getElementById('confirmarTempoQuestoes');
                    const confirmarQuestoesEl = document.getElementById('confirmarQuestoes');
                    const confirmarTempoFlashcardsEl = document.getElementById('confirmarTempoFlashcards');
                    const confirmarFlashcardsEl = document.getElementById('confirmarFlashcards');
                    const confirmarSugestaoEl = document.getElementById('confirmarSugestao');
                    const confirmarObsEl = document.getElementById('confirmarObs');
                    
                    if (!confirmarDataEl || !confirmarRendimentoEl) {
                        throw new Error('Campos do modal n√£o encontrados');
                    }
                    
                    const dataSessao = confirmarDataEl.value;
                    const rendimento = parseInt(confirmarRendimentoEl.value);
                    const tempo = confirmarTempoEl ? parseInt(confirmarTempoEl.value) || 0 : 0;
                    const tempoIntervalo = confirmarTempoIntervaloEl ? parseInt(confirmarTempoIntervaloEl.value) || 0 : 0;
                    const numeroIntervalos = confirmarNumIntervalosEl ? parseInt(confirmarNumIntervalosEl.value) || 0 : 0;
                    const tempoQuestoes = confirmarTempoQuestoesEl ? parseInt(confirmarTempoQuestoesEl.value) || 0 : 0;
                    const questoesTexto = confirmarQuestoesEl ? confirmarQuestoesEl.value.trim() || '' : '';
                    const tempoFlashcards = confirmarTempoFlashcardsEl ? parseInt(confirmarTempoFlashcardsEl.value) || 0 : 0;
                    const quantFlashcards = confirmarFlashcardsEl ? parseInt(confirmarFlashcardsEl.value) || 0 : 0;
                    const sugestao = confirmarSugestaoEl ? confirmarSugestaoEl.value.trim() : '';
                    const obs = confirmarObsEl ? confirmarObsEl.value.trim() : '';
                    
                    // Extrair dados de quest√µes
                    let quantQuestoes = 0;
                    let quantQuestoesAcertos = 0;
                    if (questoesTexto && questoesTexto.includes('/')) {
                        const partes = questoesTexto.split('/');
                        quantQuestoesAcertos = parseInt(partes[0]) || 0;
                        quantQuestoes = parseInt(partes[1]) || 0;
                    }
                    
                    // Extrair intervalos texto se necess√°rio
                    const intervalosTexto = numeroIntervalos > 0 ? `Intervalos: ${numeroIntervalos}` : '';
                    
                    // CORRE√á√ÉO: Compara√ß√£o correta de IDs
                    const tema = dados.find(t => String(t.id) === String(temaId));
                    if (!tema) {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado! Selecione um m√≥dulo v√°lido.', 'error');
                        return false;
                    }
                    
                    // Atualizar contador80
                    if (rendimento >= 80) {
                        tema.contador80 = (tema.contador80 || 0) + 1;
                    } else {
                        tema.contador80 = 0;
                    }
                    
                    // Atualizar dados do tema
                    tema.rendimento = rendimento / 100;
                    tema.sessoes = (tema.sessoes || 0) + 1;
                    tema.ultEstudo = dataSessao;
                    tema.agenda = calcularProximaRevisao(tema, dataSessao);
                    tema.tempo = (tema.tempo || 0) + tempo;
                    tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
                    
                    // Adicionar observa√ß√µes E sugest√£o
                    let novaObs = '';
                    if (obs) novaObs = `${dataSessao}: ${obs}`;
                    
                    // Adicionar novos dados √†s observa√ß√µes se preenchidos
                    if (questoesTexto) {
                        novaObs += (novaObs ? ' | ' : '') + `Q${questoesTexto}`;
                    }
                    if (quantFlashcards > 0) {
                        novaObs += (novaObs ? ' | ' : '') + `FC${quantFlashcards}`;
                    }
                    
                    if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
                    
                    if (novaObs) {
                        tema.observacoes = tema.observacoes 
                            ? tema.observacoes + '\n' + novaObs
                            : novaObs;
                    }
                    
                    // SALVAR SUGEST√ÉO NO TEMA
                    tema.sugestao = sugestao || '';
                    
                    // ADICIONAR AO HIST√ìRICO
                    const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(tema.area, tema.tema);
                    historico.push({
                        id: Date.now(),
                        temaId: tema.id,
                        area: areaCorrigida,
                        tema: temaCorrigido,
                        rendimento: rendimento / 100,
                        tempo: tempo,
                        tempoIntervalo: tempoIntervalo,
                        numeroIntervalos: numeroIntervalos,
                        intervalos: intervalosTexto,
                        tempoQuestoes: tempoQuestoes,
                        quantQuestoes: quantQuestoes,
                        quantQuestoesAcertos: quantQuestoesAcertos,
                        tempoFlashcards: tempoFlashcards,
                        quantFlashcards: quantFlashcards,
                        questoes: questoesTexto,
                        flashcards: quantFlashcards,
                        data: dataSessao,
                        observacoes: obs || '-',
                        sugestao: sugestao || '-'
                    });
                    
                    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                    localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                    
                    // Limpar formul√°rio
                    const feedbackForm = document.getElementById('feedbackForm');
                    if (feedbackForm) feedbackForm.reset();
                    const feedbackData = document.getElementById('feedbackData');
                    if (feedbackData) feedbackData.value = obterDataBrasiliaString();
                    const feedbackNumeroIntervalos = document.getElementById('feedbackNumeroIntervalos');
                    if (feedbackNumeroIntervalos) feedbackNumeroIntervalos.value = '0';
                    const feedbackIntervalos = document.getElementById('feedbackIntervalos');
                    if (feedbackIntervalos) feedbackIntervalos.value = '';
                    const feedbackQuestoes = document.getElementById('feedbackQuestoes');
                    if (feedbackQuestoes) feedbackQuestoes.value = '';
                    const feedbackFlashcards = document.getElementById('feedbackFlashcards');
                    if (feedbackFlashcards) feedbackFlashcards.value = '';
                    const tempoQuestoesInput = document.getElementById('feedbackTempoQuestoes');
                    const tempoFlashcardsInput = document.getElementById('feedbackTempoFlashcards');
                    if (tempoQuestoesInput) tempoQuestoesInput.value = '';
                    if (tempoFlashcardsInput) tempoFlashcardsInput.value = '';
                    
                    // Resetar cron√¥metro ap√≥s salvar
                    if (typeof resetCronometro === 'function') {
                        resetCronometro();
                    }
                    
                    // Fechar modal
                    window.closeConfirmarFeedbackModal();
                    
                    // NOTIFICA√á√ÉO DE SUCESSO!
                    const proximaData = formatarData(tema.agenda);
                    mostrarNotificacaoFeedback(`‚úÖ Performance registrada!<br>üìÖ Pr√≥xima revis√£o: ${proximaData}`);
                    
                    // Atualizar todas as visualiza√ß√µes
                    if (typeof renderDados === 'function') renderDados();
                    if (typeof renderTarefas === 'function') renderTarefas();
                    if (typeof renderAgenda === 'function') renderAgenda();
                    if (typeof renderPendencias === 'function') renderPendencias();
                    if (typeof updateFeedbackSelect === 'function') updateFeedbackSelect();
                    if (typeof renderHistorico === 'function') renderHistorico();
                    if (typeof updateStats === 'function') updateStats();
                    
                    console.log('‚úÖ Feedback salvo com sucesso');
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar feedback:', error);
                    console.error('‚ùå Stack trace:', error.stack);
                    mostrarNotificacaoFeedback(`‚ùå Erro ao salvar: ${error.message || 'Erro desconhecido'}. Verifique o console (F12).`, 'error');
                    return false;
                }
            };
            
            // Fun√ß√£o GLOBAL para fechar modal de confirma√ß√£o - FUNCIONA GARANTIDAMENTE
            window.closeConfirmarFeedbackModal = function() {
                console.log('üî¥ Fechando modal de confirma√ß√£o');
                const modal = document.getElementById('confirmarFeedbackModal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                    console.log('‚úÖ Modal fechado');
                } else {
                    console.error('‚ùå Modal n√£o encontrado para fechar');
                }
            };
            
            // Fechar modal ao clicar fora dele
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('confirmarFeedbackModal');
                if (modal && modal.classList.contains('active')) {
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent && !modalContent.contains(e.target) && e.target !== modal) {
                        window.closeConfirmarFeedbackModal();
                    }
                }
            });
            
            
            // Fun√ß√£o local que chama a global (compatibilidade)
            function salvarFeedbackConfirmado() {
                return window.salvarFeedbackConfirmado();
            }
            
            // EDIT FORM (s√≥ se elemento existir)
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.onsubmit = function(e) {
                    e.preventDefault();
                const id = document.getElementById('editId').value;
                const tema = dados.find(t => String(t.id) === String(id));
                
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                    return;
                }
                
                const areaEditada = document.getElementById('editArea').value.trim();
                const temaEditado = document.getElementById('editTema').value.trim();
                
                // Normalizar e corrigir √°rea/tema
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(areaEditada, temaEditado);
                tema.area = areaCorrigida;
                tema.tema = temaCorrigido;
                tema.prioridade = parseInt(document.getElementById('editPrioridade').value);
                const novoStatus = document.getElementById('editStatus').value;
                tema.status = novoStatus;
                
                // CORRE√á√ÉO: Se mudou para Conclu√≠do ou Suspenso, limpar agenda
                if (novoStatus === 'Conclu√≠do' || novoStatus === 'Suspenso') {
                    tema.agenda = '';
                } else {
                    // Recalcular agenda se necess√°rio
                    if (tema.sessoes > 0) {
                        tema.agenda = calcularProximaRevisao(tema);
                    }
                }
                
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                
                closeEditModal();
                mostrarNotificacaoFeedback('‚úÖ Tema atualizado com sucesso!');
                
                renderDados();
                renderTarefas();
                renderAgenda();
                renderPendencias();
                updateFeedbackSelect();
            };
            }
            
            // LEMBRETE FORM (s√≥ se elemento existir)
            const lembreteForm = document.getElementById('lembreteForm');
            if (lembreteForm) {
                lembreteForm.onsubmit = function(e) {
                    e.preventDefault();
                const titulo = document.getElementById('lembreteTitulo').value.trim();
                const descricao = document.getElementById('lembreteDescricao').value.trim();
                const periodicidade = document.getElementById('lembretePeriodicidade').value;
                const temaId = document.getElementById('lembreteTemaId').value;
                const dataInicial = document.getElementById('lembreteDataInicial').value;
                
                const novoLembrete = {
                    id: Date.now(),
                    titulo: titulo,
                    descricao: descricao || '',
                    periodicidade: periodicidade,
                    temaId: temaId || null,
                    dataInicial: dataInicial,
                    proximaData: periodicidade === 'pontual' ? dataInicial : calcularProximaDataLembrete({
                        periodicidade: periodicidade,
                        dataInicial: dataInicial,
                        ultimaData: null
                    }),
                    ultimaData: null,
                    concluido: false
                };
                
                lembretes.push(novoLembrete);
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                
                mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado com sucesso!');
                
                // Limpar formul√°rio
                this.reset();
                document.getElementById('lembreteDataInicial').value = obterDataBrasiliaString();
                
                renderLembretes();
            };
            }
            
            // Inicializa√ß√µes (com prote√ß√£o contra erros)
            try {
                if (typeof renderTarefas === 'function') renderTarefas();
                if (typeof renderAgenda === 'function') renderAgenda();
                if (typeof renderDados === 'function') renderDados();
                if (typeof renderPendencias === 'function') renderPendencias();
                if (typeof updateFeedbackSelect === 'function') updateFeedbackSelect();
                if (typeof updateStats === 'function') updateStats();
                if (typeof renderHistorico === 'function') renderHistorico();
                if (typeof atualizarSelectsLembrete === 'function') atualizarSelectsLembrete();
                if (typeof renderLembretes === 'function') renderLembretes();
                if (typeof atualizarSelectsCaderno === 'function') atualizarSelectsCaderno();
                if (typeof renderCaderno === 'function') renderCaderno();
            } catch (error) {
                console.error('‚ùå Erro ao inicializar:', error);
            }
            
            // GARANTIR que splash screen seja escondido mesmo com erro
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.style.display = 'none';
                    splash.classList.add('hidden');
                }
                document.body.classList.remove('splash-loading');
            }, 3000);
        };
    </script>
</body>
</html>

