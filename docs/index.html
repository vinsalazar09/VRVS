<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#17121d">
    
    <!-- Favicon para MacBook e navegadores - m√∫ltiplos formatos e caminhos -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=3">
    <link rel="shortcut icon" href="./favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico?v=3" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png?v=3">
    <link rel="icon" type="image/png" href="./logo.png?v=3">
    
    <!-- Apple Touch Icon para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png?v=3">
    <link rel="apple-touch-icon" href="./logo.png?v=3">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VRVS">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üß† VRVS v5.3 ‚Äì Sistema de Gest√£o de Estudos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* CORES CIRCUIT TECH */
            --bg-dark: #0a1a1f;
            --bg-darker: #051015;
            
            /* TURQUESA TECH */
            --turquesa-neon: #00FFE0;
            --turquesa-light: #00CED1;
            --turquesa-main: #0d9488;
            --turquesa-dark: #0f766e;
            --turquesa-darker: #134e4a;
            
            /* √ÇMBAR COBRE TECH */
            --cobre-neon: #FFAA00;
            --cobre-light: #FFB84D;
            --cobre-main: #FF9F40;
            --cobre-dark: #E5892E;
            --cobre-darker: #B8701F;
            
            /* GLASSMORPHISM */
            --glass-bg: rgba(20, 35, 45, 0.4);
            --glass-border: rgba(255, 127, 80, 0.3);
            --text-light: rgba(255, 255, 255, 0.95);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-dark) !important;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* CIRCUIT BOARD BACKGROUND */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(13, 148, 136, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 127, 80, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 206, 209, 0.1) 0%, transparent 70%),
                var(--bg-dark);
            pointer-events: none;
            z-index: 1;
        }
        
        /* GRID CIRCUIT ANIMADO */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(rgba(255, 127, 80, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 127, 80, 0.05) 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 100px 100px, 100px 100px;
            pointer-events: none;
            z-index: 1;
            animation: gridPulse 6s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; transform: translate(0, 0); }
            50% { opacity: 0.6; transform: translate(-2px, -2px); }
        }
        
        .container {
            position: relative;
            z-index: 2;
            padding-bottom: 100px;
        }
        
        /* HEADER NEON TECH */
        .header {
            background: rgba(10, 26, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 22px 20px;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, 
                var(--turquesa-main) 50%,
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            ) 1;
            animation: borderFlow 4s linear infinite;
        }
        
        @keyframes borderFlow {
            0% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, var(--cobre-main) 25%, 
                var(--turquesa-main) 50%, var(--cobre-neon) 75%, var(--turquesa-neon) 100%); }
            100% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 100%, var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, var(--turquesa-main) 50%, var(--cobre-neon) 75%); }
        }
        
        .header-title {
            background: linear-gradient(135deg, 
                var(--turquesa-neon) 0%, 
                var(--turquesa-light) 25%, 
                var(--cobre-light) 50%, 
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(255, 170, 0, 0.8));
                transform: scale(1.02);
            }
        }
        
        .header-subtitle {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 206, 209, 0.7);
        }
        
        /* TABS GLASSMORPHISM - SEM SCROLL CORTADO */
        .tabs {
            display: flex;
            gap: 12px;
            padding: 20px 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(10, 26, 31, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--turquesa-light);
            border: 1px solid rgba(0, 206, 209, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .tab:hover {
            border-color: var(--cobre-main);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, 
                rgba(255, 127, 80, 0.2), 
                rgba(0, 206, 209, 0.2)
            );
            color: var(--cobre-light);
            border-color: var(--cobre-main);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.4),
                0 0 40px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* CONTENT SECTIONS */
        .content {
            padding: 20px 15px;
            min-height: 50vh; /* CORRE√á√ÉO: Ocupar pelo menos 50% da tela */
        }
        
        .section {
            display: none;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .section.active { display: block; }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        /* CARDS GLASSMORPHISM NEON - SEM HOVER MANCHADO */
        .card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(0, 206, 209, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
            pointer-events: auto;
            /* CORRE√á√ÉO: Garantir que texto dentro dos cards seja vis√≠vel */
            color: var(--text-light);
        }
        
        /* CORRE√á√ÉO: Garantir que todos os elementos dentro dos cards herdem cor clara */
        .card * {
            color: inherit;
        }
        
        /* Exce√ß√µes: elementos que devem manter suas cores espec√≠ficas */
        .card-title {
            color: transparent; /* Mant√©m gradiente */
        }
        
        .stat-value {
            color: transparent; /* Mant√©m gradiente */
        }
        
        .stat-label {
            color: rgba(0, 206, 209, 0.8); /* Mant√©m cor espec√≠fica */
        }
        
        .form-label {
            color: var(--turquesa-light); /* Mant√©m cor espec√≠fica */
        }
        
        .form-input, .form-select, .form-textarea {
            color: var(--text-light); /* Mant√©m cor espec√≠fica */
        }
        
        .card:hover {
            border-color: var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .card-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 127, 80, 0.3);
        }
        
        /* Garantir que bot√µes dentro de card-title n√£o herdem transpar√™ncia */
        .card-title button {
            -webkit-text-fill-color: #FFFFFF !important;
            background-clip: border-box !important;
            -webkit-background-clip: border-box !important;
        }
        
        /* FORM ELEMENTS NEON */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(10, 26, 31, 0.6);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-light);
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cobre-main);
            box-shadow: 
                0 0 20px rgba(255, 127, 80, 0.3),
                inset 0 0 20px rgba(255, 127, 80, 0.05);
            background: rgba(10, 26, 31, 0.8);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 200px; /* CORRE√á√ÉO: Aumentado de 150px para melhor uso do espa√ßo */
            max-height: 500px; /* CORRE√á√ÉO: Aumentado de 400px para permitir mais conte√∫do */
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.6;
        }
        
        /* CORRE√á√ÉO: Cursor piscando fora dos boxes no mobile */
        .form-input, .form-textarea {
            -webkit-user-select: text;
            user-select: text;
            caret-color: var(--cobre-main);
            /* Remover qualquer transform que possa causar cursor fora de posi√ß√£o */
            transform: none;
            -webkit-transform: none;
        }
        
        .form-input:focus, .form-textarea:focus {
            /* Manter apenas propriedades essenciais - sem transform que causa cursor travado */
            -webkit-tap-highlight-color: rgba(255, 127, 80, 0.3);
            /* Garantir que cursor aparece dentro do elemento */
            outline-offset: 0;
        }
        
        /* CORRE√á√ÉO: Ajustar viewport quando teclado aparece no mobile */
        @media screen and (max-width: 768px) {
            /* Prevenir zoom autom√°tico no iOS quando input recebe foco */
            .form-input, .form-textarea, .form-select {
                font-size: 16px !important;
            }
            
            /* Garantir que modal seja scroll√°vel quando input est√° em foco */
            .modal-content {
                -webkit-overflow-scrolling: touch;
                /* Ajustar posi√ß√£o do modal quando teclado aparece */
                position: relative;
            }
            
            /* For√ßar scroll para elemento focado */
            .form-input:focus, .form-textarea:focus, .form-select:focus {
                scroll-margin-top: 100px;
                -webkit-scroll-margin-top: 100px;
            }
            
            /* OTIMIZA√á√ÉO: Reduzir espa√ßos vazios no modal do Di√°rio para mobile */
            #modalNovaDiario .modal-content {
                padding: 16px; /* Reduzido de 30px para 16px */
                max-height: 95vh; /* CORRE√á√ÉO: Aumentado de 90vh para 95vh - quase tela toda */
            }
            
            #modalNovaDiario .modal-header {
                margin-bottom: 16px; /* Reduzido de 24px para 16px */
            }
            
            #modalNovaDiario .form-group {
                margin-bottom: 12px; /* Reduzido de 20px para 12px */
            }
            
            #modalNovaDiario .form-label {
                margin-bottom: 6px; /* Reduzido de 8px para 6px */
                font-size: 11px; /* Ligeiramente menor para economizar espa√ßo */
            }
            
            /* CORRE√á√ÉO UX: Inputs do modal Di√°rio (iOS) */
            #modalNovaDiario input,
            #modalNovaDiario textarea,
            #modalNovaDiario select {
                box-sizing: border-box;
                padding: 12px 14px;
                text-indent: 0;
                caret-color: var(--cobre-main);
                -webkit-appearance: none;
                appearance: none;
                outline-offset: 0;
            }
            
            /* Campo T√≥pico/Pergunta: textarea com altura adequada */
            /* NOTA: Regra espec√≠fica para #novaDiarioTopico deve ficar DEPOIS de .form-textarea para sobrescrever min-height/max-height */
            #novaDiarioTopico {
                min-height: 96px;
                max-height: 220px;
                line-height: 1.4;
                font-size: 15px;
                padding: 12px 14px;
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
                caret-color: var(--cobre-main);
                direction: ltr;
                text-align: left;
                text-indent: 0;
            }
            
            /* Campo Resposta: altura maior separada */
            #novaDiarioResposta {
                min-height: 200px;
                max-height: 400px;
            }
            
            /* OTIMIZA√á√ÉO GERAL: Modais ocupam quase tela toda no mobile */
            .modal-content {
                max-height: 95vh !important; /* Quase tela toda no mobile */
                padding: 16px; /* Reduzir padding para ganhar espa√ßo */
                margin: 10px; /* Margem m√≠nima */
            }
            
            /* Containers principais devem ocupar mais espa√ßo no mobile */
            #diarioContainer,
            #cadernoContainer,
            #tarefaContainer,
            #agendaContainer {
                min-height: 60vh; /* Ocupar pelo menos 60% da tela */
            }
            
            /* √Åreas expandidas ocupam mais espa√ßo no mobile */
            .area-content:not(.collapsed) {
                max-height: 80vh !important; /* Aumentado de 70vh para mobile */
                min-height: 50vh !important; /* M√≠nimo 50% da tela quando expandido */
            }
            
            /* Reduzir paddings em cards para ganhar espa√ßo */
            .card {
                padding: 16px; /* Reduzido de 24px para 16px */
            }
        }
        
        /* BUTTONS NEON */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, 
                var(--cobre-main) 0%, 
                var(--cobre-dark) 100%
            );
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(255, 127, 80, 0.4),
                0 0 30px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.5),
                0 0 40px rgba(255, 127, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.3),
                rgba(0, 148, 136, 0.3)
            );
            box-shadow: 
                0 4px 15px rgba(0, 206, 209, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== SRS - ESTILOS DI√ÅRIO ==================== */
        
        /* ===== CHIP VRVS 3P ‚Äì Di√°rio ===== */
        .diario-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
        }
        
        .diario-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }
        
        /* ========================================
           CHIP VRVS 3P - NEON OUTLINE (OP√á√ÉO 1)
           ======================================== */
        #vrvs3p-chip-diario {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            
            /* fundo transparente para n√£o virar mais um "tijolo" */
            background: transparent !important;
            
            /* borda neon turquesa */
            border: 1.5px solid #00FFE0 !important;
            border-radius: 25px;
            
            /* glow sutil */
            box-shadow:
                0 0 8px rgba(0, 255, 224, 0.3),
                inset 0 0 8px rgba(0, 255, 224, 0.05);
            
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        #vrvs3p-chip-diario:hover {
            background: rgba(0, 255, 224, 0.08);
            box-shadow:
                0 0 12px rgba(0, 255, 224, 0.5),
                inset 0 0 12px rgba(0, 255, 224, 0.1);
        }
        
        #vrvs3p-chip-text {
            font-size: 13px;
            font-weight: 500;
            color: #00FFE0 !important;
            letter-spacing: 0.3px;
        }
        
        /* Responsivo ‚Äì portrait iPhone */
        @media (max-width: 480px) {
            .diario-header-row {
                align-items: flex-start;
            }
            
            #vrvs3p-chip-diario {
                padding: 6px 12px;
            }
            
            #vrvs3p-chip-text {
                font-size: 12px;
            }
            
            .btn-nova-diario {
                align-self: flex-end;
                margin-top: 8px;
            }
        }
        
        /* Tabs Lista/Sess√£o */
        .diario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .diario-tab {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 206, 209, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .diario-tab:hover {
            background: rgba(0, 206, 209, 0.1);
            border-color: var(--turquesa-main);
        }
        
        .diario-tab.active {
            background: var(--cobre-main);
            color: white;
            border-color: var(--cobre-main);
        }
        
        /* Modos Programado/Livre */
        .diario-sessao-modos {
            display: flex;
            gap: 8px;
        }
        
        .diario-sessao-modo-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(0, 206, 209, 0.3);
            background: transparent;
            color: var(--turquesa-light);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .diario-sessao-modo-btn:hover {
            background: rgba(0, 206, 209, 0.1);
        }
        
        .diario-sessao-modo-btn.active {
            background: var(--turquesa-main);
            color: white;
            border-color: var(--turquesa-main);
        }
        
        /* Card da sess√£o */
        .diario-sessao-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 127, 80, 0.2);
        }
        
        .diario-sessao-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(0, 206, 209, 0.7);
            margin-bottom: 16px;
        }
        
        .diario-sessao-topico {
            font-size: 16px;
            font-weight: 600;
            color: var(--cobre-light);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .diario-sessao-resposta {
            background: rgba(0, 206, 209, 0.1);
            border-left: 3px solid var(--turquesa-main);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .diario-sessao-resposta.escondida {
            display: none;
        }
        
        .diario-sessao-resposta-inner {
            font-size: 13px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .diario-sessao-acoes {
            margin-bottom: 16px;
        }
        
        /* Bot√£o Mostrar Resposta - neutro turquesa */
        .diario-sessao-acoes .btn {
            background: rgba(0, 206, 209, 0.2);
            border: 1px solid rgba(0, 206, 209, 0.4);
            color: var(--turquesa-light);
            font-weight: 600;
        }
        
        .diario-sessao-acoes .btn:hover,
        .diario-sessao-acoes .btn:active {
            background: rgba(0, 206, 209, 0.3);
        }
        
        /* Bot√µes de qualidade */
        .diario-sessao-botoes-qualidade {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            margin: 20px 0;
        }
        
        /* Bot√µes individuais - mesmo tamanho */
        .diario-sessao-botoes-qualidade button {
            flex: 1;
            max-width: 110px;
            min-width: 90px;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        /* Links secund√°rios */
        .diario-sessao-opcoes {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .link-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s ease;
        }
        
        .link-btn:hover {
            color: var(--turquesa-light);
        }
        
        /* ==================== FIM SRS ESTILOS ==================== */
        
        /* Bot√µes de qualidade da sess√£o do Di√°rio - estilo VRVS (fundo escuro + glow) */
        /* Base neutra dos tr√™s bot√µes */
        .diario-sessao-botoes-qualidade button {
            background: rgba(5, 25, 30, 0.96);
            border-radius: 8px;
            border-width: 1px;
            border-style: solid;
            color: #ffffff;
            box-shadow: none;
        }
        
        /* ESQUECI ‚Äì borda/glow vermelho */
        .diario-sessao-botoes-qualidade .btn-esqueci,
        .diario-sessao-botoes-qualidade .btn-danger {
            border-color: rgba(220, 53, 69, 0.85);
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-esqueci:active,
        .diario-sessao-botoes-qualidade .btn-danger:active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.5);
        }
        
        /* LEMBREI ‚Äì borda/glow √¢mbar */
        .diario-sessao-botoes-qualidade .btn-lembrei,
        .diario-sessao-botoes-qualidade .btn:not(.btn-danger):not(.btn-sucesso):not(.btn-esqueci):not(.btn-facil) {
            border-color: rgba(245, 158, 11, 0.85);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-lembrei:active,
        .diario-sessao-botoes-qualidade .btn:not(.btn-danger):not(.btn-sucesso):not(.btn-esqueci):not(.btn-facil):active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(245, 158, 11, 0.5);
        }
        
        /* F√ÅCIL ‚Äì borda/glow verde */
        .diario-sessao-botoes-qualidade .btn-facil,
        .diario-sessao-botoes-qualidade .btn-sucesso {
            border-color: rgba(34, 197, 94, 0.85);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-facil:active,
        .diario-sessao-botoes-qualidade .btn-sucesso:active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(34, 197, 94, 0.5);
        }
        
        /* Manter outros usos de btn-danger e btn-sucesso */
        .btn-danger:not(.diario-sessao-botoes-qualidade .btn-danger) {
            background: linear-gradient(135deg, 
                rgba(220, 53, 69, 0.8) 0%, 
                rgba(220, 53, 69, 1) 100%
            ) !important;
            margin-top: 12px;
        }
        
        .btn-sucesso:not(.diario-sessao-botoes-qualidade .btn-sucesso) {
            background: linear-gradient(135deg, 
                rgba(40, 167, 69, 0.8) 0%, 
                rgba(40, 167, 69, 1) 100%
            ) !important;
        }
        
        .btn-small {
            width: auto;
            padding: 10px 16px;
            font-size: 11px;
        }
        
        .btn-edit {
            background: transparent;
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--turquesa-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-edit:hover {
            border-color: var(--cobre-main);
            color: var(--cobre-light);
            background: rgba(255, 127, 80, 0.1);
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 6px 10px;
            border-radius: 8px;
            color: #EF4444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #EF4444;
            transform: scale(1.1);
        }
        
        .btn-save-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 206, 209, 0.15);
            color: rgba(0, 206, 209, 0.8);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-save-floating:hover {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.25) 0%, rgba(0, 206, 209, 0.35) 100%);
            color: #00FFE0;
            border-color: rgba(0, 206, 209, 0.5);
            box-shadow: 0 4px 20px rgba(0, 206, 209, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-save-floating:active {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.4) 0%, rgba(0, 206, 209, 0.5) 100%);
            color: #00FFE0;
            box-shadow: 0 6px 25px rgba(0, 206, 209, 0.5);
            transform: translateY(0) scale(0.98);
        }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.7),
                rgba(30, 50, 60, 0.5)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 127, 80, 0.1) 0%, 
                transparent 70%
            );
            animation: statPulse 4s ease-in-out infinite;
        }
        
        @keyframes statPulse {
            0%, 100% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(255, 127, 80, 0.5));
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(0, 206, 209, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* TASK ITEMS - CORES AJUSTADAS */
        .task-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item.priority-5 {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .task-item.priority-4 {
            border-color: var(--cobre-light);
            box-shadow: 0 0 20px rgba(255, 163, 102, 0.2);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .task-meta {
            font-size: 12px;
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-meta * {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .task-tag-area,
        .task-tag-rendimento,
        .task-tag-tipo,
        .task-tag-sessoes {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 206, 209, 0.1);
            color: rgba(255,255,255,0.9) !important;
            font-weight: 600;
        }
        
        .task-tag-area {
            color: var(--turquesa-light) !important;
        }
        
        .task-tag-rendimento {
            /* Cor j√° definida inline, mas garantir fallback */
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-tag-tipo {
            color: var(--cobre-light) !important;
        }
        
        .task-tag-sessoes {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .task-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(255, 127, 80, 0.5);
        }
        
        .task-theme-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.9)
            );
            /* backdrop-filter: blur(15px); */ /* DESABILITADO: Pode causar problemas de hit-testing no iOS Safari */
            border-left: 4px solid rgba(0, 206, 209, 0.5);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none; /* CR√çTICO iOS: Desabilita menu de contexto */
            -webkit-user-select: none; /* CR√çTICO iOS: Desabilita sele√ß√£o de texto */
            user-select: none;
        }
        .task-theme-item:hover {
            background: linear-gradient(135deg,
                rgba(30, 45, 55, 0.7),
                rgba(40, 60, 70, 0.5)
            );
            transform: translateX(4px);
        }
        .task-theme-item:active {
            transform: translateX(2px);
            opacity: 0.9;
        }
        .task-theme-item.priority-5 { border-left-color: var(--cobre-main); }
        .task-theme-item.priority-4 { border-left-color: var(--cobre-light); }
        .task-theme-item.priority-3 { border-left-color: rgba(0, 206, 209, 0.5); }
        .task-theme-item.priority-2 { border-left-color: #10B981; }
        .task-theme-item.priority-1 { border-left-color: #3B82F6; }
        
        .task-theme-name {
            color: var(--cobre-light);
            font-size: 15px;
            font-weight: 700;
        }
        
        .task-expanded {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .task-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            font-weight: 600;
        }
        
        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .task-detail-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600;
            padding: 4px 8px;
            background: rgba(0, 206, 209, 0.1);
            border-radius: 6px;
        }
        
        .task-tipo {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.2),
                rgba(13, 148, 136, 0.1)
            );
            color: var(--turquesa-light) !important;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 10px;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .task-suggestion {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .task-suggestion::before {
            content: 'üí°';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            animation: lampadaBrilho 2s ease-in-out infinite;
        }
        
        @keyframes lampadaBrilho {
            0%, 100% { 
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            }
            50% { 
                opacity: 0.9;
                filter: drop-shadow(0 0 12px rgba(255, 255, 0, 1)) drop-shadow(0 0 16px rgba(255, 255, 224, 0.8));
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .task-suggestion-label {
            color: var(--turquesa-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        .task-suggestion-text {
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            white-space: pre-line; /* CORRE√á√ÉO: Preservar quebras de linha */
        }
        
        .campos-tempo {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 206, 209, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .campos-tempo.ativo {
            display: block;
        }
        
        .campo-tempo-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .campo-tempo-row:last-child {
            margin-bottom: 0;
        }
        
        .campo-tempo-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .campo-tempo-item label {
            font-size: 10px;
            color: rgba(0, 206, 209, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .campo-tempo-item input {
            padding: 6px 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 4px;
            color: var(--text-light);
        }
        
        .campo-tempo-item input:focus {
            outline: none;
            border-color: rgba(0, 206, 209, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0, 206, 209, 0.5);
            font-size: 15px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 20px rgba(0, 206, 209, 0.3));
        }
        
        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 13px;
            /* CORRE√á√ÉO: Tabela n√£o deve ter altura limitada - mostrar todo conte√∫do */
        }
        
        /* Container de tabela n√£o deve limitar altura */
        .data-table-container,
        div[style*="overflow-x: auto"] {
            max-height: none; /* Sem limite de altura */
            overflow-x: auto; /* Scroll horizontal OK para tabelas */
            overflow-y: visible; /* Mostrar todo conte√∫do verticalmente */
        }
        
        .data-table th {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            color: var(--turquesa-light);
            padding: 12px 8px;
            font-weight: 700;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .data-table td {
            padding: 12px 8px;
            background: rgba(20, 35, 45, 0.3);
            border-top: 1px solid rgba(0, 206, 209, 0.1);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .data-table td:first-child {
            border-left: 1px solid rgba(0, 206, 209, 0.1);
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .data-table td:last-child {
            border-right: 1px solid rgba(0, 206, 209, 0.1);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .data-table tr:hover td {
            background: rgba(0, 206, 209, 0.05);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.1);
        }
        
        /* MESSAGES */
        #importMessage, #feedbackMessage {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
        }
        
        .message {
            background: linear-gradient(135deg,
                rgba(10, 26, 31, 0.95),
                rgba(20, 35, 45, 0.95)
            );
            backdrop-filter: blur(20px);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            animation: slideInMessage 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInMessage {
            from { 
                transform: translateX(120%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            border-left: 4px solid var(--turquesa-neon);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.3);
        }
        
        .message.error {
            border-left: 4px solid var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(255, 127, 80, 0.3);
        }
        
        /* NOTIFICATION ITEMS */
        .notification-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-item.urgent {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .notification-title {
            color: var(--cobre-light);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.5);
        }
        
        .notification-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        
        /* DATE RANGE CONTROLS */
        .date-range-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .date-range-controls .form-input {
            flex: 1;
        }
        
        /* EDIT DATE FORM */
        .edit-date-form {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.05),
                rgba(13, 148, 136, 0.02)
            );
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .edit-date-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .edit-date-row select {
            flex: 2;
        }
        
        .edit-date-row input {
            flex: 1;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.95)
            );
            backdrop-filter: blur(20px);
            border: 1px solid var(--cobre-main);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh; /* Desktop: 80vh */
            overflow-y: auto;
            animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlide {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            font-weight: 800;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--cobre-light);
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .modal-close:hover {
            transform: rotate(90deg);
        }
        
        /* SCROLL BAR CUSTOM */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                var(--turquesa-dark), 
                var(--cobre-dark)
            );
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                var(--turquesa-main), 
                var(--cobre-main)
            );
        }
        /* ==================== SPLASH SCREEN ==================== */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 50%, #0a1a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }
        
        #splashScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        #splashScreen.hidden {
            display: none;
        }
        
        .splash-logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.3));
            object-fit: contain;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--turquesa-neon);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 224, 0.5);
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .splash-subtitle {
            font-size: 14px;
            color: var(--turquesa-light);
            margin-bottom: 40px;
            opacity: 0.8;
        }
        
        .splash-loader {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .splash-loader::before,
        .splash-loader::after {
            content: '';
            position: absolute;
            border: 3px solid transparent;
            border-top-color: var(--turquesa-neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .splash-loader::before {
            width: 60px;
            height: 60px;
            animation-duration: 1s;
        }
        
        .splash-loader::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border-top-color: var(--cobre-light);
            animation-duration: 0.8s;
            animation-direction: reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .splash-progress {
            width: 200px;
            height: 3px;
            background: rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--turquesa-neon), var(--cobre-light));
            border-radius: 10px;
            width: 0%;
            animation: progressLoad 2s ease-out forwards;
            box-shadow: 0 0 10px rgba(0, 255, 224, 0.6);
        }
        
        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        body.splash-loading {
            overflow: hidden;
        }
        
        /* ===== NOVOS ESTILOS - REFATORA√á√ÉO v2.0 ===== */
        
        /* Sub-navega√ß√£o dentro de abas */
        .sub-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            width: fit-content;
            margin-bottom: 16px;
        }
        
        .sub-nav-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .sub-nav-btn:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sub-nav-btn.active {
            background: var(--cobre-main);
            color: white;
        }
        
        /* Toggle view (Timeline/Atrasados) */
        .toggle-view {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
            margin-bottom: 16px;
        }
        
        .toggle-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn.active {
            background: var(--turquesa-main);
            color: white;
        }
        
        /* ===== CADERNO - √ÅREAS COLAPS√ÅVEIS ===== */
        
        .area-section {
            margin-bottom: 16px;
        }
        
        .area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.1), rgba(13, 148, 136, 0.05));
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .area-header:hover {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg, rgba(255, 127, 80, 0.1), rgba(255, 127, 80, 0.05));
        }
        
        .area-header.collapsed {
            border-radius: 12px;
            margin-bottom: 0;
        }
        
        .area-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .area-header-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--turquesa-light);
        }
        
        .area-header-count {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            background: rgba(0, 206, 209, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .area-header-toggle {
            font-size: 12px;
            color: var(--turquesa-light);
            transition: transform 0.2s ease;
        }
        
        .area-header.collapsed .area-header-toggle {
            transform: rotate(-90deg);
        }
        
        /* ===== PAINEL VRVS 3P COLAPS√ÅVEL ===== */
        
        /* ===== PAINEL VRVS 3P COLAPS√ÅVEL - REFINADO ===== */
        
        .vrvs3p-card {
            background: rgba(10, 26, 31, 0.95);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .vrvs3p-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s ease;
            margin-bottom: 0;
        }
        
        .vrvs3p-header:hover {
            opacity: 0.9;
        }
        
        .vrvs3p-title {
            font-size: 18px;
            font-weight: 700;
            color: #00CED1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vrvs3p-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .vrvs3p-summary {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        
        .vrvs3p-caret {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
            transition: transform 0.3s ease;
            flex-shrink: 0;
            padding: 4px 8px;
        }
        
        .vrvs3p-body {
            padding-top: 20px;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }
        
        .vrvs3p-card.vrvs3p-collapsed .vrvs3p-body {
            max-height: 0;
            padding-top: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .vrvs3p-card:not(.vrvs3p-collapsed) .vrvs3p-body {
            max-height: 1000px;
            opacity: 1;
        }
        
        .vrvs3p-card.vrvs3p-collapsed .vrvs3p-caret {
            transform: rotate(-90deg);
        }
        
        /* Barra de reten√ß√£o */
        .vrvs3p-barra-container {
            margin-bottom: 16px;
        }
        
        .vrvs3p-barra-track {
            width: 100%;
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }
        
        .vrvs3p-barra-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 0.5s ease, background-color 0.3s ease;
        }
        
        .vrvs3p-barra-fill.baixa { background: #dc3545; }
        .vrvs3p-barra-fill.media { background: #f59e0b; }
        .vrvs3p-barra-fill.alta  { background: #22c55e; }
        
        .vrvs3p-barra-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
        }
        
        .vrvs3p-barra-percent {
            font-weight: 700;
            color: #FFFFFF;
        }
        
        .vrvs3p-barra-status {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }
        
        /* M√©tricas */
        .vrvs3p-metricas {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 20px;
            margin-bottom: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85);
        }
        
        .vrvs3p-metrica {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vrvs3p-metrica-valor {
            font-weight: 700;
            color: #00CED1;
        }
        
        .vrvs3p-metrica-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Mensagem pedag√≥gica */
        .vrvs3p-mensagem-box {
            background: rgba(0, 206, 209, 0.1);
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }
        
        .vrvs3p-mensagem-box.baixa {
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
        }
        
        .vrvs3p-mensagem-box.media {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .vrvs3p-mensagem-box.alta {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .vrvs3p-mensagem-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .vrvs3p-mensagem-emoji {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        /* Disclaimer */
        .vrvs3p-disclaimer {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            margin-top: 8px;
        }
        
        /* Responsivo */
        @media (max-width: 480px) {
            .vrvs3p-card {
                padding: 16px;
            }
            
            .vrvs3p-title {
                font-size: 16px;
            }
            
            .vrvs3p-metricas {
                font-size: 13px;
                gap: 6px 16px;
            }
            
            .vrvs3p-mensagem-box {
                padding: 12px 14px;
            }
            
            .vrvs3p-mensagem-text {
                font-size: 13px;
            }
        }
        
        .area-content {
            padding: 12px 0 0 0;
            overflow-y: auto; /* CORRE√á√ÉO: Permite scroll vertical quando expandido */
            overflow-x: hidden; /* Evita scroll horizontal */
            max-height: 70vh; /* CORRE√á√ÉO: Aumentado de 60vh para ocupar mais espa√ßo quando expandido */
            -webkit-overflow-scrolling: touch; /* CORRE√á√ÉO: Scroll suave no iOS */
            overscroll-behavior: contain; /* CORRE√á√ÉO: Evita scroll escapar para p√°gina externa */
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }
        
        /* Quando expandido (n√£o collapsed), usar mais espa√ßo */
        .area-content:not(.collapsed) {
            min-height: 40vh; /* M√≠nimo 40% da tela quando expandido */
        }
        
        .area-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0;
            overflow: hidden; /* Quando colapsado, n√£o precisa de scroll */
            min-height: 0 !important; /* Remover min-height quando colapsado */
        }
        
        /* ===== GR√ÅFICO LINHA - TOGGLES ===== */
        
        .chart-toggles {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .chart-toggle-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .chart-toggle-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chart-toggle-label input {
            margin: 0;
        }
        
        .chart-toggle-label input:checked + span {
            color: var(--turquesa-light);
        }
        
        /* ===== BOX DE ATEN√á√ÉO NO DI√ÅRIO ===== */
        
        .diario-atencao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,159,64,0.1);
            border-radius: 8px;
            border: 1px solid rgba(255,159,64,0.3);
        }
        
        .diario-atencao-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--cobre-main);
            background: rgba(0,0,0,0.25);
            cursor: pointer;
            accent-color: var(--cobre-main);
        }
        
        .diario-atencao-checkbox:checked {
            background: var(--cobre-main);
            box-shadow: 0 0 0 2px rgba(255,159,64,0.4);
        }
        
        .diario-atencao-label {
            color: var(--cobre-light);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* ===== CONTEXTO DO TEMA ===== */
        
        .contexto-container {
            background: rgba(0, 206, 209, 0.05);
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        
        .contexto-secao {
            margin-bottom: 16px;
        }
        
        .contexto-secao:last-child {
            margin-bottom: 0;
        }
        
        .contexto-secao h4 {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .contexto-item {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            padding: 4px 0;
            cursor: pointer;
        }
        
        .contexto-item:hover {
            color: var(--cobre-light);
        }
        
        /* Hot Topics - sem truncamento */
        .contexto-item-hottopics {
            max-height: none !important;
            overflow: visible !important;
            text-overflow: unset !important;
            -webkit-line-clamp: unset !important;
            line-clamp: unset !important;
            display: block;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .contexto-vazio {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-size: 12px;
        }
        
        /* ===== CADERNO - LISTA DE TEMAS ===== */
        
        .tema-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tema-item {
            background: rgba(20, 35, 45, 0.4);
            border: 1px solid rgba(0, 206, 209, 0.15);
            border-radius: 10px;
            padding: 12px 14px;
            transition: all 0.2s ease;
        }
        
        .tema-item:hover {
            border-color: rgba(255, 127, 80, 0.3);
        }
        
        .tema-item.has-content {
            border-left: 3px solid var(--turquesa-main);
        }
        
        .tema-item.has-hottopics {
            border-left: 3px solid var(--cobre-main);
        }
        
        .tema-item-conteudo {
            max-height: 0;
            overflow: hidden; /* Apenas quando colapsado */
            transition: max-height 0.3s ease-out;
            padding: 0 16px;
        }
        
        .tema-item-conteudo.collapsed {
            display: none;
            max-height: 0;
            overflow: hidden; /* Quando colapsado, esconder */
        }
        
        /* TAREFA 1: Quando expandido, permitir conte√∫do completo sem truncamento */
        .tema-item-conteudo:not(.collapsed) {
            display: block;
            padding: 12px 16px;
            overflow: visible; /* Permitir conte√∫do completo vis√≠vel */
            max-height: none !important; /* Remover qualquer limite de altura quando expandido */
        }
        
        .hottopics-label,
        .conteudo-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--turquesa-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        /* TAREFA 1: Garantir que texto aparece completo sem truncamento */
        .hottopics-text,
        .conteudo-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            white-space: pre-wrap; /* Preservar quebras de linha */
            word-wrap: break-word; /* Quebrar palavras longas */
            overflow: visible; /* Garantir que conte√∫do n√£o √© cortado */
        }
        
        .conteudo-vazio {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            padding: 12px 0;
            text-align: center;
        }
        
        /* ===== AGENDA ATRASADOS - ESTILOS ESPECIAIS ===== */
        
        .atrasados-area {
            margin-bottom: 16px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .atrasados-area-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(255,159,64,0.15);
            border: 1px solid rgba(255,159,64,0.3);
            border-left: 3px solid var(--cobre-main);
            color: var(--cobre-light);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .atrasados-area-header:hover {
            background: rgba(255,159,64,0.25);
        }
        
        .atrasados-area-nome {
            font-weight: 600;
            font-size: 14px;
            color: var(--cobre-light);
        }
        
        .atrasados-area-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255,127,80,0.3);
            color: #FFE4C4;
        }
        
        .atrasados-area-conteudo {
            padding: 8px 10px 12px;
            background: rgba(0,0,0,0.15);
        }
        
        .atrasados-area-conteudo.collapsed {
            display: none;
        }
        
        .task-date-atraso {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        .task-tag-sessoes {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }
        
        .tema-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tema-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--cobre-light);
        }
        
        .tema-item-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.6);
        }
        
        .tema-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .tema-item-btn {
            background: transparent;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .tema-item-btn:hover {
            opacity: 1;
        }
        
        /* ===== CADERNO - HOT TOPICS PREVIEW ===== */
        
        .hottopics-preview {
            background: rgba(255, 127, 80, 0.08);
            border: 1px solid rgba(255, 127, 80, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        
        .hottopics-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 6px;
        }
        
        .hottopics-content {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        /* ===== CADERNO - CONTE√öDO PREVIEW ===== */
        
        /* TAREFA 1: Remover truncamento - conte√∫do completo sempre vis√≠vel no Caderno */
        .conteudo-preview {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            /* Removido max-height e overflow: hidden para mostrar conte√∫do completo */
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative; /* Mantido para compatibilidade, mas sem ::after que cortava */
        }
        
        /* TAREFA 1: Remover efeito de fade que cortava conte√∫do */
        .conteudo-preview::after {
            display: none; /* Desabilitar pseudo-elemento que criava fade e cortava conte√∫do */
        }
        
        /* ===== CADERNO - PLACEHOLDER VAZIO ===== */
        
        .tema-item-empty {
            font-size: 12px;
            color: rgba(0, 206, 209, 0.5);
            font-style: italic;
            cursor: pointer;
            padding: 8px 0;
        }
        
        .tema-item-empty:hover {
            color: var(--cobre-light);
        }
        
        /* ===== PERFORMANCE MOBILE ===== */
        
        @media (max-width: 768px) {
            body::after {
                animation: none;
                opacity: 0.2;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="splash-loading">
    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <img src="./logo.png?v=3" alt="VRVS Logo" class="splash-logo" onerror="this.onerror=null; this.src='./logo.jpeg?v=3';">
        <div class="splash-title">VRVS</div>
        <div class="splash-subtitle">Sistema de Revis√£o e Performance</div>
        <div class="splash-loader"></div>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>
    
    <div id="importMessage"></div>
    <div id="feedbackMessage"></div>
    
    <!-- Bot√£o flutuante de salvar (sempre vis√≠vel) -->
    <button class="btn-save-floating" onclick="salvarDadosManualmente()" title="Salvar todos os dados">
        üíæ SALVAR
    </button>
    
    <!-- MODAL DE EDI√á√ÉO -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è EDITAR TEMA</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">√Årea</label>
                    <select class="form-select" id="editArea" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tema</label>
                    <input type="text" class="form-input" id="editTema" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-input" id="editPrioridade" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="Planejado">Planejado</option>
                        <option value="Em estudo">Em estudo</option>
                        <option value="Suspenso">Suspenso</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                </div>
                <button type="submit" class="btn">üíæ SALVAR ALTERA√á√ïES</button>
            </form>
        </div>
    </div>
    
    <!-- BOT√ÉO FLUTUANTE DE AJUDA -->
    <div id="btnAjudaFlutuanteContainer" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    ">
        <button id="btnAjudaFlutuante" onclick="showSection('tutorial')" style="
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--turquesa-main), var(--turquesa-dark));
            border: 2px solid var(--turquesa-light);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            ‚ùì
        </button>
        <button id="btnFecharTutorial" onclick="ocultarBotaoTutorial()" style="
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Fechar tutorial">
            √ó
        </button>
    </div>
    
    <!-- MODAL TUTORIAL INTERATIVO -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="tutorialTitulo">üéØ Tour Guiado - VRVS</h2>
                <button class="modal-close" onclick="fecharTutorial()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="tutorialConteudo" style="min-height: 200px;">
                    <!-- Conte√∫do din√¢mico do tutorial -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-secondary" onclick="pularTutorial()">Pular Tutorial</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btnAnterior" onclick="tutorialAnterior()">‚óÄ Anterior</button>
                        <button class="btn" id="btnProximo" onclick="tutorialProximo()">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                <div id="tutorialProgresso" style="margin-top: 15px; text-align: center; font-size: 12px; color: rgba(0,206,209,0.7);">
                    <!-- Passo X de Y -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVA ENTRADA DI√ÅRIO -->
    <div id="modalNovaDiario" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è NOVA ENTRADA</h2>
                <button class="modal-close" onclick="fecharModalDiario()">√ó</button>
            </div>
            
            <div class="modal-body">
                <input type="hidden" id="novaDiarioId">
                
                <div class="form-group">
                    <label class="form-label">üìÖ Data</label>
                    <input type="date" class="form-input" id="novaDiarioData">
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label class="form-label">√Årea</label>
                        <select class="form-select" id="novaDiarioArea" onchange="atualizarTemasDiario(this.value)">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label class="form-label">Tema</label>
                        <select class="form-select" id="novaDiarioTema">
                            <option value="">Selecione uma √°rea primeiro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‚ùì T√≥pico / Pergunta</label>
                    <textarea id="novaDiarioTopico" 
                        class="form-textarea" 
                        rows="3" 
                        style="min-height: 80px; resize: vertical; overflow-y: auto;"
                        placeholder="Ex: Em que n√≠vel se encerra o cone medular?"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‚úÖ Resposta</label>
                    <textarea class="form-textarea" id="novaDiarioResposta" rows="8" placeholder="Ex: Gradua em est√°gios evolutivos a artrose p√≥s meniscectomia..." style="min-height: 250px; overflow-y: auto;"></textarea>
                </div>
                
                <div class="diario-atencao-container">
                    <input
                        type="checkbox"
                        id="novaDiarioAtencao"
                        class="diario-atencao-checkbox"
                    >
                    <label for="novaDiarioAtencao" class="diario-atencao-label">
                        üìÖ Incluir nas revis√µes programadas (VRVS 3P)
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" onclick="salvarEntradaDiario()" style="flex: 1;">üíæ SALVAR</button>
                    <button type="button" class="btn btn-secondary" onclick="salvarEContinuarDiario()" style="flex: 1;">‚ûï SALVAR E ADICIONAR OUTRA</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL ENCERRAR SESS√ÉO -->
    <div id="encerrarSessaoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Resumo da Sess√£o</h2>
                <button class="modal-close" onclick="closeEncerrarSessaoModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,206,209,0.3);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo Total</div>
                            <div id="modalTempoTotal" style="font-size: 20px; font-weight: bold; color: #00FFE0;">00:00:00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Intervalos</div>
                            <div id="modalNumIntervalos" style="font-size: 20px; font-weight: bold; color: #00FFE0;">0</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Tempo Total de Intervalos</div>
                        <div id="modalTempoIntervalos" style="font-size: 16px; font-weight: bold; color: #FFA366;">0 min</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">üìù Preencha os dados da sess√£o:</div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Tempo em Quest√µes (min)</label>
                        <input type="number" class="form-input" id="modalTempoQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Quantidade de Quest√µes</label>
                        <input type="number" class="form-input" id="modalQuantQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">üÉè Tempo em Flashcards (min)</label>
                        <input type="number" class="form-input" id="modalTempoFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">üÉè Quantidade de Flashcards</label>
                        <input type="number" class="form-input" id="modalQuantFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="preencherDadosSessao()" style="flex: 1;">‚úÖ Preencher Formul√°rio</button>
                    <button class="btn btn-secondary" onclick="closeEncerrarSessaoModal()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE ATUALIZA√á√ÉO -->
    <div id="modalAtualizacao" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="atualizacaoTitulo">üéâ Nova Vers√£o Dispon√≠vel!</h2>
                <button class="modal-close" onclick="fecharModalAtualizacao()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="atualizacaoConteudo"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="iniciarTutorialAtualizacao()" style="flex: 1;">üéØ Ver Tutorial</button>
                    <button class="btn btn-secondary" onclick="fecharModalAtualizacao()" style="flex: 1;">Pular</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL EDITAR ANOTA√á√ÉO (CADERNO V2) -->
    <div id="modalEditarAnotacao" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üìù EDITAR ANOTA√á√ÉO</h2>
                <button class="modal-close" onclick="fecharModalAnotacao()">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                <input type="hidden" id="editAnotacaoTemaId">
                
                <!-- Info do tema -->
                <div style="margin-bottom: 20px; padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                    <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 4px;">TEMA</div>
                    <div id="editAnotacaoTema" style="font-size: 16px; font-weight: 600; color: var(--cobre-light);"></div>
                    <div id="editAnotacaoArea" style="font-size: 12px; color: rgba(255,255,255,0.6);"></div>
                </div>
                
                <!-- Hot Topics -->
                <div class="form-group">
                    <label class="form-label" style="color: var(--cobre-light);">üî• Hot Topics (pontos de prova)</label>
                    <textarea class="form-textarea" id="editAnotacaoHotTopics" rows="5" 
                        placeholder="1) Classifica√ß√£o de Wiltze&#10;2) T√©cnica de Gill&#10;3) Cl√≠nica do adolescente..."
                        style="background: rgba(255,127,80,0.05); border-color: rgba(255,127,80,0.3); min-height: 120px; overflow-y: auto;"></textarea>
                    <div style="font-size: 11px; color: rgba(255,127,80,0.7); margin-top: 5px;">
                        üí° Liste os pontos que mais caem na prova
                    </div>
                </div>
                
                <!-- Anota√ß√µes Gerais -->
                <div class="form-group">
                    <label class="form-label">üìù Anota√ß√µes Gerais</label>
                    <textarea class="form-textarea" id="editAnotacaoConteudo" rows="6" 
                        placeholder="Suas anota√ß√µes sobre o tema..." style="min-height: 150px; overflow-y: auto;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="salvarAnotacaoModal()" style="flex: 1;">üíæ SALVAR</button>
                    <button class="btn btn-secondary" onclick="fecharModalAnotacao()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVA √ÅREA -->
    <div id="modalNovaArea" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï NOVA √ÅREA</h2>
                <button class="modal-close" onclick="fecharModalNovaArea()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="formNovaArea" onsubmit="salvarNovaArea(event)">
                    <div class="form-group">
                        <label class="form-label">Nome da √Årea</label>
                        <input type="text" class="form-input" id="inputNovaAreaNome" placeholder="Ex: Nova √Årea de Estudo" required autofocus>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn" style="flex: 1; background: var(--cobre-main);">‚úÖ ADICIONAR</button>
                        <button type="button" class="btn btn-secondary" onclick="fecharModalNovaArea()" style="flex: 1;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL CADASTRO DE TEMA -->
    <div id="modalCadastro" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï ADICIONAR TEMA</h2>
                <button class="modal-close" onclick="fecharModalCadastro()">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                <form id="modalCadastroForm" onsubmit="salvarNovoTemaModal(event)">
                    <div class="form-group">
                        <label class="form-label">√Årea de Conhecimento</label>
                        <select class="form-select" id="modalCadastroArea" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tema Espec√≠fico</label>
                        <input type="text" class="form-input" id="modalNovoTema" placeholder="Ex: Sd manguito rotador" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridade (1-5)</label>
                        <input type="number" class="form-input" id="modalNovaPrioridade" min="1" max="5" value="3" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de In√≠cio (opcional)</label>
                        <input type="date" class="form-input" id="modalNovaDataInicio">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" style="flex: 1;">‚úÖ ADICIONAR</button>
                        <button type="button" class="btn btn-secondary" onclick="fecharModalCadastro()" style="flex: 1;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-title">üß† VRVS CIRCUIT TECH</div>
            <div class="header-subtitle">Sistema de Gest√£o de Estudos ‚Ä¢ v5.3</div>
        </div>
        
        <div class="tabs">
            <!-- ESTUDO (uso di√°rio) -->
            <div class="tab" onclick="showSection('tarefa')">üìã Tarefa</div>
            <div class="tab" onclick="showSection('feedback')">üìù Feedback</div>
            <div class="tab" onclick="showSection('diario')">üìî Di√°rio</div>
            <div class="tab" onclick="showSection('caderno')">üìì Caderno</div>
            <!-- PLANEJAMENTO -->
            <div class="tab" onclick="showSection('agenda')">üìÖ Agenda</div>
            <div class="tab active" onclick="showSection('dados')">üìä Dados</div>
            <!-- AN√ÅLISE -->
            <div class="tab" onclick="showSection('analytics')">üìà An√°lises</div>
            <!-- SISTEMA -->
            <div class="tab" onclick="showSection('backup')">üíæ Backup</div>
            <div class="tab" onclick="showSection('ajuda')">‚ùì Ajuda</div>
        </div>
        
        <div class="content">
            <!-- DADOS -->
            <div id="dados" class="section active">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>üìä BANCO DE DADOS</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-small" onclick="abrirModalNovaArea()" style="background: var(--cobre-main);">‚ûï Nova √Årea</button>
                            <button class="btn btn-small" onclick="abrirModalCadastro()" style="background: var(--cobre-main);">‚ûï Novo Tema</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-small" onclick="salvarDadosManualmente()" style="background: rgba(0, 206, 209, 0.15); color: rgba(0, 206, 209, 0.8); border: 1px solid rgba(0, 206, 209, 0.3); font-weight: 500;">
                            üíæ Salvar
                        </button>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">
                            üí° Dados salvam automaticamente
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√Årea</th>
                                    <th>Tema</th>
                                    <th>Status</th>
                                    <th>Prior.</th>
                                    <th>Rend.</th>
                                    <th>Sess√µes</th>
                                    <th>√ölt.Estudo</th>
                                    <th>Agenda</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="dadosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- TAREFA -->
            <div id="tarefa" class="section">
                <div class="card">
                    <div class="card-title">
                        <span>üìã TAREFAS DO DIA</span>
                    </div>
                    <div id="tarefasContainer"></div>
                </div>
            </div>
            
            <!-- AGENDA (inclui Pend√™ncias) -->
            <div id="agenda" class="section">
                <div class="card">
                    <div class="card-title">üìÖ AGENDA E ALERTAS</div>
                    
                    <!-- Toggle: Timeline vs Atrasados -->
                    <div class="toggle-view">
                        <button class="toggle-btn active" id="btnTimeline" onclick="setVistaAgenda('timeline')">üìÖ Timeline</button>
                        <button class="toggle-btn" id="btnAtrasados" onclick="setVistaAgenda('atrasados')">üîî Atrasados</button>
                    </div>
                    
                    <!-- Filtros (s√≥ aparece em Timeline) -->
                    <div id="agendaFiltros" class="edit-date-row" style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="date" id="agendaDataInicio" class="form-input" style="flex: 1; max-width: 180px;">
                        <input type="date" id="agendaDataFim" class="form-input" style="flex: 1; max-width: 180px;">
                        <button class="btn btn-small" onclick="filtrarSemanaAtual()">üìÖ Semana</button>
                        <button class="btn btn-small btn-secondary" onclick="renderAgendaUnificada()">Aplicar</button>
                    </div>
                    
                    <!-- Container √∫nico -->
                    <div id="agendaContainer"></div>
                </div>
            </div>

            <!-- PEND√äNCIAS (mantido para compatibilidade, oculto) -->
            <div id="pendencias" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üîî ALERTAS DO SISTEMA</div>
                    <div id="pendenciasContainer"></div>
                </div>
            </div>
            
            <!-- CADASTRO (mantido para compatibilidade, oculto - usar modal) -->
            <div id="cadastro" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">‚ûï ADICIONAR TEMA</div>
                    <form id="cadastroForm">
                        <div class="form-group">
                            <label class="form-label">√Årea de Conhecimento</label>
                            <select class="form-select" id="novaArea" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tema Espec√≠fico</label>
                            <input type="text" class="form-input" id="novoTema" placeholder="Ex: Sd manguito rotador" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√≠vel de Prioridade</label>
                            <input type="number" class="form-input" id="novaPrioridade" min="1" max="5" value="3" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="novaStatus">
                                <option value="Planejado">Planejado</option>
                                <option value="Em estudo">Em estudo</option>
                                <option value="Suspenso">Suspenso</option>
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de In√≠cio</label>
                            <input type="date" class="form-input" id="novaDataInicio">
                        </div>
                        <button type="submit" class="btn">‚úÖ ADICIONAR TEMA</button>
                    </form>
                </div>
            </div>
            
            <!-- FEEDBACK -->
            <div id="feedback" class="section">
                <div class="card">
                    <div class="card-title">üìù REGISTRAR PERFORMANCE</div>
                    
                    <!-- CRON√îMETRO DA SESS√ÉO -->
                    <div id="cronometroContainer" style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo da Sess√£o</div>
                                <div id="cronometroDisplay" style="font-size: 28px; font-weight: bold; color: #00FFE0; font-family: 'Courier New', monospace;">00:00:00</div>
                                <div id="tempoIntervaloTotal" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                    ‚è∏Ô∏è Intervalo acumulado: <span id="tempoIntervaloTotalDisplay">0 min</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button id="cronometroToggle" class="btn btn-small" onclick="toggleCronometro()">‚è±Ô∏è Iniciar Cron√¥metro</button>
                                <button id="cronometroPausa" class="btn btn-small" onclick="pausarCronometro()">‚è∏Ô∏è Pausar</button>
                                <button id="cronometroIntervalo" class="btn btn-small" onclick="iniciarIntervalo()">‚è∏Ô∏è Intervalo</button>
                                <button id="cronometroReset" class="btn btn-small" onclick="resetCronometro()">üîÑ Resetar</button>
                                <button id="cronometroEncerrar" class="btn btn-small" onclick="encerrarSessao()" style="background: rgba(0,206,209,0.2); color: #00FFE0; border: 1px solid rgba(0,206,209,0.4);">‚úÖ Encerrar Sess√£o</button>
                            </div>
                            <div id="tempoIntervalo" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                ‚è∏Ô∏è Em intervalo: <span id="tempoIntervaloDisplay">0 min</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label class="form-label">√Årea</label>
                            <select class="form-select" id="feedbackArea" onchange="updateFeedbackTemaSelect()">
                                <option value="">Selecione a √°rea...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√≥dulo Estudado</label>
                            <select class="form-select" id="feedbackTema" required>
                                <option value="">Selecione o m√≥dulo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data da Sess√£o</label>
                            <input type="date" class="form-input" id="feedbackData" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Performance (%)</label>
                            <input type="number" class="form-input" id="feedbackRendimento" min="0" max="100" placeholder="0-100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dura√ß√£o (min)</label>
                            <input type="number" class="form-input" id="feedbackTempo" min="0" placeholder="Minutos (opcional)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìä Intervalos (opcional)</label>
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                <input type="number" class="form-input" id="feedbackNumeroIntervalos" min="0" placeholder="N√∫mero de pausas" value="0">
                                <input type="text" class="form-input" id="feedbackIntervalos" placeholder="Ex: 00:05:00, 00:03:30" style="font-size: 12px;">
                            </div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Use o bot√£o "Encerrar Sess√£o" no cron√¥metro para preencher automaticamente
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‚ùì Quest√µes (opcional)</label>
                            <input type="text" class="form-input" id="feedbackQuestoes" placeholder="Ex: 15/20 (acertos/total)" pattern="[0-9]+/[0-9]+">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Formato: acertos/total (ex: 17/20)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üÉè Flashcards (opcional)</label>
                            <input type="number" class="form-input" id="feedbackFlashcards" min="0" placeholder="Quantidade revisada">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Quantidade de flashcards revisados na sess√£o
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diretriz Pr√≥xima Sess√£o</label>
                            <textarea class="form-textarea" id="feedbackSugestao" rows="4" placeholder="Ex: Revisar flashcards + quest√µes" style="min-height: 100px; overflow-y: auto;"></textarea>
                        </div>
                        <button type="submit" class="btn">‚úÖ SALVAR PERFORMANCE</button>
                    </form>
                    <button class="btn btn-danger" onclick="desfazerUltimoFeedback()">‚Ü©Ô∏è DESFAZER √öLTIMO</button>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div id="stats" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISES</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTemas">0</div>
                            <div class="stat-label">M√≥dulos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessoes">0</div>
                            <div class="stat-label">Sess√µes Totais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRendimento">0%</div>
                            <div class="stat-label">Performance M√©dia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTempo">0h</div>
                            <div class="stat-label">Tempo Investido</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statQuestoes">0</div>
                            <div class="stat-label">Quest√µes Resolvidas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statFlashcards">0</div>
                            <div class="stat-label">Flashcards Revisados</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìà VISUALIZA√á√ïES</div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartBarras" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <div id="chartLinhaControles" class="chart-toggles"></div>
                        <canvas id="chartLinha" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartRadar" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- AN√ÅLISES DETALHADAS -->
            <div id="analises" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üîç AN√ÅLISES DETALHADAS</span>
                        <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px; padding: 6px 12px;">
                            <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar An√°lises de Tempo</span>
                        </button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                                <option value="">Todos os temas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Per√≠odo</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                                <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">Semana Atual</button>
                                <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">M√™s Atual</button>
                                <button class="btn btn-small" onclick="limparFiltrosAnalise()">Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analiseResultados" style="margin-top: 30px;">
                        <!-- Resultados ser√£o renderizados aqui -->
                    </div>
                    
                    <div id="analiseTempo" style="display: none; margin-top: 30px;">
                        <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- HIST√ìRICO -->
            <div id="historico" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìú REGISTRO COMPLETO</div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tema</th>
                                    <th>√Årea</th>
                                    <th>Rend.</th>
                                    <th>Tempo</th>
                                    <th>Diretriz</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISE POR PER√çODO</div>
                    <div class="date-range-controls">
                        <input type="date" class="form-input" id="relatorioDataInicio">
                        <input type="date" class="form-input" id="relatorioDataFim">
                        <button class="btn btn-small" onclick="gerarRelatorio()">Gerar</button>
                    </div>
                    <div id="relatorioResultado"></div>
                    <button class="btn btn-secondary" onclick="exportarRelatorioPeriodo()" style="display:none; margin-top: 20px;" id="btnExportarRelatorio">
                        üì• Exportar Per√≠odo
                    </button>
                </div>
            </div>
            
            <!-- IMPORTAR -->
            <!-- Se√ß√£o antiga removida - importa√ß√£o agora est√° na aba Backup -->
            
            <!-- EXPORTAR -->
            <div id="exportar" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üì§ BACKUP DE DADOS</div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="margin-bottom: 12px;">üíæ SALVAR DADOS AGORA</button>
                        <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 20px;">
                            üí° Salva todos os dados no navegador (dados, hist√≥rico, lembretes, anota√ß√µes)
                        </div>
                    </div>
                    <div class="card-title" style="margin-top: 30px; margin-bottom: 15px; font-size: 14px;">üìä EXPORTAR PARA ARQUIVO</div>
                    <button class="btn btn-secondary" onclick="exportarDados()">üìä Baixar DADOS.csv</button>
                    <button class="btn btn-secondary" onclick="exportarHistorico()" style="margin-top: 12px;">üìú Baixar HISTORICO.csv</button>
                    <button class="btn btn-secondary" onclick="exportarAnotacoes()" style="margin-top: 12px;">üìî Baixar ANOTACOES.csv</button>
                </div>
            </div>
            
            <!-- TUTORIAL E AJUDA -->
            <div id="tutorial" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">‚ùì TUTORIAL E AJUDA</div>
                    
                    <!-- V√≠deo Tutorial -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìπ V√≠deo Explicativo</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2); text-align: center;">
                            <div id="videoTutorialContainer">
                                <div id="videoAnimado" style="background: linear-gradient(135deg, rgba(0,206,209,0.1), rgba(13,148,136,0.05)); border-radius: 8px; padding: 20px; min-height: 400px; position: relative; overflow: hidden;">
                                    <div id="videoSlide" style="text-align: center; padding: 20px;">
                                        <!-- Slides ser√£o inseridos aqui dinamicamente -->
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;">
                                        <button class="btn btn-small" onclick="videoAnterior()" id="btnVideoAnterior" style="font-size: 12px;">‚óÄ Anterior</button>
                                        <button class="btn btn-small" onclick="videoProximo()" id="btnVideoProximo" style="font-size: 12px;">Pr√≥ximo ‚ñ∂</button>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px; font-size: 12px; color: rgba(0,206,209,0.7);">
                                        <span id="videoProgresso">1 / 6</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tour Guiado -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado Interativo</h3>
                        <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                            Um guia passo a passo por todas as funcionalidades
                        </p>
                    </div>
                    
                    <!-- Assistente de D√∫vidas -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üí¨ Assistente de D√∫vidas</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                            <input type="text" id="perguntaAssistente" class="form-input" placeholder="Digite sua d√∫vida aqui... Ex: Como adicionar um tema?" style="margin-bottom: 15px;">
                            <button class="btn btn-secondary" onclick="responderDuvida()">üîç Buscar Resposta</button>
                            <div id="respostaAssistente" style="margin-top: 20px; display: none;">
                                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--turquesa-light);">
                                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                                    <div id="textoResposta" style="color: var(--text-light); font-size: 14px; line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ R√°pido -->
                    <div>
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Perguntas Frequentes</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-small" onclick="mostrarResposta('adicionar')" style="text-align: left; justify-content: flex-start;">‚ùì Como adicionar um tema?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('feedback')" style="text-align: left; justify-content: flex-start;">‚ùì Como registrar uma sess√£o de estudos?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('agenda')" style="text-align: left; justify-content: flex-start;">‚ùì Como usar a agenda?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('stats')" style="text-align: left; justify-content: flex-start;">‚ùì Como ver minhas estat√≠sticas?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('backup')" style="text-align: left; justify-content: flex-start;">‚ùì Como fazer backup dos dados?</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LEMBRETES -->
            <div id="lembretes" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìå LEMBRETES E ANOTA√á√ïES</div>
                    <div style="margin-bottom: 20px;">
                        <form id="lembreteForm">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo do Lembrete</label>
                                <input type="text" class="form-input" id="lembreteTitulo" placeholder="Ex: Revisar vias de acesso do cotovelo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descri√ß√£o (opcional)</label>
                                <textarea class="form-input" id="lembreteDescricao" rows="3" placeholder="Detalhes adicionais..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Periodicidade</label>
                                <select class="form-select" id="lembretePeriodicidade" required>
                                    <option value="pontual">Pontual (apenas uma vez)</option>
                                    <option value="diaria">Di√°ria</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="quinzenal">Quinzenal (15 dias)</option>
                                    <option value="mensal">Mensal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vincular ao Tema (opcional)</label>
                                <select class="form-select" id="lembreteTemaId">
                                    <option value="">Nenhum (lembrete geral)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Inicial</label>
                                <input type="date" class="form-input" id="lembreteDataInicial" required>
                            </div>
                            <button type="submit" class="btn">‚ûï Adicionar Lembrete</button>
                        </form>
                    </div>
                    <div id="lembretesContainer"></div>
                </div>
            </div>
            
            <!-- DI√ÅRIO -->
            <div id="diario" class="section">
                <div class="card">
                    <div class="card-title diario-header-row">
                        <div class="diario-header-left">
                        <span>üìî DI√ÅRIO DE APRENDIZADOS</span>
                            <div id="vrvs3p-chip-diario" onclick="irParaPainelVrvs3p(); event.stopPropagation();">
                                üß† <span id="vrvs3p-chip-text">Carregando...</span>
                            </div>
                        </div>
                        <button onclick="abrirNovaEntradaDiario()" id="btnNovaDiario" class="btn-nova-diario" style="background: #FF9F40 !important; color: #FFFFFF !important; border: 2px solid #FFB84D !important; padding: 10px 18px !important; border-radius: 8px !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; min-width: 90px !important; box-shadow: 0 2px 8px rgba(255, 159, 64, 0.4) !important; transition: all 0.2s ease; display: inline-block !important; position: relative !important; z-index: 10 !important; -webkit-tap-highlight-color: rgba(255, 159, 64, 0.5); text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important; opacity: 1 !important; visibility: visible !important;">+ Nova</button>
                    </div>
                    
                    <!-- Tabs Lista / Sess√£o -->
                    <div class="diario-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button id="diarioTabLista" class="diario-tab active" onclick="setAbaDiario('lista')">
                            üìã Lista
                        </button>
                        <button id="diarioTabSessao" class="diario-tab" onclick="setAbaDiario('sessao')">
                            üîÅ Sess√£o
                        </button>
                    </div>
                    
                    <!-- Wrapper da LISTA (conte√∫do atual) -->
                    <div id="diarioListaWrapper">
                    <!-- Toggle de Modo -->
                    <div class="diario-modos" style="margin-bottom: 16px; display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; width: fit-content;">
                        <button class="modo-btn active" id="modoRecall" onclick="setModoDiario('recall')" style="background: var(--cobre-main); border: none; color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                            üß† Recall
                        </button>
                        <button class="modo-btn" id="modoRespostas" onclick="setModoDiario('respostas')" style="background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                            üìñ Respostas
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="diario-filtros" style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                        <select class="form-select form-select-sm" id="filtroDiarioVista" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                            <option value="data">üìÖ Por Data</option>
                            <option value="tema">üìÅ Por Tema</option>
                        </select>
                        <select class="form-select form-select-sm" id="filtroDiarioArea" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                            <option value="">Todas as √°reas</option>
                        </select>
                        <input type="date" class="form-input form-input-sm" id="filtroDiarioData" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                    </div>
                    
                    <!-- Se√ß√£o "Revisar Hoje" (itens com ‚ö†Ô∏è) -->
                        <div id="diarioRevisarHoje" style="display: none; background: rgba(255,127,80,0.1); border: 1px solid rgba(255,127,80,0.3); border-radius: 12px; padding: 14px; margin-bottom: 20px; max-height: none; overflow-y: visible;"></div>
                    
                    <!-- Container principal -->
                    <div id="diarioContainer"></div>
                    </div>
                    
                    <!-- Wrapper da SESS√ÉO -->
                    <div id="diarioSessaoWrapper" style="display:none;">
                        <div class="diario-sessao-modos" style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button id="sessaoDiarioProgramado"
                                    class="diario-sessao-modo-btn active"
                                    onclick="setModoSessaoDiario('programado')">
                                üìÖ Revis√£o programada
                            </button>
                            <button id="sessaoDiarioLivre"
                                    class="diario-sessao-modo-btn"
                                    onclick="setModoSessaoDiario('livre')">
                                üß™ Treino livre
                            </button>
                        </div>
                        <div id="diarioSessao" style="margin-top: 12px;">
                            <!-- JS injeta aqui o card da sess√£o ou a mensagem "sem cards" -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CADERNO -->
            <!-- CADERNO (v2 - √°reas colaps√°veis) -->
            <div id="caderno" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>üìì CADERNO DE ANOTA√á√ïES</span>
                        <button class="btn btn-small" onclick="exportarHotTopicsHTML()" style="background: var(--cobre-main);">üî• Exportar HTML</button>
                    </div>
                    
                    <!-- Filtro compacto -->
                    <div style="margin-bottom: 16px;">
                        <select class="form-select" id="cadernoFiltroArea" onchange="renderCadernoV2()" style="max-width: 300px;">
                            <option value="">Todas as √°reas</option>
                        </select>
                    </div>
                    
                    <!-- Container com √°reas colaps√°veis -->
                    <div id="cadernoAreasContainer"></div>
                </div>
            </div>
            
            <!-- AN√ÅLISES (Stats + An√°lises + Relat√≥rios + Hist√≥rico) -->
            <div id="analytics" class="section">
                <div class="card">
                    <div class="card-title">üìà AN√ÅLISES</div>
                    
                    <!-- Sub-navega√ß√£o -->
                    <div class="sub-nav">
                        <button class="sub-nav-btn active" id="btnAnalyticsResumo" onclick="setVistaAnalytics('resumo')">üìä Resumo</button>
                        <button class="sub-nav-btn" id="btnAnalyticsGraficos" onclick="setVistaAnalytics('graficos')">üìà Gr√°ficos</button>
                        <!-- Detalhado temporariamente removido - precisa reimplementa√ß√£o -->
                        <button class="sub-nav-btn" id="btnAnalyticsHistorico" onclick="setVistaAnalytics('historico')">üìú Hist√≥rico</button>
                    </div>
                    
                    <!-- Container din√¢mico -->
                    <div id="analyticsContainer"></div>
                </div>
            </div>
            
            <!-- BACKUP (Importar + Exportar) -->
            <div id="backup" class="section">
                <div class="card">
                    <div class="card-title">üíæ BACKUP E RESTAURA√á√ÉO</div>
                    
                    <!-- Exportar -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì§ EXPORTAR DADOS</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportarDados()">üìä DADOS.csv</button>
                            <button class="btn btn-secondary" onclick="exportarHistorico()">üìú HISTORICO.csv</button>
                            <button class="btn btn-secondary" onclick="exportarAnotacoes()">üìî ANOTACOES.csv</button>
                            <button class="btn btn-secondary" onclick="exportarDiarioCSV()">üìî DIARIO.csv</button>
                            <button class="btn" onclick="exportarHotTopicsHTML()" style="background: var(--cobre-main);">üî• Hot Topics HTML</button>
                        </div>
                    </div>
                    
                    <!-- Importar -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì• IMPORTAR DADOS</h3>
                        <div class="form-group">
                            <label class="form-label">Arquivo DADOS.csv</label>
                            <input type="file" class="form-input" id="importDados" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo HISTORICO.csv</label>
                            <input type="file" class="form-input" id="importHistorico" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo ANOTACOES.csv (opcional)</label>
                            <input type="file" class="form-input" id="importAnotacoes" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo DIARIO.csv (opcional)</label>
                            <input type="file" class="form-input" id="importDiario" accept=".csv">
                        </div>
                        <button class="btn" onclick="importarArquivos()">üì• PROCESSAR IMPORTA√á√ÉO</button>
                        
                        <div style="border-top: 1px solid rgba(0,206,209,0.3); margin-top: 20px; padding-top: 20px;">
                            <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì• IMPORTAR BACKUP COMPLETO (JSON)</h3>
                            <div class="form-group">
                                <label class="form-label">Arquivo Backup Completo VRVS (.json)</label>
                                <input type="file" class="form-input" id="importBackupJSON" accept=".json">
                            </div>
                            <button class="btn" onclick="importarBackupJSON()" style="background: var(--turquesa-main);">üì• RESTAURAR BACKUP COMPLETO</button>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                                ‚ö†Ô∏è Esta opera√ß√£o substitui TODOS os dados atuais pelos do backup. Fa√ßa backup antes de restaurar!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reset -->
                    <div style="border-top: 1px solid rgba(255,127,80,0.3); padding-top: 20px;">
                        <h3 style="color: var(--cobre-light); font-size: 14px; margin-bottom: 15px;">‚ö†Ô∏è ZONA DE PERIGO</h3>
                        <button class="btn btn-danger" onclick="limparTudo()">üóëÔ∏è RESET COMPLETO</button>
                        <div style="font-size: 11px; color: rgba(255,127,80,0.7); margin-top: 8px;">
                            ‚ö†Ô∏è Esta a√ß√£o apaga TODOS os dados. Fa√ßa backup antes!
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AJUDA (Tutorial + Lembretes) -->
            <div id="ajuda" class="section">
                <div class="card">
                    <div class="card-title">‚ùì AJUDA E CONFIGURA√á√ïES</div>
                    
                    <!-- Sub-navega√ß√£o -->
                    <div class="sub-nav">
                        <button class="sub-nav-btn active" id="btnAjudaTutorial" onclick="setVistaAjuda('tutorial')">üìö Tutorial</button>
                        <button class="sub-nav-btn" id="btnAjudaLembretes" onclick="setVistaAjuda('lembretes')">üìå Lembretes</button>
                        <button class="sub-nav-btn" id="btnAjudaFaq" onclick="setVistaAjuda('faq')">üí¨ FAQ</button>
                    </div>
                    
                    <!-- Container din√¢mico -->
                    <div id="ajudaContainer"></div>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        // Fun√ß√£o para corrigir invers√£o √°rea‚Üîtema ANTES de carregar dados
        function fixAreaTemaObjeto(obj) {
            if (!obj) return obj;
            const area = String(obj.area || '');
            const tema = String(obj.tema || '');
            // Se √°rea est√° muito longa (>20) E tema cont√©m palavra-chave de √°rea, inverter
            const areaLikeKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'mao', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'pe', 'tornozelo', 'coluna', 'oncologia', 'tumores', 'mmss', 'mmii'];
            const temaPareceArea = areaLikeKeywords.some(k => tema.toLowerCase().includes(k));
            if (area.length > 20 && temaPareceArea) {
                const tmp = obj.area;
                obj.area = obj.tema;
                obj.tema = tmp;
            }
            return obj;
        }
        
        // ==================== FUN√á√ïES DE SEGURAN√áA ====================
        
        function fazerBackupCompleto() {
            const backup = {
                schemaVersion: 'VRVS_BACKUP_v1',
                timestamp: new Date().toISOString(),
                dados: JSON.parse(localStorage.getItem('vrvs_dados') || '[]'),
                historico: JSON.parse(localStorage.getItem('vrvs_historico') || '[]'),
                anotacoes: JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]'),
                lembretes: JSON.parse(localStorage.getItem('vrvs_lembretes') || '[]'),
                diario: JSON.parse(localStorage.getItem('vrvs_diario') || '{"entradas":[],"schemaVersion":"1.0"}'),
                config: JSON.parse(localStorage.getItem('vrvs_config') || '{}')
            };
            
            const backupKey = `vrvs_backup_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify(backup));
            
            // Manter apenas √∫ltimos 5 backups
            const backupKeys = Object.keys(localStorage)
                .filter(k => k.startsWith('vrvs_backup_'))
                .sort()
                .reverse();
            
            if (backupKeys.length > 5) {
                backupKeys.slice(5).forEach(k => localStorage.removeItem(k));
            }
            
            console.log(`[BACKUP] Backup criado: ${backupKey}`);
            return backupKey;
        }
        
        // Exportar backup completo em JSON (download)
        function exportarBackupJSON() {
            try {
                const backup = {
                    schemaVersion: 'VRVS_BACKUP_v1',
                    createdAt: new Date().toISOString(),
                    vrvs_dados: JSON.parse(localStorage.getItem('vrvs_dados') || '[]'),
                    vrvs_historico: JSON.parse(localStorage.getItem('vrvs_historico') || '[]'),
                    vrvs_anotacoes: JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]'),
                    vrvs_lembretes: JSON.parse(localStorage.getItem('vrvs_lembretes') || '[]'),
                    vrvs_diario: JSON.parse(localStorage.getItem('vrvs_diario') || '{"entradas":[],"schemaVersion":"1.0"}'),
                    vrvs_config: JSON.parse(localStorage.getItem('vrvs_config') || '{}')
                };
                
                // Contar itens para preview
                const totalDados = backup.vrvs_dados.length;
                const totalHistorico = backup.vrvs_historico.length;
                const totalAnotacoes = backup.vrvs_anotacoes.length;
                const totalLembretes = backup.vrvs_lembretes.length;
                const totalDiario = backup.vrvs_diario.entradas?.length || 0;
                
                const jsonStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const hoje = new Date().toISOString().split('T')[0];
                const hora = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                a.download = `vrvs_backup_${hoje}_${hora}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarNotificacaoFeedback(`‚úÖ Backup completo exportado! (${totalDados} temas, ${totalHistorico} sess√µes, ${totalAnotacoes} anota√ß√µes, ${totalLembretes} lembretes, ${totalDiario} entradas do Di√°rio)`);
            } catch (error) {
                console.error('[BACKUP] Erro ao exportar JSON:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao exportar backup. Verifique o console.', 'error');
            }
        }
        
        // Importar backup completo em JSON
        function importarBackupJSON() {
            const fileInput = document.getElementById('importBackupJSON');
            const file = fileInput?.files[0];
            
            if (!file) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione um arquivo de backup JSON!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onerror = () => {
                mostrarNotificacaoFeedback('‚ùå Erro ao ler arquivo!', 'error');
            };
            
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar schemaVersion
                    if (!backup.schemaVersion || backup.schemaVersion !== 'VRVS_BACKUP_v1') {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Arquivo n√£o √© um backup VRVS v√°lido (schemaVersion incorreto)', 'error');
                        return;
                    }
                    
                    // Mostrar preview antes de restaurar
                    const totalDados = backup.vrvs_dados?.length || 0;
                    const totalHistorico = backup.vrvs_historico?.length || 0;
                    const totalAnotacoes = backup.vrvs_anotacoes?.length || 0;
                    const totalLembretes = backup.vrvs_lembretes?.length || 0;
                    const totalDiario = backup.vrvs_diario?.entradas?.length || 0;
                    
                    const confirmacao = confirm(
                        `Este backup cont√©m:\n` +
                        `‚Ä¢ ${totalDados} temas\n` +
                        `‚Ä¢ ${totalHistorico} sess√µes\n` +
                        `‚Ä¢ ${totalAnotacoes} anota√ß√µes\n` +
                        `‚Ä¢ ${totalLembretes} lembretes\n` +
                        `‚Ä¢ ${totalDiario} entradas do Di√°rio\n\n` +
                        `‚ö†Ô∏è ATEN√á√ÉO: Esta opera√ß√£o substituir√° TODOS os dados atuais!\n\n` +
                        `Deseja continuar?`
                    );
                    
                    if (!confirmacao) return;
                    
                    // Fazer backup antes de restaurar
                    fazerBackupCompleto();
                    
                    // Restaurar dados
                    if (backup.vrvs_dados) {
                        localStorage.setItem('vrvs_dados', JSON.stringify(backup.vrvs_dados));
                        dados = backup.vrvs_dados;
                    }
                    
                    if (backup.vrvs_historico) {
                        localStorage.setItem('vrvs_historico', JSON.stringify(backup.vrvs_historico));
                        historico = backup.vrvs_historico;
                    }
                    
                    if (backup.vrvs_anotacoes) {
                        localStorage.setItem('vrvs_anotacoes', JSON.stringify(backup.vrvs_anotacoes));
                        anotacoes = backup.vrvs_anotacoes;
                    }
                    
                    if (backup.vrvs_lembretes) {
                        localStorage.setItem('vrvs_lembretes', JSON.stringify(backup.vrvs_lembretes));
                    }
                    
                    // CR√çTICO: Restaurar Di√°rio com SRS completo
                    if (backup.vrvs_diario) {
                        localStorage.setItem('vrvs_diario', JSON.stringify(backup.vrvs_diario));
                        window.diario = backup.vrvs_diario;
                        
                        // Migrar SRS se necess√°rio (mas n√£o resetar se j√° est√° completo)
                        migrarSRSParaVRVS3P();
                    }
                    
                    if (backup.vrvs_config) {
                        localStorage.setItem('vrvs_config', JSON.stringify(backup.vrvs_config));
                    }
                    
                    // Re-renderizar tudo
                    renderDados();
                    renderTarefas();
                    renderAgenda();
                    renderHistorico();
                    renderPendencias();
                    renderCaderno();
                    renderDiario();
                    updateStats();
                    
                    mostrarNotificacaoFeedback('‚úÖ Backup restaurado com sucesso! Todos os dados foram atualizados.');
                } catch (error) {
                    console.error('[BACKUP] Erro ao importar JSON:', error);
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao importar backup. Verifique se o arquivo √© v√°lido.', 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        function validarAntesDeSalvar(tipo, dados) {
            const erros = [];
            
            switch(tipo) {
                case 'anotacoes':
                    dados.forEach((a, idx) => {
                        if (!a.id) erros.push(`Anota√ß√£o ${idx} sem ID`);
                    });
                    break;
                case 'diario':
                    renderDiario();
                    break;
                    if (dados.entries) {
                        dados.entries.forEach((e, idx) => {
                            if (!e.id) erros.push(`Entrada ${idx} sem ID`);
                            if (!e.data) erros.push(`Entrada ${idx} sem data`);
                            if (!e.topico) erros.push(`Entrada ${idx} sem t√≥pico`);
                        });
                    }
                    break;
                case 'dados':
                    dados.forEach((d, idx) => {
                        if (!d.id) erros.push(`Tema ${idx} sem ID`);
                        if (!d.area) erros.push(`Tema ${idx} sem √°rea`);
                        if (!d.tema) erros.push(`Tema ${idx} sem tema`);
                    });
                    break;
            }
            
            if (erros.length > 0) {
                console.error('[VALIDA√á√ÉO] Erros encontrados:', erros);
                throw new Error(`Valida√ß√£o falhou: ${erros.join(', ')}`);
            }
            
            return true;
        }
        
        function mesclarAnotacoes(novas, existentes) {
            const mescladas = [...existentes];
            const idsExistentes = new Set(existentes.map(a => a.id));
            
            novas.forEach(nova => {
                // Procurar por ID ou temaId (para mesclar anota√ß√µes do mesmo tema)
                const existente = existentes.find(a => 
                    a.id === nova.id || 
                    (String(a.temaId) === String(nova.temaId) && String(nova.temaId) !== '')
                );
                
                if (existente) {
                    // Mesclar preservando hotTopics se ambos existirem (priorizar o novo se n√£o vazio)
                    if (nova.hotTopics !== undefined && nova.hotTopics !== null && nova.hotTopics.trim() !== '') {
                        existente.hotTopics = nova.hotTopics;
                    }
                    // Mesclar conte√∫do geral (preservar existente se novo estiver vazio)
                    if (nova.conteudo !== undefined && nova.conteudo !== null && nova.conteudo.trim() !== '') {
                        existente.conteudo = nova.conteudo;
                    }
                    // Atualizar outros campos
                    Object.assign(existente, nova);
                } else {
                    // Garantir que hotTopics existe mesmo se vazio
                    if (!nova.hotTopics) nova.hotTopics = '';
                    mescladas.push(nova);
                }
            });
            
            return mescladas;
        }
        
        // √Åreas fixas do sistema
        const AREAS_FIXAS = [
            'Ci√™ncias B√°sicas',
            'Coluna',
            'Joelho',
            'M√£o',
            'Ombro e Cotovelo',
            'Oncologia',
            'Ortopedia Pedi√°trica',
            'P√© e Tornozelo',
            'Quadril',
            'Trauma MMII',
            'Trauma MMSS',
            'Trauma Pedi√°trico'
        ];
        
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        
        let dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
        let historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
        let lembretes = JSON.parse(localStorage.getItem('vrvs_lembretes') || '[]');
        let anotacoes = JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]'); // Anota√ß√µes por tema
        
        // Aplicar corre√ß√£o de invers√£o √°rea/tema nos dados carregados
        if (Array.isArray(dados)) {
            dados = dados.map(d => fixAreaTemaObjeto(d));
        }
        
        // Limpar dados corrompidos
        function limparDadosCorretos() {
            const dadosOriginais = dados.length;
            dados = dados.filter(t => {
                if (!t.area || t.area.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.area && t.area.toLowerCase().includes('sugest')) return false;
                if (!t.tema || t.tema.toLowerCase().includes('revisao ativa') || t.tema.toLowerCase().includes('revis√£o ativa')) return false;
                if (t.tema.length > 100) return false;
                if (t.tema.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.tema.includes('Sugest√£o:') || t.tema.includes('sugest√£o:')) return false;
                if ((t.tema.match(/\|/g) || []).length > 2) return false;
                return true;
            });
            
            if (dados.length < dadosOriginais) {
                console.log(`üßπ Limpeza: removidos ${dadosOriginais - dados.length} registros corrompidos`);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            }
        }
        
        limparDadosCorretos();
        
        // Fun√ß√£o para limpar hist√≥rico inv√°lido (usada na inicializa√ß√£o e ap√≥s importa√ß√£o)
        function limparHistoricoInvalido() {
            const historicoOriginal = historico.length;
            
            historico = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historico.length < historicoOriginal) {
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                console.log(`üßπ Limpeza: removidos ${historicoOriginal - historico.length} registros inv√°lidos do hist√≥rico`);
            }
        }
        
        limparHistoricoInvalido(); // Limpar hist√≥rico inv√°lido na inicializa√ß√£o
        
        // CORRE√á√ÉO URGENTE: Normalizar √°reas duplicadas em todos os dados
        function normalizarAreasEmMassa() {
            let alteracoes = 0;
            
            // Normalizar dados
            if (Array.isArray(dados)) {
                dados.forEach(t => {
                    const areaAntiga = t.area;
                    t.area = normalizarArea(t.area);
                    if (areaAntiga !== t.area) alteracoes++;
                });
            }
            
            // Normalizar hist√≥rico
            if (Array.isArray(historico)) {
                historico.forEach(h => {
                    const areaAntiga = h.area;
                    h.area = normalizarArea(h.area);
                    if (areaAntiga !== h.area) alteracoes++;
                });
            }
            
            // Normalizar anota√ß√µes
            if (Array.isArray(anotacoes)) {
                anotacoes.forEach(a => {
                    if (a.area) {
                        const areaAntiga = a.area;
                        a.area = normalizarArea(a.area);
                        if (areaAntiga !== a.area) alteracoes++;
                    }
                });
            }
            
            // Normalizar di√°rio
            try {
                const diarioSalvo = localStorage.getItem('vrvs_diario');
                if (diarioSalvo) {
                    const diario = JSON.parse(diarioSalvo);
                    if (diario && Array.isArray(diario.entradas)) {
                        diario.entradas.forEach(e => {
                            if (e.area) {
                                const areaAntiga = e.area;
                                e.area = normalizarArea(e.area);
                                if (areaAntiga !== e.area) alteracoes++;
                            }
                        });
                        localStorage.setItem('vrvs_diario', JSON.stringify(diario));
                    }
                }
            } catch (e) {
                console.warn('[NORMALIZA√á√ÉO] Erro ao normalizar di√°rio:', e);
            }
            
            // Salvar dados normalizados
            if (alteracoes > 0) {
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                console.log(`‚úÖ Normaliza√ß√£o: ${alteracoes} √°reas corrigidas`);
            }
        }
        
        // Executar normaliza√ß√£o na inicializa√ß√£o
        normalizarAreasEmMassa();
        
        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function mostrarNotificacaoFeedback(mensagem, tipo = 'success') {
            const container = document.getElementById('feedbackMessage');
            container.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function extrairUltimaSugestao(observacoes) {
            if (!observacoes) return '';
            const linhas = observacoes.split('\n');
            for (let i = linhas.length - 1; i >= 0; i--) {
                const linha = linhas[i];
                if (linha.includes('Sugest√£o:') || linha.includes('sugest√£o:')) {
                    const partes = linha.split(/[Ss]ugest√£o:/);
                    if (partes.length > 1) {
                        return partes[1].trim().replace(/^\|/, '').replace(/\|$/, '').trim();
                    }
                }
            }
            return '';
        }
        
        function obterSugestaoTema(tema) {
            if (!tema) return '';
            if (tema.sugestao && tema.sugestao !== '-' && tema.sugestao.trim() !== '') {
                return tema.sugestao.trim();
            }
            return extrairUltimaSugestao(tema.observacoes);
        }

        function calcularTipoRevisao(tema) {
            const rend = tema.rendimento || 0;
            const sess = tema.sessoes || 0;
            
            if (sess === 0) return 'üÜï Primeira sess√£o';
            if (sess === 1) return '‚ö° Quest√µes/flashcards';
            if (rend < 0.50) return 'üìö Revisar teoria completa';
            if (rend < 0.60) return 'üìπ Aula + quest√µes';
            if (rend < 0.80) return 'üìñ Resumo + quest√µes';
            return '‚ö° Quest√µes/flashcards';
        }
        
        // CORRE√á√ÉO: Normaliza√ß√£o robusta de √°reas para evitar duplicatas
        function normalizarArea(area) {
            if (!area || typeof area !== 'string') return '';
            
            // Normalizar: remover espa√ßos extras, converter para min√∫sculas, remover acentos
            const areaNormalizada = area.trim().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' '); // Normalizar espa√ßos m√∫ltiplos
            
            // Mapa completo de varia√ß√µes para √°reas fixas
            const mapaNormalizacao = {
                // Ci√™ncias B√°sicas
                'ciencias basicas': 'Ci√™ncias B√°sicas',
                
                // Ortopedia Pedi√°trica
                'ortopedia pediatrica': 'Ortopedia Pedi√°trica',
                
                // M√£o e Punho ‚Üí M√£o (unificar todas varia√ß√µes)
                'mao e punho': 'M√£o',
                'm√£o e punho': 'M√£o',
                'mao': 'M√£o',
                'm√£o': 'M√£o',
                'punho': 'M√£o',
                
                // Trauma MMSS
                'trauma mmss': 'Trauma MMSS',
                'trauma membros superiores': 'Trauma MMSS',
                
                // Trauma MMII
                'trauma mmii': 'Trauma MMII',
                'trauma membros inferiores': 'Trauma MMII',
                
                // Ombro e Cotovelo
                'ombro e cotovelo': 'Ombro e Cotovelo',
                'ombro': 'Ombro e Cotovelo',
                'cotovelo': 'Ombro e Cotovelo',
                
                // Outras √°reas (manter como est√£o)
                'joelho': 'Joelho',
                'quadril': 'Quadril',
                'pelve': 'Quadril',
                'pe e tornozelo': 'P√© e Tornozelo',
                'p√© e tornozelo': 'P√© e Tornozelo',
                'tornozelo': 'P√© e Tornozelo',
                'coluna': 'Coluna',
                'oncologia': 'Oncologia',
                'tumores': 'Oncologia',
                'trauma pediatrico': 'Trauma Pedi√°trico',
                'trauma pedi√°trico': 'Trauma Pedi√°trico',
                'trauma ped': 'Trauma Pedi√°trico',
                'trauma pediat': 'Trauma Pedi√°trico'
            };
            
            // Verificar se √°rea normalizada est√° no mapa
            if (mapaNormalizacao[areaNormalizada]) {
                return mapaNormalizacao[areaNormalizada];
            }
            
            // Se n√£o est√° no mapa, verificar se j√° √© uma √°rea fixa (case-insensitive)
            const areaFixasLower = AREAS_FIXAS.map(a => a.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''));
            const index = areaFixasLower.indexOf(areaNormalizada);
            if (index !== -1) {
                return AREAS_FIXAS[index]; // Retornar vers√£o correta com acentos
            }
            
            // Fallback: capitalizar primeira letra de cada palavra
            return area.trim().replace(/\b\w/g, m => m.toUpperCase());
        }
        
        // Manter fun√ß√£o antiga para compatibilidade (chama a nova)
        function normalizeArea(rawArea, tema) {
            return normalizarArea(rawArea);
        }
        
        function fixAreaTema(area, tema) {
            if (!area || !tema) return { area: area || '', tema: tema || '' };
            
            // Verificar se √°rea e tema est√£o invertidos
            // Se o "tema" parece ser uma √°rea (cont√©m palavras-chave de √°rea)
            const areaKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'tornozelo', 'coluna', 'oncologia', 'tumores'];
            const temaLower = String(tema).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Se tema cont√©m palavras-chave de √°rea e √°rea n√£o, provavelmente est√£o invertidos
            const temaEhArea = areaKeywords.some(keyword => temaLower.includes(keyword));
            const areaEhArea = areaKeywords.some(keyword => String(area).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(keyword));
            
            if (temaEhArea && !areaEhArea) {
                // Est√£o invertidos, trocar
                return { area: normalizeArea(tema, ''), tema: area };
            }
            
            return { area: normalizeArea(area, tema), tema: tema };
        }
        
        function dataValida(data) {
            if (!data || data === '-' || String(data).trim() === '') return false;
            try {
                const dt = new Date(data + 'T00:00:00');
                return !isNaN(dt.getTime());
            } catch (e) {
                return false;
            }
        }
        
        function formatarDataBR(data) {
            if (!dataValida(data)) return '-';
            try {
                return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            } catch (e) {
                return '-';
            }
        }
        
        function formatarData(dataStr) {
            // Mantida para compatibilidade - usa formatarDataBR internamente
            return formatarDataBR(dataStr);
        }
        
        function calcularProximaRevisao(tema, dataSessao = null) {
            // CORRE√á√ÉO: Conclu√≠do n√£o entra no algoritmo - retornar vazio
            if (tema.status === 'Conclu√≠do') {
                return '';
            }
            
            // CORRE√á√ÉO: Usar data da sess√£o se fornecida, sen√£o usar data atual
            const dataBase = dataSessao ? new Date(dataSessao + 'T00:00:00') : new Date();
            dataBase.setHours(0, 0, 0, 0);
            
            // CORRE√á√ÉO CR√çTICA: Se √© PRIMEIRA sess√£o (contador = 1 OU √∫ltima data = null), sempre +1 dia
            const sessoes = tema.sessoes || 0;
            const ultEstudo = tema.ultEstudo || null;
            
            if (sessoes === 0 || sessoes === 1 || !ultEstudo || ultEstudo === null || ultEstudo === '') {
                const proxima = new Date(dataBase);
                proxima.setDate(proxima.getDate() + 1);
                return proxima.toISOString().split('T')[0];
            }
            
            // SOMENTE ap√≥s segunda sess√£o em diante: aplicar algoritmo normal
            const rendimento = Math.round((tema.rendimento || 0) * 100);
            const prioridade = parseInt(tema.prioridade) || 3;
            const contador80 = parseInt(tema.contador80) || 0;
            let intervalo = 1;
            
            if (rendimento < 50) {
                intervalo = 1;
            } else if (rendimento >= 50 && rendimento < 80) {
                intervalo = 3;
            } else {
                if (contador80 === 0) intervalo = 7;
                else if (contador80 === 1) intervalo = 14;
                else if (contador80 === 2) intervalo = 30;
                else intervalo = 60;
                
                if (prioridade === 5 && intervalo > 30) {
                    intervalo = 30;
                }
            }
            
            const proxima = new Date(dataBase);
            proxima.setDate(proxima.getDate() + intervalo);
            return proxima.toISOString().split('T')[0];
        }

        // ==================== MODAL DE EDI√á√ÉO ====================
        
        function openEditModal(id) {
            const tema = dados.find(t => t.id == id);
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Popular select de √°reas com AREAS_FIXAS
            const editAreaSelect = document.getElementById('editArea');
            if (editAreaSelect) {
                editAreaSelect.innerHTML = '<option value="">Selecione...</option>' + 
                    AREAS_FIXAS.map(area => `<option value="${area}">${area}</option>`).join('') +
                    '<option value="__NOVA_AREA__">‚ûï Adicionar Nova √Årea...</option>';
            }
            
            // Garantir que input est√° escondido ao abrir modal
            const editAreaInput = document.getElementById('editAreaInput');
            if (editAreaInput) {
                editAreaInput.style.display = 'none';
                editAreaInput.required = false;
            }
            
            document.getElementById('editId').value = tema.id;
            editAreaSelect.value = tema.area || '';
            document.getElementById('editTema').value = tema.tema;
            document.getElementById('editPrioridade').value = tema.prioridade || 3;
            document.getElementById('editStatus').value = tema.status || 'Planejado';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea no cadastro
        function handleNovaAreaChange(select) {
            handleAreaChange(select, 'novaAreaInput');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea na edi√ß√£o
        function handleEditAreaChange(select) {
            handleAreaChange(select, 'editAreaInput');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea no modal de dados
        function handleModalNovaAreaChange(select) {
            handleAreaChange(select, 'modalNovaAreaInput');
        }
        
        // Fun√ß√£o gen√©rica para abrir input de nova √°rea (chamada pelo bot√£o)
        function abrirInputNovaArea(selectId, inputId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (!select || !input) return;
            
            // Esconder select e mostrar input
            select.style.display = 'none';
            input.style.display = 'block';
            input.value = '';
            input.focus();
            input.required = true;
            
            // Quando perder foco ou pressionar Enter, salvar e voltar para select
            const salvarEVoltar = function() {
                const valorDigitado = input.value.trim();
                if (valorDigitado) {
                    // Normalizar √°rea
                    const areaNormalizada = normalizarArea(valorDigitado);
                    
                    // Adicionar ao select se n√£o existir
                    const opcoes = Array.from(select.options).map(opt => opt.value);
                    if (!opcoes.includes(areaNormalizada)) {
                        const novaOpcao = document.createElement('option');
                        novaOpcao.value = areaNormalizada;
                        novaOpcao.textContent = areaNormalizada;
                        select.appendChild(novaOpcao);
                    }
                    
                    // Selecionar a √°rea normalizada
                    select.value = areaNormalizada;
                    
                    // Trigger change event para atualizar depend√™ncias (temas, etc)
                    select.dispatchEvent(new Event('change'));
                }
                
                // Voltar para select
                select.style.display = 'block';
                input.style.display = 'none';
                input.required = false;
                input.onblur = null;
                input.onkeypress = null;
            };
            
            input.onblur = salvarEVoltar;
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    salvarEVoltar();
                }
            };
        }
        
        // Fun√ß√£o gen√©rica para gerenciar adi√ß√£o de nova √°rea
        function handleAreaChange(select, inputId) {
            const areaInput = document.getElementById(inputId);
            if (!areaInput) return;
            
            if (select.value === '__NOVA_AREA__') {
                // Mostrar input e esconder select
                select.style.display = 'none';
                areaInput.style.display = 'block';
                areaInput.value = '';
                areaInput.focus();
                areaInput.required = true;
                
                // Quando perder foco ou pressionar Enter, voltar para select
                areaInput.onblur = function() {
                    const valorDigitado = areaInput.value.trim();
                    if (valorDigitado) {
                        // Normalizar e adicionar ao select se n√£o existir
                        const areaNormalizada = normalizarArea(valorDigitado);
                        select.value = areaNormalizada;
                        
                        // Se n√£o est√° nas √°reas fixas, adicionar como op√ß√£o tempor√°ria
                        const opcoes = Array.from(select.options).map(opt => opt.value);
                        if (!opcoes.includes(areaNormalizada) && areaNormalizada !== '__NOVA_AREA__') {
                            // Adicionar antes da op√ß√£o "__NOVA_AREA__"
                            const novaOpcao = document.createElement('option');
                            novaOpcao.value = areaNormalizada;
                            novaOpcao.textContent = areaNormalizada;
                            select.insertBefore(novaOpcao, select.lastElementChild);
                        }
                    }
                    
                    // Voltar para select
                    select.style.display = 'block';
                    areaInput.style.display = 'none';
                    areaInput.required = false;
                    areaInput.onblur = null;
                };
                
                areaInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        areaInput.blur();
                    }
                };
            } else {
                // Esconder input se selecionar outra op√ß√£o
                areaInput.style.display = 'none';
                areaInput.required = false;
            }
        }

        // ==================== RENDERIZA√á√ÉO DE COMPONENTES ====================
        
        function renderPendencias() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const hojeStr = hoje.toISOString().split('T')[0];
            
            // Data limite: hoje - 7 dias
            const limite = new Date(hoje);
            limite.setDate(limite.getDate() - 7);
            const limiteStr = limite.toISOString().split('T')[0];
            
            const container = document.getElementById('pendenciasContainer');
            
            const pendencias = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                if (!dataValida(t.agenda)) return false;
                // Tarefas com mais de 7 dias de atraso
                const agendaDate = new Date(t.agenda + 'T00:00:00');
                const limiteDate = new Date(limiteStr + 'T00:00:00');
                return agendaDate < limiteDate;
            });
            
            if (pendencias.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma pend√™ncia!</div></div>';
                return;
            }
            
            // Ordenar: mais recente primeiro, depois menos sess√µes
            pendencias.sort((a, b) => {
                const diffData = new Date(b.agenda) - new Date(a.agenda);
                if (diffData !== 0) return diffData;
                return (a.sessoes || 0) - (b.sessoes || 0);
            });
            
            // Vari√°vel para controlar pend√™ncias expandidas
            let pendenciasExpandidas = window.pendenciasExpandidas || new Set();
            window.pendenciasExpandidas = pendenciasExpandidas;
            
            container.innerHTML = pendencias.map(t => {
                // CORRE√á√ÉO: Garantir que ID seja sempre v√°lido e consistente (sempre string)
                const temaId = t.id != null ? String(t.id) : null;
                if (!temaId) {
                    console.warn('[PENDENCIAS] Tema sem ID v√°lido:', t.tema);
                    return '';
                }
                
                // DEBUG: Log para identificar problemas com IDs espec√≠ficos
                if (['Fratura de clav√≠cula', 'Epifisiolistese', 'Sd manguito rotador', 'DDQ', 'Luxa√ß√£o e Instabilidade do cotovelo', 'LAC/LEC', 'Epicondilites', 'Fraturas do cotovelo'].includes(t.tema)) {
                    console.log('[PENDENCIAS DEBUG] Tema:', t.tema, 'ID:', temaId, 'Tipo ID original:', typeof t.id);
                }
                
                // CORRE√á√ÉO: Garantir que compara√ß√£o no Set use sempre string
                const isExpanded = pendenciasExpandidas.has(temaId);
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const dataFormatada = formatarDataBR(t.agenda);
                const diasAtraso = Math.floor((new Date(hojeStr) - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CORRE√á√ÉO DEFINITIVA: Bug onclick com IDs contendo underscore
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PROBLEMA IDENTIFICADO:
                // - JSON.stringify retorna aspas duplas: '"1733174400000_5"'
                // - Quando interpolado em onclick="...", fecha aspas prematuramente
                // - HTML gerado: onclick="togglePendencia("1733174400000_5")" = INV√ÅLIDO
                //
                // SOLU√á√ÉO CORRETA (Opus):
                // - Escape manual de aspas simples e barras
                // - Usar aspas SIMPLES no onclick (n√£o conflita com aspas duplas do HTML)
                // - HTML gerado: onclick="togglePendencia('1733174400000_5')" = V√ÅLIDO
                // Escape para onclick inline (solu√ß√£o simples que funciona)
                const temaIdStr = String(temaId);
                const temaIdEscaped = temaIdStr.replace(/'/g, "\\'").replace(/\\/g, "\\\\");
                
                return `
                <div class="task-theme-item priority-${t.prioridade || 3}" data-tema-id="${temaIdStr}" onclick="togglePendencia('${temaIdEscaped}')" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(255,127,80,0.3); cursor: pointer;">
                    <div class="task-theme-name" style="pointer-events: none; user-select: none;">${t.tema}</div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 4px; pointer-events: none; user-select: none;">üìö ${t.area} ‚Ä¢ ‚ö†Ô∏è ${diasAtraso} dias atrasado</div>
                    ${isExpanded ? `
                    <div class="task-expanded" style="pointer-events: none;">
                        <div class="task-details">
                            <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                            <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                            <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                            <div class="task-detail-item">üìÖ ${dataFormatada}</div>
                </div>
                        ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                        ${sugestao ? `
                        <div class="task-suggestion">
                            <div class="task-suggestion-label">Diretriz</div>
                            <div class="task-suggestion-text">${sugestao}</div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }
        
        // REMOVIDO: inicializarEventListenersPendencias()
        // Usando onclick inline diretamente no HTML (mesma solu√ß√£o das outras abas que funcionam)
        // Event delegation estava causando m√∫ltiplos listeners e travamentos
        
        // Vari√°vel global para controlar visibilidade dos campos de tempo
        window.camposTempoVisiveis = false;
        
        function toggleCamposTempo() {
            window.camposTempoVisiveis = !window.camposTempoVisiveis;
            const toggleText = document.getElementById('toggleTempoText');
            if (toggleText) {
                toggleText.textContent = window.camposTempoVisiveis ? '‚è±Ô∏è Ocultar Tempos' : '‚è±Ô∏è Mostrar Tempos';
            }
            renderTarefas();
            renderAgenda();
        }
        
        window.togglePendencia = function(temaId) {
            // DEBUG: Log para identificar problemas
            console.log('[PENDENCIAS] togglePendencia chamado com temaId:', temaId, 'tipo:', typeof temaId);
            
            // CORRE√á√ÉO: Validar ID antes de processar
            if (temaId == null || temaId === '') {
                console.warn('[PENDENCIAS] Tentativa de toggle com ID inv√°lido:', temaId);
                return;
            }
            
            // Garantir que temaId seja string para compara√ß√£o consistente
            temaId = String(temaId);
            
            // DEBUG: Log espec√≠fico para itens problem√°ticos
            const temasProblema = ['Fratura de clav√≠cula', 'Epifisiolistese', 'Sd manguito rotador', 'DDQ', 'Luxa√ß√£o e Instabilidade do cotovelo', 'LAC/LEC', 'Epicondilites', 'Fraturas do cotovelo'];
            const tema = dados.find(t => String(t.id) === temaId);
            if (tema && temasProblema.includes(tema.tema)) {
                console.log('[PENDENCIAS DEBUG] Item problem√°tico detectado:', tema.tema, 'ID:', temaId);
            }
            
            if (!window.pendenciasExpandidas) {
                window.pendenciasExpandidas = new Set();
            }
            if (window.pendenciasExpandidas.has(temaId)) {
                window.pendenciasExpandidas.delete(temaId);
            } else {
                window.pendenciasExpandidas.add(temaId);
            }
            renderPendencias();
            // REMOVIDO: N√£o precisa re-inicializar listeners ap√≥s cada toggle
            // Isso estava causando m√∫ltiplos listeners e travamentos
        };
        
        // ==================== CONTEXTO DO TEMA (Fase 4.1) ====================
        
        // Buscar contexto relacionado a um tema (Di√°rio ‚ö†Ô∏è, Hot Topics, Anota√ß√µes)
        function buscarContextoTema(area, tema) {
            const contexto = {
                atencao: [], // Entradas do Di√°rio com ‚ö†Ô∏è
                hotTopics: [],
                anotacoes: []
            };
            
            // 1. Buscar itens ‚ö†Ô∏è do Di√°rio
            if (window.diario && window.diario.entradas) {
                contexto.atencao = window.diario.entradas.filter(e => 
                    e.area === area && 
                    e.tema === tema && 
                    e.atencao === true
                );
            }
            
            // 2. Buscar Hot Topics e Anota√ß√µes do Caderno
            const anotacoesTema = anotacoes.filter(a => 
                a.area === area && 
                a.tema === tema
            );
            
            anotacoesTema.forEach(anot => {
                if (anot.hotTopics && anot.hotTopics.trim()) {
                    contexto.hotTopics.push({
                        texto: anot.hotTopics.trim(),
                        temaId: anot.temaId // Incluir temaId para navega√ß√£o
                    });
                }
                if (anot.conteudo && anot.conteudo.trim()) {
                    contexto.anotacoes.push(anot);
                }
            });
            
            return contexto;
        }
        
        // Renderizar contexto do tema em container
        function renderContextoTema(contexto, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            // Render se√ß√£o Aten√ß√£o (‚ö†Ô∏è)
            if (contexto.atencao.length > 0) {
                html += `
                    <div class="contexto-secao">
                        <h4>‚ö†Ô∏è PONTOS DE ATEN√á√ÉO (Di√°rio)</h4>
                        ${contexto.atencao.map(item => `
                            <div class="contexto-item" onclick="navegarParaEntradaDiario('${item.id}')">
                                ‚Ä¢ ${item.topico}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Render Hot Topics (com link para Caderno)
            if (contexto.hotTopics.length > 0) {
                // Usar temaId do primeiro hotTopic (j√° inclu√≠do na busca)
                const temaId = contexto.hotTopics[0]?.temaId || contexto.anotacoes[0]?.temaId || null;
                html += `
                    <div class="contexto-secao">
                        <h4>üìå HOT TOPICS</h4>
                        ${contexto.hotTopics.map(ht => `
                            <div class="contexto-item contexto-item-hottopics" ${temaId ? `onclick="navegarParaCadernoTema('${temaId}')"` : ''} style="${temaId ? 'cursor: pointer;' : ''}">‚Ä¢ ${ht.texto}</div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Render Anota√ß√µes (com link para Caderno)
            if (contexto.anotacoes.length > 0) {
                const temaId = contexto.anotacoes[0].temaId;
                html += `
                    <div class="contexto-secao">
                        <h4>üìù ANOTA√á√ïES (Caderno)</h4>
                        <div class="contexto-item" onclick="navegarParaCadernoTema('${temaId}')" style="cursor: pointer;">
                            ${contexto.anotacoes.length} anota√ß√£o(√µes) dispon√≠vel(eis) ‚Üí Clique para ver
                        </div>
                    </div>
                `;
            }
            
            // Se n√£o tiver nada
            if (!html) {
                html = '<div class="contexto-vazio">Nenhum contexto adicional dispon√≠vel</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Navegar para entrada espec√≠fica do Di√°rio
        function navegarParaEntradaDiario(entradaId) {
            // Mostrar se√ß√£o Di√°rio
            showSection('diario');
            
            // Filtrar para mostrar apenas a entrada espec√≠fica
            setTimeout(() => {
                // Tentar encontrar e destacar a entrada
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (entrada) {
                    // Filtrar Di√°rio para mostrar apenas esta entrada
                    const container = document.getElementById('diarioContainer');
                    if (container) {
                        // Renderizar apenas esta entrada destacada
                        container.innerHTML = `
                            <div style="background: rgba(0,206,209,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 2px solid var(--turquesa-main);">
                                <div style="font-size: 12px; color: var(--turquesa-light); margin-bottom: 8px;">
                                    üìç Entrada destacada
                                </div>
                                ${renderEntradaDiario(entrada)}
                            </div>
                            <button onclick="renderDiario()" class="btn btn-small" style="margin-bottom: 16px;">
                                ‚Üê Voltar para todas as entradas
                            </button>
                        `;
                    }
                }
            }, 300);
            }
            
        // ==================== SRS - INTEGRA√á√ÉO COM TAREFAS ====================
        
        // Contar quantos cards do Di√°rio est√£o programados para hoje dentro de um tema
        function contarDiarioProgramadoParaTema(area, tema) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return 0;
            const hoje = hojeStr();
            return window.diario.entradas.filter(e =>
                e.area === area &&
                e.tema === tema &&
                e.srs &&
                e.srs.ativo &&
                (e.srs.proximaRevisao || hoje) <= hoje
            ).length;
        }
        
        // Abrir sess√£o do Di√°rio filtrada por tema
        function abrirSessaoDiarioParaTema(area, tema) {
            // Guardar filtros espec√≠ficos da sess√£o chamada pela aba Tarefas
            window.filtrosSessaoDiario = {
                area: area || null,
                tema: tema || null,
                origem: 'tarefa'   // Para debug e identifica√ß√£o
            };
            
            // Ajustar filtros do Di√°rio na UI (opcional, para visual)
            const filtroArea = document.getElementById('filtroDiarioArea');
            if (filtroArea) filtroArea.value = area || '';
            
            // Trocar para aba Di√°rio da aplica√ß√£o geral
            showSection('diario');
            
            // Abrir aba "Sess√£o"
            setTimeout(() => {
                setAbaDiario('sessao');
                // Garantir modo programado por padr√£o
                setModoSessaoDiario('programado');
            }, 100);
        }
        
        // ==================== FIM SRS INTEGRA√á√ÉO TAREFAS ====================
        
        // Navegar para tema espec√≠fico no Caderno
        function navegarParaCadernoTema(temaId) {
            const temaIdStr = String(temaId);
            
            // 1. Garantir que anota√ß√£o existe (sem criar lixo)
            if (typeof obterOuCriarAnotacao === 'function') {
                obterOuCriarAnotacao(temaIdStr);
            }
            
            // 2. Encontrar tema nos dados globais
            const tema = dados.find(t => String(t.id) === String(temaIdStr));
            if (!tema) {
                console.warn('[CADERNO] Tema n√£o encontrado:', temaIdStr);
                return;
            }
            
            // 3. Setar filtro de √°rea
            const selectArea = document.getElementById('cadernoFiltroArea');
            if (selectArea) {
                selectArea.value = tema.area || '';
            }
            
            // 4. Navegar para aba Caderno
            showSection('caderno');
            
            // 5. Renderizar Caderno
            setTimeout(() => {
                if (typeof renderCadernoV2 === 'function') {
                renderCadernoV2();
                } else if (typeof renderCaderno === 'function') {
                    renderCaderno();
                }
                
                // 6. Ap√≥s render, expandir e scrollar
                // TAREFA 1 FIX: Aumentar timeout para garantir DOM totalmente renderizado
                setTimeout(() => {
                    const temaIdClean = temaIdStr;
                    
                    // Expandir √°rea (adaptar ao ID real)
                    const areaId = (tema.area || '')
                        .replace(/\s+/g, '-')
                        .replace(/[^a-zA-Z0-9-]/g, '');
                    const areaContent = document.getElementById(`area-content-${areaId}`);
                    if (areaContent && areaContent.classList.contains('collapsed')) {
                        if (typeof toggleAreaCaderno === 'function') {
                            toggleAreaCaderno(areaId);
                        }
                    }
                    
                    // Expandir tema - TAREFA 1 FIX: Garantir que CSS seja aplicado corretamente
                    setTimeout(() => {
                        const temaConteudo = document.getElementById(`tema-conteudo-${temaIdClean}`);
                        if (temaConteudo) {
                            // For√ßar expans√£o manual para garantir CSS correto
                            if (temaConteudo.classList.contains('collapsed')) {
                                temaConteudo.classList.remove('collapsed');
                                temaConteudo.style.display = 'block';
                                
                                // TAREFA 1 FIX: For√ßar altura completa sem limita√ß√£o
                                // Aguardar um frame para scrollHeight estar correto
                                requestAnimationFrame(() => {
                                    const scrollHeight = temaConteudo.scrollHeight || 0;
                                    temaConteudo.style.maxHeight = Math.max(scrollHeight + 100, 9999) + 'px';
                                    temaConteudo.style.overflow = 'visible';
                                    
                                    // Garantir que CSS de texto completo seja aplicado
                                    const hottopicsText = temaConteudo.querySelector('.hottopics-text');
                                    const conteudoText = temaConteudo.querySelector('.conteudo-text');
                                    if (hottopicsText) {
                                        hottopicsText.style.whiteSpace = 'pre-wrap';
                                        hottopicsText.style.wordWrap = 'break-word';
                                        hottopicsText.style.overflow = 'visible';
                                    }
                                    if (conteudoText) {
                                        conteudoText.style.whiteSpace = 'pre-wrap';
                                        conteudoText.style.wordWrap = 'break-word';
                                        conteudoText.style.overflow = 'visible';
                                    }
                                    
                                    // Scroll e highlight ap√≥s garantir conte√∫do completo
                                    setTimeout(() => {
                                        const elemento = document.querySelector(`[data-tema-id="${temaIdClean}"]`) || temaConteudo;
                    if (elemento) {
                        elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                            
                                            const originalBg = elemento.style.background;
                                            elemento.style.background = 'rgba(0, 206, 209, 0.22)';
                                            elemento.style.transition = 'background 0.3s ease';
                        setTimeout(() => {
                                                elemento.style.background = originalBg || '';
                        }, 2000);
                    }
            }, 100);
                                });
                            }
                        }
                    }, 150); // Aumentado de 0 para 150ms para garantir √°rea expandida primeiro
                }, 300); // Aumentado de 200ms para 300ms para garantir renderiza√ß√£o completa
            }, 200); // Aumentado de 100ms para 200ms para garantir showSection completou
        }
        
        // Toggle mostrar/ocultar contexto do tema
        function toggleContextoTema(temaId) {
            const containerId = `contexto-tema-${temaId}`;
            const container = document.getElementById(containerId);
            const botao = document.querySelector(`[onclick="toggleContextoTema('${temaId}')"]`);
            
            if (!container) return;
            
            if (container.style.display === 'none' || !container.style.display) {
                // Mostrar contexto
                container.style.display = 'block';
                if (botao) botao.textContent = 'üëÅÔ∏è OCULTAR CONTEXTO';
                
                // Buscar e renderizar contexto se ainda n√£o foi renderizado
                if (!container.innerHTML || container.innerHTML.trim() === '') {
                    const tema = dados.find(t => String(t.id) === String(temaId));
                    if (tema) {
                        const contexto = buscarContextoTema(tema.area, tema.tema);
                        renderContextoTema(contexto, containerId);
                    }
                }
            } else {
                // Ocultar contexto
                container.style.display = 'none';
                if (botao) botao.textContent = 'üëÅÔ∏è MOSTRAR CONTEXTO';
            }
        }
        
        // Helper: Renderizar card de tema (reutiliz√°vel)
        function renderCardTemaHTML(t, hojeStr, contagemDiarioPorTema = {}) {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const isHoje = t.agenda === hojeStr;
                const dataFormatada = formatarDataBR(t.agenda);
                
                // Contagem de di√°rio ativo para este tema
                const qtdAtivos = contagemDiarioPorTema[`${t.area}|${t.tema}`] || 0;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}" style="margin-bottom: 12px;">
                    <div class="task-name" style="display: flex; align-items: center; gap: 8px;">
                        <span>${t.tema} ${isHoje ? 'üéØ' : ''}</span>
                        ${qtdAtivos > 0 ? `<span class="vrvs3p-pill-tema" title="T√≥picos ativos no Di√°rio" style="margin-left: 8px; padding: 2px 8px; border-radius: 999px; font-size: 11px; background: rgba(5, 25, 30, 0.96); border: 1px solid rgba(0, 206, 209, 0.5); opacity: 0.9; color: rgba(255,255,255,0.9);">üß† ${qtdAtivos}</span>` : ''}
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                        <div class="task-detail-item">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <button onclick="toggleContextoTema('${t.id}')" style="background: rgba(0,206,209,0.15); border: 1px solid rgba(0,206,209,0.3); color: var(--turquesa-light); padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px; width: 100%; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(0,206,209,0.25)'" onmouseout="this.style.background='rgba(0,206,209,0.15)'">
                        üëÅÔ∏è MOSTRAR CONTEXTO
                    </button>
                    
                    <div id="contexto-tema-${t.id}" class="contexto-container" style="display: none; margin-top: 12px;"></div>
                    
                    ${(() => {
                        const qtdDiario = contarDiarioProgramadoParaTema(t.area, t.tema);
                        if (qtdDiario > 0) {
                            return `
                                <div class="tema-diario-bloco" style="background: rgba(255,127,80,0.1); border: 1px solid rgba(255,127,80,0.3); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--cobre-light); margin-bottom: 6px;">üìî Di√°rio de Aprendizados</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                                        Voc√™ tem <strong style="color: var(--cobre-light);">${qtdDiario} t√≥pico${qtdDiario > 1 ? 's' : ''} deste tema</strong> para revisar hoje.
                            </div>
                                    <button class="btn btn-small" onclick="abrirSessaoDiarioParaTema('${t.area}', '${t.tema}')" style="width: 100%; background: var(--cobre-main); color: white; border: none;">
                                        üîÅ Abrir sess√£o do Di√°rio
                                    </button>
                            </div>
                            `;
                        }
                        return '';
                    })()}
                        </div>
            `;
        }
        
        function renderTarefas() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const hojeStr = hoje.toISOString().split('T')[0];
            
            const container = document.getElementById('tarefasContainer');
            let html = '';
            
            // ===== CALCULAR CONTAGEM DE DI√ÅRIO ATIVO POR TEMA (uma vez s√≥) =====
            const contagemDiarioPorTema = {};
            if (window.diario && Array.isArray(window.diario.entradas)) {
                window.diario.entradas.forEach(e => {
                    if (!e.srs || !e.srs.ativo) return;
                    const chave = `${e.area}|${e.tema}`;
                    contagemDiarioPorTema[chave] = (contagemDiarioPorTema[chave] || 0) + 1;
                });
            }
            
            // ===== BOX "REVIS√ïES DO DIA" =====
            // Contar t√≥picos do Di√°rio programados para hoje
            const entradasHoje = getEntradasParaRevisarHojeDiario({ area: null, tema: null });
            const totalTopicos = entradasHoje.length;
            
            if (totalTopicos > 0) {
                // Contar temas distintos
                const temasDistintos = new Set(entradasHoje.map(e => `${e.area}|${e.tema}`));
                const qtdTemas = temasDistintos.size;
                
                html += `
                    <div class="revisoes-dia-box" style="background: rgba(255, 159, 64, 0.10); border: 1px solid rgba(255, 159, 64, 0.30); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 15px; font-weight: 600; color: var(--cobre-light);">üìÖ REVIS√ïES DO DIA</span>
                            <span style="font-size: 13px; font-weight: 600; color: var(--cobre-light);">${totalTopicos} t√≥pico${totalTopicos > 1 ? 's' : ''}</span>
                        </div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            Voc√™ tem <strong style="color: var(--cobre-light);">${totalTopicos} t√≥pico${totalTopicos > 1 ? 's' : ''}</strong> do Di√°rio para revisar hoje${qtdTemas > 1 ? ` (distribu√≠dos em ${qtdTemas} temas)` : ''}.
                        </div>
                        <button class="btn btn-small" onclick="abrirRevisoesDoDia()" style="width: 100%; background: var(--cobre-main); color: white; border: none;">
                            üîÅ REVISAR TODOS
                        </button>
                    </div>
                `;
            }
            
            // Data limite: hoje - 7 dias (tarefas com at√© 7 dias de atraso)
            const limite = new Date(hoje);
            limite.setDate(limite.getDate() - 7);
            const limiteStr = limite.toISOString().split('T')[0];
            
            const tarefas = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                if (!dataValida(t.agenda)) return false;
                // Apenas tarefas com at√© 7 dias de atraso (hoje at√© 7 dias atr√°s)
                const agendaDate = new Date(t.agenda + 'T00:00:00');
                const hojeDate = new Date(hojeStr + 'T00:00:00');
                const limiteDate = new Date(limiteStr + 'T00:00:00');
                return agendaDate <= hojeDate && agendaDate >= limiteDate;
            });
            
            if (tarefas.length === 0) {
                if (totalTopicos === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                } else {
                    container.innerHTML = html;
                }
                return;
            }
            
            // Ordenar: menos sess√µes primeiro (menos sess√µes em cima)
            tarefas.sort((a, b) => {
                // Primeiro por menos sess√µes (menos sess√µes primeiro)
                const diffSessoes = (a.sessoes || 0) - (b.sessoes || 0);
                if (diffSessoes !== 0) return diffSessoes;
                // Depois por data (mais recente primeiro)
                return new Date(b.agenda) - new Date(a.agenda);
            });
            
            // Agrupar por √°rea (sem colapso intermedi√°rio de tema)
            const porArea = {};
            tarefas.forEach(t => {
                const area = t.area || 'Outros';
                if (!porArea[area]) porArea[area] = [];
                porArea[area].push(t);
            });
            
            const areasOrdenadas = Object.keys(porArea).sort();
            
            if (areasOrdenadas.length === 0) {
                container.innerHTML = html || '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                return;
            }
            areasOrdenadas.forEach(area => {
                const areaId = `missoes-area-${area.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const temas = porArea[area];
                const totalTarefas = temas.length;
                
                // Header da √°rea (colaps√°vel leve, opcional)
                html += `
                    <div class="missoes-area" style="margin-bottom: 20px;">
                        <div class="missoes-area-header" onclick="toggleAreaCaderno('${areaId}')" style="cursor: pointer; padding: 10px 0; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,206,209,0.2);">
                            <span class="missoes-area-nome" style="font-size: 15px; font-weight: 600; color: var(--turquesa-light);">üìÅ ${area}</span>
                            <span class="missoes-area-badge" style="font-size: 12px; padding: 2px 8px; border-radius: 12px; background: rgba(0,206,209,0.2); color: rgba(255,255,255,0.9);">${totalTarefas} tarefa${totalTarefas > 1 ? 's' : ''}</span>
                            </div>
                        <div class="missoes-area-temas" id="area-content-${areaId}">
                            ${temas.map(t => renderCardTemaHTML(t, hojeStr, contagemDiarioPorTema)).join('')}
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Fun√ß√£o para abrir sess√£o de revis√µes do dia (todos os t√≥picos)
        function abrirRevisoesDoDia() {
            // Limpar filtros para pegar todos os t√≥picos do dia
            window.filtrosSessaoDiario = {
                origem: 'revisoes-do-dia'
            };
            
            // Trocar para aba Di√°rio
            showSection('diario');
            
            // Abrir aba "Sess√£o"
            setTimeout(() => {
                setAbaDiario('sessao');
                // Garantir modo programado por padr√£o
                setModoSessaoDiario('programado');
            }, 100);
        }
        
        function renderAgenda() {
            const hoje = new Date().toISOString().split('T')[0];
            
            // Per√≠odo: inputs ou default pr√≥ximos 7 dias
            const inputInicio = document.getElementById('agendaDataInicio');
            const inputFim = document.getElementById('agendaDataFim');
            let dataInicio = inputInicio && inputInicio.value ? inputInicio.value : '';
            let dataFim = inputFim && inputFim.value ? inputFim.value : '';
            
            if (!dataInicio || !dataFim) {
                const base = new Date();
                const start = new Date(base);
                const end = new Date(base);
                end.setDate(end.getDate() + 7);
                dataInicio = start.toISOString().split('T')[0];
                dataFim = end.toISOString().split('T')[0];
                if (inputInicio && !inputInicio.value) inputInicio.value = dataInicio;
                if (inputFim && !inputFim.value) inputFim.value = dataFim;
            }
            
            const agendadas = dados
                .filter(t => {
                    if (!t || !t.agenda || t.status === 'Conclu√≠do') return false;
                    if (!dataValida(t.agenda) || !dataValida(dataInicio) || !dataValida(dataFim)) return false;
                    return t.agenda >= dataInicio && t.agenda <= dataFim;
                })
                .sort((a, b) => {
                    // Primeiro por menos sess√µes (menos sess√µes primeiro)
                    const diffSessoes = (a.sessoes || 0) - (b.sessoes || 0);
                    if (diffSessoes !== 0) return diffSessoes;
                    // Depois por data (mais pr√≥ximo primeiro)
                    return a.agenda.localeCompare(b.agenda);
                });
            
            const container = document.getElementById('agendaContainer');
            if (agendadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div>Timeline vazia</div></div>';
                return;
            }
            
            container.innerHTML = agendadas.map(t => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const dataFormatada = formatarDataBR(t.agenda);
                const tipo = calcularTipoRevisao(t);
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-date">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function filtrarSemanaAtual() {
            const hoje = new Date();
            const diaSemana = hoje.getDay(); // 0=Dom, 1=Seg, ...
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            
            document.getElementById('agendaDataInicio').value = segunda.toISOString().split('T')[0];
            document.getElementById('agendaDataFim').value = domingo.toISOString().split('T')[0];
            renderAgenda();
        }
        
        function renderDados() {
            const tbody = document.getElementById('dadosTableBody');
            tbody.innerHTML = dados.map(t => {
                const ultEstudo = formatarDataBR(t.ultEstudo);
                const agenda = formatarDataBR(t.agenda);
                const rend = t.rendimento ? Math.round(t.rendimento * 100) + '%' : '-';
                const rendColor = t.rendimento >= 0.8 ? '#00FFE0' : t.rendimento >= 0.5 ? '#FFA366' : '#EF4444';
                
                return `
                    <tr>
                        <td style="color: rgba(0,206,209,0.8);">${t.area || '-'}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${t.tema || '-'}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.status || 'N√£o iniciado'}</td>
                        <td style="text-align: center; color: var(--cobre-main);">${t.prioridade || 3}</td>
                        <td style="text-align: center; color: ${rendColor};">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.sessoes || 0}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${ultEstudo}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${agenda}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit" onclick="openEditModal(${t.id})" title="Editar">üîß</button>
                            <button class="btn-delete" onclick="deletarTema(${t.id})" title="Excluir tema permanentemente">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateFeedbackSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            
            // Usar √°reas fixas como base, adicionando √°reas existentes que n√£o est√£o na lista
            const areasExistentes = [...new Set(dados.map(t => t.area).filter(a => a && a.trim()))];
            const areasCompletas = [...new Set([...AREAS_FIXAS, ...areasExistentes])].sort();
            
            areaSelect.innerHTML = '<option value="">Selecione a √°rea...</option>' +
                areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Atualizar temas baseado na √°rea selecionada
            updateFeedbackTemaSelect();
        }
        
        function preencherDropdownAreas(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Se for datalist, atualizar
            if (element.tagName === 'INPUT' && element.list) {
                const datalist = document.getElementById(element.list.id || 'listAreasFixas');
                if (datalist) {
                    datalist.innerHTML = AREAS_FIXAS.map(area => `<option value="${area}">`).join('');
                }
            }
        }
        
        function updateFeedbackTemaSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            const areaSelecionada = areaSelect.value;
            
            temaSelect.innerHTML = '<option value="">Selecione o m√≥dulo...</option>';
            
            if (!areaSelecionada) {
                // Se nenhuma √°rea selecionada, mostrar todos os temas
                temaSelect.innerHTML += dados.map(t => `<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
            } else {
                // Filtrar temas pela √°rea selecionada
                const temasFiltrados = dados.filter(t => t.area === areaSelecionada);
                temaSelect.innerHTML += temasFiltrados.map(t => `<option value="${t.id}">${t.tema}</option>`).join('');
            }
        }
        
        function deletarTema(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Confirmar exclus√£o
            const confirmacao = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO: Excluir tema "${tema.tema}"?\n\n` +
                `Isso ir√° REMOVER PERMANENTEMENTE:\n` +
                `‚Ä¢ O tema dos dados\n` +
                `‚Ä¢ Todo o hist√≥rico relacionado\n` +
                `‚Ä¢ Lembretes vinculados\n` +
                `‚Ä¢ Anota√ß√µes do caderno\n\n` +
                `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
                `Confirmar exclus√£o?`
            );
            
            if (!confirmacao) return;
            
            // Contar quantos registros ser√£o removidos
            const historicoRelacionado = historico.filter(h => String(h.temaId) === String(temaId));
            const lembretesRelacionados = lembretes.filter(l => String(l.temaId) === String(temaId));
            const anotacoesRelacionadas = anotacoes.filter(a => String(a.temaId) === String(temaId));
            
            // Remover tema dos dados
            dados = dados.filter(t => String(t.id) !== String(temaId));
            
            // Remover hist√≥rico relacionado
            historico = historico.filter(h => String(h.temaId) !== String(temaId));
            
            // Remover lembretes relacionados
            lembretes = lembretes.filter(l => String(l.temaId) !== String(temaId));
            
            // Remover anota√ß√µes relacionadas
            anotacoes = anotacoes.filter(a => String(a.temaId) !== String(temaId));
            
            // Salvar tudo no localStorage
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            
            // Mostrar resumo do que foi removido
            const resumo = [
                `‚úÖ Tema removido`,
                historicoRelacionado.length > 0 ? `${historicoRelacionado.length} registro(s) de hist√≥rico` : '',
                lembretesRelacionados.length > 0 ? `${lembretesRelacionados.length} lembrete(s)` : '',
                anotacoesRelacionadas.length > 0 ? `${anotacoesRelacionadas.length} anota√ß√£o(√µes)` : ''
            ].filter(r => r).join('\n');
            
            mostrarNotificacaoFeedback(resumo);
            
            // Atualizar todas as visualiza√ß√µes
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            renderLembretes();
            renderCaderno();
        }
        
        function desfazerUltimoFeedback() {
            if (historico.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum feedback para desfazer!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Confirma revers√£o do √∫ltimo registro?')) {
                return;
            }
            
            const ultimaSessao = historico[historico.length - 1];
            
            // CORRE√á√ÉO: Buscar tema comparando IDs como strings
            const tema = dados.find(t => String(t.id) === String(ultimaSessao.temaId));
            
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado!', 'error');
                return;
            }
            
            historico.pop();
            tema.sessoes = Math.max(0, (tema.sessoes || 1) - 1);
            tema.tempo = Math.max(0, (tema.tempo || 0) - (ultimaSessao.tempo || 0));
            
            const sessoesRestantes = historico.filter(h => String(h.temaId) === String(tema.id));
            
            if (sessoesRestantes.length > 0) {
                const somaRend = sessoesRestantes.reduce((sum, h) => sum + (h.rendimento || 0), 0);
                tema.rendimento = somaRend / sessoesRestantes.length;
                
                // Recalcular contador80
                let contador = 0;
                for (let i = sessoesRestantes.length - 1; i >= 0; i--) {
                    if ((sessoesRestantes[i].rendimento || 0) >= 0.8) {
                        contador++;
                    } else {
                        break;
                    }
                }
                tema.contador80 = contador;
                
                // Atualizar √∫ltima data e agenda
                const ultimaSessaoRestante = sessoesRestantes[sessoesRestantes.length - 1];
                tema.ultEstudo = ultimaSessaoRestante ? ultimaSessaoRestante.data : '';
                tema.agenda = calcularProximaRevisao(tema);
            } else {
                tema.rendimento = 0;
                tema.status = 'Planejado';
                tema.ultEstudo = '';
                tema.agenda = '';
                tema.contador80 = 0;
            }
            
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            
            mostrarNotificacaoFeedback('‚úÖ Revers√£o executada com sucesso!');
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
            renderPendencias();
        }

        function renderHistorico() {
            const tbody = document.getElementById('historicoTableBody');
            if (!tbody) {
                console.warn('[RENDER HISTORICO] Tbody n√£o encontrado! Verificando novamente em 100ms...');
                setTimeout(() => renderHistorico(), 100);
                return;
            }
            
            console.log('[RENDER HISTORICO] Total de registros no hist√≥rico:', historico.length);
            
            // CORRE√á√ÉO: Filtrar hist√≥rico inv√°lido (√°rea "Tema" e linhas sem dados v√°lidos)
            const historicoFiltrado = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            console.log('[RENDER HISTORICO] Registros ap√≥s filtro:', historicoFiltrado.length);
            
            if (historicoFiltrado.length === 0) {
                console.warn('[RENDER HISTORICO] Nenhum registro v√°lido encontrado ap√≥s filtro!');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                // CORRE√á√ÉO: Aplicar fixAreaTema para corrigir invers√µes
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${(h.observacoes && h.observacoes !== '-' ? h.observacoes + ' ' : '') + (h.sugestao && h.sugestao !== '-' ? h.sugestao : '') || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Defina per√≠odo completo!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= dataInicio && h.data <= dataFim;
            });
            
            if (sessoesNoPeriodo.length === 0) {
                document.getElementById('relatorioResultado').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Sem dados no per√≠odo</div></div>';
                document.getElementById('btnExportarRelatorio').style.display = 'none';
                return;
            }
            
            const totalSessoes = sessoesNoPeriodo.length;
            const totalTempo = sessoesNoPeriodo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const rendimentoMedio = Math.round((sessoesNoPeriodo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100);
            
            const porArea = {};
            sessoesNoPeriodo.forEach(h => {
                const area = h.area || 'Sem √°rea';
                if (!porArea[area]) {
                    porArea[area] = { sessoes: 0, tempo: 0, rendimento: 0 };
                }
                porArea[area].sessoes++;
                porArea[area].tempo += h.tempo || 0;
                porArea[area].rendimento += h.rendimento || 0;
            });
            
            const resultado = `
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 12px;">
                        An√°lise: ${formatarDataBR(dataInicio)} - ${formatarDataBR(dataFim)}
                    </h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalSessoes}</div>
                            <div class="stat-label">Sess√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(totalTempo / 60)}h</div>
                            <div class="stat-label">Tempo Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rendimentoMedio}%</div>
                            <div class="stat-label">Performance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(porArea).length}</div>
                            <div class="stat-label">√Åreas</div>
                        </div>
                    </div>
                    <h5 style="color: var(--turquesa-light); margin: 20px 0 12px;">Detalhamento por √Årea:</h5>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√Årea</th>
                                <th>Sess√µes</th>
                                <th>Tempo</th>
                                <th>Rendimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(porArea).map(([area, stats]) => `
                                <tr>
                                    <td style="color: var(--turquesa-light);">${area}</td>
                                    <td style="text-align: center;">${stats.sessoes}</td>
                                    <td style="text-align: center;">${stats.tempo} min</td>
                                    <td style="text-align: center;">${Math.round(stats.rendimento / stats.sessoes * 100)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('relatorioResultado').innerHTML = resultado;
            document.getElementById('btnExportarRelatorio').style.display = 'block';
            
            localStorage.setItem('relatorioPeriodo', JSON.stringify({ dataInicio, dataFim }));
        }

        function exportarRelatorioPeriodo() {
            const periodo = JSON.parse(localStorage.getItem('relatorioPeriodo') || '{}');
            if (!periodo.dataInicio || !periodo.dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Gere relat√≥rio primeiro!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= periodo.dataInicio && h.data <= periodo.dataFim;
            });
            
            const csv = dados2CSV(sessoesNoPeriodo);
            const filename = `VRVS_RELATORIO_${periodo.dataInicio}_${periodo.dataFim}.csv`;
            downloadCSV(csv, filename);
        }
        
        function updateStats() {
            // CORRE√á√ÉO: Suspenso n√£o aparece em estat√≠sticas
            const temasAtivos = dados.filter(t => t.status !== 'Suspenso');
            document.getElementById('statTemas').textContent = temasAtivos.length;
            
            // Filtrar hist√≥rico de temas suspensos
            const historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                return tema && tema.status !== 'Suspenso';
            });
            
            const totalSessoes = historicoAtivo.length;
            document.getElementById('statSessoes').textContent = totalSessoes;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            document.getElementById('statRendimento').textContent = rendimentoMedio + '%';
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            document.getElementById('statTempo').textContent = totalHoras + 'h';
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes)
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoAtivo.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            document.getElementById('statQuestoes').textContent = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular flashcards totais
            const totalFlashcards = historicoAtivo.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            document.getElementById('statFlashcards').textContent = totalFlashcards.toLocaleString();
            
            renderChartBarras();
            renderChartLinhaControles(); // Renderizar controles antes do gr√°fico
            renderChartLinha();
            renderChartRadar();
        }
        
        // ==================== GR√ÅFICOS POR √ÅREA! ====================
        
        const COLORS_PALETTE = [
            '#FFD700', '#FFA07A', '#F5DEB3', '#FF69B4', '#20B2AA', '#87CEEB',
            '#00FFE0', '#00CED1', '#FFA366', '#FF7F50', '#E55100', '#0d9488'
        ];
        let areaColorMap = {};
        let colorIndex = 0;
        
        function getColorForArea(area) {
            if (!areaColorMap[area]) {
                areaColorMap[area] = COLORS_PALETTE[colorIndex % COLORS_PALETTE.length];
                colorIndex++;
            }
            return areaColorMap[area];
        }
        
        let chartBarrasInst = null;
        let chartLinhaInst = null; // Inst√¢ncia para gr√°fico Stats
        let chartLinhaAnalyticsInst = null; // Inst√¢ncia separada para gr√°fico Analytics
        let chartRadarInst = null;
        
        // Estado de √°reas vis√≠veis no gr√°fico de linha
        let areasVisiveisLinha = new Set();
        
        // ==================== AGRUPAMENTO PARA GR√ÅFICOS ====================
        // Mapeamento de agrupamento (apenas para visualiza√ß√£o nos gr√°ficos)
        // N√ÉO altera os dados originais
        const AGRUPAMENTO_GRAFICOS = {
            'Trauma MMSS': 'Trauma Adulto',
            'Trauma MMII': 'Trauma Adulto',
            'Trauma Coluna': 'Trauma Adulto'
            // Todas as outras mant√™m o nome original
        };
        
        function agruparParaGrafico(area) {
            return AGRUPAMENTO_GRAFICOS[area] || area;
        }
        
        // GR√ÅFICO 1: Performance m√©dia POR √ÅREA
        function renderChartBarras(canvasId = 'chartBarras') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn('[CHART BARRAS] Canvas n√£o encontrado! ID:', canvasId);
                return;
            }
            console.log('[CHART BARRAS] Renderizando gr√°fico... ID:', canvasId);
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area: areaNormalizada } = fixAreaTema(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (areaNormalizada.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(areaNormalizada);
                
                if (!areaStats[areaAgrupada]) {
                    areaStats[areaAgrupada] = { total: 0, count: 0 };
                }
                areaStats[areaAgrupada].total += h.rendimento * 100;
                areaStats[areaAgrupada].count += 1;
            });
            
            const areaRendimento = [];
            for (let area in areaStats) {
                const media = Math.round(areaStats[area].total / areaStats[area].count);
                areaRendimento.push([area, media]);
            }
            const sorted = areaRendimento.sort((a, b) => b[1] - a[1]);
            
            console.log('[CHART BARRAS] √Åreas encontradas:', Object.keys(areaStats).length);
            console.log('[CHART BARRAS] Dados ordenados:', sorted.length, '√°reas');
            
            if (sorted.length === 0) {
                console.warn('[CHART BARRAS] Nenhum dado para exibir! Hist√≥rico:', historico.length, 'registros');
                if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
                // Mostrar mensagem ao usu√°rio
                const container = ctx.closest('div');
                if (container && !container.querySelector('.no-data-message')) {
                    container.innerHTML += '<div class="no-data-message" style="color: rgba(0,206,209,0.7); padding: 20px; text-align: center; font-size: 14px;">‚ö†Ô∏è Nenhum dado dispon√≠vel para exibir. Adicione sess√µes no hist√≥rico primeiro.</div>';
                }
                return;
            }
            if (chartBarrasInst) { chartBarrasInst.destroy(); }
            
            // Cores: extremos (m√°ximo e m√≠nimo) mais fortes, centro mais brando
            const maxVal = Math.max(...sorted.map(s => s[1]));
            const minVal = Math.min(...sorted.map(s => s[1]));
            const backgroundColors = sorted.map((s, index) => {
                const valor = s[1];
                const corBase = getColorForArea(s[0]);
                
                // Se √© m√°ximo ou m√≠nimo, usar cor forte
                if (valor === maxVal || valor === minVal) {
                    return corBase; // Cor original (forte)
                }
                
                // Para valores intermedi√°rios, tornar a cor mais branda (adicionar transpar√™ncia)
                const r = parseInt(corBase.slice(1, 3), 16);
                const g = parseInt(corBase.slice(3, 5), 16);
                const b = parseInt(corBase.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, 0.4)`; // 40% de opacidade para centro
            });
            
            const borderColors = sorted.map((s, index) => {
                const valor = s[1];
                const corBase = getColorForArea(s[0]);
                
                // Bordas: extremos mais grossas e fortes, centro mais finas e brandas
                if (valor === maxVal || valor === minVal) {
                    return corBase; // Cor original (forte)
                }
                const r = parseInt(corBase.slice(1, 3), 16);
                const g = parseInt(corBase.slice(3, 5), 16);
                const b = parseInt(corBase.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, 0.6)`; // 60% de opacidade para bordas do centro
            });
            
            const borderWidths = sorted.map(s => {
                const valor = s[1];
                return (valor === maxVal || valor === minVal) ? 2 : 1; // Extremos com borda mais grossa
            });
            
            console.log('[CHART BARRAS] Criando gr√°fico com', sorted.length, '√°reas');
            console.log('[CHART BARRAS] Chart dispon√≠vel?', typeof Chart !== 'undefined');
            
            try {
                chartBarrasInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Performance M√©dia (%)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: borderWidths
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Performance M√©dia por √Årea',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
            console.log('[CHART BARRAS] Gr√°fico criado com sucesso!');
            } catch (err) {
                console.error('[CHART BARRAS] ERRO ao criar gr√°fico:', err);
                const container = ctx.closest('div');
                if (container) {
                    container.innerHTML += '<div style="color: #EF4444; padding: 20px; text-align: center;">‚ö†Ô∏è Erro ao renderizar gr√°fico: ' + err.message + '</div>';
                }
            }
        }
        
        // Renderizar controles de toggle para gr√°fico de linha (vers√£o principal)
        function renderChartLinhaControles() {
            const container = document.getElementById('chartLinhaControles');
            if (!container) return;
            
            renderChartLinhaControlesInterno(container);
        }
        
        // Renderizar controles de toggle para gr√°fico de linha (vers√£o Analytics)
        function renderChartLinhaControlesAnalytics() {
            const container = document.getElementById('chartLinhaControlesAnalytics');
            if (!container) return;
            
            renderChartLinhaControlesInterno(container);
        }
        
        // Fun√ß√£o interna compartilhada para renderizar controles
        function renderChartLinhaControlesInterno(container) {
            
            // Obter todas as √°reas √∫nicas (agrupadas) do hist√≥rico
            const areasUnicas = new Set();
            historico.forEach(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area || area.toLowerCase() === 'tema') return;
                
                const areaAgrupada = agruparParaGrafico(area);
                areasUnicas.add(areaAgrupada);
            });
            
            const areas = Array.from(areasUnicas).sort();
            
            // Inicializar todas como vis√≠veis se ainda n√£o foi inicializado
            if (areasVisiveisLinha.size === 0) {
                areas.forEach(a => areasVisiveisLinha.add(a));
            }
            
            // Renderizar controles (bot√µes TODAS/NENHUMA removidos - n√£o funcionavam)
            let html = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            `;
            
            areas.forEach(area => {
                html += `
                    <label class="chart-toggle-label">
                        <input type="checkbox" 
                               ${areasVisiveisLinha.has(area) ? 'checked' : ''}
                               onchange="toggleAreaLinha('${area.replace(/'/g, "\\'")}')">
                        <span>${area}</span>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Toggle de √°rea individual no gr√°fico de linha
        function toggleAreaLinha(area) {
            if (areasVisiveisLinha.has(area)) {
                areasVisiveisLinha.delete(area);
            } else {
                areasVisiveisLinha.add(area);
            }
            // CORRE√á√ÉO: Detectar qual canvas est√° ativo e atualizar ambos
            const canvasStats = document.getElementById('chartLinha');
            const canvasAnalytics = document.getElementById('chartLinhaAnalytics');
            
            // Atualizar controles de ambos se existirem
            renderChartLinhaControles();
            if (canvasAnalytics) {
                renderChartLinhaControlesAnalytics();
            }
            
            // Re-renderizar gr√°ficos ativos
            if (canvasStats) {
                renderChartLinha('chartLinha');
            }
            if (canvasAnalytics) {
                renderChartLinha('chartLinhaAnalytics');
            }
        }
        
        // Toggle todas as √°reas (mostrar/ocultar todas)
        function toggleTodasAreasLinha(mostrar) {
            const areasUnicas = new Set();
            historico.forEach(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area || area.toLowerCase() === 'tema') return;
                
                const areaAgrupada = agruparParaGrafico(area);
                areasUnicas.add(areaAgrupada);
            });
            
            areasVisiveisLinha = mostrar ? new Set(Array.from(areasUnicas)) : new Set();
            
            // CORRE√á√ÉO: Detectar qual canvas est√° ativo e atualizar ambos
            const canvasStats = document.getElementById('chartLinha');
            const canvasAnalytics = document.getElementById('chartLinhaAnalytics');
            
            // Atualizar controles de ambos se existirem
            renderChartLinhaControles();
            if (canvasAnalytics) {
                renderChartLinhaControlesAnalytics();
            }
            
            // Re-renderizar gr√°ficos ativos
            if (canvasStats) {
                renderChartLinha('chartLinha');
            }
            if (canvasAnalytics) {
                renderChartLinha('chartLinhaAnalytics');
            }
        }
        
        // GR√ÅFICO 2: Evolu√ß√£o POR √ÅREA
        function renderChartLinha(canvasId = 'chartLinha') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn('[CHART LINHA] Canvas n√£o encontrado! ID:', canvasId);
                return;
            }
            
            // CORRE√á√ÉO: Renderizar controles se ainda n√£o foram renderizados (para ambos: principal e Analytics)
            const controlesId = canvasId === 'chartLinhaAnalytics' ? 'chartLinhaControlesAnalytics' : 'chartLinhaControles';
            const controlesEl = document.getElementById(controlesId);
            if (controlesEl && !controlesEl.innerHTML) {
                if (canvasId === 'chartLinhaAnalytics') {
                    renderChartLinhaControlesAnalytics();
                } else {
                    renderChartLinhaControles();
                }
            }
            
            // AGRUPAR POR √ÅREA!!!
            const areasSessoes = {};
            historico.forEach(h => {
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(area);
                
                if (!areasSessoes[areaAgrupada]) {
                    areasSessoes[areaAgrupada] = [];
                }
                areasSessoes[areaAgrupada].push({
                    rendimento: (h.rendimento || 0) * 100,
                    sessao: areasSessoes[areaAgrupada].length + 1
                });
            });
            
            const datasets = Object.entries(areasSessoes)
                .filter(([area]) => areasVisiveisLinha.has(area)) // FILTRAR POR √ÅREAS VIS√çVEIS
                .map(([area, sessoes]) => {
                const color = getColorForArea(area);
                return {
                    label: area,
                    data: sessoes.map(s => ({ x: s.sessao, y: s.rendimento })),
                    borderColor: color,
                    backgroundColor: color + '33',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            // CORRE√á√ÉO: Usar inst√¢ncia separada para Analytics vs Stats
            let instanciaAtual = canvasId === 'chartLinhaAnalytics' ? chartLinhaAnalyticsInst : chartLinhaInst;
            
            // Destruir inst√¢ncia anterior se existir
            if (instanciaAtual) { 
                try {
                    instanciaAtual.destroy(); 
                } catch(e) {
                    console.warn('[CHART LINHA] Erro ao destruir gr√°fico anterior:', e);
                }
            }
            
            // Criar novo gr√°fico sempre (mesmo vazio, para permitir reativar)
            const novaInstancia = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets.length > 0 ? datasets : [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone (portrait/landscape)
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o da Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const area = context[0].dataset.label;
                                    const sessao = context[0].parsed.x;
                                    return `${area} - Sess√£o ${sessao}`;
                                },
                                label: function(context) {
                                    return `Performance: ${Math.round(context.parsed.y)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'N√∫mero da Sess√£o',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', stepSize: 1 },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Rendimento (%)',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
            
            // Salvar na inst√¢ncia correta
            if (canvasId === 'chartLinhaAnalytics') {
                chartLinhaAnalyticsInst = novaInstancia;
            } else {
                chartLinhaInst = novaInstancia;
            }
        }
        
        // GR√ÅFICO 3: Radar POR √ÅREA
        function renderChartRadar(canvasId = 'chartRadar') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(area);
                
                if (!areaStats[areaAgrupada]) {
                    areaStats[areaAgrupada] = { total: 0, count: 0 };
                }
                areaStats[areaAgrupada].total += h.rendimento * 100;
                areaStats[areaAgrupada].count += 1;
            });
            
            const areas = [];
            const rendimentos = [];
            for (let area in areaStats) {
                areas.push(area);
                rendimentos.push(Math.round(areaStats[area].total / areaStats[area].count));
            }
            
            if (areas.length === 0) {
                if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
                return;
            }
            
            if (chartRadarInst) { chartRadarInst.destroy(); }
            chartRadarInst = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'Performance M√©dia',
                        data: rendimentos,
                        borderColor: '#FFA500',
                        backgroundColor: 'rgba(255, 165, 0, 0.15)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#FFA500',
                        pointBorderColor: '#0a1a1f',
                        pointHoverBackgroundColor: '#FFA500',
                        pointHoverBorderColor: '#0a1a1f'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone
                    aspectRatio: 1.3,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Mapa de Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'rgba(0,206,209,0.5)',
                                backdropColor: 'transparent',
                                stepSize: 20,
                                callback: val => val + '%'
                            },
                            grid: { color: 'rgba(0,206,209,0.2)' },
                            angleLines: { color: 'rgba(0,206,209,0.1)' },
                            pointLabels: {
                                color: 'rgba(0,206,209,0.8)',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== IMPORTA√á√ÉO/EXPORTA√á√ÉO ====================
        
        function limparTudo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Apagar TODOS os dados?')) return;
            if (!confirm('‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Opera√ß√£o irrevers√≠vel!')) return;
            
            localStorage.removeItem('vrvs_dados');
            localStorage.removeItem('vrvs_historico');
            localStorage.removeItem('ultimoBackup');
            dados = [];
            historico = [];
            
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            
            mostrarNotificacaoFeedback('üóëÔ∏è Reset completo executado');
        }
        
        function importarArquivos() {
            const dadosFile = document.getElementById('importDados').files[0];
            const historicoFile = document.getElementById('importHistorico').files[0];
            const anotacoesFile = document.getElementById('importAnotacoes').files[0];
            const diarioFile = document.getElementById('importDiario').files[0];
            
            console.log('[IMPORT] ========== IN√çCIO DA IMPORTA√á√ÉO ==========');
            console.log('[IMPORT] Arquivos selecionados:', {
                dados: dadosFile ? dadosFile.name + ' (' + dadosFile.size + ' bytes)' : 'n√£o selecionado',
                historico: historicoFile ? historicoFile.name + ' (' + historicoFile.size + ' bytes)' : 'n√£o selecionado',
                anotacoes: anotacoesFile ? anotacoesFile.name + ' (' + anotacoesFile.size + ' bytes)' : 'n√£o selecionado',
                diario: diarioFile ? diarioFile.name + ' (' + diarioFile.size + ' bytes)' : 'n√£o selecionado'
            });
            console.log('[IMPORT] Verifica√ß√£o de arquivos:', {
                dadosFile: !!dadosFile,
                historicoFile: !!historicoFile,
                anotacoesFile: !!anotacoesFile,
                diarioFile: !!diarioFile
            });
            
            if (!dadosFile && !historicoFile && !anotacoesFile && !diarioFile) {
                mostrarNotificacaoFeedback('‚ùå Selecione arquivo para importar!', 'error');
                return;
            }
            
            const promises = [];
            
            if (dadosFile) {
                console.log('[IMPORT DADOS] Iniciando importa√ß√£o de', dadosFile.name);
                promises.push(parseCSV(dadosFile).then(dadosCSV => {
                    console.log('[IMPORT DADOS] CSV parseado,', dadosCSV.length, 'registros recebidos');
                    dados = dadosCSV.map(t => {
                        if (!t.id) t.id = Date.now() + Math.random();
                        t.area = normalizeArea(t.area, t.tema);
                        if (t.rendimento > 1) t.rendimento = t.rendimento / 100;
                        t.prioridade = parseInt(t.prioridade) || 3;
                        t.sessoes = parseInt(t.sessoes) || 0;
                        t.tempo = parseInt(t.tempo) || 0;
                        t.contador80 = parseInt(t.contador80) || 0;
                        if (!t.sugestao || t.sugestao === '-') {
                            t.sugestao = extrairUltimaSugestao(t.observacoes);
                        }
                        delete t.tipoRevisao;
                        return t;
                    });
                    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                    console.log('[IMPORT DADOS]', dados.length, 'dados salvos');
                    return 'dados';
                }).catch(err => {
                    console.error('[IMPORT DADOS] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (historicoFile) {
                console.log('[IMPORT HISTORICO] Iniciando importa√ß√£o de', historicoFile.name);
                promises.push(parseCSV(historicoFile).then(historicoCSV => {
                    console.log('[IMPORT HISTORICO] CSV parseado,', historicoCSV.length, 'registros recebidos');
                    historico = historicoCSV.map(h => {
                        if (!h.id) h.id = Date.now() + Math.random();
                        h.area = normalizeArea(h.area, h.tema);
                        if (h.rendimento > 1) h.rendimento = h.rendimento / 100;
                        h.tempo = parseInt(h.tempo) || 0;
                        if (!h.data || h.data === '-') {
                            const obsMatch = (h.observacoes || '').match(/^(\d{4}-\d{2}-\d{2}):/);
                            if (obsMatch) {
                                h.data = obsMatch[1];
                            }
                        }
                        if (!h.sugestao || h.sugestao === '-') {
                            h.sugestao = extrairUltimaSugestao(h.observacoes);
                        }
                        return h;
                    });
                    localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                    console.log('[IMPORT HISTORICO]', historico.length, 'registros salvos');
                    return 'historico';
                }).catch(err => {
                    console.error('[IMPORT HISTORICO] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (anotacoesFile) {
                console.log('[IMPORT ANOTACOES] Iniciando importa√ß√£o de', anotacoesFile.name, 'tamanho:', anotacoesFile.size);
                promises.push(parseCSVAnotacoes(anotacoesFile).then(anotacoesCSV => {
                    console.log('[IMPORT ANOTACOES] CSV parseado,', anotacoesCSV.length, 'anota√ß√µes recebidas');
                    const anotacoesImportadas = anotacoesCSV.map(a => {
                        if (!a.id) a.id = Date.now() + Math.random();
                        // CR√çTICO: Garantir que temaId seja string e corresponda a um tema v√°lido
                        a.temaId = String(a.temaId || a.temaid || '');
                        // Se temaId est√° vazio, tentar encontrar pelo nome do tema
                        if (!a.temaId || a.temaId.trim() === '') {
                            const tema = dados.find(t => String(t.tema).trim() === String(a.tema || '').trim());
                            if (tema) {
                                a.temaId = String(tema.id);
                                console.log(`[IMPORT ANOTACOES] temaId encontrado para "${a.tema}": ${a.temaId}`);
                            } else {
                                console.warn(`[IMPORT ANOTACOES] N√£o foi poss√≠vel encontrar temaId para "${a.tema}"`);
                            }
                        }
                        return a;
                    }).filter(a => a.temaId && a.temaId.trim() !== ''); // Filtrar apenas com temaId v√°lido
                    
                    // CR√çTICO: Mesclar com anota√ß√µes existentes (preservar dados existentes)
                    anotacoes = mesclarAnotacoes(anotacoesImportadas, anotacoes);
                    localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                    console.log(`[IMPORT ANOTACOES] ${anotacoes.length} anota√ß√µes ap√≥s mesclagem (${anotacoesImportadas.length} novas)`);
                    return 'anotacoes';
                }).catch(err => {
                    console.error('[IMPORT ANOTACOES] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (diarioFile) {
                console.log('[IMPORT DIARIO] Iniciando importa√ß√£o de', diarioFile.name);
                promises.push(parseCSVDiario(diarioFile).then(diarioCSV => {
                    console.log('[IMPORT DIARIO] CSV parseado,', diarioCSV.length, 'entradas recebidas');
                    
                    // Carregar di√°rio existente
                    carregarDiario();
                    
                    // Mesclar entradas importadas com existentes
                    const entradasExistentes = window.diario.entradas || [];
                    const entradasImportadas = diarioCSV.map(e => {
                        if (!e.id) e.id = Date.now() + Math.random();
                        e.atencao = e.atencao === 'true' || e.atencao === true;
                        return e;
                    });
                    
                    // Mesclar: se ID existe, atualiza; se n√£o, adiciona
                    entradasImportadas.forEach(nova => {
                        const existente = entradasExistentes.find(e => String(e.id) === String(nova.id));
                        if (existente) {
                            // Atualizar entrada existente
                            Object.assign(existente, nova);
                        } else {
                            // Adicionar nova entrada
                            entradasExistentes.push(nova);
                        }
                    });
                    
                    window.diario.entradas = entradasExistentes;
                    // Inicializar SRS em todas as entradas ap√≥s importa√ß√£o
                    inicializarSrsEmTodasEntradas();
                    salvarDiario();
                    console.log(`[IMPORT DIARIO] ${entradasExistentes.length} entradas ap√≥s mesclagem`);
                    return 'diario';
                }).catch(err => {
                    console.error('[IMPORT DIARIO] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            console.log('[IMPORT] Total de promises criadas:', promises.length);
            if (promises.length === 0) {
                console.error('[IMPORT] ERRO: Nenhuma promise foi criada!');
                mostrarNotificacaoFeedback('‚ùå Nenhum arquivo v√°lido selecionado!', 'error');
                return;
            }
            
            console.log('[IMPORT] Executando Promise.allSettled com', promises.length, 'promises...');
            Promise.allSettled(promises)
                .then(results => {
                    console.log('[IMPORT] Todas as promises finalizadas. Total de resultados:', results.length);
                    console.log('[IMPORT] Resultados detalhados:', results);
                    
                    // CORRE√á√ÉO: Limpar hist√≥rico inv√°lido ap√≥s importa√ß√£o
                    limparHistoricoInvalido();
                    
                    const sucessos = [];
                    const erros = [];
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            console.log(`[IMPORT] Promise ${index} sucesso:`, result.value);
                            sucessos.push(result.value);
                        } else {
                            console.error(`[IMPORT] Promise ${index} falhou:`, result.reason);
                            console.error(`[IMPORT] Erro completo:`, result.reason);
                            if (result.reason?.stack) {
                                console.error(`[IMPORT] Stack:`, result.reason.stack);
                            }
                            erros.push(result.reason?.message || result.reason?.toString() || 'Erro desconhecido');
                        }
                    });
                    
                    let msg = '';
                    if (sucessos.length > 0) {
                        msg = sucessos.map(r => {
                            if (r === 'dados') return 'Dados';
                            if (r === 'historico') return 'Hist√≥rico';
                            if (r === 'anotacoes') return 'Anota√ß√µes';
                            if (r === 'diario') return 'Di√°rio';
                            return r;
                        }).join(' e ');
                        mostrarNotificacaoFeedback(`‚úÖ ${msg} importados com sucesso!`);
                    }
                    
                    if (erros.length > 0) {
                        console.error('[IMPORT] Erros encontrados:', erros);
                        mostrarNotificacaoFeedback(`‚ö†Ô∏è Alguns arquivos n√£o puderam ser importados. Verifique o console.`, 'error');
                    }
                    document.getElementById('importDados').value = '';
                    document.getElementById('importHistorico').value = '';
                    document.getElementById('importAnotacoes').value = '';
                    document.getElementById('importDiario').value = '';
                    renderDados();
                    renderTarefas();
                    renderAgenda();
                    renderHistorico();
                    renderPendencias();
                    atualizarSelectsCaderno();
                    renderCaderno();
                    if (sucessos.includes('diario')) {
                        renderDiario();
                    }
                    updateFeedbackSelect();
                    updateStats();
                });
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('Arquivo n√£o fornecido'));
                    return;
                }
                console.log('[PARSE CSV] Lendo arquivo:', file.name, 'tamanho:', file.size);
                const reader = new FileReader();
                reader.onerror = (err) => {
                    console.error('[PARSE CSV] Erro ao ler arquivo:', err);
                    reject(new Error('Erro ao ler arquivo: ' + (err.message || 'Erro desconhecido')));
                };
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        console.log('[PARSE CSV] Arquivo lido, tamanho do texto:', text.length);
                        if (!text || text.trim() === '') {
                            reject(new Error('Arquivo est√° vazio'));
                            return;
                        }
                        const rows = parseCSVText(text);
                        console.log('[PARSE CSV] Linhas parseadas:', rows.length);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo vazio ou inv√°lido (menos de 2 linhas)'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx]) {
                                    return stripOuterQuotes(r[idx]);
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            return {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                status: getVal(r, 'status', 'estado') || 'N√£o iniciado',
                                prioridade: parseInt(getVal(r, 'prioridade', 'prior')) || 3,
                                dificuldade: getVal(r, 'dificuldade', 'dific') || 'M√©dia',
                                rendimento: (() => {
                                    const valStr = getVal(r, 'rendimento', 'rend');
                                    if (!valStr) return 0;
                                    const cleanStr = valStr.replace('%', '').replace(',', '.');
                                    const val = parseFloat(cleanStr) || 0;
                                    return val > 1 ? val / 100 : val;
                                })(),
                                sessoes: parseInt(getVal(r, 'sessoes', 'sessao')) || 0,
                                ultEstudo: getVal(r, 'ultestudo', 'ultest', 'ultimoestudo', 'ultimo_estudo'),
                                agenda: getVal(r, 'dataagenda', 'agenda', 'data_agenda'),
                                tempo: parseInt(getVal(r, 'tempomin', 'tempo')) || 0,
                                observacoes: getVal(r, 'observacoes', 'obs', 'observacao'),
                                contador80: parseInt(getVal(r, 'contador80')) || 0,
                                sugestao: getVal(r, 'sugestao', 'sugestoes'),
                                data: getVal(r, 'data'),
                                temaId: getVal(r, 'temaid')
                            };
                        });
                        const antesFiltro = data.length;
                        const dataFiltrada = data.filter(obj => obj.tema && obj.tema.trim() !== '');
                        console.log('[PARSE CSV] Registros antes do filtro:', antesFiltro, 'depois:', dataFiltrada.length);
                        if (dataFiltrada.length === 0 && antesFiltro > 0) {
                            console.warn('[PARSE CSV] ATEN√á√ÉO: Todos os registros foram filtrados! Verifique se o campo "tema" existe no CSV.');
                        }
                        resolve(dataFiltrada);
                    } catch (err) {
                        console.error('[PARSE CSV] Erro no processamento:', err);
                        console.error('[PARSE CSV] Stack:', err.stack);
                        reject(err);
                    }
                };
                console.log('[PARSE CSV] Iniciando leitura do arquivo...');
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PARSER ESPEC√çFICO PARA DI√ÅRIO
        function parseCSVDiario(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo de di√°rio'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = parseCSVText(text);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo de di√°rio vazio ou inv√°lido'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx] !== undefined && r[idx] !== null && String(r[idx]).trim() !== '') {
                                    return stripOuterQuotes(String(r[idx]));
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map(r => {
                            const entrada = {
                                id: getVal(r, 'id') || Date.now() + Math.random(),
                                data: getVal(r, 'data') || new Date().toISOString().split('T')[0],
                                area: getVal(r, 'area', '√°rea'),
                                tema: getVal(r, 'tema'),
                                topico: getVal(r, 'topico', 't√≥pico', 'pergunta'),
                                resposta: getVal(r, 'resposta'),
                                atencao: getVal(r, 'atencao', 'aten√ß√£o', 'atencao') === 'true' || getVal(r, 'atencao', 'aten√ß√£o') === '1',
                                criadoEm: getVal(r, 'criadoem', 'criad em', 'createdat'),
                                ultimaAtualizacao: getVal(r, 'ultimaatualizacao', '√∫ltima atualiza√ß√£o', 'updatedat') || new Date().toISOString().split('T')[0]
                            };
                            // Preservar quebras de linha
                            if (entrada.resposta) {
                                entrada.resposta = entrada.resposta.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                            }
                            
                            // Tentar parsear campo SRS se existir (compatibilidade com CSVs antigos)
                            const srsAtivo = getVal(r, 'srsativo', 'srs ativo', 'srsativo');
                            const srsProximaRevisao = getVal(r, 'srsproximarevisao', 'srs pr√≥xima revis√£o', 'srsproximarevisao');
                            const srsRepeticoes = getVal(r, 'srsrepeticoes', 'srs repeti√ß√µes', 'srsrepeticoes');
                            const srsUltimaResposta = getVal(r, 'srsultimaresposta', 'srs √∫ltima resposta', 'srsultimaresposta');
                            
                            // Se algum campo SRS existir, criar objeto srs
                            if (srsAtivo || srsProximaRevisao || srsRepeticoes || srsUltimaResposta) {
                                entrada.srs = {
                                    ativo: srsAtivo === 'true' || srsAtivo === '1' || srsAtivo === '',
                                    proximaRevisao: srsProximaRevisao || hojeStr(),
                                    repeticoes: parseInt(srsRepeticoes) || 0,
                                    ultimaResposta: srsUltimaResposta || null
                                };
                            }
                            // Se n√£o tiver campos SRS, inicializarSrsEntrada ser√° chamado depois
                            
                            return entrada;
                        });
                        console.log('[PARSE CSV] Dados processados:', data.length, 'registros');
                        resolve(data);
                    } catch (err) {
                        console.error('[PARSE CSV] Erro no processamento:', err);
                        console.error('[PARSE CSV] Stack:', err.stack);
                        reject(err);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PARSER ESPEC√çFICO PARA ANOTA√á√ïES
        // Mapeia campos corretos: id, temaId, area, tema, conteudo, ultimaAtualizacao
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function parseCSVAnotacoes(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo de anota√ß√µes'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        console.log('[PARSE CSV ANOTACOES] Arquivo lido, tamanho:', text.length, 'caracteres');
                        console.log('[PARSE CSV ANOTACOES] Primeiros 500 caracteres:', text.substring(0, 500));
                        const rows = parseCSVText(text);
                        console.log('[PARSE CSV ANOTACOES] Linhas parseadas:', rows.length);
                        if (rows.length > 0) {
                            console.log('[PARSE CSV ANOTACOES] Headers:', rows[0]);
                        }
                        if (rows.length < 2) {
                            reject(new Error('Arquivo de anota√ß√µes vazio ou inv√°lido. Linhas encontradas: ' + rows.length));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx] !== undefined && r[idx] !== null && String(r[idx]).trim() !== '') {
                                    return stripOuterQuotes(String(r[idx]));
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            let conteudo = getVal(r, 'conteudo', 'conte√∫do', 'conteudo', 'texto', 'anotacao', 'anota√ß√£o');
                            // Preservar quebras de linha no conte√∫do
                            if (conteudo) {
                                conteudo = conteudo.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                            }
                            
                            // Separar Hot Topics do conte√∫do geral
                            let hotTopics = '';
                            let conteudoGeral = conteudo || '';
                            
                            if (conteudo) {
                                // Procurar por padr√µes de Hot Topics no in√≠cio do conte√∫do
                                const hotTopicsPatterns = [
                                    /^HOT\s+TOPICS?\s*üî•?\s*\n/i,
                                    /^Hot\s+Topics?\s*üî•?\s*\n/i,
                                    /^hot\s+topics?\s*üî•?\s*\n/i,
                                    /^HOT\s+TOPICS?\s*üî•/i,
                                    /^Hot\s+Topics?\s*üî•/i
                                ];
                                
                                let hotTopicsStart = -1;
                                for (const pattern of hotTopicsPatterns) {
                                    const match = conteudo.match(pattern);
                                    if (match) {
                                        hotTopicsStart = match.index + match[0].length;
                                        break;
                                    }
                                }
                                
                                if (hotTopicsStart > -1) {
                                    // Extrair Hot Topics (tudo ap√≥s o marcador at√© o fim ou pr√≥xima se√ß√£o)
                                    const restante = conteudo.substring(hotTopicsStart);
                                    // Se houver conte√∫do ap√≥s Hot Topics, separar
                                    const partes = restante.split(/\n\n+/);
                                    
                                    if (partes.length > 0) {
                                        hotTopics = partes[0].trim();
                                        // O resto vai para conte√∫do geral (se houver mais de uma parte)
                                        if (partes.length > 1) {
                                            conteudoGeral = partes.slice(1).join('\n\n').trim();
                                        } else {
                                            conteudoGeral = '';
                                        }
                                    } else {
                                        hotTopics = restante.trim();
                                        conteudoGeral = '';
                                    }
                                }
                            }
                            
                            const anotacao = {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                temaId: getVal(r, 'temaid', 'tema_id', 'temaid', 'temaid'),
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                conteudo: conteudoGeral,
                                hotTopics: hotTopics,
                                ultimaAtualizacao: getVal(r, 'ultimaatualizacao', 'ultima_atualizacao', 'ultimaatualizacao', 'data', 'dataatualizacao') || new Date().toISOString().split('T')[0]
                            };
                            
                            // Tentar resolver temaId pelo nome se necess√°rio
                            if (!anotacao.temaId || anotacao.temaId.trim() === '') {
                                if (anotacao.tema) {
                                    const tema = dados.find(t => String(t.tema).trim() === String(anotacao.tema).trim());
                                    if (tema) {
                                        anotacao.temaId = String(tema.id);
                                        anotacao.area = tema.area;
                                        anotacao.tema = tema.tema;
                                    }
                                }
                            } else {
                                // Verificar se temaId existe e atualizar √°rea/tema
                                const tema = dados.find(t => String(t.id) === String(anotacao.temaId));
                                if (tema) {
                                    anotacao.area = tema.area;
                                    anotacao.tema = tema.tema;
                                }
                            }
                            
                            return anotacao;
                        }).filter(obj => {
                            // Manter apenas anota√ß√µes que t√™m temaId v√°lido
                            return obj.temaId && obj.temaId.trim() !== '';
                        });
                        console.log(`[PARSE CSV ANOTACOES] ${data.length} anota√ß√µes parseadas de ${rows.length - 1} linhas`);
                        console.log('[PARSE CSV ANOTACOES] Primeira anota√ß√£o:', data[0]);
                        if (data.length === 0) {
                            console.warn('[PARSE CSV ANOTACOES] NENHUMA anota√ß√£o v√°lida encontrada ap√≥s filtro!');
                            console.warn('[PARSE CSV ANOTACOES] Verifique se temaId ou tema est√£o corretos');
                        }
                        resolve(data);
                    } catch (err) {
                        reject(new Error('Erro ao processar CSV de anota√ß√µes: ' + err.message));
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function parseCSVText(input) {
            let text = String(input || '').replace(/^\uFEFF/, '');
            const rows = [];
            let row = [];
            let cell = '';
            let i = 0;
            let inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    // Dentro de aspas: preservar tudo, incluindo quebras de linha
                    if (ch === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            // Aspas duplas escapadas: ""
                            cell += '"';
                            i += 2;
                        } else if (next === ',' || next === '\r' || next === '\n' || i === text.length - 1) {
                            // Fim do campo entre aspas
                            inQuotes = false;
                            i += 1;
                        } else {
                            // Aspas simples dentro do campo (mant√©m)
                            cell += ch;
                            i += 1;
                        }
                    } else {
                        // Qualquer caractere dentro de aspas (incluindo \n e \r)
                        cell += ch;
                        i += 1;
                    }
                } else {
                    // Fora de aspas
                    if (ch === '"') {
                        inQuotes = true;
                        i += 1;
                    } else if (ch === ',') {
                        row.push(cell);
                        cell = '';
                        i += 1;
                    } else if (ch === '\r') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        if (text[i + 1] === '\n') i += 2; else i += 1;
                    } else if (ch === '\n') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        i += 1;
                    } else {
                        cell += ch;
                        i += 1;
                    }
                }
            }
            // Adicionar √∫ltima c√©lula e linha
            if (cell || row.length > 0) {
                row.push(cell);
                rows.push(row);
            }
            return rows;
        }
        
        function stripOuterQuotes(s) {
            const str = String(s ?? '');
            if (str.length >= 2 && str[0] === '"' && str[str.length - 1] === '"') {
                return str.slice(1, -1).replace(/""/g, '"');
            }
            return str;
        }
        
        function exportarDados() {
            const csv = dados2CSV(dados);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_DADOS_${hoje}.csv`);
        }
        
        function exportarHistorico() {
            const csv = dados2CSV(historico);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_HISTORICO_${hoje}.csv`);
        }
        
        function exportarAnotacoes() {
            // üîß CORRE√á√ÉO: Exportar apenas anota√ß√µes que t√™m conte√∫do
            const anotacoesComConteudo = anotacoes.filter(a => {
                const conteudo = (a.conteudo || '').trim();
                return conteudo.length > 0;
            });
            
            if (anotacoesComConteudo.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma anota√ß√£o com conte√∫do para exportar!', 'error');
                return;
            }
            
            const csv = dados2CSV(anotacoesComConteudo);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_ANOTACOES_${hoje}.csv`);
            mostrarNotificacaoFeedback(`‚úÖ ${anotacoesComConteudo.length} anota√ß√£o(√µes) exportadas!`);
        }
        
        function salvarDadosManualmente() {
            try {
                // Salvar todos os dados no localStorage
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                mostrarNotificacaoFeedback('‚úÖ Todos os dados salvos com sucesso!');
            } catch (e) {
                mostrarNotificacaoFeedback('‚ùå Erro ao salvar: ' + e.message, 'error');
            }
        }
        
        function dados2CSV(arr) {
            if (arr.length === 0) return '';
            // Uni√£o de todas as chaves para garantir todas as colunas
            const headerSet = new Set();
            arr.forEach(obj => {
                if (obj) Object.keys(obj).forEach(k => headerSet.add(k));
            });
            // Garantir que observacoes e sugestao est√£o sempre presentes
            headerSet.add('observacoes');
            headerSet.add('sugestao');
            const headers = Array.from(headerSet);
            
            const rows = arr.map(obj => headers.map(h => {
                const val = (obj && obj[h] != null) ? obj[h] : '';
                const strVal = String(val);
                // Escapar aspas duplas
                const escaped = strVal.replace(/"/g, '""');
                // Se cont√©m v√≠rgula, quebra de linha ou aspas, precisa estar entre aspas
                if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) {
                    return `"${escaped}"`;
                }
                return escaped;
            }).join(','));
            return [headers.join(','), ...rows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // ==================== NAVEGA√á√ÉO ====================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            if (sectionId === 'dados') renderDados();
            if (sectionId === 'tarefa') renderTarefas();
            if (sectionId === 'agenda') renderAgendaUnificada();
            if (sectionId === 'stats') updateStats();
            if (sectionId === 'historico') renderHistorico();
            if (sectionId === 'pendencias') renderPendencias();
            if (sectionId === 'lembretes') {
                atualizarSelectsLembrete();
                renderLembretes();
            }
            if (sectionId === 'caderno') {
                renderCadernoV2();
            }
            if (sectionId === 'diario') {
                renderDiario();
                // Atualizar chip VRVS 3P quando abrir aba Di√°rio
                setTimeout(() => {
                    atualizarChipVrvs3p();
                }, 50);
            }
            if (sectionId === 'analises') {
                atualizarSelectsAnalise();
                // Garantir que di√°rio est√° carregado antes de calcular an√°lises
                if (!window.diario) {
                    carregarDiario();
                }
                atualizarAnalises();
            }
            // Novas se√ß√µes consolidadas
            if (sectionId === 'analytics') {
                // Garantir que di√°rio est√° carregado antes de renderizar Analytics
                if (!window.diario) {
                    carregarDiario();
                }
                // Garantir que a vista inicial seja renderizada
                if (!vistaAnalytics) vistaAnalytics = 'resumo';
                renderAnalytics();
            }
            if (sectionId === 'backup') {
                // Nada especial para renderizar
            }
            if (sectionId === 'ajuda') {
                renderAjuda();
            }
        }
        
        // ==================== AN√ÅLISES DETALHADAS ====================
        
        function atualizarSelectsAnalise() {
            // Atualizar select de √°reas (incluindo AREAS_FIXAS + √°reas dos dados)
            const areaSelect = document.getElementById('analiseFiltroArea');
            const areasDados = dados.filter(t => t.status !== 'Suspenso').map(t => t.area).filter(a => a);
            const areas = [...new Set([...AREAS_FIXAS, ...areasDados])].sort();
            areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
            areas.forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
            
            // Atualizar select de temas baseado na √°rea selecionada
            atualizarSelectTemaAnalise();
        }
        
        function atualizarSelectTemaAnalise() {
            const temaSelect = document.getElementById('analiseFiltroTema');
            const areaSelecionada = document.getElementById('analiseFiltroArea').value;
            
            let temasFiltrados = dados.filter(t => t.status !== 'Suspenso');
            if (areaSelecionada) {
                temasFiltrados = temasFiltrados.filter(t => t.area === areaSelecionada);
            }
            
            const temas = [...new Set(temasFiltrados.map(t => `${t.area} - ${t.tema}`))].sort();
            temaSelect.innerHTML = '<option value="">Todos os temas</option>';
            temas.forEach(tema => {
                temaSelect.innerHTML += `<option value="${tema}">${tema}</option>`;
            });
        }
        
        function atualizarAnalises() {
            calcularAnalises();
        }
        
        // Vari√°vel global para controlar visibilidade das an√°lises de tempo
        window.analisesTempoVisiveis = false;
        
        function toggleAnalisesTempo() {
            window.analisesTempoVisiveis = !window.analisesTempoVisiveis;
            const toggleText = document.getElementById('toggleAnalisesTempoText');
            const analiseTempoDiv = document.getElementById('analiseTempo');
            
            if (toggleText) {
                toggleText.textContent = window.analisesTempoVisiveis ? '‚è±Ô∏è Ocultar An√°lises de Tempo' : '‚è±Ô∏è Mostrar An√°lises de Tempo';
            }
            
            if (analiseTempoDiv) {
                analiseTempoDiv.style.display = window.analisesTempoVisiveis ? 'block' : 'none';
            }
            
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function calcularAnalisesTempo() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico (mesma l√≥gica de calcularAnalises)
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseTempo').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">‚è±Ô∏è</div><div>Nenhum dado de tempo encontrado</div></div>';
                return;
            }
            
            // Calcular m√©dias de tempo
            const sessoesComTempo = historicoFiltrado.filter(h => h.tempo && h.tempo > 0);
            const tempoMedioSessao = sessoesComTempo.length > 0
                ? Math.round(sessoesComTempo.reduce((sum, h) => sum + (h.tempo || 0), 0) / sessoesComTempo.length)
                : 0;
            
            // Tempo m√©dio em quest√µes
            const sessoesComTempoQuestoes = historicoFiltrado.filter(h => h.tempoQuestoes && h.tempoQuestoes > 0);
            const tempoMedioQuestoes = sessoesComTempoQuestoes.length > 0
                ? Math.round(sessoesComTempoQuestoes.reduce((sum, h) => sum + (h.tempoQuestoes || 0), 0) / sessoesComTempoQuestoes.length)
                : 0;
            
            // Tempo m√©dio em flashcards
            const sessoesComTempoFlashcards = historicoFiltrado.filter(h => h.tempoFlashcards && h.tempoFlashcards > 0);
            const tempoMedioFlashcards = sessoesComTempoFlashcards.length > 0
                ? Math.round(sessoesComTempoFlashcards.reduce((sum, h) => sum + (h.tempoFlashcards || 0), 0) / sessoesComTempoFlashcards.length)
                : 0;
            
            // M√©dia de intervalos por sess√£o
            const sessoesComIntervalos = historicoFiltrado.filter(h => h.numeroIntervalos && h.numeroIntervalos > 0);
            const mediaIntervalosPorSessao = sessoesComIntervalos.length > 0
                ? (sessoesComIntervalos.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0) / sessoesComIntervalos.length).toFixed(1)
                : '0';
            
            // Tempo m√©dio de cada intervalo
            const intervalosIndividuais = [];
            historicoFiltrado.forEach(h => {
                if (h.intervalos && h.tempoIntervalo && h.numeroIntervalos) {
                    const numIntervalos = parseInt(h.numeroIntervalos) || 0;
                    const tempoTotalIntervalos = parseInt(h.tempoIntervalo) || 0;
                    if (numIntervalos > 0 && tempoTotalIntervalos > 0) {
                        intervalosIndividuais.push(tempoTotalIntervalos / numIntervalos);
                    }
                }
            });
            const tempoMedioIntervalo = intervalosIndividuais.length > 0
                ? Math.round(intervalosIndividuais.reduce((sum, t) => sum + t, 0) / intervalosIndividuais.length)
                : 0;
            
            // Renderizar an√°lises de tempo
            const html = `
                <div style="background: rgba(0,206,209,0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 16px;">‚è±Ô∏è AN√ÅLISES DE TEMPO</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioSessao} min</div>
                            <div class="stat-label">Tempo M√©dio por Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioQuestoes} min</div>
                            <div class="stat-label">Tempo M√©dio em Quest√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioFlashcards} min</div>
                            <div class="stat-label">Tempo M√©dio em Flashcards</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${mediaIntervalosPorSessao}</div>
                            <div class="stat-label">M√©dia de Intervalos/Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioIntervalo} min</div>
                            <div class="stat-label">Tempo M√©dio por Intervalo</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analiseTempo').innerHTML = html;
        }
        
        function calcularAnalises() {
            // Calcular m√©tricas VRVS 3P primeiro (garantir que di√°rio est√° carregado)
            let htmlVrvs3p = '';
            
            // Garantir que window.diario existe (se n√£o, inicializar vazio)
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            // Sempre calcular estat√≠sticas (mesmo se vazio)
            let stats = {};
            try {
                stats = calcularEstatisticasVrvs3p(window.diario, hojeStr()) || {};
            } catch (e) {
                console.error('[VRVS3P] Erro ao calcular estat√≠sticas:', e);
                stats = { totalAtivos: 0, totalHoje: 0, totalAtrasadas: 0 };
            }
            const faixa = (stats && stats.retencaoGlobal !== null && stats.retencaoGlobal !== undefined) ? classificarFaixaRetencao(stats.retencaoGlobal) : 'nenhum';
            const mensagem = mensagemRetencao((stats && stats.retencaoGlobal) ? stats.retencaoGlobal : 0, stats || {});
            
            // Sempre renderizar painel (mesmo se vazio)
            htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card" style="background: rgba(0,206,209,0.05); border: 1px solid rgba(0,206,209,0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 18px; font-weight: 600;">üß† Sa√∫de do Di√°rio VRVS 3P</h3>
                        
                        ${stats.totalAtivos > 0 ? `
                            <div class="vrvs3p-saude-bloco">
                                <div class="vrvs3p-progress-wrapper" style="margin-bottom: 20px;">
                                    <div class="vrvs3p-progress-bar" style="width: 100%; height: 24px; background: rgba(5,25,30,0.8); border-radius: 12px; overflow: hidden; position: relative;">
                                        <div class="vrvs3p-progress-fill vrvs3p-progress-fill--${faixa}" style="width: ${stats.retencaoGlobalPct}%; height: 100%; background: ${faixa === 'alta' ? 'linear-gradient(90deg, #22c55e, #16a34a)' : faixa === 'media' ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 'linear-gradient(90deg, #dc3545, #b91c1c)'}; transition: width 0.3s ease;"></div>
                                    </div>
                                    <div class="vrvs3p-progress-label" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                        <span class="vrvs3p-progress-percent" style="font-size: 16px; font-weight: 600; color: var(--turquesa-light);">${stats.retencaoGlobalPct}%</span>
                                        <span class="vrvs3p-progress-status" style="font-size: 13px; color: rgba(255,255,255,0.7);">‚Ä¢ ${faixa === 'alta' ? 'Alta' : faixa === 'media' ? 'M√©dia' : 'Baixa'}</span>
                                    </div>
                                </div>
                                
                                <div class="vrvs3p-contagem-linha" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; font-size: 13px; color: rgba(255,255,255,0.8);">
                                    <span><strong style="color: var(--turquesa-light);">${stats.totalAtivos}</strong> t√≥picos ativos</span>
                                    <span>‚Ä¢ <strong style="color: var(--cobre-light);">${stats.totalHoje}</strong> para revisar hoje</span>
                                    <span>‚Ä¢ <strong style="color: ${stats.totalAtrasadas > 0 ? '#dc3545' : 'rgba(255,255,255,0.8)'}">${stats.totalAtrasadas}</strong> atrasados</span>
                                </div>
                                
                                <div class="vrvs3p-mensagem" style="padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border-left: 3px solid var(--turquesa-light); font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 20px;">
                                    ${(mensagem && typeof mensagem === 'object' && mensagem.emoji && mensagem.texto) ? `${mensagem.emoji} ${mensagem.texto}` : (mensagem || '')}
                                </div>
                            </div>
                            
                            ${stats.porArea.length > 0 ? `
                                <div class="vrvs3p-subpainel" style="margin-top: 24px;">
                                    <h4 style="color: var(--turquesa-light); margin-bottom: 16px; font-size: 15px; font-weight: 600;">üìä Reten√ß√£o por √°rea</h4>
                                    <ul class="vrvs3p-area-lista" style="list-style: none; padding: 0; margin: 0;">
                                        ${stats.porArea.map(item => {
                                            const faixaArea = classificarFaixaRetencao(item.retencao);
                                            const corBarra = faixaArea === 'alta' ? '#22c55e' : faixaArea === 'media' ? '#f59e0b' : '#dc3545';
                                            const emoji = faixaArea === 'alta' ? 'üü¢' : faixaArea === 'media' ? 'üü°' : 'üî¥';
                                            return `
                                                <li style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(0,206,209,0.1);">
                                                    <span style="flex: 0 0 140px; font-size: 13px; color: rgba(255,255,255,0.9);">${item.area}</span>
                                                    <div style="flex: 1; height: 20px; background: rgba(5,25,30,0.8); border-radius: 10px; overflow: hidden; position: relative;">
                                                        <div style="width: ${item.retencaoPct}%; height: 100%; background: ${corBarra}; transition: width 0.3s ease;"></div>
                                                    </div>
                                                    <span style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9);">${item.retencaoPct}%</span>
                                                    <span style="flex: 0 0 30px; text-align: center; font-size: 14px;">${emoji}</span>
                                                </li>
                                            `;
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="vrvs3p-maturidade" style="margin-top: 24px;">
                                <h4 style="color: var(--turquesa-light); margin-bottom: 16px; font-size: 15px; font-weight: 600;">üìà Maturidade dos t√≥picos</h4>
                                <div class="vrvs3p-maturidade-barra" style="display: flex; height: 32px; border-radius: 8px; overflow: hidden; margin-bottom: 12px;">
                                    ${stats.maturidade.novos > 0 ? `<div style="flex: ${stats.maturidade.novos}; background: linear-gradient(90deg, #dc3545, #b91c1c); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.novos}</div>` : ''}
                                    ${stats.maturidade.fixando > 0 ? `<div style="flex: ${stats.maturidade.fixando}; background: linear-gradient(90deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.fixando}</div>` : ''}
                                    ${stats.maturidade.maduros > 0 ? `<div style="flex: ${stats.maturidade.maduros}; background: linear-gradient(90deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.maduros}</div>` : ''}
                                    ${stats.maturidade.consolidados > 0 ? `<div style="flex: ${stats.maturidade.consolidados}; background: linear-gradient(90deg, #059669, #047857); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.consolidados}</div>` : ''}
                                </div>
                                <div class="vrvs3p-maturidade-legenda" style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: rgba(255,255,255,0.7);">
                                    ${stats.maturidade.novos > 0 ? `<span>üî¥ ${stats.maturidade.novos} novos</span>` : ''}
                                    ${stats.maturidade.fixando > 0 ? `<span>üü° ${stats.maturidade.fixando} fixando</span>` : ''}
                                    ${stats.maturidade.maduros > 0 ? `<span>üü¢ ${stats.maturidade.maduros} maduros</span>` : ''}
                                    ${stats.maturidade.consolidados > 0 ? `<span>üíé ${stats.maturidade.consolidados} consolidados</span>` : ''}
                                </div>
                                <p style="margin-top: 12px; font-size: 11px; color: rgba(255,255,255,0.5); font-style: italic;">
                                    üéØ Meta: migrar t√≥picos para est√°gios mais altos ao longo das semanas.
                                </p>
                            </div>
                            
                            <p class="vrvs3p-disclaimer" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(0,206,209,0.2); font-size: 11px; color: rgba(255,255,255,0.5); font-style: italic; text-align: center;">
                                Estimativa baseada no modelo VRVS 3P. N√£o √© nota ‚Äî √© um mapa para orientar seu esfor√ßo.
                            </p>
                        ` : `
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üìî</div>
                                <div style="font-size: 15px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">Nenhum t√≥pico ativo</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Cadastre entradas pelo Di√°rio e marque "Incluir nas revis√µes programadas"</div>
                            </div>
                        `}
                    </section>
                `;
            
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                // Filtrar por √°rea
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                // Filtrar por tema
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                // Filtrar por per√≠odo
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            // Sempre inserir painel VRVS 3P, mesmo se n√£o houver hist√≥rico
            const resultadosContainer = document.getElementById('analiseResultados');
            if (!resultadosContainer) return;
            
            if (historicoFiltrado.length === 0) {
                resultadosContainer.innerHTML = htmlVrvs3p + '<div class="empty-state"><div class="empty-icon">üìä</div><div>Nenhum dado encontrado para os filtros selecionados</div></div>';
                return;
            }
            
            // Calcular estat√≠sticas
            const totalSessoes = historicoFiltrado.length;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoFiltrado.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            const totalMinutos = historicoFiltrado.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            const totalMinutosResto = totalMinutos % 60;
            
            // Calcular quest√µes
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            const taxaAcertoQuestoes = totalQuestoesTotal > 0 
                ? Math.round((totalQuestoesAcertos / totalQuestoesTotal) * 100)
                : 0;
            
            // Calcular flashcards
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            // Calcular intervalos
            const totalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0);
            const tempoTotalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.tempoIntervalo) || 0), 0);
            
            // Agrupar por √°rea (se n√£o filtrado por √°rea espec√≠fica)
            let porArea = {};
            if (!areaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema && tema.area) {
                        if (!porArea[tema.area]) {
                            porArea[tema.area] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porArea[tema.area].sessoes++;
                        porArea[tema.area].tempo += h.tempo || 0;
                        porArea[tema.area].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porArea[tema.area].questoes.acertos += parseInt(match[1]);
                                porArea[tema.area].questoes.total += parseInt(match[2]);
                            }
                        }
                        porArea[tema.area].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porArea).forEach(area => {
                    porArea[area].rendimento = porArea[area].sessoes > 0 
                        ? Math.round((porArea[area].rendimento / porArea[area].sessoes) * 100)
                        : 0;
                    porArea[area].tempoHoras = Math.round(porArea[area].tempo / 60);
                });
            }
            
            // Agrupar por tema (se n√£o filtrado por tema espec√≠fico)
            let porTema = {};
            if (!temaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema) {
                        const temaKey = `${tema.area} - ${tema.tema}`;
                        if (!porTema[temaKey]) {
                            porTema[temaKey] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porTema[temaKey].sessoes++;
                        porTema[temaKey].tempo += h.tempo || 0;
                        porTema[temaKey].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porTema[temaKey].questoes.acertos += parseInt(match[1]);
                                porTema[temaKey].questoes.total += parseInt(match[2]);
                            }
                        }
                        porTema[temaKey].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porTema).forEach(temaKey => {
                    porTema[temaKey].rendimento = porTema[temaKey].sessoes > 0 
                        ? Math.round((porTema[temaKey].rendimento / porTema[temaKey].sessoes) * 100)
                        : 0;
                    porTema[temaKey].tempoHoras = Math.round(porTema[temaKey].tempo / 60);
                });
            }
            
            // Renderizar resultados
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHoras}h${totalMinutosResto > 0 ? ' ' + totalMinutosResto + 'm' : ''}</div>
                        <div class="stat-label">Tempo Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoesTotal > 0 ? totalQuestoesAcertos + '/' + totalQuestoesTotal : '0'}</div>
                        <div class="stat-label">Quest√µes (${taxaAcertoQuestoes}% acerto)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalIntervalos}</div>
                        <div class="stat-label">Intervalos (${Math.round(tempoTotalIntervalos)} min)</div>
                    </div>
                </div>
            `;
            
            // Detalhamento por √°rea (com temas colaps√°veis)
            if (!areaFiltro && Object.keys(porArea).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìä Detalhamento por √Årea:</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th style="width: 30px;"></th><th>√Årea</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porArea).sort().forEach((area, index) => {
                    const stats = porArea[area];
                    const temasDaArea = Object.keys(porTema).filter(t => t.startsWith(area + ' - '));
                    
                    html += '<tr style="background: rgba(0,206,209,0.15); cursor: pointer;" onclick="toggleTemasArea(\'' + area.replace(/'/g, "\\'") + '\')">';
                    html += `<td style="text-align: center; color: var(--turquesa-light); font-weight: bold;">${temasDaArea.length > 0 ? '‚ñ∂' : ''}</td>`;
                    html += `<td><strong style="color: var(--turquesa-light);">${area}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                    
                    // Temas da √°rea (inicialmente ocultos)
                    if (temasDaArea.length > 0) {
                        html += `<tr id="temas-${area.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: none;">`;
                        html += '<td colspan="7" style="padding: 0; background: rgba(0,0,0,0.3);">';
                        html += '<table style="width: 100%; margin: 0;"><tbody>';
                        
                        temasDaArea.forEach(temaKey => {
                            const temaStats = porTema[temaKey];
                            const temaNome = temaKey.replace(area + ' - ', '');
                            html += '<tr style="border-top: 1px solid rgba(0,206,209,0.2);">';
                            html += `<td style="padding-left: 40px; color: rgba(0,206,209,0.8); font-weight: 500;">${temaNome}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.sessoes}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.tempoHoras}h</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.rendimento}%</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.questoes.total > 0 ? temaStats.questoes.acertos + '/' + temaStats.questoes.total + ' (' + Math.round((temaStats.questoes.acertos / temaStats.questoes.total) * 100) + '%)' : '-'}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.flashcards > 0 ? temaStats.flashcards.toLocaleString() : '-'}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></td></tr>';
                    }
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema (apenas quando filtrar por √°rea espec√≠fica)
            if (areaFiltro && !temaFiltro && Object.keys(porTema).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìö Temas da √Årea "' + areaFiltro + '":</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th>Tema</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porTema).filter(t => t.startsWith(areaFiltro + ' - ')).sort().forEach(temaKey => {
                    const stats = porTema[temaKey];
                    const temaNome = temaKey.replace(areaFiltro + ' - ', '');
                    html += '<tr>';
                    html += `<td><strong style="color: var(--turquesa-light);">${temaNome}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema quando filtrado por tema espec√≠fico (n√£o mostrar, j√° est√° no resumo geral)
            
            // Inserir painel VRVS 3P no topo dos resultados
            document.getElementById('analiseResultados').innerHTML = htmlVrvs3p + html;
            
            // Se an√°lises de tempo est√£o vis√≠veis, recalcular
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function filtrarAnaliseSemanaAtual() {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            
            document.getElementById('analiseDataInicio').value = inicioSemana.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimSemana.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function filtrarAnaliseMesAtual() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('analiseDataInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimMes.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function limparFiltrosAnalise() {
            document.getElementById('analiseFiltroArea').value = '';
            document.getElementById('analiseFiltroTema').value = '';
            document.getElementById('analiseDataInicio').value = '';
            document.getElementById('analiseDataFim').value = '';
            atualizarSelectsAnalise();
            atualizarAnalises();
        }
        
        // Fun√ß√£o para expandir/colapsar temas de uma √°rea
        function toggleTemasArea(area) {
            const areaId = 'temas-' + area.replace(/[^a-zA-Z0-9]/g, '-');
            const row = document.getElementById(areaId);
            if (!row) return;
            
            const isVisible = row.style.display !== 'none';
            row.style.display = isVisible ? 'none' : 'table-row';
            
            // Atualizar √≠cone
            const areaRow = row.previousElementSibling;
            if (areaRow) {
                const iconCell = areaRow.querySelector('td:first-child');
                if (iconCell) {
                    iconCell.textContent = isVisible ? '‚ñ∂' : '‚ñº';
                }
            }
        }
        
        // ==================== CRON√îMETRO DA SESS√ÉO ====================
        
        let cronometroInterval = null;
        let cronometroSegundos = 0;
        let cronometroRodando = false;
        let intervaloAtivo = false;
        let intervaloSegundos = 0;
        let intervaloInterval = null;
        let tempoTotalIntervalo = 0; // Tempo total de intervalo acumulado (n√£o conta no estudo)
        let cronometroInicioTimestamp = null; // Timestamp de quando o cron√¥metro foi iniciado (para rodar em segundo plano)
        let intervalosIndividuais = []; // Array para armazenar cada intervalo individualmente [{tempo: segundos, inicio: timestamp}, ...]
        let intervaloInicioTimestamp = null; // Timestamp de quando o intervalo atual come√ßou
        
        // Restaurar cron√¥metro do localStorage se existir
        function restaurarCronometro() {
            const salvo = localStorage.getItem('vrvs_cronometro');
            if (salvo) {
                try {
                    const dados = JSON.parse(salvo);
                    if (dados.timestamp) {
                        // Calcular tempo decorrido desde que foi salvo (BASEADO EM TIMESTAMP)
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - dados.timestamp) / 1000);
                        
                        // Atualizar valores
                        cronometroSegundos = dados.segundos + tempoDecorrido;
                        tempoTotalIntervalo = dados.tempoIntervalo || 0;
                        intervalosIndividuais = dados.intervalosIndividuais || []; // Restaurar intervalos individuais
                        intervaloInicioTimestamp = dados.intervaloInicioTimestamp || null;
                        
                        // Se estava em intervalo, restaurar estado do intervalo
                        if (dados.intervaloAtivo) {
                            intervaloAtivo = true;
                            intervaloSegundos = dados.intervaloSegundos + tempoDecorrido;
                            document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                            document.getElementById('tempoIntervalo').style.display = 'block';
                            document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                            
                            // Reiniciar intervalo timer
                            if (intervaloInterval) {
                                clearInterval(intervaloInterval);
                            }
                            intervaloInterval = setInterval(() => {
                                intervaloSegundos++;
                                document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                            }, 1000);
                        }
                        
                        // Se estava rodando, reiniciar contagem COM TIMESTAMP PRECISO
                        if (dados.rodando && !cronometroRodando) {
                            cronometroRodando = true;
                            cronometroInicioTimestamp = dados.timestamp; // Usar timestamp original
                            localStorage.setItem('vrvs_cronometro_timestamp', String(dados.timestamp));
                            localStorage.setItem('vrvs_cronometro_segundos', String(dados.segundos));
                            iniciarCronometroContagem();
                            document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                        }
                        
                        atualizarDisplayCronometro();
                    }
                } catch (e) {
                    console.log('Erro ao restaurar cron√¥metro:', e);
                }
            }
        }
        
        // Salvar estado do cron√¥metro
        function salvarEstadoCronometro() {
            if (cronometroRodando || intervaloAtivo) {
                // CR√çTICO: Salvar timestamp original, n√£o atualizar
                const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                
                localStorage.setItem('vrvs_cronometro', JSON.stringify({
                    rodando: cronometroRodando,
                    segundos: segundosOriginais ? parseInt(segundosOriginais) : cronometroSegundos,
                    timestamp: timestampOriginal ? parseInt(timestampOriginal) : cronometroInicioTimestamp || Date.now(),
                    tempoIntervalo: tempoTotalIntervalo,
                    intervaloAtivo: intervaloAtivo,
                    intervaloSegundos: intervaloSegundos,
                    intervalosIndividuais: intervalosIndividuais, // Salvar array de intervalos individuais
                    intervaloInicioTimestamp: intervaloInicioTimestamp
                }));
            } else {
                localStorage.removeItem('vrvs_cronometro');
            }
        }
        
        // Iniciar contagem do cron√¥metro
        function iniciarCronometroContagem() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            
            // CR√çTICO: Manter timestamp original se j√° existe, sen√£o criar novo
            let timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
            let segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
            
            if (!timestampOriginal) {
                // Primeira vez iniciando
                cronometroInicioTimestamp = Date.now();
                timestampOriginal = String(cronometroInicioTimestamp);
                segundosOriginais = String(cronometroSegundos);
            } else {
                // Continuando contagem - usar timestamp original
                cronometroInicioTimestamp = parseInt(timestampOriginal);
            }
            
            // Salvar no localStorage
            localStorage.setItem('vrvs_cronometro_timestamp', timestampOriginal);
            localStorage.setItem('vrvs_cronometro_segundos', segundosOriginais);
            
            // Atualizar display periodicamente (mas c√°lculo sempre baseado em timestamp)
            cronometroInterval = setInterval(() => {
                atualizarDisplayCronometro();
            }, 100); // Atualizar a cada 100ms para maior precis√£o visual
            
            cronometroRodando = true;
            salvarEstadoCronometro();
        }
        
        // Fun√ß√£o para calcular tempo decorrido baseado em timestamp (n√£o depende de intervalos)
        function calcularTempoDecorrido() {
            const timestampSalvo = localStorage.getItem('vrvs_cronometro_timestamp');
            const segundosSalvos = parseInt(localStorage.getItem('vrvs_cronometro_segundos') || '0');
            
            if (timestampSalvo && cronometroRodando) {
                const agora = Date.now();
                const tempoDecorrido = Math.floor((agora - parseInt(timestampSalvo)) / 1000);
                return segundosSalvos + tempoDecorrido;
            }
            return cronometroSegundos;
        }
        
        function formatarTempoCronometro(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }
        
        function formatarIntervaloMinutos(segundos) {
            const minutos = Math.floor(segundos / 60);
            return minutos > 0 ? `${minutos} min` : '0 min';
        }
        
        function atualizarDisplayCronometro() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando
            if (cronometroRodando) {
                cronometroSegundos = calcularTempoDecorrido();
            }
            
            document.getElementById('cronometroDisplay').textContent = formatarTempoCronometro(cronometroSegundos);
            // Atualizar display de tempo total de intervalo acumulado
            if (tempoTotalIntervalo > 0) {
                document.getElementById('tempoIntervaloTotal').style.display = 'block';
                document.getElementById('tempoIntervaloTotalDisplay').textContent = formatarIntervaloMinutos(tempoTotalIntervalo);
            } else {
                document.getElementById('tempoIntervaloTotal').style.display = 'none';
            }
        }
        
        function toggleCronometro() {
            if (intervaloAtivo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Termine o intervalo primeiro!', 'error');
                return;
            }
            
            if (cronometroRodando) {
                // Pausar - calcular tempo final baseado em timestamp
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                
                // Calcular tempo final preciso
                cronometroSegundos = calcularTempoDecorrido();
                
                cronometroRodando = false;
                cronometroInicioTimestamp = null;
                localStorage.removeItem('vrvs_cronometro_timestamp');
                
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                salvarEstadoCronometro();
                atualizarDisplayCronometro();
            } else {
                // Iniciar - salvar timestamp preciso
                cronometroInicioTimestamp = Date.now();
                localStorage.setItem('vrvs_cronometro_timestamp', String(cronometroInicioTimestamp));
                localStorage.setItem('vrvs_cronometro_segundos', String(cronometroSegundos));
                
                iniciarCronometroContagem();
                document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        }
        
        function pausarCronometro() {
            if (cronometroRodando) {
                toggleCronometro();
            }
        }
        
        function iniciarIntervalo() {
            if (!cronometroRodando && cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Inicie o cron√¥metro primeiro!', 'error');
                return;
            }
            
            if (intervaloAtivo) {
                // Finalizar intervalo - calcular tempo baseado em timestamp e salvar individualmente
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                // Calcular tempo preciso do intervalo baseado em timestamp
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                // Salvar intervalo individual
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal; // Acumular tempo de intervalo
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
                
                document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'none';
                atualizarDisplayCronometro(); // Atualizar display com tempo acumulado
                salvarEstadoCronometro(); // Salvar estado atualizado
                mostrarNotificacaoFeedback(`‚úÖ Intervalo finalizado (${formatarTempoCronometro(tempoIntervaloFinal)} - Total: ${formatarTempoCronometro(tempoTotalIntervalo)})`);
            } else {
                // Iniciar intervalo (pausa o cron√¥metro mas n√£o conta)
                intervaloAtivo = true;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = Date.now(); // Salvar timestamp de in√≠cio do intervalo
                
                document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'block';
                
                intervaloInterval = setInterval(() => {
                    // Calcular baseado em timestamp para maior precis√£o
                    if (intervaloInicioTimestamp) {
                        const agora = Date.now();
                        intervaloSegundos = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                    } else {
                        intervaloSegundos++;
                    }
                    document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                }, 100);
                
                // Pausar cron√¥metro durante intervalo
                if (cronometroRodando) {
                    clearInterval(cronometroInterval);
                    cronometroInterval = null;
                    cronometroRodando = false;
                    document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                }
                
                salvarEstadoCronometro(); // Salvar estado quando inicia intervalo
            }
        }
        
        function resetCronometro() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
            }
            if (intervaloInterval) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
            }
            cronometroRodando = false;
            intervaloAtivo = false;
            cronometroSegundos = 0;
            intervaloSegundos = 0;
            tempoTotalIntervalo = 0; // Resetar tempo total de intervalo
            intervalosIndividuais = []; // Resetar array de intervalos individuais
            intervaloInicioTimestamp = null;
            cronometroInicioTimestamp = null;
            atualizarDisplayCronometro();
            document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
            document.getElementById('tempoIntervalo').style.display = 'none';
            localStorage.removeItem('vrvs_cronometro'); // Limpar do localStorage
            localStorage.removeItem('vrvs_cronometro_timestamp');
            localStorage.removeItem('vrvs_cronometro_segundos');
        }
        
        // Fun√ß√£o para encerrar sess√£o e mostrar modal
        function encerrarSessao() {
            // Pausar cron√¥metro se estiver rodando para calcular tempo final preciso
            if (cronometroRodando) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                cronometroSegundos = calcularTempoDecorrido();
                cronometroRodando = false;
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            }
            
            // Finalizar intervalo ativo se houver
            if (intervaloAtivo) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal;
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
            }
            
            if (cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è O cron√¥metro n√£o est√° rodando!', 'error');
                return;
            }
            
            // Preencher dados do modal
            document.getElementById('modalTempoTotal').textContent = formatarTempoCronometro(cronometroSegundos);
            document.getElementById('modalNumIntervalos').textContent = intervalosIndividuais.length;
            document.getElementById('modalTempoIntervalos').textContent = formatarIntervaloMinutos(tempoTotalIntervalo);
            
            // Limpar campos do modal
            document.getElementById('modalTempoQuestoes').value = '';
            document.getElementById('modalQuantQuestoes').value = '';
            document.getElementById('modalTempoFlashcards').value = '';
            document.getElementById('modalQuantFlashcards').value = '';
            
            // CORRE√á√ÉO: Tentar ler valores dos campos de tempo da tarefa ativa (se houver)
            const temaAtivo = document.getElementById('feedbackTema').value;
            if (temaAtivo) {
                const camposTempo = document.querySelector(`.campos-tempo[data-tema-id="${temaAtivo}"]`);
                if (camposTempo) {
                    const tempoQuestoesInput = camposTempo.querySelector('.tempo-questoes');
                    const quantQuestoesInput = camposTempo.querySelector('.quant-questoes');
                    const tempoFlashcardsInput = camposTempo.querySelector('.tempo-flashcards');
                    const quantFlashcardsInput = camposTempo.querySelector('.quant-flashcards');
                    
                    if (tempoQuestoesInput && tempoQuestoesInput.value) {
                        document.getElementById('modalTempoQuestoes').value = tempoQuestoesInput.value;
                    }
                    if (quantQuestoesInput && quantQuestoesInput.value) {
                        document.getElementById('modalQuantQuestoes').value = quantQuestoesInput.value;
                    }
                    if (tempoFlashcardsInput && tempoFlashcardsInput.value) {
                        document.getElementById('modalTempoFlashcards').value = tempoFlashcardsInput.value;
                    }
                    if (quantFlashcardsInput && quantFlashcardsInput.value) {
                        document.getElementById('modalQuantFlashcards').value = quantFlashcardsInput.value;
                    }
                }
            }
            
            // Mostrar modal
            document.getElementById('encerrarSessaoModal').classList.add('active');
        }
        
        function closeEncerrarSessaoModal() {
            document.getElementById('encerrarSessaoModal').classList.remove('active');
        }
        
        function preencherDadosSessao() {
            const tempoQuestoes = parseInt(document.getElementById('modalTempoQuestoes').value) || 0;
            const quantQuestoes = parseInt(document.getElementById('modalQuantQuestoes').value) || 0;
            const tempoFlashcards = parseInt(document.getElementById('modalTempoFlashcards').value) || 0;
            const quantFlashcards = parseInt(document.getElementById('modalQuantFlashcards').value) || 0;
            
            // Preencher campos do formul√°rio
            const tempoTotal = tempoQuestoes + tempoFlashcards;
            if (tempoTotal > 0) {
                document.getElementById('feedbackTempo').value = tempoTotal;
            }
            
            // Preencher quest√µes (formato: acertos/total)
            if (quantQuestoes > 0) {
                document.getElementById('feedbackQuestoes').value = quantQuestoes + '/' + quantQuestoes;
            }
            
            // Preencher flashcards
            if (quantFlashcards > 0) {
                document.getElementById('feedbackFlashcards').value = quantFlashcards;
            }
            
            // Preencher intervalo se houver
            const numeroIntervalos = intervalosIndividuais.length;
            if (numeroIntervalos > 0) {
                const temposIntervalos = intervalosIndividuais.map(i => formatarTempoCronometro(i.tempo)).join(', ');
                document.getElementById('feedbackNumeroIntervalos').value = numeroIntervalos;
                document.getElementById('feedbackIntervalos').value = temposIntervalos;
            }
            
            // Guardar valores no modal para uso posterior (atrav√©s de atributos data)
            const modal = document.getElementById('encerrarSessaoModal');
            modal.dataset.tempoQuestoes = tempoQuestoes;
            modal.dataset.quantQuestoes = quantQuestoes;
            modal.dataset.tempoFlashcards = tempoFlashcards;
            modal.dataset.quantFlashcards = quantFlashcards;
            
            // Fechar modal
            closeEncerrarSessaoModal();
            
            // Scroll para o formul√°rio
            document.getElementById('feedbackForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function obterTempoCronometroMinutos() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando (n√£o depende de intervalos)
            const segundosPrecisos = cronometroRodando ? calcularTempoDecorrido() : cronometroSegundos;
            return Math.floor(segundosPrecisos / 60);
        }
        
        function obterTempoIntervaloMinutos() {
            return Math.floor(tempoTotalIntervalo / 60);
        }
        
        // ==================== LEMBRETES E ANOTA√á√ïES ====================
        
        function calcularProximaDataLembrete(lembrete) {
            if (lembrete.periodicidade === 'pontual') {
                return null; // N√£o tem pr√≥xima data
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const dataInicial = new Date(lembrete.dataInicial + 'T00:00:00');
            const ultimaData = lembrete.ultimaData ? new Date(lembrete.ultimaData + 'T00:00:00') : dataInicial;
            
            let proximaData = new Date(ultimaData);
            
            switch(lembrete.periodicidade) {
                case 'diaria':
                    proximaData.setDate(proximaData.getDate() + 1);
                    break;
                case 'semanal':
                    proximaData.setDate(proximaData.getDate() + 7);
                    break;
                case 'quinzenal':
                    proximaData.setDate(proximaData.getDate() + 15);
                    break;
                case 'mensal':
                    proximaData.setMonth(proximaData.getMonth() + 1);
                    break;
            }
            
            return proximaData.toISOString().split('T')[0];
        }
        
        function renderLembretes() {
            const container = document.getElementById('lembretesContainer');
            if (!container) return;
            
            const hoje = new Date().toISOString().split('T')[0];
            
            // Separar lembretes ativos e conclu√≠dos
            const lembretesAtivos = lembretes.filter(l => !l.concluido && (!l.proximaData || l.proximaData <= hoje));
            const lembretesFuturos = lembretes.filter(l => !l.concluido && l.proximaData && l.proximaData > hoje);
            const lembretesConcluidos = lembretes.filter(l => l.concluido);
            
            if (lembretes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìå</div><div>Nenhum lembrete cadastrado</div></div>';
                return;
            }
            
            let html = '';
            
            // Lembretes ativos (para hoje)
            if (lembretesAtivos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: var(--turquesa-light); margin-bottom: 10px;">üìå Para Hoje</h3>';
                html += lembretesAtivos.map(l => {
                    const proximaDataFormatada = l.proximaData ? formatarData(l.proximaData) : 'Pontual';
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade === 'pontual' ? 'Pontual' : l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.periodicidade !== 'pontual' ? `<button class="btn-edit" onclick="marcarLembreteConcluido(${l.id})" title="Marcar como conclu√≠do">‚úÖ</button>` : ''}
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes futuros
            if (lembretesFuturos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ Pr√≥ximos</h3>';
                html += lembretesFuturos.map(l => {
                    const proximaDataFormatada = formatarData(l.proximaData);
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes conclu√≠dos (opcional, pode ser ocultado)
            if (lembretesConcluidos.length > 0 && false) { // Desabilitado por enquanto
                html += '<div><h3 style="color: rgba(255,255,255,0.3); margin-bottom: 10px;">‚úÖ Conclu√≠dos</h3>';
                html += lembretesConcluidos.map(l => {
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.5;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="text-decoration: line-through; color: rgba(255,255,255,0.3);">${l.titulo}</div>
                                </div>
                                <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function marcarLembreteConcluido(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            
            if (lembrete.periodicidade === 'pontual') {
                lembrete.concluido = true;
            } else {
                // Atualizar √∫ltima data e calcular pr√≥xima
                const hoje = new Date().toISOString().split('T')[0];
                lembrete.ultimaData = hoje;
                lembrete.proximaData = calcularProximaDataLembrete(lembrete);
            }
            
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('‚úÖ Lembrete atualizado!');
        }
        
        function deletarLembrete(id) {
            if (!confirm('Tem certeza que deseja deletar este lembrete?')) return;
            
            lembretes = lembretes.filter(l => l.id !== id);
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('üóëÔ∏è Lembrete deletado!');
        }
        
        // ==================== CADERNO DE ANOTA√á√ïES ====================
        
        function migrarAnotacoesParaHotTopics() {
            // Migra√ß√£o segura: adicionar campo hotTopics sem perder dados
            const backupKey = fazerBackupCompleto();
            const anotacoesAtuais = JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]');
            
            let atualizadas = false;
            const anotacoesMigradas = anotacoesAtuais.map(a => {
                if (a.hotTopics === undefined) {
                    a.hotTopics = ''; // Campo novo, vazio por padr√£o
                    atualizadas = true;
                }
                return a;
            });
            
            if (atualizadas) {
                validarAntesDeSalvar('anotacoes', anotacoesMigradas);
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoesMigradas));
                anotacoes = anotacoesMigradas;
                console.log(`[MIGRA√á√ÉO] Campo hotTopics adicionado. Backup: ${backupKey}`);
            }
        }
        
        function obterOuCriarAnotacao(temaId) {
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (!anotacao) {
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) return null;
                
                anotacao = {
                    id: Date.now(),
                    temaId: temaId,
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    hotTopics: '', // Campo novo
                    ultimaAtualizacao: new Date().toISOString().split('T')[0]
                };
                anotacoes.push(anotacao);
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            }
            return anotacao;
        }
        
        function navegarParaAnotacao(temaId) {
            // Criar anota√ß√£o se n√£o existir
            obterOuCriarAnotacao(temaId);
            
            // Encontrar a √°rea do tema
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            // Filtrar caderno para mostrar apenas a √°rea do tema
            const filtroArea = document.getElementById('cadernoFiltroArea');
            if (filtroArea) {
                filtroArea.value = tema.area;
            }
            
            // Mostrar se√ß√£o caderno primeiro
            showSection('caderno');
            
            // Renderizar caderno filtrado (renderCadernoV2 n√£o depende de cadernoFiltroTema)
            setTimeout(() => {
                renderCadernoV2();
                
                // Scroll para anota√ß√£o ap√≥s renderizar
            setTimeout(() => {
                const elemento = document.querySelector(`[data-tema-id="${temaId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    elemento.style.background = 'rgba(0,206,209,0.2)';
                    setTimeout(() => {
                        elemento.style.background = '';
                    }, 2000);
                }
                }, 300);
            }, 100);
        }
        
        function atualizarSelectsLembrete() {
            const select = document.getElementById('lembreteTemaId');
            if (!select) return;
            
            select.innerHTML = '<option value="">Nenhum (lembrete geral)</option>';
            
            dados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.area} - ${t.tema}`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectsCaderno() {
            const selectArea = document.getElementById('cadernoFiltroArea');
            const selectTema = document.getElementById('cadernoFiltroTema');
            
            if (selectArea) {
                // Incluir AREAS_FIXAS + √°reas dos dados
                const areasDados = dados.map(t => t.area).filter(a => a);
                const areas = [...new Set([...AREAS_FIXAS, ...areasDados])].sort();
                selectArea.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    selectArea.appendChild(option);
                });
            }
            
            // Resetar select de tema para desabilitado
            if (selectTema) {
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
            }
        }
        
        function atualizarSelectTemaPorArea() {
            const selectTema = document.getElementById('cadernoFiltroTema');
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            if (!selectTema) return;
            
            if (!filtroArea) {
                // Se n√£o h√° √°rea selecionada, desabilitar select de tema
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
                return;
            }
            
            // Habilitar e popular com temas da √°rea selecionada
            selectTema.disabled = false;
            selectTema.innerHTML = '<option value="">Todos os temas desta √°rea</option>';
            
            const temasFiltrados = dados.filter(t => t.area === filtroArea);
            
            temasFiltrados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.tema; // Mostrar apenas o nome do tema, sem repetir √°rea
                selectTema.appendChild(option);
            });
        }
        
        function filtrarCaderno() {
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            
            renderCaderno(filtroArea, filtroTema);
        }
        
        function renderCaderno(filtroArea = '', filtroTema = '') {
            const container = document.getElementById('cadernoContainer');
            if (!container) return;
            
            // CR√çTICO: Recarregar anota√ß√µes do localStorage antes de renderizar
            try {
                const anotacoesSalvas = localStorage.getItem('vrvs_anotacoes');
                if (anotacoesSalvas) {
                    anotacoes = JSON.parse(anotacoesSalvas);
                }
            } catch (e) {
                console.error('[RENDER CADERNO] Erro ao carregar anota√ß√µes:', e);
            }
            
            let anotacoesFiltradas = anotacoes;
            
            if (filtroArea) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => a.area === filtroArea);
            }
            
            if (filtroTema) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => String(a.temaId) === String(filtroTema));
            }
            
            // Agrupar por √°rea
            const anotacoesPorArea = {};
            anotacoesFiltradas.forEach(a => {
                // CORRE√á√ÉO: S√≥ mostrar anota√ß√µes que t√™m conte√∫do OU temaId v√°lido correspondente a um tema
                const tema = dados.find(t => String(t.id) === String(a.temaId));
                if (!tema) {
                    console.warn(`[RENDER CADERNO] Anota√ß√£o sem tema correspondente: temaId=${a.temaId}, tema="${a.tema}"`);
                    return; // Pular anota√ß√µes sem tema correspondente
                }
                
                // Atualizar √°rea e tema da anota√ß√£o com dados do tema (garantir consist√™ncia)
                a.area = tema.area;
                a.tema = tema.tema;
                
                if (!anotacoesPorArea[a.area]) {
                    anotacoesPorArea[a.area] = [];
                }
                anotacoesPorArea[a.area].push(a);
            });
            
            if (anotacoesFiltradas.length === 0 || Object.keys(anotacoesPorArea).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma anota√ß√£o encontrada</div></div>';
                return;
            }
            
            let html = '';
            
            Object.keys(anotacoesPorArea).sort().forEach(area => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 18px;">üìö ${area}</h3>`;
                
                // Ordenar temas dentro da √°rea alfabeticamente (como sugerido pelo Opus)
                anotacoesPorArea[area].sort((a, b) => {
                    const temaA = a.tema || '';
                    const temaB = b.tema || '';
                    return temaA.localeCompare(temaB, 'pt-BR', { sensitivity: 'base' });
                }).forEach(anotacao => {
                    const tema = dados.find(t => String(t.id) === String(anotacao.temaId));
                    if (!tema) return;
                    
                    html += `
                        <div class="task-item" style="margin-bottom: 20px;" data-tema-id="${anotacao.temaId}">
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                    üìù ${anotacao.tema}
                                </div>
                                <div style="font-size: 11px; color: rgba(0,206,209,0.6); margin-bottom: 10px;">
                                    √öltima atualiza√ß√£o: ${formatarData(anotacao.ultimaAtualizacao)}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: var(--cobre-light); margin-bottom: 5px; display: block; font-weight: 600;">üî• Hot Topics (pontos de prova)</label>
                                <textarea 
                                    id="hotTopics_${anotacao.temaId}" 
                                    class="form-input" 
                                    rows="3" 
                                    style="width: 100%; font-family: inherit; resize: vertical; background: rgba(255,127,80,0.05); border: 1px solid rgba(255,127,80,0.3); border-radius: 6px; padding: 10px;"
                                    placeholder="Digite pontos importantes do tema..."
                                    onblur="salvarAnotacao(${anotacao.temaId})"
                                >${((anotacao.hotTopics || '')).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: rgba(0,206,209,0.8); margin-bottom: 5px; display: block;">üìù Anota√ß√µes Gerais</label>
                                <textarea 
                                    id="anotacao_${anotacao.temaId}" 
                                    class="form-input" 
                                    rows="6" 
                                    style="width: 100%; font-family: inherit; resize: vertical;"
                                    placeholder="Digite suas anota√ß√µes aqui..."
                                    onblur="salvarAnotacao(${anotacao.temaId})"
                                >${(anotacao.conteudo || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-edit" onclick="salvarAnotacao(${anotacao.temaId})" title="Salvar">üíæ</button>
                                <button class="btn-edit" onclick="limparAnotacao(${anotacao.temaId})" title="Limpar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function salvarAnotacao(temaId) {
            const textarea = document.getElementById(`anotacao_${temaId}`);
            const hotTopicsTextarea = document.getElementById(`hotTopics_${temaId}`);
            if (!textarea) return;
            
            const anotacao = obterOuCriarAnotacao(temaId);
            if (!anotacao) return;
            
            anotacao.conteudo = textarea.value.trim();
            anotacao.hotTopics = hotTopicsTextarea ? hotTopicsTextarea.value.trim() : '';
            anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
            
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
            
            // Atualizar renderiza√ß√£o
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            renderCaderno(filtroArea, filtroTema);
        }
        
        function limparAnotacao(temaId) {
            if (!confirm('Tem certeza que deseja limpar esta anota√ß√£o?')) return;
            
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (anotacao) {
                anotacao.conteudo = '';
                anotacao.hotTopics = '';
                anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                const textarea = document.getElementById(`anotacao_${temaId}`);
                const hotTopicsTextarea = document.getElementById(`hotTopics_${temaId}`);
                if (textarea) textarea.value = '';
                if (hotTopicsTextarea) hotTopicsTextarea.value = '';
                
                mostrarNotificacaoFeedback('üóëÔ∏è Anota√ß√£o limpa!');
                
                const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
                const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
                renderCaderno(filtroArea, filtroTema);
            }
        }
        
        // ==================== INICIALIZA√á√ÉO ====================
        
        // Garantir carregamento da logo no MacBook
        function garantirLogoCarregada() {
            const logoImg = document.querySelector('.splash-logo');
            if (!logoImg) return;
            
            // For√ßar recarregamento com timestamp √∫nico para evitar cache
            const timestamp = new Date().getTime();
            const logoPath = './logo.png?v=' + timestamp;
            const logoFallback = './logo.jpeg?v=' + timestamp;
            
            // Criar nova imagem para testar
            const testImg = new Image();
            testImg.onload = function() {
                logoImg.src = logoPath;
            };
            testImg.onerror = function() {
                // Tentar fallback
                const testFallback = new Image();
                testFallback.onload = function() {
                    logoImg.src = logoFallback;
                };
                testFallback.onerror = function() {
                    console.warn('Logo n√£o encontrada, usando fallback');
                };
                testFallback.src = logoFallback;
            };
            testImg.src = logoPath;
        }
        
        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', garantirLogoCarregada);
        } else {
            garantirLogoCarregada();
        }
        
        // ==================== SISTEMA DE TUTORIAL E AJUDA ====================
        
        const passosTutorial = [
            {
                titulo: "üéØ Bem-vindo ao VRVS!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Ol√°! Este √© o <strong>VRVS</strong> - seu sistema de gest√£o de estudos.</p>
                    <p style="margin-bottom: 15px;">Vou te mostrar rapidamente como usar cada funcionalidade.</p>
                    <p style="color: rgba(0,206,209,0.8);">üì± Dica: Voc√™ pode instalar como app no seu celular!</p>
                `
            },
            {
                titulo: "üìä Banco de Dados",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Aqui voc√™:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚úÖ Adiciona novos temas para estudar</li>
                        <li>‚úÖ Define √°rea, status e prioridade</li>
                        <li>‚úÖ Visualiza todos seus temas</li>
                        <li>‚úÖ Edita ou remove temas</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">√â a base de tudo!</p>
                `
            },
            {
                titulo: "üìã Tarefas do Dia",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Tarefas de hoje e atrasadas:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üéØ Mostra o que voc√™ precisa estudar HOJE</li>
                        <li>‚è±Ô∏è Op√ß√£o de registrar tempo por atividade</li>
                        <li>üí° Diretrizes personalizadas para cada tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìÖ Agenda",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Timeline dos pr√≥ximos dias:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìÜ Filtre por per√≠odo (semana, m√™s)</li>
                        <li>üîç Visualize o que vem pela frente</li>
                        <li>üìå Organize suas revis√µes</li>
                    </ul>
                `
            },
            {
                titulo: "üí¨ Feedback de Sess√£o",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Registre cada sess√£o de estudos:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚è±Ô∏è Use o cron√¥metro integrado</li>
                        <li>üìä Avalie seu rendimento</li>
                        <li>‚ùì Registre quest√µes e flashcards</li>
                        <li>üìù Adicione observa√ß√µes</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">Todos os dados s√£o salvos automaticamente!</p>
                `
            },
            {
                titulo: "üìà Estat√≠sticas e An√°lises",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Acompanhe seu progresso:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìä Gr√°ficos de performance</li>
                        <li>‚è±Ô∏è An√°lises de tempo (opcional)</li>
                        <li>üìâ Identifica√ß√£o de pontos fracos</li>
                        <li>üéØ M√©tricas por √°rea e tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìå Extras e Backup",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Outras funcionalidades:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìå Lembretes personalizados</li>
                        <li>üìî Caderno de anota√ß√µes</li>
                        <li>üì§ Exportar dados (CSV)</li>
                        <li>üì• Importar dados</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üíæ Tudo √© salvo localmente no seu navegador!</p>
                `
            },
            {
                titulo: "‚úÖ Pronto para come√ßar!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Agora voc√™ conhece todas as funcionalidades!</p>
                    <p style="margin-bottom: 15px;"><strong>Pr√≥ximos passos:</strong></p>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>Adicione seus primeiros temas na aba "Dados"</li>
                        <li>Configure a agenda</li>
                        <li>Comece a estudar e registre suas sess√µes</li>
                    </ol>
                    <p style="margin-top: 15px; color: var(--turquesa-light);">‚ùì D√∫vidas? Use o bot√£o de ajuda no canto da tela!</p>
                `
            }
        ];
        
        let passoAtual = 0;
        
        function iniciarTutorial() {
            passoAtual = 0;
            mostrarPassoTutorial();
            document.getElementById('tutorialModal').style.display = 'flex';
        }
        
        function mostrarPassoTutorial() {
            const passo = passosTutorial[passoAtual];
            document.getElementById('tutorialTitulo').textContent = passo.titulo;
            document.getElementById('tutorialConteudo').innerHTML = passo.conteudo;
            document.getElementById('tutorialProgresso').textContent = `Passo ${passoAtual + 1} de ${passosTutorial.length}`;
            
            // Atualizar bot√µes
            document.getElementById('btnAnterior').style.display = passoAtual === 0 ? 'none' : 'block';
            document.getElementById('btnProximo').textContent = passoAtual === passosTutorial.length - 1 ? 'Finalizar ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function tutorialProximo() {
            if (passoAtual < passosTutorial.length - 1) {
                passoAtual++;
                mostrarPassoTutorial();
            } else {
                finalizarTutorial();
            }
        }
        
        function tutorialAnterior() {
            if (passoAtual > 0) {
                passoAtual--;
                mostrarPassoTutorial();
            }
        }
        
        function pularTutorial() {
            if (confirm('Tem certeza que deseja pular o tutorial?')) {
                finalizarTutorial();
            }
        }
        
        function fecharTutorial() {
            finalizarTutorial();
        }
        
        function finalizarTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            localStorage.setItem('vrvs_tutorial_completo', 'true');
        }
        
        function ocultarBotaoTutorial() {
            const container = document.getElementById('btnAjudaFlutuanteContainer');
            if (container) {
                container.style.display = 'none';
                localStorage.setItem('vrvs_tutorial_oculto', 'true');
            }
        }
        
        // Verificar se o bot√£o deve estar oculto ao carregar
        window.addEventListener('DOMContentLoaded', function() {
            const tutorialOculto = localStorage.getItem('vrvs_tutorial_oculto');
            if (tutorialOculto === 'true') {
                const container = document.getElementById('btnAjudaFlutuanteContainer');
                if (container) {
                    container.style.display = 'none';
                }
            }
        });
        
        // ==================== V√çDEO ANIMADO TUTORIAL ====================
        
        const slidesVideo = [
            {
                titulo: "üß† Bem-vindo ao VRVS",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">üß†</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Sistema de Gest√£o de Estudos</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Uma plataforma completa para organizar seus estudos, acompanhar seu progresso e melhorar seu desempenho.
                    </p>
                `
            },
            {
                titulo: "üìä Organize seus Temas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Adicione e Organize</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Cadastre seus temas por √°rea, defina prioridades e datas. Tudo organizado em um s√≥ lugar.
                    </p>
                `
            },
            {
                titulo: "üìã Tarefas do Dia",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">O que Estudar Hoje?</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Veja suas tarefas do dia e receba diretrizes personalizadas para cada tema. Registre o tempo gasto em quest√µes e flashcards.
                    </p>
                `
            },
            {
                titulo: "üí¨ Registre suas Sess√µes",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üí¨</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Acompanhe seu Progresso</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Use o cron√¥metro integrado, registre seu rendimento, quest√µes e flashcards. Tudo salvo automaticamente.
                    </p>
                `
            },
            {
                titulo: "üìà An√°lises Detalhadas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìà</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Veja seu Desempenho</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Gr√°ficos, estat√≠sticas por √°rea, an√°lises de tempo. Identifique seus pontos fortes e fracos.
                    </p>
                `
            },
            {
                titulo: "‚úÖ Pronto para Come√ßar!",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">‚úÖ</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Comece Agora</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Adicione seus primeiros temas e comece a estudar de forma mais organizada e eficiente.
                    </p>
                `
            }
        ];
        
        let slideAtualVideo = 0;
        
        function mostrarSlideVideo() {
            const slide = slidesVideo[slideAtualVideo];
            document.getElementById('videoSlide').innerHTML = slide.conteudo;
            document.getElementById('videoProgresso').textContent = `${slideAtualVideo + 1} / ${slidesVideo.length}`;
            
            document.getElementById('btnVideoAnterior').style.display = slideAtualVideo === 0 ? 'none' : 'block';
            document.getElementById('btnVideoProximo').textContent = slideAtualVideo === slidesVideo.length - 1 ? 'Fim ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function videoProximo() {
            if (slideAtualVideo < slidesVideo.length - 1) {
                slideAtualVideo++;
                mostrarSlideVideo();
            }
        }
        
        function videoAnterior() {
            if (slideAtualVideo > 0) {
                slideAtualVideo--;
                mostrarSlideVideo();
            }
        }
        
        // Inicializar v√≠deo ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            mostrarSlideVideo();
        });
        
        // ==================== FAQ INTELIGENTE ====================
        
        const faqRespostas = {
            adicionar: {
                titulo: "Como adicionar um tema?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üìä Dados</strong><br>
                    2. Preencha o formul√°rio no topo:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea (ex: Ortopedia)<br>
                       &nbsp;&nbsp;‚Ä¢ Tema (ex: Fraturas do √∫mero)<br>
                       &nbsp;&nbsp;‚Ä¢ Status, Prioridade, Data<br>
                    3. Clique em <strong>üíæ SALVAR</strong><br><br>
                    Pronto! O tema aparecer√° na tabela abaixo.
                `
            },
            feedback: {
                titulo: "Como registrar uma sess√£o?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üí¨ Feedback</strong><br>
                    2. Use o <strong>‚è±Ô∏è Cron√¥metro</strong> durante o estudo<br>
                    3. Ao terminar, clique em <strong>Encerrar Sess√£o</strong><br>
                    4. Preencha:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea e Tema estudado<br>
                       &nbsp;&nbsp;‚Ä¢ Tempo, rendimento<br>
                       &nbsp;&nbsp;‚Ä¢ Quest√µes e flashcards<br>
                       &nbsp;&nbsp;‚Ä¢ Observa√ß√µes<br>
                    5. Clique em <strong>SALVAR FEEDBACK</strong><br><br>
                    Seus dados s√£o salvos automaticamente!
                `
            },
            agenda: {
                titulo: "Como usar a agenda?",
                texto: `
                    <strong>A agenda mostra suas pr√≥ximas revis√µes:</strong><br><br>
                    ‚Ä¢ Filtre por per√≠odo usando os campos de data<br>
                    ‚Ä¢ Clique em <strong>Semana Atual</strong> para ver os pr√≥ximos 7 dias<br>
                    ‚Ä¢ Cada tema mostra: √°rea, prioridade, rendimento<br>
                    ‚Ä¢ A data de agenda √© definida ao adicionar/editar o tema<br><br>
                    <strong>Dica:</strong> Use para planejar sua semana de estudos!
                `
            },
            stats: {
                titulo: "Como ver estat√≠sticas?",
                texto: `
                    <strong>V√°rias formas de analisar seus dados:</strong><br><br>
                    üìà <strong>Aba Gr√°ficos:</strong> Visualiza√ß√µes gerais<br>
                    üîç <strong>Aba An√°lises:</strong> Dados detalhados por √°rea/tema<br>
                    ‚è±Ô∏è <strong>An√°lises de Tempo:</strong> Clique no bot√£o para mostrar<br>
                    üìú <strong>Aba Hist√≥rico:</strong> Todas as sess√µes registradas<br><br>
                    Use os filtros para focar em per√≠odos espec√≠ficos!
                `
            },
            backup: {
                titulo: "Como fazer backup?",
                texto: `
                    <strong>Seus dados j√° s√£o salvos automaticamente!</strong><br><br>
                    Mas voc√™ pode fazer backup extra:<br><br>
                    1. V√° para a aba <strong>üì§ Exportar</strong><br>
                    2. Clique em <strong>üìä Baixar DADOS.csv</strong><br>
                    3. Ou <strong>üìú Baixar HISTORICO.csv</strong><br><br>
                    Os arquivos CSV podem ser abertos no Excel ou Google Sheets.<br><br>
                    <strong>Importante:</strong> Dados ficam no navegador. Se limpar cache, pode perder tudo!
                `
            }
        };
        
        function mostrarResposta(tipo) {
            const resposta = faqRespostas[tipo];
            document.getElementById('perguntaAssistente').value = resposta.titulo;
            document.getElementById('textoResposta').innerHTML = resposta.texto;
            document.getElementById('respostaAssistente').style.display = 'block';
            
            // Scroll suave at√© a resposta
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function responderDuvida() {
            const pergunta = document.getElementById('perguntaAssistente').value.toLowerCase();
            let resposta = '';
            
            // Sistema simples de palavras-chave
            if (pergunta.includes('adicionar') || pergunta.includes('novo') || pergunta.includes('criar') || pergunta.includes('tema')) {
                resposta = faqRespostas.adicionar.texto;
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registrar') || pergunta.includes('cron√¥metro')) {
                resposta = faqRespostas.feedback.texto;
            } else if (pergunta.includes('agenda') || pergunta.includes('timeline') || pergunta.includes('pr√≥xim')) {
                resposta = faqRespostas.agenda.texto;
            } else if (pergunta.includes('estat√≠stica') || pergunta.includes('gr√°fico') || pergunta.includes('an√°lise') || pergunta.includes('performance')) {
                resposta = faqRespostas.stats.texto;
            } else if (pergunta.includes('backup') || pergunta.includes('exportar') || pergunta.includes('salvar') || pergunta.includes('perder')) {
                resposta = faqRespostas.backup.texto;
            } else if (pergunta.includes('tempo') || pergunta.includes('quest√µes') || pergunta.includes('flashcard')) {
                resposta = `
                    <strong>Registrando tempo por atividade:</strong><br><br>
                    1. Na aba <strong>üìã Tarefas</strong> ou <strong>üìÖ Agenda</strong><br>
                    2. Clique no bot√£o <strong>‚è±Ô∏è Mostrar Tempos</strong><br>
                    3. Preencha os campos opcionais de cada tema<br>
                    4. Os dados ser√£o inclu√≠dos nas an√°lises<br><br>
                    Voc√™ tamb√©m pode registrar no Feedback de Sess√£o!
                `;
            } else if (pergunta.includes('como') || pergunta.includes('usar') || pergunta.includes('funciona')) {
                resposta = `
                    <strong>N√£o encontrei uma resposta espec√≠fica.</strong><br><br>
                    Tente uma destas op√ß√µes:<br>
                    ‚Ä¢ Clique nos bot√µes de perguntas frequentes acima<br>
                    ‚Ä¢ Inicie o <strong>Tour Guiado</strong> no topo da p√°gina<br>
                    ‚Ä¢ Seja mais espec√≠fico na pergunta<br><br>
                    <strong>Exemplos de perguntas:</strong><br>
                    "Como adicionar tema?"<br>
                    "Como fazer backup?"<br>
                    "Como ver estat√≠sticas?"
                `;
            } else {
                resposta = `
                    <strong>Desculpe, n√£o entendi sua d√∫vida.</strong><br><br>
                    Clique em uma das <strong>Perguntas Frequentes</strong> acima ou<br>
                    inicie o <strong>üöÄ Tour Guiado</strong> para conhecer a plataforma!
                `;
            }
            
            document.getElementById('textoResposta').innerHTML = resposta;
            document.getElementById('respostaAssistente').style.display = 'block';
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Enter para buscar resposta
        document.addEventListener('DOMContentLoaded', function() {
            const inputPergunta = document.getElementById('perguntaAssistente');
            if (inputPergunta) {
                inputPergunta.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        responderDuvida();
                    }
                });
            }
        });
        
        // ==================== MIGRA√á√ïES E INICIALIZA√á√ïES ====================
        
        // Executar migra√ß√µes na inicializa√ß√£o
        migrarAnotacoesParaHotTopics();
        
        // Inicializar estrutura do Di√°rio se n√£o existir
        function inicializarDiario() {
            const diarioExistente = localStorage.getItem('vrvs_diario');
            if (diarioExistente) return;
            
            const diarioInicial = {
                schemaVersion: 1,
                entries: []
            };
            
            localStorage.setItem('vrvs_diario', JSON.stringify(diarioInicial));
            console.log('[DI√ÅRIO] Estrutura inicializada');
        }
        
        inicializarDiario();
        
        // ==================== WINDOW ONLOAD ====================
        
        window.onload = function() {
            // Garantir logo novamente ap√≥s carregamento completo
            garantirLogoCarregada();
            
            // Restaurar cron√¥metro se estava rodando antes
            restaurarCronometro();
            
            // Verificar se √© primeira vez e mostrar tutorial
            const tutorialCompleto = localStorage.getItem('vrvs_tutorial_completo');
            if (!tutorialCompleto) {
                setTimeout(() => {
                    if (confirm('üëã Primeira vez aqui? Gostaria de fazer um tour r√°pido pela plataforma?')) {
                        iniciarTutorial();
                    } else {
                        localStorage.setItem('vrvs_tutorial_completo', 'true');
                    }
                }, 1000);
            }
            
            // Page Visibility API - Detectar quando aba sai/volta ao foco
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Aba saiu de foco - salvar estado atual (funciona offline)
                    if (cronometroRodando || intervaloAtivo) {
                        salvarEstadoCronometro();
                        console.log('üì± Aba em segundo plano - cron√¥metro continua contando');
                    }
                } else {
                    // Aba voltou ao foco - restaurar e calcular tempo decorrido BASEADO EM TIMESTAMP ORIGINAL
                    const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                    const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                    
                    if (timestampOriginal && segundosOriginais) {
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - parseInt(timestampOriginal)) / 1000);
                        
                        // Atualizar cron√¥metro principal baseado no timestamp original
                        cronometroSegundos = parseInt(segundosOriginais) + tempoDecorrido;
                        
                        // Restaurar outros dados
                        const salvo = localStorage.getItem('vrvs_cronometro');
                        if (salvo) {
                            try {
                                const dados = JSON.parse(salvo);
                                tempoTotalIntervalo = dados.tempoIntervalo || 0;
                                
                                // Se estava em intervalo, atualizar intervalo tamb√©m
                                if (dados.intervaloAtivo) {
                                    intervaloAtivo = true;
                                    const intervaloOriginal = dados.intervaloSegundos || 0;
                                    intervaloSegundos = intervaloOriginal + tempoDecorrido;
                                    
                                    // Reiniciar timer do intervalo se necess√°rio
                                    if (intervaloInterval) {
                                        clearInterval(intervaloInterval);
                                    }
                                    intervaloInterval = setInterval(() => {
                                        // Calcular baseado em timestamp para intervalo tamb√©m
                                        const agoraIntervalo = Date.now();
                                        const tempoDecorridoIntervalo = Math.floor((agoraIntervalo - parseInt(timestampOriginal)) / 1000);
                                        intervaloSegundos = intervaloOriginal + tempoDecorridoIntervalo;
                                        document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                                    }, 100);
                                    
                                    document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                                    document.getElementById('tempoIntervalo').style.display = 'block';
                                    document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                                }
                                
                                // Se estava rodando, garantir que continue rodando
                                if (dados.rodando && !cronometroRodando) {
                                    cronometroInicioTimestamp = parseInt(timestampOriginal);
                                    iniciarCronometroContagem();
                                    document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                                } else if (dados.rodando && cronometroRodando) {
                                    // J√° est√° rodando, apenas atualizar display
                                    atualizarDisplayCronometro();
                                }
                                
                                console.log('üì± Aba voltou ao foco - cron√¥metro atualizado (+' + tempoDecorrido + 's)');
                            } catch (e) {
                                console.log('Erro ao restaurar:', e);
                            }
                        }
                    }
                }
            });
            
            // Tamb√©m salvar antes de fechar a p√°gina
            window.addEventListener('beforeunload', function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            });
            
            // Salvar periodicamente enquanto est√° rodando (a cada 30 segundos)
            setInterval(function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            }, 30000); // Salvar a cada 30 segundos
            
            // ==================== SISTEMA DE ATUALIZA√á√ÉO AUTOM√ÅTICA ====================
            const APP_VERSION = '5.3';
            const SW_VERSION = 'vrvs-v5.3-sincronizacao-completa-20251212-2250';
            
            // Changelog das atualiza√ß√µes
            const CHANGELOG = {
                '5.3': {
                    titulo: 'üéâ Grande Refatora√ß√£o - Interface Renovada!',
                    data: '12 de Dezembro de 2025',
                    mudancas: [
                        {
                            icone: 'üìä',
                            titulo: '10 Abas Consolidadas',
                            descricao: 'Reduzimos de 16 para 10 abas, organizando melhor a navega√ß√£o. Agora √© mais f√°cil encontrar o que precisa!'
                        },
                        {
                            icone: 'üìì',
                            titulo: 'Caderno V2 - √Åreas Colaps√°veis',
                            descricao: 'O Caderno agora organiza temas por √°rea, com √°reas que podem ser expandidas/colapsadas. Visualiza√ß√£o mais limpa e organizada!'
                        },
                        {
                            icone: 'üî•',
                            titulo: 'Hot Topics em Destaque',
                            descricao: 'Hot Topics agora aparecem em preview no Caderno, destacados com cor especial. Exporte todos em HTML para revis√£o!'
                        },
                        {
                            icone: 'üìà',
                            titulo: 'An√°lises Unificado',
                            descricao: 'Todas as an√°lises em um s√≥ lugar: Resumo, Gr√°ficos e Hist√≥rico. Navegue entre as vistas facilmente!'
                        },
                        {
                            icone: '‚ûï',
                            titulo: 'Cadastro Integrado',
                            descricao: 'Adicionar novo tema agora √© mais r√°pido - tudo em um modal dentro da aba Dados!'
                        },
                        {
                            icone: 'üìÖ',
                            titulo: 'Agenda Unificada',
                            descricao: 'Timeline e Pend√™ncias agora est√£o juntas. Use o toggle para alternar entre as vistas!'
                        }
                    ]
                },
                '5.2': {
                    titulo: 'Di√°rio de Aprendizados',
                    data: '11 de Dezembro de 2025',
                    mudancas: [
                        {
                            icone: 'üìî',
                            titulo: 'Novo Sistema de Di√°rio',
                            descricao: 'Registre seus aprendizados e pontos esquecidos diariamente, organizados por data e tema!'
                        }
                    ]
                }
            };
            
            // Registrar Service Worker para funcionamento offline
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' }).then((registration) => {
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // Verificar atualiza√ß√µes imediatamente
                    registration.update();
                    
                    // Detectar quando h√° nova vers√£o dispon√≠vel
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ Nova vers√£o do Service Worker detectada!');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // H√° uma nova vers√£o instalada, mas ainda n√£o ativa
                                mostrarNotificacaoAtualizacao();
                            }
                        });
                    });
                    
                    // Verificar atualiza√ß√µes periodicamente (a cada 1 minuto)
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                    
                    // Limpar caches antigos ao iniciar
                    if ('caches' in window) {
                        caches.keys().then((cacheNames) => {
                                cacheNames.forEach((cacheName) => {
                                if (!cacheName.includes('v5.3') && cacheName.startsWith('vrvs-')) {
                                    console.log('üóëÔ∏è Removendo cache antigo:', cacheName);
                                    caches.delete(cacheName);
                                }
                            });
                        });
                    }
                }).catch((error) => {
                    console.error('‚ö†Ô∏è Erro ao registrar Service Worker:', error);
                });
            }
            
            // Fun√ß√£o para mostrar notifica√ß√£o de atualiza√ß√£o
            function mostrarNotificacaoAtualizacao() {
                const notificacao = document.createElement('div');
                notificacao.id = 'notificacaoAtualizacao';
                notificacao.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--cobre-main), var(--cobre-dark));
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(255, 127, 80, 0.4);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    animation: slideInRight 0.3s ease;
                `;
                notificacao.innerHTML = `
                    <span>üîÑ Nova vers√£o dispon√≠vel!</span>
                    <button onclick="atualizarApp()" style="
                        background: white;
                        color: var(--cobre-main);
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                    ">Atualizar Agora</button>
                `;
                document.body.appendChild(notificacao);
                
                // Auto-remover ap√≥s 10 segundos se n√£o clicar
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => notificacao.remove(), 300);
                    }
                }, 10000);
            }
            
            // Fun√ß√£o para for√ßar atualiza√ß√£o do app
            window.atualizarApp = function() {
                // Salvar vers√£o anterior para mostrar changelog ap√≥s reload
                const versaoAnterior = localStorage.getItem('vrvs_versao_anterior') || '5.0';
                localStorage.setItem('vrvs_versao_anterior', APP_VERSION);
                localStorage.setItem('vrvs_mostrar_changelog', 'true');
                
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then((registrations) => {
                        registrations.forEach((registration) => {
                            if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    
                    // Limpar todos os caches
                    if ('caches' in window) {
                        caches.keys().then((cacheNames) => {
                            return Promise.all(cacheNames.map(name => caches.delete(name)));
                        }).then(() => {
                            console.log('‚úÖ Cache limpo! Recarregando...');
                            window.location.reload(true);
                        });
                    } else {
                        window.location.reload(true);
                    }
                } else {
                    window.location.reload(true);
                }
            };
            
            // Verificar se deve mostrar changelog ap√≥s atualiza√ß√£o
            function verificarChangelogAposAtualizacao() {
                const mostrarChangelog = localStorage.getItem('vrvs_mostrar_changelog');
                if (mostrarChangelog === 'true') {
                    localStorage.removeItem('vrvs_mostrar_changelog');
                    const versaoAnterior = localStorage.getItem('vrvs_versao_anterior') || '5.0';
                    mostrarModalAtualizacao(APP_VERSION, versaoAnterior);
                }
            }
            
            // Mostrar modal de atualiza√ß√£o
            function mostrarModalAtualizacao(versaoAtual, versaoAnterior) {
                const changelog = CHANGELOG[versaoAtual];
                if (!changelog) return;
                
                const modal = document.getElementById('modalAtualizacao');
                const titulo = document.getElementById('atualizacaoTitulo');
                const conteudo = document.getElementById('atualizacaoConteudo');
                
                titulo.textContent = changelog.titulo;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                            Vers√£o ${versaoAtual} ‚Ä¢ ${changelog.data}
                        </div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                            O que mudou nesta vers√£o:
                        </div>
                `;
                
                changelog.mudancas.forEach((mudanca, index) => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px; border-left: 3px solid var(--turquesa-main);">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="font-size: 24px;">${mudanca.icone}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px; font-size: 14px;">
                                        ${mudanca.titulo}
                                    </div>
                                    <div style="font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.5;">
                                        ${mudanca.descricao}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                conteudo.innerHTML = html;
                
                modal.classList.add('active');
            }
            
            function fecharModalAtualizacao() {
                document.getElementById('modalAtualizacao').classList.remove('active');
            }
            
            function iniciarTutorialAtualizacao() {
                fecharModalAtualizacao();
                setTimeout(() => {
                    iniciarTutorialNovidades();
                }, 300);
            }
            
            // Tutorial espec√≠fico das novidades
            function iniciarTutorialNovidades() {
                const passosNovidades = [
                    {
                        titulo: 'üìä 10 Abas Consolidadas',
                        conteudo: `
                            <p style="margin-bottom: 15px;">A navega√ß√£o foi simplificada! Agora temos apenas <strong>10 abas</strong> organizadas em grupos:</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">üìö ESTUDO (uso di√°rio)</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìã Tarefa</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìù Feedback</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìî Di√°rio</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìì Caderno</div>
                                <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 10px;">üìÖ PLANEJAMENTO</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìÖ Agenda</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìä Dados</div>
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">üìà AN√ÅLISE</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìà An√°lises</div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìì Caderno V2 - √Åreas Colaps√°veis',
                        conteudo: `
                            <p style="margin-bottom: 15px;">O <strong>Caderno</strong> foi completamente renovado!</p>
                            <ul style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li><strong>√Åreas colaps√°veis:</strong> Clique no cabe√ßalho da √°rea para expandir/colapsar</li>
                                <li><strong>Preview de Hot Topics:</strong> Veja seus Hot Topics destacados em cada tema</li>
                                <li><strong>Visualiza√ß√£o limpa:</strong> Apenas temas com conte√∫do aparecem destacados</li>
                                <li><strong>Edi√ß√£o r√°pida:</strong> Clique no √≠cone ‚úèÔ∏è para editar anota√ß√µes</li>
                            </ul>
                            <div style="background: rgba(255,127,80,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--cobre-main);">
                                <div style="font-size: 12px; color: var(--cobre-light);">
                                    üí° <strong>Dica:</strong> Use Hot Topics para anotar os pontos que mais caem na prova!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìà An√°lises Unificado',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Todas as an√°lises agora est√£o em um s√≥ lugar!</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">4 Vistas Dispon√≠veis:</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìä <strong>Resumo:</strong> M√©tricas principais em cards</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìà <strong>Gr√°ficos:</strong> Visualiza√ß√µes de performance</div>
                                <!-- Detalhado temporariamente removido -->
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px;">üìú <strong>Hist√≥rico:</strong> Todas as sess√µes registradas</div>
                            </div>
                            <p style="font-size: 12px; color: rgba(255,255,255,0.6);">Use os bot√µes de sub-navega√ß√£o para alternar entre as vistas!</p>
                        `
                    },
                    {
                        titulo: '‚ûï Cadastro Integrado',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Adicionar novos temas ficou mais r√°pido!</p>
                            <ol style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li>V√° na aba <strong>üìä Dados</strong></li>
                                <li>Clique no bot√£o <strong>‚ûï Novo Tema</strong> no topo</li>
                                <li>Preencha √°rea, tema e prioridade</li>
                                <li>Salve - pronto! Uma anota√ß√£o vazia ser√° criada automaticamente</li>
                            </ol>
                            <div style="background: rgba(0,206,209,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--turquesa-main);">
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                    ‚ú® N√£o precisa mais ir em uma aba separada para cadastrar!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìÖ Agenda Unificada',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Timeline e Pend√™ncias agora est√£o juntas!</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">Use o Toggle para alternar:</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìÖ <strong>Timeline:</strong> Veja seu cronograma completo</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px;">üîî <strong>Atrasados:</strong> Veja apenas o que est√° pendente</div>
                            </div>
                            <p style="font-size: 12px; color: rgba(255,255,255,0.6);">Tudo em um s√≥ lugar, mais organizado!</p>
                        `
                    },
                    {
                        titulo: 'üî• Exporta√ß√£o Hot Topics HTML',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Nova funcionalidade: exporte todos os seus Hot Topics em um arquivo HTML bonito!</p>
                            <ol style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li>V√° na aba <strong>üìì Caderno</strong></li>
                                <li>Clique no bot√£o <strong>üî• Exportar HTML</strong> no topo</li>
                                <li>Um arquivo HTML ser√° baixado com todos os Hot Topics</li>
                                <li>Abra no navegador para revisar ou imprimir</li>
                            </ol>
                            <div style="background: rgba(255,127,80,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--cobre-main);">
                                <div style="font-size: 12px; color: var(--cobre-light);">
                                    üí° Perfeito para revis√£o antes da prova!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: '‚úÖ Pronto para usar!',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Essas s√£o as principais mudan√ßas da vers√£o ${APP_VERSION}!</p>
                            <p style="margin-bottom: 15px;">Explore as novas funcionalidades e aproveite a interface mais organizada.</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
                                    üí° <strong>Dica:</strong> Se tiver d√∫vidas, use a aba <strong>‚ùì Ajuda</strong> para ver tutoriais e FAQ atualizados!
                                </div>
                            </div>
                        `
                    }
                ];
                
                // Usar o sistema de tutorial existente, mas com passos diferentes
                passosTutorial = passosNovidades;
                passoAtual = 0;
                mostrarPassoTutorial();
                document.getElementById('tutorialModal').style.display = 'flex';
            }
            
            // Splash Screen - Esconder ap√≥s carregar (executar apenas uma vez)
            if (!window.splashScreenRemovido) {
                window.splashScreenRemovido = true;
                setTimeout(() => {
                    const splash = document.getElementById('splashScreen');
                    if (splash && !splash.classList.contains('hidden')) {
                        splash.classList.add('fade-out');
                        if (document.body) {
                            document.body.classList.remove('splash-loading');
                        }
                        setTimeout(() => {
                            if (splash && !splash.classList.contains('hidden')) {
                                splash.classList.add('hidden');
                            }
                        }, 800);
                    }
                }, 2500); // Mostrar por 2.5 segundos
            }
            
            // Inicializar campo de data com hoje (com verifica√ß√£o de seguran√ßa)
            const feedbackData = document.getElementById('feedbackData');
            if (feedbackData) {
                feedbackData.value = new Date().toISOString().split('T')[0];
            }
            
            // Inicializar data inicial do lembrete com hoje
            const lembreteDataInicial = document.getElementById('lembreteDataInicial');
            if (lembreteDataInicial) {
                lembreteDataInicial.value = new Date().toISOString().split('T')[0];
            }
            
            // Event listeners para filtros de agenda (com verifica√ß√£o de seguran√ßa)
            const agendaDataInicio = document.getElementById('agendaDataInicio');
            const agendaDataFim = document.getElementById('agendaDataFim');
            if (agendaDataInicio && !agendaDataInicio.dataset.listenerAdded) {
                agendaDataInicio.dataset.listenerAdded = 'true';
                agendaDataInicio.addEventListener('change', renderAgenda);
            }
            if (agendaDataFim && !agendaDataFim.dataset.listenerAdded) {
                agendaDataFim.dataset.listenerAdded = 'true';
                agendaDataFim.addEventListener('change', renderAgenda);
            }
            
            // CADASTRO FORM
            document.getElementById('cadastroForm').onsubmit = function(e) {
                e.preventDefault();
                // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
                const novaAreaInput = document.getElementById('novaAreaInput');
                let area = '';
                if (novaAreaInput && novaAreaInput.style.display !== 'none' && novaAreaInput.value.trim()) {
                    area = novaAreaInput.value.trim();
                } else {
                    area = document.getElementById('novaArea').value.trim();
                }
                
                // Validar que n√£o √© a op√ß√£o especial
                if (area === '__NOVA_AREA__' || !area) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                    return;
                }
                
                const tema = document.getElementById('novoTema').value.trim();
                const prioridade = parseInt(document.getElementById('novaPrioridade').value);
                const status = document.getElementById('novaStatus').value;
                const dataInicio = document.getElementById('novaDataInicio').value;
                
                const novoTema = {
                    id: Date.now(),
                    area: normalizeArea(area, tema),
                    tema: tema,
                    status: status,
                    prioridade: prioridade,
                    dificuldade: 'M√©dia',
                    rendimento: 0,
                    sessoes: 0,
                    ultEstudo: '',
                    agenda: dataInicio || '',
                    tempo: 0,
                    observacoes: '',
                    contador80: 0,
                    sugestao: ''
                };
                
                dados.push(novoTema);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                this.reset();
                mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
                renderDados();
                updateFeedbackSelect();
                renderPendencias();
            };
            
            // FEEDBACK FORM - 100% FUNCIONANDO!
            document.getElementById('feedbackArea').addEventListener('change', updateFeedbackTemaSelect);
            document.getElementById('feedbackForm').onsubmit = function(e) {
                e.preventDefault();
                const temaId = document.getElementById('feedbackTema').value;
                // CORRE√á√ÉO: Usar data do formul√°rio (input feedbackData)
                const dataSessao = document.getElementById('feedbackData').value;
                if (!dataSessao) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione uma data para a sess√£o!', 'error');
                    return;
                }
                const rendimento = parseInt(document.getElementById('feedbackRendimento').value);
                const tempoInput = document.getElementById('feedbackTempo');
                // Usar tempo do cron√¥metro se dispon√≠vel, sen√£o usar o input
                const tempo = cronometroSegundos > 0 ? obterTempoCronometroMinutos() : (parseInt(tempoInput.value) || 0);
                const tempoIntervalo = obterTempoIntervaloMinutos(); // Tempo de intervalo em minutos
                // Se usar cron√¥metro, atualizar o campo de input tamb√©m
                if (cronometroSegundos > 0) {
                    tempoInput.value = tempo;
                }
                
                // Novos campos opcionais
                const numeroIntervalos = parseInt(document.getElementById('feedbackNumeroIntervalos').value) || 0;
                const intervalosTexto = document.getElementById('feedbackIntervalos').value.trim() || '';
                const questoesTexto = document.getElementById('feedbackQuestoes').value.trim() || '';
                const flashcards = parseInt(document.getElementById('feedbackFlashcards').value) || 0;
                
                // Extrair dados de quest√µes (formato: acertos/total)
                let tempoQuestoes = 0;
                let quantQuestoes = 0;
                let quantQuestoesAcertos = 0;
                if (questoesTexto && questoesTexto.includes('/')) {
                    const partes = questoesTexto.split('/');
                    quantQuestoesAcertos = parseInt(partes[0]) || 0;
                    quantQuestoes = parseInt(partes[1]) || 0;
                }
                // Tentar obter tempo de quest√µes do modal ou usar 0
                const modal = document.getElementById('encerrarSessaoModal');
                if (modal && modal.dataset.tempoQuestoes) {
                    tempoQuestoes = parseInt(modal.dataset.tempoQuestoes) || 0;
                }
                
                // Extrair dados de flashcards
                let tempoFlashcards = 0;
                let quantFlashcards = 0;
                if (flashcards > 0) {
                    quantFlashcards = flashcards;
                    if (modal && modal.dataset.tempoFlashcards) {
                        tempoFlashcards = parseInt(modal.dataset.tempoFlashcards) || 0;
                    }
                }
                
                const sugestao = document.getElementById('feedbackSugestao').value.trim();
                const obs = ''; // Campo removido - n√£o mais usado
                
                // CORRE√á√ÉO: Compara√ß√£o correta de IDs
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado! Selecione um m√≥dulo v√°lido.', 'error');
                    return;
                }
                
                // üîß CORRE√á√ÉO M√çNIMA: Salvar contador80 antes para usar no c√°lculo correto
                const contador80Antes = parseInt(tema.contador80) || 0;
                const sessoesAntes = tema.sessoes || 0;
                
                // Atualizar dados do tema
                tema.rendimento = rendimento / 100;
                tema.sessoes = (tema.sessoes || 0) + 1;
                tema.ultEstudo = dataSessao;
                
                // üîß CORRE√á√ÉO: Na segunda sess√£o, usar contador80 = 0 para o c√°lculo (primeira n√£o conta)
                tema.contador80 = (sessoesAntes === 1 ? 0 : contador80Antes);
                
                // Calcular pr√≥xima revis√£o ANTES de atualizar contador80
                // CORRE√á√ÉO: Passar dataSessao para calcular baseado na data do feedback, n√£o na data atual
                tema.agenda = calcularProximaRevisao(tema, dataSessao);
                
                // Atualizar contador80 ap√≥s calcular o intervalo
                if (rendimento >= 80) {
                    tema.contador80 = (sessoesAntes === 1 ? 0 : contador80Antes) + 1;
                } else {
                    tema.contador80 = 0;
                }
                tema.tempo = (tema.tempo || 0) + tempo;
                tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
                
                // Adicionar observa√ß√µes E sugest√£o
                let novaObs = '';
                if (obs) novaObs = `${dataSessao}: ${obs}`;
                
                // Adicionar novos dados √†s observa√ß√µes se preenchidos
                if (questoesTexto) {
                    novaObs += (novaObs ? ' | ' : '') + `Q${questoesTexto}`;
                }
                if (flashcards > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `FC${flashcards}`;
                }
                if (numeroIntervalos > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `Intervalos: ${numeroIntervalos} (${intervalosTexto || 'registrados'})`;
                }
                
                if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
                
                if (novaObs) {
                    tema.observacoes = tema.observacoes 
                        ? tema.observacoes + '\n' + novaObs
                        : novaObs;
                }
                
                // SALVAR SUGEST√ÉO NO TEMA
                tema.sugestao = sugestao || '';
                
                // ADICIONAR AO HIST√ìRICO
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(tema.area, tema.tema);
                historico.push({
                    id: Date.now(),
                    temaId: tema.id,
                    area: areaCorrigida,
                    tema: temaCorrigido,
                    rendimento: rendimento / 100,
                    tempo: tempo,
                    tempoIntervalo: tempoIntervalo || 0, // Tempo de intervalo em minutos
                    numeroIntervalos: numeroIntervalos, // N√∫mero de intervalos
                    intervalos: intervalosTexto, // Tempos de cada intervalo
                    tempoQuestoes: tempoQuestoes, // Tempo gasto em quest√µes (min)
                    quantQuestoes: quantQuestoes, // Quantidade total de quest√µes
                    quantQuestoesAcertos: quantQuestoesAcertos, // Quantidade de acertos
                    tempoFlashcards: tempoFlashcards, // Tempo gasto em flashcards (min)
                    quantFlashcards: quantFlashcards, // Quantidade de flashcards revisados
                    questoes: questoesTexto, // Quest√µes (acertos/total) - mantido para compatibilidade
                    flashcards: quantFlashcards, // Quantidade de flashcards - mantido para compatibilidade
                    data: dataSessao,
                    observacoes: '-', // Campo removido do formul√°rio
                    sugestao: sugestao || '-'
                });
                
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                
                this.reset();
                document.getElementById('feedbackData').value = new Date().toISOString().split('T')[0];
                // Limpar campos opcionais tamb√©m
                document.getElementById('feedbackNumeroIntervalos').value = '0';
                document.getElementById('feedbackIntervalos').value = '';
                document.getElementById('feedbackQuestoes').value = '';
                document.getElementById('feedbackFlashcards').value = '';
                
                // Resetar cron√¥metro ap√≥s salvar (incluindo tempo de intervalo)
                resetCronometro();
                
                // NOTIFICA√á√ÉO DE SUCESSO!
                const proximaData = formatarData(tema.agenda);
                mostrarNotificacaoFeedback(`‚úÖ Performance registrada!<br>üìÖ Pr√≥xima revis√£o: ${proximaData}`);
                
                renderTarefas();
                renderAgenda();
                renderDados();
                renderHistorico();
                renderPendencias();
                updateStats();
            };
            
            // EDIT FORM
            document.getElementById('editForm').onsubmit = function(e) {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const tema = dados.find(t => String(t.id) === String(id));
                
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                    return;
                }
                
                // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
                const editAreaInput = document.getElementById('editAreaInput');
                let areaEdit = '';
                if (editAreaInput && editAreaInput.style.display !== 'none' && editAreaInput.value.trim()) {
                    areaEdit = editAreaInput.value.trim();
                } else {
                    areaEdit = document.getElementById('editArea').value.trim();
                }
                
                // Validar que n√£o √© a op√ß√£o especial
                if (areaEdit === '__NOVA_AREA__' || !areaEdit) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                    return;
                }
                
                tema.area = normalizeArea(areaEdit);
                tema.tema = document.getElementById('editTema').value.trim();
                tema.prioridade = parseInt(document.getElementById('editPrioridade').value);
                const novoStatus = document.getElementById('editStatus').value;
                tema.status = novoStatus;
                
                // CORRE√á√ÉO: Se mudou para Conclu√≠do ou Suspenso, limpar agenda
                if (novoStatus === 'Conclu√≠do' || novoStatus === 'Suspenso') {
                    tema.agenda = '';
                } else {
                    // Recalcular agenda se necess√°rio
                    if (tema.sessoes > 0) {
                        tema.agenda = calcularProximaRevisao(tema);
                    }
                }
                
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                
                closeEditModal();
                mostrarNotificacaoFeedback('‚úÖ Tema atualizado com sucesso!');
                
                renderDados();
                renderTarefas();
                renderAgenda();
                renderPendencias();
                updateFeedbackSelect();
            };
            
            // LEMBRETE FORM
            document.getElementById('lembreteForm').onsubmit = function(e) {
                e.preventDefault();
                const titulo = document.getElementById('lembreteTitulo').value.trim();
                const descricao = document.getElementById('lembreteDescricao').value.trim();
                const periodicidade = document.getElementById('lembretePeriodicidade').value;
                const temaId = document.getElementById('lembreteTemaId').value;
                const dataInicial = document.getElementById('lembreteDataInicial').value;
                
                const novoLembrete = {
                    id: Date.now(),
                    titulo: titulo,
                    descricao: descricao || '',
                    periodicidade: periodicidade,
                    temaId: temaId || null,
                    dataInicial: dataInicial,
                    proximaData: periodicidade === 'pontual' ? dataInicial : calcularProximaDataLembrete({
                        periodicidade: periodicidade,
                        dataInicial: dataInicial,
                        ultimaData: null
                    }),
                    ultimaData: null,
                    concluido: false
                };
                
                lembretes.push(novoLembrete);
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                
                mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado com sucesso!');
                
                // Limpar formul√°rio
                this.reset();
                document.getElementById('lembreteDataInicial').value = new Date().toISOString().split('T')[0];
                
                renderLembretes();
            };
            
            // Inicializa√ß√µes
            renderTarefas();
            renderAgenda();
            renderDados();
            renderPendencias();
            // REMOVIDO: inicializarEventListenersPendencias() - usando onclick inline agora
            updateFeedbackSelect();
            updateStats();
            renderHistorico();
            atualizarSelectsLembrete();
            renderLembretes();
            atualizarSelectsCaderno();
            renderCaderno();
            
            // Popular select de √°reas fixas no cadastro
            const novaAreaSelect = document.getElementById('novaArea');
            if (novaAreaSelect) {
                novaAreaSelect.innerHTML = '<option value="">Selecione...</option>' + 
                    AREAS_FIXAS.map(area => `<option value="${area}">${area}</option>`).join('') +
                    '<option value="__NOVA_AREA__">‚ûï Adicionar Nova √Årea...</option>';
            }
            
            // Inicializar Di√°rio
            carregarDiario();
            renderDiario();
            
            // Garantir que bot√£o + Nova tenha texto branco vis√≠vel (corrige problema de heran√ßa do card-title)
            setTimeout(() => {
                const btnNova = document.getElementById('btnNovaDiario');
                if (btnNova) {
                    btnNova.style.setProperty('color', '#FFFFFF', 'important');
                    btnNova.style.setProperty('-webkit-text-fill-color', '#FFFFFF', 'important');
                    btnNova.style.setProperty('text-shadow', '0 1px 3px rgba(0,0,0,0.5)', 'important');
                }
            }, 100);
        };
        
        function atualizarTemasCadastro(areaSelecionada) {
            // Fun√ß√£o para atualizar temas no cadastro quando √°rea mudar (se necess√°rio no futuro)
            // Por enquanto, apenas placeholder
        }
        
        // ==================== DI√ÅRIO DE APRENDIZADOS ====================
        
        const DIARIO_SCHEMA_VERSION = '1.0';
        let modoDiario = 'recall'; // 'recall' ou 'respostas'
        
        // ==================== SRS - SISTEMA DE REVIS√ÉO ESPA√áADA ====================
        
        // Modo da aba do Di√°rio: 'lista' ou 'sessao'
        let abaDiarioAtiva = 'lista';
        
        // Modo da sess√£o: 'programado' (FSRS) ou 'livre'
        let modoSessaoDiario = 'programado';
        
        // Estado interno da sess√£o de flashcards do Di√°rio
        let sessaoDiario = {
            tipo: null,          // 'programado' | 'livre'
            filaIds: [],         // array de IDs de entradas
            indiceAtual: 0       // √≠ndice na fila
        };
        
        // Fun√ß√µes utilit√°rias de data
        function hojeStr() {
            return new Date().toISOString().split('T')[0]; // 'YYYY-MM-DD'
        }
        
        // Helper para formatar texto do Di√°rio preservando quebras de linha
        function formatarTextoDiario(texto) {
            if (!texto) return '';
            const seguro = String(texto)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            return seguro.replace(/\n/g, '<br>');
        }
        
        function addDias(dateStr, dias) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + dias);
            return d.toISOString().split('T')[0];
        }
        
        function diffEmDias(data1, data2) {
            // data1 e data2 em 'YYYY-MM-DD'
            // retornar data2 - data1 em dias
            const d1 = new Date(data1);
            const d2 = new Date(data2);
            const diffTime = d2 - d1;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // ==================== VRVS 3P - CONSTANTES E FUN√á√ïES AUXILIARES ====================
        
        // Intervalos de est√°gio VRVS 3P (em dias)
        const VRVS3P_STAGE_INTERVALS = [1, 2, 4, 7, 12, 20, 35, 60, 90, 135, 200];
        const VRVS3P_MAX_STAGE = VRVS3P_STAGE_INTERVALS.length - 1; // 10
        
        // Reten√ß√£o estimada por est√°gio (0-10, 0-based como c√≥digo atual)
        const VRVS3P_RETENCAO_POR_ESTAGIO = [
            0.40, // √≠ndice 0 = est√°gio 0 (novo)
            0.55, // √≠ndice 1 = est√°gio 1
            0.65, // √≠ndice 2 = est√°gio 2
            0.72, // √≠ndice 3 = est√°gio 3
            0.78, // √≠ndice 4 = est√°gio 4
            0.83, // √≠ndice 5 = est√°gio 5
            0.88, // √≠ndice 6 = est√°gio 6
            0.92, // √≠ndice 7 = est√°gio 7
            0.95, // √≠ndice 8 = est√°gio 8
            0.97, // √≠ndice 9 = est√°gio 9
            0.98  // √≠ndice 10 = est√°gio 10 (m√°ximo)
        ];
        
        // Obter reten√ß√£o estimada por est√°gio (mant√©m compatibilidade 0-based)
        function obterRetencaoPorEstagio(estagio) {
            const estagioClamped = Math.min(Math.max(estagio || 0, 0), 10);
            return VRVS3P_RETENCAO_POR_ESTAGIO[estagioClamped];
        }
        
        // Classificar faixa de reten√ß√£o (para cores)
        function classificarFaixaRetencao(pct) {
            // pct em 0-1
            if (pct < 0.65) return 'baixa';    // vermelho
            if (pct < 0.80) return 'media';    // √¢mbar
            return 'alta';                     // verde (>= 0.80)
        }
        
        // Mapear repeticoes antigas para est√°gio inicial (migra√ß√£o)
        function mapearRepeticoesParaEstagio(repeticoes) {
            const r = repeticoes || 0;
            if (r <= 0) return 0;
            if (r === 1) return 1;
            if (r === 2) return 2;
            if (r === 3) return 3;
            if (r === 4) return 4;
            return 5; // 5+ vai pro est√°gio 5
        }
        
        // Normalizar qualidade de resposta (blindar entrada)
        function normalizarQualidade(qualidade) {
            if (typeof qualidade === 'number') {
                if (qualidade === 0) return 'esqueci';
                if (qualidade === 1) return 'lembrei';
                if (qualidade === 2) return 'facil';
            }
            if (typeof qualidade === 'string') {
                const q = qualidade.toLowerCase();
                if (q === 'esqueci' || q === 'lembrei' || q === 'facil') return q;
            }
            // fallback seguro: trata como 'esqueci'
            return 'esqueci';
        }
        
        // Inicializar SRS VRVS 3P para nova entrada
        function inicializarSrsVRVS3P(hojeStr) {
            const hoje = hojeStr || hojeStr();
            const intervalo = VRVS3P_STAGE_INTERVALS[0]; // 1 dia
            
            return {
                engine: 'VRVS_FSRS3_v1',
                    ativo: true,
                estagio: 0,
                intervalo: intervalo,
                ultimaRevisaoData: hoje,
                proximaRevisao: addDias(hoje, intervalo),
                ultimaResposta: null,
                    repeticoes: 0,
                facilidade: 2.3,
                historicoRespostas: []
            };
        }
        
        // Atualizar SRS VRVS 3P ap√≥s resposta
        function atualizarSRS_VRVS3P(entrada, resposta) {
            if (!entrada || !entrada.srs || !entrada.srs.ativo) return;
            
            const srs = entrada.srs;
            const hoje = hojeStr();
            let estagio = srs.estagio ?? 0;
            
            // Transi√ß√µes de est√°gio conforme resposta
            if (resposta === 'esqueci') {
                if (estagio <= 1) {
                    estagio = 0;
            } else {
                    estagio = estagio - 2;
                }
            } else if (resposta === 'lembrei') {
                estagio = Math.min(estagio + 1, VRVS3P_MAX_STAGE);
            } else if (resposta === 'facil') {
                estagio = Math.min(estagio + 2, VRVS3P_MAX_STAGE);
            } else {
                // resposta inv√°lida ‚Üí n√£o faz nada
                return;
            }
            
            const intervalo = VRVS3P_STAGE_INTERVALS[estagio];
            
            // Atualizar campos do SRS
            srs.estagio = estagio;
            srs.intervalo = intervalo;
            srs.ultimaResposta = resposta;
            srs.ultimaRevisaoData = hoje;
            srs.proximaRevisao = addDias(hoje, intervalo);
            srs.repeticoes = (srs.repeticoes || 0) + 1;
            
            // Atualizar facilidade (opcional, para futuro)
            const fAtual = srs.facilidade ?? 2.3;
            let fNova = fAtual;
            if (resposta === 'esqueci') fNova = fAtual - 0.15;
            if (resposta === 'facil') fNova = fAtual + 0.05;
            srs.facilidade = Math.max(1.3, Math.min(fNova, 3.0));
            
            // Garantir que engine est√° definido
            if (!srs.engine) {
                srs.engine = 'VRVS_FSRS3_v1';
            }
        }
        
        // Migrar SRS antigo para VRVS 3P (idempotente)
        function migrarSRSParaVRVS3P() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return;
            
            let migradas = 0;
            window.diario.entradas.forEach(entrada => {
                const srs = entrada.srs;
                if (!srs) return;
                
                // Se j√° est√° na nova vers√£o, n√£o mexe
                if (srs.engine === 'VRVS_FSRS3_v1' && typeof srs.estagio === 'number') {
                    return;
                }
                
                // Migrar: mapear repeticoes ‚Üí estagio
                const estagio = mapearRepeticoesParaEstagio(srs.repeticoes || 0);
                srs.estagio = estagio;
                srs.intervalo = VRVS3P_STAGE_INTERVALS[estagio];
                srs.engine = 'VRVS_FSRS3_v1';
                
                // Garantir facilidade default
                if (typeof srs.facilidade !== 'number') {
                    srs.facilidade = 2.3;
                }
                
                // Se n√£o tem ultimaRevisaoData, usar proximaRevisao como refer√™ncia
                if (!srs.ultimaRevisaoData && srs.proximaRevisao) {
                    // Estimar data da √∫ltima revis√£o baseado no intervalo atual
                    const hoje = hojeStr();
                    const intervaloAtual = srs.intervalo || VRVS3P_STAGE_INTERVALS[estagio];
                    srs.ultimaRevisaoData = addDias(srs.proximaRevisao, -intervaloAtual);
                }
                
                // Garantir historicoRespostas existe
                if (!Array.isArray(srs.historicoRespostas)) {
                    srs.historicoRespostas = [];
                }
                
                migradas++;
            });
            
            if (migradas > 0) {
                salvarDiario(); // Salvar ap√≥s migra√ß√£o
            }
        }
        
        // Estimar reten√ß√£o te√≥rica (para Painel de Reten√ß√£o - Fase 4)
        function estimarRetencao(intervalo, diasDesdeRevisao) {
            // k calibrado pro VRVS 3P (pode ajustar depois)
            const k = 0.1625; // -ln(0.85)
            const x = diasDesdeRevisao / Math.max(intervalo, 1);
            const r = Math.exp(-k * x);
            return Math.max(0, Math.min(1, r));
        }
        
        // Classificar status de revis√£o (em-dia / pendente / atrasado)
        function classificarStatusRevisao(entrada, hojeStr) {
            if (!entrada.srs || !entrada.srs.ativo) return 'inativo';
            
            const hoje = hojeStr || hojeStr();
            const proximaRevisao = entrada.srs.proximaRevisao;
            if (!proximaRevisao) return 'inativo';
            
            const diff = diffEmDias(proximaRevisao, hoje); // hoje - proximaRevisao
            
            if (diff < 0) return 'em-dia';        // ainda n√£o venceu
            if (diff <= entrada.srs.intervalo) return 'pendente'; // leve atraso
            return 'atrasado';                    // muito atrasado
        }
        
        // Mensagem pedag√≥gica baseada em reten√ß√£o global e stats completos
        function mensagemRetencao(retencaoGlobal, stats) {
            // Se stats √© n√∫mero (compatibilidade com chamadas antigas), tratar como totalAtivos
            const totalAtivos = typeof stats === 'number' ? stats : (stats && stats.totalAtivos ? stats.totalAtivos : 0);
            const pendentesHoje = typeof stats === 'object' && stats ? (stats.totalHoje || 0) : 0;
            const atrasados = typeof stats === 'object' && stats ? (stats.totalAtrasadas || 0) : 0;
            const pct = (typeof retencaoGlobal === 'number' ? retencaoGlobal : 0) * 100;
            const temPendencias = (pendentesHoje > 0) || (atrasados > 0);
            
            if (!totalAtivos) {
                return {
                    emoji: '‚ú®',
                    texto: 'Nenhum t√≥pico ativo ainda. Crie entradas no Di√°rio marcando VRVS 3P.',
                    classe: 'neutro'
                };
            }
            
            // Sem pend√™ncias: considerar reten√ß√£o global
            if (!temPendencias) {
                if (pct >= 80) {
                    return {
                        emoji: 'üéØ',
                        texto: 'Excelente! Seus t√≥picos est√£o bem consolidados e voc√™ est√° em dia.',
                        classe: 'alta'
                    };
                } else if (pct >= 65) {
                    return {
                        emoji: '‚ö°',
                        texto: 'Voc√™ est√° em dia hoje. Continue revisando para subir a reten√ß√£o global.',
                        classe: 'media'
                    };
                } else {
                    return {
                        emoji: 'üìö',
                        texto: 'Voc√™ est√° em dia hoje, mas a reten√ß√£o global ainda est√° baixa. Reforce alguns t√≥picos-chave.',
                        classe: 'baixa'
                    };
                }
            }
            
            // Com pend√™ncias (hoje ou atrasadas)
            if (atrasados > 0) {
                return {
                    emoji: '‚è∞',
                    texto: 'Existem t√≥picos atrasados. Priorize os atrasados antes dos demais.',
                    classe: 'baixa'
                };
            }
            
            // S√≥ pendentes de hoje
            return {
                emoji: 'üß†',
                texto: 'Voc√™ tem t√≥picos para revisar hoje. Reserve alguns minutos para avan√ßar.',
                classe: (pct >= 80 ? 'alta' : 'media')
            };
        }
        
        // Calcular estat√≠sticas agregadas do Di√°rio VRVS 3P
        function calcularEstatisticasVrvs3p(diario, hojeStrParam) {
            // Se hojeStrParam n√£o foi passado, usar fun√ß√£o hojeStr() ou calcular diretamente
            let hoje;
            if (hojeStrParam) {
                hoje = hojeStrParam;
            } else if (typeof hojeStr === 'function') {
                hoje = hojeStr();
            } else {
                hoje = new Date().toISOString().split('T')[0];
            }
            
            // Inicializar estrutura de retorno
            const stats = {
                totalAtivos: 0,
                totalHoje: 0,
                totalAtrasadas: 0,
                retencaoGlobal: null,
                retencaoGlobalPct: null,
                porArea: [],
                maturidade: {
                    novos: 0,      // est√°gios 0-1
                    fixando: 0,    // est√°gios 2-3
                    maduros: 0,    // est√°gios 4-6
                    consolidados: 0 // est√°gios 7-10
                }
            };
            
            // Validar entrada
            if (!diario || !Array.isArray(diario.entradas) || diario.entradas.length === 0) {
                return stats;
            }
            
            // Filtrar apenas entradas ativas com SRS
            const entradasAtivas = diario.entradas.filter(e => 
                e.srs && 
                e.srs.ativo === true &&
                e.srs.engine === 'VRVS_FSRS3_v1'
            );
            
            stats.totalAtivos = entradasAtivas.length;
            
            if (stats.totalAtivos === 0) {
                return stats;
            }
            
            // Contar t√≥picos para hoje e atrasados
            let somaRetencao = 0;
            let contagemRetencao = 0;
            const porAreaMap = {};
            
            entradasAtivas.forEach(entrada => {
                const srs = entrada.srs;
                const estagio = srs.estagio || 0;
                const proximaRevisao = srs.proximaRevisao || hoje;
                
                // Contar para hoje
                if (proximaRevisao <= hoje) {
                    stats.totalHoje++;
                    
                    // Se muito atrasado (mais que 1 intervalo)
                    const diff = diffEmDias(proximaRevisao, hoje);
                    if (diff > (srs.intervalo || 1)) {
                        stats.totalAtrasadas++;
                    }
                }
                
                // Calcular reten√ß√£o estimada por est√°gio
                const retencaoEstagio = obterRetencaoPorEstagio(estagio);
                somaRetencao += retencaoEstagio;
                contagemRetencao++;
                
                // Agrupar por √°rea
                const area = entrada.area || 'Outros';
                if (!porAreaMap[area]) {
                    porAreaMap[area] = {
                        area: area,
                        total: 0,
                        somaRetencao: 0,
                        hoje: 0,
                        atrasadas: 0
                    };
                }
                porAreaMap[area].total++;
                porAreaMap[area].somaRetencao += retencaoEstagio;
                if (proximaRevisao <= hoje) {
                    porAreaMap[area].hoje++;
                    const diff = diffEmDias(proximaRevisao, hoje);
                    if (diff > (srs.intervalo || 1)) {
                        porAreaMap[area].atrasadas++;
                    }
                }
                
                // Classificar maturidade
                if (estagio <= 1) {
                    stats.maturidade.novos++;
                } else if (estagio <= 3) {
                    stats.maturidade.fixando++;
                } else if (estagio <= 6) {
                    stats.maturidade.maduros++;
                } else {
                    stats.maturidade.consolidados++;
                }
            });
            
            // Calcular reten√ß√£o global
            if (contagemRetencao > 0) {
                stats.retencaoGlobal = somaRetencao / contagemRetencao;
                stats.retencaoGlobalPct = Math.round(stats.retencaoGlobal * 100);
            }
            
            // Processar reten√ß√£o por √°rea
            stats.porArea = Object.keys(porAreaMap).map(area => {
                const item = porAreaMap[area];
                const retencaoMedia = item.total > 0 ? item.somaRetencao / item.total : 0;
                return {
                    area: area,
                    total: item.total,
                    retencao: retencaoMedia,
                    retencaoPct: Math.round(retencaoMedia * 100),
                    hoje: item.hoje,
                    atrasadas: item.atrasadas
                };
            }).sort((a, b) => b.retencao - a.retencao); // Ordenar por reten√ß√£o (maior primeiro)
            
            return stats;
        }
        
        // ==================== FIM VRVS 3P AUXILIARES ====================
        
        // Inicializar SRS em uma entrada (compatibilidade + VRVS 3P)
        function inicializarSrsEntrada(entrada) {
            const hoje = hojeStr();
            if (!entrada.srs) {
                // Nova entrada: usar VRVS 3P padr√£o
                entrada.srs = inicializarSrsVRVS3P(hoje);
            } else {
                // Entrada existente: garantir campos b√°sicos e compatibilidade
                if (typeof entrada.srs.ativo !== 'boolean') entrada.srs.ativo = true;
                if (!entrada.srs.proximaRevisao) entrada.srs.proximaRevisao = hoje;
                if (typeof entrada.srs.repeticoes !== 'number') entrada.srs.repeticoes = 0;
                if (!('ultimaResposta' in entrada.srs)) entrada.srs.ultimaResposta = null;
                
                // Garantir campos VRVS 3P se n√£o existirem (ser√° migrado depois se necess√°rio)
                if (!entrada.srs.engine) {
                    // Se n√£o tem engine, ainda n√£o foi migrado - ser√° migrado em migrarSRSParaVRVS3P()
                } else if (entrada.srs.engine === 'VRVS_FSRS3_v1') {
                    // J√° migrado: garantir campos VRVS 3P
                    if (typeof entrada.srs.estagio !== 'number') entrada.srs.estagio = 0;
                    if (typeof entrada.srs.intervalo !== 'number') entrada.srs.intervalo = VRVS3P_STAGE_INTERVALS[0];
                    if (!entrada.srs.ultimaRevisaoData) entrada.srs.ultimaRevisaoData = hoje;
                    if (typeof entrada.srs.facilidade !== 'number') entrada.srs.facilidade = 2.3;
                    if (!Array.isArray(entrada.srs.historicoRespostas)) entrada.srs.historicoRespostas = [];
                }
            }
        }
        
        // Inicializar SRS em todas as entradas carregadas
        function inicializarSrsEmTodasEntradas() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return;
            window.diario.entradas.forEach(inicializarSrsEntrada);
        }
        
        // Selecionar entradas programadas para HOJE (modo FSRS)
        function getEntradasParaRevisarHojeDiario(filtros) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return [];
            const hoje = hojeStr();
            return window.diario.entradas.filter(e => {
                if (!e.srs || !e.srs.ativo) return false;
                const due = e.srs.proximaRevisao || hoje;
                if (due > hoje) return false;
                if (filtros.area && e.area !== filtros.area) return false;
                if (filtros.tema && e.tema !== filtros.tema) return false;
                return true;
            });
        }
        
        // Selecionar entradas para TREINO LIVRE
        function getEntradasTreinoLivreDiario(filtros) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return [];
            return window.diario.entradas.filter(e => {
                const bateArea = !filtros.area || e.area === filtros.area;
                // Usar apenas filtro de √°rea (OP√á√ÉO B - filtro de tema n√£o existe)
                return bateArea;
            });
        }
        
        // Fun√ß√£o de agendamento com 3 bot√µes (Esqueci / Lembrei / F√°cil) - VRVS 3P
        function registrarRespostaSrsDiario(entrada, qualidade) {
            if (!entrada || !entrada.srs || !entrada.srs.ativo) return;
            
            // Normalizar qualidade e atualizar usando VRVS 3P
            const resposta = normalizarQualidade(qualidade);
            atualizarSRS_VRVS3P(entrada, resposta);
        }
        
        // ==================== FIM SRS ====================
        
        function carregarDiario() {
            try {
                const diarioSalvo = localStorage.getItem('vrvs_diario');
                if (diarioSalvo) {
                    const diario = JSON.parse(diarioSalvo);
                    if (diario.entradas && Array.isArray(diario.entradas)) {
                        window.diario = diario;
                        inicializarSrsEmTodasEntradas(); // Inicializar SRS em entradas existentes
                        migrarSRSParaVRVS3P(); // Migrar para VRVS 3P se necess√°rio
                    } else {
                        window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                        inicializarSrsEmTodasEntradas(); // Seguro mesmo vazio
                    }
                } else {
                    window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                    inicializarSrsEmTodasEntradas(); // Seguro mesmo vazio
                }
                // Atualizar chip VRVS 3P ap√≥s carregar
                atualizarChipVrvs3p();
            } catch (e) {
                console.error('[DI√ÅRIO] Erro ao carregar:', e);
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                inicializarSrsEmTodasEntradas(); // Seguro mesmo em erro
                atualizarChipVrvs3p();
            }
        }
        
        function salvarDiario() {
            try {
                window.diario.schemaVersion = DIARIO_SCHEMA_VERSION;
                localStorage.setItem('vrvs_diario', JSON.stringify(window.diario));
            } catch (e) {
                console.error('[DI√ÅRIO] Erro ao salvar:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar di√°rio!', 'error');
            }
        }
        
        function setModoDiario(modo) {
            modoDiario = modo;
            
            // Atualizar bot√µes
            const btnRecall = document.getElementById('modoRecall');
            const btnRespostas = document.getElementById('modoRespostas');
            
            if (btnRecall && btnRespostas) {
                if (modo === 'recall') {
                    btnRecall.style.background = 'var(--cobre-main)';
                    btnRecall.style.color = 'white';
                    btnRespostas.style.background = 'transparent';
                    btnRespostas.style.color = 'rgba(255,255,255,0.6)';
                } else {
                    btnRespostas.style.background = 'var(--cobre-main)';
                    btnRespostas.style.color = 'white';
                    btnRecall.style.background = 'transparent';
                    btnRecall.style.color = 'rgba(255,255,255,0.6)';
                }
            }
            
            renderDiario();
        }
        
        // Auto-resize para textarea do T√≥pico
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight + 4) + 'px';
        }
        
        function abrirNovaEntradaDiario() {
            // Limpar flag de edi√ß√£o da sess√£o
            window.editandoDaSessao = false;
            
            // Limpar campos
            document.getElementById('novaDiarioId').value = '';
            document.getElementById('novaDiarioTopico').value = '';
            document.getElementById('novaDiarioResposta').value = '';
            document.getElementById('novaDiarioAtencao').checked = false;
            
            // Reabilitar selects (caso tenham sido desabilitados)
            const areaSelect = document.getElementById('novaDiarioArea');
            const temaSelect = document.getElementById('novaDiarioTema');
            if (areaSelect) {
                areaSelect.disabled = false;
                areaSelect.title = '';
            }
            if (temaSelect) {
                temaSelect.disabled = false;
                temaSelect.title = '';
            }
            
            // Definir data padr√£o (hoje)
            const hoje = new Date().toISOString().split('T')[0];
            const dataInput = document.getElementById('novaDiarioData');
            if (dataInput) {
                dataInput.value = hoje;
            }
            
            // Configurar auto-resize no campo T√≥pico
            const topicoInput = document.getElementById('novaDiarioTopico');
            if (topicoInput) {
                autoResizeTextarea(topicoInput);
                // Remover listener antigo se existir e adicionar novo
                topicoInput.removeEventListener('input', topicoInput._autoResizeHandler);
                topicoInput._autoResizeHandler = function() {
                    autoResizeTextarea(this);
                };
                topicoInput.addEventListener('input', topicoInput._autoResizeHandler);
            }
            
            // Popular select de √°reas com AREAS_FIXAS + √°reas existentes nos dados
            if (areaSelect) {
                const areasExistentes = [...new Set([...AREAS_FIXAS, ...dados.map(t => t.area).filter(a => a)])].sort();
                areaSelect.innerHTML = '<option value="">Selecione...</option>';
                areasExistentes.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                areaSelect.value = ''; // Limpar sele√ß√£o
            }
            
            // Limpar select de temas
            if (temaSelect) {
                temaSelect.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
            }
            
            // Mostrar modal
            document.getElementById('modalNovaDiario').classList.add('active');
        }
        
        function atualizarTemasDiario(areaSelecionada) {
            const temaSelect = document.getElementById('novaDiarioTema');
            if (!temaSelect || !areaSelecionada) {
                if (temaSelect) {
                    temaSelect.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                }
                return;
            }
            
            // Filtrar temas da √°rea selecionada
            const temasDaArea = dados
                .filter(t => t.area === areaSelecionada && t.status !== 'Suspenso')
                .map(t => t.tema)
                .filter((tema, index, self) => self.indexOf(tema) === index) // Remover duplicatas
                .sort();
            
            // Popular select
            temaSelect.innerHTML = '<option value="">Selecione...</option>';
            temasDaArea.forEach(tema => {
                const option = document.createElement('option');
                option.value = tema;
                option.textContent = tema;
                temaSelect.appendChild(option);
            });
        }
        
        function fecharModalDiario() {
            document.getElementById('modalNovaDiario').classList.remove('active');
            
            // Limpar flag de edi√ß√£o da sess√£o e reabilitar selects
            if (window.editandoDaSessao) {
                window.editandoDaSessao = false;
                const areaSelect = document.getElementById('novaDiarioArea');
                const temaSelect = document.getElementById('novaDiarioTema');
                if (areaSelect) {
                    areaSelect.disabled = false;
                    areaSelect.title = '';
                }
                if (temaSelect) {
                    temaSelect.disabled = false;
                    temaSelect.title = '';
                }
            }
        }
        
        function salvarEntradaDiario() {
            try {
                const entradaId = document.getElementById('novaDiarioId')?.value;
                const veioDaSessao = window.editandoDaSessao === true;
                
                const areaSelect = document.getElementById('novaDiarioArea');
                const temaSelect = document.getElementById('novaDiarioTema');
                
                // Se for edi√ß√£o e veio da sess√£o, usar valores originais da entrada para √°rea/tema
                let area, tema;
                if (entradaId && veioDaSessao) {
                    const entradaOriginal = window.diario.entradas.find(e => String(e.id) === entradaId);
                    if (entradaOriginal) {
                        // Usar valores originais da entrada (campos est√£o desabilitados)
                        area = entradaOriginal.area || '';
                        tema = entradaOriginal.tema || '';
                    } else {
                        // Fallback: ler dos campos mesmo desabilitados
                        area = areaSelect?.value.trim() || '';
                        tema = temaSelect?.value.trim() || '';
                    }
                } else {
                    // Edi√ß√£o normal ou nova entrada: ler dos campos
                    area = areaSelect?.value.trim() || '';
                    tema = temaSelect?.value.trim() || '';
                }
                
                const topico = document.getElementById('novaDiarioTopico')?.value.trim();
                const resposta = document.getElementById('novaDiarioResposta')?.value.trim();
                const atencao = document.getElementById('novaDiarioAtencao')?.checked || false;
            const dataInput = document.getElementById('novaDiarioData');
            const data = dataInput ? dataInput.value : new Date().toISOString().split('T')[0];
            
                // Valida√ß√£o: √°rea e tema s√£o obrigat√≥rios
            if (!area || !tema || !topico) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha pelo menos √Årea, Tema e T√≥pico!', 'error');
                    // SEMPRE limpar flag e fechar modal mesmo em erro
                    window.editandoDaSessao = false;
                return;
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            
            if (entradaId) {
                // Editar entrada existente
                const entrada = window.diario.entradas.find(e => String(e.id) === entradaId);
                if (entrada) {
                    // Se veio da sess√£o, s√≥ atualizar topico e resposta (√°rea/tema desabilitados)
                    if (veioDaSessao === true) {
                        entrada.topico = topico;
                        entrada.resposta = resposta;
                        entrada.ultimaAtualizacao = hoje;
                        // N√ÉO mexer em √°rea, tema, atencao, data
                        // N√ÉO resetar SRS (manter est√°gio, intervalo, proximaRevisao, historicoRespostas)
                    } else {
                        // Edi√ß√£o normal da Lista: atualizar tudo
                    entrada.area = area;
                    entrada.tema = tema;
                    entrada.topico = topico;
                    entrada.resposta = resposta;
                    entrada.atencao = atencao;
                    entrada.data = data; // Usar data do campo
                    entrada.ultimaAtualizacao = hoje;
                        
                        // Gerenciar SRS conforme checkbox
                        if (atencao) {
                            // Se marcado e n√£o tem SRS, criar; se j√° tem, garantir que est√° ativo
                            if (!entrada.srs) {
                                entrada.srs = inicializarSrsVRVS3P(hoje);
                            } else {
                                entrada.srs.ativo = true;
                                // Garantir campos VRVS 3P se n√£o existirem
                                if (!entrada.srs.engine || entrada.srs.engine !== 'VRVS_FSRS3_v1') {
                                    // Migrar se necess√°rio (ser√° feito na pr√≥xima carga, mas garantir aqui tamb√©m)
                                    if (!entrada.srs.engine) {
                                        const estagio = mapearRepeticoesParaEstagio(entrada.srs.repeticoes || 0);
                                        entrada.srs.estagio = estagio;
                                        entrada.srs.intervalo = VRVS3P_STAGE_INTERVALS[estagio];
                                        entrada.srs.engine = 'VRVS_FSRS3_v1';
                                        if (typeof entrada.srs.facilidade !== 'number') entrada.srs.facilidade = 2.3;
                                        if (!Array.isArray(entrada.srs.historicoRespostas)) entrada.srs.historicoRespostas = [];
                                        if (!entrada.srs.ultimaRevisaoData) entrada.srs.ultimaRevisaoData = hoje;
                                    }
                                }
                            }
                            // CORRE√á√ÉO: Garantir sincroniza√ß√£o do checkbox com SRS ap√≥s inicializa√ß√£o
                            entrada.srs.ativo = atencao;
                        } else {
                            // Se desmarcado, desativar SRS (mas n√£o deletar para manter hist√≥rico)
                            if (entrada.srs) {
                                entrada.srs.ativo = false;
                            }
                        }
                    }
                }
            } else {
                // Nova entrada
                const novaEntrada = {
                    id: Date.now(),
                    data: data, // Usar data do campo
                    area: area,
                    tema: tema,
                    topico: topico,
                    resposta: resposta,
                    atencao: atencao,
                    criadoEm: hoje,
                    ultimaAtualizacao: hoje
                };
                
                // Se checkbox marcado, inicializar SRS VRVS 3P; sen√£o, n√£o criar SRS
                if (atencao) {
                    novaEntrada.srs = inicializarSrsVRVS3P(hoje);
                    // CORRE√á√ÉO: Garantir sincroniza√ß√£o do checkbox com SRS ap√≥s inicializa√ß√£o
                    novaEntrada.srs.ativo = atencao;
                } else {
                    // N√£o criar SRS se checkbox n√£o marcado
                    novaEntrada.srs = null;
                }
                
                window.diario.entradas.push(novaEntrada);
            }
            
            salvarDiario();
                
                // Verificar se veio da sess√£o (j√° declarado acima, apenas usar)
                const veioDaSessaoFlag = veioDaSessao;
                
                // Limpar flag
                window.editandoDaSessao = false;
                
                // Fechar modal antes de renderizar (evita conflito visual)
            fecharModalDiario();
                
                // Pequeno delay para garantir que modal fechou antes de renderizar (especialmente mobile)
                setTimeout(() => {
                    if (veioDaSessaoFlag) {
                        // Se veio da sess√£o, re-renderizar apenas o card atual da sess√£o
                        const entradaAtual = getEntradaAtualSessao();
                        if (entradaAtual) {
                            renderSessaoDiario(entradaAtual);
                        }
                    } else {
                        // Edi√ß√£o normal: renderizar lista completa
            renderDiario();
                    }
                    // Atualizar chip VRVS 3P ap√≥s salvar
                    atualizarChipVrvs3p();
            mostrarNotificacaoFeedback('‚úÖ Entrada salva com sucesso!');
                }, 50);
            } catch (error) {
                console.error('[DI√ÅRIO] Erro ao salvar entrada:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar entrada. Verifique o console.', 'error');
                // SEMPRE limpar flag e fechar modal mesmo em erro
                window.editandoDaSessao = false;
                fecharModalDiario();
            }
        }
        
        function salvarEContinuarDiario() {
            salvarEntradaDiario();
            setTimeout(() => {
                abrirNovaEntradaDiario();
            }, 300);
        }
        
        // Atualizar chip VRVS 3P no Di√°rio
        function atualizarChipVrvs3p() {
            const chip = document.getElementById('vrvs3p-chip-diario');
            const chipText = document.getElementById('vrvs3p-chip-text');
            if (!chip || !chipText) return;
            
            // Garantir que window.diario existe (se n√£o, inicializar vazio)
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            const hoje = hojeStr();
            const stats = calcularEstatisticasVrvs3p(window.diario || { entradas: [] }, hoje);
            
            let texto;
            
            if (!stats || stats.totalAtivos === 0) {
                // Nenhum t√≥pico ativo
                texto = 'üß† Nenhum ativo';
            } else {
                const totalAtivos = stats.totalAtivos || 0;
                const pendentesHoje = stats.totalHoje || 0;
                const atrasados = stats.totalAtrasadas || 0;
                
                if (pendentesHoje === 0 && atrasados === 0) {
                    // Tudo em dia: nenhum hoje, nenhum atrasado
                    texto = `üß† ${totalAtivos} ativos ¬∑ ‚úÖ em dia`;
                } else {
                    // Formato padr√£o
                    texto = `üß† ${totalAtivos} ativos ¬∑ ${pendentesHoje} hoje`;
                    if (atrasados > 0) {
                        texto += ` ¬∑ ${atrasados} ‚ö†Ô∏è`;
                    }
                }
            }
            
            chipText.textContent = texto;
            chip.style.display = 'inline-flex';
        }
        
        // Navegar para painel VRVS 3P
        function irParaPainelVrvs3p() {
            // Ir para aba Analytics (n√£o analises)
            showSection('analytics');
            // Garantir que est√° na sub-aba Resumo
            setTimeout(() => {
                setVistaAnalytics('resumo');
                // Scroll at√© o painel ap√≥s renderizar e expandir se estiver colapsado
                setTimeout(() => {
                    const painel = document.getElementById('painel-vrvs3p');
                    if (painel) {
                        // Se estiver colapsado, expandir antes de fazer scroll
                        if (painel.classList.contains('vrvs3p-collapsed')) {
                            togglePainelVrvs3p();
                        }
                        painel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.warn('[VRVS3P] Painel n√£o encontrado ap√≥s navega√ß√£o');
                    }
                }, 200);
            }, 100);
        }
        
        // Toggle do painel VRVS 3P (colaps√°vel)
        function togglePainelVrvs3p() {
            const painel = document.getElementById('painel-vrvs3p');
            const body = painel ? painel.querySelector('.vrvs3p-body') : null;
            const caret = painel ? painel.querySelector('.vrvs3p-caret') : null;
            
            if (painel && body) {
                painel.classList.toggle('vrvs3p-collapsed');
                
                // Rotacionar caret
                if (caret) {
                    if (painel.classList.contains('vrvs3p-collapsed')) {
                        caret.style.transform = 'rotate(-90deg)';
                    } else {
                        caret.style.transform = 'rotate(0deg)';
                    }
                }
            }
        }
        
        function renderDiario() {
            const container = document.getElementById('diarioContainer');
            if (!container) return;
            
            // Atualizar chip VRVS 3P
            atualizarChipVrvs3p();
            
            if (!window.diario || !window.diario.entradas || window.diario.entradas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada no di√°rio ainda</div><div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.5);">Clique em "+ Nova" para adicionar</div></div>';
                
                // Esconder se√ß√£o "Revisar Hoje"
                const revisarHoje = document.getElementById('diarioRevisarHoje');
                if (revisarHoje) revisarHoje.style.display = 'none';
                
                return;
            }
            
            const filtroVista = document.getElementById('filtroDiarioVista')?.value || 'data';
            const filtroArea = document.getElementById('filtroDiarioArea')?.value || '';
            const filtroData = document.getElementById('filtroDiarioData')?.value || '';
            
            // Atualizar select de √°reas
            const areaSelect = document.getElementById('filtroDiarioArea');
            if (areaSelect) {
                const areas = [...new Set(window.diario.entradas.map(e => e.area))].sort();
                areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
                });
                if (filtroArea) areaSelect.value = filtroArea;
            }
            
            // Filtrar entradas
            let entradasFiltradas = window.diario.entradas;
            
            if (filtroArea) {
                entradasFiltradas = entradasFiltradas.filter(e => e.area === filtroArea);
            }
            
            if (filtroData) {
                entradasFiltradas = entradasFiltradas.filter(e => e.data === filtroData);
            }
            
            // Separar entradas que precisam revis√£o (com ‚ö†Ô∏è ou SRS ativo com proximaRevisao <= hoje)
            const hoje = hojeStr();
            const entradasRevisar = entradasFiltradas.filter(e => {
                // Entrada marcada com aten√ß√£o OU tem SRS ativo programado para hoje
                if (e.atencao) return true;
                if (e.srs && e.srs.ativo && e.srs.proximaRevisao) {
                    return e.srs.proximaRevisao <= hoje;
                }
                return false;
            });
            
            // Renderizar se√ß√£o "Revisar Hoje"
            const revisarHoje = document.getElementById('diarioRevisarHoje');
            if (revisarHoje) {
                if (entradasRevisar.length > 0) {
                    revisarHoje.style.display = 'block';
                    const revisarId = 'diario-revisar-hoje';
                    revisarHoje.innerHTML = `
                        <div class="area-section" style="margin-bottom: 0;">
                            <div class="area-header collapsed" onclick="toggleAreaCaderno('${revisarId}')" style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;">
                                <div class="area-header-left">
                                    <span class="area-header-title">‚ö†Ô∏è Revisar Hoje</span>
                                    <span class="area-header-count">${entradasRevisar.length} entrada${entradasRevisar.length > 1 ? 's' : ''}</span>
                        </div>
                                <span class="area-header-toggle">‚ñº</span>
                            </div>
                            <div class="area-content collapsed" id="area-content-${revisarId}">
                        ${entradasRevisar.map(e => renderEntradaDiario(e)).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    revisarHoje.style.display = 'none';
                }
            }
            
            // DESATIVADO: Entradas devem aparecer tanto em "Revisar Hoje" quanto na lista principal
            // // Remover entradas com aten√ß√£o da lista principal
            // entradasFiltradas = entradasFiltradas.filter(e => !e.atencao);
            
            if (filtroVista === 'data') {
                renderDiarioPorData(entradasFiltradas, container);
            } else {
                renderDiarioPorTema(entradasFiltradas, container);
            }
        }
        
        function renderDiarioPorData(entradas, container) {
            // Agrupar por data
            const porData = {};
            entradas.forEach(e => {
                if (!porData[e.data]) porData[e.data] = [];
                porData[e.data].push(e);
            });
            
            const datasOrdenadas = Object.keys(porData).sort((a, b) => new Date(b) - new Date(a));
            
            if (datasOrdenadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada encontrada</div></div>';
                return;
            }
            
            let html = '';
            datasOrdenadas.forEach((data, idx) => {
                const dataId = `diario-data-${data.replace(/-/g, '')}`;
                html += `<div style="margin-bottom: 24px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('${dataId}')" style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìÖ ${formatarDataCompleta(data)}</span>
                            <span class="area-header-count">${porData[data].length} entrada${porData[data].length > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-${dataId}">
                        ${porData[data].map(e => renderEntradaDiario(e)).join('')}
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderDiarioPorTema(entradas, container) {
            // CORRE√á√ÉO: Agrupar primeiro por √ÅREA, depois por TEMA dentro de cada √°rea
            const porArea = {};
            entradas.forEach(e => {
                if (!porArea[e.area]) porArea[e.area] = {};
                const temaKey = e.tema;
                if (!porArea[e.area][temaKey]) porArea[e.area][temaKey] = [];
                porArea[e.area][temaKey].push(e);
            });
            
            const areasOrdenadas = Object.keys(porArea).sort();
            
            if (areasOrdenadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada encontrada</div></div>';
                return;
            }
            
            let html = '';
            areasOrdenadas.forEach(area => {
                const areaId = `diario-area-${area.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const temasDaArea = Object.keys(porArea[area]).sort();
                const totalEntradasArea = temasDaArea.reduce((sum, tema) => sum + porArea[area][tema].length, 0);
                
                // Box da √ÅREA (colaps√°vel)
                html += `<div style="margin-bottom: 24px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('${areaId}')" style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìÅ ${area}</span>
                            <span class="area-header-count">${totalEntradasArea} entrada${totalEntradasArea > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-${areaId}">`;
                
                // Temas dentro da √°rea (tamb√©m colaps√°veis)
                temasDaArea.forEach(tema => {
                    const temaId = `diario-tema-${area.replace(/[^a-zA-Z0-9]/g, '-')}-${tema.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <div style="margin-bottom: 16px; margin-left: 12px;">
                            <div class="area-header collapsed" onclick="toggleAreaCaderno('${temaId}')" style="cursor: pointer; padding: 6px 0; margin-bottom: 6px;">
                                <div class="area-header-left">
                                    <span class="area-header-title">üìÑ ${tema}</span>
                                    <span class="area-header-count">${porArea[area][tema].length} entrada${porArea[area][tema].length > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-${temaId}">
                                ${porArea[area][tema].map(e => renderEntradaDiario(e)).join('')}
                    </div>
                </div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderEntradaDiario(entrada) {
            const mostrarResposta = modoDiario === 'respostas';
            
            return `
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 14px; margin-bottom: 12px; border: 1px solid rgba(255,127,80,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 4px;">
                                ${entrada.area} ‚Ä¢ ${entrada.tema}
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobre-light); margin-bottom: 8px; display: block; border-bottom: 1px solid rgba(0, 206, 209, 0.2); padding-bottom: 8px;">
                                ‚ùì ${formatarTextoDiario(entrada.topico)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            ${entrada.atencao ? '<span style="color: var(--cobre-main); font-size: 18px;">‚ö†Ô∏è</span>' : ''}
                            <button onclick="editarEntradaDiario(${entrada.id})" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 14px; padding: 4px 8px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${mostrarResposta && entrada.resposta ? `
                        <div style="background: rgba(0,206,209,0.1); border-left: 3px solid var(--turquesa-main); padding: 10px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                            <span style="font-size: 13px;">‚úÖ</span><br>
                            <span>${formatarTextoDiario(entrada.resposta)}</span>
                        </div>
                    ` : mostrarResposta ? `
                        <div style="color: rgba(255,255,255,0.5); font-size: 12px; font-style: italic; margin-top: 8px;">
                            (Sem resposta ainda)
                        </div>
                    ` : `
                        <button onclick="toggleRespostaIndividual(${entrada.id})" style="background: rgba(0,206,209,0.15); border: 1px solid rgba(0,206,209,0.3); color: var(--turquesa-light); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px;">
                            üëÅÔ∏è Ver Resposta
                        </button>
                        <div id="resposta_${entrada.id}" style="display: none; background: rgba(0,206,209,0.1); border-left: 3px solid var(--turquesa-main); padding: 10px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                            <span style="font-size: 13px;">‚úÖ</span><br>
                            <span>${entrada.resposta ? formatarTextoDiario(entrada.resposta) : '(Sem resposta ainda)'}</span>
                        </div>
                    `}
                </div>
            `;
        }
        
        function toggleRespostaIndividual(entradaId) {
            const respostaDiv = document.getElementById(`resposta_${entradaId}`);
            if (respostaDiv) {
                respostaDiv.style.display = respostaDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Editar entrada a partir da sess√£o (desabilita √°rea/tema)
        function editarEntradaSessaoDiario() {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual) return;
            
            // CR√çTICO: Marcar flag ANTES de chamar editarEntradaDiario
            // Isso garante que a fun√ß√£o sabe que veio da sess√£o
            window.editandoDaSessao = true;
            
            // Usar fun√ß√£o existente de edi√ß√£o
            editarEntradaDiario(entradaAtual.id);
        }
        
        function editarEntradaDiario(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (!entrada) {
                console.error('[DEBUG VRVS3P] Entrada n√£o encontrada:', entradaId);
                return;
            }
            
            // CR√çTICO: Verificar flag ANTES de qualquer coisa
            // Se n√£o foi setada explicitamente por editarEntradaSessaoDiario(), assumir que veio da Lista
            const veioDaSessao = window.editandoDaSessao === true;
            
            // Se n√£o veio da sess√£o, garantir que flag est√° false (pode ter ficado true de edi√ß√£o anterior)
            if (!veioDaSessao) {
                window.editandoDaSessao = false;
            }
            
            document.getElementById('novaDiarioId').value = entrada.id;
            const dataInput = document.getElementById('novaDiarioData');
            if (dataInput) {
                dataInput.value = entrada.data || new Date().toISOString().split('T')[0];
            }
            
            // Popular select de √°reas com TODAS as √°reas existentes (AREAS_FIXAS + √°reas dos dados + √°rea da entrada)
            const areaSelect = document.getElementById('novaDiarioArea');
            if (areaSelect) {
                // Coletar todas as √°reas: AREAS_FIXAS + √°reas dos dados + √°rea da entrada atual
                const areasDosDados = [...new Set(dados.map(t => t.area).filter(a => a))];
                const areasExistentes = [...new Set([...AREAS_FIXAS, ...areasDosDados, entrada.area].filter(a => a))].sort();
                
                areaSelect.innerHTML = '<option value="">Selecione...</option>';
                areasExistentes.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                
                // CR√çTICO: Setar valor ANTES de desabilitar
                areaSelect.value = entrada.area || '';
                
                // Se veio da sess√£o, desabilitar √°rea/tema (mas valor j√° est√° setado)
                if (veioDaSessao) {
                    areaSelect.disabled = true;
                    areaSelect.title = 'Editar √°rea/tema apenas pela Lista';
                } else {
                    areaSelect.disabled = false;
                    areaSelect.title = '';
                }
            }
            
            // Atualizar temas baseado na √°rea selecionada
            if (entrada.area) {
            atualizarTemasDiario(entrada.area);
            }
            
            // Selecionar tema ap√≥s popular select (com timeout maior para garantir que temas foram populados)
            setTimeout(() => {
                const temaSelect = document.getElementById('novaDiarioTema');
                if (temaSelect) {
                    // Verificar se tema existe nas options antes de setar
                    const temaExiste = Array.from(temaSelect.options).some(opt => opt.value === entrada.tema);
                    
                    if (temaExiste) {
                        temaSelect.value = entrada.tema || '';
                    } else {
                        // Tentar novamente ap√≥s mais um delay (mobile pode ser mais lento)
                        setTimeout(() => {
                            temaSelect.value = entrada.tema || '';
                        }, 100);
                    }
                    
                    // Se veio da sess√£o, desabilitar tema tamb√©m (mas valor j√° est√° setado)
                    if (veioDaSessao) {
                        temaSelect.disabled = true;
                        temaSelect.title = 'Editar √°rea/tema apenas pela Lista';
                    } else {
                        temaSelect.disabled = false;
                        temaSelect.title = '';
                    }
                }
            }, 150); // Aumentado para 150ms para garantir que temas foram populados (mobile pode ser mais lento)
            
            document.getElementById('novaDiarioTopico').value = entrada.topico;
            document.getElementById('novaDiarioResposta').value = entrada.resposta || '';
            // Marcar checkbox se entrada tem SRS ativo OU se campo atencao est√° marcado
            const temSrsAtivo = entrada.srs && entrada.srs.ativo;
            document.getElementById('novaDiarioAtencao').checked = entrada.atencao || temSrsAtivo || false;
            
            // Mostrar modal
            document.getElementById('modalNovaDiario').classList.add('active');
        }
        
        // ==================== SRS - CONTROLE DE ABA E MODO ====================
        
        // Fun√ß√£o para mudar aba do Di√°rio
        function setAbaDiario(aba) {
            abaDiarioAtiva = aba; // 'lista' ou 'sessao'
            const tabLista = document.getElementById('diarioTabLista');
            const tabSessao = document.getElementById('diarioTabSessao');
            const containerLista = document.getElementById('diarioListaWrapper');
            const containerSessao = document.getElementById('diarioSessaoWrapper');
            
            if (tabLista && tabSessao && containerLista && containerSessao) {
                if (aba === 'lista') {
                    tabLista.classList.add('active');
                    tabSessao.classList.remove('active');
                    containerLista.style.display = 'block';
                    containerSessao.style.display = 'none';
                    // Re-renderizar a lista normal
                    renderDiario();
                } else {
                    tabSessao.classList.add('active');
                    tabLista.classList.remove('active');
                    containerLista.style.display = 'none';
                    containerSessao.style.display = 'block';
                    // Inicialmente, s√≥ mostra a tela "escolha o tipo de sess√£o"
                    renderSessaoDiario(null);
                }
            }
        }
        
        // Fun√ß√£o para mudar o tipo de sess√£o (programado x livre)
        function setModoSessaoDiario(modo) {
            modoSessaoDiario = modo; // 'programado' ou 'livre'
            const btnProgramado = document.getElementById('sessaoDiarioProgramado');
            const btnLivre = document.getElementById('sessaoDiarioLivre');
            
            if (btnProgramado && btnLivre) {
                if (modo === 'programado') {
                    btnProgramado.classList.add('active');
                    btnLivre.classList.remove('active');
                } else {
                    btnLivre.classList.add('active');
                    btnProgramado.classList.remove('active');
                }
            }
            
            // Reiniciar sess√£o quando modo muda
            iniciarSessaoDiario(modo);
        }
        
        // Inicializar a sess√£o de Di√°rio
        function iniciarSessaoDiario(tipo) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                renderSessaoDiario(null);
                return;
            }
            
            // Filtros padr√£o (usados quando o usu√°rio entra pela aba Di√°rio)
            let filtros = {
                area: null,
                tema: null
            };
            
            // Se houver filtros de sess√£o vindos da aba Tarefas, eles t√™m prioridade
            if (window.filtrosSessaoDiario) {
                filtros.area = window.filtrosSessaoDiario.area || null;
                filtros.tema = window.filtrosSessaoDiario.tema || null;
            } else {
                // Caso contr√°rio, use o filtro de √°rea atual da UI (filtroDiarioArea)
                const filtroAreaSelect = document.getElementById('filtroDiarioArea');
                filtros.area = filtroAreaSelect && filtroAreaSelect.value ? filtroAreaSelect.value : null;
                // N√£o precisa de filtro de tema na UI por enquanto (mant√©m simples)
                filtros.tema = null;
            }
            
            // Guardar tipo
            sessaoDiario = sessaoDiario || {};
            sessaoDiario.tipo = tipo;
            
            let entradas = [];
            if (tipo === 'programado') {
                entradas = getEntradasParaRevisarHojeDiario(filtros);
            } else {
                entradas = getEntradasTreinoLivreDiario(filtros);
            }
            
            sessaoDiario.filaIds = entradas.map(e => e.id);
            sessaoDiario.indiceAtual = 0;
            
            if (!sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        function getEntradaAtualSessao() {
            if (!sessaoDiario || !Array.isArray(sessaoDiario.filaIds)) return null;
            const id = sessaoDiario.filaIds[sessaoDiario.indiceAtual];
            return (window.diario.entradas || []).find(e => String(e.id) === String(id)) || null;
        }
        
        // ==================== SRS - UI DA SESS√ÉO ====================
        
        // Fun√ß√£o para renderizar a sess√£o dentro do <div id="diarioSessao">
        function renderSessaoDiario(entradaAtual) {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            // Se nenhum card na fila
            if (!entradaAtual) {
                // Limpar filtros da sess√£o quando terminar
                window.filtrosSessaoDiario = null;
                
                const tipo = sessaoDiario.tipo || modoSessaoDiario;
                if (tipo === 'programado') {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>‚úÖ Voc√™ n√£o tem nenhum t√≥pico do Di√°rio <strong>programado para hoje</strong> com os filtros atuais.</div>
                            <button class="btn btn-small" onclick="setModoSessaoDiario('livre')" style="margin-top: 12px;">
                                üîÅ Fazer treino livre mesmo assim
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>üìî Nenhum t√≥pico encontrado para treino livre com os filtros atuais.</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-top: 8px;">
                                Ajuste os filtros de √°rea ou crie novas entradas no Di√°rio.
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            const indice = sessaoDiario.indiceAtual + 1;
            const total = sessaoDiario.filaIds.length;
            
            // Por padr√£o, resposta escondida at√© clicar
            container.innerHTML = `
                <div class="diario-sessao-card">
                    <div class="diario-sessao-meta">
                        <span>${entradaAtual.area} ‚Ä¢ ${entradaAtual.tema}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${indice} / ${total}</span>
                            <button onclick="editarEntradaSessaoDiario()" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 16px; padding: 4px 8px; display: flex; align-items: center;" title="Editar pergunta/resposta">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div class="diario-sessao-topico">
                        ‚ùì ${formatarTextoDiario(entradaAtual.topico)}
                    </div>
                    <div id="diarioSessaoRespostaWrapper" class="diario-sessao-resposta escondida">
                        <div class="diario-sessao-resposta-inner">
                            ${entradaAtual.resposta ? formatarTextoDiario(entradaAtual.resposta) : '<em>(Sem resposta cadastrada)</em>'}
                        </div>
                    </div>
                    <div class="diario-sessao-acoes">
                        <button class="btn btn-small" onclick="mostrarRespostaSessaoDiario()">
                            üîç MOSTRAR RESPOSTA
                        </button>
                    </div>
                    <div class="diario-sessao-botoes-qualidade">
                        <button class="btn btn-esqueci btn-danger" onclick="responderSessaoDiario('esqueci')" title="N√£o lembrei ou errei. Vou revisar em breve.">‚ùå ESQUECI</button>
                        <button class="btn btn-lembrei" onclick="responderSessaoDiario('lembrei')" title="Lembrei, mas precisei pensar. Progresso normal.">üëç LEMBREI</button>
                        <button class="btn btn-facil btn-sucesso" onclick="responderSessaoDiario('facil')" title="Veio na hora! Posso esperar mais pra revisar.">üòå F√ÅCIL</button>
                    </div>
                    <div class="diario-sessao-opcoes">
                        <button class="link-btn" onclick="pularSessaoDiario()">‚è≠Ô∏è Pular este t√≥pico</button>
                        <button class="link-btn" onclick="desativarSessaoDiarioAtual()">üö´ N√£o revisar mais este t√≥pico</button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar resposta (apenas altera CSS)
        function mostrarRespostaSessaoDiario() {
            const wrapper = document.getElementById('diarioSessaoRespostaWrapper');
            if (wrapper) {
                wrapper.classList.remove('escondida');
            }
        }
        
        // Avan√ßar card ap√≥s resposta "valendo"
        function responderSessaoDiario(qualidade) {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual) return;
            
            // Se for sess√£o programada, aplica agendamento
            if (sessaoDiario.tipo === 'programado') {
                registrarRespostaSrsDiario(entradaAtual, qualidade);
                salvarDiario(); // j√° existe; apenas reutilizar
                // Atualizar chip VRVS 3P ap√≥s registrar resposta
                atualizarChipVrvs3p();
            }
            
            // Avan√ßar na fila
            sessaoDiario.indiceAtual++;
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                // Acabou
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // Pular card (sem alterar SRS)
        function pularSessaoDiario() {
            sessaoDiario.indiceAtual++;
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // Desativar card da revis√£o (srs.ativo = false)
        function desativarSessaoDiarioAtual() {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual || !entradaAtual.srs) return;
            
            entradaAtual.srs.ativo = false;
            salvarDiario();
            // Atualizar chip VRVS 3P ap√≥s desativar
            atualizarChipVrvs3p();
            
            // Remover da fila atual
            sessaoDiario.filaIds.splice(sessaoDiario.indiceAtual, 1);
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // ==================== FIM SRS UI ====================
        
        function toggleAtencaoDiario(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (entrada) {
                entrada.atencao = !entrada.atencao;
                entrada.ultimaAtualizacao = new Date().toISOString().split('T')[0];
                salvarDiario();
                renderDiario();
                // Atualizar chip VRVS 3P ap√≥s alterar aten√ß√£o
                atualizarChipVrvs3p();
            }
        }
        
        function formatarDataCompleta(dataStr) {
            const data = new Date(dataStr + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const ontem = new Date(hoje);
            ontem.setDate(ontem.getDate() - 1);
            
            if (dataStr === hoje.toISOString().split('T')[0]) {
                return 'Hoje';
            } else if (dataStr === ontem.toISOString().split('T')[0]) {
                return 'Ontem';
            } else {
                return data.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }
        
        // ==================== NOVAS FUN√á√ïES - REFATORA√á√ÉO v2.0 ====================
        
        // ==================== MODAL NOVA √ÅREA ====================
        
        function abrirModalNovaArea() {
            try {
                const inputNome = document.getElementById('inputNovaAreaNome');
                const modal = document.getElementById('modalNovaArea');
                
                if (!modal) {
                    console.error('[BUG FIX] Modal modalNovaArea n√£o encontrado!');
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao abrir modal de nova √°rea.', 'error');
                    return;
                }
                
                if (inputNome) {
                    inputNome.value = '';
                }
                
                modal.classList.add('active');
            } catch (e) {
                console.error('[BUG FIX] Erro ao abrir modal nova √°rea:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao abrir modal de nova √°rea.', 'error');
            }
        }
        
        function fecharModalNovaArea() {
            document.getElementById('modalNovaArea').classList.remove('active');
        }
        
        function salvarNovaArea(event) {
            event.preventDefault();
            const nomeArea = document.getElementById('inputNovaAreaNome').value.trim();
            
            if (!nomeArea) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Digite um nome para a √°rea!', 'error');
                return;
            }
            
            // Normalizar √°rea
            const areaNormalizada = normalizarArea(nomeArea);
            
            // Verificar se j√° existe
            const areasExistentes = [...new Set([...AREAS_FIXAS, ...dados.map(t => t.area).filter(a => a)])];
            if (areasExistentes.includes(areaNormalizada)) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è A √°rea "${areaNormalizada}" j√° existe!`, 'error');
                return;
            }
            
            // Atualizar TODOS os selects de √°rea na plataforma
            atualizarTodosSelectsArea(areaNormalizada);
            
            // Fechar modal e mostrar sucesso
            fecharModalNovaArea();
            mostrarNotificacaoFeedback(`‚úÖ √Årea "${areaNormalizada}" adicionada com sucesso! Agora est√° dispon√≠vel em todas as abas.`);
        }
        
        // Fun√ß√£o centralizada para atualizar TODOS os selects de √°rea
        function atualizarTodosSelectsArea(novaArea) {
            // Lista de todos os selects que precisam ser atualizados
            const selectsArea = [
                'modalNovaArea',      // Modal cadastro tema
                'editArea',           // Modal edi√ß√£o tema
                'novaArea',           // Formul√°rio cadastro (aba Dados)
                'feedbackArea',       // Formul√°rio Feedback
                'novaDiarioArea',     // Formul√°rio Di√°rio
                'analiseFiltroArea',  // Filtro An√°lises
                'filtroDiarioArea',   // Filtro Di√°rio
                'cadernoFiltroArea'   // Filtro Caderno
            ];
            
            // Obter todas as √°reas existentes (fixas + dos dados)
            const areasExistentes = [...new Set([...AREAS_FIXAS, ...dados.map(t => t.area).filter(a => a)])];
            const areasCompletas = [...new Set([...areasExistentes, novaArea])].sort();
            
            // Atualizar cada select
            selectsArea.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const valorAtual = select.value; // Preservar valor selecionado
                const primeiroOption = select.options[0]?.value === '' ? '<option value="">Selecione...</option>' : 
                                      (select.options[0]?.value === 'Todas as √°reas' ? '<option value="">Todas as √°reas</option>' : '');
                
                select.innerHTML = primeiroOption + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                
                // Restaurar valor selecionado se ainda existir
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    select.value = valorAtual;
                }
            });
            
            // Chamar fun√ß√µes espec√≠ficas que dependem de √°reas
            updateFeedbackSelect(); // Atualiza feedbackArea
            atualizarSelectsAnalise(); // Atualiza analiseFiltroArea
            atualizarSelectsCaderno(); // Atualiza cadernoFiltroArea
            
            // Atualizar selects do Di√°rio manualmente (usando areasCompletas j√° criada acima)
            // Atualizar select de √°rea do formul√°rio de nova entrada do Di√°rio
            const novaDiarioArea = document.getElementById('novaDiarioArea');
            if (novaDiarioArea) {
                const valorAtual = novaDiarioArea.value;
                novaDiarioArea.innerHTML = '<option value="">Selecione...</option>' + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    novaDiarioArea.value = valorAtual;
                    atualizarTemasDiario(valorAtual);
                }
            }
            
            // Atualizar filtro de √°rea do Di√°rio
            const filtroDiarioArea = document.getElementById('filtroDiarioArea');
            if (filtroDiarioArea) {
                const valorAtual = filtroDiarioArea.value;
                filtroDiarioArea.innerHTML = '<option value="">Todas as √°reas</option>' + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    filtroDiarioArea.value = valorAtual;
                }
            }
            
            // Trigger change events para atualizar depend√™ncias
            selectsArea.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && select.value) {
                    select.dispatchEvent(new Event('change'));
                }
            });
        }
        
        // ==================== MODAL CADASTRO ====================
        
        function abrirModalCadastro() {
            // Popular select de √°reas com AREAS_FIXAS + √°reas existentes nos dados
            let areasExistentes = [];
            try {
                if (typeof AREAS_FIXAS !== 'undefined' && Array.isArray(AREAS_FIXAS)) {
                    areasExistentes = [...AREAS_FIXAS];
                }
                if (typeof dados !== 'undefined' && Array.isArray(dados)) {
                    const areasDosDados = dados.map(t => t.area).filter(a => a);
                    areasExistentes = [...areasExistentes, ...areasDosDados];
                }
                areasExistentes = [...new Set(areasExistentes)].sort();
            } catch (e) {
                console.error('[BUG FIX] Erro ao coletar √°reas:', e);
                areasExistentes = AREAS_FIXAS || [];
            }
            
            const selectArea = document.getElementById('modalCadastroArea');
            if (!selectArea) {
                console.error('[BUG FIX] Select modalCadastroArea n√£o encontrado!');
                return;
            }
            
            selectArea.innerHTML = '<option value="">Selecione...</option>' +
                areasExistentes.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Limpar campos
            const temaInput = document.getElementById('modalNovoTema');
            const prioridadeInput = document.getElementById('modalNovaPrioridade');
            const dataInput = document.getElementById('modalNovaDataInicio');
            
            if (temaInput) temaInput.value = '';
            if (prioridadeInput) prioridadeInput.value = '3';
            if (dataInput) dataInput.value = '';
            
            const modal = document.getElementById('modalCadastro');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('[BUG FIX] Modal modalCadastro n√£o encontrado!');
            }
        }
        
        function fecharModalCadastro() {
            document.getElementById('modalCadastro').classList.remove('active');
        }
        
        function salvarNovoTemaModal(event) {
            event.preventDefault();
            
            // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
            const modalNovaAreaInput = document.getElementById('modalNovaAreaInput');
            let area = '';
            if (modalNovaAreaInput && modalNovaAreaInput.style.display !== 'none' && modalNovaAreaInput.value.trim()) {
                area = modalNovaAreaInput.value.trim();
            } else {
                const selectArea = document.getElementById('modalCadastroArea');
                if (selectArea) {
                    area = selectArea.value.trim();
                }
            }
            
            // Validar que n√£o √© a op√ß√£o especial
            if (area === '__NOVA_AREA__' || !area) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                return;
            }
            
            const tema = document.getElementById('modalNovoTema').value.trim();
            const prioridade = parseInt(document.getElementById('modalNovaPrioridade').value) || 3;
            const dataInicio = document.getElementById('modalNovaDataInicio').value;
            
            if (!area || !tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha √°rea e tema!', 'error');
                return;
            }
            
            // Verificar duplicata
            const duplicado = dados.find(t => 
                t.area.toLowerCase() === area.toLowerCase() && 
                t.tema.toLowerCase() === tema.toLowerCase()
            );
            
            if (duplicado) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema j√° existe!', 'error');
                return;
            }
            
            const novoTema = {
                id: Date.now(),
                area: area,
                tema: tema,
                status: 'Planejado',
                prioridade: prioridade,
                rendimento: 0,
                sessoes: 0,
                tempo: 0,
                agenda: dataInicio || '',
                ultimoEstudo: ''
            };
            
            dados.push(novoTema);
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            
            // Criar anota√ß√£o vazia para o tema
            const novaAnotacao = {
                id: Date.now() + 1,
                temaId: String(novoTema.id),
                area: area,
                tema: tema,
                conteudo: '',
                hotTopics: '',
                ultimaAtualizacao: ''
            };
            anotacoes.push(novaAnotacao);
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            
            fecharModalCadastro();
            renderDadosTable();
            mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
        }
        
        // ==================== MODAL EDITAR ANOTA√á√ÉO ====================
        
        function fecharModalAnotacao() {
            document.getElementById('modalEditarAnotacao').classList.remove('active');
        }
        
        function editarAnotacaoModal(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            
            if (!tema) return;
            
            // Preencher modal
            document.getElementById('editAnotacaoTemaId').value = temaId;
            document.getElementById('editAnotacaoTema').textContent = tema.tema;
            document.getElementById('editAnotacaoArea').textContent = tema.area;
            document.getElementById('editAnotacaoHotTopics').value = anotacao?.hotTopics || '';
            document.getElementById('editAnotacaoConteudo').value = anotacao?.conteudo || '';
            
            document.getElementById('modalEditarAnotacao').classList.add('active');
        }
        
        function salvarAnotacaoModal() {
            const temaId = document.getElementById('editAnotacaoTemaId').value;
            const hotTopics = document.getElementById('editAnotacaoHotTopics').value.trim();
            const conteudo = document.getElementById('editAnotacaoConteudo').value.trim();
            
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            
            if (!anotacao) {
                anotacao = {
                    id: Date.now(),
                    temaId: String(temaId),
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    hotTopics: '',
                    ultimaAtualizacao: ''
                };
                anotacoes.push(anotacao);
            }
            
            anotacao.hotTopics = hotTopics;
            anotacao.conteudo = conteudo;
            anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
            
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            
            document.getElementById('modalEditarAnotacao').classList.remove('active');
            renderCadernoV2();
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
        }
        
        // ==================== CADERNO V2 ====================
        
        function renderCadernoV2() {
            const container = document.getElementById('cadernoAreasContainer');
            if (!container) return;
            
            // Recarregar anota√ß√µes
            try {
                const anotacoesSalvas = localStorage.getItem('vrvs_anotacoes');
                if (anotacoesSalvas) {
                    anotacoes = JSON.parse(anotacoesSalvas);
                }
            } catch (e) {
                console.error('[CADERNO] Erro ao carregar anota√ß√µes:', e);
            }
            
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            // Popular select de √°reas
            const selectArea = document.getElementById('cadernoFiltroArea');
            if (selectArea && selectArea.options.length <= 1) {
                const areasUnicas = [...new Set(dados.map(t => t.area))].sort();
                areasUnicas.forEach(area => {
                    const opt = document.createElement('option');
                    opt.value = area;
                    opt.textContent = area;
                    selectArea.appendChild(opt);
                });
            }
            
            // Agrupar temas por √°rea
            const areaGroups = {};
            
            dados.forEach(tema => {
                if (tema.status === 'Suspenso') return;
                if (filtroArea && tema.area !== filtroArea) return;
                
                if (!areaGroups[tema.area]) {
                    areaGroups[tema.area] = [];
                }
                
                // Buscar anota√ß√£o do tema
                const anotacao = anotacoes.find(a => String(a.temaId) === String(tema.id));
                
                areaGroups[tema.area].push({
                    temaId: tema.id,
                    tema: tema.tema,
                    area: tema.area,
                    conteudo: anotacao?.conteudo || '',
                    hotTopics: anotacao?.hotTopics || '',
                    ultimaAtualizacao: anotacao?.ultimaAtualizacao || ''
                });
            });
            
            if (Object.keys(areaGroups).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìì</div><div>Nenhum tema encontrado</div></div>';
                return;
            }
            
            // Ordenar √°reas
            const areasOrdenadas = Object.keys(areaGroups).sort();
            
            let html = '';
            
            areasOrdenadas.forEach(area => {
                const temas = areaGroups[area];
                const temasComConteudo = temas.filter(t => t.conteudo || t.hotTopics).length;
                const areaId = area.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                
                html += `
                    <div class="area-section" data-area="${area}">
                        <div class="area-header collapsed" onclick="toggleAreaCaderno('${areaId}')">
                            <div class="area-header-left">
                                <span class="area-header-title">üìÅ ${area}</span>
                                <span class="area-header-count">${temasComConteudo}/${temas.length}</span>
                            </div>
                            <span class="area-header-toggle">‚ñº</span>
                        </div>
                        <div class="area-content collapsed" id="area-content-${areaId}">
                            <div class="tema-list">
                `;
                
                // Ordenar temas alfabeticamente
                temas.sort((a, b) => a.tema.localeCompare(b.tema, 'pt-BR'));
                
                temas.forEach(tema => {
                    const temHotTopics = tema.hotTopics && tema.hotTopics.trim();
                    const temConteudo = tema.conteudo && tema.conteudo.trim();
                    
                    let itemClass = 'tema-item';
                    if (temHotTopics) itemClass += ' has-hottopics';
                    else if (temConteudo) itemClass += ' has-content';
                    
                    const temaIdStr = String(tema.temaId);
                    const conteudoId = `tema-conteudo-${temaIdStr}`;
                    
                    // TAREFA 1: Remover truncamento - usar texto completo sempre
                    // No Caderno, o objetivo √© ver o conte√∫do completo, n√£o preview
                    const hotTopicsCompleto = temHotTopics ? tema.hotTopics : '';
                    const conteudoCompleto = temConteudo ? tema.conteudo : '';
                    
                    html += `
                        <div class="${itemClass}" data-tema-id="${temaIdStr}">
                            <div class="tema-item-header" onclick="toggleTemaCaderno('${temaIdStr}')">
                                <span class="tema-item-name">üìù ${tema.tema}</span>
                                <div class="tema-item-actions">
                                    ${tema.ultimaAtualizacao ? `<span class="tema-item-date">${formatarData(tema.ultimaAtualizacao)}</span>` : ''}
                                    <button class="tema-item-btn" onclick="event.stopPropagation(); editarAnotacaoModal(${tema.temaId})" title="Editar">‚úèÔ∏è</button>
                                </div>
                            </div>
                            <div id="${conteudoId}" class="tema-item-conteudo collapsed">
                                ${temHotTopics ? `
                            <div class="hottopics-preview">
                                        <div class="hottopics-label">üî• Hot Topics</div>
                                        <div class="hottopics-text">${escapeHtmlCaderno(hotTopicsCompleto).replace(/\n/g, '<br>')}</div>
                            </div>
                                ` : ''}
                                ${temConteudo ? `
                                    <div class="conteudo-preview">
                                        <div class="conteudo-label">üßæ Anota√ß√µes</div>
                                        <div class="conteudo-text">${escapeHtmlCaderno(conteudoCompleto).replace(/\n/g, '<br>')}</div>
                                    </div>
                                ` : ''}
                                ${!temHotTopics && !temConteudo ? `
                                    <div class="conteudo-vazio">
                                        <em>Sem conte√∫do registrado para este tema.</em>
                                    </div>
                                ` : ''}
                            </div>
                            </div>
                        `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleTemaCaderno(temaId) {
            const conteudo = document.getElementById(`tema-conteudo-${temaId}`);
            if (!conteudo) return;
            
            const isCollapsed = conteudo.classList.contains('collapsed');
            if (isCollapsed) {
                conteudo.classList.remove('collapsed');
                conteudo.style.display = 'block';
                // TAREFA 1: Remover limita√ß√£o de altura - permitir conte√∫do completo
                // Usar scrollHeight real ou valor muito alto para n√£o limitar
                const scrollHeight = conteudo.scrollHeight || 0;
                // Usar valor muito alto (9999px) para garantir que conte√∫do completo seja vis√≠vel
                conteudo.style.maxHeight = Math.max(scrollHeight + 100, 9999) + 'px';
                conteudo.style.overflow = 'visible'; // Garantir que conte√∫do n√£o √© cortado
            } else {
                conteudo.classList.add('collapsed');
                conteudo.style.maxHeight = '0px';
                conteudo.style.display = 'none';
            }
        }
        
        function toggleAreaCaderno(areaId) {
            const header = document.querySelector(`[onclick="toggleAreaCaderno('${areaId}')"]`);
            const content = document.getElementById(`area-content-${areaId}`);
            
            if (header && content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                
                // CORRE√á√ÉO: Remover display: none inline se existir
                if (content.style.display === 'none') {
                    content.style.display = '';
                }
                
                // Se est√° expandindo, usar max-height generoso ou remover limite
                if (!content.classList.contains('collapsed')) {
                    // CORRE√á√ÉO: Usar scrollHeight + margem OU valor generoso (70vh)
                    const scrollHeight = content.scrollHeight;
                    const viewportHeight = window.innerHeight;
                    const maxHeightVH = Math.min(scrollHeight + 100, viewportHeight * 0.7); // 70% da viewport ou scrollHeight + margem
                    content.style.maxHeight = maxHeightVH + 'px';
                } else {
                    content.style.maxHeight = '0';
                }
            }
        }
        
        function escapeHtmlCaderno(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        // ==================== AGENDA UNIFICADA ====================
        
        let vistaAgenda = 'timeline';
        
        function setVistaAgenda(vista) {
            vistaAgenda = vista;
            
            // Atualizar bot√µes
            document.getElementById('btnTimeline').classList.toggle('active', vista === 'timeline');
            document.getElementById('btnAtrasados').classList.toggle('active', vista === 'atrasados');
            
            // Mostrar/esconder filtros
            const filtros = document.getElementById('agendaFiltros');
            if (filtros) {
                filtros.style.display = vista === 'timeline' ? 'flex' : 'none';
            }
            
            renderAgendaUnificada();
        }
        
        function renderAgendaUnificada() {
            if (vistaAgenda === 'atrasados') {
                renderAgendaAtrasados();
            } else {
                renderAgenda();
            }
        }
        
        // Helper: Obter n√∫mero de sess√µes de um tema
        function obterNumeroSessoesTema(t) {
            if (typeof t.totalSessoes === 'number') return t.totalSessoes;
            if (typeof t.sessoes === 'number') return t.sessoes;
            return 0;
        }
        
        // Helper: Renderizar card de tema atrasado
        function renderCardTemaAtrasadoHTML(t) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const diasAtraso = Math.floor((hoje - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
            const sugestao = obterSugestaoTema ? obterSugestaoTema(t) : '';
            const rendPct = Math.round((t.rendimento || 0) * 100);
            const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
            const dataFormatada = formatarDataBR ? formatarDataBR(t.agenda) : t.agenda;
            const tipo = calcularTipoRevisao ? calcularTipoRevisao(t) : '';
            const numSessoes = obterNumeroSessoesTema(t);
            
            return `
                <div class="task-item priority-${t.prioridade || 3}" style="margin-bottom: 12px;">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-meta">
                            <span class="task-date-atraso" style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                üìÖ ${dataFormatada} ‚Ä¢ ‚ö†Ô∏è ${diasAtraso} dias atrasado
                            </span>
                        </div>
                    </div>
                    <div class="task-body">
                        <div class="task-tags">
                            <span class="task-tag-area">üìö ${t.area || ''}</span>
                            <span class="task-tag-rendimento" style="color: ${rendColor};">
                                üìä ${rendPct}%
                            </span>
                            <span class="task-tag-sessoes" style="color: rgba(255,255,255,0.7);">
                                üì¢ ${numSessoes} sess√µes
                            </span>
                            ${tipo ? `<span class="task-tag-tipo">${tipo}</span>` : ''}
                        </div>
                        ${sugestao ? `
                        <div class="task-suggestion">
                            <div class="task-suggestion-label">Diretriz</div>
                            <div class="task-suggestion-text">${sugestao}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Fun√ß√£o para colapso leve por √°rea em Atrasados
        function toggleAtrasadosArea(areaId) {
            const conteudo = document.getElementById(`atrasados-conteudo-${areaId}`);
            if (!conteudo) return;
            
            const isCollapsed = conteudo.classList.contains('collapsed');
            if (isCollapsed) {
                conteudo.classList.remove('collapsed');
                conteudo.style.display = 'block';
            } else {
                conteudo.classList.add('collapsed');
                conteudo.style.display = 'none';
            }
        }
        
        function renderAgendaAtrasados() {
            const container = document.getElementById('agendaContainer');
            if (!container) return;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const hojeStr = hoje.toISOString().split('T')[0];
            
            // 1) Filtrar apenas temas atrasados e n√£o conclu√≠dos
            const atrasados = dados.filter(t => {
                if (!t || !t.agenda) return false;
                if (t.status === 'Conclu√≠do') return false;
                if (typeof dataValida === 'function' && !dataValida(t.agenda)) return false;
                return t.agenda < hojeStr;
            });
            
            if (!atrasados.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div>Nenhuma atividade atrasada na Agenda.</div>
                    </div>
                `;
                return;
            }
            
            // 2) Agrupar atrasados por √°rea
            const porArea = {};
            atrasados.forEach(t => {
                const area = t.area || 'Outros';
                if (!porArea[area]) porArea[area] = [];
                porArea[area].push(t);
            });
            
            // 3) Gerar HTML
            let html = '';
            Object.keys(porArea).sort().forEach(area => {
                const temas = porArea[area];
                
                // Ordenar temas desta √°rea:
                // 1) por n√∫mero de sess√µes (crescente)
                // 2) em caso de empate, por data (mais antigo primeiro)
                temas.sort((a, b) => {
                    const sa = obterNumeroSessoesTema(a);
                    const sb = obterNumeroSessoesTema(b);
                    if (sa !== sb) return sa - sb;
                    return a.agenda.localeCompare(b.agenda);
                });
                
                const areaId = area.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                const totalTemas = temas.length;
                
                html += `
                    <div class="atrasados-area" id="atrasados-area-${areaId}" style="margin-bottom: 16px; border-radius: 10px; overflow: hidden;">
                        <div class="atrasados-area-header" onclick="toggleAtrasadosArea('${areaId}')" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: rgba(255,159,64,0.15); border: 1px solid rgba(255,159,64,0.3); border-left: 3px solid var(--cobre-main); color: var(--cobre-light); cursor: pointer;">
                            <span class="atrasados-area-nome" style="font-weight: 600; font-size: 14px;">üìÅ ${area}</span>
                            <span class="atrasados-area-badge" style="font-size: 12px; padding: 2px 8px; border-radius: 999px; background: rgba(255,127,80,0.3); color: #FFE4C4;">${totalTemas} atrasado${totalTemas > 1 ? 's' : ''}</span>
                        </div>
                        <div class="atrasados-area-conteudo" id="atrasados-conteudo-${areaId}" style="padding: 8px 10px 12px; background: rgba(0,0,0,0.15);">
                            ${temas.map(renderCardTemaAtrasadoHTML).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== AN√ÅLISES ====================
        
        let vistaAnalytics = 'resumo';
        
        function setVistaAnalytics(vista) {
            vistaAnalytics = vista;
            
            // Atualizar bot√µes
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                if (btn.id && btn.id.startsWith('btnAnalytics')) {
                    btn.classList.remove('active');
                }
            });
            
            // Mapear vista para ID do bot√£o corretamente
            const vistaMap = {
                'resumo': 'Resumo',
                'graficos': 'Graficos',
                'detalhado': 'Detalhado',
                'historico': 'Historico'
            };
            
            const btnId = `btnAnalytics${vistaMap[vista] || vista.charAt(0).toUpperCase() + vista.slice(1)}`;
            const btnAtivo = document.getElementById(btnId);
            if (btnAtivo) {
                btnAtivo.classList.add('active');
            } else {
                console.warn('[ANALYTICS] Bot√£o n√£o encontrado para vista:', vista, 'ID esperado:', btnId);
            }
            
            renderAnalytics();
        }
        
        function renderAnalytics() {
            const container = document.getElementById('analyticsContainer');
            if (!container) {
                console.error('[ANALYTICS] Container n√£o encontrado!');
                return;
            }
            
            // Garantir que vistaAnalytics tenha um valor v√°lido
            if (!vistaAnalytics) vistaAnalytics = 'resumo';
            
            console.log('[ANALYTICS] Renderizando vista:', vistaAnalytics);
            
            switch(vistaAnalytics) {
                case 'resumo':
                    renderAnalyticsResumo(container);
                    break;
                case 'graficos':
                    renderAnalyticsGraficos(container);
                    break;
                // case 'detalhado':
                //     renderAnalyticsDetalhado(container);
                //     break;
                // Temporariamente removido - precisa reimplementa√ß√£o (campos h.questoes/flashcards n√£o existem)
                case 'historico':
                    renderAnalyticsHistorico(container);
                    break;
                default:
                    console.warn('[ANALYTICS] Vista desconhecida:', vistaAnalytics, '- usando resumo');
                    vistaAnalytics = 'resumo';
                    renderAnalyticsResumo(container);
                    break;
            }
        }
        
        function renderAnalyticsResumo(container) {
            // Filtrar hist√≥rico de temas suspensos (igual ao c√≥digo antigo que funcionava)
            const historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                return tema && tema.status !== 'Suspenso';
            });
            
            // Calcular estat√≠sticas usando hist√≥rico ATIVO
            const totalTemas = dados.filter(t => t.status !== 'Suspenso').length;
            const totalSessoes = historicoAtivo.length;
            const rendimentoMedio = historicoAtivo.length > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / historicoAtivo.length) * 100)
                : 0;
            
            // CORRE√á√ÉO: Usar hist√≥rico para calcular tempo total, n√£o dados
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const horasTotal = Math.round(totalMinutos / 60);
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes) - C√ìDIGO ID√äNTICO AO ANTIGO
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            let questoesEncontradas = 0;
            historicoAtivo.forEach((h, idx) => {
                if (h.questoes) {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: questoes="${h.questoes}"`);
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                        questoesEncontradas++;
                        console.log(`[DEBUG RESUMO] Match encontrado: ${match[1]}/${match[2]}`);
                    } else {
                        console.log(`[DEBUG RESUMO] Match N√ÉO encontrado para: "${h.questoes}"`);
                    }
                } else {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: h.questoes √© ${h.questoes} (tipo: ${typeof h.questoes})`);
                }
            });
            console.log(`[DEBUG RESUMO] Total de sess√µes com quest√µes: ${questoesEncontradas}/${historicoAtivo.length}`);
            
            // Calcular flashcards totais - C√ìDIGO ID√äNTICO AO ANTIGO
            let flashcardsEncontrados = 0;
            const totalFlashcards = historicoAtivo.reduce((sum, h, idx) => {
                const val = parseInt(h.flashcards) || 0;
                if (val > 0) {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: flashcards=${h.flashcards} (valor: ${val})`);
                    flashcardsEncontrados++;
                }
                return sum + val;
            }, 0);
            console.log(`[DEBUG RESUMO] Total de sess√µes com flashcards: ${flashcardsEncontrados}/${historicoAtivo.length}`);
            
            const totalQuestoes = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular m√©tricas VRVS 3P para o painel
            let htmlVrvs3p = '';
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            let statsVrvs3p = {};
            try {
                statsVrvs3p = calcularEstatisticasVrvs3p(window.diario, hojeStr()) || {};
            } catch (e) {
                console.error('[VRVS3P] Erro ao calcular estat√≠sticas:', e);
                statsVrvs3p = { totalAtivos: 0, totalHoje: 0, totalAtrasadas: 0 };
            }
            const faixaVrvs3p = (statsVrvs3p && statsVrvs3p.retencaoGlobal !== null && statsVrvs3p.retencaoGlobal !== undefined) ? classificarFaixaRetencao(statsVrvs3p.retencaoGlobal) : 'nenhum';
            const mensagemVrvs3p = mensagemRetencao((statsVrvs3p && statsVrvs3p.retencaoGlobal) ? statsVrvs3p.retencaoGlobal : 0, statsVrvs3p || {});
            
            // Montar painel VRVS 3P colaps√°vel (vers√£o refinada para Resumo)
            // SEMPRE renderizar painel (mesmo se vazio)
            const faixaTexto = faixaVrvs3p === 'alta' ? 'Alta' : faixaVrvs3p === 'media' ? 'M√©dia' : 'Baixa';
            const resumoHeader = (statsVrvs3p && statsVrvs3p.totalAtivos > 0 && statsVrvs3p.retencaoGlobalPct !== null)
                ? `${statsVrvs3p.retencaoGlobalPct}% ¬∑ ${statsVrvs3p.totalAtivos} ativos ¬∑ ${statsVrvs3p.totalHoje || 0} hoje ¬∑ ${statsVrvs3p.totalAtrasadas || 0} atrasados ¬∑ ${faixaTexto}`
                : (statsVrvs3p && statsVrvs3p.totalAtivos > 0)
                ? `${statsVrvs3p.totalAtivos} ativos ¬∑ ${statsVrvs3p.totalHoje || 0} hoje ¬∑ ${statsVrvs3p.totalAtrasadas || 0} atrasados`
                : 'Nenhum t√≥pico ativo ainda';
            
            if (statsVrvs3p && statsVrvs3p.totalAtivos > 0) {
                const classeBarra = faixaVrvs3p === 'alta' ? 'alta' : faixaVrvs3p === 'media' ? 'media' : 'baixa';
                // Usar classe da mensagem se dispon√≠vel, sen√£o usar faixa de reten√ß√£o
                const classeMensagem = (mensagemVrvs3p && mensagemVrvs3p.classe) ? mensagemVrvs3p.classe : (faixaVrvs3p === 'alta' ? 'alta' : faixaVrvs3p === 'media' ? 'media' : 'baixa');
                htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card vrvs3p-collapsed">
                        <button type="button" class="vrvs3p-header" onclick="togglePainelVrvs3p()">
                            <span class="vrvs3p-title">üß† SA√öDE DO DI√ÅRIO VRVS 3P</span>
                            <div class="vrvs3p-header-right">
                                <span class="vrvs3p-summary">${resumoHeader}</span>
                                <span class="vrvs3p-caret">‚ñæ</span>
                            </div>
                        </button>
                        <div class="vrvs3p-body">
                            ${statsVrvs3p.retencaoGlobalPct !== null ? `
                                <div class="vrvs3p-barra-container">
                                    <div class="vrvs3p-barra-track">
                                        <div class="vrvs3p-barra-fill ${classeBarra}" style="width: ${statsVrvs3p.retencaoGlobalPct}%;"></div>
                                    </div>
                                    <div class="vrvs3p-barra-label">
                                        <span class="vrvs3p-barra-percent">${statsVrvs3p.retencaoGlobalPct}%</span>
                                        <span class="vrvs3p-barra-status">${faixaTexto}</span>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="vrvs3p-metricas">
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor">${statsVrvs3p.totalAtivos}</span>
                                    <span class="vrvs3p-metrica-label">ativos</span>
                                </div>
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor">${statsVrvs3p.totalHoje}</span>
                                    <span class="vrvs3p-metrica-label">para hoje</span>
                                </div>
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor" style="color: ${statsVrvs3p.totalAtrasadas > 0 ? '#dc3545' : 'rgba(255,255,255,0.8)'}">${statsVrvs3p.totalAtrasadas}</span>
                                    <span class="vrvs3p-metrica-label">atrasados</span>
                                </div>
                            </div>
                            <div class="vrvs3p-mensagem-box ${classeMensagem}">
                                <div class="vrvs3p-mensagem-text">
                                    <span class="vrvs3p-mensagem-emoji">${(mensagemVrvs3p && typeof mensagemVrvs3p === 'object' && mensagemVrvs3p.emoji) ? mensagemVrvs3p.emoji : '‚ú®'}</span>
                                    <span>${(mensagemVrvs3p && typeof mensagemVrvs3p === 'object' && mensagemVrvs3p.texto) ? mensagemVrvs3p.texto : (mensagemVrvs3p || '')}</span>
                                </div>
                            </div>
                            <div class="vrvs3p-disclaimer">Estimativa VRVS 3P ¬∑ N√£o √© nota, √© mapa de esfor√ßo</div>
                        </div>
                    </section>
                `;
            } else {
                const mensagemVazia = mensagemRetencao(0, statsVrvs3p || {});
                htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card vrvs3p-collapsed">
                        <button type="button" class="vrvs3p-header" onclick="togglePainelVrvs3p()">
                            <span class="vrvs3p-title">üß† SA√öDE DO DI√ÅRIO VRVS 3P</span>
                            <div class="vrvs3p-header-right">
                                <span class="vrvs3p-summary">Nenhum t√≥pico ativo ainda</span>
                                <span class="vrvs3p-caret">‚ñæ</span>
                            </div>
                        </button>
                        <div class="vrvs3p-body">
                            <div class="vrvs3p-mensagem-box">
                                <div class="vrvs3p-mensagem-text">
                                    <span class="vrvs3p-mensagem-emoji">${(mensagemVazia && typeof mensagemVazia === 'object' && mensagemVazia.emoji) ? mensagemVazia.emoji : '‚ú®'}</span>
                                    <span>${(mensagemVazia && typeof mensagemVazia === 'object' && mensagemVazia.texto) ? mensagemVazia.texto : (mensagemVazia || '')}</span>
                                </div>
                            </div>
                            <div class="vrvs3p-disclaimer">Estimativa VRVS 3P ¬∑ N√£o √© nota, √© mapa de esfor√ßo</div>
                        </div>
                    </section>
                `;
            }
            
            container.innerHTML = htmlVrvs3p + `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalTemas}</div>
                        <div class="stat-label">M√≥dulos Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes Totais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${horasTotal}h</div>
                        <div class="stat-label">Tempo Investido</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoes}</div>
                        <div class="stat-label">Quest√µes Resolvidas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                </div>
                
                <!-- Filtro de per√≠odo -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px;">
                    <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ An√°lise por Per√≠odo</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="date" class="form-input" id="analyticsDataInicio" style="flex: 1; min-width: 120px;">
                        <input type="date" class="form-input" id="analyticsDataFim" style="flex: 1; min-width: 120px;">
                        <button class="btn btn-small" onclick="gerarRelatorioAnalytics()">Gerar</button>
                    </div>
                    <div id="analyticsRelatorioResultado" style="margin-top: 15px;"></div>
                </div>
            `;
        }
        
        function renderAnalyticsGraficos(container) {
            // Destruir gr√°ficos antigos se existirem ANTES de criar novos
            // CORRE√á√ÉO: Destruir apenas inst√¢ncias Analytics, n√£o Stats
            if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
            if (chartLinhaAnalyticsInst) { 
                try {
                    chartLinhaAnalyticsInst.destroy(); 
                } catch(e) {
                    console.warn('[ANALYTICS] Erro ao destruir gr√°fico linha:', e);
                }
                chartLinhaAnalyticsInst = null; 
            }
            if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
            
            // Criar HTML com abas colaps√°veis para gr√°ficos
            container.innerHTML = `
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-barras')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìä Performance por √Årea</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-barras">
                    <canvas id="chartBarrasAnalytics" width="400" height="150"></canvas>
                </div>
                </div>
                
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-linha')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìà Evolu√ß√£o Temporal</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-linha">
                        <div id="chartLinhaControlesAnalytics" class="chart-toggles"></div>
                    <canvas id="chartLinhaAnalytics" width="400" height="150"></canvas>
                </div>
                </div>
                
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-radar')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üéØ Radar de Compet√™ncias</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-radar">
                    <canvas id="chartRadarAnalytics" width="400" height="200"></canvas>
                    </div>
                </div>
            `;
            
            // Renderizar gr√°ficos usando os IDs espec√≠ficos da aba Analytics
            // CORRE√á√ÉO: Aguardar Chart.js estar dispon√≠vel e DOM estar pronto
            const tentarRenderizarGraficos = () => {
                if (typeof Chart === 'undefined') {
                    console.warn('[ANALYTICS GRAFICOS] Chart.js n√£o est√° dispon√≠vel ainda, tentando novamente...');
                    setTimeout(tentarRenderizarGraficos, 100);
                    return;
                }
                
                const canvasBarras = document.getElementById('chartBarrasAnalytics');
                const canvasLinha = document.getElementById('chartLinhaAnalytics');
                const canvasRadar = document.getElementById('chartRadarAnalytics');
                
                if (!canvasBarras || !canvasLinha || !canvasRadar) {
                    console.warn('[ANALYTICS GRAFICOS] Canvas n√£o encontrado, tentando novamente...');
                    setTimeout(tentarRenderizarGraficos, 100);
                    return;
                }
                
                console.log('[ANALYTICS GRAFICOS] Renderizando gr√°ficos...');
                renderChartBarras('chartBarrasAnalytics');
                
                // Renderizar controles de toggle para gr√°fico de linha (Analytics)
                renderChartLinhaControlesAnalytics();
                renderChartLinha('chartLinhaAnalytics');
                
                renderChartRadar('chartRadarAnalytics');
            };
            
            requestAnimationFrame(() => {
                setTimeout(tentarRenderizarGraficos, 50);
            });
        }
        
        function renderAnalyticsDetalhado(container) {
            // CORRE√á√ÉO: Incluir todos os elementos HTML necess√°rios (filtros, selects)
            container.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--turquesa-light); font-size: 14px; font-weight: 600;">üîç An√°lises por √Årea e Tema</span>
                    <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px;">
                        <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar An√°lises de Tempo</span>
                    </button>
                </div>
                
                <!-- FILTROS -->
                <div style="margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Filtrar por √Årea</label>
                        <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                            <option value="">Todas as √°reas</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Filtrar por Tema</label>
                        <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                            <option value="">Todos os temas</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Per√≠odo</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                            <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">üìÖ Semana Atual</button>
                        <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">üìÜ M√™s Atual</button>
                        <button class="btn btn-small" onclick="limparFiltrosAnalise()">üóëÔ∏è Limpar Filtros</button>
                    </div>
                </div>
                
                <!-- RESULTADOS -->
                <div id="analiseResultados" style="margin-top: 20px;">
                    <!-- Resultados ser√£o renderizados aqui por calcularAnalises() -->
                </div>
                
                <!-- AN√ÅLISES DE TEMPO (toggle) -->
                <div id="analiseTempo" style="display: none; margin-top: 20px;">
                    <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                </div>
            `;
            
            // Popular selects e calcular an√°lises
            setTimeout(() => {
                atualizarSelectsAnalise();
                atualizarAnalises();
            }, 100);
        }
        
        function renderAnalyticsHistorico(container) {
            // Renderizar hist√≥rico com estrutura completa da tabela
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <span style="color: var(--turquesa-light); font-size: 14px;">üìú Hist√≥rico de Sess√µes</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tema</th>
                                <th>√Årea</th>
                                <th>Rend.</th>
                                <th>Tempo</th>
                                <th>Diretriz</th>
                            </tr>
                        </thead>
                        <tbody id="historicoTableBodyAnalytics">
                            <!-- Conte√∫do ser√° preenchido por renderHistoricoAnalytics() -->
                        </tbody>
                    </table>
                </div>
            `;
            
            // Chamar fun√ß√£o de hist√≥rico espec√≠fica para Analytics ap√≥s DOM estar pronto
            // CORRE√á√ÉO: Aguardar DOM estar pronto e tentar m√∫ltiplas vezes se necess√°rio
            const tentarRenderizarHistorico = () => {
                const tbody = document.getElementById('historicoTableBodyAnalytics');
                if (!tbody) {
                    console.warn('[ANALYTICS HISTORICO] Tbody n√£o encontrado, tentando novamente...');
                    setTimeout(tentarRenderizarHistorico, 100);
                    return;
                }
                console.log('[ANALYTICS HISTORICO] Renderizando hist√≥rico...');
                renderHistoricoAnalytics();
            };
            
            requestAnimationFrame(() => {
                setTimeout(tentarRenderizarHistorico, 50);
            });
        }
        
        function renderHistoricoAnalytics() {
            const tbody = document.getElementById('historicoTableBodyAnalytics');
            if (!tbody) {
                console.warn('[RENDER HISTORICO ANALYTICS] Tbody n√£o encontrado!');
                return;
            }
            
            console.log('[RENDER HISTORICO ANALYTICS] Total de registros no hist√≥rico:', historico.length);
            
            // Filtrar hist√≥rico inv√°lido
            const historicoFiltrado = historico.filter(h => {
                if (!h.area || !h.tema) return false;
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                return true;
            });
            
            console.log('[RENDER HISTORICO ANALYTICS] Registros ap√≥s filtro:', historicoFiltrado.length);
            
            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                // Unificar observa√ß√µes e sugest√£o em uma √∫nica coluna "Diretriz"
                const diretriz = [
                    h.observacoes && h.observacoes !== '-' ? h.observacoes : '',
                    h.sugestao && h.sugestao !== '-' ? h.sugestao : ''
                ].filter(s => s.trim() !== '').join(' ') || '-';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${diretriz}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function gerarRelatorioAnalytics() {
            const dataInicio = document.getElementById('analyticsDataInicio')?.value;
            const dataFim = document.getElementById('analyticsDataFim')?.value;
            const container = document.getElementById('analyticsRelatorioResultado');
            
            if (!dataInicio || !dataFim) {
                container.innerHTML = '<div style="color: var(--cobre-light);">‚ö†Ô∏è Selecione as datas</div>';
                return;
            }
            
            // Filtrar hist√≥rico pelo per√≠odo
            const historicoFiltrado = historico.filter(h => {
                const data = h.data;
                return data >= dataInicio && data <= dataFim;
            });
            
            if (historicoFiltrado.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6);">Nenhuma sess√£o encontrada no per√≠odo.</div>';
                return;
            }
            
            const totalSessoes = historicoFiltrado.length;
            const rendMedio = Math.round(historicoFiltrado.reduce((a, h) => a + (h.rendimento || 0), 0) / totalSessoes * 100);
            const tempoTotal = historicoFiltrado.reduce((a, h) => a + (h.tempo || 0), 0);
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes) - C√ìDIGO ID√äNTICO AO ANTIGO
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            
            // Calcular flashcards totais - C√ìDIGO ID√äNTICO AO ANTIGO
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            const totalQuestoes = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalSessoes}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Sess√µes</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${rendMedio}%</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Performance</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${Math.round(tempoTotal/60)}h</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Tempo</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalQuestoes}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Quest√µes</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalFlashcards.toLocaleString()}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Flashcards</div>
                    </div>
                </div>
            `;
        }
        
        // ==================== AJUDA ====================
        
        let vistaAjuda = 'tutorial';
        
        function setVistaAjuda(vista) {
            vistaAjuda = vista;
            
            // Atualizar bot√µes
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                if (btn.id && btn.id.startsWith('btnAjuda')) {
                    btn.classList.remove('active');
                }
            });
            
            const btnAtivo = document.getElementById(`btnAjuda${vista.charAt(0).toUpperCase() + vista.slice(1)}`);
            if (btnAtivo) btnAtivo.classList.add('active');
            
            renderAjuda();
        }
        
        function renderAjuda() {
            const container = document.getElementById('ajudaContainer');
            if (!container) return;
            
            switch(vistaAjuda) {
                case 'tutorial':
                    renderAjudaTutorial(container);
                    break;
                case 'lembretes':
                    renderAjudaLembretes(container);
                    break;
                case 'faq':
                    renderAjudaFaq(container);
                    break;
            }
        }
        
        function renderAjudaTutorial(container) {
            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado</h3>
                    <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                        Um guia passo a passo por todas as funcionalidades
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(0,206,209,0.1), rgba(13,148,136,0.05)); border-radius: 8px; padding: 20px;">
                    <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Guia R√°pido</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìã Tarefa</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Veja o que estudar hoje baseado na revis√£o espa√ßada.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìù Feedback</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Registre suas sess√µes de estudo com tempo, performance e quest√µes.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìî Di√°rio</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Anote aprendizados do dia no formato pergunta/resposta para recall ativo.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìì Caderno</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Registre Hot Topics (pontos de prova) e anota√ß√µes por tema.</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAjudaLembretes(container) {
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <form id="lembreteFormAjuda" onsubmit="adicionarLembreteAjuda(event)">
                        <div class="form-group">
                            <label class="form-label">T√≠tulo do Lembrete</label>
                            <input type="text" class="form-input" id="lembreteTituloAjuda" placeholder="Ex: Revisar vias de acesso" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o (opcional)</label>
                            <textarea class="form-input" id="lembreteDescricaoAjuda" rows="2" placeholder="Detalhes..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Periodicidade</label>
                            <select class="form-select" id="lembretePeriodicidadeAjuda" required>
                                <option value="pontual">Pontual</option>
                                <option value="diaria">Di√°ria</option>
                                <option value="semanal">Semanal</option>
                                <option value="mensal">Mensal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-input" id="lembreteDataAjuda" required>
                        </div>
                        <button type="submit" class="btn">‚ûï Adicionar Lembrete</button>
                    </form>
                </div>
                <div id="lembretesListaAjuda"></div>
            `;
            
            // Renderizar lembretes existentes
            setTimeout(() => {
                renderLembretesLista();
            }, 100);
        }
        
        function renderLembretesLista() {
            const container = document.getElementById('lembretesListaAjuda');
            if (!container) return;
            
            if (lembretes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìå</div><div>Nenhum lembrete</div></div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            lembretes.forEach(l => {
                html += `
                    <div class="task-item" style="padding: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: var(--cobre-light);">${l.titulo}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6);">${l.periodicidade} ‚Ä¢ ${formatarData(l.dataInicial)}</div>
                            </div>
                            <button class="btn-edit" onclick="removerLembrete(${l.id})" title="Remover">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function adicionarLembreteAjuda(event) {
            event.preventDefault();
            
            const titulo = document.getElementById('lembreteTituloAjuda').value.trim();
            const descricao = document.getElementById('lembreteDescricaoAjuda').value.trim();
            const periodicidade = document.getElementById('lembretePeriodicidadeAjuda').value;
            const dataInicial = document.getElementById('lembreteDataAjuda').value;
            
            if (!titulo || !dataInicial) return;
            
            const novoLembrete = {
                id: Date.now(),
                titulo: titulo,
                descricao: descricao,
                periodicidade: periodicidade,
                dataInicial: dataInicial,
                temaId: null,
                ativo: true
            };
            
            lembretes.push(novoLembrete);
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            
            // Limpar form
            document.getElementById('lembreteTituloAjuda').value = '';
            document.getElementById('lembreteDescricaoAjuda').value = '';
            document.getElementById('lembreteDataAjuda').value = '';
            
            renderLembretesLista();
            mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado!');
        }
        
        function renderAjudaFaq(container) {
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <input type="text" id="perguntaAssistenteAjuda" class="form-input" placeholder="Digite sua d√∫vida..." style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="responderDuvidaAjuda()">üîç Buscar Resposta</button>
                </div>
                <div id="respostaAssistenteAjuda" style="display: none; margin-bottom: 20px;"></div>
                
                <h4 style="color: var(--turquesa-light); margin-bottom: 15px;">üìö Perguntas Frequentes</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('adicionar')" style="text-align: left;">‚ùì Como adicionar um tema?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('feedback')" style="text-align: left;">‚ùì Como registrar uma sess√£o?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('agenda')" style="text-align: left;">‚ùì Como usar a agenda?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('backup')" style="text-align: left;">‚ùì Como fazer backup?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('hottopics')" style="text-align: left;">‚ùì O que s√£o Hot Topics?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('caderno')" style="text-align: left;">‚ùì Como usar o Caderno V2?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('analytics')" style="text-align: left;">‚ùì Como usar An√°lises?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('exportar')" style="text-align: left;">‚ùì Como exportar Hot Topics em HTML?</button>
                </div>
                <div id="respostaFaqAjuda" style="margin-top: 20px;"></div>
            `;
        }
        
        function mostrarRespostaAjuda(tipo) {
            const container = document.getElementById('respostaFaqAjuda');
            const respostas = {
                'adicionar': 'V√° em <b>Dados</b> e clique no bot√£o <b>‚ûï Novo Tema</b> no topo. Preencha a √°rea, tema e prioridade no modal que abrir.',
                'feedback': 'V√° em <b>Feedback</b>, selecione o tema, preencha data, performance e tempo (opcional), e clique em Salvar.',
                'agenda': 'A <b>Agenda</b> mostra seus estudos programados. Use o toggle no topo para alternar entre <b>Timeline</b> (cronograma completo) ou <b>Atrasados</b> (pend√™ncias).',
                'backup': 'V√° em <b>Backup</b> e clique nos bot√µes para exportar seus dados em CSV. Para restaurar, use a se√ß√£o Importar na mesma aba.',
                'hottopics': '<b>Hot Topics</b> s√£o os pontos mais importantes de cada tema - aqueles que caem com frequ√™ncia na prova. Anote-os no <b>Caderno</b> no campo destacado em laranja.',
                'caderno': 'O <b>Caderno V2</b> organiza temas por √°rea. Clique no cabe√ßalho da √°rea para expandir/colapsar. Hot Topics aparecem destacados. Clique em ‚úèÔ∏è para editar.',
                'analytics': '<b>An√°lises</b> unifica todas as an√°lises em um s√≥ lugar. Use os bot√µes de sub-navega√ß√£o para alternar entre Resumo, Gr√°ficos e Hist√≥rico.',
                'exportar': 'No <b>Caderno</b>, clique no bot√£o <b>üî• Exportar HTML</b> no topo. Um arquivo HTML ser√° baixado com todos os seus Hot Topics organizados por √°rea.'
            };
            
            container.innerHTML = `
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--turquesa-light);">
                    <div style="font-size: 14px; color: var(--text-light); line-height: 1.6;">${respostas[tipo] || 'Resposta n√£o encontrada.'}</div>
                </div>
            `;
        }
        
        function responderDuvidaAjuda() {
            const pergunta = document.getElementById('perguntaAssistenteAjuda')?.value?.toLowerCase() || '';
            const container = document.getElementById('respostaAssistenteAjuda');
            
            if (!pergunta.trim()) {
                container.style.display = 'none';
                return;
            }
            
            let resposta = 'N√£o encontrei uma resposta espec√≠fica. Tente explorar as perguntas frequentes abaixo.';
            
            if (pergunta.includes('tema') || pergunta.includes('adicionar') || pergunta.includes('cadastr')) {
                resposta = 'Para adicionar um tema, v√° em <b>Dados</b> e clique em <b>‚ûï Novo Tema</b>.';
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registr')) {
                resposta = 'Para registrar uma sess√£o, v√° em <b>Feedback</b> e preencha os dados da sua sess√£o de estudo.';
            } else if (pergunta.includes('backup') || pergunta.includes('export') || pergunta.includes('salvar')) {
                resposta = 'Para fazer backup, v√° em <b>Backup</b> e exporte seus dados em CSV.';
            } else if (pergunta.includes('hot') || pergunta.includes('prova') || pergunta.includes('importante')) {
                resposta = 'Use <b>Hot Topics</b> no <b>Caderno</b> para anotar os pontos mais importantes de cada tema. Voc√™ pode exportar todos em HTML!';
            } else if (pergunta.includes('caderno') || pergunta.includes('anota√ß√£o')) {
                resposta = 'O <b>Caderno V2</b> organiza temas por √°rea. Clique no cabe√ßalho da √°rea para expandir/colapsar. Hot Topics aparecem destacados em laranja.';
            } else if (pergunta.includes('analytics') || pergunta.includes('an√°lise') || pergunta.includes('gr√°fico')) {
                resposta = 'V√° em <b>An√°lises</b> e use os bot√µes de sub-navega√ß√£o para alternar entre Resumo, Gr√°ficos e Hist√≥rico.';
            } else if (pergunta.includes('export') || pergunta.includes('html')) {
                resposta = 'No <b>Caderno</b>, clique no bot√£o <b>üî• Exportar HTML</b> no topo para baixar todos os Hot Topics em um arquivo HTML.';
            }
            
            container.innerHTML = `
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--turquesa-light);">
                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                    <div style="font-size: 14px; color: var(--text-light); line-height: 1.6;">${resposta}</div>
                </div>
            `;
            container.style.display = 'block';
        }
        
        // ==================== EXPORTA√á√ÉO HOT TOPICS HTML ====================
        
        function exportarHotTopicsHTML(areaFiltro = null) {
            // Filtrar anota√ß√µes que t√™m hot topics
            let anotacoesComHotTopics = anotacoes.filter(a => a.hotTopics && a.hotTopics.trim());
            
            if (anotacoesComHotTopics.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum Hot Topic encontrado!', 'error');
                return;
            }
            
            // Aplicar filtro de √°rea se especificado
            if (areaFiltro) {
                anotacoesComHotTopics = anotacoesComHotTopics.filter(a => a.area === areaFiltro);
            }
            
            if (anotacoesComHotTopics.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum Hot Topic para esta √°rea!', 'error');
                return;
            }
            
            // Agrupar por √°rea
            const porArea = {};
            anotacoesComHotTopics.forEach(a => {
                if (!porArea[a.area]) porArea[a.area] = [];
                porArea[a.area].push(a);
            });
            
            // Gerar HTML
            const dataGeracao = new Date().toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Hot Topics TEOT 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 0 auto; }
        header {
            text-align: center;
            padding: 30px 0 40px;
            border-bottom: 2px solid rgba(0, 206, 209, 0.3);
            margin-bottom: 30px;
        }
        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #00FFE0, #FF9F40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .subtitle { color: rgba(0, 206, 209, 0.8); font-size: 14px; }
        .area { margin-bottom: 40px; }
        .area-title {
            color: #00CED1;
            font-size: 20px;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 206, 209, 0.3);
            margin-bottom: 20px;
        }
        .tema {
            background: rgba(20, 35, 45, 0.6);
            border: 1px solid rgba(255, 159, 64, 0.3);
            border-left: 4px solid #FF9F40;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .tema-title {
            color: #FFB84D;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .hot-topics {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.8;
        }
        footer {
            text-align: center;
            padding: 40px 0 20px;
            border-top: 1px solid rgba(0, 206, 209, 0.2);
            margin-top: 40px;
        }
        .footer-text { color: rgba(255, 255, 255, 0.5); font-size: 12px; }
        .footer-logo { color: #00CED1; font-weight: 700; margin-top: 10px; }
        @media print {
            body { background: white; color: black; }
            .tema { border: 1px solid #ccc; break-inside: avoid; }
            .area-title { color: #0d9488; }
            .tema-title { color: #b8701f; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• Hot Topics TEOT 2026</h1>
            <p class="subtitle">Gerado em ${dataGeracao}</p>
        </header>
        
        ${Object.keys(porArea).sort().map(area => `
            <div class="area">
                <h2 class="area-title">üìÅ ${area}</h2>
                ${porArea[area].sort((a, b) => a.tema.localeCompare(b.tema, 'pt-BR')).map(anotacao => `
                    <div class="tema">
                        <div class="tema-title">üìù ${anotacao.tema}</div>
                        <div class="hot-topics">${anotacao.hotTopics.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')}</div>
                    </div>
                `).join('')}
            </div>
        `).join('')}
        
        <footer>
            <p class="footer-text">Documento gerado automaticamente</p>
            <p class="footer-logo">üß† VRVS CIRCUIT TECH</p>
        </footer>
    </div>
</body>
</html>`;
            
            // Download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const nomeArquivo = areaFiltro 
                ? `HOT_TOPICS_${areaFiltro.replace(/\s+/g, '_').toUpperCase()}_${new Date().toISOString().split('T')[0]}.html`
                : `HOT_TOPICS_COMPLETO_${new Date().toISOString().split('T')[0]}.html`;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacaoFeedback(`‚úÖ ${anotacoesComHotTopics.length} Hot Topics exportados!`);
        }
        
        // ==================== EXPORTA√á√ÉO DI√ÅRIO CSV ====================
        
        function exportarDiarioCSV() {
            if (!window.diario || !window.diario.entradas || window.diario.entradas.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma entrada no di√°rio!', 'error');
                return;
            }
            
            const headers = ['id', 'data', 'area', 'tema', 'topico', 'resposta', 'atencao', 'criadoEm', 'ultimaAtualizacao', 'srsAtivo', 'srsProximaRevisao', 'srsRepeticoes', 'srsUltimaResposta'];
            let csv = headers.join(',') + '\n';
            
            window.diario.entradas.forEach(e => {
                // Garantir que SRS est√° inicializado antes de exportar
                if (!e.srs) {
                    inicializarSrsEntrada(e);
                }
                
                const linha = [
                    e.id,
                    e.data,
                    `"${(e.area || '').replace(/"/g, '""')}"`,
                    `"${(e.tema || '').replace(/"/g, '""')}"`,
                    `"${(e.topico || '').replace(/"/g, '""')}"`,
                    `"${(e.resposta || '').replace(/"/g, '""')}"`,
                    e.atencao ? 'true' : 'false',
                    e.criadoEm || '',
                    e.ultimaAtualizacao || '',
                    e.srs ? (e.srs.ativo ? 'true' : 'false') : 'true',
                    e.srs ? (e.srs.proximaRevisao || '') : '',
                    e.srs ? (e.srs.repeticoes || 0) : 0,
                    e.srs ? (e.srs.ultimaResposta || '') : ''
                ];
                csv += linha.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DIARIO_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacaoFeedback('‚úÖ Di√°rio exportado!');
        }
        
        // ==================== INICIALIZA√á√ÉO ATUALIZADA ====================
        
        // Sobrescrever initApp para incluir novas renderiza√ß√µes (se existir)
        if (typeof initApp !== 'undefined') {
            const initAppOriginal = initApp;
            initApp = function() {
                initAppOriginal();
            
                // Renderizar novas abas se estiverem ativas
                setTimeout(() => {
                    if (document.getElementById('analyticsContainer')) {
                        renderAnalytics();
                    }
                    if (document.getElementById('ajudaContainer')) {
                        renderAjuda();
                    }
                    if (document.getElementById('cadernoAreasContainer')) {
                        renderCadernoV2();
                    }
                }, 500);
            };
        }
    </script>
</body>
</html>

