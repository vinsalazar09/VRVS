<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0a1a1f">
<title>ğŸ§  VRVS CIRCUIT TECH â€” v5.1</title>
<style>
/* ====== Base visual compacta (circuit/amber-turquoise) ====== */
*{box-sizing:border-box} html,body{margin:0;background:#0a1a1f;color:#eaf2ff;font-family:-apple-system,BlinkMacSystemFont,'SF Pro',Segoe UI,Roboto,Arial,sans-serif; -webkit-font-smoothing:antialiased}
:root{--turq:#26c6da;--turq2:#80deea;--amber:#ff7f50;--amber2:#ffa366;--ok:#00ffe0;--warn:#ffa366;--bad:#ef4444;--card:#0f1a20;--edge:#1a353d}
.grid{position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(#15313a 1px,transparent 1px),linear-gradient(90deg,#15313a 1px,transparent 1px);background-size:60px 60px;opacity:.28}
.header{position:sticky;top:0;z-index:10;background:#0d1c21cc;backdrop-filter:blur(10px);border-bottom:1px solid #15313a;padding:18px 16px;text-align:center}
.header h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.5px;background:linear-gradient(90deg,#00ffe0,#ffa366);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header small{display:block;color:var(--turq2);opacity:.9}
.tabs{display:flex;gap:10px;overflow-x:auto;padding:12px 14px;border-bottom:1px solid #15313a;background:#0e1b21}
.tab{flex:0 0 auto;padding:10px 14px;border:1px solid #1d3b43;border-radius:10px;background:#0f2027;color:#9ad7e6;font-weight:800;cursor:pointer;white-space:nowrap}
.tab.active{border-color:var(--amber2);color:var(--amber2);background:linear-gradient(135deg,#132b33,#18323a)}
.content{padding:18px}
.section{display:none;animation:.25s ease-out slidein}@keyframes slidein{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.section.active{display:block}
.card{background:linear-gradient(180deg,#0f1a20,#0c161c);border:1px solid var(--edge);border-radius:16px;padding:18px;margin:16px 0;box-shadow:0 4px 24px #0009}
.card h3{margin:0 0 14px;color:var(--turq2)}
input.select,select.input{appearance:none}
.input,.select,.textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #1b3840;background:#0d1c21;color:#eaf2ff;margin:6px 0 14px}
.textarea{min-height:90px;resize:vertical}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;border:0;background:linear-gradient(135deg,#ff7f50,#e55100);color:#fff;font-weight:900;letter-spacing:.5px;cursor:pointer}
.btn.secondary{background:linear-gradient(135deg,#1f434c,#163941)}
.btn.small{padding:8px 10px;font-size:12px}
table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:14px}
th{font-size:11px;text-transform:uppercase;letter-spacing:.6px;text-align:left;color:#86cfe0;border-bottom:1px solid var(--edge);padding:10px 8px}
td{background:#102029;border-top:1px solid #102932;border-bottom:1px solid #102932;padding:10px 8px}
td:first-child{border-left:1px solid #102932;border-top-left-radius:8px;border-bottom-left-radius:8px}
td:last-child{border-right:1px solid #102932;border-top-right-radius:8px;border-bottom-right-radius:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #27444d;background:#0f2229;color:#9ad7e6}
.notice{padding:12px;border-radius:10px;border:1px solid #27444d;background:#0e1f25;margin:10px 0}
.empty{padding:40px;text-align:center;color:#81c6d4}
.statgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.stat{background:#0f2027;border:1px solid #1b3942;border-radius:14px;padding:16px;text-align:center}
.stat .v{font-size:28px;font-weight:900;background:linear-gradient(90deg,#00ffe0,#ffa366);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat .l{font-size:11px;color:#8ed6e4;letter-spacing:1px;text-transform:uppercase}
.task{border:1px solid #27444d;background:#0e1f25;border-radius:14px;padding:14px;margin:10px 0}
.task.p5{box-shadow:0 0 0 1px #ff7f50}
</style>
</head>
<body>
<div class="grid"></div>

<header class="header">
  <h1>VRVS CIRCUIT TECH</h1>
  <small>TEOT 2026 â€¢ v5.1</small>
</header>

<nav class="tabs">
  <button class="tab active" onclick="showSection('dados', this)">ğŸ“Š Dados</button>
  <button class="tab" onclick="showSection('cadastro', this)">â• Cadastro</button>
  <button class="tab" onclick="showSection('feedback', this)">ğŸ“ Feedback</button>
  <button class="tab" onclick="showSection('tarefa', this)">ğŸ“‹ Tarefa</button>
  <button class="tab" onclick="showSection('agenda', this)">ğŸ“… Agenda</button>
  <button class="tab" onclick="showSection('pendencias', this)">ğŸ”” PendÃªncias</button>
  <button class="tab" onclick="showSection('stats', this)">ğŸ“ˆ EstatÃ­sticas</button>
  <button class="tab" onclick="showSection('historico', this)">ğŸ“œ HistÃ³rico</button>
  <button class="tab" onclick="showSection('importar', this)">ğŸ“¥ Importar</button>
  <button class="tab" onclick="showSection('exportar', this)">ğŸ“¤ Exportar</button>
</nav>

<main class="content">
  <!-- DADOS -->
  <section id="dados" class="section active">
    <div class="card">
      <h3>ğŸ“Š Banco de Dados</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>Ãrea</th><th>Tema</th><th>Status</th><th>Prior.</th><th>Rend.</th><th>SessÃµes</th><th>Ãšlt.Estudo</th><th>Agenda</th><th>AÃ§Ãµes</th>
          </tr></thead>
          <tbody id="dadosBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CADASTRO -->
  <section id="cadastro" class="section">
    <div class="card">
      <h3>â• Adicionar Tema</h3>
      <label>Ãrea</label><input id="newArea" class="input" placeholder="Ombro e Cotovelo">
      <label>Tema</label><input id="newTema" class="input" placeholder="Sd manguito rotador">
      <label>Prioridade (1â€“5)</label><input id="newPrior" type="number" min="1" max="5" value="3" class="input">
      <label>Data inicial (opcional)</label><input id="newStart" type="date" class="input">
      <button class="btn" onclick="addTema()">âœ… Adicionar</button>
    </div>
  </section>

  <!-- FEEDBACK (ÃREA â†’ TEMA) -->
  <section id="feedback" class="section">
    <div class="card">
      <h3>ğŸ“ Registrar Performance</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Ãrea</label>
          <select id="fbArea" class="select"></select>
        </div>
        <div>
          <label>Tema</label>
          <select id="fbTema" class="select"><option value="">Selecioneâ€¦</option></select>
        </div>
      </div>
      <label>Data da sessÃ£o</label><input id="fbData" type="date" class="input">
      <label>Performance (%)</label><input id="fbRend" type="number" min="0" max="100" class="input" placeholder="0â€“100">
      <label>DuraÃ§Ã£o (min)</label><input id="fbTempo" type="number" min="0" class="input" placeholder="Minutos">
      <label>Diretriz prÃ³xima sessÃ£o</label><input id="fbSug" class="input" placeholder="Ex: Revisar flashcards + questÃµes">
      <label>Log da sessÃ£o</label><textarea id="fbObs" class="textarea" placeholder="Ex: Q17/20 em 30min | FC8/10 em 15min"></textarea>
      <div style="display:flex;gap:10px">
        <button class="btn" onclick="salvarFB()">ğŸ’¾ Salvar performance</button>
        <button class="btn secondary" onclick="desfazer()">â†©ï¸ Desfazer Ãºltimo</button>
      </div>
      <div id="msg" class="notice" style="display:none"></div>
    </div>
  </section>

  <!-- TAREFA -->
  <section id="tarefa" class="section">
    <div class="card"><h3>ğŸ“‹ MissÃµes do Dia</h3><div id="tarefas"></div></div>
  </section>

  <!-- AGENDA -->
  <section id="agenda" class="section">
    <div class="card"><h3>ğŸ“… Timeline</h3><div id="agendaCt"></div></div>
  </section>

  <!-- PENDÃŠNCIAS -->
  <section id="pendencias" class="section">
    <div class="card"><h3>ğŸ”” Alertas do Sistema</h3><div id="pendCt"></div></div>
  </section>

  <!-- STATS -->
  <section id="stats" class="section">
    <div class="card">
      <h3>ğŸ“Š Analytics</h3>
      <div class="statgrid">
        <div class="stat"><div class="v" id="sTemas">0</div><div class="l">MÃ³dulos ativos</div></div>
        <div class="stat"><div class="v" id="sSessoes">0</div><div class="l">SessÃµes</div></div>
        <div class="stat"><div class="v" id="sRend">0%</div><div class="l">Performance</div></div>
        <div class="stat"><div class="v" id="sTempo">0h</div><div class="l">Tempo</div></div>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“ˆ VisualizaÃ§Ãµes</h3>
      <div style="height:220px;margin:12px 0"><canvas id="cBarras"></canvas></div>
      <div style="height:220px;margin:12px 0"><canvas id="cLinha"></canvas></div>
      <div style="height:280px;margin:12px 0"><canvas id="cRadar"></canvas></div>
    </div>
  </section>

  <!-- HISTÃ“RICO -->
  <section id="historico" class="section">
    <div class="card">
      <h3>ğŸ“œ Registro Completo</h3>
      <div class="notice">Registros antigos sem data nÃ£o quebram nada; corrija pelo CSV se quiser e reimporte.</div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Data</th><th>Tema</th><th>Ãrea</th><th>Rend.</th><th>Tempo</th><th>ObservaÃ§Ãµes</th><th>SugestÃ£o</th></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- IMPORTAR/EXPORTAR -->
  <section id="importar" class="section">
    <div class="card">
      <h3>ğŸ“¥ Importar</h3>
      <label>DADOS.csv</label><input id="fDados" type="file" class="input" accept=".csv">
      <label>HISTORICO.csv</label><input id="fHist" type="file" class="input" accept=".csv">
      <button class="btn" onclick="importar()">ğŸ“¥ Processar importaÃ§Ã£o</button>
      <button class="btn secondary" onclick="resetAll()">ğŸ—‘ï¸ Reset completo</button>
    </div>
  </section>

  <section id="exportar" class="section">
    <div class="card">
      <h3>ğŸ“¤ Backup</h3>
      <button class="btn secondary" onclick="expDados()">Baixar DADOS.csv</button>
      <button class="btn secondary" onclick="expHist()">Baixar HISTORICO.csv</button>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== NavegaÃ§Ã£o (sem depender de event global) ===== */
function showSection(id, el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if (el) el.classList.add('active');
}

/* ===== Estado ===== */
let dados = JSON.parse(localStorage.getItem('vrvs_dados')||'[]');
let historico = JSON.parse(localStorage.getItem('vrvs_historico')||'[]');

/* ===== Utils ===== */
const norm = s => String(s||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
function normalizeArea(raw){
  const a = norm(raw);
  const map = {
    'trauma mmss':'Trauma MMSS','trauma membros superiores':'Trauma MMSS',
    'trauma mmii':'Trauma MMII','trauma membros inferiores':'Trauma MMII',
    'ombro':'Ombro e Cotovelo','cotovelo':'Ombro e Cotovelo','ombro e cotovelo':'Ombro e Cotovelo',
    'mao':'MÃ£o','punho':'MÃ£o','pe e tornozelo':'PÃ© e Tornozelo','tornozelo':'PÃ© e Tornozelo','pe':'PÃ© e Tornozelo',
    'quadril':'Quadril','pelve':'Quadril','coluna':'Coluna','oncologia':'Oncologia','tumores':'Oncologia'
  };
  return map[a] || a.replace(/\b\w/g,m=>m.toUpperCase());
}
function msg(txt,err=false){const m=document.getElementById('msg');m.style.display='block';m.textContent=txt;m.style.borderColor=err?'#ff7f50':'#27444d';setTimeout(()=>m.style.display='none',4000)}

/* ===== Paleta de cores por Ã¡rea (persistente) ===== */
const PALETTE = ["#00FFE0","#FFA366","#00B3FF","#FFD166","#A78BFA","#34D399","#F472B6","#F59E0B","#22D3EE","#EF4444","#C084FC","#10B981"];
let areaColors = JSON.parse(localStorage.getItem('vrvs_area_colors')||'{}');
function colorFor(area){
  if(!areaColors[area]){
    const used = Object.values(areaColors);
    const next = PALETTE.find(c=>!used.includes(c)) || PALETTE[used.length % PALETTE.length];
    areaColors[area]=next;
    localStorage.setItem('vrvs_area_colors', JSON.stringify(areaColors));
  }
  return areaColors[area];
}
function ensureColors(){
  const set = new Set(); dados.forEach(t=>set.add(t.area)); historico.forEach(h=>set.add(h.area));
  [...set].filter(Boolean).forEach(a=>colorFor(a));
}

/* ===== RenderizaÃ§Ãµes ===== */
function renderDados(){
  const tb=document.getElementById('dadosBody');
  tb.innerHTML = dados.map(t=>{
    const r = Math.round((t.rendimento||0)*100);
    const rc = r>=80?'var(--ok)':r>=50?'var(--warn)':'var(--bad)';
    const u = t.ultEstudo? new Date(t.ultEstudo+'T00:00:00').toLocaleDateString('pt-BR'):'-';
    const a = t.agenda? new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR'):'-';
    return `<tr>
      <td style="color:${colorFor(t.area)}">${t.area||'-'}</td>
      <td style="color:var(--amber2);font-weight:800">${t.tema||'-'}</td>
      <td>${t.status||'Planejado'}</td>
      <td style="text-align:center">${t.prioridade||3}</td>
      <td style="text-align:center;color:${rc}">${t.rendimento? r+'%':'-'}</td>
      <td style="text-align:center">${t.sessoes||0}</td>
      <td style="text-align:center">${u}</td>
      <td style="text-align:center">${a}</td>
      <td><span class="badge">ID ${t.id}</span></td>
    </tr>`;
  }).join('');
}

function calcProx(tema){
  if((tema.sessoes||0)===1){ const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().split('T')[0]; }
  const r = Math.round((tema.rendimento||0)*100);
  const p = parseInt(tema.prioridade)||3;
  const c80 = parseInt(tema.contador80)||0;
  let dias=1;
  if(r<50) dias=1; else if(r<80) dias=3; else { dias=[7,14,30,60][Math.min(c80,3)]; if(p===5 && dias>30) dias=30; }
  const d=new Date(); d.setDate(d.getDate()+dias); return d.toISOString().split('T')[0];
}

function renderTarefas(){
  const hoje = new Date().toISOString().split('T')[0];
  const arr = dados.filter(t=>t.agenda && t.agenda<=hoje && ['Em estudo','Planejado'].includes(t.status))
                   .sort((a,b)=>a.agenda.localeCompare(b.agenda)||(b.prioridade||0)-(a.prioridade||0));
  const ct=document.getElementById('tarefas');
  if(!arr.length){ ct.innerHTML='<div class="empty">Nenhuma missÃ£o pendente</div>'; return; }
  ct.innerHTML = arr.map(t=>{
    const r=Math.round((t.rendimento||0)*100), col = r>=80?'var(--ok)':r>=50?'var(--warn)':'var(--bad)';
    return `<div class="task p${t.prioridade||3}">
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div style="font-weight:900;color:var(--amber2)">${t.tema}</div>
        <div class="badge">${new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR')}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <span class="badge" style="border-color:${colorFor(t.area)};color:${colorFor(t.area)}">${t.area}</span>
        <span class="badge">â­ ${t.prioridade||3}</span>
        <span class="badge" style="color:${col}">${r}%</span>
        <span class="badge">â± ${t.sessoes||0} sessÃµes</span>
      </div>
      ${t.sugestao? `<div class="notice" style="border-color:${colorFor(t.area)}">ğŸ’¡ ${t.sugestao}</div>`:''}
    </div>`;
  }).join('');
}

function renderAgenda(){
  const hoje = new Date().toISOString().split('T')[0];
  const arr = dados.filter(t=>t.agenda && t.agenda>=hoje && t.status!=='ConcluÃ­do')
                   .sort((a,b)=>a.agenda.localeCompare(b.agenda));
  const ct=document.getElementById('agendaCt');
  ct.innerHTML = arr.length? arr.map(t=>`
    <div class="task">
      <div style="display:flex;justify-content:space-between">
        <div style="font-weight:900;color:var(--amber2)">${t.tema}</div>
        <div class="badge">${new Date(t.agenda+'T00:00:00').toLocaleDateString('pt-BR')}</div>
      </div>
      <div class="badge" style="border-color:${colorFor(t.area)};color:${colorFor(t.area)}">${t.area}</div>
    </div>`).join('') : '<div class="empty">Timeline vazia</div>';
}

function renderPend(){
  const hoje=new Date().toISOString().split('T')[0];
  const atrasadas = dados.filter(t=>t.agenda && (new Date(hoje)-new Date(t.agenda) > 7*24*3600*1000));
  const semData = historico.filter(h=>!h.data || h.data==='-').length;
  let out='';
  if(atrasadas.length) out += `<div class="notice">âš ï¸ ${atrasadas.length} mÃ³dulos em atraso crÃ­tico<br>${atrasadas.map(t=>'â€¢ '+t.tema).join('<br>')}</div>`;
  if(semData) out += `<div class="notice">ğŸ“… ${semData} registros antigos sem data (ok manter assim se nÃ£o quiser editar).</div>`;
  if(!out) out='<div class="empty">Sistema operacional</div>';
  document.getElementById('pendCt').innerHTML = out;
}

function renderHist(){
  const tb=document.getElementById('histBody');
  const arr=[...historico].sort((a,b)=>{
    if(!a.data||a.data==='-') return 1;
    if(!b.data||b.data==='-') return -1;
    return new Date(b.data)-new Date(a.data);
  });
  tb.innerHTML = arr.map(h=>{
    const r=Math.round((h.rendimento||0)*100);
    const col = r>=80?'var(--ok)':r>=50?'var(--warn)':'var(--bad)';
    return `<tr>
      <td style="font-size:12px;color:${h.data&&h.data!=='-'?'#8ed6e4':'#ef4444'}">${h.data? new Date(h.data+'T00:00:00').toLocaleDateString('pt-BR'):'-'}</td>
      <td style="color:var(--amber2);font-weight:800">${h.tema||'-'}</td>
      <td style="color:${colorFor(h.area)}">${h.area||'-'}</td>
      <td style="text-align:center;color:${col}">${h.rendimento? r+'%':'-'}</td>
      <td style="text-align:center">${h.tempo? h.tempo+' min':'-'}</td>
      <td>${h.observacoes||'-'}</td>
      <td>${h.sugestao||'-'}</td>
    </tr>`;
  }).join('');
}

/* ===== GrÃ¡ficos ===== */
let gBar=null,gLine=null,gRad=null;
function updateCharts(){
  if(!window.Chart) return;
  ensureColors();

  // MÃ©dia por Ã¡rea
  const agg={};
  historico.forEach(h=>{
    if(!h.area || !h.rendimento) return;
    const a = normalizeArea(h.area);
    if(!agg[a]) agg[a]={s:0,c:0}; agg[a].s += h.rendimento*100; agg[a].c++;
  });
  const labels = Object.keys(agg);
  const medias = labels.map(a=>Math.round(agg[a].s/agg[a].c));
  const cols = labels.map(colorFor);

  const ctxB=document.getElementById('cBarras'); if(gBar) gBar.destroy();
  gBar = new Chart(ctxB,{type:'bar',data:{labels,datasets:[{data:medias,backgroundColor:cols,borderColor:cols}]} ,options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}});

  // EvoluÃ§Ã£o por Ã¡rea
  const series = {};
  historico.forEach(h=>{
    const a = normalizeArea(h.area); if(!a) return;
    (series[a]||(series[a]=[])).push((h.rendimento||0)*100);
  });
  const ds = Object.entries(series).map(([a,vals])=>({label:a,data:vals.map((v,i)=>({x:i+1,y:v})),borderColor:colorFor(a),backgroundColor:colorFor(a)+'33',tension:.3}));
  const ctxL=document.getElementById('cLinha'); if(gLine) gLine.destroy();
  gLine = new Chart(ctxL,{type:'line',data:{datasets:ds},options:{scales:{x:{type:'linear',ticks:{stepSize:1}},y:{beginAtZero:true,max:100}}}});

  // Radar (mesmas mÃ©dias)
  const ctxR=document.getElementById('cRadar'); if(gRad) gRad.destroy();
  gRad = new Chart(ctxR,{type:'radar',data:{labels,datasets:[{label:'MÃ©dia',data:medias,borderColor:'#00ffe0',backgroundColor:'#00ffe033'}]},options:{scales:{r:{beginAtZero:true,max:100}}}});
}

/* ===== Stats ===== */
function updateStats(){
  document.getElementById('sTemas').textContent = dados.length;
  document.getElementById('sSessoes').textContent = historico.length;
  const rm = historico.length ? Math.round(100*historico.reduce((s,h)=>s+(h.rendimento||0),0)/historico.length) : 0;
  document.getElementById('sRend').textContent = rm + '%';
  const min = historico.reduce((s,h)=>s+(h.tempo||0),0);
  document.getElementById('sTempo').textContent = Math.round(min/60)+'h';
  updateCharts();
}

/* ===== Feedback (Ãrea â†’ Tema) ===== */
function fillAreaTema(){
  const fbA = document.getElementById('fbArea');
  const fbT = document.getElementById('fbTema');
  const areas = [...new Set(dados.map(t=>t.area))].filter(Boolean).sort();
  fbA.innerHTML = '<option value="">Selecioneâ€¦</option>'+areas.map(a=>`<option>${a}</option>`).join('');
  fbT.innerHTML = '<option value="">Selecioneâ€¦</option>';
  fbA.onchange = () => {
    const a = fbA.value;
    const temas = dados.filter(t=>t.area===a).map(t=>({id:t.id,tema:t.tema}));
    fbT.innerHTML = '<option value="">Selecioneâ€¦</option>'+temas.map(t=>`<option value="${t.id}">${t.tema}</option>`).join('');
  };
}

function salvarFB(){
  const area = document.getElementById('fbArea').value;
  const temaId = document.getElementById('fbTema').value;
  const data = document.getElementById('fbData').value;
  const rend = parseInt(document.getElementById('fbRend').value||'0');
  const tempo = parseInt(document.getElementById('fbTempo').value||'0');
  const sug = document.getElementById('fbSug').value.trim();
  const obs = document.getElementById('fbObs').value.trim();
  const tema = dados.find(t=>String(t.id)===String(temaId) && t.area===area);
  if(!tema){ msg('Selecione Ã¡rea e tema vÃ¡lidos', true); return; }

  tema.contador80 = (rend>=80)? (parseInt(tema.contador80)||0)+1 : 0;
  tema.rendimento = rend/100;
  tema.sessoes = (tema.sessoes||0)+1;
  tema.ultEstudo = data;
  tema.agenda = calcProx(tema);
  tema.tempo = (tema.tempo||0)+tempo;
  tema.status = tema.sessoes===1?'Em estudo':tema.status;
  if (sug) tema.sugestao = sug;

  const linhaObs = `${data}: ${obs||''}${sug? (obs?' | ':'')+'SugestÃ£o: '+sug:''}`;
  if (obs || sug) tema.observacoes = tema.observacoes ? (tema.observacoes+'\n'+linhaObs) : linhaObs;

  historico.push({id:Date.now(),temaId:tema.id,area:tema.area,tema:tema.tema,rendimento:rend/100,tempo:tempo,data:data,observacoes:obs||'-',sugestao:sug||'-'});

  localStorage.setItem('vrvs_dados', JSON.stringify(dados));
  localStorage.setItem('vrvs_historico', JSON.stringify(historico));

  msg(`âœ… Performance registrada. PrÃ³xima revisÃ£o: ${new Date(tema.agenda+'T00:00:00').toLocaleDateString('pt-BR')}`);
  renderDados(); renderTarefas(); renderAgenda(); renderHist(); renderPend(); updateStats(); fillAreaTema();
  document.getElementById('fbRend').value=''; document.getElementById('fbTempo').value=''; document.getElementById('fbSug').value=''; document.getElementById('fbObs').value='';
}

function desfazer(){
  if(!historico.length){ msg('Nada para desfazer', true); return; }
  const u = historico.pop();
  const tema = dados.find(t=>String(t.id)===String(u.temaId));
  if(tema){
    tema.sessoes=Math.max(0,(tema.sessoes||1)-1);
    tema.tempo=Math.max(0,(tema.tempo||0)-(u.tempo||0));
    const rem=historico.filter(h=>String(h.temaId)===String(tema.id));
    if(rem.length){
      tema.rendimento = rem.reduce((s,h)=>s+(h.rendimento||0),0)/rem.length;
      let c=0; for(let i=rem.length-1;i>=0;i--){ if((rem[i].rendimento||0)>=0.8) c++; else break; } tema.contador80=c;
      tema.ultEstudo = rem[rem.length-1].data; tema.agenda = calcProx(tema);
    } else { tema.rendimento=0; tema.status='Planejado'; tema.ultEstudo=''; tema.agenda=''; tema.contador80=0; }
    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
  }
  localStorage.setItem('vrvs_historico', JSON.stringify(historico));
  msg('âœ… ReversÃ£o executada');
  renderDados(); renderTarefas(); renderAgenda(); renderHist(); renderPend(); updateStats(); fillAreaTema();
}

/* ===== Import/Export ===== */
function parseCSVText(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const rows=[], row=[]; let cell='', i=0, inQ=false;
  while(i<text.length){
    const ch=text[i];
    if(inQ){ if(ch=='"'){ if(text[i+1]=='"'){cell+='"';i+=2}else{inQ=false;i++} } else {cell+=ch;i++} }
    else { if(ch=='"'){inQ=true;i++}
      else if(ch==','){ row.push(cell); cell=''; i++; }
      else if(ch=='\r'){ row.push(cell); rows.push([...row]); row.length=0; cell=''; if(text[i+1]=='\n') i+=2; else i++; }
      else if(ch=='\n'){ row.push(cell); rows.push([...row]); row.length=0; cell=''; i++; }
      else { cell+=ch; i++; } }
  }
  row.push(cell); rows.push([...row]); return rows;
}
function parseCSV(file){
  return new Promise((res,rej)=>{
    const r=new FileReader(); r.onerror=()=>rej(new Error('Falha leitura'));
    r.onload=e=>{
      try{
        const rows=parseCSVText(e.target.result); if(rows.length<2) throw new Error('CSV vazio');
        const headers=rows[0].map(h=>norm(h).replace(/[().\s]/g,'')); const map={}; headers.forEach((h,i)=>map[h]=i);
        const get=(r,...names)=>{ for(const n of names){ const i=map[n]; if(i!=null && r[i]!==undefined) return String(r[i]); } return ''; };
        const out = rows.slice(1).map((r,idx)=>{
          const rendStr=get(r,'rendimento','rend').replace('%','').replace(',','.');
          const tempoStr=get(r,'tempomin','tempo');
          const obj={
            id:get(r,'id')||`${Date.now()}_${idx}`,
            area:normalizeArea(get(r,'area','topico')),
            tema:get(r,'tema','assunto','titulo'),
            status:get(r,'status','estado')||'Planejado',
            prioridade:parseInt(get(r,'prioridade','prior'))||3,
            dificuldade:get(r,'dificuldade','dific')||'MÃ©dia',
            rendimento: (()=>{ const v=parseFloat(rendStr); if(isNaN(v)) return 0; return v>1? v/100:v; })(),
            sessoes:parseInt(get(r,'sessoes','sessao'))||0,
            ultEstudo:get(r,'ultestudo','ultest','ultimoestudo','ultimo_estudo'),
            agenda:get(r,'dataagenda','agenda','data_agenda'),
            tempo:parseInt(tempoStr)||0,
            observacoes:get(r,'observacoes','obs','observacao'),
            contador80:parseInt(get(r,'contador80'))||0,
            sugestao:get(r,'sugestao','sugestoes')||'',
            data:get(r,'data'), temaId:get(r,'temaid')
          };
          return obj.tema? obj:null;
        }).filter(Boolean);
        res(out);
      }catch(err){ rej(err); }
    };
    r.readAsText(file,'UTF-8');
  });
}
async function importar(){
  const fD=document.getElementById('fDados').files[0];
  const fH=document.getElementById('fHist').files[0];
  if(!fD && !fH){ msg('Selecione um CSV',true); return; }
  try{
    if(fD){ dados = await parseCSV(fD); localStorage.setItem('vrvs_dados', JSON.stringify(dados)); }
    if(fH){ historico = await parseCSV(fH); localStorage.setItem('vrvs_historico', JSON.stringify(historico)); }
    ensureColors(); renderDados(); renderTarefas(); renderAgenda(); renderHist(); renderPend(); updateStats(); fillAreaTema(); msg('âœ… ImportaÃ§Ã£o concluÃ­da');
  }catch(e){ msg('Erro: '+e.message,true); }
}
function toCSV(arr){
  if(!arr.length) return '';
  const headers = Object.keys(arr[0]);
  const body = arr.map(o=>headers.map(h=>{ const v=o[h]??''; const s=String(v).replace(/"/g,'""'); return (s.includes(',')||s.includes('\n'))?`"${s}"`:s; }).join(','));
  return [headers.join(','),...body].join('\n');
}
function expDados(){ const csv=toCSV(dados); download(csv,`VRVS_DADOS_${new Date().toISOString().slice(0,10)}.csv`); }
function expHist(){ const csv=toCSV(historico); download(csv,`VRVS_HISTORICO_${new Date().toISOString().slice(0,10)}.csv`); }
function download(csv,name){ const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
function resetAll(){
  if(confirm('Apagar TODOS os dados?') && confirm('Confirma?')){
    localStorage.removeItem('vrvs_dados'); localStorage.removeItem('vrvs_historico'); localStorage.removeItem('vrvs_area_colors');
    dados=[]; historico=[]; areaColors={}; renderDados(); renderTarefas(); renderAgenda(); renderHist(); renderPend(); updateStats(); fillAreaTema(); msg('ğŸ—‘ï¸ Reset completo');
  }
}

/* ===== Boot ===== */
document.getElementById('fbData').value = new Date().toISOString().slice(0,10);
ensureColors(); renderDados(); renderTarefas(); renderAgenda(); renderPend(); renderHist(); updateStats(); fillAreaTema();
if(!window.Chart){ console.warn('Chart.js indisponÃ­vel â€” grÃ¡ficos ocultos para evitar erro.'); }
</script>
</body>
</html>
