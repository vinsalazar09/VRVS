<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- S3H: Auto-reload quando SW troca controller (ANTES de qualquer JS que possa quebrar) -->
    <script>
        (function(){
            try {
                if (!('serviceWorker' in navigator)) return;
                var reloaded = false;
                navigator.serviceWorker.addEventListener('controllerchange', function(){
                    if (reloaded) return;
                    reloaded = true;
                    window.location.reload();
                });
            } catch(e) {}
        })();
    </script>
    <!-- S3I: Inicializar vari√°veis globais ANTES de qualquer c√≥digo (evita TDZ) -->
    <script>
        (function(){
            window.vistaAnalytics = window.vistaAnalytics ?? 'resumo';
            window.vistaAgenda = window.vistaAgenda ?? 'timeline';
            window.vistaAjuda = window.vistaAjuda ?? 'tutorial';
        })();
    </script>
    <script>
        // RESCUE: Kill-switch anti-overlay fantasma (executar o mais cedo poss√≠vel)
        ;(function vrvs_rescue_killOverlays(){
            try{
                const ids = ['diario-viewer-overlay-pergunta','diario-viewer-overlay'];
                ids.forEach(id => { const el = document.getElementById(id); if(el) el.remove(); });
                document.querySelectorAll('[id^="diario-viewer-overlay"]').forEach(el => el.remove());
            }catch(e){}
        })();
        
        // S3B: QUOTA GUARD + PARSE GUARD ‚Äî Detec√ß√£o precoce ANTES de qualquer setItem
        (function() {
            // Helper para detectar QuotaExceededError
            function isQuotaExceeded(e) {
                if (!e) return false;
                return e.name === 'QuotaExceededError' || 
                       e.code === 22 || 
                       (e.message && e.message.toLowerCase().includes('quota'));
            }
            
            // Helper para abortar boot e mostrar erro no splash
            function abortBoot(reason, displayText) {
                window.__vrvsBootAbort = true;
                window.__vrvsBootAbortReason = reason;
                window.__vrvsBootAbortDisplay = displayText || reason;
                
                // S3B FIX: Declarar reasonParam antes do setTimeout para escopo correto
                const reasonParam = reason.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                
                // Centralizar escrita do splash via updateSplashDebugLine (evita vazamento de CACHE_NAME)
                bootStepMemory = 'ABORT';
                bootErrMemory = sanitizeBootErr(window.__vrvsBootAbortDisplay || 'ABORT');
                
                // Registrar listener DOMContentLoaded ANTES de abortar
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        try {
                            // Mostrar marcador no splash
                            const marker = document.getElementById('bootMarkerQuota');
                            if (marker) {
                                marker.style.display = 'block';
                                marker.textContent = 'ERR: ' + sanitizeBootErr(window.__vrvsBootAbortDisplay) + ' ‚Üí Recovery';
                            }
                            // Atualizar splashDebugLine via fun√ß√£o centralizada
                            // REMOVIDO: Linhas de debug removidas do splash
                            // updateSplashDebugLine();
                        } catch(_) {}
                    });
                } else {
                    // DOM j√° carregado, atualizar imediatamente
                    try {
                        const marker = document.getElementById('bootMarkerQuota');
                        if (marker) {
                            marker.style.display = 'block';
                            marker.textContent = 'ERR: ' + sanitizeBootErr(window.__vrvsBootAbortDisplay) + ' ‚Üí Recovery';
                        }
                        // Atualizar splashDebugLine via fun√ß√£o centralizada
                        // REMOVIDO: Linhas de debug removidas do splash
                        // updateSplashDebugLine();
                    } catch(_) {}
                }
                
                // Redirecionar ap√≥s delay
                setTimeout(function() {
                    try {
                        location.replace('./recover.html?mode=storage&reason=' + reasonParam);
                    } catch(_) {
                        window.location.href = './recover.html?mode=storage&reason=' + reasonParam;
                    }
                }, 200);
            }
            
            // Helper para parse seguro com limite de tamanho
            function safeParseLS(key, fallback, maxBytes) {
                maxBytes = maxBytes || (4 * 1024 * 1024); // Default 4MB
                
                try {
                    const raw = localStorage.getItem(key);
                    if (raw === null) return fallback;
                    
                    // Verificar tamanho antes de parsear
                    const sizeBytes = raw.length * 2; // UTF-16: 2 bytes por char
                    if (sizeBytes > maxBytes) {
                        abortBoot('TOO_BIG:' + key, 'STORAGE');
                        throw new Error('TOO_BIG:' + key);
                    }
                    
                    // Tentar parsear
                    try {
                        return JSON.parse(raw);
                    } catch(parseErr) {
                        abortBoot('PARSE_FAIL:' + key, 'PARSE');
                        throw parseErr;
                    }
                } catch(e) {
                    // Se j√° abortou, re-lan√ßar
                    if (window.__vrvsBootAbort) throw e;
                    // Caso contr√°rio, retornar fallback
                    return fallback;
                }
            }
            
            // Teste de quota no boot mais precoce poss√≠vel (ANTES de qualquer setItem)
            try {
                localStorage.setItem('__vrvs_quota_test', '1');
                localStorage.removeItem('__vrvs_quota_test');
            } catch(e) {
                if (isQuotaExceeded(e)) {
                    abortBoot('QUOTA', 'QUOTA');
                    throw new Error('QUOTA_EXCEEDED: localStorage cheio. Redirecionando para recovery.');
                }
            }
            
            // S3B FIX: Expor helpers globalmente para uso no c√≥digo principal
            window.isQuotaExceeded = isQuotaExceeded;
            window.safeParseLS = safeParseLS;
            window.abortBoot = abortBoot;
        })();
        
        // S3A: BOOT TRACE + ERRO VIS√çVEL (sempre ativo)
        (function() {
            // Flag para evitar loop quando localStorage est√° cheio
            let localStorageQuotaExceeded = false;
            let bootStepMemory = '?';
            let bootErrMemory = '‚Äî';
            
            // Helpers para boot trace (protegidos contra QuotaExceededError)
            function setBootStep(n) {
                bootStepMemory = String(n);
                if (localStorageQuotaExceeded) {
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                    return;
                }
                try {
                    localStorage.setItem('vrvs_last_boot_step', String(n));
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                } catch(e) {
                    if (e.name === 'QuotaExceededError' || e.message && e.message.includes('quota')) {
                        localStorageQuotaExceeded = true;
                    }
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                }
            }
            
            // S3J: Helper para formatar erro com stack trace e localiza√ß√£o
            function fmtErr(e) {
                try {
                    const msg = (e && (e.message || e.reason)) ? String(e.message || e.reason) : String(e);
                    const stack = e && e.stack ? String(e.stack) : '';
                    
                    // Extrair primeira ocorr√™ncia de ":<linha>:<col>" do stack para index.html ou sw.js
                    let loc = '';
                    const m = stack.match(/(index\.html|sw\.js|\/VRVS\/index\.html|\/VRVS\/sw\.js)[^\n]*:(\d+):(\d+)/);
                    if (m) loc = ` @ ${m[1]}:${m[2]}:${m[3]}`;
                    
                    // Se n√£o encontrou no stack, tentar propriedades do evento
                    if (!loc && e) {
                        const source = e.filename || e.sourceURL || '';
                        const line = e.lineno || e.line || '';
                        const col = e.colno || e.column || '';
                        if (source && line) loc = ` @ ${source}:${line}:${col}`;
                    }
                    
                    // Retornar mensagem formatada com stack truncado
                    const stackShort = stack ? stack.substring(0, 300) : '';
                    return { msg, stack, loc, stackShort };
                } catch(_) {
                    return { msg: String(e), stack: '', loc: '', stackShort: '' };
                }
            }
            
            // Sanitiza√ß√£o de erro para evitar vazamento de CACHE_NAME no splash
            function sanitizeBootErr(v) {
                const s = String(v || '').trim();
                if (!s) return '‚Äî';
                // se vazou cache name / marcador de cache, reduzir:
                if (s.includes('vrvs-v') || s.includes('CACHE:') || s.includes('CACHE_NAME')) return 'CACHE';
                // tamb√©m evitar strings muito longas no splash:
                return s.length > 40 ? s.slice(0, 40) + '‚Ä¶' : s;
            }
            
            function setBootErr(msgOrError) {
                // S3J: Aceitar string ou objeto Error
                let msgShort, stackInfo = '';
                if (msgOrError && typeof msgOrError === 'object' && (msgOrError.message || msgOrError.stack)) {
                    const fmt = fmtErr(msgOrError);
                    msgShort = fmt.msg + fmt.loc;
                    if (fmt.stackShort) stackInfo = ' | STK: ' + fmt.stackShort;
                } else {
                    msgShort = String(msgOrError);
                }
                msgShort = msgShort.substring(0, 180);
                if (stackInfo) msgShort += stackInfo.substring(0, 200);
                
                // S3Q: NUNCA salvar CACHE_NAME como erro (filtro antes de salvar)
                if (msgShort && typeof msgShort === 'string' && 
                    (msgShort.includes('vrvs-v5.3') || msgShort.includes('CACHE:') || 
                     msgShort.includes('vrvs-v') || msgShort.includes('backup-quota-safe') ||
                     msgShort.includes('s3q-backup-quota-safe'))) {
                    console.warn('[BOOT ERR] Ignorando erro que cont√©m CACHE_NAME:', msgShort);
                    bootErrMemory = '‚Äî';
                    // Limpar do localStorage se existir
                    try {
                        localStorage.removeItem('vrvs_last_boot_err');
                    } catch(_) {}
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                    return;
                }
                
                // Sanitizar antes de salvar (evita vazamento de CACHE_NAME)
                bootErrMemory = sanitizeBootErr(msgShort);
                if (localStorageQuotaExceeded) {
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                    return;
                }
                try {
                    localStorage.setItem('vrvs_last_boot_err', bootErrMemory);
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                } catch(e) {
                    if (e.name === 'QuotaExceededError' || e.message && e.message.includes('quota')) {
                        localStorageQuotaExceeded = true;
                    }
                    // REMOVIDO: Linhas de debug removidas do splash
                    // updateSplashDebugLine();
                }
            }
            
            function updateSplashDebugLine() {
                try {
                    const el = document.getElementById('splashDebugLine');
                    if (!el) return;
                    let step = bootStepMemory;
                    let err = bootErrMemory;
                    
                    // S3Q: Validar que err n√£o seja CACHE_NAME (bug cosm√©tico)
                    if (err && (err.includes('vrvs-v5.3') || err.includes('CACHE:') || err.includes('vrvs-v'))) {
                        err = '‚Äî';
                        bootErrMemory = '‚Äî';
                    }
                    
                    // S3L: Se app j√° iniciou com sucesso, n√£o mostrar erro stale
                    const appIniciado = document.body && !document.body.classList.contains('splash-loading');
                    if (appIniciado && err !== '‚Äî' && err !== '') {
                        // App iniciou OK, limpar erro stale
                        err = '‚Äî';
                        bootErrMemory = '‚Äî';
                        try {
                            localStorage.removeItem('vrvs_last_boot_err');
                        } catch(_) {}
                    }
                    if (!localStorageQuotaExceeded) {
                        try {
                            step = localStorage.getItem('vrvs_last_boot_step') || bootStepMemory;
                            // S3L: S√≥ ler de localStorage se app ainda n√£o iniciou
                            if (!appIniciado) {
                                const errFromLS = localStorage.getItem('vrvs_last_boot_err') || bootErrMemory;
                                // Sanitizar valor do localStorage (corrige valores antigos com CACHE_NAME)
                                if (errFromLS && typeof errFromLS === 'string' && errFromLS !== '‚Äî' && errFromLS !== '') {
                                    err = sanitizeBootErr(errFromLS);
                                } else {
                                    err = bootErrMemory;
                                }
                            }
                        } catch(e) {
                            if (e.name === 'QuotaExceededError' || e.message && e.message.includes('quota')) {
                                localStorageQuotaExceeded = true;
                            }
                        }
                    }
                    // S3Q: Garantir que err nunca seja CACHE_NAME (valida√ß√£o final antes de renderizar)
                    const finalErr = (err && typeof err === 'string' && (err.includes('vrvs-v5.3') || err.includes('CACHE:') || err.includes('vrvs-v') || err.includes('backup-quota-safe'))) ? '‚Äî' : err;
                    el.textContent = 'BOOT: ' + step + ' | ERR: ' + finalErr;
                } catch(e) {}
            }
            
            // Handlers de erro globais (protegidos contra QuotaExceededError)
            window.addEventListener('error', function(e) {
                if (e.error && (e.error.name === 'QuotaExceededError' || (e.error.message && e.error.message.includes('quota')))) {
                    // S3M FIX: Chamar abortBoot ao inv√©s de apenas mostrar erro
                    if (typeof window.abortBoot === 'function') {
                        window.abortBoot('QUOTA', 'QUOTA');
                    } else {
                        bootErrMemory = 'QUOTA_EXCEEDED: localStorage cheio';
                        // REMOVIDO: Linhas de debug removidas do splash
                        // updateSplashDebugLine();
                    }
                    return;
                }
                // S3J: Passar objeto Error completo com prefixo JS e stack
                const err = e.error || e;
                setBootErr({ 
                    message: 'JS: ' + (err.message || String(err)), 
                    stack: err.stack || '', 
                    filename: e.filename, 
                    lineno: e.lineno, 
                    colno: e.colno 
                });
            });
            
            window.addEventListener('unhandledrejection', function(e) {
                if (e.reason && (e.reason.name === 'QuotaExceededError' || (e.reason.message && e.reason.message.includes('quota')))) {
                    // S3M FIX: Chamar abortBoot ao inv√©s de apenas mostrar erro
                    if (typeof window.abortBoot === 'function') {
                        window.abortBoot('QUOTA', 'QUOTA');
                    } else {
                        bootErrMemory = 'QUOTA_EXCEEDED: localStorage cheio';
                        // REMOVIDO: Linhas de debug removidas do splash
                        // updateSplashDebugLine();
                    }
                    return;
                }
                // S3O: N√ÉO abortar boot por erro de SW update (iOS conflito de scriptURL)
                const errMsg = String(e.reason?.message || e.reason || '');
                if (errMsg.includes('Cannot update a service worker') || 
                    errMsg.includes('different SCRIPT URL') ||
                    errMsg.includes('script URL')) {
                    // Apenas logar, n√£o abortar boot
                    console.warn('[SW] Erro de update ignorado (conflito scriptURL):', errMsg);
                    return; // N√£o chamar setBootErr para este erro espec√≠fico
                }
                // S3J: Passar objeto Error completo com prefixo PROMISE e stack
                const err = e.reason || e;
                setBootErr({ 
                    message: 'PROMISE: ' + (err.message || String(err)), 
                    stack: err.stack || '' 
                });
            });
            
            // Updater peri√≥dico para #splashDebugLine
            // REMOVIDO: Linhas de debug removidas do splash
            // setInterval(updateSplashDebugLine, 500);
            
            // Airbag final (8s)
            setTimeout(function() {
                try {
                    const splash = document.getElementById('splashScreen');
                    const body = document.body;
                    if (splash && !splash.classList.contains('hidden')) {
                        setBootErr('BOOT_TIMEOUT');
                        splash.classList.add('fade-out');
                        if (body) body.classList.remove('splash-loading');
                        setTimeout(function() {
                            if (splash) splash.classList.add('hidden');
                        }, 800);
                    }
                } catch(e) {}
            }, 8000);
            
            // Marca√ß√£o inicial
            setBootStep(1);
        })();
        
        // VRVS DEBUG MODE ‚Äî Desligado por padr√£o em produ√ß√£o
        const VRVS_DEBUG = false;
        
        if (VRVS_DEBUG) {
            /* VRVS BOOT DIAG ‚Äî Apenas ativo se VRVS_DEBUG === true */
            window.__VRVS_BOOT_STEP__ = 0;

            function __vrvsFindSplashHost() {
                const ids = ['splashScreen', 'splashSubtitle', 'splashStatus', 'splashText'];
                for (var i=0; i<ids.length; i++){
                    var el = document.getElementById(ids[i]);
                    if (el) return el;
                }
                return document.body || document.documentElement;
            }

            function __vrvsMark(n) {
                window.__VRVS_BOOT_STEP__ = n;
                try {
                    var host = __vrvsFindSplashHost();
                    var s = document.getElementById('vrvsBootDiag');
                    if (!s) {
                        s = document.createElement('div');
                        s.id = 'vrvsBootDiag';
                        s.style.cssText = 'margin-top:10px;font-size:12px;opacity:.95;line-height:1.3;word-break:break-word;';
                        host.appendChild(s);
                    }
                    s.textContent = 'BOOT ' + n;
                } catch (e) {}
            }

            __vrvsMark(1);
            
            function vrvsClearSWAndCachesThenReload(){
                try {
                    var done = function(){
                        try { location.reload(); } catch(_) {}
                    };
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(function(regs){
                            return Promise.all(regs.map(function(r){ try{ return r.unregister(); } catch(e){ return Promise.resolve(false); } }));
                        }).catch(function(){});
                    }
                    if ('caches' in window) {
                        caches.keys().then(function(names){
                            return Promise.all(names.map(function(n){ try{ return caches.delete(n); } catch(e){ return Promise.resolve(false); } }));
                        }).then(done).catch(done);
                    } else {
                        done();
                    }
                } catch(e) {
                    try { location.reload(); } catch(_) {}
                }
            }
            
            function vrvsShowRescueOverlayIfStuck(){
                try {
                    if (!document.body) { setTimeout(vrvsShowRescueOverlayIfStuck, 200); return; }
                    var stuck = false;
                    try { stuck = document.body.classList.contains('splash-loading'); } catch(_) {}
                    if (!stuck) return;
                    if (document.getElementById('vrvsRescueOverlay')) return;
                    var ov = document.createElement('div');
                    ov.id = 'vrvsRescueOverlay';
                    ov.style.cssText =
                        'position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,.88);color:#fff;' +
                        'padding:16px;display:flex;flex-direction:column;gap:12px;overflow:auto;font-family:-apple-system,system-ui;';
                    var title = document.createElement('div');
                    title.style.cssText = 'font-size:16px;font-weight:700;';
                    title.textContent = 'VRVS ‚Äî MODO RESGATE (PWA preso no splash)';
                    var info = document.createElement('div');
                    info.style.cssText = 'font-size:13px;opacity:.95;line-height:1.35;';
                    info.textContent = 'O app n√£o terminou o boot. Voc√™ pode baixar seus dados do PWA agora (RAW) e/ou limpar cache offline e recarregar. Isso N√ÉO apaga seus dados.';
                    var btn1 = document.createElement('button');
                    btn1.textContent = 'Baixar RAW (dados atuais do PWA)';
                    btn1.style.cssText = 'padding:12px;border-radius:12px;border:0;font-size:14px;font-weight:700;';
                    btn1.onclick = vrvsDownloadRawStoragePWA;
                    var btn2 = document.createElement('button');
                    btn2.textContent = 'Limpar cache offline (SW/caches) e recarregar';
                    btn2.style.cssText = 'padding:12px;border-radius:12px;border:0;font-size:14px;font-weight:700;';
                    btn2.onclick = vrvsClearSWAndCachesThenReload;
                    var btn3 = document.createElement('button');
                    btn3.textContent = 'Fechar overlay e tentar continuar';
                    btn3.style.cssText = 'padding:12px;border-radius:12px;border:0;font-size:14px;font-weight:700;background:rgba(255,255,255,.2);';
                    btn3.onclick = function(){
                        try {
                            var overlay = document.getElementById('vrvsRescueOverlay');
                            if (overlay) overlay.remove();
                            try { document.body.classList.remove('splash-loading'); } catch(_) {}
                            try {
                                var splash = document.getElementById('splashScreen');
                                if (splash) {
                                    splash.classList.add('fade-out');
                                    setTimeout(function(){
                                        try { splash.classList.add('hidden'); } catch(_) {}
                                    }, 800);
                                }
                            } catch(_) {}
                        } catch(e) {}
                    };
                    var box = document.createElement('pre');
                    box.id = 'vrvsRescueKeys';
                    box.style.cssText = 'background:rgba(255,255,255,.08);padding:12px;border-radius:12px;font-size:12px;white-space:pre-wrap;';
                    try {
                        var lines = [];
                        var mainKeys = ['vrvs_dados','vrvs_historico','vrvs_anotacoes','vrvs_diario','vrvs_config'];
                        for (var i=0;i<mainKeys.length;i++){
                            var k = mainKeys[i];
                            var v = null;
                            try { v = localStorage.getItem(k); } catch(e){ v = null; }
                            lines.push(k + ': ' + (v ? ('len=' + v.length) : 'MISSING/ERR'));
                        }
                        box.textContent = lines.join('\n');
                    } catch(e) {
                        box.textContent = 'Falha ao ler localStorage: ' + String(e);
                    }
                    ov.appendChild(title);
                    ov.appendChild(info);
                    ov.appendChild(btn1);
                    ov.appendChild(btn2);
                    ov.appendChild(btn3);
                    ov.appendChild(box);
                    document.body.appendChild(ov);
                } catch(e) {}
            }
            
            setTimeout(vrvsShowRescueOverlayIfStuck, 7000);
        }
        
        // === FALLBACK EMERG√äNCIA SPLASH (remove splash mesmo se window.onload falhar) ===
        (function() {
            // Timeout de seguran√ßa: remover splash ap√≥s 5 segundos mesmo se window.onload n√£o executar
            setTimeout(function() {
                try {
                    const splash = document.getElementById('splashScreen');
                    const body = document.body;
                    if (splash && !splash.classList.contains('hidden')) {
                        splash.classList.add('fade-out');
                        if (body) {
                            body.classList.remove('splash-loading');
                        }
                        setTimeout(function() {
                            if (splash && !splash.classList.contains('hidden')) {
                                splash.classList.add('hidden');
                            }
                        }, 800);
                    }
                } catch(e) {
                    console.error('[FALLBACK SPLASH] Erro ao remover splash:', e);
                    // √öltimo recurso: tentar remover diretamente
                    try {
                        const splash = document.getElementById('splashScreen');
                        const body = document.body;
                        if (splash) splash.classList.add('hidden');
                        if (body) body.classList.remove('splash-loading');
                    } catch(e2) {}
                }
            }, 5000);
        })();
        
        // === VRVS EMERG√äNCIA (PWA preso no splash) - SEMPRE DISPON√çVEL ===
        window.vrvsDownloadRawStoragePWA = function(){
            try {
                var keys = ['vrvs_dados','vrvs_historico','vrvs_anotacoes','vrvs_diario','vrvs_config'];
                var snap = { ts: new Date().toISOString(), note: 'RAW localStorage (PWA context)', data: {}, allKeys: [] };
                for (var i=0; i<keys.length; i++){
                    var k = keys[i];
                    try { snap.data[k] = localStorage.getItem(k); } catch(e){ snap.data[k] = null; }
                }
                try {
                    for (var j=0; j<localStorage.length; j++){
                        var kk = localStorage.key(j);
                        snap.allKeys.push({ key: kk, length: (localStorage.getItem(kk)||'').length });
                    }
                } catch(_) {}
                var blob = new Blob([JSON.stringify(snap, null, 2)], { type: 'application/json' });
                var a = document.createElement('a');
                var stamp = new Date().toISOString().replace(/[:.]/g,'-');
                a.href = URL.createObjectURL(blob);
                a.download = 'VRVS_PWA_RAW_' + stamp + '.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(function(){ try{ URL.revokeObjectURL(a.href); }catch(_){} }, 2000);
            } catch(e) {
                alert('Falha ao baixar RAW: ' + String(e));
            }
        };
        
        // Kill-switch SW (desligado por padr√£o - apenas ativo se VRVS_DEBUG === true)
        // Removido completamente em produ√ß√£o
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#17121d">
    
    <!-- Favicon para MacBook e navegadores - m√∫ltiplos formatos e caminhos -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=3">
    <link rel="shortcut icon" href="./favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico?v=3" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png?v=3">
    <link rel="icon" type="image/png" href="./logo.png?v=3">
    
    <!-- Apple Touch Icon para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png?v=3">
    <link rel="apple-touch-icon" href="./logo.png?v=3">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VRVS">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üß† VRVS v5.3 ‚Äì Sistema de Gest√£o de Estudos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* CORES CIRCUIT TECH */
            --bg-dark: #0a1a1f;
            --bg-darker: #051015;
            
            /* TURQUESA TECH */
            --turquesa-neon: #00FFE0;
            --turquesa-light: #00CED1;
            --turquesa-main: #0d9488;
            --turquesa-dark: #0f766e;
            --turquesa-darker: #134e4a;
            
            /* √ÇMBAR COBRE TECH */
            --cobre-neon: #FFAA00;
            --cobre-light: #FFB84D;
            --cobre-main: #FF9F40;
            --cobre-dark: #E5892E;
            --cobre-darker: #B8701F;
            --ambar-claro: #FFB84D; /* SPEC OPUS: √Çmbar dourado */
            
            /* GLASSMORPHISM */
            --glass-bg: rgba(20, 35, 45, 0.4);
            --glass-border: rgba(255, 127, 80, 0.3);
            --text-light: rgba(255, 255, 255, 0.95);
        }
        
        /* ==================== HIERARQUIA DE INTENSIDADE (OPUS) ==================== */
        
        /* BASE GLASS (container, sem alterar texto) */
        .glass-base {
            background: rgba(255,255,255, 0.03);
            border: 1px solid rgba(255,255,255, 0.08);
        }
        
        /* TABS DO DI√ÅRIO ‚Äî ESTADOS */
        .modo-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            -webkit-tap-highlight-color: transparent;
        }
        
        .modo-inativo {
            background: transparent;
            color: rgba(255,255,255,0.6);
            border: 1px solid transparent;
            box-shadow: none;
        }
        
        /* N√≠vel 2 ‚Äî DESTAQUE (15%) */
        .nivel-2-turquesa {
            background: linear-gradient(135deg, rgba(0,206,209,0.08), rgba(0,206,209,0.04));
            border: 1px solid rgba(0,206,209,0.20);
            color: rgba(0,206,209,0.85);
            box-shadow: 0 0 20px rgba(0,206,209,0.08);
        }
        
        .nivel-2-ambar {
            background: linear-gradient(135deg, rgba(255,184,77,0.08), rgba(255,184,77,0.04));
            border: 1px solid rgba(255,184,77,0.20);
            color: rgba(255,184,77,0.85);
            box-shadow: 0 0 20px rgba(255,184,77,0.08);
        }
        
        .nivel-2-vermelho {
            background: linear-gradient(135deg, rgba(255,82,82,0.08), rgba(255,82,82,0.04));
            border: 1px solid rgba(255,82,82,0.15);
            color: rgba(255,82,82,0.70);
            box-shadow: 0 0 20px rgba(255,82,82,0.08);
        }
        
        /* N√≠vel 3 ‚Äî A√á√ÉO (5%) */
        .nivel-3-ambar {
            background: linear-gradient(135deg, rgba(255,184,77,0.15), rgba(255,184,77,0.08));
            border: 1px solid rgba(255,184,77,0.30);
            color: rgba(255,184,77,0.95);
            box-shadow: 0 0 24px rgba(255,184,77,0.10);
        }
        
        /* FAIXAS RANKING (N√≠vel 1 + cor sutil) */
        .faixa-baixa {
            background: linear-gradient(135deg, rgba(255,82,82,0.06), transparent);
            border: 1px solid rgba(255,82,82,0.12);
        }
        
        .faixa-baixa .rank-badge {
            background: rgba(255,82,82,0.10);
            border: 1px solid rgba(255,82,82,0.20);
            color: rgba(255,82,82,0.80);
        }
        
        .faixa-baixa .nota-display {
            color: rgba(255,82,82,0.75);
        }
        
        .faixa-media {
            background: linear-gradient(135deg, rgba(255,184,77,0.06), transparent);
            border: 1px solid rgba(255,184,77,0.12);
        }
        
        .faixa-media .rank-badge {
            background: rgba(255,184,77,0.10);
            border: 1px solid rgba(255,184,77,0.20);
            color: rgba(255,184,77,0.80);
        }
        
        .faixa-media .nota-display {
            color: rgba(255,184,77,0.75);
        }
        
        .faixa-alta {
            background: linear-gradient(135deg, rgba(80,220,100,0.06), transparent);
            border: 1px solid rgba(80,220,100,0.12);
        }
        
        .faixa-alta .rank-badge {
            background: rgba(80,220,100,0.10);
            border: 1px solid rgba(80,220,100,0.20);
            color: rgba(80,220,100,0.80);
        }
        
        .faixa-alta .nota-display {
            color: rgba(80,220,100,0.75);
        }
        
        /* BADGE AVAN√áADO (N√≠vel 1 √¢mbar discreto) */
        .badge-avancado {
            background: linear-gradient(135deg, rgba(255,184,77,0.08), rgba(255,184,77,0.04));
            border: 1px solid rgba(255,184,77,0.15);
            color: rgba(255,184,77,0.75);
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* OBSERVA√á√ÉO ‚Äî MULTILINE (sem cor fixa) */
        .obs-desempenho {
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.4;
            margin-top: 6px;
            font-size: 12px;
            font-style: italic;
            color: rgba(255,255,255,0.65);
        }
        
        /* ==================== FIM HIERARQUIA ==================== */

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-dark) !important;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* CIRCUIT BOARD BACKGROUND */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(13, 148, 136, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 127, 80, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 206, 209, 0.1) 0%, transparent 70%),
                var(--bg-dark);
            pointer-events: none;
            z-index: 1;
        }
        
        /* GRID CIRCUIT ANIMADO */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(rgba(255, 127, 80, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 127, 80, 0.05) 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 100px 100px, 100px 100px;
            pointer-events: none;
            z-index: 1;
            animation: gridPulse 6s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; transform: translate(0, 0); }
            50% { opacity: 0.6; transform: translate(-2px, -2px); }
        }
        
        .container {
            position: relative;
            z-index: 2;
            padding-bottom: 100px;
        }
        
        /* HEADER NEON TECH */
        .header {
            background: rgba(10, 26, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 22px 20px;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, 
                var(--turquesa-main) 50%,
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            ) 1;
            animation: borderFlow 4s linear infinite;
        }
        
        @keyframes borderFlow {
            0% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, var(--cobre-main) 25%, 
                var(--turquesa-main) 50%, var(--cobre-neon) 75%, var(--turquesa-neon) 100%); }
            100% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 100%, var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, var(--turquesa-main) 50%, var(--cobre-neon) 75%); }
        }
        
        .header-title {
            background: linear-gradient(135deg, 
                var(--turquesa-neon) 0%, 
                var(--turquesa-light) 25%, 
                var(--cobre-light) 50%, 
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(255, 170, 0, 0.8));
                transform: scale(1.02);
            }
        }
        
        .header-subtitle {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 206, 209, 0.7);
        }
        
        /* TABS GLASSMORPHISM - SEM SCROLL CORTADO */
        .tabs {
            display: flex;
            gap: 12px;
            padding: 20px 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(10, 26, 31, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--turquesa-light);
            border: 1px solid rgba(0, 206, 209, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .tab:hover {
            border-color: var(--cobre-main);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, 
                rgba(255, 127, 80, 0.2), 
                rgba(0, 206, 209, 0.2)
            );
            color: var(--cobre-light);
            border-color: var(--cobre-main);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.4),
                0 0 40px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* CONTENT SECTIONS */
        .content {
            padding: 20px 15px;
            min-height: 50vh; /* CORRE√á√ÉO: Ocupar pelo menos 50% da tela */
        }
        
        .section {
            display: none;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .section.active { display: block; }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        /* CARDS GLASSMORPHISM NEON - SEM HOVER MANCHADO */
        .card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(0, 206, 209, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
            pointer-events: auto;
            /* CORRE√á√ÉO: Garantir que texto dentro dos cards seja vis√≠vel */
            color: var(--text-light);
        }
        
        /* CORRE√á√ÉO: Garantir que todos os elementos dentro dos cards herdem cor clara */
        .card * {
            color: inherit;
        }
        
        /* Exce√ß√µes: elementos que devem manter suas cores espec√≠ficas */
        .card-title {
            color: transparent; /* Mant√©m gradiente */
        }
        
        .stat-value {
            color: transparent; /* Mant√©m gradiente */
        }
        
        .stat-label {
            color: rgba(0, 206, 209, 0.8); /* Mant√©m cor espec√≠fica */
        }
        
        .form-label {
            color: var(--turquesa-light); /* Mant√©m cor espec√≠fica */
        }
        
        .form-input, .form-select, .form-textarea {
            color: var(--text-light); /* Mant√©m cor espec√≠fica */
        }
        
        .card:hover {
            border-color: var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .card-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 127, 80, 0.3);
        }
        
        /* Garantir que bot√µes dentro de card-title n√£o herdem transpar√™ncia */
        .card-title button {
            -webkit-text-fill-color: #FFFFFF !important;
            background-clip: border-box !important;
            -webkit-background-clip: border-box !important;
        }
        
        /* FORM ELEMENTS NEON */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(10, 26, 31, 0.6);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-light);
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cobre-main);
            box-shadow: 
                0 0 20px rgba(255, 127, 80, 0.3),
                inset 0 0 20px rgba(255, 127, 80, 0.05);
            background: rgba(10, 26, 31, 0.8);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 200px; /* CORRE√á√ÉO: Aumentado de 150px para melhor uso do espa√ßo */
            max-height: 500px; /* CORRE√á√ÉO: Aumentado de 400px para permitir mais conte√∫do */
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.6;
        }
        
        /* CORRE√á√ÉO: Cursor piscando fora dos boxes no mobile */
        .form-input, .form-textarea {
            -webkit-user-select: text;
            user-select: text;
            caret-color: var(--cobre-main);
            /* Remover qualquer transform que possa causar cursor fora de posi√ß√£o */
            transform: none;
            -webkit-transform: none;
        }
        
        .form-input:focus, .form-textarea:focus {
            /* Manter apenas propriedades essenciais - sem transform que causa cursor travado */
            -webkit-tap-highlight-color: rgba(255, 127, 80, 0.3);
            /* Garantir que cursor aparece dentro do elemento */
            outline-offset: 0;
        }
        
        /* CORRE√á√ÉO: Ajustar viewport quando teclado aparece no mobile */
        @media screen and (max-width: 768px) {
            /* Prevenir zoom autom√°tico no iOS quando input recebe foco */
            .form-input, .form-textarea, .form-select {
                font-size: 16px !important;
            }
            
            /* Garantir que modal seja scroll√°vel quando input est√° em foco */
            .modal-content {
                -webkit-overflow-scrolling: touch;
                /* Ajustar posi√ß√£o do modal quando teclado aparece */
                position: relative;
            }
            
            /* For√ßar scroll para elemento focado */
            .form-input:focus, .form-textarea:focus, .form-select:focus {
                scroll-margin-top: 100px;
                -webkit-scroll-margin-top: 100px;
            }
            
            /* OTIMIZA√á√ÉO: Reduzir espa√ßos vazios no modal do Di√°rio para mobile */
            #modalNovaDiario .modal-content {
                padding: 16px; /* Reduzido de 30px para 16px */
                max-height: 95vh; /* CORRE√á√ÉO: Aumentado de 90vh para 95vh - quase tela toda */
            }
            
            #modalNovaDiario .modal-header {
                margin-bottom: 16px; /* Reduzido de 24px para 16px */
            }
            
            #modalNovaDiario .form-group {
                margin-bottom: 12px; /* Reduzido de 20px para 12px */
            }
            
            #modalNovaDiario .form-label {
                margin-bottom: 6px; /* Reduzido de 8px para 6px */
                font-size: 11px; /* Ligeiramente menor para economizar espa√ßo */
            }
            
            /* CORRE√á√ÉO UX: Inputs do modal Di√°rio (iOS) */
            #modalNovaDiario input,
            #modalNovaDiario textarea,
            #modalNovaDiario select {
                box-sizing: border-box;
                padding: 12px 14px;
                text-indent: 0;
                caret-color: var(--cobre-main);
                -webkit-appearance: none;
                appearance: none;
                outline-offset: 0;
            }
            
            /* Campo T√≥pico/Pergunta: textarea com altura adequada */
            /* NOTA: Regra espec√≠fica para #novaDiarioTopico deve ficar DEPOIS de .form-textarea para sobrescrever min-height/max-height */
            #novaDiarioTopico {
                min-height: 96px;
                max-height: 220px;
                line-height: 1.4;
                font-size: 15px;
                padding: 12px 14px;
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
                caret-color: var(--cobre-main);
                direction: ltr;
                text-align: left;
                text-indent: 0;
            }
            
            /* Campo Resposta: altura maior separada */
            #novaDiarioResposta {
                min-height: 200px;
                max-height: 400px;
            }
            
            /* P1 DEBUG START - Instrumenta√ß√£o visual do caret (remov√≠vel) */
            #p1-debug-caret-pill {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.95);
                color: #00FFE0;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 11px;
                font-family: 'Courier New', monospace;
                z-index: 999999;
                max-width: 320px;
                border: 2px solid rgba(0, 206, 209, 0.6);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                display: none; /* Default OFF */
                line-height: 1.4;
                word-break: break-word;
            }
            
            #p1-debug-caret-pill.active {
                display: block;
            }
            
            #p1-debug-caret-pill .p1-debug-label {
                font-weight: bold;
                color: #00CED1;
                margin-bottom: 4px;
            }
            
            #p1-debug-caret-pill .p1-debug-value {
                color: #FFFFFF;
                margin-left: 8px;
            }
            /* P1 DEBUG END */
            
            /* OTIMIZA√á√ÉO GERAL: Modais ocupam quase tela toda no mobile */
            .modal-content {
                max-height: 95vh !important; /* Quase tela toda no mobile */
                padding: 16px; /* Reduzir padding para ganhar espa√ßo */
                margin: 10px; /* Margem m√≠nima */
            }
            
            /* Containers principais devem ocupar mais espa√ßo no mobile */
            #diarioContainer,
            #cadernoContainer,
            #tarefaContainer,
            #agendaContainer {
                min-height: 60vh; /* Ocupar pelo menos 60% da tela */
            }
            
            /* √Åreas expandidas ocupam mais espa√ßo no mobile */
            .area-content:not(.collapsed) {
                max-height: 80vh !important; /* Aumentado de 70vh para mobile */
                min-height: 50vh !important; /* M√≠nimo 50% da tela quando expandido */
            }
            
            /* Reduzir paddings em cards para ganhar espa√ßo */
            .card {
                padding: 16px; /* Reduzido de 24px para 16px */
            }
        }
        
        /* BUTTONS NEON */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, 
                var(--cobre-main) 0%, 
                var(--cobre-dark) 100%
            );
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(255, 127, 80, 0.4),
                0 0 30px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.5),
                0 0 40px rgba(255, 127, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* ===== PATCH D - UX REFINADA: TOUCH/FOCUS ===== */
        .btn {
            /* Melhorar √°rea de toque no mobile */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(255, 127, 80, 0.3);
            min-height: 44px; /* Tamanho m√≠nimo recomendado para touch */
        }
        
        .btn:focus {
            outline: 2px solid var(--turquesa-neon);
            outline-offset: 2px;
        }
        
        .btn:focus:not(:focus-visible) {
            outline: none; /* Remover outline em clique, manter em navega√ß√£o por teclado */
        }
        
        .btn-secondary {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.3),
                rgba(0, 148, 136, 0.3)
            );
            box-shadow: 
                0 4px 15px rgba(0, 206, 209, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== MODAL GERENCIAR PERFIS (P4 - REFATORADO) ==================== */
        
        .vrvsModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        
        .vrvsModal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vrvsModal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .vrvsModal-content {
            position: relative;
            z-index: 1;
            background: rgba(10, 26, 31, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 24px;
            padding: 0;
            max-width: 340px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: vrvsModalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255,255,255,0.9);
        }
        
        @keyframes vrvsModalSlide {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .vrvsModal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .vrvsModal-title {
            margin: 0;
            color: #FFFFFF;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vrvsModal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .vrvsModal-close:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .vrvsModal-body {
            padding: 20px;
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
        }
        
        .vrvsModal-footer {
            padding: 0 20px 20px 20px;
        }
        
        /* ============================================ */
        /* ITEM DE PERFIL - BASE                       */
        /* ============================================ */
        
        .perfil-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 18px;
            margin-bottom: 12px;
            background: rgba(15, 40, 50, 0.9);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
            gap: 12px;
            flex-wrap: nowrap;
        }
        
        .perfil-item:hover {
            background: rgba(20, 50, 60, 0.95);
        }
        
        .perfil-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .perfil-item-name {
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .perfil-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: center;
        }
        
        /* ============================================ */
        /* BOT√ïES DE A√á√ÉO                              */
        /* ============================================ */
        
        .btn-perfil-action {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            flex-shrink: 0;
        }
        
        .btn-perfil-ativar {
            background: rgba(0, 206, 209, 0.15);
            color: #00CED1;
        }
        
        .btn-perfil-ativar:hover {
            background: rgba(0, 206, 209, 0.25);
        }
        
        .btn-perfil-editar {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .btn-perfil-editar:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-perfil-apagar {
            background: rgba(255, 69, 58, 0.15);
            color: #ff453a;
        }
        
        .btn-perfil-apagar:hover {
            background: rgba(255, 69, 58, 0.25);
        }
        
        /* ============================================ */
        /* PERFIL ATIVO - GRADIENTE TURQUESA + √ÇMBAR   */
        /* ============================================ */
        
        .perfil-item.ativo {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.12) 0%, rgba(255, 163, 102, 0.08) 100%);
            border: 2px solid transparent;
            position: relative;
            isolation: isolate;
        }
        
        /* BORDA GRADIENTE */
        .perfil-item.ativo::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, var(--turquesa-neon) 0%, var(--ambar-claro) 100%);
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        /* GLOW EXTERNO */
        .perfil-item.ativo::after {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--turquesa-neon) 0%, var(--ambar-claro) 100%);
            opacity: 0.25;
            filter: blur(15px);
            z-index: -1;
            animation: glowPulse 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes glowPulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.35; }
        }
        
        .perfil-item.ativo .perfil-item-name {
            color: #FFFFFF;
            font-weight: 700;
        }
        
        /* ============================================ */
        /* BADGE "ATIVO"                               */
        /* ============================================ */
        
        .badge-ativo {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: linear-gradient(135deg, var(--turquesa-neon) 0%, var(--ambar-claro) 100%);
            color: #000000;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 6px;
            white-space: nowrap;
        }
        
        .badge-ativo-dot {
            width: 6px;
            height: 6px;
            background: #000000;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* ============================================ */
        /* BOT√ÉO CRIAR NOVO PERFIL                     */
        /* ============================================ */
        
        .btn-criar-perfil {
            width: 100%;
            padding: 16px;
            margin-top: 8px;
            background: transparent;
            border: 2px dashed rgba(0, 206, 209, 0.4);
            border-radius: 14px;
            color: #00CED1;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .btn-criar-perfil:hover {
            background: rgba(0, 206, 209, 0.08);
            border-color: var(--turquesa-neon);
        }
        
        .btn-criar-perfil-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--turquesa-neon) 0%, var(--ambar-claro) 100%);
            color: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* ============================================ */
        /* BOT√ÉO FECHAR                                */
        /* ============================================ */
        
        .btn-fechar-modal {
            width: 100%;
            padding: 16px;
            margin-top: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .btn-fechar-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== GERENCIAR √ÅREAS/TEMAS (SPEC OPUS) ==================== */
        .area-card-gerenciar {
            margin-bottom: 12px;
            background: rgba(15, 40, 50, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }
        
        .area-header-gerenciar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: rgba(0, 206, 209, 0.06);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,206,209,0.2);
        }
        
        .area-info-gerenciar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .area-name-gerenciar {
            font-size: 14px;
            font-weight: 600;
            color: var(--turquesa-light);
        }
        
        .area-badge-gerenciar {
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .area-badge-fixa-gerenciar {
            padding: 3px 8px;
            background: rgba(255, 184, 77, 0.15);
            border: 1px solid rgba(255, 184, 77, 0.3);
            border-radius: 10px;
            font-size: 10px;
            color: var(--ambar-claro);
            cursor: help;
            user-select: none;
            touch-action: manipulation;
        }
        
        .area-actions-gerenciar {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .area-toggle-gerenciar {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 8px;
        }
        
        .area-content-gerenciar {
            padding: 6px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            opacity: 1;
        }
        
        .area-content-gerenciar.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .tema-item-gerenciar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .tema-item-gerenciar:hover {
            background: rgba(255, 255, 255, 0.04);
        }
        
        .tema-name-gerenciar {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tema-actions-gerenciar {
            display: flex;
            gap: 6px;
        }
        
        .btn-sm-gerenciar {
            width: 32px;
            height: 32px;
            min-width: 32px;
            min-height: 32px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            flex-shrink: 0;
        }
        
        .btn-edit-gerenciar {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .btn-edit-gerenciar:active {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(1px);
        }
        
        .btn-delete-gerenciar {
            background: rgba(255, 69, 58, 0.12);
            color: #ff453a;
        }
        
        .btn-delete-gerenciar:active {
            background: rgba(255, 69, 58, 0.25);
            transform: translateY(1px);
        }
        
        /* Mobile: modal mais pr√≥ximo do topo */
        @media (max-width: 768px) {
            .vrvsModal-content {
                max-height: 90vh;
                margin-top: 5vh;
            }
        }
        
        /* ==================== SRS - ESTILOS DI√ÅRIO ==================== */
        
        /* ===== CHIP VRVS 3P ‚Äì Di√°rio ===== */
        .diario-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
        }
        
        .diario-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }
        
        /* ========================================
           CHIP VRVS 3P - NEON OUTLINE (OP√á√ÉO 1)
           ======================================== */
        #vrvs3p-chip-diario {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            
            /* fundo transparente para n√£o virar mais um "tijolo" */
            background: transparent !important;
            
            /* borda neon turquesa */
            border: 1.5px solid #00FFE0 !important;
            border-radius: 25px;
            
            /* glow sutil */
            box-shadow:
                0 0 8px rgba(0, 255, 224, 0.3),
                inset 0 0 8px rgba(0, 255, 224, 0.05);
            
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        #vrvs3p-chip-diario:hover {
            background: rgba(0, 255, 224, 0.08);
            box-shadow:
                0 0 12px rgba(0, 255, 224, 0.5),
                inset 0 0 12px rgba(0, 255, 224, 0.1);
        }
        
        #vrvs3p-chip-text {
            font-size: 13px;
            font-weight: 500;
            color: #00FFE0 !important;
            letter-spacing: 0.3px;
        }
        
        /* Responsivo ‚Äì portrait iPhone */
        @media (max-width: 480px) {
            .diario-header-row {
                align-items: flex-start;
            }
            
            #vrvs3p-chip-diario {
                padding: 6px 12px;
            }
            
            #vrvs3p-chip-text {
                font-size: 12px;
            }
            
            .btn-nova-diario {
                align-self: flex-end;
                margin-top: 8px;
            }
        }
        
        /* Tabs Lista/Sess√£o */
        .diario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .diario-tab {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 206, 209, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .diario-tab:hover {
            background: rgba(0, 206, 209, 0.1);
            border-color: var(--turquesa-main);
        }
        
        .diario-tab.active {
            background: var(--cobre-main);
            color: white;
            border-color: var(--cobre-main);
        }
        
        /* Modos Programado/Livre */
        .diario-sessao-modos {
            display: flex;
            gap: 8px;
        }
        
        .diario-sessao-modo-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(0, 206, 209, 0.3);
            background: transparent;
            color: var(--turquesa-light);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .diario-sessao-modo-btn:hover {
            background: rgba(0, 206, 209, 0.1);
        }
        
        .diario-sessao-modo-btn.active {
            background: var(--turquesa-main);
            color: white;
            border-color: var(--turquesa-main);
        }
        
        /* Card da sess√£o */
        .diario-sessao-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 127, 80, 0.2);
        }
        
        .diario-sessao-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(0, 206, 209, 0.7);
            margin-bottom: 16px;
        }
        
        /* === PATCH CSS ‚Äî garantir "esquerda de verdade" no card (31/12/2025) === */
        .diario-sessao-topico {
            width: 100% !important;
            align-self: stretch !important;
            text-align: left !important;
            white-space: pre-wrap !important;
            overflow-wrap: anywhere;
            word-wrap: break-word;
            line-height: 1.5;
            color: var(--cobre-light);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        /* Se o card estiver como flex e centralizando itens, corrigir s√≥ no eixo transversal */
        .diario-sessao-card {
            align-items: stretch !important;
        }
        /* === FIM PATCH CSS === */
        
        .diario-sessao-resposta {
            background: rgba(0, 206, 209, 0.1);
            border-left: 3px solid var(--turquesa-main);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 20px;
            /* FIX iOS: garantir alinhamento √† esquerda e largura total */
            text-align: left !important;
            text-align-last: left !important;
            -webkit-text-align-last: left !important;
            width: 100% !important;
            display: block !important;
            align-self: stretch !important;
        }
        
        .diario-sessao-resposta.escondida {
            display: none;
        }
        
        /* FIX iOS: garantir alinhamento √† esquerda e largura total */
        .diario-sessao-resposta-inner {
            font-size: 13px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            /* FIX iOS: garantir alinhamento √† esquerda e largura total */
            text-align: left !important;
            text-align-last: left !important;
            -webkit-text-align-last: left !important;
            width: 100% !important;
            display: block !important;
            align-self: stretch !important;
        }
        
        /* P2 v2: fallback robusto ‚Äî n√£o depender de .escondida */
        [hidden] {
            display: none !important;
        }
        
        .diario-sessao-acoes {
            margin-bottom: 16px;
        }
        
        /* Bot√£o Mostrar Resposta - neutro turquesa */
        .diario-sessao-acoes .btn {
            background: rgba(0, 206, 209, 0.2);
            border: 1px solid rgba(0, 206, 209, 0.4);
            color: var(--turquesa-light);
            font-weight: 600;
        }
        
        .diario-sessao-acoes .btn:hover,
        .diario-sessao-acoes .btn:active {
            background: rgba(0, 206, 209, 0.3);
        }
        
        /* Bot√µes de qualidade */
        .diario-sessao-botoes-qualidade {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            margin: 20px 0;
        }
        
        /* Bot√µes individuais - mesmo tamanho */
        .diario-sessao-botoes-qualidade button {
            flex: 1;
            max-width: 110px;
            min-width: 90px;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        /* Links secund√°rios */
        .diario-sessao-opcoes {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .link-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s ease;
        }
        
        .link-btn:hover {
            color: var(--turquesa-light);
        }
        
        /* ==================== BOT√ïES DE OP√á√ïES DA SESS√ÉO (v5.3.63) ==================== */
        
        .diario-sessao-opcoes-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .diario-sessao-opcoes-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .sessao-opcao-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px; /* iOS touch target */
        }
        
        .sessao-opcao-pular {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }
        
        .sessao-opcao-pular:hover,
        .sessao-opcao-pular:active {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .sessao-opcao-desativar {
            background: rgba(255, 127, 80, 0.1);
            border: 1px solid rgba(255, 127, 80, 0.3);
            color: rgba(255, 127, 80, 0.8);
        }
        
        .sessao-opcao-desativar:hover,
        .sessao-opcao-desativar:active {
            background: rgba(255, 127, 80, 0.2);
            color: var(--cobre-main);
        }
        
        .sessao-opcao-excluir {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: rgba(220, 53, 69, 0.8);
            width: 100%;
        }
        
        .sessao-opcao-excluir:hover,
        .sessao-opcao-excluir:active {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        
        /* S5-UX: Bot√£o Pr√≥ximo na sess√£o */
        .sessao-nav-proximo {
            background: rgba(0, 206, 209, 0.1);
            border: 1px solid rgba(0, 206, 209, 0.4);
            color: rgba(0, 206, 209, 0.9);
            font-size: 13px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            min-height: 44px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .sessao-nav-proximo:hover {
            background: rgba(0, 206, 209, 0.15);
            border-color: rgba(0, 206, 209, 0.5);
        }

        .sessao-nav-proximo:active {
            background: rgba(0, 206, 209, 0.2);
        }
        
        /* ==================== TL-2: TREINO LIVRE RUNNER ==================== */
        
        .treino-livre-runner-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .treino-livre-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-bottom: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .treino-livre-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .treino-livre-sair {
            background: transparent;
            border: none;
            color: var(--turquesa-light);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }
        
        .treino-livre-sair:hover,
        .treino-livre-sair:active {
            color: var(--turquesa-neon);
        }
        
        .treino-livre-header-center {
            flex: 1;
            text-align: center;
        }
        
        .treino-livre-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--turquesa-light);
            margin-bottom: 2px;
        }
        
        .treino-livre-header-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .treino-livre-progresso {
            font-size: 14px;
            color: rgba(0, 206, 209, 0.7);
            font-weight: 600;
        }
        
        .treino-livre-navegacao {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .treino-livre-navegacao button {
            flex: 1;
            padding: 12px;
            min-height: 44px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid rgba(0, 206, 209, 0.3);
            background: rgba(0, 206, 209, 0.1);
            color: var(--turquesa-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .treino-livre-navegacao button:hover:not(:disabled) {
            background: rgba(0, 206, 209, 0.2);
            border-color: rgba(0, 206, 209, 0.5);
        }
        
        .treino-livre-navegacao button:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .treino-livre-navegacao button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .treino-livre-fim {
            text-align: center;
            padding: 40px 20px;
        }
        
        .treino-livre-fim-titulo {
            font-size: 20px;
            font-weight: 600;
            color: var(--turquesa-light);
            margin-bottom: 12px;
        }
        
        .treino-livre-fim-detalhe {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }
        
        .treino-livre-fim-disclaimer {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 24px;
        }
        
        /* ==================== FIM SRS ESTILOS ==================== */
        
        /* ==================== A1-UX: ESTILOS TELA FIM TREINO ==================== */
        /* Container da tela de fim do treino - isolado para n√£o afetar outras telas */
        #treinoFimDetalhes .card-detalhe-treino {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
        }
        
        /* T√≠tulo da nota */
        #treinoFimDetalhes .card-detalhe-nota {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }
        
        /* √Årea e tema */
        #treinoFimDetalhes .card-detalhe-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        /* Pergunta (sem truncar) */
        #treinoFimDetalhes .card-detalhe-pergunta {
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
        }
        /* ==================== FIM A1-UX ESTILOS ==================== */
        
        /* ==================== A1-PRO: CARDS COLAPS√ÅVEIS ==================== */
        .card-resultado {
            margin-bottom: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
            text-align: left;
        }
        
        .card-resultado-header {
            position: relative;
            text-align: left;
            padding: 16px;
            cursor: pointer;
            list-style: none;
        }
        
        .card-resultado-header::marker {
            content: "";
        }
        
        .card-resultado-header::-webkit-details-marker {
            display: none;
        }
        
        .card-resultado-nota {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }
        
        .card-resultado-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-resultado-conteudo {
            padding: 0 16px 16px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            padding-top: 16px;
        }
        
        .card-resultado-pergunta {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .card-resultado[data-nota="null"] {
            border-left-color: rgba(255, 255, 255, 0.3);
        }
        
        /* REFINO UI 01 ‚Äî A1 fim de treino (whitespace + seta) */
        .card-resultado {
            overflow: hidden;
        }
        
        .card-resultado-header {
            padding-right: 30px;
        }
        
        .card-resultado-header::after {
            content: "‚ñº";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            transition: transform 0.2s;
            pointer-events: none;
        }
        
        .card-resultado[open] .card-resultado-header::after {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .card-resultado-pergunta {
            white-space: pre-line !important;
        }
        
        .card-resultado-pergunta,
        .card-resultado-pergunta * {
            text-overflow: clip !important;
            -webkit-line-clamp: unset !important;
            line-clamp: unset !important;
            overflow: visible !important;
        }
        
        /* REFINO UI 01 ‚Äî Modal confirmar exclus√£o (contraste + sem ellipsis) */
        #modalConfirmarExclusaoDiario .modal-content {
            color: rgba(255, 255, 255, 0.92) !important;
        }
        
        #modalConfirmarExclusaoDiario .modal-body,
        #modalConfirmarExclusaoDiario .modal-body * {
            color: rgba(255, 255, 255, 0.90) !important;
        }
        
        #modalConfirmarExclusaoDiario #previewExclusaoDiario {
            color: rgba(255, 255, 255, 0.90) !important;
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
            -webkit-line-clamp: unset !important;
            line-clamp: unset !important;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        
        /* ==================== FIM A1-PRO ==================== */
        
        /* Bot√µes de qualidade da sess√£o do Di√°rio - estilo VRVS (fundo escuro + glow) */
        /* Base neutra dos tr√™s bot√µes */
        .diario-sessao-botoes-qualidade button {
            background: rgba(5, 25, 30, 0.96);
            border-radius: 8px;
            border-width: 1px;
            border-style: solid;
            color: #ffffff;
            box-shadow: none;
        }
        
        /* ESQUECI ‚Äì borda/glow vermelho */
        .diario-sessao-botoes-qualidade .btn-esqueci,
        .diario-sessao-botoes-qualidade .btn-danger {
            border-color: rgba(220, 53, 69, 0.85);
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-esqueci:active,
        .diario-sessao-botoes-qualidade .btn-danger:active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.5);
        }
        
        /* LEMBREI ‚Äì borda/glow √¢mbar */
        .diario-sessao-botoes-qualidade .btn-lembrei,
        .diario-sessao-botoes-qualidade .btn:not(.btn-danger):not(.btn-sucesso):not(.btn-esqueci):not(.btn-facil) {
            border-color: rgba(245, 158, 11, 0.85);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-lembrei:active,
        .diario-sessao-botoes-qualidade .btn:not(.btn-danger):not(.btn-sucesso):not(.btn-esqueci):not(.btn-facil):active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(245, 158, 11, 0.5);
        }
        
        /* F√ÅCIL ‚Äì borda/glow verde */
        .diario-sessao-botoes-qualidade .btn-facil,
        .diario-sessao-botoes-qualidade .btn-sucesso {
            border-color: rgba(34, 197, 94, 0.85);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.35);
        }
        
        .diario-sessao-botoes-qualidade .btn-facil:active,
        .diario-sessao-botoes-qualidade .btn-sucesso:active {
            transform: scale(0.97);
            box-shadow: 0 0 16px rgba(34, 197, 94, 0.5);
        }
        
        /* Manter outros usos de btn-danger e btn-sucesso */
        .btn-danger:not(.diario-sessao-botoes-qualidade .btn-danger) {
            background: linear-gradient(135deg, 
                rgba(220, 53, 69, 0.8) 0%, 
                rgba(220, 53, 69, 1) 100%
            ) !important;
            margin-top: 12px;
        }
        
        .btn-sucesso:not(.diario-sessao-botoes-qualidade .btn-sucesso) {
            background: linear-gradient(135deg, 
                rgba(40, 167, 69, 0.8) 0%, 
                rgba(40, 167, 69, 1) 100%
            ) !important;
        }
        
        .btn-small {
            width: auto;
            padding: 10px 16px;
            font-size: 11px;
        }
        
        .btn-edit {
            background: transparent;
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--turquesa-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-edit:hover {
            border-color: var(--cobre-main);
            color: var(--cobre-light);
            background: rgba(255, 127, 80, 0.1);
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 6px 10px;
            border-radius: 8px;
            color: #EF4444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #EF4444;
            transform: scale(1.1);
        }
        
        .btn-save-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 206, 209, 0.15);
            color: rgba(0, 206, 209, 0.8);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-save-floating:hover {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.25) 0%, rgba(0, 206, 209, 0.35) 100%);
            color: #00FFE0;
            border-color: rgba(0, 206, 209, 0.5);
            box-shadow: 0 4px 20px rgba(0, 206, 209, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-save-floating:active {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.4) 0%, rgba(0, 206, 209, 0.5) 100%);
            color: #00FFE0;
            box-shadow: 0 6px 25px rgba(0, 206, 209, 0.5);
            transform: translateY(0) scale(0.98);
        }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.7),
                rgba(30, 50, 60, 0.5)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 127, 80, 0.1) 0%, 
                transparent 70%
            );
            animation: statPulse 4s ease-in-out infinite;
        }
        
        @keyframes statPulse {
            0%, 100% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(255, 127, 80, 0.5));
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(0, 206, 209, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* TASK ITEMS - CORES AJUSTADAS */
        .task-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-edit-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 2;
        }
        
        .task-item.priority-5 {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .task-item.priority-4 {
            border-color: var(--cobre-light);
            box-shadow: 0 0 20px rgba(255, 163, 102, 0.2);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .task-meta {
            font-size: 12px;
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-meta * {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .task-tag-area,
        .task-tag-rendimento,
        .task-tag-tipo,
        .task-tag-sessoes {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 206, 209, 0.1);
            color: rgba(255,255,255,0.9) !important;
            font-weight: 600;
        }
        
        .task-tag-area {
            color: var(--turquesa-light) !important;
        }
        
        .task-tag-rendimento {
            /* Cor j√° definida inline, mas garantir fallback */
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-tag-tipo {
            color: var(--cobre-light) !important;
        }
        
        .task-tag-sessoes {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .task-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(255, 127, 80, 0.5);
        }
        
        .task-theme-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.9)
            );
            /* backdrop-filter: blur(15px); */ /* DESABILITADO: Pode causar problemas de hit-testing no iOS Safari */
            border-left: 4px solid rgba(0, 206, 209, 0.5);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none; /* CR√çTICO iOS: Desabilita menu de contexto */
            -webkit-user-select: none; /* CR√çTICO iOS: Desabilita sele√ß√£o de texto */
            user-select: none;
        }
        .task-theme-item:hover {
            background: linear-gradient(135deg,
                rgba(30, 45, 55, 0.7),
                rgba(40, 60, 70, 0.5)
            );
            transform: translateX(4px);
        }
        .task-theme-item:active {
            transform: translateX(2px);
            opacity: 0.9;
        }
        .task-theme-item.priority-5 { border-left-color: var(--cobre-main); }
        .task-theme-item.priority-4 { border-left-color: var(--cobre-light); }
        .task-theme-item.priority-3 { border-left-color: rgba(0, 206, 209, 0.5); }
        .task-theme-item.priority-2 { border-left-color: #10B981; }
        .task-theme-item.priority-1 { border-left-color: #3B82F6; }
        
        .task-theme-name {
            color: var(--cobre-light);
            font-size: 15px;
            font-weight: 700;
        }
        
        .task-expanded {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .task-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            font-weight: 600;
        }
        
        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .task-detail-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600;
            padding: 4px 8px;
            background: rgba(0, 206, 209, 0.1);
            border-radius: 6px;
        }
        
        .task-tipo {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.2),
                rgba(13, 148, 136, 0.1)
            );
            color: var(--turquesa-light) !important;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 10px;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .task-suggestion {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .task-suggestion::before {
            content: 'üí°';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            animation: lampadaBrilho 2s ease-in-out infinite;
        }
        
        @keyframes lampadaBrilho {
            0%, 100% { 
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            }
            50% { 
                opacity: 0.9;
                filter: drop-shadow(0 0 12px rgba(255, 255, 0, 1)) drop-shadow(0 0 16px rgba(255, 255, 224, 0.8));
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .task-suggestion-label {
            color: var(--turquesa-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        .task-suggestion-text {
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            white-space: pre-line;
            word-break: break-word;
        }
        
        .campos-tempo {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 206, 209, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .campos-tempo.ativo {
            display: block;
        }
        
        .campo-tempo-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .campo-tempo-row:last-child {
            margin-bottom: 0;
        }
        
        .campo-tempo-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .campo-tempo-item label {
            font-size: 10px;
            color: rgba(0, 206, 209, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .campo-tempo-item input {
            padding: 6px 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 4px;
            color: var(--text-light);
        }
        
        .campo-tempo-item input:focus {
            outline: none;
            border-color: rgba(0, 206, 209, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0, 206, 209, 0.5);
            font-size: 15px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 20px rgba(0, 206, 209, 0.3));
        }
        
        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 13px;
            /* CORRE√á√ÉO: Tabela n√£o deve ter altura limitada - mostrar todo conte√∫do */
        }
        
        /* Container de tabela n√£o deve limitar altura */
        .data-table-container,
        div[style*="overflow-x: auto"] {
            max-height: none; /* Sem limite de altura */
            overflow-x: auto; /* Scroll horizontal OK para tabelas */
            overflow-y: visible; /* Mostrar todo conte√∫do verticalmente */
        }
        
        .data-table th {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            color: var(--turquesa-light);
            padding: 12px 8px;
            font-weight: 700;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .data-table td {
            padding: 12px 8px;
            background: rgba(20, 35, 45, 0.3);
            border-top: 1px solid rgba(0, 206, 209, 0.1);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .data-table td:first-child {
            border-left: 1px solid rgba(0, 206, 209, 0.1);
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .data-table td:last-child {
            border-right: 1px solid rgba(0, 206, 209, 0.1);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .data-table tr:hover td {
            background: rgba(0, 206, 209, 0.05);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.1);
        }
        
        /* MESSAGES */
        #importMessage, #feedbackMessage {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
        }
        
        .message {
            background: linear-gradient(135deg,
                rgba(10, 26, 31, 0.95),
                rgba(20, 35, 45, 0.95)
            );
            backdrop-filter: blur(20px);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            animation: slideInMessage 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInMessage {
            from { 
                transform: translateX(120%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            border-left: 4px solid var(--turquesa-neon);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.3);
        }
        
        .message.error {
            border-left: 4px solid var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(255, 127, 80, 0.3);
        }
        
        /* NOTIFICATION ITEMS */
        .notification-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-item.urgent {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .notification-title {
            color: var(--cobre-light);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.5);
        }
        
        .notification-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        
        /* DATE RANGE CONTROLS */
        .date-range-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .date-range-controls .form-input {
            flex: 1;
        }
        
        /* EDIT DATE FORM */
        .edit-date-form {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.05),
                rgba(13, 148, 136, 0.02)
            );
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .edit-date-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .edit-date-row select {
            flex: 2;
        }
        
        .edit-date-row input {
            flex: 1;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.95)
            );
            backdrop-filter: blur(20px);
            border: 1px solid var(--cobre-main);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh; /* Desktop: 80vh */
            overflow-y: auto;
            animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255,255,255,0.9); /* Cor clara para todo texto no modal */
        }
        
        /* Garantir que TODOS os elementos dentro do modal sejam claros */
        .modal-content p,
        .modal-content ul,
        .modal-content li,
        .modal-content strong,
        .modal-content span,
        .modal-content div,
        .modal-content h1,
        .modal-content h2,
        .modal-content h3 {
            color: rgba(255,255,255,0.9) !important;
        }
        
        @keyframes modalSlide {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            font-weight: 800;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--cobre-light);
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .modal-close:hover {
            transform: rotate(90deg);
        }
        
        /* SCROLL BAR CUSTOM */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                var(--turquesa-dark), 
                var(--cobre-dark)
            );
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                var(--turquesa-main), 
                var(--cobre-main)
            );
        }
        /* ==================== SPLASH SCREEN ==================== */
        @keyframes splashFailSafeHide {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 50%, #0a1a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.8s ease-out;
            pointer-events: none; /* FAILSAFE: n√£o bloqueia toques mesmo se JS n√£o executar */
            animation: splashFailSafeHide .6s ease-out 8s forwards; /* Auto-hide ap√≥s 8s se JS n√£o executar */
        }
        
        #splashScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        #splashScreen.hidden {
            display: none;
        }
        
        .splash-logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.3));
            object-fit: contain;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--turquesa-neon);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 224, 0.5);
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .splash-subtitle {
            font-size: 14px;
            color: var(--turquesa-light);
            margin-bottom: 40px;
            opacity: 0.8;
        }
        
        .splash-loader {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .splash-loader::before,
        .splash-loader::after {
            content: '';
            position: absolute;
            border: 3px solid transparent;
            border-top-color: var(--turquesa-neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .splash-loader::before {
            width: 60px;
            height: 60px;
            animation-duration: 1s;
        }
        
        .splash-loader::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border-top-color: var(--cobre-light);
            animation-duration: 0.8s;
            animation-direction: reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .splash-progress {
            width: 200px;
            height: 3px;
            background: rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--turquesa-neon), var(--cobre-light));
            border-radius: 10px;
            width: 0%;
            animation: progressLoad 2s ease-out forwards;
            box-shadow: 0 0 10px rgba(0, 255, 224, 0.6);
        }
        
        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        body.splash-loading {
            /* REMOVIDO overflow: hidden para evitar hard lock se JS n√£o executar */
            /* Classe ainda √© usada pelo JS para controle, mas n√£o bloqueia intera√ß√£o */
            overflow: auto; /* Permite scroll mesmo se JS n√£o executar */
        }
        
        /* ===== NOVOS ESTILOS - REFATORA√á√ÉO v2.0 ===== */
        
        /* Sub-navega√ß√£o dentro de abas */
        .sub-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            width: fit-content;
            margin-bottom: 16px;
        }
        
        .sub-nav-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .sub-nav-btn:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sub-nav-btn.active {
            background: var(--cobre-main);
            color: white;
        }
        
        /* Toggle view (Timeline/Atrasados) */
        .toggle-view {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
            margin-bottom: 16px;
        }
        
        .toggle-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn.active {
            background: var(--turquesa-main);
            color: white;
        }
        
        /* ===== CONFIGURA√á√ïES ===== */
        
        .config-toggle {
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .config-toggle label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .config-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .config-help {
            margin-top: 8px;
            margin-left: 32px;
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        
        .config-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        /* ===== CADERNO - √ÅREAS COLAPS√ÅVEIS ===== */
        
        .area-section {
            margin-bottom: 16px;
        }
        
        .area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.1), rgba(13, 148, 136, 0.05));
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .area-header:hover {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg, rgba(255, 127, 80, 0.1), rgba(255, 127, 80, 0.05));
        }
        
        .area-header.collapsed {
            border-radius: 12px;
            margin-bottom: 0;
        }
        
        .area-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .area-header-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--turquesa-light);
        }
        
        .area-header-count {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            background: rgba(0, 206, 209, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .area-header-toggle {
            font-size: 12px;
            color: var(--turquesa-light);
            transition: transform 0.2s ease;
        }
        
        .area-header.collapsed .area-header-toggle {
            transform: rotate(-90deg);
        }
        
        /* ===== PAINEL VRVS 3P COLAPS√ÅVEL ===== */
        
        /* ===== PAINEL VRVS 3P COLAPS√ÅVEL - REFINADO ===== */
        
        .vrvs3p-card {
            background: rgba(10, 26, 31, 0.95);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .vrvs3p-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s ease;
            margin-bottom: 0;
        }
        
        .vrvs3p-header:hover {
            opacity: 0.9;
        }
        
        .vrvs3p-title {
            font-size: 18px;
            font-weight: 700;
            color: #00CED1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vrvs3p-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .vrvs3p-summary {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        
        .vrvs3p-caret {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
            transition: transform 0.3s ease;
            flex-shrink: 0;
            padding: 4px 8px;
        }
        
        .vrvs3p-body {
            padding-top: 20px;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }
        
        .vrvs3p-card.vrvs3p-collapsed .vrvs3p-body {
            max-height: 0;
            padding-top: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .vrvs3p-card:not(.vrvs3p-collapsed) .vrvs3p-body {
            max-height: 1000px;
            opacity: 1;
        }
        
        .vrvs3p-card.vrvs3p-collapsed .vrvs3p-caret {
            transform: rotate(-90deg);
        }
        
        /* Barra de reten√ß√£o */
        .vrvs3p-barra-container {
            margin-bottom: 16px;
        }
        
        .vrvs3p-barra-track {
            width: 100%;
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }
        
        .vrvs3p-barra-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 0.5s ease, background-color 0.3s ease;
        }
        
        .vrvs3p-barra-fill.baixa { background: #dc3545; }
        .vrvs3p-barra-fill.media { background: #f59e0b; }
        .vrvs3p-barra-fill.alta  { background: #22c55e; }
        
        .vrvs3p-barra-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
        }
        
        .vrvs3p-barra-percent {
            font-weight: 700;
            color: #FFFFFF;
        }
        
        .vrvs3p-barra-status {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }
        
        /* M√©tricas */
        .vrvs3p-metricas {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 20px;
            margin-bottom: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85);
        }
        
        .vrvs3p-metrica {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vrvs3p-metrica-valor {
            font-weight: 700;
            color: #00CED1;
        }
        
        .vrvs3p-metrica-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Mensagem pedag√≥gica */
        .vrvs3p-mensagem-box {
            background: rgba(0, 206, 209, 0.1);
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }
        
        .vrvs3p-mensagem-box.baixa {
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
        }
        
        .vrvs3p-mensagem-box.media {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .vrvs3p-mensagem-box.alta {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .vrvs3p-mensagem-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .vrvs3p-mensagem-emoji {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        /* Disclaimer */
        .vrvs3p-disclaimer {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            margin-top: 8px;
        }
        
        /* Responsivo */
        @media (max-width: 480px) {
            .vrvs3p-card {
                padding: 16px;
            }
            
            .vrvs3p-title {
                font-size: 16px;
            }
            
            .vrvs3p-metricas {
                font-size: 13px;
                gap: 6px 16px;
            }
            
            .vrvs3p-mensagem-box {
                padding: 12px 14px;
            }
            
            .vrvs3p-mensagem-text {
                font-size: 13px;
            }
        }
        
        .area-content {
            padding: 12px 0 0 0;
            overflow-y: auto; /* CORRE√á√ÉO: Permite scroll vertical quando expandido */
            overflow-x: hidden; /* Evita scroll horizontal */
            max-height: 70vh; /* CORRE√á√ÉO: Aumentado de 60vh para ocupar mais espa√ßo quando expandido */
            -webkit-overflow-scrolling: touch; /* CORRE√á√ÉO: Scroll suave no iOS */
            overscroll-behavior: contain; /* CORRE√á√ÉO: Evita scroll escapar para p√°gina externa */
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }
        
        /* Quando expandido (n√£o collapsed), usar mais espa√ßo */
        .area-content:not(.collapsed) {
            min-height: 40vh; /* M√≠nimo 40% da tela quando expandido */
        }
        
        .area-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0;
            overflow: hidden; /* Quando colapsado, n√£o precisa de scroll */
            min-height: 0 !important; /* Remover min-height quando colapsado */
        }
        
        /* ===== GR√ÅFICO LINHA - TOGGLES ===== */
        
        .chart-toggles {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .chart-toggle-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .chart-toggle-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chart-toggle-label input {
            margin: 0;
        }
        
        .chart-toggle-label input:checked + span {
            color: var(--turquesa-light);
        }
        
        /* ===== BOX DE ATEN√á√ÉO NO DI√ÅRIO ===== */
        
        .diario-atencao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,159,64,0.1);
            border-radius: 8px;
            border: 1px solid rgba(255,159,64,0.3);
        }
        
        .diario-atencao-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--cobre-main);
            background: rgba(0,0,0,0.25);
            cursor: pointer;
            accent-color: var(--cobre-main);
        }
        
        .diario-atencao-checkbox:checked {
            background: var(--cobre-main);
            box-shadow: 0 0 0 2px rgba(255,159,64,0.4);
        }
        
        .diario-atencao-label {
            color: var(--cobre-light);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* ===== CONTEXTO DO TEMA ===== */
        
        .contexto-container {
            background: rgba(0, 206, 209, 0.05);
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        
        .contexto-secao {
            margin-bottom: 16px;
        }
        
        .contexto-secao:last-child {
            margin-bottom: 0;
        }
        
        .contexto-secao h4 {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .contexto-item {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            padding: 4px 0;
            cursor: pointer;
        }
        
        .contexto-item:hover {
            color: var(--cobre-light);
        }
        
        /* Hot Topics - sem truncamento */
        .contexto-item-hottopics {
            max-height: none !important;
            overflow: visible !important;
            text-overflow: unset !important;
            -webkit-line-clamp: unset !important;
            line-clamp: unset !important;
            display: block;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .contexto-vazio {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-size: 12px;
        }
        
        /* ===== CADERNO - LISTA DE TEMAS ===== */
        
        .tema-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tema-item {
            background: rgba(20, 35, 45, 0.4);
            border: 1px solid rgba(0, 206, 209, 0.15);
            border-radius: 10px;
            padding: 12px 14px;
            transition: all 0.2s ease;
        }
        
        .tema-item:hover {
            border-color: rgba(255, 127, 80, 0.3);
        }
        
        .tema-item.has-content {
            border-left: 3px solid var(--turquesa-main);
        }
        
        .tema-item.has-hottopics {
            border-left: 3px solid var(--cobre-main);
        }
        
        .tema-item-conteudo {
            max-height: 0;
            overflow: hidden; /* Apenas quando colapsado */
            transition: max-height 0.3s ease-out;
            padding: 0 16px;
        }
        
        .tema-item-conteudo.collapsed {
            display: none;
            max-height: 0;
            overflow: hidden; /* Quando colapsado, esconder */
        }
        
        /* TAREFA 1: Quando expandido, permitir conte√∫do completo sem truncamento */
        .tema-item-conteudo:not(.collapsed) {
            display: block;
            padding: 12px 16px;
            overflow: visible; /* Permitir conte√∫do completo vis√≠vel */
            max-height: none !important; /* Remover qualquer limite de altura quando expandido */
        }
        
        .hottopics-label,
        .conteudo-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--turquesa-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        /* TAREFA 1: Garantir que texto aparece completo sem truncamento */
        .hottopics-text,
        .conteudo-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            white-space: pre-wrap; /* Preservar quebras de linha */
            word-wrap: break-word; /* Quebrar palavras longas */
            overflow: visible; /* Garantir que conte√∫do n√£o √© cortado */
        }
        
        .conteudo-vazio {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            padding: 12px 0;
            text-align: center;
        }
        
        /* ===== AGENDA ATRASADOS - ESTILOS ESPECIAIS ===== */
        
        .atrasados-area {
            margin-bottom: 16px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .atrasados-area-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(255,159,64,0.15);
            border: 1px solid rgba(255,159,64,0.3);
            border-left: 3px solid var(--cobre-main);
            color: var(--cobre-light);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .atrasados-area-header:hover {
            background: rgba(255,159,64,0.25);
        }
        
        .atrasados-area-nome {
            font-weight: 600;
            font-size: 14px;
            color: var(--cobre-light);
        }
        
        .atrasados-area-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255,127,80,0.3);
            color: #FFE4C4;
        }
        
        .atrasados-area-conteudo {
            padding: 8px 10px 12px;
            background: rgba(0,0,0,0.15);
        }
        
        .atrasados-area-conteudo.collapsed {
            display: none;
        }
        
        .task-date-atraso {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        .task-tag-sessoes {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }
        
        .tema-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tema-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--cobre-light);
        }
        
        .tema-item-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.6);
        }
        
        .tema-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .tema-item-btn {
            background: transparent;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .tema-item-btn:hover {
            opacity: 1;
        }
        
        /* ===== CADERNO - HOT TOPICS PREVIEW ===== */
        
        .hottopics-preview {
            background: rgba(255, 127, 80, 0.08);
            border: 1px solid rgba(255, 127, 80, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        
        .hottopics-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 6px;
        }
        
        .hottopics-content {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        /* ===== CADERNO - CONTE√öDO PREVIEW ===== */
        
        /* TAREFA 1: Remover truncamento - conte√∫do completo sempre vis√≠vel no Caderno */
        .conteudo-preview {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            /* Removido max-height e overflow: hidden para mostrar conte√∫do completo */
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative; /* Mantido para compatibilidade, mas sem ::after que cortava */
        }
        
        /* TAREFA 1: Remover efeito de fade que cortava conte√∫do */
        .conteudo-preview::after {
            display: none; /* Desabilitar pseudo-elemento que criava fade e cortava conte√∫do */
        }
        
        /* ===== CADERNO - PLACEHOLDER VAZIO ===== */
        
        .tema-item-empty {
            font-size: 12px;
            color: rgba(0, 206, 209, 0.5);
            font-style: italic;
            cursor: pointer;
            padding: 8px 0;
        }
        
        .tema-item-empty:hover {
            color: var(--cobre-light);
        }
        
        /* ===== PERFORMANCE MOBILE ===== */
        
        @media (max-width: 768px) {
            body::after {
                animation: none;
                opacity: 0.2;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
        /* === HOTFIX iOS - FOR√áAR ESQUERDA NA SESS√ÉO (2025-01-01) === */
        #diarioSessao .diario-sessao-topico,
        #diarioSessao .diario-sessao-topico * {
            text-align: left !important;
        }
        #diarioSessao .diario-sessao-topico {
            width: 100% !important;
            display: block !important;
            align-self: stretch !important;
            white-space: pre-wrap !important;
            overflow-wrap: anywhere !important;
            word-wrap: break-word !important;
        }
        #diarioSessao .diario-sessao-card {
            align-items: stretch !important;
        }
        /* === FIM HOTFIX === */
        
        /* ========================================
           RAW FASE 2.1 (V2 COMPAT√çVEL) - Visualiza√ß√£o VRVS 3P
           Refinamento visual + Progressive Enhancement (iPhone safe)
           Mant√©m classes existentes: .srs-* e .modal-srs-*
           ======================================== */

        /* -----------------------------
           BADGE (card do Di√°rio)
           ----------------------------- */
        .srs-badge {
            flex-shrink: 0;
            flex-grow: 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
            margin-top: 8px;
            border: 1px solid rgba(0, 206, 209, 0.28);
            background: rgba(0, 206, 209, 0.12);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.22);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .srs-badge:hover {
            background: rgba(0, 206, 209, 0.18);
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.28);
        }

        .srs-badge:active {
            transform: translateY(0);
        }

        .srs-estrelas {
            letter-spacing: 1px;
            font-weight: 900;
        }

        .srs-taxa {
            color: rgba(255, 255, 255, 0.85);
            font-weight: 700;
        }

        .srs-icone-detalhe {
            color: var(--turquesa-light);
            font-size: 14px;
            opacity: 0.95;
        }

        /* Cores por est√°gio (mantidas) */
        .srs-estagio-0 { border-color: #ff4444; background: rgba(255, 68, 68, 0.12); }
        .srs-estagio-1 { border-color: #ff8800; background: rgba(255, 136, 0, 0.12); }
        .srs-estagio-2 { border-color: #ffcc00; background: rgba(255, 204, 0, 0.12); }
        .srs-estagio-3 { border-color: #88cc00; background: rgba(136, 204, 0, 0.12); }
        .srs-estagio-4 { border-color: #44bb44; background: rgba(68, 187, 68, 0.12); }
        .srs-estagio-5 { border-color: #00aa00; background: rgba(0, 170, 0, 0.12); }

        /* Pequeno "glow" por est√°gio (suave, sem exagero) */
        .srs-badge.srs-estagio-0 { box-shadow: 0 10px 26px rgba(255, 68, 68, 0.12); }
        .srs-badge.srs-estagio-1 { box-shadow: 0 10px 26px rgba(255, 136, 0, 0.12); }
        .srs-badge.srs-estagio-2 { box-shadow: 0 10px 26px rgba(255, 204, 0, 0.10); }
        .srs-badge.srs-estagio-3 { box-shadow: 0 10px 26px rgba(136, 204, 0, 0.10); }
        .srs-badge.srs-estagio-4 { box-shadow: 0 10px 26px rgba(68, 187, 68, 0.10); }
        .srs-badge.srs-estagio-5 { box-shadow: 0 10px 26px rgba(0, 170, 0, 0.10); }

        /* Progressive enhancement: se existir .srs-taxa dentro do badge, ajustar alinhamento */
        @supports selector(:has(*)) {
            .srs-badge:has(.srs-taxa) {
                gap: 10px;
            }
        }

        /* -----------------------------
           MODAL (overlay + content)
           ----------------------------- */
        .modal-srs-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.70);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Fallback para browsers sem backdrop-filter */
        @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
            .modal-srs-overlay {
                background: rgba(0, 0, 0, 0.85);
            }
        }

        .modal-srs-overlay.active {
            display: flex;
        }

        .modal-srs-content {
            background: linear-gradient(135deg, #13262c 0%, #09161a 100%);
            border-radius: 18px;
            max-width: 420px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid rgba(0, 206, 209, 0.28);
            box-shadow: 0 22px 70px rgba(0, 0, 0, 0.55);
        }

        .modal-srs-header {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.10);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(10, 26, 31, 0.88);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1;
        }

        @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
            .modal-srs-header {
                background: rgba(10, 26, 31, 0.95);
            }
        }

        .modal-srs-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 900;
            letter-spacing: 0.3px;
            color: var(--turquesa-light);
        }

        .modal-srs-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.65);
            font-size: 26px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            transition: background 0.15s ease, color 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-srs-close:hover {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.10);
        }

        .modal-srs-body {
            padding: 18px;
            padding-bottom: calc(18px + env(safe-area-inset-bottom));
        }

        /* -----------------------------
           RESUMO
           ----------------------------- */
        .srs-resumo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .srs-resumo-item {
            background: rgba(0, 0, 0, 0.28);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .srs-resumo-item.full-width {
            grid-column: 1 / -1;
        }

        .srs-resumo-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.55);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            font-weight: 800;
        }

        .srs-resumo-valor {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
        }

        .srs-resumo-valor.estrelas {
            letter-spacing: 2px;
        }

        /* -----------------------------
           HIST√ìRICO
           ----------------------------- */
        .srs-historico-titulo {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.65);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 900;
        }

        .srs-historico-lista {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .srs-historico-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.22);
            border-radius: 12px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .srs-historico-data {
            color: rgba(255, 255, 255, 0.55);
            min-width: 56px;
            font-weight: 700;
        }

        .srs-historico-resposta {
            min-width: 88px;
            font-weight: 900;
        }

        .srs-historico-resposta.esqueci { color: #ff6b6b; }
        .srs-historico-resposta.lembrei { color: #4ecdc4; }
        .srs-historico-resposta.facil { color: #95e77e; }

        .srs-historico-transicao {
            color: rgba(255, 255, 255, 0.45);
            font-size: 12px;
            font-weight: 700;
        }

        .srs-historico-vazio {
            text-align: center;
            color: rgba(255, 255, 255, 0.45);
            padding: 18px 10px;
            font-style: italic;
        }

        /* -----------------------------
           RESPONSIVO (iPhone)
           ----------------------------- */
        @media (max-width: 480px) {
            .modal-srs-content {
                max-height: 90vh;
                margin: 10px;
            }

            .srs-resumo {
                grid-template-columns: 1fr;
            }

            .srs-resumo-item.full-width {
                grid-column: 1;
            }
        }

        /* ========================================
           FIM RAW FASE 2.1 (V2 COMPAT√çVEL)
           ======================================== */
        
        /* ==================== MODO AVAN√áADO - RANGE SLIDER ==================== */
        #novaDiarioNotaDesempenho {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        #novaDiarioNotaDesempenho::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #fff, rgba(255,184,77,0.8));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        #novaDiarioNotaDesempenho::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #fff, rgba(255,184,77,0.8));
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        /* ==================== FIM MODO AVAN√áADO RANGE ==================== */
    </style>
</head>
<body class="splash-loading">
    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <img src="./logo.png?v=3" alt="VRVS Logo" class="splash-logo" onerror="this.onerror=null; this.src='./logo.jpeg?v=3';">
        <div class="splash-title">VRVS</div>
        <div class="splash-subtitle">Sistema de Revis√£o e Performance</div>
        <div id="bootMarkerQuota" style="position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); font-size: 13px; color: #ff6b6b; font-family: monospace; z-index: 10003; text-align: center; font-weight: 700; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 6px; display: none;">ERR: QUOTA ‚Üí Recovery</div>
        <div class="splash-loader"></div>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>
    
    <div id="importMessage"></div>
    <div id="feedbackMessage"></div>
    
    <!-- Bot√£o flutuante de salvar (sempre vis√≠vel) -->
    <button class="btn-save-floating" onclick="salvarDadosManualmente()" title="Salvar todos os dados">
        üíæ SALVAR
    </button>
    
    <!-- MODAL DE EDI√á√ÉO -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è EDITAR TEMA</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">√Årea</label>
                    <select class="form-select" id="editArea" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tema</label>
                    <input type="text" class="form-input" id="editTema" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-input" id="editPrioridade" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="Planejado">Planejado</option>
                        <option value="Em estudo">Em estudo</option>
                        <option value="Suspenso">Suspenso</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                </div>
                <button type="submit" class="btn">üíæ SALVAR ALTERA√á√ïES</button>
            </form>
        </div>
    </div>
    
    <!-- BOT√ÉO FLUTUANTE DE AJUDA -->
    <div id="btnAjudaFlutuanteContainer" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    ">
        <button id="btnAjudaFlutuante" onclick="showSection('tutorial', event)" style="
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--turquesa-main), var(--turquesa-dark));
            border: 2px solid var(--turquesa-light);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            ‚ùì
        </button>
        <button id="btnFecharTutorial" onclick="ocultarBotaoTutorial()" style="
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Fechar tutorial">
            √ó
        </button>
    </div>
    
    <!-- MODAL TUTORIAL INTERATIVO -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="tutorialTitulo">üéØ Tour Guiado - VRVS</h2>
                <button class="modal-close" onclick="fecharTutorial()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(95vh - 150px);">
                <div id="tutorialConteudo" style="min-height: 200px; word-wrap: break-word; overflow-wrap: break-word;">
                    <!-- Conte√∫do din√¢mico do tutorial -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-secondary" onclick="pularTutorial()">Pular Tutorial</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btnAnterior" onclick="tutorialAnterior()">‚óÄ Anterior</button>
                        <button class="btn" id="btnProximo" onclick="tutorialProximo()">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                <div id="tutorialProgresso" style="margin-top: 15px; text-align: center; font-size: 12px; color: rgba(0,206,209,0.7);">
                    <!-- Passo X de Y -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVA ENTRADA DI√ÅRIO -->
    <div id="modalNovaDiario" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è NOVA ENTRADA</h2>
                <button class="modal-close" onclick="fecharModalDiario()">√ó</button>
            </div>
            
            <div class="modal-body">
                <input type="hidden" id="novaDiarioId">
                
                <div class="form-group">
                    <label class="form-label">üìÖ Data</label>
                    <input type="date" class="form-input" id="novaDiarioData">
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label class="form-label">√Årea</label>
                        <select class="form-select" id="novaDiarioArea" onchange="atualizarTemasDiario(this.value)">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label class="form-label">Tema</label>
                        <select class="form-select" id="novaDiarioTema">
                            <option value="">Selecione uma √°rea primeiro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‚ùì T√≥pico / Pergunta</label>
                    <textarea id="novaDiarioTopico" 
                        class="form-textarea" 
                        rows="3" 
                        style="min-height: 80px; resize: vertical; overflow-y: auto;"
                        placeholder="Ex: Em que n√≠vel se encerra o cone medular?"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì∑ Imagem da Pergunta/T√≥pico (opcional)</label>
                    <input type="file" id="novaDiarioImagemPergunta" accept="image/*" style="display: none;" onchange="diario_processarImagemPergunta(event)">
                    <div id="novaDiarioImagemPerguntaPreview" style="display: none; margin-top: 10px;">
                        <img id="novaDiarioImagemPerguntaThumb" src="" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="diario_removerImagemPergunta()" style="font-size: 12px; padding: 8px 16px;">üóëÔ∏è Remover imagem</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('novaDiarioImagemPergunta').click()" id="novaDiarioImagemPerguntaBtn" style="margin-top: 8px;">
                        üì∑ Adicionar imagem
                    </button>
                    <div id="novaDiarioImagemPerguntaStatus" style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; font-style: italic;">
                        üì∑ imagem: ‚Äî
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‚úÖ Resposta</label>
                    <textarea class="form-textarea" id="novaDiarioResposta" rows="8" placeholder="Ex: Gradua em est√°gios evolutivos a artrose p√≥s meniscectomia..." style="min-height: 250px; overflow-y: auto;"></textarea>
                </div>
                
                <!-- P1 DEBUG START - Bot√£o toggle debug (remov√≠vel) -->
                <div style="margin-top: 12px; text-align: right;">
                    <button type="button" 
                            id="p1-debug-toggle" 
                            onclick="toggleP1DebugCaret()"
                            style="background: rgba(0, 206, 209, 0.2); 
                                   border: 1px solid rgba(0, 206, 209, 0.4); 
                                   color: var(--cobre-main); 
                                   padding: 6px 12px; 
                                   border-radius: 6px; 
                                   font-size: 12px; 
                                   cursor: pointer;">
                        üêû Debug Caret
                    </button>
                </div>
                <!-- P1 DEBUG END -->
                
                <!-- P1 DEBUG START - Debug pill (remov√≠vel) -->
                <div id="p1-debug-caret-pill"></div>
                <!-- P1 DEBUG END -->
                
                <div class="form-group">
                    <label class="form-label">üì∑ Imagem (opcional)</label>
                    <input type="file" id="novaDiarioImagem" accept="image/*" style="display: none;" onchange="diario_processarImagem(event)">
                    <div id="novaDiarioImagemPreview" style="display: none; margin-top: 10px;">
                        <img id="novaDiarioImagemThumb" src="" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="diario_removerImagem()" style="font-size: 12px; padding: 8px 16px;">üóëÔ∏è Remover imagem</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('novaDiarioImagem').click()" id="novaDiarioImagemBtn" style="margin-top: 8px;">
                        üì∑ Adicionar imagem
                    </button>
                    <div id="novaDiarioImagemStatus" style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; font-style: italic;">
                        üì∑ imagem: ‚Äî
                    </div>
                </div>
                
                <div id="diarioDesempenhoMount"></div>
                
                <div class="diario-atencao-container">
                    <input
                        type="checkbox"
                        id="novaDiarioAtencao"
                        class="diario-atencao-checkbox"
                    >
                    <label for="novaDiarioAtencao" class="diario-atencao-label">
                        üìÖ Incluir nas revis√µes programadas (VRVS 3P)
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn nivel-3-ambar" onclick="(async () => { await salvarEntradaDiario(); })()" style="flex: 1; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">üíæ SALVAR</button>
                    <button type="button" class="btn nivel-2-turquesa" onclick="(async () => { await salvarEContinuarDiario(); })()" style="flex: 1; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">‚ûï SALVAR E ADICIONAR OUTRA</button>
                </div>
                
                <div id="btnExcluirEntradaWrapper" style="display: none; margin-top: 16px;">
                    <button type="button" class="btn nivel-2-vermelho" onclick="confirmarExcluirEntradaDiario()" style="width: 100%; font-weight: 800; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                        üóëÔ∏è Apagar este card
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMAR EXCLUS√ÉO DI√ÅRIO (PATCH 4) -->
    <div id="modalConfirmarExclusaoDiario" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ö†Ô∏è Confirmar exclus√£o</h2>
                <button class="modal-close" onclick="fecharModalConfirmarExclusaoDiario()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este card?</p>
                <p id="previewExclusaoDiario" style="font-size: 12px; color: rgba(255,255,255,0.90); margin-top: 8px; font-style: italic;"></p>
                <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                    Esta a√ß√£o n√£o pode ser desfeita.
                </p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn" onclick="fecharModalConfirmarExclusaoDiario()" style="flex: 1;">Cancelar</button>
                <button class="btn btn-danger" onclick="executarExcluirEntradaDiario()" style="flex: 1; background: rgba(239, 68, 68, 0.2); border-color: #EF4444; color: #FFFFFF;">üóëÔ∏è Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL ENCERRAR SESS√ÉO -->
    <div id="encerrarSessaoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Resumo da Sess√£o</h2>
                <button class="modal-close" onclick="closeEncerrarSessaoModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,206,209,0.3);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo Total</div>
                            <div id="modalTempoTotal" style="font-size: 20px; font-weight: bold; color: #00FFE0;">00:00:00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Intervalos</div>
                            <div id="modalNumIntervalos" style="font-size: 20px; font-weight: bold; color: #00FFE0;">0</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Tempo Total de Intervalos</div>
                        <div id="modalTempoIntervalos" style="font-size: 16px; font-weight: bold; color: #FFA366;">0 min</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">üìù Preencha os dados da sess√£o:</div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Tempo em Quest√µes (min)</label>
                        <input type="number" class="form-input" id="modalTempoQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Quantidade de Quest√µes</label>
                        <input type="number" class="form-input" id="modalQuantQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">üÉè Tempo em Flashcards (min)</label>
                        <input type="number" class="form-input" id="modalTempoFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">üÉè Quantidade de Flashcards</label>
                        <input type="number" class="form-input" id="modalQuantFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="preencherDadosSessao()" style="flex: 1;">‚úÖ Preencher Formul√°rio</button>
                    <button class="btn btn-secondary" onclick="closeEncerrarSessaoModal()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE ATUALIZA√á√ÉO -->
    <div id="modalAtualizacao" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="atualizacaoTitulo">üéâ Nova Vers√£o Dispon√≠vel!</h2>
                <button class="modal-close" onclick="fecharModalAtualizacao()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="atualizacaoConteudo"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="iniciarTutorialAtualizacao()" style="flex: 1;">üéØ Ver Tutorial</button>
                    <button class="btn btn-secondary" onclick="fecharModalAtualizacao()" style="flex: 1;">Pular</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL EDITAR ANOTA√á√ÉO (CADERNO V2) -->
    <div id="modalEditarAnotacao" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üìù EDITAR ANOTA√á√ÉO</h2>
                <button class="modal-close" onclick="fecharModalAnotacao()">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                <input type="hidden" id="editAnotacaoTemaId">
                
                <!-- Info do tema -->
                <div style="margin-bottom: 20px; padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                    <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 4px;">TEMA</div>
                    <div id="editAnotacaoTema" style="font-size: 16px; font-weight: 600; color: var(--cobre-light);"></div>
                    <div id="editAnotacaoArea" style="font-size: 12px; color: rgba(255,255,255,0.6);"></div>
                </div>
                
                <!-- Hot Topics -->
                <div class="form-group">
                    <label class="form-label" style="color: var(--cobre-light);">üî• Hot Topics (pontos de prova)</label>
                    <textarea class="form-textarea" id="editAnotacaoHotTopics" rows="5" 
                        placeholder="1) Classifica√ß√£o de Wiltze&#10;2) T√©cnica de Gill&#10;3) Cl√≠nica do adolescente..."
                        style="background: rgba(255,127,80,0.05); border-color: rgba(255,127,80,0.3); min-height: 120px; overflow-y: auto;"></textarea>
                    <div style="font-size: 11px; color: rgba(255,127,80,0.7); margin-top: 5px;">
                        üí° Liste os pontos que mais caem na prova
                    </div>
                </div>
                
                <!-- Anota√ß√µes Gerais -->
                <div class="form-group">
                    <label class="form-label">üìù Anota√ß√µes Gerais</label>
                    <textarea class="form-textarea" id="editAnotacaoConteudo" rows="6" 
                        placeholder="Suas anota√ß√µes sobre o tema..." style="min-height: 150px; overflow-y: auto;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="salvarAnotacaoModal()" style="flex: 1;">üíæ SALVAR</button>
                    <button class="btn btn-secondary" onclick="fecharModalAnotacao()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVA √ÅREA -->
    <div id="modalNovaArea" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï NOVA √ÅREA</h2>
                <button class="modal-close" onclick="fecharModalNovaArea()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="formNovaArea" onsubmit="salvarNovaArea(event)">
                    <div class="form-group">
                        <label class="form-label">Nome da √Årea</label>
                        <input type="text" class="form-input" id="inputNovaAreaNome" placeholder="Ex: Nova √Årea de Estudo" required autofocus>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn" style="flex: 1; background: var(--cobre-main);">‚úÖ ADICIONAR</button>
                        <button type="button" class="btn btn-secondary" onclick="fecharModalNovaArea()" style="flex: 1;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL CADASTRO DE TEMA -->
    <div id="modalCadastro" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï ADICIONAR TEMA</h2>
                <button class="modal-close" onclick="fecharModalCadastro()">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                <form id="modalCadastroForm" onsubmit="salvarNovoTemaModal(event)">
                    <div class="form-group">
                        <label class="form-label">√Årea de Conhecimento</label>
                        <select class="form-select" id="modalCadastroArea" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tema Espec√≠fico</label>
                        <input type="text" class="form-input" id="modalNovoTema" placeholder="Ex: Sd manguito rotador" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridade (1-5)</label>
                        <input type="number" class="form-input" id="modalNovaPrioridade" min="1" max="5" value="3" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de In√≠cio (opcional)</label>
                        <input type="date" class="form-input" id="modalNovaDataInicio">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" style="flex: 1;">‚úÖ ADICIONAR</button>
                        <button type="button" class="btn btn-secondary" onclick="fecharModalCadastro()" style="flex: 1;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-title">üß† VRVS CIRCUIT TECH</div>
            <div class="header-subtitle">Sistema de Gest√£o de Estudos ‚Ä¢ <span id="vrvsBuildDisplay">v5.3.191</span></div>
        </div>
        
        <div class="tabs">
            <!-- ESTUDO (uso di√°rio) -->
            <div class="tab" onclick="showSection('tarefa', event)">üìã Tarefa</div>
            <div class="tab" onclick="showSection('feedback', event)">üìù Feedback</div>
            <div class="tab" id="tabDiario" onclick="showSection('diario', event)">üìî Di√°rio</div>
            <div class="tab" onclick="showSection('caderno', event)">üìì Caderno</div>
            <div class="tab" onclick="showSection('mindmaps', event)">üß† Mapas</div>
            <!-- PLANEJAMENTO -->
            <div class="tab" onclick="showSection('agenda', event)">üìÖ Agenda</div>
            <div class="tab active" onclick="showSection('dados', event)">üìä Dados</div>
            <!-- AN√ÅLISE -->
            <div class="tab" onclick="showSection('analytics', event)">üìà An√°lises</div>
            <!-- SISTEMA -->
            <div class="tab" onclick="showSection('backup', event)">üíæ Backup</div>
            <div class="tab" onclick="showSection('ajuda', event)">‚ùì Ajuda</div>
            <div class="tab" onclick="showSection('config', event)">‚öôÔ∏è Config</div>
        </div>
        
        <div class="content">
            <!-- DADOS -->
            <div id="dados" class="section active">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>üìä BANCO DE DADOS</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-small" onclick="abrirModalNovaArea()" style="background: var(--cobre-main);">‚ûï Nova √Årea</button>
                            <button class="btn btn-small" onclick="abrirModalCadastro()" style="background: var(--cobre-main);">‚ûï Novo Tema</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-small" onclick="salvarDadosManualmente()" style="background: rgba(0, 206, 209, 0.15); color: rgba(0, 206, 209, 0.8); border: 1px solid rgba(0, 206, 209, 0.3); font-weight: 500;">
                            üíæ Salvar
                        </button>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">
                            üí° Dados salvam automaticamente
                        </div>
                    </div>
                    
                    <!-- GERENCIAR √ÅREAS & TEMAS (SPEC OPUS) -->
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(0,206,209,0.05); border: 1px solid rgba(0,206,209,0.2); border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="color: var(--turquesa-light); font-size: 16px; font-weight: 600; margin: 0;">üß† Gerenciar √Åreas & Temas</h3>
                            <button id="btnAbrirGerenciador" class="btn btn-small" onclick="toggleGerenciadorAreasTemas()" style="background: var(--cobre-main); color: white; border: none;">
                                Abrir gerenciador
                            </button>
                        </div>
                        <div id="gerenciadorAreasTemas" style="display: none;">
                            <input type="text" 
                                   id="buscaAreasTemas" 
                                   class="form-input" 
                                   placeholder="üîç Buscar √°rea ou tema..." 
                                   oninput="filtrarAreasTemas()"
                                   style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                            <div id="areasTemasLista">
                                <!-- Renderizado dinamicamente -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√Årea</th>
                                    <th>Tema</th>
                                    <th>Status</th>
                                    <th>Prior.</th>
                                    <th>Rend.</th>
                                    <th>Sess√µes</th>
                                    <th>√ölt.Estudo</th>
                                    <th>Agenda</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="dadosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- TAREFA -->
            <div id="tarefa" class="section">
                <div class="card">
                    <div class="card-title">
                        <span>üìã TAREFAS DO DIA</span>
                    </div>
                    <div id="tarefasContainer"></div>
                </div>
            </div>
            
            <!-- AGENDA (inclui Pend√™ncias) -->
            <div id="agenda" class="section">
                <div class="card">
                    <div class="card-title">üìÖ AGENDA E ALERTAS</div>
                    
                    <!-- Toggle: Timeline vs Atrasados -->
                    <div class="toggle-view">
                        <button class="toggle-btn active" id="btnTimeline" onclick="setVistaAgenda('timeline')">üìÖ Timeline</button>
                        <button class="toggle-btn" id="btnAtrasados" onclick="setVistaAgenda('atrasados')">üîî Atrasados</button>
                    </div>
                    
                    <!-- Filtros (s√≥ aparece em Timeline) -->
                    <div id="agendaFiltros" class="edit-date-row" style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="date" id="agendaDataInicio" class="form-input" style="flex: 1; max-width: 180px;">
                        <input type="date" id="agendaDataFim" class="form-input" style="flex: 1; max-width: 180px;">
                        <button class="btn btn-small" onclick="filtrarSemanaAtual()">üìÖ Semana</button>
                        <button class="btn btn-small btn-secondary" onclick="renderAgendaUnificada()">Aplicar</button>
                    </div>
                    
                    <!-- Container √∫nico -->
                    <div id="agendaContainer"></div>
                </div>
            </div>

            <!-- PEND√äNCIAS (mantido para compatibilidade, oculto) -->
            <div id="pendencias" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üîî ALERTAS DO SISTEMA</div>
                    <div id="pendenciasContainer"></div>
                </div>
            </div>
            
            <!-- CADASTRO (mantido para compatibilidade, oculto - usar modal) -->
            <div id="cadastro" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">‚ûï ADICIONAR TEMA</div>
                    <form id="cadastroForm">
                        <div class="form-group">
                            <label class="form-label">√Årea de Conhecimento</label>
                            <select class="form-select" id="novaArea" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tema Espec√≠fico</label>
                            <input type="text" class="form-input" id="novoTema" placeholder="Ex: Sd manguito rotador" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√≠vel de Prioridade</label>
                            <input type="number" class="form-input" id="novaPrioridade" min="1" max="5" value="3" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="novaStatus">
                                <option value="Planejado">Planejado</option>
                                <option value="Em estudo">Em estudo</option>
                                <option value="Suspenso">Suspenso</option>
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de In√≠cio</label>
                            <input type="date" class="form-input" id="novaDataInicio">
                        </div>
                        <button type="submit" class="btn">‚úÖ ADICIONAR TEMA</button>
                    </form>
                </div>
            </div>
            
            <!-- FEEDBACK -->
            <div id="feedback" class="section">
                <div class="card">
                    <div class="card-title">üìù REGISTRAR PERFORMANCE</div>
                    
                    <!-- CRON√îMETRO DA SESS√ÉO -->
                    <div id="cronometroContainer" style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo da Sess√£o</div>
                                <div id="cronometroDisplay" style="font-size: 28px; font-weight: bold; color: #00FFE0; font-family: 'Courier New', monospace;">00:00:00</div>
                                <div id="tempoIntervaloTotal" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                    ‚è∏Ô∏è Intervalo acumulado: <span id="tempoIntervaloTotalDisplay">0 min</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button id="cronometroToggle" class="btn btn-small" onclick="toggleCronometro()">‚è±Ô∏è Iniciar Cron√¥metro</button>
                                <button id="cronometroPausa" class="btn btn-small" onclick="pausarCronometro()">‚è∏Ô∏è Pausar</button>
                                <button id="cronometroIntervalo" class="btn btn-small" onclick="iniciarIntervalo()">‚è∏Ô∏è Intervalo</button>
                                <button id="cronometroReset" class="btn btn-small" onclick="resetCronometro()">üîÑ Resetar</button>
                                <button id="cronometroEncerrar" class="btn btn-small" onclick="encerrarSessao()" style="background: rgba(0,206,209,0.2); color: #00FFE0; border: 1px solid rgba(0,206,209,0.4);">‚úÖ Encerrar Sess√£o</button>
                            </div>
                            <div id="tempoIntervalo" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                ‚è∏Ô∏è Em intervalo: <span id="tempoIntervaloDisplay">0 min</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label class="form-label">√Årea</label>
                            <select class="form-select" id="feedbackArea" onchange="updateFeedbackTemaSelect()">
                                <option value="">Selecione a √°rea...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√≥dulo Estudado</label>
                            <select class="form-select" id="feedbackTema" required>
                                <option value="">Selecione o m√≥dulo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data da Sess√£o</label>
                            <input type="date" class="form-input" id="feedbackData" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Performance (%)</label>
                            <input type="number" class="form-input" id="feedbackRendimento" min="0" max="100" placeholder="0-100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dura√ß√£o (min)</label>
                            <input type="number" class="form-input" id="feedbackTempo" min="0" placeholder="Minutos (opcional)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìä Intervalos (opcional)</label>
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                <input type="number" class="form-input" id="feedbackNumeroIntervalos" min="0" placeholder="N√∫mero de pausas" value="0">
                                <input type="text" class="form-input" id="feedbackIntervalos" placeholder="Ex: 00:05:00, 00:03:30" style="font-size: 12px;">
                            </div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Use o bot√£o "Encerrar Sess√£o" no cron√¥metro para preencher automaticamente
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‚ùì Quest√µes (opcional)</label>
                            <input type="text" class="form-input" id="feedbackQuestoes" placeholder="Ex: 15/20 (acertos/total)" pattern="[0-9]+/[0-9]+">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Formato: acertos/total (ex: 17/20)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üÉè Flashcards (opcional)</label>
                            <input type="number" class="form-input" id="feedbackFlashcards" min="0" placeholder="Quantidade revisada">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Quantidade de flashcards revisados na sess√£o
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diretriz Pr√≥xima Sess√£o</label>
                            <textarea class="form-textarea" id="feedbackSugestao" rows="4" placeholder="Ex: Revisar flashcards + quest√µes" style="min-height: 100px; overflow-y: auto;"></textarea>
                        </div>
                        <button type="submit" class="btn">‚úÖ SALVAR PERFORMANCE</button>
                    </form>
                    <button class="btn btn-danger" onclick="desfazerUltimoFeedback()">‚Ü©Ô∏è DESFAZER √öLTIMO</button>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div id="stats" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISES</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTemas">0</div>
                            <div class="stat-label">M√≥dulos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessoes">0</div>
                            <div class="stat-label">Sess√µes Totais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRendimento">0%</div>
                            <div class="stat-label">Performance M√©dia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTempo">0h</div>
                            <div class="stat-label">Tempo Investido</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statQuestoes">0</div>
                            <div class="stat-label">Quest√µes Resolvidas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statFlashcards">0</div>
                            <div class="stat-label">Flashcards Revisados</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìà VISUALIZA√á√ïES</div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartBarras" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <div id="chartLinhaControles" class="chart-toggles"></div>
                        <canvas id="chartLinha" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartRadar" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- AN√ÅLISES DETALHADAS -->
            <div id="analises" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üîç AN√ÅLISES DETALHADAS</span>
                        <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px; padding: 6px 12px;">
                            <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar An√°lises de Tempo</span>
                        </button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                                <option value="">Todos os temas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Per√≠odo</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                                <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">Semana Atual</button>
                                <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">M√™s Atual</button>
                                <button class="btn btn-small" onclick="limparFiltrosAnalise()">Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analiseResultados" style="margin-top: 30px;">
                        <!-- Resultados ser√£o renderizados aqui -->
                    </div>
                    
                    <div id="analiseTempo" style="display: none; margin-top: 30px;">
                        <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- HIST√ìRICO -->
            <div id="historico" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìú REGISTRO COMPLETO</div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tema</th>
                                    <th>√Årea</th>
                                    <th>Rend.</th>
                                    <th>Tempo</th>
                                    <th>Diretriz</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISE POR PER√çODO</div>
                    <div class="date-range-controls">
                        <input type="date" class="form-input" id="relatorioDataInicio">
                        <input type="date" class="form-input" id="relatorioDataFim">
                        <button class="btn btn-small" onclick="gerarRelatorio()">Gerar</button>
                    </div>
                    <div id="relatorioResultado"></div>
                    <button class="btn btn-secondary" onclick="exportarRelatorioPeriodo()" style="display:none; margin-top: 20px;" id="btnExportarRelatorio">
                        üì• Exportar Per√≠odo
                    </button>
                </div>
            </div>
            
            <!-- IMPORTAR -->
            <!-- Se√ß√£o antiga removida - importa√ß√£o agora est√° na aba Backup -->
            
            <!-- EXPORTAR -->
            <div id="exportar" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">üì§ BACKUP DE DADOS</div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="margin-bottom: 12px;">üíæ SALVAR DADOS AGORA</button>
                        <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 20px;">
                            üí° Salva todos os dados no navegador (dados, hist√≥rico, lembretes, anota√ß√µes)
                        </div>
                    </div>
                    <div class="card-title" style="margin-top: 30px; margin-bottom: 15px; font-size: 14px;">üìä EXPORTAR PARA ARQUIVO</div>
                    <button class="btn btn-secondary" onclick="exportarDados()">üìä Baixar DADOS.csv</button>
                    <button class="btn btn-secondary" onclick="exportarHistorico()" style="margin-top: 12px;">üìú Baixar HISTORICO.csv</button>
                    <button class="btn btn-secondary" onclick="exportarAnotacoes()" style="margin-top: 12px;">üìî Baixar ANOTACOES.csv</button>
                </div>
            </div>
            
            <!-- TUTORIAL E AJUDA -->
            <div id="tutorial" class="section" style="display: none;">
                <div class="card">
                    <div class="card-title">‚ùì TUTORIAL E AJUDA</div>
                    
                    <!-- V√≠deo Tutorial -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìπ V√≠deo Explicativo</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2); text-align: center;">
                            <div id="videoTutorialContainer">
                                <div id="videoAnimado" style="background: linear-gradient(135deg, rgba(0,206,209,0.1), rgba(13,148,136,0.05)); border-radius: 8px; padding: 20px; min-height: 400px; position: relative; overflow: hidden;">
                                    <div id="videoSlide" style="text-align: center; padding: 20px;">
                                        <!-- Slides ser√£o inseridos aqui dinamicamente -->
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;">
                                        <button class="btn btn-small" onclick="videoAnterior()" id="btnVideoAnterior" style="font-size: 12px;">‚óÄ Anterior</button>
                                        <button class="btn btn-small" onclick="videoProximo()" id="btnVideoProximo" style="font-size: 12px;">Pr√≥ximo ‚ñ∂</button>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px; font-size: 12px; color: rgba(0,206,209,0.7);">
                                        <span id="videoProgresso">1 / 6</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tour Guiado -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado Interativo</h3>
                        <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                            Um guia passo a passo por todas as funcionalidades
                        </p>
                    </div>
                    
                    <!-- Assistente de D√∫vidas -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üí¨ Assistente de D√∫vidas</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                            <input type="text" id="perguntaAssistente" class="form-input" placeholder="Digite sua d√∫vida aqui... Ex: Como adicionar um tema?" style="margin-bottom: 15px;">
                            <button class="btn btn-secondary" onclick="responderDuvida()">üîç Buscar Resposta</button>
                            <div id="respostaAssistente" style="margin-top: 20px; display: none;">
                                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--turquesa-light);">
                                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                                    <div id="textoResposta" style="color: var(--text-light); font-size: 14px; line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ R√°pido -->
                    <div>
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Perguntas Frequentes</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-small" onclick="mostrarResposta('adicionar')" style="text-align: left; justify-content: flex-start;">‚ùì Como adicionar um tema?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('feedback')" style="text-align: left; justify-content: flex-start;">‚ùì Como registrar uma sess√£o de estudos?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('agenda')" style="text-align: left; justify-content: flex-start;">‚ùì Como usar a agenda?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('stats')" style="text-align: left; justify-content: flex-start;">‚ùì Como ver minhas estat√≠sticas?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('backup')" style="text-align: left; justify-content: flex-start;">‚ùì Como fazer backup dos dados?</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DI√ÅRIO -->
            <div id="diario" class="section">
                <div class="card">
                    <div class="card-title diario-header-row">
                        <div class="diario-header-left">
                        <span>üìî DI√ÅRIO DE APRENDIZADOS</span><span id="diarioBadgeAvancadoMount"></span>
                            <div id="vrvs3p-chip-diario" onclick="irParaPainelVrvs3p(); event.stopPropagation();">
                                üß† <span id="vrvs3p-chip-text">Carregando...</span>
                            </div>
                        </div>
                        <button onclick="abrirNovaEntradaDiario()" id="btnNovaDiario" class="btn-nova-diario" style="background: #FF9F40 !important; color: #FFFFFF !important; border: 2px solid #FFB84D !important; padding: 10px 18px !important; border-radius: 8px !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; min-width: 90px !important; box-shadow: 0 2px 8px rgba(255, 159, 64, 0.4) !important; transition: all 0.2s ease; display: inline-block !important; position: relative !important; z-index: 10 !important; -webkit-tap-highlight-color: rgba(255, 159, 64, 0.5); text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important; opacity: 1 !important; visibility: visible !important;">+ Nova</button>
                    </div>
                    
                    <!-- Box Modo Avan√ßado -->
                    <div id="diarioModoAvancadoBox" style="background: linear-gradient(135deg, rgba(255,184,77,0.1), rgba(255,184,77,0.05)); border-radius: 8px; padding: 14px; margin-bottom: 16px; border-left: 3px solid rgba(255,184,77,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px; color: rgba(255,255,255,0.9); font-size: 14px;">‚öôÔ∏è Modo Avan√ßado</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6);">Acompanhe desempenho nos casos cl√≠nicos</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 56px; height: 34px; flex-shrink: 0;">
                                <input type="checkbox" id="toggleModoAvancado" onchange="modoAvancado_toggle()" style="opacity: 0; width: 0; height: 0;">
                                <span id="toggleModoAvancadoSpan" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.1); border-radius: 17px; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s;">
                                    <span id="toggleModoAvancadoThumb" style="position: absolute; content: ''; height: 28px; width: 28px; left: 3px; bottom: 3px; background: linear-gradient(145deg, #fff, #e8e8e8); border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Tabs Lista / Sess√£o -->
                    <div class="diario-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button id="diarioTabLista" class="diario-tab active" onclick="setAbaDiario('lista')">
                            üìã Lista
                        </button>
                        <button id="diarioTabSessao" class="diario-tab" onclick="setAbaDiario('sessao')">
                            üîÅ Sess√£o
                        </button>
                    </div>
                    
                    <!-- Wrapper da LISTA (conte√∫do atual) -->
                    <div id="diarioListaWrapper">
                    <!-- Toggle de Modo -->
                    <div class="diario-modos" style="margin-bottom: 16px; display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; width: fit-content;">
                        <button class="modo-btn nivel-2-turquesa active" id="modoRecall" onclick="setModoDiario('recall')">
                            üß† Recall
                        </button>
                        <button class="modo-btn modo-inativo" id="modoRespostas" onclick="setModoDiario('respostas')">
                            üìñ Respostas
                        </button>
                        <span id="diarioRankingBtnMount"></span>
                    </div>
                    
                    <!-- PATCH 2: Indicadores VRVS 3P (complementa chip) -->
                    <!-- PATCH 4: Substitu√≠do ‚ö†Ô∏è aten√ß√£o por üìÜ pr√≥ximas -->
                    <div id="diarioIndicadoresVRVS" style="display: flex; gap: 12px; align-items: center; padding: 8px 12px; background: rgba(0,206,209,0.05); border: 1px solid rgba(0,206,209,0.2); border-radius: 8px; margin-bottom: 16px; font-size: 12px; flex-wrap: wrap;">
                        <span style="color: rgba(255,255,255,0.7);">üß† ativos: <span id="diarioCountAtivos" style="color: var(--turquesa-light); font-weight: 600;">0</span></span>
                        <span style="color: rgba(255,255,255,0.7);">‚è∞ hoje: <span id="diarioCountHoje" style="color: var(--cobre-light); font-weight: 600;">0</span></span>
                        <span style="color: rgba(255,255,255,0.7);">üìÜ pr√≥ximas: <span id="diarioCountProximas" style="color: var(--turquesa-main); font-weight: 600;">0</span></span>
                        <div style="margin-left: auto; display: flex; gap: 8px;">
                            <button onclick="desmarcarTodasRevisoes()" style="background: rgba(255,69,58,0.2); border: 1px solid rgba(255,69,58,0.4); color: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                                üî¥ Desmarcar Todos
                            </button>
                            <button onclick="marcarTodasRevisoes()" style="background: rgba(52,199,89,0.2); border: 1px solid rgba(52,199,89,0.4); color: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                                üü¢ Marcar Todos
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="diario-filtros" style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                        <input type="text" class="form-input form-input-sm" id="filtroDiarioBusca" placeholder="üîç Buscar (t√≥pico, tema)..." oninput="filtrarDiarioPorBusca()" style="font-size: 13px; padding: 8px; flex: 1; min-width: 200px;">
                        <button class="btn btn-small btn-secondary" onclick="limparBuscaDiario()" id="btnLimparBuscaDiario" style="display: none; font-size: 13px; padding: 8px;">‚úï Limpar</button>
                        <select class="form-select form-select-sm" id="filtroDiarioVista" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                            <option value="data">üìÖ Por Data</option>
                            <option value="tema">üìÅ Por Tema</option>
                        </select>
                        <select class="form-select form-select-sm" id="filtroDiarioArea" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                            <option value="">Todas as √°reas</option>
                        </select>
                        <input type="date" class="form-input form-input-sm" id="filtroDiarioData" onchange="renderDiario()" style="font-size: 13px; padding: 8px;">
                    </div>
                    <div id="diarioBuscaResultados" style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 12px; display: none;">
                        <span id="diarioBuscaContador">0</span> resultado(s) encontrado(s)
                    </div>
                    
                    <!-- Se√ß√£o "Revisar Hoje" (itens com ‚ö†Ô∏è) -->
                        <div id="diarioRevisarHoje" style="display: none; background: rgba(255,127,80,0.1); border: 1px solid rgba(255,127,80,0.3); border-radius: 12px; padding: 14px; margin-bottom: 20px; max-height: none; overflow-y: visible;"></div>
                    
                    <!-- Container principal -->
                    <div id="diarioContainer"></div>
                    </div>
                    
                    <!-- Wrapper da SESS√ÉO -->
                    <div id="diarioSessaoWrapper" style="display:none;">
                        <div class="diario-sessao-modos" style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button id="sessaoDiarioProgramado"
                                    class="diario-sessao-modo-btn active"
                                    onclick="setModoSessaoDiario('programado')">
                                üìÖ Revis√£o programada
                            </button>
                            <button id="sessaoDiarioLivre"
                                    class="diario-sessao-modo-btn"
                                    onclick="setModoSessaoDiario('livre')">
                                üß™ Treino livre
                            </button>
                        </div>
                        <div id="diarioSessao" style="margin-top: 12px;">
                            <!-- JS injeta aqui o card da sess√£o ou a mensagem "sem cards" -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CADERNO -->
            <!-- CADERNO (v2 - √°reas colaps√°veis) -->
            <div id="caderno" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>üìì CADERNO DE ANOTA√á√ïES</span>
                        <button class="btn btn-small" onclick="exportarHotTopicsHTML()" style="background: var(--cobre-main);">üî• Exportar HTML</button>
                    </div>
                    
                    <!-- Filtro compacto -->
                    <div style="margin-bottom: 16px;">
                        <select class="form-select" id="cadernoFiltroArea" onchange="renderCadernoV2()" style="max-width: 300px;">
                            <option value="">Todas as √°reas</option>
                        </select>
                    </div>
                    
                    <!-- Container com √°reas colaps√°veis -->
                    <div id="cadernoAreasContainer"></div>
                </div>
            </div>
            
            <!-- MAPAS MENTAIS -->
            <div id="mindmaps" class="section">
                <div class="card">
                    <div class="card-title">üß† Mapas Mentais</div>
                    
                    <!-- Criar Novo Mapa -->
                    <div style="margin-bottom: 24px; padding: 18px; background: rgba(0,206,209,0.05); border-radius: 12px; border: 1px solid rgba(0,206,209,0.2);">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ‚ú® Criar Novo Mapa
                        </h3>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button class="btn btn-small" onclick="mindmaps_abrirGPT()" style="flex: 1;">
                                ü§ñ Abrir GPT
                            </button>
                            <button class="btn btn-small" onclick="mindmaps_copiarPrompt()" style="flex: 1;">
                                üìã Copiar Prompt
                            </button>
                        </div>
                        
                        <textarea id="mindmapsOutlineInput" placeholder="Cole aqui o outline gerado pelo GPT...&#10;&#10;Formato:&#10;- N√≥ principal&#10;  - Sub-n√≥&#10;    * Detalhe" style="width: 100%; min-height: 120px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px dashed rgba(0,206,209,0.3); border-radius: 8px; color: rgba(255,255,255,0.9); font-size: 13px; font-family: 'SF Mono', monospace; resize: vertical;"></textarea>
                        
                        <button class="btn" onclick="mindmaps_gerarMapa()" style="width: 100%; margin-top: 12px; background: var(--turquesa-main);">
                            üß† GERAR MAPA
                        </button>
                    </div>
                    
                    <!-- Biblioteca -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="color: var(--turquesa-light); font-size: 16px;">üìö Biblioteca</h3>
                            <span id="mindmapsCount" style="font-size: 12px; color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 12px;">0 mapas</span>
                        </div>
                        <div id="mindmapsLista">
                            <!-- Renderizado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AN√ÅLISES (Stats + An√°lises + Relat√≥rios + Hist√≥rico) -->
            <div id="analytics" class="section">
                <div class="card">
                    <div class="card-title">üìà AN√ÅLISES</div>
                    
                    <!-- Sub-navega√ß√£o -->
                    <div class="sub-nav">
                        <button class="sub-nav-btn active" id="btnAnalyticsResumo" onclick="setVistaAnalytics('resumo')">üìä Resumo</button>
                        <button class="sub-nav-btn" id="btnAnalyticsGraficos" onclick="setVistaAnalytics('graficos')">üìà Gr√°ficos</button>
                        <!-- Detalhado temporariamente removido - precisa reimplementa√ß√£o -->
                        <button class="sub-nav-btn" id="btnAnalyticsHistorico" onclick="setVistaAnalytics('historico')">üìú Hist√≥rico</button>
                    </div>
                    
                    <!-- Container din√¢mico -->
                    <div id="analyticsContainer"></div>
                </div>
            </div>
            
            <!-- BACKUP (Importar + Exportar) -->
            <div id="backup" class="section">
                <div class="card">
                    <div class="card-title">üíæ BACKUP E RESTAURA√á√ÉO</div>
                    
                    <!-- Exportar -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì§ EXPORTAR DADOS</h3>
                        <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                            Perfil ativo: <strong id="backupPerfilAtivo">DEFAULT</strong>
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportarDados()">üìä DADOS.csv</button>
                            <button class="btn btn-secondary" onclick="exportarHistorico()">üìú HISTORICO.csv</button>
                            <button class="btn btn-secondary" onclick="exportarAnotacoes()">üìî ANOTACOES.csv</button>
                            <button class="btn btn-secondary" onclick="exportarDiarioCSV()">üìî DIARIO.csv</button>
                            <button class="btn" onclick="exportarHotTopicsHTML()" style="background: var(--cobre-main);">üî• Hot Topics HTML</button>
                            <button class="btn" onclick="exportarBackupJSON()" style="background: var(--turquesa-main);">üì• Backup Completo (.json)</button>
                            <button class="btn" onclick="showSection('mindmaps')" style="background: var(--turquesa-main);">üó∫Ô∏è Ir para üß† Mapas</button>
                        </div>
                    </div>
                    
                    <!-- Exporta√ß√£o Avan√ßada -->
                    <details style="margin-bottom: 30px; border-top: 1px solid rgba(0,206,209,0.3); padding-top: 20px;">
                        <summary style="cursor: pointer; color: var(--turquesa-light); font-size: 14px; font-weight: 600; margin-bottom: 15px; padding: 8px; background: rgba(0,206,209,0.1); border-radius: 6px; list-style: none;">
                            üîß Exporta√ß√£o Avan√ßada
                        </summary>
                        <div style="padding: 12px; margin-top: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 10px; white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
                                Exporta todos os dados do localStorage em formato JSON bruto. Inclui hist√≥rico de respostas VRVS 3P, configura√ß√µes e todos os dados da plataforma.
                            </p>
                            <button class="btn" onclick="exportarBackupJSON()" style="background: var(--turquesa-main);">
                                üì• Baixar Backup Completo (.json)
                            </button>
                        </div>
                    </details>
                    
                    <!-- Importar Backup JSON (Box Principal) -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì• IMPORTAR BACKUP COMPLETO (JSON)</h3>
                        <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                            Perfil ativo: <strong id="backupPerfilAtivoImport">DEFAULT</strong>
                        </p>
                        <div class="form-group">
                            <label class="form-label">Arquivo Backup Completo VRVS (.json)</label>
                            <input type="file" class="form-input" id="importBackupJSON" accept=".json">
                        </div>
                        <button class="btn" onclick="importarBackupJSON()" style="background: var(--turquesa-main);">üì• RESTAURAR BACKUP COMPLETO</button>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                            ‚ö†Ô∏è Esta opera√ß√£o substitui TODOS os dados do perfil ativo pelos do backup. Fa√ßa backup antes de restaurar!
                        </div>
                    </div>
                    
                    <!-- Importar Dados CSV -->
                    <div style="margin-bottom: 30px; border-top: 1px solid rgba(0,206,209,0.3); padding-top: 20px;">
                        <h3 style="color: var(--turquesa-light); font-size: 14px; margin-bottom: 15px;">üì• IMPORTAR DADOS (CSV)</h3>
                        <div class="form-group">
                            <label class="form-label">Arquivo DADOS.csv</label>
                            <input type="file" class="form-input" id="importDados" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo HISTORICO.csv</label>
                            <input type="file" class="form-input" id="importHistorico" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo ANOTACOES.csv (opcional)</label>
                            <input type="file" class="form-input" id="importAnotacoes" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Arquivo DIARIO.csv (opcional)</label>
                            <input type="file" class="form-input" id="importDiario" accept=".csv">
                        </div>
                        <button class="btn" onclick="importarArquivos()">üì• PROCESSAR IMPORTA√á√ÉO</button>
                    </div>
                    
                    <!-- Reset -->
                    <div style="border-top: 1px solid rgba(255,127,80,0.3); padding-top: 20px;">
                        <h3 style="color: var(--cobre-light); font-size: 14px; margin-bottom: 15px;">‚ö†Ô∏è ZONA DE PERIGO</h3>
                        <button class="btn btn-danger" onclick="limparTudo()">üóëÔ∏è RESET COMPLETO</button>
                        <div style="font-size: 11px; color: rgba(255,127,80,0.7); margin-top: 8px;">
                            ‚ö†Ô∏è Esta a√ß√£o apaga TODOS os dados. Fa√ßa backup antes!
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AJUDA (Tutorial + FAQ) -->
            <div id="ajuda" class="section">
                <div class="card">
                    <div class="card-title">‚ùì AJUDA</div>
                    
                    <!-- Sub-navega√ß√£o -->
                    <div class="sub-nav">
                        <button class="sub-nav-btn active" id="btnAjudaTutorial" onclick="setVistaAjuda('tutorial')">üìö Tutorial</button>
                        <button class="sub-nav-btn" id="btnAjudaFaq" onclick="setVistaAjuda('faq')">üí¨ FAQ</button>
                    </div>
                    
                    <!-- Container din√¢mico -->
                    <div id="ajudaContainer"></div>
                </div>
            </div>
            
            <!-- CONFIGURA√á√ïES -->
            <div id="config" class="section">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è CONFIGURA√á√ïES</div>
                    
                    <!-- CONFIG REFATORADA -->
                    <div style="margin-top: 24px;">
                        <!-- Bloco 1: Perfil -->
                        <div style="margin-bottom: 24px; padding: 18px; background: linear-gradient(135deg, rgba(0,206,209,0.08), rgba(0,255,224,0.04)); border: 1px solid rgba(0,206,209,0.25); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,206,209,0.1);">
                            <h3 style="margin-top: 0; margin-bottom: 14px; color: var(--turquesa-light); font-size: 17px; font-weight: 600;">üë§ Perfil</h3>
                            <div style="margin: 0 0 14px 0; font-size: 14px; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span style="font-weight: 500;">Perfil ativo:</span>
                                <select id="perfilAtivoSelect" onchange="trocarPerfil(this.value)" style="background: rgba(255,255,255,0.12); border: 1px solid rgba(0,206,209,0.3); border-radius: 6px; padding: 6px 10px; color: var(--turquesa-light); font-weight: 600; cursor: pointer; min-height: 36px; transition: all 0.2s; box-shadow: 0 0 0 1px rgba(255,163,102,0.1);">
                                    <!-- PATCH D1: Renderizado dinamicamente via renderConfig() -->
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="abrirModalGerenciarPerfis()" style="font-size: 13px; padding: 10px 18px; min-height: 40px; border-radius: 6px; transition: all 0.2s; box-shadow: 0 0 0 1px rgba(255,163,102,0.15), 0 2px 4px rgba(0,206,209,0.1);">‚öôÔ∏è Gerenciar perfis</button>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.6); line-height: 1.5;">Crie datasets separados para diferentes projetos de estudo.</p>
                        </div>
                        
                        <!-- Bloco 2: Armazenamento -->
                        <div style="margin-bottom: 24px; padding: 16px; background: rgba(255,127,80,0.05); border: 1px solid rgba(255,127,80,0.2); border-radius: 8px;">
                            <h3 style="margin-top: 0; margin-bottom: 12px; color: var(--cobre-light); font-size: 16px;">üíæ Armazenamento</h3>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: rgba(255,255,255,0.8);">
                                Uso atual: <strong id="configStorageUsage">Calculando...</strong><br>
                                <span style="font-size: 11px; color: rgba(255,255,255,0.5);">Limite varia por aparelho/navegador</span>
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-top: 12px;" onclick="toggleBackupConfig()">
                                <div>
                                    <span style="font-size: 13px; color: rgba(255,255,255,0.7);">üì• Exportar / Importar dados</span>
                                    <span style="font-size: 10px; color: rgba(255,255,255,0.5); display: block; margin-top: 4px;">
                                        (Perfil: <strong id="configPerfilAtivo">DEFAULT</strong>)
                                    </span>
                                </div>
                                <span id="backupConfigToggle" style="font-size: 12px; color: rgba(255,255,255,0.5);">‚ñº Expandir</span>
                            </div>
                            <div id="backupConfigContent" style="display: none; margin-top: 12px;">
                                <button class="btn btn-small btn-secondary" onclick="showSection('backup')" style="width: 100%; text-align: left;">Abrir Backup ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- Bloco 3: Ferramentas (colaps√°vel) -->
                        <div style="margin-bottom: 24px; padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleFerramentasConfig()">
                                <h3 style="margin: 0; color: var(--turquesa-light); font-size: 16px;">üîß Ferramentas</h3>
                                <span id="ferramentasConfigToggle" style="font-size: 14px; color: rgba(255,255,255,0.6);">‚ñº Expandir</span>
                            </div>
                            <div id="ferramentasConfigContent" style="display: none; margin-top: 12px;">
                                <p style="margin: 0 0 12px 0; font-size: 13px; color: rgba(255,255,255,0.7);">
                                    <strong>Build:</strong> <span id="configVrvsBuild" style="color: var(--turquesa-light); font-weight: 600;"></span><br>
                                    <span style="font-size: 11px; color: rgba(255,255,255,0.5);">Build deve bater com CACHE_NAME do Service Worker</span>
                                </p>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button class="btn btn-small" onclick="forcarAtualizacaoApp()" style="text-align: left; background: rgba(0, 206, 209, 0.2); border-color: rgba(0, 206, 209, 0.5);">üîÑ Verificar Atualiza√ß√µes do App</button>
                                    <button class="btn btn-small" onclick="diagnosticoApp()" style="text-align: left; background: rgba(255, 159, 64, 0.2); border-color: rgba(255, 159, 64, 0.5);">üìã Diagn√≥stico do App</button>
                                    <button class="btn btn-small" onclick="resetAppShell()" style="text-align: left; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5);">üßπ Reset App Shell (sem apagar dados)</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bloco 4: Sobre -->
                        <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <h3 style="margin-top: 0; margin-bottom: 12px; color: var(--turquesa-light); font-size: 16px;">‚ÑπÔ∏è Sobre</h3>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: rgba(255,255,255,0.8);">
                                VRVS <span id="configSobreBuild"></span>
                            </p>
                            <button class="btn btn-secondary" onclick="showSection('ajuda')">üìö Ver Tutorial e FAQ ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Modal Gerenciar Perfis (P1.3) -->
    <div id="vrvsModalPerfis" class="vrvsModal">
        <div class="vrvsModal-overlay" onclick="fecharModalGerenciarPerfis()"></div>
        <div class="vrvsModal-content">
            <div class="vrvsModal-header">
                <h2 class="vrvsModal-title">‚öôÔ∏è Perfis</h2>
                <button class="vrvsModal-close" onclick="fecharModalGerenciarPerfis()">√ó</button>
            </div>
            <div class="vrvsModal-body">
                <div id="vrvsModalPerfisLista">
                    <!-- PATCH D1: Renderizado dinamicamente via abrirModalGerenciarPerfis() -->
                </div>
                <button class="btn-criar-perfil" onclick="vrvs_abrirModalCriarPerfil()">
                    <span class="btn-criar-perfil-icon">+</span>
                    Criar novo perfil
                </button>
            </div>
            <div class="vrvsModal-footer">
                <button class="btn-fechar-modal" onclick="fecharModalGerenciarPerfis()">FECHAR</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== VRVS BUILD ====================
        const VRVS_BUILD = "v5.3.191";
        
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        // Fun√ß√£o para corrigir invers√£o √°rea‚Üîtema ANTES de carregar dados
        function fixAreaTemaObjeto(obj) {
            if (!obj) return obj;
            const area = String(obj.area || '');
            const tema = String(obj.tema || '');
            // Se √°rea est√° muito longa (>20) E tema cont√©m palavra-chave de √°rea, inverter
            const areaLikeKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'mao', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'pe', 'tornozelo', 'coluna', 'oncologia', 'tumores', 'mmss', 'mmii'];
            const temaPareceArea = areaLikeKeywords.some(k => tema.toLowerCase().includes(k));
            if (area.length > 20 && temaPareceArea) {
                const tmp = obj.area;
                obj.area = obj.tema;
                obj.tema = tmp;
            }
            return obj;
        }
        
        // ==================== FUN√á√ïES DE SEGURAN√áA ====================
        
        // Detectar se est√° em modo standalone (PWA)
        function isStandalone() {
            try {
                if (navigator && navigator.standalone) return true; // iOS
                if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return true; // padr√£o
                return false;
            } catch (e) { return false; }
        }
        
        function fazerBackupCompleto() {
            // PACOTE A: Ler dados SEMPRE do perfil ativo usando window.vrvs_key()
            const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
            const backup = {
                schemaVersion: 'VRVS_BACKUP_v1',
                timestamp: new Date().toISOString(),
                perfilAtivo: perfilAtivo,
                dados: JSON.parse(localStorage.getItem(window.vrvs_key('dados')) || '[]'),
                historico: JSON.parse(localStorage.getItem(window.vrvs_key('historico')) || '[]'),
                anotacoes: JSON.parse(localStorage.getItem(window.vrvs_key('anotacoes')) || '[]'),
                lembretes: JSON.parse(localStorage.getItem(window.vrvs_key('lembretes')) || '[]'),
                diario: JSON.parse(localStorage.getItem(window.vrvs_diarioKey()) || '{"entradas":[],"schemaVersion":"1.0"}'),
                config: JSON.parse(localStorage.getItem('vrvs_config') || '{}')
            };
            
            // S3Q: Calcular tamanho estimado do backup
            const backupStr = JSON.stringify(backup);
            const estimatedBytes = backupStr.length * 2; // UTF-16
            const MAX_BACKUP_BYTES_STANDALONE = 1.5 * 1024 * 1024; // 1.5MB conservador
            
            // S3Q: Hard stop se backup muito grande (preventivo)
            if (isStandalone() && estimatedBytes > MAX_BACKUP_BYTES_STANDALONE) {
                console.warn('[BACKUP] Backup muito grande (' + (estimatedBytes / 1024 / 1024).toFixed(2) + 'MB). N√£o ser√° criado.');
                if (typeof mostrarNotificacaoFeedback === 'function') {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Backup muito grande (' + (estimatedBytes / 1024 / 1024).toFixed(2) + 'MB). Limpe dados antigos antes de criar backup.', 'warning');
                }
                return null;
            }
            
            // S3Q: Verificar quota dispon√≠vel ANTES de criar backup
            try {
                const testKey = '__vrvs_backup_quota_test';
                // Tentar escrever ~100KB para verificar espa√ßo
                const testSize = Math.min(100 * 1024, estimatedBytes);
                localStorage.setItem(testKey, 'x'.repeat(testSize));
                localStorage.removeItem(testKey);
            } catch(e) {
                if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                    console.warn('[BACKUP] Quota insuficiente para criar backup. Pulando cria√ß√£o.');
                    if (typeof mostrarNotificacaoFeedback === 'function') {
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Espa√ßo insuficiente para backup. Limpe dados antigos no Storage Doctor.', 'warning');
                    }
                    return null;
                }
                // Se n√£o for quota, rethrow (erro inesperado)
                throw e;
            }
            
            // PACOTE A: Reten√ß√£o por perfil (5 backups POR PERFIL)
            const MAX_BACKUPS_PER_PERFIL = 5;
            
            // S3Q: Limpar backups antigos do PERFIL ATIVO ANTES de criar novo
            const prefixoPerfil = `vrvs_backup_${perfilAtivo}_`;
            const bksDoPerfil = Object.keys(localStorage)
                .filter(k => k.startsWith(prefixoPerfil))
                .sort();
            
            // S3Q: Limpar backups antigos do perfil se estiver no limite
            if (bksDoPerfil.length >= MAX_BACKUPS_PER_PERFIL) {
                // Manter apenas os √∫ltimos MAX_BACKUPS_PER_PERFIL
                const backupsParaRemover = bksDoPerfil.slice(0, bksDoPerfil.length - MAX_BACKUPS_PER_PERFIL + 1);
                backupsParaRemover.forEach(rm => {
                    try { localStorage.removeItem(rm); } catch(_) {}
                });
            }
            
            // S3Q: Tentar criar backup com prote√ß√£o QUOTA (com prefixo de perfil)
            const backupKey = `vrvs_backup_${perfilAtivo}_${Date.now()}`;
            try {
                localStorage.setItem(backupKey, backupStr);
                console.log(`[BACKUP] Backup criado: ${backupKey} (${(estimatedBytes / 1024 / 1024).toFixed(2)}MB)`);
                return backupKey;
            } catch(e) {
                // S3Q: Se falhar por quota, limpar TODOS os backups e retry 1x
                if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                    console.warn('[BACKUP] Quota excedida ao criar backup. Limpando todos os backups e tentando novamente...');
                    
                    // Limpar TODOS os backups do PERFIL ATIVO
                    const allBackupsDoPerfil = Object.keys(localStorage).filter(k => k.startsWith(prefixoPerfil));
                    allBackupsDoPerfil.forEach(rm => {
                        try { localStorage.removeItem(rm); } catch(_) {}
                    });
                    
                    // Retry 1x
                    try {
                        localStorage.setItem(backupKey, backupStr);
                        console.log(`[BACKUP] Backup criado ap√≥s limpeza: ${backupKey}`);
                        return backupKey;
                    } catch(e2) {
                        // Se ainda falhar, desistir
                        console.error('[BACKUP] Falha ao criar backup mesmo ap√≥s limpeza:', e2);
                        if (typeof mostrarNotificacaoFeedback === 'function') {
                            mostrarNotificacaoFeedback('‚ö†Ô∏è Sem espa√ßo suficiente para backup. Limpe dados no Storage Doctor.', 'warning');
                        }
                        return null;
                    }
                }
                // Se n√£o for quota, rethrow (erro inesperado)
                throw e;
            }
        }
        
        // Baixar snapshot pr√©-import (N√ÉO grava no localStorage)
        function baixarSnapshotAntesImport() {
            try {
                const keys = ['vrvs_dados','vrvs_historico','vrvs_anotacoes','vrvs_diario','vrvs_config','vrvs_lembretes'];
                const snap = { ts: new Date().toISOString(), note: 'snapshot antes do import', data: {} };
                keys.forEach(k => { snap.data[k] = localStorage.getItem(k); });
                
                const blob = new Blob([JSON.stringify(snap, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                const stamp = new Date().toISOString().replace(/[:.]/g,'-');
                a.href = URL.createObjectURL(blob);
                a.download = `VRVS_PRE_IMPORT_${stamp}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(a.href), 1500);
            } catch (e) {
                try { alert('Falha ao baixar snapshot pr√©-import: ' + String(e)); } catch(_) {}
            }
        }
        
        // Exportar backup completo em JSON (download)
        function exportarBackupJSON() {
            try {
                // PACOTE A: Exportar SEMPRE do perfil ativo usando window.vrvs_key()
                const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
                const backup = {
                    schemaVersion: 'VRVS_BACKUP_v1',
                    createdAt: new Date().toISOString(),
                    perfilAtivo: perfilAtivo,
                    vrvs_dados: JSON.parse(localStorage.getItem(window.vrvs_key('dados')) || '[]'),
                    vrvs_historico: JSON.parse(localStorage.getItem(window.vrvs_key('historico')) || '[]'),
                    vrvs_anotacoes: JSON.parse(localStorage.getItem(window.vrvs_key('anotacoes')) || '[]'),
                    vrvs_lembretes: JSON.parse(localStorage.getItem(window.vrvs_key('lembretes')) || '[]'),
                    vrvs_diario: JSON.parse(localStorage.getItem(window.vrvs_diarioKey()) || '{"entradas":[],"schemaVersion":"1.0"}'),
                    vrvs_config: JSON.parse(localStorage.getItem('vrvs_config') || '{}'),
                    vrvs_mindmaps: mindmaps_getAll()
                };
                
                // Contar itens para preview
                const totalDados = backup.vrvs_dados.length;
                const totalHistorico = backup.vrvs_historico.length;
                const totalAnotacoes = backup.vrvs_anotacoes.length;
                const totalLembretes = backup.vrvs_lembretes.length;
                const totalDiario = backup.vrvs_diario.entradas?.length || 0;
                
                const jsonStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const hoje = obterYMDLocal();
                const hora = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                a.download = `vrvs_backup_${perfilAtivo}_${hoje}_${hora}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // PATCH P3: Usar displayName sanitizado em mensagens
                const displayNameAtivo = window.vrvs_sanitizeDisplayName(window.vrvs_getDisplayName(perfilAtivo));
                mostrarNotificacaoFeedback(`‚úÖ Backup completo exportado do perfil "${displayNameAtivo}"! (${totalDados} temas, ${totalHistorico} sess√µes, ${totalAnotacoes} anota√ß√µes, ${totalLembretes} lembretes, ${totalDiario} entradas do Di√°rio)`);
            } catch (error) {
                console.error('[BACKUP] Erro ao exportar JSON:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao exportar backup. Verifique o console.', 'error');
            }
        }
        
        // Importar backup completo em JSON
        function importarBackupJSON() {
            const fileInput = document.getElementById('importBackupJSON');
            const file = fileInput?.files[0];
            
            if (!file) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione um arquivo de backup JSON!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onerror = () => {
                mostrarNotificacaoFeedback('‚ùå Erro ao ler arquivo!', 'error');
            };
            
            reader.onload = (e) => {
                try {
                    const raw = JSON.parse(e.target.result);
                    console.log('[IMPORT RAW] Arquivo carregado:', raw.note || 'backup padr√£o');
                    
                    // Converter RAW do overlay para formato de backup se necess√°rio
                    let backup = raw;
                    // Detectar RAW do overlay: pode ter 'note' com 'RAW localStorage' OU ter 'data' sem 'schemaVersion'
                    const isRawOverlay = (raw.note && raw.note.includes('RAW localStorage')) || 
                                        (raw.data && !raw.schemaVersion);
                    if (isRawOverlay) {
                        console.log('[IMPORT RAW] Detectado RAW do overlay, convertendo...');
                        console.log('[IMPORT RAW] Tipo detectado:', raw.note ? 'por note' : 'por estrutura');
                        // √â um RAW do overlay, precisa converter
                        backup = {
                            schemaVersion: 'VRVS_BACKUP_v1',
                            timestamp: raw.ts || new Date().toISOString(),
                            vrvs_dados: null,
                            vrvs_historico: null,
                            vrvs_anotacoes: null,
                            vrvs_lembretes: null,
                            vrvs_diario: null,
                            vrvs_config: null
                        };
                        
                        // Parsear strings JSON do RAW
                        if (raw.data) {
                            try {
                                const dadosRaw = raw.data.vrvs_dados;
                                backup.vrvs_dados = dadosRaw ? (typeof dadosRaw === 'string' ? JSON.parse(dadosRaw) : dadosRaw) : [];
                                console.log('[IMPORT RAW] vrvs_dados:', backup.vrvs_dados?.length || 0, 'itens');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_dados:', e);
                                backup.vrvs_dados = []; 
                            }
                            
                            try {
                                const historicoRaw = raw.data.vrvs_historico;
                                backup.vrvs_historico = historicoRaw ? (typeof historicoRaw === 'string' ? JSON.parse(historicoRaw) : historicoRaw) : [];
                                console.log('[IMPORT RAW] vrvs_historico:', backup.vrvs_historico?.length || 0, 'itens');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_historico:', e);
                                backup.vrvs_historico = []; 
                            }
                            
                            try {
                                const anotacoesRaw = raw.data.vrvs_anotacoes;
                                backup.vrvs_anotacoes = anotacoesRaw ? (typeof anotacoesRaw === 'string' ? JSON.parse(anotacoesRaw) : anotacoesRaw) : [];
                                console.log('[IMPORT RAW] vrvs_anotacoes:', backup.vrvs_anotacoes?.length || 0, 'itens');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_anotacoes:', e);
                                backup.vrvs_anotacoes = []; 
                            }
                            
                            try {
                                const lembretesRaw = raw.data.vrvs_lembretes;
                                backup.vrvs_lembretes = lembretesRaw ? (typeof lembretesRaw === 'string' ? JSON.parse(lembretesRaw) : lembretesRaw) : [];
                                console.log('[IMPORT RAW] vrvs_lembretes:', backup.vrvs_lembretes?.length || 0, 'itens');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_lembretes:', e);
                                backup.vrvs_lembretes = []; 
                            }
                            
                            try {
                                const diarioRaw = raw.data.vrvs_diario;
                                backup.vrvs_diario = diarioRaw ? (typeof diarioRaw === 'string' ? JSON.parse(diarioRaw) : diarioRaw) : {entradas:[],schemaVersion:"1.0"};
                                console.log('[IMPORT RAW] vrvs_diario:', backup.vrvs_diario?.entradas?.length || 0, 'entradas');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_diario:', e);
                                backup.vrvs_diario = {entradas:[],schemaVersion:"1.0"}; 
                            }
                            
                            try {
                                const configRaw = raw.data.vrvs_config;
                                backup.vrvs_config = configRaw ? (typeof configRaw === 'string' ? JSON.parse(configRaw) : configRaw) : {};
                                console.log('[IMPORT RAW] vrvs_config:', Object.keys(backup.vrvs_config || {}).length, 'chaves');
                            } catch(e) { 
                                console.error('[IMPORT RAW] Erro ao parsear vrvs_config:', e);
                                backup.vrvs_config = {}; 
                            }
                        }
                        console.log('[IMPORT RAW] Convers√£o conclu√≠da');
                    }
                    
                    // Validar schemaVersion
                    if (!backup.schemaVersion || backup.schemaVersion !== 'VRVS_BACKUP_v1') {
                        console.error('[IMPORT RAW] schemaVersion inv√°lido:', backup.schemaVersion);
                        mostrarNotificacaoFeedback('‚ö†Ô∏è Arquivo n√£o √© um backup VRVS v√°lido (schemaVersion incorreto)', 'error');
                        return;
                    }
                    
                    console.log('[IMPORT RAW] Valida√ß√£o OK, mostrando preview...');
                    
                    // PACOTE A: Verificar se perfil do backup √© diferente do perfil ativo
                    const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
                    const perfilBackup = backup.perfilAtivo || 'DEFAULT';
                    const perfilDiferente = perfilBackup !== perfilAtivo;
                    
                    // Mostrar preview antes de restaurar
                    const totalDados = backup.vrvs_dados?.length || 0;
                    const totalHistorico = backup.vrvs_historico?.length || 0;
                    const totalAnotacoes = backup.vrvs_anotacoes?.length || 0;
                    const totalLembretes = backup.vrvs_lembretes?.length || 0;
                    const totalDiario = backup.vrvs_diario?.entradas?.length || 0;
                    
                    let mensagemConfirmacao = `Este backup cont√©m:\n` +
                        `‚Ä¢ ${totalDados} temas\n` +
                        `‚Ä¢ ${totalHistorico} sess√µes\n` +
                        `‚Ä¢ ${totalAnotacoes} anota√ß√µes\n` +
                        `‚Ä¢ ${totalLembretes} lembretes\n` +
                        `‚Ä¢ ${totalDiario} entradas do Di√°rio\n\n`;
                    
                    // PACOTE A: Avisar se perfil diferente
                    if (perfilDiferente) {
                        // PATCH P3: Usar displayNames sanitizados em mensagens
                        const displayNameBackup = window.vrvs_sanitizeDisplayName(window.vrvs_getDisplayName(perfilBackup));
                        const displayNameAtivo = window.vrvs_sanitizeDisplayName(window.vrvs_getDisplayName(perfilAtivo));
                        mensagemConfirmacao += `‚ö†Ô∏è ATEN√á√ÉO CR√çTICA:\n` +
                            `‚Ä¢ Backup foi criado no perfil "${displayNameBackup}"\n` +
                            `‚Ä¢ Voc√™ est√° importando no perfil "${displayNameAtivo}"\n` +
                            `‚Ä¢ Os dados ser√£o importados APENAS no perfil "${displayNameAtivo}"\n` +
                            `‚Ä¢ O perfil "${displayNameBackup}" N√ÉO ser√° afetado\n\n`;
                    }
                    
                    // PATCH P3: Usar displayName sanitizado
                    const displayNameAtivo = window.vrvs_sanitizeDisplayName(window.vrvs_getDisplayName(perfilAtivo));
                    mensagemConfirmacao += `‚ö†Ô∏è Esta opera√ß√£o substituir√° TODOS os dados do perfil "${displayNameAtivo}"!\n\n` +
                        `Deseja continuar?`;
                    
                    const confirmacao = confirm(mensagemConfirmacao);
                    
                    if (!confirmacao) return;
                    
                    // Snapshot pr√©-import (download, N√ÉO grava no localStorage)
                    console.log('[IMPORT RAW] Baixando snapshot pr√©-import...');
                    baixarSnapshotAntesImport();
                    
                    // Limpar backups antigos, mantendo 1 mais recente (seguran√ßa extra)
                    try {
                        const bks = Object.keys(localStorage).filter(k => k.startsWith('vrvs_backup_')).sort();
                        // manter o mais recente (√∫ltimo), apagar o resto
                        for (let i = 0; i < bks.length - 1; i++) {
                            try { localStorage.removeItem(bks[i]); } catch(_) {}
                        }
                        console.log('[IMPORT RAW] Backups antigos limpos, mantido 1 mais recente');
                    } catch(_) {}
                    
                    // PACOTE A: Restaurar dados SEMPRE no perfil ativo usando window.vrvs_key()
                    console.log('[IMPORT RAW] Restaurando dados no perfil ativo:', perfilAtivo);
                    if (backup.vrvs_dados) {
                        const dadosKey = window.vrvs_key('dados');
                        try { localStorage.removeItem(dadosKey); } catch(_) {}
                        try {
                            localStorage.setItem(dadosKey, JSON.stringify(backup.vrvs_dados));
                            dados = backup.vrvs_dados;
                            console.log('[IMPORT RAW] ‚úÖ vrvs_dados restaurado no perfil', perfilAtivo, ':', backup.vrvs_dados.length, 'itens');
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_dados (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    if (backup.vrvs_historico) {
                        const historicoKey = window.vrvs_key('historico');
                        try { localStorage.removeItem(historicoKey); } catch(_) {}
                        try {
                            localStorage.setItem(historicoKey, JSON.stringify(backup.vrvs_historico));
                            historico = backup.vrvs_historico;
                            console.log('[IMPORT RAW] ‚úÖ vrvs_historico restaurado no perfil', perfilAtivo, ':', backup.vrvs_historico.length, 'itens');
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_historico (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    if (backup.vrvs_anotacoes) {
                        const anotacoesKey = window.vrvs_key('anotacoes');
                        try { localStorage.removeItem(anotacoesKey); } catch(_) {}
                        try {
                            localStorage.setItem(anotacoesKey, JSON.stringify(backup.vrvs_anotacoes));
                            anotacoes = backup.vrvs_anotacoes;
                            console.log('[IMPORT RAW] ‚úÖ vrvs_anotacoes restaurado no perfil', perfilAtivo, ':', backup.vrvs_anotacoes.length, 'itens');
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_anotacoes (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    if (backup.vrvs_lembretes) {
                        const lembretesKey = window.vrvs_key('lembretes');
                        try { localStorage.removeItem(lembretesKey); } catch(_) {}
                        try {
                            localStorage.setItem(lembretesKey, JSON.stringify(backup.vrvs_lembretes));
                            console.log('[IMPORT RAW] ‚úÖ vrvs_lembretes restaurado no perfil', perfilAtivo, ':', backup.vrvs_lembretes.length, 'itens');
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_lembretes (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    // CR√çTICO: Restaurar Di√°rio com SRS completo
                    if (backup.vrvs_diario) {
                        const diarioKey = window.vrvs_diarioKey();
                        try { localStorage.removeItem(diarioKey); } catch(_) {}
                        try {
                            localStorage.setItem(diarioKey, JSON.stringify(backup.vrvs_diario));
                            window.diario = backup.vrvs_diario;
                            console.log('[IMPORT RAW] ‚úÖ vrvs_diario restaurado no perfil', perfilAtivo, ':', backup.vrvs_diario.entradas?.length || 0, 'entradas');
                            
                            // Migrar SRS se necess√°rio (mas n√£o resetar se j√° est√° completo)
                            migrarSRSParaVRVS3P();
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_diario (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    if (backup.vrvs_config) {
                        try { localStorage.removeItem('vrvs_config'); } catch(_) {}
                        try {
                            localStorage.setItem('vrvs_config', JSON.stringify(backup.vrvs_config));
                            console.log('[IMPORT RAW] ‚úÖ vrvs_config restaurado');
                        } catch(e) {
                            alert('Falha ao restaurar vrvs_config (quota). Snapshot pr√©-import foi baixado.');
                            throw e;
                        }
                    }
                    
                    if (backup.vrvs_mindmaps) {
                        try {
                            if (typeof vrvs_safeSetItem === 'function') {
                                vrvs_safeSetItem('vrvs_mindmaps', JSON.stringify(backup.vrvs_mindmaps), 'mindmaps');
                            } else {
                                localStorage.setItem('vrvs_mindmaps', JSON.stringify(backup.vrvs_mindmaps));
                            }
                            console.log('[IMPORT RAW] ‚úÖ vrvs_mindmaps restaurado');
                        } catch(e) {
                            console.error('[IMPORT RAW] Erro ao restaurar vrvs_mindmaps:', e);
                        }
                    }
                    
                    // Re-renderizar tudo
                    console.log('[IMPORT RAW] Recarregando UI...');
                    renderDados();
                    renderTarefas();
                    renderAgenda();
                    renderHistorico();
                    renderPendencias();
                    renderCaderno();
                    renderDiario();
                    updateStats();
                    
                    console.log('[IMPORT RAW] ‚úÖ Importa√ß√£o conclu√≠da com sucesso!');
                    mostrarNotificacaoFeedback('‚úÖ Backup restaurado com sucesso! Todos os dados foram atualizados.');
                } catch (error) {
                    console.error('[IMPORT RAW] ‚ùå Erro ao importar backup:', error);
                    console.error('[IMPORT RAW] Stack:', error.stack);
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao importar backup: ' + (error.message || 'Erro desconhecido'), 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        function validarAntesDeSalvar(tipo, dados) {
            const erros = [];
            
            switch(tipo) {
                case 'anotacoes':
                    dados.forEach((a, idx) => {
                        if (!a.id) erros.push(`Anota√ß√£o ${idx} sem ID`);
                    });
                    break;
                case 'diario':
                    renderDiario();
                    break;
                    if (dados.entries) {
                        dados.entries.forEach((e, idx) => {
                            if (!e.id) erros.push(`Entrada ${idx} sem ID`);
                            if (!e.data) erros.push(`Entrada ${idx} sem data`);
                            if (!e.topico) erros.push(`Entrada ${idx} sem t√≥pico`);
                        });
                    }
                    break;
                case 'dados':
                    dados.forEach((d, idx) => {
                        if (!d.id) erros.push(`Tema ${idx} sem ID`);
                        if (!d.area) erros.push(`Tema ${idx} sem √°rea`);
                        if (!d.tema) erros.push(`Tema ${idx} sem tema`);
                    });
                    break;
            }
            
            if (erros.length > 0) {
                console.error('[VALIDA√á√ÉO] Erros encontrados:', erros);
                throw new Error(`Valida√ß√£o falhou: ${erros.join(', ')}`);
            }
            
            return true;
        }
        
        function mesclarAnotacoes(novas, existentes) {
            const mescladas = [...existentes];
            const idsExistentes = new Set(existentes.map(a => a.id));
            
            novas.forEach(nova => {
                // Procurar por ID ou temaId (para mesclar anota√ß√µes do mesmo tema)
                const existente = existentes.find(a => 
                    a.id === nova.id || 
                    (String(a.temaId) === String(nova.temaId) && String(nova.temaId) !== '')
                );
                
                if (existente) {
                    // Mesclar preservando hotTopics se ambos existirem (priorizar o novo se n√£o vazio)
                    if (nova.hotTopics !== undefined && nova.hotTopics !== null && nova.hotTopics.trim() !== '') {
                        existente.hotTopics = nova.hotTopics;
                    }
                    // Mesclar conte√∫do geral (preservar existente se novo estiver vazio)
                    if (nova.conteudo !== undefined && nova.conteudo !== null && nova.conteudo.trim() !== '') {
                        existente.conteudo = nova.conteudo;
                    }
                    // Atualizar outros campos
                    Object.assign(existente, nova);
                } else {
                    // Garantir que hotTopics existe mesmo se vazio
                    if (!nova.hotTopics) nova.hotTopics = '';
                    mescladas.push(nova);
                }
            });
            
            return mescladas;
        }
        
        // √Åreas fixas do sistema
        const AREAS_FIXAS = [
            'Ci√™ncias B√°sicas',
            'Coluna',
            'Joelho',
            'M√£o',
            'Ombro e Cotovelo',
            'Oncologia',
            'Ortopedia Pedi√°trica',
            'P√© e Tornozelo',
            'Quadril',
            'Trauma Coluna',
            'Trauma MMII',
            'Trauma MMSS',
            'Trauma Pedi√°trico'
        ];
        
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        
        // S3D: Declara√ß√£o global cedo para evitar TDZ (antes de qualquer uso)
        window.diarioBuscaRAF = window.diarioBuscaRAF ?? null;
        
        // S3E: timers globais do Di√°rio (evita TDZ no boot)
        window.diarioChipVrvs3pTimeout = window.diarioChipVrvs3pTimeout ?? null;
        window.diarioBuscaTimeout = window.diarioBuscaTimeout ?? null;
        window.diarioRenderando = window.diarioRenderando ?? false;
        
        // S3G: vistas globais (evita TDZ no boot) - REMOVIDO: j√° inicializado no topo do HTML
        
        // S3A: Safe JSON parse helper (se ainda n√£o foi definido)
        if (typeof safeJSONFromLS === 'undefined') {
            function safeJSONFromLS(key, fallback) {
                try {
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : fallback;
                } catch(e) {
                    // N√£o tentar setBootErr se for QuotaExceededError (evitar loop)
                    if (typeof setBootErr === 'function' && e.name !== 'QuotaExceededError' && !(e.message && e.message.includes('quota'))) {
                        // S3J: Passar objeto Error completo com stack
                        setBootErr({ 
                            message: key + ': ' + (e.message || String(e || 'Parse error')), 
                            stack: e.stack || '' 
                        });
                    }
                    return fallback;
                }
            }
            window.safeJSONFromLS = safeJSONFromLS;
        }
        
        // ==================== PERFIS MVP (P1.4-A1) ====================
        // Inicializar perfil ativo ANTES de qualquer carregamento de dados
        window.vrvs_perfilAtivo = localStorage.getItem('vrvs_perfil_ativo') || 'DEFAULT';
        
        // Helper √∫nico para todas as chaves (DEFAULT usa legacy, outros perfis usam namespaced)
        window.vrvs_key = function(baseKey) {
            const p = window.vrvs_perfilAtivo || 'DEFAULT';
            if (p === 'DEFAULT') {
                return `vrvs_${baseKey}`;  // Legacy compat (sem prefixo)
            }
            return `vrvs_${p}_${baseKey}`; // Namespaced (ex: vrvs_VIDA_dados)
        };
        
        // Alias para compatibilidade com c√≥digo existente
        window.vrvs_diarioKey = function() {
            return window.vrvs_key('diario');
        };
        
        if (typeof __vrvsMark === 'function') __vrvsMark(2); // Antes do primeiro carregamento do localStorage
        if (typeof setBootStep === 'function') setBootStep(2);
        // S3B: Carregar dados com fallback para legacy (compatibilidade)
        let dadosKey = window.vrvs_key('dados');
        let dadosRaw = localStorage.getItem(dadosKey);
        let dados = null;
        if (dadosRaw !== null) {
            dados = (typeof window.safeParseLS === 'function') ? window.safeParseLS(dadosKey, [], 4 * 1024 * 1024) : safeJSONFromLS(dadosKey, []);
        }
        // Fallback: se perfil DEFAULT e namespaced n√£o existe, tentar legacy
        if ((dados === null || !Array.isArray(dados)) && window.vrvs_perfilAtivo === 'DEFAULT') {
            const legacyRaw = localStorage.getItem('vrvs_dados');
            if (legacyRaw !== null) {
                dados = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_dados', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_dados', []);
            }
        }
        if (!dados || !Array.isArray(dados)) dados = [];
        
        let historicoKey = window.vrvs_key('historico');
        let historicoRaw = localStorage.getItem(historicoKey);
        let historico = null;
        if (historicoRaw !== null) {
            historico = (typeof window.safeParseLS === 'function') ? window.safeParseLS(historicoKey, [], 4 * 1024 * 1024) : safeJSONFromLS(historicoKey, []);
        }
        if ((historico === null || !Array.isArray(historico)) && window.vrvs_perfilAtivo === 'DEFAULT') {
            const legacyRaw = localStorage.getItem('vrvs_historico');
            if (legacyRaw !== null) {
                historico = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_historico', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_historico', []);
            }
        }
        if (!historico || !Array.isArray(historico)) historico = [];
        
        // P4: Carregar √°reas customizadas persistentes (por perfil)
        let areasCustomKey = window.vrvs_key('areas_custom');
        let areasCustomRaw = localStorage.getItem(areasCustomKey);
        let vrvsAreasCustom = null;
        if (areasCustomRaw !== null) {
            vrvsAreasCustom = (typeof window.safeParseLS === 'function') ? window.safeParseLS(areasCustomKey, [], 4 * 1024 * 1024) : safeJSONFromLS(areasCustomKey, []);
        }
        if ((vrvsAreasCustom === null || !Array.isArray(vrvsAreasCustom)) && window.vrvs_perfilAtivo === 'DEFAULT') {
            const legacyRaw = localStorage.getItem('vrvs_areas_custom');
            if (legacyRaw !== null) {
                vrvsAreasCustom = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_areas_custom', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_areas_custom', []);
            }
        }
        // Garantir Array, garantir strings, trim, remover vazios, deduplicar, sort
        if (!Array.isArray(vrvsAreasCustom)) vrvsAreasCustom = [];
        vrvsAreasCustom = vrvsAreasCustom
            .map(a => String(a).trim())
            .filter(a => a.length > 0)
            .filter((a, i, arr) => arr.indexOf(a) === i) // Deduplicar
            .sort();
        window.vrvsAreasCustom = vrvsAreasCustom;
        
        let lembretesKey = window.vrvs_key('lembretes');
        let lembretesRaw = localStorage.getItem(lembretesKey);
        let lembretes = null;
        if (lembretesRaw !== null) {
            lembretes = (typeof window.safeParseLS === 'function') ? window.safeParseLS(lembretesKey, [], 4 * 1024 * 1024) : safeJSONFromLS(lembretesKey, []);
        }
        if ((lembretes === null || !Array.isArray(lembretes)) && window.vrvs_perfilAtivo === 'DEFAULT') {
            const legacyRaw = localStorage.getItem('vrvs_lembretes');
            if (legacyRaw !== null) {
                lembretes = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_lembretes', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_lembretes', []);
            }
        }
        if (!lembretes || !Array.isArray(lembretes)) lembretes = [];
        
        let anotacoesKey = window.vrvs_key('anotacoes');
        let anotacoesRaw = localStorage.getItem(anotacoesKey);
        let anotacoes = null;
        if (anotacoesRaw !== null) {
            anotacoes = (typeof window.safeParseLS === 'function') ? window.safeParseLS(anotacoesKey, [], 4 * 1024 * 1024) : safeJSONFromLS(anotacoesKey, []);
        }
        if ((anotacoes === null || !Array.isArray(anotacoes)) && window.vrvs_perfilAtivo === 'DEFAULT') {
            const legacyRaw = localStorage.getItem('vrvs_anotacoes');
            if (legacyRaw !== null) {
                anotacoes = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_anotacoes', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_anotacoes', []);
            }
        }
        if (!anotacoes || !Array.isArray(anotacoes)) anotacoes = [];
        
        // Aplicar corre√ß√£o de invers√£o √°rea/tema nos dados carregados
        if (Array.isArray(dados)) {
            dados = dados.map(d => fixAreaTemaObjeto(d));
        }
        if (typeof __vrvsMark === 'function') __vrvsMark(3); // Logo ap√≥s concluir o carregamento dos dados
        if (typeof setBootStep === 'function') setBootStep(3);
        
        // Limpar dados corrompidos
        function limparDadosCorretos() {
            const dadosOriginais = dados.length;
            dados = dados.filter(t => {
                if (!t.area || t.area.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.area && t.area.toLowerCase().includes('sugest')) return false;
                if (!t.tema || t.tema.toLowerCase().includes('revisao ativa') || t.tema.toLowerCase().includes('revis√£o ativa')) return false;
                if (t.tema.length > 100) return false;
                if (t.tema.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.tema.includes('Sugest√£o:') || t.tema.includes('sugest√£o:')) return false;
                if ((t.tema.match(/\|/g) || []).length > 2) return false;
                return true;
            });
            
            if (dados.length < dadosOriginais) {
                console.log(`üßπ Limpeza: removidos ${dadosOriginais - dados.length} registros corrompidos`);
                // S3B: Proteger setItem contra quota excedida (com abort se falhar)
                try {
                    localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                } catch(e) {
                    if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                        if (typeof window.abortBoot === 'function') {
                            window.abortBoot('QUOTA_DADOS_CLEAN', 'QUOTA');
                        }
                        throw new Error('QUOTA_EXCEEDED: Falha ao salvar dados limpos');
                    } else {
                        throw e;
                    }
                }
            }
        }
        
        limparDadosCorretos();
        
        // Fun√ß√£o para limpar hist√≥rico inv√°lido (usada na inicializa√ß√£o e ap√≥s importa√ß√£o)
        function limparHistoricoInvalido() {
            const historicoOriginal = historico.length;
            
            historico = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historico.length < historicoOriginal) {
                // S3B: Proteger setItem contra quota excedida (com abort se falhar)
                try {
                    localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                    console.log(`üßπ Limpeza: removidos ${historicoOriginal - historico.length} registros inv√°lidos do hist√≥rico`);
                } catch(e) {
                    if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                        if (typeof window.abortBoot === 'function') {
                            window.abortBoot('QUOTA_HISTORICO_CLEAN', 'QUOTA');
                        }
                        throw new Error('QUOTA_EXCEEDED: Falha ao salvar hist√≥rico limpo');
                    } else {
                        throw e;
                    }
                }
            }
        }
        
        limparHistoricoInvalido(); // Limpar hist√≥rico inv√°lido na inicializa√ß√£o
        
        // CORRE√á√ÉO URGENTE: Normalizar √°reas duplicadas em todos os dados
        function normalizarAreasEmMassa() {
            let alteracoes = 0;
            
            // Normalizar dados
            if (Array.isArray(dados)) {
                dados.forEach(t => {
                    const areaAntiga = t.area;
                    t.area = normalizarArea(t.area);
                    if (areaAntiga !== t.area) alteracoes++;
                });
            }
            
            // Normalizar hist√≥rico
            if (Array.isArray(historico)) {
                historico.forEach(h => {
                    const areaAntiga = h.area;
                    h.area = normalizarArea(h.area);
                    if (areaAntiga !== h.area) alteracoes++;
                });
            }
            
            // Normalizar anota√ß√µes
            if (Array.isArray(anotacoes)) {
                anotacoes.forEach(a => {
                    if (a.area) {
                        const areaAntiga = a.area;
                        a.area = normalizarArea(a.area);
                        if (areaAntiga !== a.area) alteracoes++;
                    }
                });
            }
            
            // Normalizar di√°rio
            try {
                const diarioSalvo = localStorage.getItem(window.vrvs_diarioKey());
                if (diarioSalvo) {
                    let diario;
                    try {
                        diario = JSON.parse(diarioSalvo);
                    } catch(e) {
                        if (typeof setBootErr === 'function') {
                            // S3J: Passar objeto Error completo com stack
                            setBootErr({ 
                                message: 'vrvs_diario(norm): ' + (e.message || String(e || 'Diario norm error')), 
                                stack: e.stack || '' 
                            });
                        }
                        diario = null;
                    }
                    if (diario && Array.isArray(diario.entradas)) {
                        diario.entradas.forEach(e => {
                            if (e.area) {
                                const areaAntiga = e.area;
                                e.area = normalizarArea(e.area);
                                if (areaAntiga !== e.area) alteracoes++;
                            }
                        });
                        // S3B: Proteger setItem contra quota excedida (com abort se falhar)
                        try {
                            localStorage.setItem(window.vrvs_diarioKey(), JSON.stringify(diario));
                        } catch(e) {
                            if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                                // Abortar boot e redirecionar
                                if (typeof window.abortBoot === 'function') {
                                    window.abortBoot('QUOTA_DIARIO_NORM', 'QUOTA');
                                }
                                throw new Error('QUOTA_EXCEEDED: Falha ao salvar di√°rio normalizado');
                            } else {
                                throw e; // Re-lan√ßar se n√£o for quota
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('[NORMALIZA√á√ÉO] Erro ao normalizar di√°rio:', e);
            }
            
            // Salvar dados normalizados (S3B: protegido com abort se quota)
            if (alteracoes > 0) {
                // Verificar se j√° abortou antes de tentar salvar
                if (window.__vrvsBootAbort) {
                    console.warn('[S3B] Boot abortado, pulando salvamento de dados normalizados');
                    return;
                }
                
                try {
                    localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                } catch(e) {
                    if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                        if (typeof window.abortBoot === 'function') {
                            window.abortBoot('QUOTA_DADOS_NORM', 'QUOTA');
                        }
                        throw new Error('QUOTA_EXCEEDED: Falha ao salvar dados normalizados');
                    } else {
                        throw e;
                    }
                }
                
                // Se abortou ap√≥s dados, n√£o tentar hist√≥rico
                if (window.__vrvsBootAbort) return;
                
                try {
                    localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                } catch(e) {
                    if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                        if (typeof window.abortBoot === 'function') {
                            window.abortBoot('QUOTA_HISTORICO_NORM', 'QUOTA');
                        }
                        throw new Error('QUOTA_EXCEEDED: Falha ao salvar hist√≥rico normalizado');
                    } else {
                        throw e;
                    }
                }
                
                // Se abortou ap√≥s hist√≥rico, n√£o tentar anota√ß√µes
                if (window.__vrvsBootAbort) return;
                
                try {
                    localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                } catch(e) {
                    if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                        if (typeof window.abortBoot === 'function') {
                            window.abortBoot('QUOTA_ANOTACOES_NORM', 'QUOTA');
                        }
                        throw new Error('QUOTA_EXCEEDED: Falha ao salvar anota√ß√µes normalizadas');
                    } else {
                        throw e;
                    }
                }
                
                console.log(`‚úÖ Normaliza√ß√£o: ${alteracoes} √°reas corrigidas`);
            }
        }
        
        // Executar normaliza√ß√£o na inicializa√ß√£o
        normalizarAreasEmMassa();
        
        // CR√çTICO: Atribuir dados √†s vari√°veis globais para uso em toda a aplica√ß√£o
        window.dados = dados;
        window.historico = historico;
        window.anotacoes = anotacoes;
        window.lembretes = lembretes;
        
        // Carregar di√°rio e atribuir a window.diario
        try {
            const diarioSalvo = localStorage.getItem('vrvs_diario');
            const schemaVersion = (typeof DIARIO_SCHEMA_VERSION !== 'undefined' ? DIARIO_SCHEMA_VERSION : '1.0');
            if (diarioSalvo) {
                let diarioParsed;
                try {
                    diarioParsed = JSON.parse(diarioSalvo);
                } catch(e) {
                    if (typeof setBootErr === 'function') {
                        // S3J: Passar objeto Error completo com stack
                        setBootErr({ 
                            message: 'vrvs_diario: ' + (e.message || String(e || 'Diario error')), 
                            stack: e.stack || '' 
                        });
                    }
                    diarioParsed = null;
                }
                // Compatibilidade: aceitar tanto {entradas:[]} quanto [] direto
                if (Array.isArray(diarioParsed)) {
                    window.diario = { entradas: diarioParsed, schemaVersion: schemaVersion };
                } else if (diarioParsed && Array.isArray(diarioParsed.entradas)) {
                    window.diario = diarioParsed;
                } else {
                    window.diario = { entradas: [], schemaVersion: schemaVersion };
                }
            } else {
                window.diario = { entradas: [], schemaVersion: schemaVersion };
            }
        } catch (e) {
            if (typeof setBootErr === 'function') {
                // S3J: Passar objeto Error completo com stack
                setBootErr({ 
                    message: 'diario_init: ' + (e.message || String(e || 'Diario init error')), 
                    stack: e.stack || '' 
                });
            }
            console.error('[INICIALIZA√á√ÉO] Erro ao carregar di√°rio:', e);
            window.diario = { entradas: [], schemaVersion: '1.0' };
        }
        
        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function mostrarNotificacaoFeedback(mensagem, tipo = 'success') {
            const container = document.getElementById('feedbackMessage');
            container.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function extrairUltimaSugestao(observacoes) {
            if (!observacoes) return '';
            const linhas = observacoes.split('\n');
            for (let i = linhas.length - 1; i >= 0; i--) {
                const linha = linhas[i];
                if (linha.includes('Sugest√£o:') || linha.includes('sugest√£o:')) {
                    const partes = linha.split(/[Ss]ugest√£o:/);
                    if (partes.length > 1) {
                        return partes[1].trim().replace(/^\|/, '').replace(/\|$/, '').trim();
                    }
                }
            }
            return '';
        }
        
        function obterSugestaoTema(tema) {
            if (!tema) return '';
            if (tema.sugestao && tema.sugestao !== '-' && tema.sugestao.trim() !== '') {
                return tema.sugestao.trim();
            }
            return extrairUltimaSugestao(tema.observacoes);
        }

        function calcularTipoRevisao(tema) {
            const rend = tema.rendimento || 0;
            const sess = tema.sessoes || 0;
            
            if (sess === 0) return 'üÜï Primeira sess√£o';
            if (sess === 1) return '‚ö° Quest√µes/flashcards';
            if (rend < 0.50) return 'üìö Revisar teoria completa';
            if (rend < 0.60) return 'üìπ Aula + quest√µes';
            if (rend < 0.80) return 'üìñ Resumo + quest√µes';
            return '‚ö° Quest√µes/flashcards';
        }
        
        // CORRE√á√ÉO: Normaliza√ß√£o robusta de √°reas para evitar duplicatas
        function normalizarArea(area) {
            if (!area || typeof area !== 'string') return '';
            
            // Normalizar: remover espa√ßos extras, converter para min√∫sculas, remover acentos
            const areaNormalizada = area.trim().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' '); // Normalizar espa√ßos m√∫ltiplos
            
            // Mapa completo de varia√ß√µes para √°reas fixas
            const mapaNormalizacao = {
                // Ci√™ncias B√°sicas
                'ciencias basicas': 'Ci√™ncias B√°sicas',
                
                // Ortopedia Pedi√°trica
                'ortopedia pediatrica': 'Ortopedia Pedi√°trica',
                
                // M√£o e Punho ‚Üí M√£o (unificar todas varia√ß√µes)
                'mao e punho': 'M√£o',
                'm√£o e punho': 'M√£o',
                'mao': 'M√£o',
                'm√£o': 'M√£o',
                'punho': 'M√£o',
                
                // Trauma MMSS
                'trauma mmss': 'Trauma MMSS',
                'trauma membros superiores': 'Trauma MMSS',
                
                // Trauma MMII
                'trauma mmii': 'Trauma MMII',
                'trauma membros inferiores': 'Trauma MMII',
                
                // Ombro e Cotovelo
                'ombro e cotovelo': 'Ombro e Cotovelo',
                'ombro': 'Ombro e Cotovelo',
                'cotovelo': 'Ombro e Cotovelo',
                
                // Outras √°reas (manter como est√£o)
                'joelho': 'Joelho',
                'quadril': 'Quadril',
                'pelve': 'Quadril',
                'pe e tornozelo': 'P√© e Tornozelo',
                'p√© e tornozelo': 'P√© e Tornozelo',
                'tornozelo': 'P√© e Tornozelo',
                'coluna': 'Coluna',
                'oncologia': 'Oncologia',
                'tumores': 'Oncologia',
                'trauma pediatrico': 'Trauma Pedi√°trico',
                'trauma pedi√°trico': 'Trauma Pedi√°trico',
                'trauma ped': 'Trauma Pedi√°trico',
                'trauma pediat': 'Trauma Pedi√°trico'
            };
            
            // Verificar se √°rea normalizada est√° no mapa
            if (mapaNormalizacao[areaNormalizada]) {
                return mapaNormalizacao[areaNormalizada];
            }
            
            // Plataforma livre - retornar √°rea normalizada como est√°
            // Android Acentos: N√ÉO usar title-case ASCII (quebra Unicode/acentos)
            // Retornar exatamente como est√° salvo (trim apenas)
            return area.trim();
        }
        
        // Manter fun√ß√£o antiga para compatibilidade (chama a nova)
        function normalizeArea(rawArea, tema) {
            return normalizarArea(rawArea);
        }
        
        function fixAreaTema(area, tema) {
            if (!area || !tema) return { area: area || '', tema: tema || '' };
            
            // Verificar se √°rea e tema est√£o invertidos
            // Se o "tema" parece ser uma √°rea (cont√©m palavras-chave de √°rea)
            const areaKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'tornozelo', 'coluna', 'oncologia', 'tumores'];
            const temaLower = String(tema).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Se tema cont√©m palavras-chave de √°rea e √°rea n√£o, provavelmente est√£o invertidos
            const temaEhArea = areaKeywords.some(keyword => temaLower.includes(keyword));
            const areaEhArea = areaKeywords.some(keyword => String(area).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(keyword));
            
            if (temaEhArea && !areaEhArea) {
                // Est√£o invertidos, trocar
                return { area: normalizeArea(tema, ''), tema: area };
            }
            
            return { area: normalizeArea(area, tema), tema: tema };
        }
        
        function dataValida(data) {
            if (!data || data === '-' || String(data).trim() === '') return false;
            try {
                const dt = new Date(data + 'T00:00:00');
                return !isNaN(dt.getTime());
            } catch (e) {
                return false;
            }
        }
        
        function formatarDataBR(data) {
            if (!dataValida(data)) return '-';
            try {
                return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            } catch (e) {
                return '-';
            }
        }
        
        function formatarData(dataStr) {
            // Mantida para compatibilidade - usa formatarDataBR internamente
            return formatarDataBR(dataStr);
        }
        
        function calcularProximaRevisao(tema, dataSessao = null) {
            // CORRE√á√ÉO: Conclu√≠do n√£o entra no algoritmo - retornar vazio
            if (tema.status === 'Conclu√≠do') {
                return '';
            }
            
            // CORRE√á√ÉO: Usar data da sess√£o se fornecida, sen√£o usar data atual
            const dataBase = dataSessao ? new Date(dataSessao + 'T00:00:00') : new Date();
            dataBase.setHours(0, 0, 0, 0);
            
            // CORRE√á√ÉO CR√çTICA: Se √© PRIMEIRA sess√£o (contador = 1 OU √∫ltima data = null), sempre +1 dia
            const sessoes = tema.sessoes || 0;
            const ultEstudo = tema.ultEstudo || null;
            
            if (sessoes === 0 || sessoes === 1 || !ultEstudo || ultEstudo === null || ultEstudo === '') {
                const proxima = new Date(dataBase);
                proxima.setDate(proxima.getDate() + 1);
                return proxima.toISOString().split('T')[0];
            }
            
            // SOMENTE ap√≥s segunda sess√£o em diante: aplicar algoritmo normal
            const rendimento = Math.round((tema.rendimento || 0) * 100);
            const prioridade = parseInt(tema.prioridade) || 3;
            const contador80 = parseInt(tema.contador80) || 0;
            let intervalo = 1;
            
            if (rendimento < 50) {
                intervalo = 1;
            } else if (rendimento >= 50 && rendimento < 80) {
                intervalo = 3;
            } else {
                if (contador80 === 0) intervalo = 7;
                else if (contador80 === 1) intervalo = 14;
                else if (contador80 === 2) intervalo = 30;
                else intervalo = 60;
                
                if (prioridade === 5 && intervalo > 30) {
                    intervalo = 30;
                }
            }
            
            const proxima = new Date(dataBase);
            proxima.setDate(proxima.getDate() + intervalo);
            return proxima.toISOString().split('T')[0];
        }

        // ==================== MODAL DE EDI√á√ÉO ====================
        
        function openEditModal(id) {
            const tema = dados.find(t => t.id == id);
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Popular select de √°reas usando helper centralizado
            const editAreaSelect = document.getElementById('editArea');
            if (editAreaSelect) {
                // Usar helper centralizado para obter todas as √°reas dispon√≠veis
                const areasCompletas = getAreasDisponiveisDoPerfilAtivo();
                
                editAreaSelect.innerHTML = '<option value="">Selecione...</option>' + 
                    areasCompletas.map(area => `<option value="${area}">${area}</option>`).join('') +
                    '<option value="__NOVA_AREA__">‚ûï Adicionar Nova √Årea...</option>';
                
                // Garantir sele√ß√£o da √°rea atual (mesmo que n√£o esteja em AREAS_FIXAS)
                if (tema.area && areasCompletas.includes(tema.area)) {
                    editAreaSelect.value = tema.area;
                } else {
                    editAreaSelect.value = tema.area || '';
                }
            }
            
            // Garantir que input est√° escondido ao abrir modal
            const editAreaInput = document.getElementById('editAreaInput');
            if (editAreaInput) {
                editAreaInput.style.display = 'none';
                editAreaInput.required = false;
            }
            
            document.getElementById('editId').value = tema.id;
            document.getElementById('editTema').value = tema.tema;
            document.getElementById('editPrioridade').value = tema.prioridade || 3;
            document.getElementById('editStatus').value = tema.status || 'Planejado';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea no cadastro
        function handleNovaAreaChange(select) {
            handleAreaChange(select, 'novaAreaInput');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea na edi√ß√£o
        function handleEditAreaChange(select) {
            handleAreaChange(select, 'editAreaInput');
        }
        
        // Fun√ß√£o para gerenciar adi√ß√£o de nova √°rea no modal de dados
        function handleModalNovaAreaChange(select) {
            handleAreaChange(select, 'modalNovaAreaInput');
        }
        
        // Fun√ß√£o gen√©rica para abrir input de nova √°rea (chamada pelo bot√£o)
        function abrirInputNovaArea(selectId, inputId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (!select || !input) return;
            
            // Esconder select e mostrar input
            select.style.display = 'none';
            input.style.display = 'block';
            input.value = '';
            input.focus();
            input.required = true;
            
            // Quando perder foco ou pressionar Enter, salvar e voltar para select
            const salvarEVoltar = function() {
                const valorDigitado = input.value.trim();
                if (valorDigitado) {
                    // Normalizar √°rea
                    const areaNormalizada = normalizarArea(valorDigitado);
                    
                    // Adicionar ao select se n√£o existir
                    const opcoes = Array.from(select.options).map(opt => opt.value);
                    if (!opcoes.includes(areaNormalizada)) {
                        const novaOpcao = document.createElement('option');
                        novaOpcao.value = areaNormalizada;
                        novaOpcao.textContent = areaNormalizada;
                        select.appendChild(novaOpcao);
                    }
                    
                    // Selecionar a √°rea normalizada
                    select.value = areaNormalizada;
                    
                    // Trigger change event para atualizar depend√™ncias (temas, etc)
                    select.dispatchEvent(new Event('change'));
                }
                
                // Voltar para select
                select.style.display = 'block';
                input.style.display = 'none';
                input.required = false;
                input.onblur = null;
                input.onkeypress = null;
            };
            
            input.onblur = salvarEVoltar;
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    salvarEVoltar();
                }
            };
        }
        
        // Fun√ß√£o gen√©rica para gerenciar adi√ß√£o de nova √°rea
        function handleAreaChange(select, inputId) {
            const areaInput = document.getElementById(inputId);
            if (!areaInput) return;
            
            if (select.value === '__NOVA_AREA__') {
                // Mostrar input e esconder select
                select.style.display = 'none';
                areaInput.style.display = 'block';
                areaInput.value = '';
                areaInput.focus();
                areaInput.required = true;
                
                // Quando perder foco ou pressionar Enter, voltar para select
                areaInput.onblur = function() {
                    const valorDigitado = areaInput.value.trim();
                    if (valorDigitado) {
                        // Normalizar e adicionar ao select se n√£o existir
                        const areaNormalizada = normalizarArea(valorDigitado);
                        select.value = areaNormalizada;
                        
                        // Se n√£o est√° nas √°reas fixas, adicionar como op√ß√£o tempor√°ria
                        const opcoes = Array.from(select.options).map(opt => opt.value);
                        if (!opcoes.includes(areaNormalizada) && areaNormalizada !== '__NOVA_AREA__') {
                            // Adicionar antes da op√ß√£o "__NOVA_AREA__"
                            const novaOpcao = document.createElement('option');
                            novaOpcao.value = areaNormalizada;
                            novaOpcao.textContent = areaNormalizada;
                            select.insertBefore(novaOpcao, select.lastElementChild);
                        }
                    }
                    
                    // Voltar para select
                    select.style.display = 'block';
                    areaInput.style.display = 'none';
                    areaInput.required = false;
                    areaInput.onblur = null;
                };
                
                areaInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        areaInput.blur();
                    }
                };
            } else {
                // Esconder input se selecionar outra op√ß√£o
                areaInput.style.display = 'none';
                areaInput.required = false;
            }
        }

        // ==================== RENDERIZA√á√ÉO DE COMPONENTES ====================
        
        function renderPendencias() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const hojeStr = hoje.toISOString().split('T')[0];
            
            // Data limite: hoje - 7 dias
            const limite = new Date(hoje);
            limite.setDate(limite.getDate() - 7);
            const limiteStr = limite.toISOString().split('T')[0];
            
            const container = document.getElementById('pendenciasContainer');
            if (!container) return;
            
            const pendencias = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                if (!dataValida(t.agenda)) return false;
                // Tarefas com mais de 7 dias de atraso
                const agendaDate = new Date(t.agenda + 'T00:00:00');
                const limiteDate = new Date(limiteStr + 'T00:00:00');
                return agendaDate < limiteDate;
            });
            
            if (pendencias.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma pend√™ncia!</div></div>';
                return;
            }
            
            // Ordenar: mais recente primeiro, depois menos sess√µes
            pendencias.sort((a, b) => {
                const diffData = new Date(b.agenda) - new Date(a.agenda);
                if (diffData !== 0) return diffData;
                return (a.sessoes || 0) - (b.sessoes || 0);
            });
            
            // Vari√°vel para controlar pend√™ncias expandidas
            let pendenciasExpandidas = window.pendenciasExpandidas || new Set();
            window.pendenciasExpandidas = pendenciasExpandidas;
            
            container.innerHTML = pendencias.map(t => {
                // CORRE√á√ÉO: Garantir que ID seja sempre v√°lido e consistente (sempre string)
                const temaId = t.id != null ? String(t.id) : null;
                if (!temaId) {
                    console.warn('[PENDENCIAS] Tema sem ID v√°lido:', t.tema);
                    return '';
                }
                
                // DEBUG: Log para identificar problemas com IDs espec√≠ficos
                if (['Fratura de clav√≠cula', 'Epifisiolistese', 'Sd manguito rotador', 'DDQ', 'Luxa√ß√£o e Instabilidade do cotovelo', 'LAC/LEC', 'Epicondilites', 'Fraturas do cotovelo'].includes(t.tema)) {
                    console.log('[PENDENCIAS DEBUG] Tema:', t.tema, 'ID:', temaId, 'Tipo ID original:', typeof t.id);
                }
                
                // CORRE√á√ÉO: Garantir que compara√ß√£o no Set use sempre string
                const isExpanded = pendenciasExpandidas.has(temaId);
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const dataFormatada = formatarDataBR(t.agenda);
                const diasAtraso = Math.floor((new Date(hojeStr) - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CORRE√á√ÉO DEFINITIVA: Bug onclick com IDs contendo underscore
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PROBLEMA IDENTIFICADO:
                // - JSON.stringify retorna aspas duplas: '"1733174400000_5"'
                // - Quando interpolado em onclick="...", fecha aspas prematuramente
                // - HTML gerado: onclick="togglePendencia("1733174400000_5")" = INV√ÅLIDO
                //
                // SOLU√á√ÉO CORRETA (Opus):
                // - Escape manual de aspas simples e barras
                // - Usar aspas SIMPLES no onclick (n√£o conflita com aspas duplas do HTML)
                // - HTML gerado: onclick="togglePendencia('1733174400000_5')" = V√ÅLIDO
                // Escape para onclick inline (solu√ß√£o simples que funciona)
                const temaIdStr = String(temaId);
                const temaIdEscaped = temaIdStr.replace(/'/g, "\\'").replace(/\\/g, "\\\\");
                
                return `
                <div class="task-theme-item priority-${t.prioridade || 3}" data-tema-id="${temaIdStr}" onclick="togglePendencia('${temaIdEscaped}')" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(255,127,80,0.3); cursor: pointer;">
                    <div class="task-theme-name" style="pointer-events: none; user-select: none;">${t.tema}</div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 4px; pointer-events: none; user-select: none;">üìö ${t.area} ‚Ä¢ ‚ö†Ô∏è ${diasAtraso} dias atrasado</div>
                    ${isExpanded ? `
                    <div class="task-expanded" style="pointer-events: none;">
                        <div class="task-details">
                            <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                            <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                            <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                            <div class="task-detail-item">üìÖ ${dataFormatada}</div>
                </div>
                        ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                        ${sugestao ? `
                        <div class="task-suggestion">
                            <div class="task-suggestion-label">Diretriz</div>
                            <div class="task-suggestion-text">${sugestao}</div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }
        
        // REMOVIDO: inicializarEventListenersPendencias()
        // Usando onclick inline diretamente no HTML (mesma solu√ß√£o das outras abas que funcionam)
        // Event delegation estava causando m√∫ltiplos listeners e travamentos
        
        // Vari√°vel global para controlar visibilidade dos campos de tempo
        window.camposTempoVisiveis = false;
        
        function toggleCamposTempo() {
            window.camposTempoVisiveis = !window.camposTempoVisiveis;
            const toggleText = document.getElementById('toggleTempoText');
            if (toggleText) {
                toggleText.textContent = window.camposTempoVisiveis ? '‚è±Ô∏è Ocultar Tempos' : '‚è±Ô∏è Mostrar Tempos';
            }
            renderTarefas();
            renderAgenda();
        }
        
        window.togglePendencia = function(temaId) {
            // DEBUG: Log para identificar problemas
            console.log('[PENDENCIAS] togglePendencia chamado com temaId:', temaId, 'tipo:', typeof temaId);
            
            // CORRE√á√ÉO: Validar ID antes de processar
            if (temaId == null || temaId === '') {
                console.warn('[PENDENCIAS] Tentativa de toggle com ID inv√°lido:', temaId);
                return;
            }
            
            // Garantir que temaId seja string para compara√ß√£o consistente
            temaId = String(temaId);
            
            // DEBUG: Log espec√≠fico para itens problem√°ticos
            const temasProblema = ['Fratura de clav√≠cula', 'Epifisiolistese', 'Sd manguito rotador', 'DDQ', 'Luxa√ß√£o e Instabilidade do cotovelo', 'LAC/LEC', 'Epicondilites', 'Fraturas do cotovelo'];
            const tema = dados.find(t => String(t.id) === temaId);
            if (tema && temasProblema.includes(tema.tema)) {
                console.log('[PENDENCIAS DEBUG] Item problem√°tico detectado:', tema.tema, 'ID:', temaId);
            }
            
            if (!window.pendenciasExpandidas) {
                window.pendenciasExpandidas = new Set();
            }
            if (window.pendenciasExpandidas.has(temaId)) {
                window.pendenciasExpandidas.delete(temaId);
            } else {
                window.pendenciasExpandidas.add(temaId);
            }
            renderPendencias();
            // REMOVIDO: N√£o precisa re-inicializar listeners ap√≥s cada toggle
            // Isso estava causando m√∫ltiplos listeners e travamentos
        };
        
        // ==================== CONTEXTO DO TEMA (Fase 4.1) ====================
        
        // Buscar contexto relacionado a um tema (Di√°rio ‚ö†Ô∏è, Hot Topics, Anota√ß√µes)
        function buscarContextoTema(area, tema) {
            const contexto = {
                atencao: [], // Entradas do Di√°rio com ‚ö†Ô∏è
                hotTopics: [],
                anotacoes: []
            };
            
            // 1. Buscar itens ‚ö†Ô∏è do Di√°rio
            if (window.diario && window.diario.entradas) {
                contexto.atencao = window.diario.entradas.filter(e => 
                    e.area === area && 
                    e.tema === tema && 
                    e.atencao === true
                );
            }
            
            // 2. Buscar Hot Topics e Anota√ß√µes do Caderno
            const anotacoesTema = anotacoes.filter(a => 
                a.area === area && 
                a.tema === tema
            );
            
            anotacoesTema.forEach(anot => {
                if (anot.hotTopics && anot.hotTopics.trim()) {
                    contexto.hotTopics.push({
                        texto: anot.hotTopics.trim(),
                        temaId: anot.temaId // Incluir temaId para navega√ß√£o
                    });
                }
                if (anot.conteudo && anot.conteudo.trim()) {
                    contexto.anotacoes.push(anot);
                }
            });
            
            return contexto;
        }
        
        // Renderizar contexto do tema em container
        function renderContextoTema(contexto, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            // Render se√ß√£o Aten√ß√£o (‚ö†Ô∏è)
            if (contexto.atencao.length > 0) {
                html += `
                    <div class="contexto-secao">
                        <h4>‚ö†Ô∏è PONTOS DE ATEN√á√ÉO (Di√°rio)</h4>
                        ${contexto.atencao.map(item => `
                            <div class="contexto-item" onclick="navegarParaEntradaDiario('${item.id}')">
                                ‚Ä¢ ${item.topico}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Render Hot Topics (com link para Caderno)
            if (contexto.hotTopics.length > 0) {
                // Usar temaId do primeiro hotTopic (j√° inclu√≠do na busca)
                const temaId = contexto.hotTopics[0]?.temaId || contexto.anotacoes[0]?.temaId || null;
                html += `
                    <div class="contexto-secao">
                        <h4>üìå HOT TOPICS</h4>
                        ${contexto.hotTopics.map(ht => `
                            <div class="contexto-item contexto-item-hottopics" ${temaId ? `onclick="navegarParaCadernoTema('${temaId}')"` : ''} style="${temaId ? 'cursor: pointer;' : ''}">‚Ä¢ ${ht.texto}</div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Render Anota√ß√µes (com link para Caderno)
            if (contexto.anotacoes.length > 0) {
                const temaId = contexto.anotacoes[0].temaId;
                html += `
                    <div class="contexto-secao">
                        <h4>üìù ANOTA√á√ïES (Caderno)</h4>
                        <div class="contexto-item" onclick="navegarParaCadernoTema('${temaId}')" style="cursor: pointer;">
                            ${contexto.anotacoes.length} anota√ß√£o(√µes) dispon√≠vel(eis) ‚Üí Clique para ver
                        </div>
                    </div>
                `;
            }
            
            // Se n√£o tiver nada
            if (!html) {
                html = '<div class="contexto-vazio">Nenhum contexto adicional dispon√≠vel</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Navegar para entrada espec√≠fica do Di√°rio
        function navegarParaEntradaDiario(entradaId) {
            // Mostrar se√ß√£o Di√°rio
            showSection('diario');
            
            // Filtrar para mostrar apenas a entrada espec√≠fica
            setTimeout(() => {
                // Tentar encontrar e destacar a entrada
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (entrada) {
                    // Filtrar Di√°rio para mostrar apenas esta entrada
                    const container = document.getElementById('diarioContainer');
                    if (container) {
                        // Renderizar apenas esta entrada destacada
                        container.innerHTML = `
                            <div style="background: rgba(0,206,209,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 2px solid var(--turquesa-main);">
                                <div style="font-size: 12px; color: var(--turquesa-light); margin-bottom: 8px;">
                                    üìç Entrada destacada
                                </div>
                                ${renderEntradaDiario(entrada)}
                            </div>
                            <button onclick="renderDiario()" class="btn btn-small" style="margin-bottom: 16px;">
                                ‚Üê Voltar para todas as entradas
                            </button>
                        `;
                    }
                }
            }, 300);
            }
            
        // ==================== SRS - INTEGRA√á√ÉO COM TAREFAS ====================
        
        // Contar quantos cards do Di√°rio est√£o programados para hoje dentro de um tema
        function contarDiarioProgramadoParaTema(area, tema) {
            // P1: Usar mesma fun√ß√£o que monta a fila para garantir consist√™ncia
            const entradas = getEntradasParaRevisarHojeDiario({ area, tema });
            return entradas.length;
        }
        
        // Abrir sess√£o do Di√°rio filtrada por tema
        // P1 FIX: Helper para evitar corrup√ß√£o de par√¢metros no onclick
        function abrirSessaoDiarioParaTemaFromBtn(btn) {
            const area = btn.getAttribute('data-area');
            const tema = btn.getAttribute('data-tema');
            abrirSessaoDiarioParaTema(area, tema);
        }
        
        function abrirSessaoDiarioParaTema(area, tema) {
            // P1 v2 OPUS: Montar fila AQUI para evitar timing issues
            const entradas = getEntradasParaRevisarHojeDiario({ area, tema });
            
            if (entradas.length === 0) {
                mostrarNotificacaoFeedback('üìã Sem t√≥picos deste tema para hoje', 'info');
                return;
            }
            
            // Guardar fila J√Å MONTADA com IDs (n√£o apenas filtros)
            window.sessaoFiltradaPreMontada = {
                filaIds: entradas.map(e => e.id),
                area: area,
                tema: tema,
                total: entradas.length,
                origem: 'tarefa'
            };
            
            // Ajustar filtros visuais (opcional)
            const filtroArea = document.getElementById('filtroDiarioArea');
            if (filtroArea) filtroArea.value = area || '';
            
            // Trocar para aba Di√°rio
            showSection('diario');
            
            setTimeout(() => {
                setModoSessaoDiario('programado');
                setAbaDiario('sessao');
            }, 100);
        }
        
        // ==================== FIM SRS INTEGRA√á√ÉO TAREFAS ====================
        
        // Navegar para tema espec√≠fico no Caderno
        function navegarParaCadernoTema(temaId) {
            const temaIdStr = String(temaId);
            
            // 1. Garantir que anota√ß√£o existe (sem criar lixo)
            if (typeof obterOuCriarAnotacao === 'function') {
                obterOuCriarAnotacao(temaIdStr);
            }
            
            // 2. Encontrar tema nos dados globais
            const tema = dados.find(t => String(t.id) === String(temaIdStr));
            if (!tema) {
                console.warn('[CADERNO] Tema n√£o encontrado:', temaIdStr);
                return;
            }
            
            // 3. Setar filtro de √°rea
            const selectArea = document.getElementById('cadernoFiltroArea');
            if (selectArea) {
                selectArea.value = tema.area || '';
            }
            
            // 4. Navegar para aba Caderno
            showSection('caderno');
            
            // 5. Renderizar Caderno
            setTimeout(() => {
                if (typeof renderCadernoV2 === 'function') {
                renderCadernoV2();
                } else if (typeof renderCaderno === 'function') {
                    renderCaderno();
                }
                
                // 6. Ap√≥s render, expandir e scrollar
                // TAREFA 1 FIX: Aumentar timeout para garantir DOM totalmente renderizado
                setTimeout(() => {
                    const temaIdClean = temaIdStr;
                    
                    // Expandir √°rea (adaptar ao ID real)
                    const areaId = (tema.area || '')
                        .replace(/\s+/g, '-')
                        .replace(/[^a-zA-Z0-9-]/g, '');
                    const areaContent = document.getElementById(`area-content-${areaId}`);
                    if (areaContent && areaContent.classList.contains('collapsed')) {
                        if (typeof toggleAreaCaderno === 'function') {
                            toggleAreaCaderno(areaId);
                        }
                    }
                    
                    // Expandir tema - TAREFA 1 FIX: Garantir que CSS seja aplicado corretamente
                    setTimeout(() => {
                        const temaConteudo = document.getElementById(`tema-conteudo-${temaIdClean}`);
                        if (temaConteudo) {
                            // For√ßar expans√£o manual para garantir CSS correto
                            if (temaConteudo.classList.contains('collapsed')) {
                                temaConteudo.classList.remove('collapsed');
                                temaConteudo.style.display = 'block';
                                
                                // TAREFA 1 FIX: For√ßar altura completa sem limita√ß√£o
                                // Aguardar um frame para scrollHeight estar correto
                                requestAnimationFrame(() => {
                                    const scrollHeight = temaConteudo.scrollHeight || 0;
                                    temaConteudo.style.maxHeight = Math.max(scrollHeight + 100, 9999) + 'px';
                                    temaConteudo.style.overflow = 'visible';
                                    
                                    // Garantir que CSS de texto completo seja aplicado
                                    const hottopicsText = temaConteudo.querySelector('.hottopics-text');
                                    const conteudoText = temaConteudo.querySelector('.conteudo-text');
                                    if (hottopicsText) {
                                        hottopicsText.style.whiteSpace = 'pre-wrap';
                                        hottopicsText.style.wordWrap = 'break-word';
                                        hottopicsText.style.overflow = 'visible';
                                    }
                                    if (conteudoText) {
                                        conteudoText.style.whiteSpace = 'pre-wrap';
                                        conteudoText.style.wordWrap = 'break-word';
                                        conteudoText.style.overflow = 'visible';
                                    }
                                    
                                    // Scroll e highlight ap√≥s garantir conte√∫do completo
                                    setTimeout(() => {
                                        const elemento = document.querySelector(`[data-tema-id="${temaIdClean}"]`) || temaConteudo;
                    if (elemento) {
                        elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                            
                                            const originalBg = elemento.style.background;
                                            elemento.style.background = 'rgba(0, 206, 209, 0.22)';
                                            elemento.style.transition = 'background 0.3s ease';
                        setTimeout(() => {
                                                elemento.style.background = originalBg || '';
                        }, 2000);
                    }
            }, 100);
                                });
                            }
                        }
                    }, 150); // Aumentado de 0 para 150ms para garantir √°rea expandida primeiro
                }, 300); // Aumentado de 200ms para 300ms para garantir renderiza√ß√£o completa
            }, 200); // Aumentado de 100ms para 200ms para garantir showSection completou
        }
        
        // Toggle mostrar/ocultar contexto do tema
        function toggleContextoTema(temaId) {
            const containerId = `contexto-tema-${temaId}`;
            const container = document.getElementById(containerId);
            const botao = document.querySelector(`[onclick="toggleContextoTema('${temaId}')"]`);
            
            if (!container) return;
            
            if (container.style.display === 'none' || !container.style.display) {
                // Mostrar contexto
                container.style.display = 'block';
                if (botao) botao.textContent = 'üëÅÔ∏è OCULTAR CONTEXTO';
                
                // Buscar e renderizar contexto se ainda n√£o foi renderizado
                if (!container.innerHTML || container.innerHTML.trim() === '') {
                    const tema = dados.find(t => String(t.id) === String(temaId));
                    if (tema) {
                        const contexto = buscarContextoTema(tema.area, tema.tema);
                        renderContextoTema(contexto, containerId);
                    }
                }
            } else {
                // Ocultar contexto
                container.style.display = 'none';
                if (botao) botao.textContent = 'üëÅÔ∏è MOSTRAR CONTEXTO';
            }
        }
        
        // Helper: Renderizar card de tema (reutiliz√°vel)
        function renderCardTemaHTML(t, hojeStr, contagemDiarioPorTema = {}) {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const isHoje = t.agenda === hojeStr;
                const dataFormatada = formatarDataBR(t.agenda);
                
                // Contagem de di√°rio ativo para este tema
                const qtdAtivos = contagemDiarioPorTema[`${t.area}|${t.tema}`] || 0;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}" style="margin-bottom: 12px;">
                    <button class="btn-edit task-edit-btn" onclick="openEditModal(${t.id})" title="Editar tema/status">‚úèÔ∏è</button>
                    <div class="task-name" style="display: flex; align-items: center; gap: 8px;">
                        <span>${t.tema} ${isHoje ? 'üéØ' : ''}</span>
                        ${qtdAtivos > 0 ? `<span class="vrvs3p-pill-tema" title="T√≥picos ativos no Di√°rio" style="margin-left: 8px; padding: 2px 8px; border-radius: 999px; font-size: 11px; background: rgba(5, 25, 30, 0.96); border: 1px solid rgba(0, 206, 209, 0.5); opacity: 0.9; color: rgba(255,255,255,0.9);">üß† ${qtdAtivos}</span>` : ''}
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                        <div class="task-detail-item">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <button onclick="toggleContextoTema('${t.id}')" style="background: rgba(0,206,209,0.15); border: 1px solid rgba(0,206,209,0.3); color: var(--turquesa-light); padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px; width: 100%; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(0,206,209,0.25)'" onmouseout="this.style.background='rgba(0,206,209,0.15)'">
                        üëÅÔ∏è MOSTRAR CONTEXTO
                    </button>
                    
                    <div id="contexto-tema-${t.id}" class="contexto-container" style="display: none; margin-top: 12px;"></div>
                    
                    ${(() => {
                        const qtdDiario = contarDiarioProgramadoParaTema(t.area, t.tema);
                        if (qtdDiario > 0) {
                            return `
                                <div class="tema-diario-bloco" style="background: rgba(255,127,80,0.1); border: 1px solid rgba(255,127,80,0.3); border-radius: 10px; padding: 12px; margin-top: 12px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--cobre-light); margin-bottom: 6px;">üìî Di√°rio de Aprendizados</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                                        Voc√™ tem <strong style="color: var(--cobre-light);">${qtdDiario} t√≥pico${qtdDiario > 1 ? 's' : ''} deste tema</strong> para revisar hoje.
                            </div>
                                    <button class="btn btn-small" data-area="${(t.area || '').replace(/"/g, '&quot;')}" data-tema="${(t.tema || '').replace(/"/g, '&quot;')}" onclick="abrirSessaoDiarioParaTemaFromBtn(this)" style="width: 100%; background: var(--cobre-main); color: white; border: none;">
                                        üîÅ Abrir sess√£o do Di√°rio
                                    </button>
                            </div>
                            `;
                        }
                        return '';
                    })()}
                        </div>
            `;
        }
        
        function renderTarefas() {
            // BUG D: Usar data local (n√£o UTC)
            const hojeStr = hojeStrLocal();
            
            const container = document.getElementById('tarefasContainer');
            if (!container) return;
            
            let html = '';
            
            // ===== CALCULAR CONTAGEM DE DI√ÅRIO ATIVO POR TEMA (uma vez s√≥) =====
            const contagemDiarioPorTema = {};
            if (window.diario && Array.isArray(window.diario.entradas)) {
                window.diario.entradas.forEach(e => {
                    if (!e.srs || !e.srs.ativo) return;
                    const chave = `${e.area}|${e.tema}`;
                    contagemDiarioPorTema[chave] = (contagemDiarioPorTema[chave] || 0) + 1;
                });
            }
            
            // ===== BOX "REVIS√ïES DO DIA" =====
            // Contar t√≥picos do Di√°rio programados para hoje
            const diarioHabilitado = vrvs_isDiarioEnabled();
            const entradasHoje = getEntradasParaRevisarHojeDiario({ area: null, tema: null });
            const totalTopicos = entradasHoje.length;
            
            if (diarioHabilitado && totalTopicos > 0) {
                // Contar temas distintos
                const temasDistintos = new Set(entradasHoje.map(e => `${e.area}|${e.tema}`));
                const qtdTemas = temasDistintos.size;
                
                html += `
                    <div class="revisoes-dia-box" style="background: rgba(255, 159, 64, 0.10); border: 1px solid rgba(255, 159, 64, 0.30); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 15px; font-weight: 600; color: var(--cobre-light);">üìÖ REVIS√ïES DO DIA</span>
                            <span style="font-size: 13px; font-weight: 600; color: var(--cobre-light);">${totalTopicos} t√≥pico${totalTopicos > 1 ? 's' : ''}</span>
                        </div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            Voc√™ tem <strong style="color: var(--cobre-light);">${totalTopicos} t√≥pico${totalTopicos > 1 ? 's' : ''}</strong> do Di√°rio para revisar hoje${qtdTemas > 1 ? ` (distribu√≠dos em ${qtdTemas} temas)` : ''}.
                        </div>
                        <button class="btn btn-small" onclick="abrirRevisoesDoDia()" style="width: 100%; background: var(--cobre-main); color: white; border: none;">
                            üîÅ REVISAR TODOS
                        </button>
                    </div>
                `;
            }
            
            // BUG D: Data limite usando data local (hoje - 7 dias)
            const hojeDate = new Date();
            hojeDate.setHours(0, 0, 0, 0);
            const limite = new Date(hojeDate);
            limite.setDate(limite.getDate() - 7);
            const limiteStr = dateStrLocal(limite);
            
            const tarefas = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo') return false;
                if (!dataValida(t.agenda)) return false;
                // Apenas tarefas com at√© 7 dias de atraso (hoje at√© 7 dias atr√°s)
                const agendaDate = new Date(t.agenda + 'T00:00:00');
                const hojeDateLocal = new Date(hojeStr + 'T00:00:00');
                const limiteDateLocal = new Date(limiteStr + 'T00:00:00');
                return agendaDate <= hojeDateLocal && agendaDate >= limiteDateLocal;
            });
            
            if (tarefas.length === 0) {
                if (totalTopicos === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                } else {
                    container.innerHTML = html;
                }
                return;
            }
            
            // BUG D: Calcular "iniciado ontem" antes do sort
            const ontemLocal = ontemStrLocal();
            const ontemUTC = ontemStrUTC();
            
            tarefas.forEach(t => {
                const sessoes = Number(t.sessoes || 0);
                const ult = ymdFromAny(t.ultEstudo || t.ult_estudo || t.ultimoEstudo || t.ult || '');
                t._iniciadoOntem = (sessoes === 1) && (ult === ontemLocal || ult === ontemUTC);
            });
            
            // BUG D: Ordenar: iniciado ontem primeiro ‚Üí menos sess√µes ‚Üí agenda (mais atrasado) ‚Üí tema
            tarefas.sort((a, b) => {
                const ao = a._iniciadoOntem ? 1 : 0;
                const bo = b._iniciadoOntem ? 1 : 0;
                if (ao !== bo) return bo - ao; // iniciado ontem primeiro
                
                const sa = Number(a.sessoes || 0);
                const sb = Number(b.sessoes || 0);
                if (sa !== sb) return sa - sb; // menos sess√µes primeiro
                
                // tie-break: agenda mais atrasado primeiro (preferir mais urgente)
                const da = String(a.agenda || '');
                const db = String(b.agenda || '');
                if (da !== db) return da.localeCompare(db); // mais atrasado primeiro (menor data = mais urgente)
                
                return String(a.tema || '').localeCompare(String(b.tema || ''), 'pt-BR', { sensitivity: 'base' });
            });
            
            // BUG D: Agrupar por √°rea PRESERVANDO ordem global (n√£o ordenar √°reas alfabeticamente)
            const porArea = {};
            const orderedAreas = []; // Ordem de apari√ß√£o das √°reas conforme tarefas j√° ordenadas
            
            tarefas.forEach(t => {
                const area = t.area || 'Outros';
                if (!porArea[area]) {
                    porArea[area] = [];
                    orderedAreas.push(area); // Preservar ordem de primeira apari√ß√£o
                }
                porArea[area].push(t);
            });
            
            // BUG D: Usar orderedAreas (ordem global) em vez de Object.keys(porArea).sort()
            const areasOrdenadas = orderedAreas;
            
            if (areasOrdenadas.length === 0) {
                container.innerHTML = html || '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                return;
            }
            areasOrdenadas.forEach(area => {
                const areaId = `missoes-area-${area.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const temas = porArea[area];
                const totalTarefas = temas.length;
                
                // Header da √°rea (colaps√°vel leve, opcional)
                html += `
                    <div class="missoes-area" style="margin-bottom: 20px;">
                        <div class="missoes-area-header" onclick="toggleAreaCaderno('${areaId}')" style="cursor: pointer; padding: 10px 0; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,206,209,0.2);">
                            <span class="missoes-area-nome" style="font-size: 15px; font-weight: 600; color: var(--turquesa-light);">üìÅ ${area}</span>
                            <span class="missoes-area-badge" style="font-size: 12px; padding: 2px 8px; border-radius: 12px; background: rgba(0,206,209,0.2); color: rgba(255,255,255,0.9);">${totalTarefas} tarefa${totalTarefas > 1 ? 's' : ''}</span>
                            </div>
                        <div class="missoes-area-temas" id="area-content-${areaId}">
                            ${temas.map(t => renderCardTemaHTML(t, hojeStr, contagemDiarioPorTema)).join('')}
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ===== PATCH D - FUN√á√ÉO DE FILTRO DE TAREFAS =====
        // Fun√ß√£o para abrir sess√£o de revis√µes do dia (todos os t√≥picos)
        function abrirRevisoesDoDia() {
            if (!vrvs_isDiarioEnabled()) {
                alert('Di√°rio est√° desativado (dados preservados). V√° em Config para reativar.');
                showSection('config');
                return;
            }
            
            // Limpar filtros para pegar todos os t√≥picos do dia
            window.filtrosSessaoDiario = {
                origem: 'revisoes-do-dia'
            };
            
            // Trocar para aba Di√°rio
            showSection('diario');
            
            // Abrir aba "Sess√£o"
            setTimeout(() => {
                setAbaDiario('sessao');
                // Garantir modo programado por padr√£o
                setModoSessaoDiario('programado');
            }, 100);
        }
        
        function renderAgenda() {
            const hoje = obterYMDLocal();
            
            // Per√≠odo: inputs ou default pr√≥ximos 7 dias
            const inputInicio = document.getElementById('agendaDataInicio');
            const inputFim = document.getElementById('agendaDataFim');
            let dataInicio = inputInicio && inputInicio.value ? inputInicio.value : '';
            let dataFim = inputFim && inputFim.value ? inputFim.value : '';
            
            if (!dataInicio || !dataFim) {
                const base = new Date();
                const start = new Date(base);
                const end = new Date(base);
                end.setDate(end.getDate() + 7);
                dataInicio = start.toISOString().split('T')[0];
                dataFim = end.toISOString().split('T')[0];
                if (inputInicio && !inputInicio.value) inputInicio.value = dataInicio;
                if (inputFim && !inputFim.value) inputFim.value = dataFim;
            }
            
            const agendadas = dados
                .filter(t => {
                    if (!t || !t.agenda || t.status === 'Conclu√≠do') return false;
                    if (!dataValida(t.agenda) || !dataValida(dataInicio) || !dataValida(dataFim)) return false;
                    return t.agenda >= dataInicio && t.agenda <= dataFim;
                })
                .sort((a, b) => {
                    // Ordenar apenas por data (mais pr√≥xima primeiro)
                    return a.agenda.localeCompare(b.agenda);
                });
            
            const container = document.getElementById('agendaContainer');
            if (agendadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div>Timeline vazia</div></div>';
                return;
            }
            
            container.innerHTML = agendadas.map(t => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const dataFormatada = formatarDataBR(t.agenda);
                const tipo = calcularTipoRevisao(t);
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-date">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function filtrarSemanaAtual() {
            const hoje = new Date();
            const diaSemana = hoje.getDay(); // 0=Dom, 1=Seg, ...
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            
            document.getElementById('agendaDataInicio').value = segunda.toISOString().split('T')[0];
            document.getElementById('agendaDataFim').value = domingo.toISOString().split('T')[0];
            renderAgenda();
        }
        
        function renderDados() {
            const tbody = document.getElementById('dadosTableBody');
            tbody.innerHTML = dados.map(t => {
                const ultEstudo = formatarDataBR(t.ultEstudo);
                const agenda = formatarDataBR(t.agenda);
                const rend = t.rendimento ? Math.round(t.rendimento * 100) + '%' : '-';
                const rendColor = t.rendimento >= 0.8 ? '#00FFE0' : t.rendimento >= 0.5 ? '#FFA366' : '#EF4444';
                
                return `
                    <tr>
                        <td style="color: rgba(0,206,209,0.8);">${t.area || '-'}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${t.tema || '-'}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.status || 'N√£o iniciado'}</td>
                        <td style="text-align: center; color: var(--cobre-main);">${t.prioridade || 3}</td>
                        <td style="text-align: center; color: ${rendColor};">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.sessoes || 0}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${ultEstudo}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${agenda}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit" onclick="openEditModal(${t.id})" title="Editar">üîß</button>
                            <button class="btn-delete" onclick="deletarTema(${t.id})" title="Excluir tema permanentemente">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Renderizar gerenciador se estiver aberto
            const gerenciador = document.getElementById('gerenciadorAreasTemas');
            if (gerenciador && gerenciador.style.display !== 'none') {
                renderGerenciarAreasTemas();
            }
        }
        
        // ==================== GERENCIAR √ÅREAS/TEMAS (SPEC OPUS) ====================
        
        function toggleGerenciadorAreasTemas() {
            const gerenciador = document.getElementById('gerenciadorAreasTemas');
            const btn = document.getElementById('btnAbrirGerenciador');
            if (!gerenciador || !btn) return;
            
            if (gerenciador.style.display === 'none') {
                gerenciador.style.display = '';
                btn.textContent = 'Fechar gerenciador';
                renderGerenciarAreasTemas();
            } else {
                gerenciador.style.display = 'none';
                btn.textContent = 'Abrir gerenciador';
            }
        }
        
        function renderGerenciarAreasTemas() {
            const container = document.getElementById('areasTemasLista');
            if (!container) return;
            
            // Agrupar temas por √°rea (apenas do perfil ativo)
            const porArea = {};
            dados.forEach(t => {
                const area = t.area || 'Sem √°rea';
                if (!porArea[area]) porArea[area] = [];
                porArea[area].push(t);
            });
            
            const areasOrdenadas = Object.keys(porArea).sort();
            
            if (areasOrdenadas.length === 0) {
                container.textContent = 'Nenhuma √°rea encontrada.';
                return;
            }
            
            // Construir HTML usando createElement (seguro, sem innerHTML com dados do usu√°rio)
            const fragment = document.createDocumentFragment();
            
            areasOrdenadas.forEach(area => {
                const temas = porArea[area];
                const areaId = `area-gerenciar-${area.replace(/[^a-zA-Z0-9]/g, '-')}`;
                // Plataforma livre - nenhuma √°rea √© fixa
                const isAreaFixa = false;
                
                const card = document.createElement('div');
                card.className = 'area-card-gerenciar';
                card.setAttribute('data-area', area);
                
                const header = document.createElement('div');
                header.className = 'area-header-gerenciar';
                header.onclick = () => toggleAreaGerenciar(areaId);
                
                const info = document.createElement('div');
                info.className = 'area-info-gerenciar';
                
                const nome = document.createElement('span');
                nome.className = 'area-name-gerenciar';
                nome.textContent = area;
                
                const badge = document.createElement('span');
                badge.className = 'area-badge-gerenciar';
                badge.textContent = `${temas.length} tema${temas.length > 1 ? 's' : ''}`;
                
                info.appendChild(nome);
                info.appendChild(badge);
                
                // Badge "FIXA" para √°reas travadas (UX opcional)
                if (isAreaFixa) {
                    const badgeFixa = document.createElement('span');
                    badgeFixa.className = 'area-badge-fixa-gerenciar';
                    badgeFixa.textContent = 'üîí FIXA';
                    badgeFixa.title = '√Årea fixa do sistema ‚Äî n√£o pode editar/apagar';
                    badgeFixa.onclick = (e) => {
                        e.stopPropagation();
                        mostrarNotificacaoFeedback('üîí √Årea fixa do sistema ‚Äî n√£o pode editar/apagar', 'info');
                    };
                    badgeFixa.style.cursor = 'help';
                    info.appendChild(badgeFixa);
                }
                
                const actions = document.createElement('div');
                actions.className = 'area-actions-gerenciar';
                
                if (!isAreaFixa) {
                    const btnEdit = document.createElement('button');
                    btnEdit.className = 'btn-sm-gerenciar btn-edit-gerenciar';
                    btnEdit.textContent = '‚úèÔ∏è';
                    btnEdit.title = 'Renomear √°rea';
                    btnEdit.onclick = (e) => { e.stopPropagation(); renomearArea(area); };
                    
                    const btnDelete = document.createElement('button');
                    btnDelete.className = 'btn-sm-gerenciar btn-delete-gerenciar';
                    btnDelete.textContent = 'üóëÔ∏è';
                    btnDelete.title = 'Apagar √°rea';
                    btnDelete.onclick = (e) => { e.stopPropagation(); apagarArea(area); };
                    
                    actions.appendChild(btnEdit);
                    actions.appendChild(btnDelete);
                }
                
                const toggle = document.createElement('span');
                toggle.className = 'area-toggle-gerenciar';
                toggle.textContent = '‚ñº';
                actions.appendChild(toggle);
                
                header.appendChild(info);
                header.appendChild(actions);
                
                const content = document.createElement('div');
                content.className = 'area-content-gerenciar collapsed';
                content.id = areaId;
                
                temas.forEach(tema => {
                    const temaItem = document.createElement('div');
                    temaItem.className = 'tema-item-gerenciar';
                    temaItem.setAttribute('data-tema-id', tema.id);
                    
                    const temaNome = document.createElement('span');
                    temaNome.className = 'tema-name-gerenciar';
                    temaNome.textContent = tema.tema;
                    
                    const temaActions = document.createElement('div');
                    temaActions.className = 'tema-actions-gerenciar';
                    
                    const btnEditTema = document.createElement('button');
                    btnEditTema.className = 'btn-sm-gerenciar btn-edit-gerenciar';
                    btnEditTema.textContent = '‚úèÔ∏è';
                    btnEditTema.title = 'Renomear tema';
                    btnEditTema.onclick = () => renomearTema(tema.id);
                    
                    const btnDeleteTema = document.createElement('button');
                    btnDeleteTema.className = 'btn-sm-gerenciar btn-delete-gerenciar';
                    btnDeleteTema.textContent = 'üóëÔ∏è';
                    btnDeleteTema.title = 'Apagar tema';
                    btnDeleteTema.onclick = () => deletarTema(tema.id);
                    
                    temaActions.appendChild(btnEditTema);
                    temaActions.appendChild(btnDeleteTema);
                    
                    temaItem.appendChild(temaNome);
                    temaItem.appendChild(temaActions);
                    content.appendChild(temaItem);
                });
                
                card.appendChild(header);
                card.appendChild(content);
                fragment.appendChild(card);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        function toggleAreaGerenciar(areaId) {
            const content = document.getElementById(areaId);
            if (!content) return;
            content.classList.toggle('collapsed');
            const header = content.previousElementSibling;
            const toggle = header.querySelector('.area-toggle-gerenciar');
            if (toggle) toggle.textContent = content.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        }
        
        function filtrarAreasTemas() {
            const query = (document.getElementById('buscaAreasTemas')?.value || '').toLowerCase().trim();
            const cards = document.querySelectorAll('.area-card-gerenciar');
            
            cards.forEach(card => {
                const areaNome = (card.getAttribute('data-area') || '').toLowerCase();
                const temas = card.querySelectorAll('.tema-item-gerenciar');
                let areaMatch = areaNome.includes(query);
                let temaMatch = false;
                
                temas.forEach(tema => {
                    const temaNome = tema.querySelector('.tema-name-gerenciar')?.textContent.toLowerCase() || '';
                    if (temaNome.includes(query)) {
                        temaMatch = true;
                        tema.style.display = '';
                    } else {
                        tema.style.display = query ? 'none' : '';
                    }
                });
                
                card.style.display = (areaMatch || temaMatch || !query) ? '' : 'none';
            });
        }
        
        function renomearTema(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado', 'error');
                return;
            }
            
            const nomeAntigo = tema.tema;
            const nomeNovo = prompt(`Renomear tema "${nomeAntigo}":\n\nDigite o novo nome:`, nomeAntigo);
            if (!nomeNovo || nomeNovo.trim() === nomeAntigo || !nomeNovo.trim()) return;
            
            const nomeNovoTrim = nomeNovo.trim();
            
            // Bloquear colis√£o: mesmo nome na mesma √°rea
            const conflito = dados.find(t => 
                String(t.id) !== String(temaId) && 
                t.area === tema.area && 
                t.tema === nomeNovoTrim
            );
            if (conflito) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è J√° existe um tema "${nomeNovoTrim}" na √°rea "${tema.area}"`, 'error');
                return;
            }
            
            try {
                // Atualizar dados[] (match exato ===)
                dados.forEach(t => {
                    if (t.area === tema.area && t.tema === nomeAntigo) {
                        t.tema = nomeNovoTrim;
                    }
                });
                
                // Atualizar historico[] (match exato ===)
                historico.forEach(h => {
                    if (h.tema === nomeAntigo) {
                        h.tema = nomeNovoTrim;
                    }
                });
                
                // Atualizar diario.entradas[] (match exato ===)
                if (window.diario && window.diario.entradas) {
                    window.diario.entradas.forEach(e => {
                        if (e.tema === nomeAntigo) {
                            e.tema = nomeNovoTrim;
                        }
                    });
                    salvarDiario();
                }
                
                // Atualizar anotacoes[] (match exato ===)
                anotacoes.forEach(a => {
                    if (a.tema === nomeAntigo) {
                        a.tema = nomeNovoTrim;
                    }
                });
                
                // Salvar tudo
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                
                // Re-renderizar
                renderGerenciarAreasTemas();
                renderDados();
                renderTarefas();
                renderAgenda();
                renderHistorico();
                renderDiario();
                renderCaderno();
                updateFeedbackSelect();
                
                mostrarNotificacaoFeedback(`‚úÖ Tema renomeado: "${nomeAntigo}" ‚Üí "${nomeNovoTrim}"`);
                
            } catch(e) {
                console.error('[RENOMEAR TEMA] Erro:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao renomear tema', 'error');
            }
        }
        
        function renomearArea(nomeArea) {
            // Plataforma livre - qualquer √°rea pode ser renomeada
            const nomeNovo = prompt(`Renomear √°rea "${nomeArea}":\n\nDigite o novo nome:`, nomeArea);
            if (!nomeNovo || nomeNovo.trim() === nomeArea || !nomeNovo.trim()) return;
            
            const nomeNovoTrim = nomeNovo.trim();
            
            // Bloquear colis√£o: √°rea j√° existe
            const areasExistentes = getAreasDisponiveisDoPerfilAtivo();
            if (areasExistentes.includes(nomeNovoTrim)) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è J√° existe uma √°rea chamada "${nomeNovoTrim}"`, 'error');
                return;
            }
            
            try {
                // Atualizar dados[] (match exato ===)
                dados.forEach(t => {
                    if (t.area === nomeArea) {
                        t.area = nomeNovoTrim;
                    }
                });
                
                // Atualizar historico[] (match exato ===)
                historico.forEach(h => {
                    if (h.area === nomeArea) {
                        h.area = nomeNovoTrim;
                    }
                });
                
                // Atualizar diario.entradas[] (match exato ===)
                if (window.diario && window.diario.entradas) {
                    window.diario.entradas.forEach(e => {
                        if (e.area === nomeArea) {
                            e.area = nomeNovoTrim;
                        }
                    });
                    salvarDiario();
                }
                
                // Atualizar anotacoes[] (match exato ===)
                anotacoes.forEach(a => {
                    if (a.area === nomeArea) {
                        a.area = nomeNovoTrim;
                    }
                });
                
                // Atualizar vrvsAreasCustom (match exato ===)
                if (window.vrvsAreasCustom) {
                    const index = window.vrvsAreasCustom.indexOf(nomeArea);
                    if (index !== -1) {
                        window.vrvsAreasCustom[index] = nomeNovoTrim;
                        window.vrvsAreasCustom.sort();
                        localStorage.setItem(window.vrvs_key('areas_custom'), JSON.stringify(window.vrvsAreasCustom));
                    }
                }
                
                // Salvar tudo
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                
                // Atualizar selects
                atualizarTodosSelectsArea(nomeNovoTrim);
                
                // Re-renderizar
                renderGerenciarAreasTemas();
                renderDados();
                renderTarefas();
                renderAgenda();
                renderHistorico();
                renderDiario();
                renderCaderno();
                
                mostrarNotificacaoFeedback(`‚úÖ √Årea renomeada: "${nomeArea}" ‚Üí "${nomeNovoTrim}"`);
                
            } catch(e) {
                console.error('[RENOMEAR AREA] Erro:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao renomear √°rea', 'error');
            }
        }
        
        function apagarArea(nomeArea) {
            // Plataforma livre - qualquer √°rea pode ser apagada
            // Verificar que √°rea existe e tem temas
            const temasDaArea = dados.filter(t => t.area === nomeArea);
            if (temasDaArea.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è √Årea n√£o encontrada ou n√£o possui temas', 'error');
                return;
            }
            
            // TRAVA 3: Validar estrutura dos datasets antes de calcular impacto
            if (!Array.isArray(dados) || !Array.isArray(historico) || !Array.isArray(anotacoes) || !Array.isArray(lembretes)) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: estrutura de dados inv√°lida. Abortando.', 'error');
                return;
            }
            
            if (window.diario && (!window.diario.entradas || !Array.isArray(window.diario.entradas))) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: estrutura do di√°rio inv√°lida. Abortando.', 'error');
                return;
            }
            
            // Calcular contagens EXATAS (ANTES de confirmar)
            const temaIds = temasDaArea.map(t => t.id);
            
            const sessoes = historico.filter(h => 
                h.area === nomeArea || temaIds.some(id => String(h.temaId) === String(id))
            );
            
            const entradasDiario = (window.diario?.entradas || []).filter(e => e.area === nomeArea);
            
            const anotacoesArea = anotacoes.filter(a => 
                a.area === nomeArea || temaIds.some(id => String(a.temaId) === String(id))
            );
            
            const lembretesArea = lembretes.filter(l => 
                temaIds.some(id => String(l.temaId) === String(id))
            );
            
            // Confirma√ß√£o com contagens exatas (conforme spec)
            const mensagem = `Apagar √°rea "${nomeArea}"?\n\n` +
                `Isso vai apagar ${temasDaArea.length} tema${temasDaArea.length > 1 ? 's' : ''} e todos os dados associados:\n\n` +
                `üìã ${sessoes.length} sess√£o${sessoes.length > 1 ? '√µes' : ''} de estudo\n` +
                `üìì ${entradasDiario.length} entrada${entradasDiario.length > 1 ? 's' : ''} do di√°rio\n` +
                `üìù ${anotacoesArea.length} anota√ß√£o${anotacoesArea.length > 1 ? '√µes' : ''} do caderno\n` +
                (lembretesArea.length > 0 ? `üìå ${lembretesArea.length} lembrete${lembretesArea.length > 1 ? 's' : ''}\n` : '') +
                `‚≠ê Hot Topics relacionados\n\n` +
                `Esta a√ß√£o n√£o pode ser desfeita.`;
            
            if (!confirm(mensagem)) return;
            
            try {
                // OPERA√á√ÉO AT√îMICA: tudo ou nada
                // 1. Apagar temas de dados[]
                const dadosAntes = dados.length;
                dados = dados.filter(t => t.area !== nomeArea);
                if (dados.length === dadosAntes) {
                    throw new Error('Falha ao remover temas de dados');
                }
                
                // 2. Apagar sess√µes do hist√≥rico (√°rea OU temaId dos temas)
                historico = historico.filter(h => 
                    h.area !== nomeArea && !temaIds.some(id => String(h.temaId) === String(id))
                );
                
                // 3. Apagar entradas do di√°rio (por √°rea)
                if (window.diario && window.diario.entradas) {
                    window.diario.entradas = window.diario.entradas.filter(e => e.area !== nomeArea);
                    salvarDiario();
                }
                
                // 4. Apagar anota√ß√µes (√°rea OU temaId dos temas)
                anotacoes = anotacoes.filter(a => 
                    a.area !== nomeArea && !temaIds.some(id => String(a.temaId) === String(id))
                );
                
                // 5. Apagar lembretes (por temaId dos temas)
                lembretes = lembretes.filter(l => 
                    !temaIds.some(id => String(l.temaId) === String(id))
                );
                
                // 6. Remover de vrvsAreasCustom
                if (window.vrvsAreasCustom) {
                    window.vrvsAreasCustom = window.vrvsAreasCustom.filter(a => a !== nomeArea);
                    localStorage.setItem(window.vrvs_key('areas_custom'), JSON.stringify(window.vrvsAreasCustom));
                }
                
                // SALVAR TUDO (atomicamente)
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
                
                // Atualizar selects
                atualizarTodosSelectsArea();
                
                // Mostrar resumo
                mostrarNotificacaoFeedback(
                    `‚úÖ √Årea "${nomeArea}" e ${temasDaArea.length} tema${temasDaArea.length > 1 ? 's' : ''} apagados`
                );
                
                // Re-renderizar tudo
                renderGerenciarAreasTemas();
                renderDados();
                renderTarefas();
                renderAgenda();
                renderHistorico();
                renderPendencias();
                updateFeedbackSelect();
                updateStats();
                renderLembretes();
                renderCaderno();
                renderDiario();
                
            } catch(e) {
                console.error('[APAGAR AREA] Erro:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao apagar √°rea. Dados n√£o foram alterados.', 'error');
            }
        }
        
        function updateFeedbackSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            
            // Usar helper centralizado para obter todas as √°reas dispon√≠veis
            const areasCompletas = getAreasDisponiveisDoPerfilAtivo();
            
            areaSelect.innerHTML = '<option value="">Selecione a √°rea...</option>' +
                areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Atualizar temas baseado na √°rea selecionada
            updateFeedbackTemaSelect();
        }
        
        function preencherDropdownAreas(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Se for datalist, atualizar
            if (element.tagName === 'INPUT' && element.list) {
                const datalist = document.getElementById(element.list.id || 'listAreasFixas');
                if (datalist) {
                    datalist.innerHTML = getAreasBaseDoPerfil().map(area => `<option value="${area}">`).join('');
                }
            }
        }
        
        function updateFeedbackTemaSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            const areaSelecionada = areaSelect.value;
            
            temaSelect.innerHTML = '<option value="">Selecione o m√≥dulo...</option>';
            
            if (!areaSelecionada) {
                // Se nenhuma √°rea selecionada, mostrar todos os temas
                temaSelect.innerHTML += dados.map(t => `<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
            } else {
                // Filtrar temas pela √°rea selecionada
                const temasFiltrados = dados.filter(t => t.area === areaSelecionada);
                temaSelect.innerHTML += temasFiltrados.map(t => `<option value="${t.id}">${t.tema}</option>`).join('');
            }
        }
        
        function deletarTema(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Validar estrutura dos datasets antes de calcular impacto
            if (!Array.isArray(dados) || !Array.isArray(historico) || !Array.isArray(anotacoes) || !Array.isArray(lembretes)) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: estrutura de dados inv√°lida. Abortando.', 'error');
                return;
            }
            
            if (window.diario && (!window.diario.entradas || !Array.isArray(window.diario.entradas))) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: estrutura do di√°rio inv√°lida. Abortando.', 'error');
                return;
            }
            
            // Calcular contagens EXATAS (ANTES de confirmar)
            const historicoRelacionado = historico.filter(h => String(h.temaId) === String(temaId));
            const lembretesRelacionados = lembretes.filter(l => String(l.temaId) === String(temaId));
            const anotacoesRelacionadas = anotacoes.filter(a => String(a.temaId) === String(temaId));
            const entradasDiario = (window.diario?.entradas || []).filter(e => 
                e.area === tema.area && e.tema === tema.tema
            );
            
            // Confirma√ß√£o com contagens exatas (conforme spec)
            const mensagem = `Apagar tema "${tema.tema}"?\n\n` +
                `Isso vai apagar:\n` +
                `üìã ${historicoRelacionado.length} sess√£o${historicoRelacionado.length > 1 ? '√µes' : ''} de estudo\n` +
                `üìì ${entradasDiario.length} entrada${entradasDiario.length > 1 ? 's' : ''} do di√°rio\n` +
                `üìù ${anotacoesRelacionadas.length} anota√ß√£o${anotacoesRelacionadas.length > 1 ? '√µes' : ''} do caderno\n` +
                (lembretesRelacionados.length > 0 ? `üìå ${lembretesRelacionados.length} lembrete${lembretesRelacionados.length > 1 ? 's' : ''}\n` : '') +
                `\nEsta a√ß√£o n√£o pode ser desfeita.`;
            
            if (!confirm(mensagem)) return;
            
            try {
                // OPERA√á√ÉO AT√îMICA: tudo ou nada
                // 1. Remover tema dos dados
                const dadosAntes = dados.length;
                dados = dados.filter(t => String(t.id) !== String(temaId));
                if (dados.length === dadosAntes) {
                    throw new Error('Falha ao remover tema de dados');
                }
                
                // 2. Remover hist√≥rico relacionado
                historico = historico.filter(h => String(h.temaId) !== String(temaId));
                
                // 3. Remover lembretes relacionados
                lembretes = lembretes.filter(l => String(l.temaId) === String(temaId));
                
                // 4. Remover anota√ß√µes relacionadas
                anotacoes = anotacoes.filter(a => String(a.temaId) === String(temaId));
                
                // 5. Remover entradas do di√°rio (match area+tema)
                if (window.diario && window.diario.entradas) {
                    window.diario.entradas = window.diario.entradas.filter(e => 
                        !(e.area === tema.area && e.tema === tema.tema)
                    );
                    salvarDiario();
                }
                
                // SALVAR TUDO (atomicamente)
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                
                // Mostrar resumo
                const resumo = [
                    `‚úÖ Tema removido`,
                    historicoRelacionado.length > 0 ? `${historicoRelacionado.length} registro(s) de hist√≥rico` : '',
                    entradasDiario.length > 0 ? `${entradasDiario.length} entrada(s) do di√°rio` : '',
                    lembretesRelacionados.length > 0 ? `${lembretesRelacionados.length} lembrete(s)` : '',
                    anotacoesRelacionadas.length > 0 ? `${anotacoesRelacionadas.length} anota√ß√£o(√µes)` : ''
                ].filter(r => r).join('\n');
                
                mostrarNotificacaoFeedback(resumo);
                
                // Re-renderizar tudo
                renderGerenciarAreasTemas();
                renderDados();
                renderTarefas();
                renderAgenda();
                renderHistorico();
                renderPendencias();
                updateFeedbackSelect();
                updateStats();
                renderLembretes();
                renderCaderno();
                renderDiario();
                
            } catch(e) {
                console.error('[DELETAR TEMA] Erro:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao apagar tema. Dados n√£o foram alterados.', 'error');
            }
        }
        
        function desfazerUltimoFeedback() {
            if (historico.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum feedback para desfazer!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Confirma revers√£o do √∫ltimo registro?')) {
                return;
            }
            
            const ultimaSessao = historico[historico.length - 1];
            
            // CORRE√á√ÉO: Buscar tema comparando IDs como strings
            const tema = dados.find(t => String(t.id) === String(ultimaSessao.temaId));
            
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado!', 'error');
                return;
            }
            
            historico.pop();
            tema.sessoes = Math.max(0, (tema.sessoes || 1) - 1);
            tema.tempo = Math.max(0, (tema.tempo || 0) - (ultimaSessao.tempo || 0));
            
            const sessoesRestantes = historico.filter(h => String(h.temaId) === String(tema.id));
            
            if (sessoesRestantes.length > 0) {
                const somaRend = sessoesRestantes.reduce((sum, h) => sum + (h.rendimento || 0), 0);
                tema.rendimento = somaRend / sessoesRestantes.length;
                
                // Recalcular contador80
                let contador = 0;
                for (let i = sessoesRestantes.length - 1; i >= 0; i--) {
                    if ((sessoesRestantes[i].rendimento || 0) >= 0.8) {
                        contador++;
                    } else {
                        break;
                    }
                }
                tema.contador80 = contador;
                
                // Atualizar √∫ltima data e agenda
                const ultimaSessaoRestante = sessoesRestantes[sessoesRestantes.length - 1];
                tema.ultEstudo = ultimaSessaoRestante ? ultimaSessaoRestante.data : '';
                tema.agenda = calcularProximaRevisao(tema);
            } else {
                tema.rendimento = 0;
                tema.status = 'Planejado';
                tema.ultEstudo = '';
                tema.agenda = '';
                tema.contador80 = 0;
            }
            
            localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
            localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
            
            mostrarNotificacaoFeedback('‚úÖ Revers√£o executada com sucesso!');
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
            renderPendencias();
        }

        function renderHistorico() {
            const tbody = document.getElementById('historicoTableBody');
            if (!tbody) {
                console.warn('[RENDER HISTORICO] Tbody n√£o encontrado! Verificando novamente em 100ms...');
                setTimeout(() => renderHistorico(), 100);
                return;
            }
            
            console.log('[RENDER HISTORICO] Total de registros no hist√≥rico:', historico.length);
            
            // CORRE√á√ÉO: Filtrar hist√≥rico inv√°lido (√°rea "Tema" e linhas sem dados v√°lidos)
            const historicoFiltrado = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            console.log('[RENDER HISTORICO] Registros ap√≥s filtro:', historicoFiltrado.length);
            
            if (historicoFiltrado.length === 0) {
                console.warn('[RENDER HISTORICO] Nenhum registro v√°lido encontrado ap√≥s filtro!');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                // CORRE√á√ÉO: Aplicar fixAreaTema para corrigir invers√µes
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${(h.observacoes && h.observacoes !== '-' ? h.observacoes + ' ' : '') + (h.sugestao && h.sugestao !== '-' ? h.sugestao : '') || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Defina per√≠odo completo!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= dataInicio && h.data <= dataFim;
            });
            
            if (sessoesNoPeriodo.length === 0) {
                document.getElementById('relatorioResultado').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Sem dados no per√≠odo</div></div>';
                document.getElementById('btnExportarRelatorio').style.display = 'none';
                return;
            }
            
            const totalSessoes = sessoesNoPeriodo.length;
            const totalTempo = sessoesNoPeriodo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const rendimentoMedio = Math.round((sessoesNoPeriodo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100);
            
            const porArea = {};
            sessoesNoPeriodo.forEach(h => {
                const area = h.area || 'Sem √°rea';
                if (!porArea[area]) {
                    porArea[area] = { sessoes: 0, tempo: 0, rendimento: 0 };
                }
                porArea[area].sessoes++;
                porArea[area].tempo += h.tempo || 0;
                porArea[area].rendimento += h.rendimento || 0;
            });
            
            const resultado = `
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 12px;">
                        An√°lise: ${formatarDataBR(dataInicio)} - ${formatarDataBR(dataFim)}
                    </h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalSessoes}</div>
                            <div class="stat-label">Sess√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(totalTempo / 60)}h</div>
                            <div class="stat-label">Tempo Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rendimentoMedio}%</div>
                            <div class="stat-label">Performance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(porArea).length}</div>
                            <div class="stat-label">√Åreas</div>
                        </div>
                    </div>
                    <h5 style="color: var(--turquesa-light); margin: 20px 0 12px;">Detalhamento por √Årea:</h5>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√Årea</th>
                                <th>Sess√µes</th>
                                <th>Tempo</th>
                                <th>Rendimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(porArea).map(([area, stats]) => `
                                <tr>
                                    <td style="color: var(--turquesa-light);">${area}</td>
                                    <td style="text-align: center;">${stats.sessoes}</td>
                                    <td style="text-align: center;">${stats.tempo} min</td>
                                    <td style="text-align: center;">${Math.round(stats.rendimento / stats.sessoes * 100)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('relatorioResultado').innerHTML = resultado;
            document.getElementById('btnExportarRelatorio').style.display = 'block';
            
            localStorage.setItem('relatorioPeriodo', JSON.stringify({ dataInicio, dataFim }));
        }

        function exportarRelatorioPeriodo() {
            const periodo = JSON.parse(localStorage.getItem('relatorioPeriodo') || '{}');
            if (!periodo.dataInicio || !periodo.dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Gere relat√≥rio primeiro!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= periodo.dataInicio && h.data <= periodo.dataFim;
            });
            
            const csv = dados2CSV(sessoesNoPeriodo);
            const filename = `VRVS_RELATORIO_${periodo.dataInicio}_${periodo.dataFim}.csv`;
            downloadCSV(csv, filename);
        }
        
        function updateStats() {
            // CORRE√á√ÉO: Suspenso n√£o aparece em estat√≠sticas
            const temasAtivos = dados.filter(t => t.status !== 'Suspenso');
            document.getElementById('statTemas').textContent = temasAtivos.length;
            
            // Filtrar hist√≥rico de temas suspensos
            const historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                return tema && tema.status !== 'Suspenso';
            });
            
            const totalSessoes = historicoAtivo.length;
            document.getElementById('statSessoes').textContent = totalSessoes;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            document.getElementById('statRendimento').textContent = rendimentoMedio + '%';
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            document.getElementById('statTempo').textContent = totalHoras + 'h';
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes)
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoAtivo.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            document.getElementById('statQuestoes').textContent = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular flashcards totais
            const totalFlashcards = historicoAtivo.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            document.getElementById('statFlashcards').textContent = totalFlashcards.toLocaleString();
            
            renderChartBarras();
            renderChartLinhaControles(); // Renderizar controles antes do gr√°fico
            renderChartLinha();
            renderChartRadar();
        }
        
        // ==================== GR√ÅFICOS POR √ÅREA! ====================
        
        const COLORS_PALETTE = [
            '#FFD700', '#FFA07A', '#F5DEB3', '#FF69B4', '#20B2AA', '#87CEEB',
            '#00FFE0', '#00CED1', '#FFA366', '#FF7F50', '#E55100', '#0d9488'
        ];
        let areaColorMap = {};
        let colorIndex = 0;
        
        function getColorForArea(area) {
            if (!areaColorMap[area]) {
                areaColorMap[area] = COLORS_PALETTE[colorIndex % COLORS_PALETTE.length];
                colorIndex++;
            }
            return areaColorMap[area];
        }
        
        let chartBarrasInst = null;
        let chartLinhaInst = null; // Inst√¢ncia para gr√°fico Stats
        let chartLinhaAnalyticsInst = null; // Inst√¢ncia separada para gr√°fico Analytics
        let chartRadarInst = null;
        
        // Estado de √°reas vis√≠veis no gr√°fico de linha
        let areasVisiveisLinha = new Set();
        
        // ==================== AGRUPAMENTO PARA GR√ÅFICOS ====================
        // Mapeamento de agrupamento (apenas para visualiza√ß√£o nos gr√°ficos)
        // N√ÉO altera os dados originais
        const AGRUPAMENTO_GRAFICOS = {
            'Trauma MMSS': 'Trauma Adulto',
            'Trauma MMII': 'Trauma Adulto',
            'Trauma Coluna': 'Trauma Adulto'
            // Todas as outras mant√™m o nome original
        };
        
        function agruparParaGrafico(area) {
            return AGRUPAMENTO_GRAFICOS[area] || area;
        }
        
        // GR√ÅFICO 1: Performance m√©dia POR √ÅREA
        function renderChartBarras(canvasId = 'chartBarras') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn('[CHART BARRAS] Canvas n√£o encontrado! ID:', canvasId);
                return;
            }
            console.log('[CHART BARRAS] Renderizando gr√°fico... ID:', canvasId);
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area: areaNormalizada } = fixAreaTema(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (areaNormalizada.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(areaNormalizada);
                
                if (!areaStats[areaAgrupada]) {
                    areaStats[areaAgrupada] = { total: 0, count: 0 };
                }
                areaStats[areaAgrupada].total += h.rendimento * 100;
                areaStats[areaAgrupada].count += 1;
            });
            
            const areaRendimento = [];
            for (let area in areaStats) {
                const media = Math.round(areaStats[area].total / areaStats[area].count);
                areaRendimento.push([area, media]);
            }
            const sorted = areaRendimento.sort((a, b) => b[1] - a[1]);
            
            console.log('[CHART BARRAS] √Åreas encontradas:', Object.keys(areaStats).length);
            console.log('[CHART BARRAS] Dados ordenados:', sorted.length, '√°reas');
            
            if (sorted.length === 0) {
                console.warn('[CHART BARRAS] Nenhum dado para exibir! Hist√≥rico:', historico.length, 'registros');
                if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
                // Mostrar mensagem ao usu√°rio
                const container = ctx.closest('div');
                if (container && !container.querySelector('.no-data-message')) {
                    container.innerHTML += '<div class="no-data-message" style="color: rgba(0,206,209,0.7); padding: 20px; text-align: center; font-size: 14px;">‚ö†Ô∏è Nenhum dado dispon√≠vel para exibir. Adicione sess√µes no hist√≥rico primeiro.</div>';
                }
                return;
            }
            if (chartBarrasInst) { chartBarrasInst.destroy(); }
            
            // Cores: extremos (m√°ximo e m√≠nimo) mais fortes, centro mais brando
            const maxVal = Math.max(...sorted.map(s => s[1]));
            const minVal = Math.min(...sorted.map(s => s[1]));
            const backgroundColors = sorted.map((s, index) => {
                const valor = s[1];
                const corBase = getColorForArea(s[0]);
                
                // Se √© m√°ximo ou m√≠nimo, usar cor forte
                if (valor === maxVal || valor === minVal) {
                    return corBase; // Cor original (forte)
                }
                
                // Para valores intermedi√°rios, tornar a cor mais branda (adicionar transpar√™ncia)
                const r = parseInt(corBase.slice(1, 3), 16);
                const g = parseInt(corBase.slice(3, 5), 16);
                const b = parseInt(corBase.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, 0.4)`; // 40% de opacidade para centro
            });
            
            const borderColors = sorted.map((s, index) => {
                const valor = s[1];
                const corBase = getColorForArea(s[0]);
                
                // Bordas: extremos mais grossas e fortes, centro mais finas e brandas
                if (valor === maxVal || valor === minVal) {
                    return corBase; // Cor original (forte)
                }
                const r = parseInt(corBase.slice(1, 3), 16);
                const g = parseInt(corBase.slice(3, 5), 16);
                const b = parseInt(corBase.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, 0.6)`; // 60% de opacidade para bordas do centro
            });
            
            const borderWidths = sorted.map(s => {
                const valor = s[1];
                return (valor === maxVal || valor === minVal) ? 2 : 1; // Extremos com borda mais grossa
            });
            
            console.log('[CHART BARRAS] Criando gr√°fico com', sorted.length, '√°reas');
            console.log('[CHART BARRAS] Chart dispon√≠vel?', typeof Chart !== 'undefined');
            
            try {
                chartBarrasInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Performance M√©dia (%)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: borderWidths
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Performance M√©dia por √Årea',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
            console.log('[CHART BARRAS] Gr√°fico criado com sucesso!');
            } catch (err) {
                console.error('[CHART BARRAS] ERRO ao criar gr√°fico:', err);
                const container = ctx.closest('div');
                if (container) {
                    container.innerHTML += '<div style="color: #EF4444; padding: 20px; text-align: center;">‚ö†Ô∏è Erro ao renderizar gr√°fico: ' + err.message + '</div>';
                }
            }
        }
        
        // Renderizar controles de toggle para gr√°fico de linha (vers√£o principal)
        function renderChartLinhaControles() {
            const container = document.getElementById('chartLinhaControles');
            if (!container) return;
            
            renderChartLinhaControlesInterno(container);
        }
        
        // Renderizar controles de toggle para gr√°fico de linha (vers√£o Analytics)
        function renderChartLinhaControlesAnalytics() {
            const container = document.getElementById('chartLinhaControlesAnalytics');
            if (!container) return;
            
            renderChartLinhaControlesInterno(container);
        }
        
        // Fun√ß√£o interna compartilhada para renderizar controles
        function renderChartLinhaControlesInterno(container) {
            
            // Obter todas as √°reas √∫nicas (agrupadas) do hist√≥rico
            const areasUnicas = new Set();
            historico.forEach(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area || area.toLowerCase() === 'tema') return;
                
                const areaAgrupada = agruparParaGrafico(area);
                areasUnicas.add(areaAgrupada);
            });
            
            const areas = Array.from(areasUnicas).sort();
            
            // Inicializar todas como vis√≠veis se ainda n√£o foi inicializado
            if (areasVisiveisLinha.size === 0) {
                areas.forEach(a => areasVisiveisLinha.add(a));
            }
            
            // Renderizar controles (bot√µes TODAS/NENHUMA removidos - n√£o funcionavam)
            let html = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            `;
            
            areas.forEach(area => {
                html += `
                    <label class="chart-toggle-label">
                        <input type="checkbox" 
                               ${areasVisiveisLinha.has(area) ? 'checked' : ''}
                               onchange="toggleAreaLinha('${area.replace(/'/g, "\\'")}')">
                        <span>${area}</span>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Toggle de √°rea individual no gr√°fico de linha
        function toggleAreaLinha(area) {
            if (areasVisiveisLinha.has(area)) {
                areasVisiveisLinha.delete(area);
            } else {
                areasVisiveisLinha.add(area);
            }
            // CORRE√á√ÉO: Detectar qual canvas est√° ativo e atualizar ambos
            const canvasStats = document.getElementById('chartLinha');
            const canvasAnalytics = document.getElementById('chartLinhaAnalytics');
            
            // Atualizar controles de ambos se existirem
            renderChartLinhaControles();
            if (canvasAnalytics) {
                renderChartLinhaControlesAnalytics();
            }
            
            // Re-renderizar gr√°ficos ativos
            if (canvasStats) {
                renderChartLinha('chartLinha');
            }
            if (canvasAnalytics) {
                renderChartLinha('chartLinhaAnalytics');
            }
        }
        
        // Toggle todas as √°reas (mostrar/ocultar todas)
        function toggleTodasAreasLinha(mostrar) {
            const areasUnicas = new Set();
            historico.forEach(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area || area.toLowerCase() === 'tema') return;
                
                const areaAgrupada = agruparParaGrafico(area);
                areasUnicas.add(areaAgrupada);
            });
            
            areasVisiveisLinha = mostrar ? new Set(Array.from(areasUnicas)) : new Set();
            
            // CORRE√á√ÉO: Detectar qual canvas est√° ativo e atualizar ambos
            const canvasStats = document.getElementById('chartLinha');
            const canvasAnalytics = document.getElementById('chartLinhaAnalytics');
            
            // Atualizar controles de ambos se existirem
            renderChartLinhaControles();
            if (canvasAnalytics) {
                renderChartLinhaControlesAnalytics();
            }
            
            // Re-renderizar gr√°ficos ativos
            if (canvasStats) {
                renderChartLinha('chartLinha');
            }
            if (canvasAnalytics) {
                renderChartLinha('chartLinhaAnalytics');
            }
        }
        
        // GR√ÅFICO 2: Evolu√ß√£o POR √ÅREA
        function renderChartLinha(canvasId = 'chartLinha') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn('[CHART LINHA] Canvas n√£o encontrado! ID:', canvasId);
                return;
            }
            
            // CORRE√á√ÉO: Renderizar controles se ainda n√£o foram renderizados (para ambos: principal e Analytics)
            const controlesId = canvasId === 'chartLinhaAnalytics' ? 'chartLinhaControlesAnalytics' : 'chartLinhaControles';
            const controlesEl = document.getElementById(controlesId);
            if (controlesEl && !controlesEl.innerHTML) {
                if (canvasId === 'chartLinhaAnalytics') {
                    renderChartLinhaControlesAnalytics();
                } else {
                    renderChartLinhaControles();
                }
            }
            
            // AGRUPAR POR √ÅREA!!!
            const areasSessoes = {};
            historico.forEach(h => {
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(area);
                
                if (!areasSessoes[areaAgrupada]) {
                    areasSessoes[areaAgrupada] = [];
                }
                areasSessoes[areaAgrupada].push({
                    rendimento: (h.rendimento || 0) * 100,
                    sessao: areasSessoes[areaAgrupada].length + 1
                });
            });
            
            const datasets = Object.entries(areasSessoes)
                .filter(([area]) => areasVisiveisLinha.has(area)) // FILTRAR POR √ÅREAS VIS√çVEIS
                .map(([area, sessoes]) => {
                const color = getColorForArea(area);
                return {
                    label: area,
                    data: sessoes.map(s => ({ x: s.sessao, y: s.rendimento })),
                    borderColor: color,
                    backgroundColor: color + '33',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            // CORRE√á√ÉO: Usar inst√¢ncia separada para Analytics vs Stats
            let instanciaAtual = canvasId === 'chartLinhaAnalytics' ? chartLinhaAnalyticsInst : chartLinhaInst;
            
            // Destruir inst√¢ncia anterior se existir
            if (instanciaAtual) { 
                try {
                    instanciaAtual.destroy(); 
                } catch(e) {
                    console.warn('[CHART LINHA] Erro ao destruir gr√°fico anterior:', e);
                }
            }
            
            // Criar novo gr√°fico sempre (mesmo vazio, para permitir reativar)
            const novaInstancia = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets.length > 0 ? datasets : [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone (portrait/landscape)
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o da Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const area = context[0].dataset.label;
                                    const sessao = context[0].parsed.x;
                                    return `${area} - Sess√£o ${sessao}`;
                                },
                                label: function(context) {
                                    return `Performance: ${Math.round(context.parsed.y)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'N√∫mero da Sess√£o',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', stepSize: 1 },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Rendimento (%)',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
            
            // Salvar na inst√¢ncia correta
            if (canvasId === 'chartLinhaAnalytics') {
                chartLinhaAnalyticsInst = novaInstancia;
            } else {
                chartLinhaInst = novaInstancia;
            }
        }
        
        // GR√ÅFICO 3: Radar POR √ÅREA
        function renderChartRadar(canvasId = 'chartRadar') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                // AGRUPAR PARA GR√ÅFICO (apenas visualiza√ß√£o, n√£o altera dados originais)
                const areaAgrupada = agruparParaGrafico(area);
                
                if (!areaStats[areaAgrupada]) {
                    areaStats[areaAgrupada] = { total: 0, count: 0 };
                }
                areaStats[areaAgrupada].total += h.rendimento * 100;
                areaStats[areaAgrupada].count += 1;
            });
            
            const areas = [];
            const rendimentos = [];
            for (let area in areaStats) {
                areas.push(area);
                rendimentos.push(Math.round(areaStats[area].total / areaStats[area].count));
            }
            
            if (areas.length === 0) {
                if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
                return;
            }
            
            if (chartRadarInst) { chartRadarInst.destroy(); }
            chartRadarInst = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'Performance M√©dia',
                        data: rendimentos,
                        borderColor: '#FFA500',
                        backgroundColor: 'rgba(255, 165, 0, 0.15)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#FFA500',
                        pointBorderColor: '#0a1a1f',
                        pointHoverBackgroundColor: '#FFA500',
                        pointHoverBorderColor: '#0a1a1f'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CORRE√á√ÉO: Permite adaptar √† orienta√ß√£o do iPhone
                    aspectRatio: 1.3,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Mapa de Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'rgba(0,206,209,0.5)',
                                backdropColor: 'transparent',
                                stepSize: 20,
                                callback: val => val + '%'
                            },
                            grid: { color: 'rgba(0,206,209,0.2)' },
                            angleLines: { color: 'rgba(0,206,209,0.1)' },
                            pointLabels: {
                                color: 'rgba(0,206,209,0.8)',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== IMPORTA√á√ÉO/EXPORTA√á√ÉO ====================
        
        function limparTudo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Apagar TODOS os dados?')) return;
            if (!confirm('‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Opera√ß√£o irrevers√≠vel!')) return;
            
            localStorage.removeItem('vrvs_dados');
            localStorage.removeItem('vrvs_historico');
            localStorage.removeItem('ultimoBackup');
            dados = [];
            historico = [];
            
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            
            mostrarNotificacaoFeedback('üóëÔ∏è Reset completo executado');
        }
        
        function importarArquivos() {
            const dadosFile = document.getElementById('importDados').files[0];
            const historicoFile = document.getElementById('importHistorico').files[0];
            const anotacoesFile = document.getElementById('importAnotacoes').files[0];
            const diarioFile = document.getElementById('importDiario').files[0];
            
            console.log('[IMPORT] ========== IN√çCIO DA IMPORTA√á√ÉO ==========');
            console.log('[IMPORT] Arquivos selecionados:', {
                dados: dadosFile ? dadosFile.name + ' (' + dadosFile.size + ' bytes)' : 'n√£o selecionado',
                historico: historicoFile ? historicoFile.name + ' (' + historicoFile.size + ' bytes)' : 'n√£o selecionado',
                anotacoes: anotacoesFile ? anotacoesFile.name + ' (' + anotacoesFile.size + ' bytes)' : 'n√£o selecionado',
                diario: diarioFile ? diarioFile.name + ' (' + diarioFile.size + ' bytes)' : 'n√£o selecionado'
            });
            console.log('[IMPORT] Verifica√ß√£o de arquivos:', {
                dadosFile: !!dadosFile,
                historicoFile: !!historicoFile,
                anotacoesFile: !!anotacoesFile,
                diarioFile: !!diarioFile
            });
            
            if (!dadosFile && !historicoFile && !anotacoesFile && !diarioFile) {
                mostrarNotificacaoFeedback('‚ùå Selecione arquivo para importar!', 'error');
                return;
            }
            
            const promises = [];
            
            if (dadosFile) {
                console.log('[IMPORT DADOS] Iniciando importa√ß√£o de', dadosFile.name);
                promises.push(parseCSV(dadosFile).then(dadosCSV => {
                    console.log('[IMPORT DADOS] CSV parseado,', dadosCSV.length, 'registros recebidos');
                    dados = dadosCSV.map(t => {
                        if (!t.id) t.id = Date.now() + Math.random();
                        t.area = normalizeArea(t.area, t.tema);
                        if (t.rendimento > 1) t.rendimento = t.rendimento / 100;
                        t.prioridade = parseInt(t.prioridade) || 3;
                        t.sessoes = parseInt(t.sessoes) || 0;
                        t.tempo = parseInt(t.tempo) || 0;
                        t.contador80 = parseInt(t.contador80) || 0;
                        if (!t.sugestao || t.sugestao === '-') {
                            t.sugestao = extrairUltimaSugestao(t.observacoes);
                        }
                        delete t.tipoRevisao;
                        return t;
                    });
                    localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                    console.log('[IMPORT DADOS]', dados.length, 'dados salvos');
                    return 'dados';
                }).catch(err => {
                    console.error('[IMPORT DADOS] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (historicoFile) {
                console.log('[IMPORT HISTORICO] Iniciando importa√ß√£o de', historicoFile.name);
                promises.push(parseCSV(historicoFile).then(historicoCSV => {
                    console.log('[IMPORT HISTORICO] CSV parseado,', historicoCSV.length, 'registros recebidos');
                    historico = historicoCSV.map(h => {
                        if (!h.id) h.id = Date.now() + Math.random();
                        h.area = normalizeArea(h.area, h.tema);
                        if (h.rendimento > 1) h.rendimento = h.rendimento / 100;
                        h.tempo = parseInt(h.tempo) || 0;
                        if (!h.data || h.data === '-') {
                            const obsMatch = (h.observacoes || '').match(/^(\d{4}-\d{2}-\d{2}):/);
                            if (obsMatch) {
                                h.data = obsMatch[1];
                            }
                        }
                        if (!h.sugestao || h.sugestao === '-') {
                            h.sugestao = extrairUltimaSugestao(h.observacoes);
                        }
                        return h;
                    });
                    localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                    console.log('[IMPORT HISTORICO]', historico.length, 'registros salvos');
                    return 'historico';
                }).catch(err => {
                    console.error('[IMPORT HISTORICO] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (anotacoesFile) {
                console.log('[IMPORT ANOTACOES] Iniciando importa√ß√£o de', anotacoesFile.name, 'tamanho:', anotacoesFile.size);
                promises.push(parseCSVAnotacoes(anotacoesFile).then(anotacoesCSV => {
                    console.log('[IMPORT ANOTACOES] CSV parseado,', anotacoesCSV.length, 'anota√ß√µes recebidas');
                    const anotacoesImportadas = anotacoesCSV.map(a => {
                        if (!a.id) a.id = Date.now() + Math.random();
                        // CR√çTICO: Garantir que temaId seja string e corresponda a um tema v√°lido
                        a.temaId = String(a.temaId || a.temaid || '');
                        // Se temaId est√° vazio, tentar encontrar pelo nome do tema
                        if (!a.temaId || a.temaId.trim() === '') {
                            const tema = dados.find(t => String(t.tema).trim() === String(a.tema || '').trim());
                            if (tema) {
                                a.temaId = String(tema.id);
                                console.log(`[IMPORT ANOTACOES] temaId encontrado para "${a.tema}": ${a.temaId}`);
                            } else {
                                console.warn(`[IMPORT ANOTACOES] N√£o foi poss√≠vel encontrar temaId para "${a.tema}"`);
                            }
                        }
                        return a;
                    }).filter(a => a.temaId && a.temaId.trim() !== ''); // Filtrar apenas com temaId v√°lido
                    
                    // CR√çTICO: Mesclar com anota√ß√µes existentes (preservar dados existentes)
                    anotacoes = mesclarAnotacoes(anotacoesImportadas, anotacoes);
                    localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                    console.log(`[IMPORT ANOTACOES] ${anotacoes.length} anota√ß√µes ap√≥s mesclagem (${anotacoesImportadas.length} novas)`);
                    return 'anotacoes';
                }).catch(err => {
                    console.error('[IMPORT ANOTACOES] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            if (diarioFile) {
                console.log('[IMPORT DIARIO] Iniciando importa√ß√£o de', diarioFile.name);
                promises.push(parseCSVDiario(diarioFile).then(diarioCSV => {
                    console.log('[IMPORT DIARIO] CSV parseado,', diarioCSV.length, 'entradas recebidas');
                    
                    // Carregar di√°rio existente
                    carregarDiario();
                    
                    // Mesclar entradas importadas com existentes
                    const entradasExistentes = window.diario.entradas || [];
                    const entradasImportadas = diarioCSV.map(e => {
                        if (!e.id) e.id = Date.now() + Math.random();
                        e.atencao = e.atencao === 'true' || e.atencao === true;
                        return e;
                    });
                    
                    // Mesclar: se ID existe, atualiza; se n√£o, adiciona
                    entradasImportadas.forEach(nova => {
                        const existente = entradasExistentes.find(e => String(e.id) === String(nova.id));
                        if (existente) {
                            // Atualizar entrada existente
                            Object.assign(existente, nova);
                        } else {
                            // Adicionar nova entrada
                            entradasExistentes.push(nova);
                        }
                    });
                    
                    window.diario.entradas = entradasExistentes;
                    // Inicializar SRS em todas as entradas ap√≥s importa√ß√£o
                    inicializarSrsEmTodasEntradas();
                    salvarDiario();
                    console.log(`[IMPORT DIARIO] ${entradasExistentes.length} entradas ap√≥s mesclagem`);
                    return 'diario';
                }).catch(err => {
                    console.error('[IMPORT DIARIO] Erro ao importar:', err);
                    throw err;
                }));
            }
            
            console.log('[IMPORT] Total de promises criadas:', promises.length);
            if (promises.length === 0) {
                console.error('[IMPORT] ERRO: Nenhuma promise foi criada!');
                mostrarNotificacaoFeedback('‚ùå Nenhum arquivo v√°lido selecionado!', 'error');
                return;
            }
            
            console.log('[IMPORT] Executando Promise.allSettled com', promises.length, 'promises...');
            Promise.allSettled(promises)
                .then(results => {
                    console.log('[IMPORT] Todas as promises finalizadas. Total de resultados:', results.length);
                    console.log('[IMPORT] Resultados detalhados:', results);
                    
                    // CORRE√á√ÉO: Limpar hist√≥rico inv√°lido ap√≥s importa√ß√£o
                    limparHistoricoInvalido();
                    
                    const sucessos = [];
                    const erros = [];
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            console.log(`[IMPORT] Promise ${index} sucesso:`, result.value);
                            sucessos.push(result.value);
                        } else {
                            console.error(`[IMPORT] Promise ${index} falhou:`, result.reason);
                            console.error(`[IMPORT] Erro completo:`, result.reason);
                            if (result.reason?.stack) {
                                console.error(`[IMPORT] Stack:`, result.reason.stack);
                            }
                            erros.push(result.reason?.message || result.reason?.toString() || 'Erro desconhecido');
                        }
                    });
                    
                    let msg = '';
                    if (sucessos.length > 0) {
                        msg = sucessos.map(r => {
                            if (r === 'dados') return 'Dados';
                            if (r === 'historico') return 'Hist√≥rico';
                            if (r === 'anotacoes') return 'Anota√ß√µes';
                            if (r === 'diario') return 'Di√°rio';
                            return r;
                        }).join(' e ');
                        mostrarNotificacaoFeedback(`‚úÖ ${msg} importados com sucesso!`);
                    }
                    
                    if (erros.length > 0) {
                        console.error('[IMPORT] Erros encontrados:', erros);
                        mostrarNotificacaoFeedback(`‚ö†Ô∏è Alguns arquivos n√£o puderam ser importados. Verifique o console.`, 'error');
                    }
                    document.getElementById('importDados').value = '';
                    document.getElementById('importHistorico').value = '';
                    document.getElementById('importAnotacoes').value = '';
                    document.getElementById('importDiario').value = '';
                    renderDados();
                    renderTarefas();
                    renderAgenda();
                    renderHistorico();
                    renderPendencias();
                    atualizarSelectsCaderno();
                    renderCaderno();
                    if (sucessos.includes('diario')) {
                        renderDiario();
                    }
                    updateFeedbackSelect();
                    updateStats();
                });
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('Arquivo n√£o fornecido'));
                    return;
                }
                console.log('[PARSE CSV] Lendo arquivo:', file.name, 'tamanho:', file.size);
                const reader = new FileReader();
                reader.onerror = (err) => {
                    console.error('[PARSE CSV] Erro ao ler arquivo:', err);
                    reject(new Error('Erro ao ler arquivo: ' + (err.message || 'Erro desconhecido')));
                };
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        console.log('[PARSE CSV] Arquivo lido, tamanho do texto:', text.length);
                        if (!text || text.trim() === '') {
                            reject(new Error('Arquivo est√° vazio'));
                            return;
                        }
                        const rows = parseCSVText(text);
                        console.log('[PARSE CSV] Linhas parseadas:', rows.length);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo vazio ou inv√°lido (menos de 2 linhas)'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx]) {
                                    return stripOuterQuotes(r[idx]);
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            return {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                status: getVal(r, 'status', 'estado') || 'N√£o iniciado',
                                prioridade: parseInt(getVal(r, 'prioridade', 'prior')) || 3,
                                dificuldade: getVal(r, 'dificuldade', 'dific') || 'M√©dia',
                                rendimento: (() => {
                                    const valStr = getVal(r, 'rendimento', 'rend');
                                    if (!valStr) return 0;
                                    const cleanStr = valStr.replace('%', '').replace(',', '.');
                                    const val = parseFloat(cleanStr) || 0;
                                    return val > 1 ? val / 100 : val;
                                })(),
                                sessoes: parseInt(getVal(r, 'sessoes', 'sessao')) || 0,
                                ultEstudo: getVal(r, 'ultestudo', 'ultest', 'ultimoestudo', 'ultimo_estudo'),
                                agenda: getVal(r, 'dataagenda', 'agenda', 'data_agenda'),
                                tempo: parseInt(getVal(r, 'tempomin', 'tempo')) || 0,
                                observacoes: getVal(r, 'observacoes', 'obs', 'observacao'),
                                contador80: parseInt(getVal(r, 'contador80')) || 0,
                                sugestao: getVal(r, 'sugestao', 'sugestoes'),
                                data: getVal(r, 'data'),
                                temaId: getVal(r, 'temaid')
                            };
                        });
                        const antesFiltro = data.length;
                        const dataFiltrada = data.filter(obj => obj.tema && obj.tema.trim() !== '');
                        console.log('[PARSE CSV] Registros antes do filtro:', antesFiltro, 'depois:', dataFiltrada.length);
                        if (dataFiltrada.length === 0 && antesFiltro > 0) {
                            console.warn('[PARSE CSV] ATEN√á√ÉO: Todos os registros foram filtrados! Verifique se o campo "tema" existe no CSV.');
                        }
                        resolve(dataFiltrada);
                    } catch (err) {
                        console.error('[PARSE CSV] Erro no processamento:', err);
                        console.error('[PARSE CSV] Stack:', err.stack);
                        reject(err);
                    }
                };
                console.log('[PARSE CSV] Iniciando leitura do arquivo...');
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PARSER ESPEC√çFICO PARA DI√ÅRIO
        function parseCSVDiario(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo de di√°rio'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = parseCSVText(text);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo de di√°rio vazio ou inv√°lido'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx] !== undefined && r[idx] !== null && String(r[idx]).trim() !== '') {
                                    return stripOuterQuotes(String(r[idx]));
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map(r => {
                            const entrada = {
                                id: getVal(r, 'id') || Date.now() + Math.random(),
                                data: getVal(r, 'data') || new Date().toISOString().split('T')[0],
                                area: getVal(r, 'area', '√°rea'),
                                tema: getVal(r, 'tema'),
                                topico: getVal(r, 'topico', 't√≥pico', 'pergunta'),
                                resposta: getVal(r, 'resposta'),
                                atencao: getVal(r, 'atencao', 'aten√ß√£o', 'atencao') === 'true' || getVal(r, 'atencao', 'aten√ß√£o') === '1',
                                criadoEm: getVal(r, 'criadoem', 'criad em', 'createdat'),
                                ultimaAtualizacao: getVal(r, 'ultimaatualizacao', '√∫ltima atualiza√ß√£o', 'updatedat') || new Date().toISOString().split('T')[0]
                            };
                            // Preservar quebras de linha
                            if (entrada.resposta) {
                                entrada.resposta = entrada.resposta.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                            }
                            
                            // Tentar parsear campo SRS se existir (compatibilidade com CSVs antigos)
                            const srsAtivo = getVal(r, 'srsativo', 'srs ativo', 'srsativo');
                            const srsProximaRevisao = getVal(r, 'srsproximarevisao', 'srs pr√≥xima revis√£o', 'srsproximarevisao');
                            const srsRepeticoes = getVal(r, 'srsrepeticoes', 'srs repeti√ß√µes', 'srsrepeticoes');
                            const srsUltimaResposta = getVal(r, 'srsultimaresposta', 'srs √∫ltima resposta', 'srsultimaresposta');
                            
                            // Se algum campo SRS existir, criar objeto srs
                            if (srsAtivo || srsProximaRevisao || srsRepeticoes || srsUltimaResposta) {
                                entrada.srs = {
                                    ativo: srsAtivo === 'true' || srsAtivo === '1' || srsAtivo === '',
                                    proximaRevisao: srsProximaRevisao || hojeStr(),
                                    repeticoes: parseInt(srsRepeticoes) || 0,
                                    ultimaResposta: srsUltimaResposta || null
                                };
                            }
                            // Se n√£o tiver campos SRS, inicializarSrsEntrada ser√° chamado depois
                            
                            return entrada;
                        });
                        console.log('[PARSE CSV] Dados processados:', data.length, 'registros');
                        resolve(data);
                    } catch (err) {
                        console.error('[PARSE CSV] Erro no processamento:', err);
                        console.error('[PARSE CSV] Stack:', err.stack);
                        reject(err);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PARSER ESPEC√çFICO PARA ANOTA√á√ïES
        // Mapeia campos corretos: id, temaId, area, tema, conteudo, ultimaAtualizacao
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function parseCSVAnotacoes(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo de anota√ß√µes'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        console.log('[PARSE CSV ANOTACOES] Arquivo lido, tamanho:', text.length, 'caracteres');
                        console.log('[PARSE CSV ANOTACOES] Primeiros 500 caracteres:', text.substring(0, 500));
                        const rows = parseCSVText(text);
                        console.log('[PARSE CSV ANOTACOES] Linhas parseadas:', rows.length);
                        if (rows.length > 0) {
                            console.log('[PARSE CSV ANOTACOES] Headers:', rows[0]);
                        }
                        if (rows.length < 2) {
                            reject(new Error('Arquivo de anota√ß√µes vazio ou inv√°lido. Linhas encontradas: ' + rows.length));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx] !== undefined && r[idx] !== null && String(r[idx]).trim() !== '') {
                                    return stripOuterQuotes(String(r[idx]));
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            let conteudo = getVal(r, 'conteudo', 'conte√∫do', 'conteudo', 'texto', 'anotacao', 'anota√ß√£o');
                            // Preservar quebras de linha no conte√∫do
                            if (conteudo) {
                                conteudo = conteudo.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                            }
                            
                            // Separar Hot Topics do conte√∫do geral
                            let hotTopics = '';
                            let conteudoGeral = conteudo || '';
                            
                            if (conteudo) {
                                // Procurar por padr√µes de Hot Topics no in√≠cio do conte√∫do
                                const hotTopicsPatterns = [
                                    /^HOT\s+TOPICS?\s*üî•?\s*\n/i,
                                    /^Hot\s+Topics?\s*üî•?\s*\n/i,
                                    /^hot\s+topics?\s*üî•?\s*\n/i,
                                    /^HOT\s+TOPICS?\s*üî•/i,
                                    /^Hot\s+Topics?\s*üî•/i
                                ];
                                
                                let hotTopicsStart = -1;
                                for (const pattern of hotTopicsPatterns) {
                                    const match = conteudo.match(pattern);
                                    if (match) {
                                        hotTopicsStart = match.index + match[0].length;
                                        break;
                                    }
                                }
                                
                                if (hotTopicsStart > -1) {
                                    // Extrair Hot Topics (tudo ap√≥s o marcador at√© o fim ou pr√≥xima se√ß√£o)
                                    const restante = conteudo.substring(hotTopicsStart);
                                    // Se houver conte√∫do ap√≥s Hot Topics, separar
                                    const partes = restante.split(/\n\n+/);
                                    
                                    if (partes.length > 0) {
                                        hotTopics = partes[0].trim();
                                        // O resto vai para conte√∫do geral (se houver mais de uma parte)
                                        if (partes.length > 1) {
                                            conteudoGeral = partes.slice(1).join('\n\n').trim();
                                        } else {
                                            conteudoGeral = '';
                                        }
                                    } else {
                                        hotTopics = restante.trim();
                                        conteudoGeral = '';
                                    }
                                }
                            }
                            
                            const anotacao = {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                temaId: getVal(r, 'temaid', 'tema_id', 'temaid', 'temaid'),
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                conteudo: conteudoGeral,
                                hotTopics: hotTopics,
                                ultimaAtualizacao: getVal(r, 'ultimaatualizacao', 'ultima_atualizacao', 'ultimaatualizacao', 'data', 'dataatualizacao') || new Date().toISOString().split('T')[0]
                            };
                            
                            // Tentar resolver temaId pelo nome se necess√°rio
                            if (!anotacao.temaId || anotacao.temaId.trim() === '') {
                                if (anotacao.tema) {
                                    const tema = dados.find(t => String(t.tema).trim() === String(anotacao.tema).trim());
                                    if (tema) {
                                        anotacao.temaId = String(tema.id);
                                        anotacao.area = tema.area;
                                        anotacao.tema = tema.tema;
                                    }
                                }
                            } else {
                                // Verificar se temaId existe e atualizar √°rea/tema
                                const tema = dados.find(t => String(t.id) === String(anotacao.temaId));
                                if (tema) {
                                    anotacao.area = tema.area;
                                    anotacao.tema = tema.tema;
                                }
                            }
                            
                            return anotacao;
                        }).filter(obj => {
                            // Manter apenas anota√ß√µes que t√™m temaId v√°lido
                            return obj.temaId && obj.temaId.trim() !== '';
                        });
                        console.log(`[PARSE CSV ANOTACOES] ${data.length} anota√ß√µes parseadas de ${rows.length - 1} linhas`);
                        console.log('[PARSE CSV ANOTACOES] Primeira anota√ß√£o:', data[0]);
                        if (data.length === 0) {
                            console.warn('[PARSE CSV ANOTACOES] NENHUMA anota√ß√£o v√°lida encontrada ap√≥s filtro!');
                            console.warn('[PARSE CSV ANOTACOES] Verifique se temaId ou tema est√£o corretos');
                        }
                        resolve(data);
                    } catch (err) {
                        reject(new Error('Erro ao processar CSV de anota√ß√µes: ' + err.message));
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function parseCSVText(input) {
            let text = String(input || '').replace(/^\uFEFF/, '');
            const rows = [];
            let row = [];
            let cell = '';
            let i = 0;
            let inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    // Dentro de aspas: preservar tudo, incluindo quebras de linha
                    if (ch === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            // Aspas duplas escapadas: ""
                            cell += '"';
                            i += 2;
                        } else if (next === ',' || next === '\r' || next === '\n' || i === text.length - 1) {
                            // Fim do campo entre aspas
                            inQuotes = false;
                            i += 1;
                        } else {
                            // Aspas simples dentro do campo (mant√©m)
                            cell += ch;
                            i += 1;
                        }
                    } else {
                        // Qualquer caractere dentro de aspas (incluindo \n e \r)
                        cell += ch;
                        i += 1;
                    }
                } else {
                    // Fora de aspas
                    if (ch === '"') {
                        inQuotes = true;
                        i += 1;
                    } else if (ch === ',') {
                        row.push(cell);
                        cell = '';
                        i += 1;
                    } else if (ch === '\r') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        if (text[i + 1] === '\n') i += 2; else i += 1;
                    } else if (ch === '\n') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        i += 1;
                    } else {
                        cell += ch;
                        i += 1;
                    }
                }
            }
            // Adicionar √∫ltima c√©lula e linha
            if (cell || row.length > 0) {
                row.push(cell);
                rows.push(row);
            }
            return rows;
        }
        
        function stripOuterQuotes(s) {
            const str = String(s ?? '');
            if (str.length >= 2 && str[0] === '"' && str[str.length - 1] === '"') {
                return str.slice(1, -1).replace(/""/g, '"');
            }
            return str;
        }
        
        function exportarDados() {
            const csv = dados2CSV(dados);
            const hoje = obterYMDLocal();
            downloadCSV(csv, `VRVS_DADOS_${hoje}.csv`);
        }
        
        function exportarHistorico() {
            const csv = dados2CSV(historico);
            const hoje = obterYMDLocal();
            downloadCSV(csv, `VRVS_HISTORICO_${hoje}.csv`);
        }
        
        function exportarAnotacoes() {
            // üîß CORRE√á√ÉO: Exportar apenas anota√ß√µes que t√™m conte√∫do
            const anotacoesComConteudo = anotacoes.filter(a => {
                const conteudo = (a.conteudo || '').trim();
                return conteudo.length > 0;
            });
            
            if (anotacoesComConteudo.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma anota√ß√£o com conte√∫do para exportar!', 'error');
                return;
            }
            
            const csv = dados2CSV(anotacoesComConteudo);
            const hoje = obterYMDLocal();
            downloadCSV(csv, `VRVS_ANOTACOES_${hoje}.csv`);
            mostrarNotificacaoFeedback(`‚úÖ ${anotacoesComConteudo.length} anota√ß√£o(√µes) exportadas!`);
        }
        
        // ==================== CONFIGURA√á√ïES ====================
        
        function irParaRevisoesDiario() {
            showSection('diario');
            setTimeout(() => {
                const el = document.getElementById('diarioIndicadoresVRVS');
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        // PACOTE A: Fun√ß√£o helper para atualizar labels de perfil ativo
        function atualizarLabelsPerfilAtivo() {
            const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
            // PATCH P3: Usar displayName em vez de perfilId (textContent j√° escapa automaticamente)
            const displayName = window.vrvs_getDisplayName(perfilAtivo);
            const elBackup = document.getElementById('backupPerfilAtivo');
            const elBackupImport = document.getElementById('backupPerfilAtivoImport');
            const elConfig = document.getElementById('configPerfilAtivo');
            if (elBackup) elBackup.textContent = displayName;
            if (elBackupImport) elBackupImport.textContent = displayName;
            if (elConfig) elConfig.textContent = displayName;
        }
        
        function renderConfig() {
            const enabled = vrvs_isDiarioEnabled();
            const checkbox = document.getElementById('configDiarioEnabled');
            if (checkbox) checkbox.checked = enabled;
            // Atualizar VRVS_BUILD na UI
            const buildEl = document.getElementById('configVrvsBuild');
            if (buildEl && typeof VRVS_BUILD !== 'undefined') {
                buildEl.textContent = VRVS_BUILD;
            }
            // PACOTE A: Atualizar label de perfil ativo
            atualizarLabelsPerfilAtivo();
            const sobreBuild = document.getElementById('configSobreBuild');
            if (sobreBuild && typeof VRVS_BUILD !== 'undefined') {
                sobreBuild.textContent = VRVS_BUILD;
            }
            // Atualizar header
            const headerBuild = document.getElementById('vrvsBuildDisplay');
            if (headerBuild && typeof VRVS_BUILD !== 'undefined') {
                headerBuild.textContent = VRVS_BUILD;
            }
            // Calcular uso de armazenamento
            const storageEl = document.getElementById('configStorageUsage');
            if (storageEl) {
                try {
                    let totalBytes = 0;
                    const keys = ['vrvs_dados', 'vrvs_historico', 'vrvs_anotacoes', 'vrvs_diario', 'vrvs_config', 'vrvs_lembretes'];
                    keys.forEach(key => {
                        const val = localStorage.getItem(key);
                        if (val) totalBytes += new Blob([val]).size;
                    });
                    const mb = (totalBytes / (1024 * 1024)).toFixed(2);
                    storageEl.textContent = `${mb} MB`;
                } catch(e) {
                    storageEl.textContent = 'N/A';
                }
            }
            // PATCH D1: Sincronizar select de perfil (renderizar dinamicamente)
            const selectPerfil = document.getElementById('perfilAtivoSelect');
            if (selectPerfil) {
                // PATCH P3: Usar displayName no texto do option via DOM (mais seguro que innerHTML)
                const perfis = window.vrvs_listarPerfis();
                selectPerfil.innerHTML = ''; // Limpar primeiro
                perfis.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p; // value sempre √© perfilId (n√£o displayName)
                    option.textContent = window.vrvs_getDisplayName(p); // textContent escapa automaticamente
                    selectPerfil.appendChild(option);
                });
                selectPerfil.value = window.vrvs_perfilAtivo || 'DEFAULT';
            }
        }
        
        // ==================== GERENCIAR PERFIS V1 - PATCH D1 ====================
        
        // Helper para construir chave de um perfil espec√≠fico (sem trocar contexto global)
        window.vrvs_keyOf = function(perfil, baseKey) {
            if (perfil === 'DEFAULT') {
                return `vrvs_${baseKey}`;
            }
            return `vrvs_${perfil}_${baseKey}`;
        };
        
        window.vrvs_diarioKeyOf = function(perfil) {
            return window.vrvs_keyOf(perfil, 'diario');
        };
        
        // ==================== P3: DISPLAY NAMES DE PERFIS ====================
        
        // Helper: Escapar HTML para prevenir XSS
        window.vrvs_escapeHTML = function(str) {
            if (typeof str !== 'string') return String(str || '');
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };
        
        // Helper: Obter objeto completo de displayNames
        window.vrvs_getDisplayNames = function() {
            try {
                const raw = localStorage.getItem('vrvs_perfis_displayNames');
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return (typeof parsed === 'object' && parsed !== null) ? parsed : {};
            } catch(e) {
                console.warn('[PERFIS P3] Erro ao ler displayNames:', e);
                return {};
            }
        };
        
        // Helper: Salvar objeto completo de displayNames
        window.vrvs_setDisplayNames = function(obj) {
            try {
                if (!obj || typeof obj !== 'object') {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar nomes de exibi√ß√£o', 'error');
                    return false;
                }
                localStorage.setItem('vrvs_perfis_displayNames', JSON.stringify(obj));
                return true;
            } catch(e) {
                console.error('[PERFIS P3] Erro ao salvar displayNames:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar nomes de exibi√ß√£o (armazenamento cheio?)', 'error');
                return false;
            }
        };
        
        // Helper: Obter displayName de um perfil (ou retornar perfilId se n√£o houver)
        window.vrvs_getDisplayName = function(perfilId) {
            if (!perfilId || typeof perfilId !== 'string') return perfilId || 'DEFAULT';
            const displayNames = window.vrvs_getDisplayNames();
            return displayNames[perfilId] || perfilId;
        };
        
        // Helper: Sanitizar displayName para uso seguro em strings (trim + limit)
        window.vrvs_sanitizeDisplayName = function(displayName) {
            if (typeof displayName !== 'string') return String(displayName || '').trim();
            return displayName.trim().substring(0, 40);
        };
        
        // ==================== FIM P3: DISPLAY NAMES ====================
        
        // ==================== MAPAS MENTAIS ====================
        
        const MINDMAPS_GPT_URL = 'https://chatgpt.com/g/g-69864f5ec28881919ed073c3c11e9f19-avaliador-teot-2a-fase-6-min';
        
        // Parser VRVS Outline v1
        function mindmaps_parseOutline(text) {
            const lines = text.split('\n');
            const stack = [];
            const root = { id: 'root', label: 'Root', children: [], details: [] };
            let lastNode = root;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                let indent = 0;
                for (let j = 0; j < line.length; j++) {
                    if (line[j] === ' ') indent++;
                    else if (line[j] === '\t') indent += 2;
                    else break;
                }
                const level = Math.floor(indent / 2);
                
                if (trimmed.startsWith('- ')) {
                    const label = trimmed.substring(2).trim();
                    if (!label) continue;
                    
                    const node = {
                        id: `node_${i}_${Date.now()}_${Math.random()}`,
                        label: label,
                        children: [],
                        details: []
                    };
                    
                    while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                        stack.pop();
                    }
                    
                    const parent = stack.length > 0 ? stack[stack.length - 1].node : root;
                    parent.children.push(node);
                    
                    stack.push({ node, level });
                    lastNode = node;
                } else if (trimmed.startsWith('* ')) {
                    const detail = trimmed.substring(2).trim();
                    if (detail && lastNode) {
                        lastNode.details.push(detail);
                    }
                }
            }
            
            return root.children.length > 0 ? root.children[0] : null;
        }
        
        function mindmaps_generateId(title) {
            const slug = title.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            return `${slug}_${Date.now()}`;
        }
        
        function mindmaps_countNodes(node) {
            if (!node) return 0;
            let count = 1;
            if (node.children) {
                node.children.forEach(child => {
                    count += mindmaps_countNodes(child);
                });
            }
            return count;
        }
        
        function mindmaps_getAll() {
            try {
                const raw = localStorage.getItem('vrvs_mindmaps');
                if (!raw) return { version: 1, items: [] };
                const parsed = JSON.parse(raw);
                return parsed.version ? parsed : { version: 1, items: parsed };
            } catch(e) {
                return { version: 1, items: [] };
            }
        }
        
        function mindmaps_saveAll(data) {
            try {
                const jsonStr = JSON.stringify(data);
                if (typeof vrvs_safeSetItem === 'function') {
                    return vrvs_safeSetItem('vrvs_mindmaps', jsonStr, 'mindmaps');
                } else {
                    localStorage.setItem('vrvs_mindmaps', jsonStr);
                    return true;
                }
            } catch(e) {
                console.error('[MINDMAPS] Erro ao salvar:', e);
                if (window.isQuotaExceeded && window.isQuotaExceeded(e)) {
                    if (typeof vrvs_showQuotaModal === 'function') {
                        vrvs_showQuotaModal('crit');
                    }
                }
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar. Verifique o armazenamento.', 'error');
                return false;
            }
        }
        
        function mindmaps_gerarMapa() {
            const textarea = document.getElementById('mindmapsOutlineInput');
            const outline = textarea.value.trim();
            
            if (!outline) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Cole um outline antes de gerar o mapa!', 'error');
                return;
            }
            
            const lines = outline.split('\n').filter(l => l.trim());
            const hasNodes = lines.some(l => l.trim().startsWith('- '));
            if (!hasNodes) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Formato inv√°lido. Use - para n√≥s e * para detalhes.', 'error');
                return;
            }
            
            try {
                // Parsear para validar e calcular nodeCount
                const map = mindmaps_parseOutline(outline);
                if (!map) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao parsear outline. Verifique o formato.', 'error');
                    return;
                }
                
                const title = map.label || 'Mapa Sem T√≠tulo';
                const id = mindmaps_generateId(title);
                const nodeCount = mindmaps_countNodes(map);
                
                // Salvar APENAS outline (sem map) - arquitetura outline-only
                const all = mindmaps_getAll();
                all.items.push({
                    id: id,
                    title: title,
                    updatedAt: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    sourceType: 'outline',
                    outlineText: outline,
                    nodeCount: nodeCount
                    // N√ÉO salvar item.map (gerado em mem√≥ria no viewer)
                });
                
                if (!mindmaps_saveAll(all)) {
                    return;
                }
                
                textarea.value = '';
                mindmaps_renderLista();
                
                // Abrir viewer com from=vrvs
                window.location.href = `./mindmap/?id=${id}&from=vrvs`;
                
            } catch(e) {
                console.error('[MINDMAPS] Erro:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao gerar mapa: ' + (e.message || 'Erro desconhecido'), 'error');
            }
        }
        
        function mindmaps_renderLista() {
            const container = document.getElementById('mindmapsLista');
            const countEl = document.getElementById('mindmapsCount');
            if (!container) return;
            
            const all = mindmaps_getAll();
            const items = all.items || [];
            
            if (countEl) {
                countEl.textContent = `${items.length} ${items.length === 1 ? 'mapa' : 'mapas'}`;
            }
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">üß†</div>
                        <p style="font-size: 14px;">Nenhum mapa ainda. Crie seu primeiro!</p>
                    </div>
                `;
                return;
            }
            
            items.sort((a, b) => new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0));
            
            container.innerHTML = items.map(item => {
                // Compat: calcular nodeCount se n√£o existir (legado)
                let nodeCount = item.nodeCount;
                if (!nodeCount && item.map) {
                    nodeCount = mindmaps_countNodes(item.map);
                } else if (!nodeCount && item.outlineText) {
                    const tempMap = mindmaps_parseOutline(item.outlineText);
                    nodeCount = tempMap ? mindmaps_countNodes(tempMap) : 0;
                }
                
                const date = new Date(item.updatedAt || item.createdAt || Date.now());
                const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                
                return `
                    <div class="mindmap-item" data-id="${item.id}" 
                         onclick="mindmaps_abrirMapa('${item.id}')"
                         style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: rgba(0,206,209,0.05); border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(0,206,209,0.2); cursor: pointer; touch-action: manipulation; min-height: 44px;">
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 14px; color: var(--turquesa-light); margin: 0 0 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${vrvs_escapeHTML(item.title)}</h4>
                            <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin: 0;">${nodeCount || 0} n√≥s ‚Ä¢ ${dateStr}</p>
                        </div>
                        <span style="font-size: 20px; color: rgba(255,255,255,0.6); margin-left: 12px;">‚ñ∂</span>
                    </div>
                `;
            }).join('');
        }
        
        function mindmaps_abrirMapa(id) {
            window.location.href = `./mindmap/?id=${id}&from=vrvs`;
        }
        
        function mindmaps_abrirGPT() {
            const url = MINDMAPS_GPT_URL || '';
            if (url) {
                window.open(url, '_blank');
            } else {
                mostrarNotificacaoFeedback('‚ö†Ô∏è URL do GPT n√£o configurada', 'error');
            }
        }
        
        function mindmaps_copiarPrompt() {
            const prompt = `MODO GABARITO ‚Äî OUTLINE VRVS v1

Gere um resumo no formato VRVS Outline v1 para virar mapa mental.

REGRAS OBRIGAT√ìRIAS:
- Resposta APENAS em bloco de c√≥digo (sem texto explicativo antes/depois).
- Cada linha come√ßa com "- " (n√≥s) ou "* " (detalhes).
- Indenta√ß√£o: exatamente 2 espa√ßos por n√≠vel (sem TAB).
- PROIBIDO: bullets "‚Ä¢/‚óè", numera√ß√£o, par√°grafos soltos, texto fora do bloco de c√≥digo.
- Seja hier√°rquico e objetivo.

TEMA: [COLE O TEMA AQUI]`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(prompt).then(() => {
                    mostrarNotificacaoFeedback('‚úÖ Prompt copiado!');
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    mostrarNotificacaoFeedback('‚úÖ Prompt copiado!');
                } catch(e) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao copiar. Tente manualmente.', 'error');
                }
                document.body.removeChild(textarea);
            }
        }
        
        // ==================== FIM MAPAS MENTAIS ====================
        
        // ==================== MODO AVAN√áADO DO DI√ÅRIO ====================
        
        function modoAvancado_getAtivo() {
            const val = localStorage.getItem('modoAvancadoAtivo');
            return val === 'true';
        }
        
        function modoAvancado_setAtivo(ativo) {
            localStorage.setItem('modoAvancadoAtivo', ativo ? 'true' : 'false');
        }
        
        function modoAvancado_getRankingOrdem() {
            const val = localStorage.getItem('rankingOrdem');
            return val === 'desc' ? 'desc' : 'asc';
        }
        
        function modoAvancado_setRankingOrdem(ordem) {
            localStorage.setItem('rankingOrdem', ordem === 'desc' ? 'desc' : 'asc');
        }
        
        function calcularDiasEntreDatas(data1, data2) {
            // Parse seguro com T00:00:00 para evitar timezone
            const d1 = new Date(data1 + 'T00:00:00');
            const d2 = new Date(data2 + 'T00:00:00');
            const diffTime = Math.abs(d2 - d1);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
function modoAvancado_toggle() {
    const checkbox = document.getElementById('toggleModoAvancado');
    const ativo = checkbox.checked;
    modoAvancado_setAtivo(ativo);
    
    // Atualizar visual do toggle
    diarioModoAvancado_atualizarToggleVisual();
    
    if (ativo) {
        mostrarNotificacaoFeedback('‚ú® Modo Avan√ßado ativado<br>Agora voc√™ pode acompanhar seu desempenho nos casos cl√≠nicos.', 'success', 3000);
    }
    
    // Renderizar UI do Modo Avan√ßado (badge + bot√£o ranking)
    diarioModoAvancado_renderUI();
    
    // Se modal estiver aberto, atualizar box desempenho
    const modal = document.getElementById('modalNovaDiario');
    if (modal && modal.style.display !== 'none' && modal.style.display !== '') {
        const entradaId = document.getElementById('novaDiarioId')?.value;
        if (entradaId) {
            // Edi√ß√£o: buscar entrada e renderizar com dados
            const entrada = window.diario?.entradas?.find(e => String(e.id) === entradaId);
            diarioModoAvancado_renderBoxDesempenho(entrada || null);
        } else {
            // Nova entrada: renderizar vazio
            diarioModoAvancado_renderBoxDesempenho(null);
        }
    }
    
    if (typeof renderDiario === 'function') {
        renderDiario();
    }
    
    if (typeof renderAjuda === 'function') {
        renderAjuda();
    }
}
        
        function modoAvancado_toggleRankingOrdem() {
            const atual = modoAvancado_getRankingOrdem();
            const nova = atual === 'asc' ? 'desc' : 'asc';
            modoAvancado_setRankingOrdem(nova);
            renderRanking();
        }
        
        function diarioModoAvancado_renderUI() {
            // A) Badge "AVAN√áADO" no header
            const badgeMount = document.getElementById('diarioBadgeAvancadoMount');
            if (badgeMount) {
                if (modoAvancado_getAtivo()) {
                    badgeMount.innerHTML = '<span class="badge-avancado" style="margin-left: 10px;">AVAN√áADO</span>';
                } else {
                    badgeMount.innerHTML = '';
                }
            }
            
            // B) Bot√£o "üèÜ Ranking" nos modos
            const rankingBtnMount = document.getElementById('diarioRankingBtnMount');
            if (rankingBtnMount) {
                if (modoAvancado_getAtivo()) {
                    rankingBtnMount.innerHTML = `<button class="modo-btn modo-inativo" id="modoRanking" onclick="setModoDiario('ranking')">
                            üèÜ Ranking
                        </button>`;
                } else {
                    rankingBtnMount.innerHTML = '';
                    // Se estava em ranking e modo foi desativado, voltar para recall
                    if (typeof modoDiario !== 'undefined' && modoDiario === 'ranking') {
                        modoDiario = 'recall';
                        if (typeof renderDiario === 'function') {
                            renderDiario();
                        }
                    }
                }
            }
            
            // Atualizar toggle visual ao renderizar UI
            diarioModoAvancado_atualizarToggleVisual();
        }
        
        function diarioModoAvancado_renderBoxDesempenho(entradaOpt) {
            const mount = document.getElementById('diarioDesempenhoMount');
            if (!mount) return;
            
            // Se modo n√£o est√° ativo, limpar mount
            if (!modoAvancado_getAtivo()) {
                mount.innerHTML = '';
                return;
            }
            
            // Renderizar box completo
            const nota = entradaOpt && typeof entradaOpt.notaDesempenho === 'number' && !isNaN(entradaOpt.notaDesempenho) ? entradaOpt.notaDesempenho : null;
            const obs = entradaOpt && entradaOpt.obsDesempenho ? entradaOpt.obsDesempenho : '';
            
            mount.innerHTML = `
                <div class="desempenho-box" style="background: linear-gradient(135deg, rgba(255,184,77,0.12), rgba(255,184,77,0.05)); border: 1px solid rgba(255,184,77,0.2); border-radius: 18px; padding: 20px; margin-top: 24px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: rgba(255,184,77,0.9); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        üèÜ Desempenho (Modo Avan√ßado)
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Nota do √∫ltimo treino</label>
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="flex: 1;">
                                <input type="range" id="novaDiarioNotaDesempenho" min="0" max="10" step="0.5" value="${nota !== null ? nota : '0'}" data-touched="${nota !== null ? '1' : '0'}" style="width: 100%;">
                            </div>
                            <div id="novaDiarioNotaDesempenhoValue" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 800; color: rgba(255,184,77,0.9); background: rgba(0,0,0,0.3); border: 1px solid rgba(255,184,77,0.2); border-radius: 16px;">${nota !== null ? nota.toFixed(1) : '‚Äî'}</div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Observa√ß√£o (opcional)</label>
                        <textarea id="novaDiarioObsDesempenho" placeholder="Ex: confundi classifica√ß√£o..." rows="3" style="width: 100%; padding: 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; color: rgba(255,255,255,0.9); font-size: 15px; resize: vertical; min-height: 60px; white-space: pre-wrap; word-wrap: break-word; font-family: inherit;">${vrvs_escapeHTML(obs)}</textarea>
                    </div>
                </div>
            `;
            
            // Configurar listener do slider ap√≥s inserir HTML
            const slider = document.getElementById('novaDiarioNotaDesempenho');
            const valueDisplay = document.getElementById('novaDiarioNotaDesempenhoValue');
            if (slider && valueDisplay) {
                // Remover listener anterior se existir (evitar duplica√ß√£o)
                const newSlider = slider.cloneNode(true);
                slider.parentNode.replaceChild(newSlider, slider);
                
                newSlider.addEventListener('input', function() {
                    this.dataset.touched = '1';
                    const val = parseFloat(this.value) || 0;
                    const display = document.getElementById('novaDiarioNotaDesempenhoValue');
                    if (display) display.textContent = val.toFixed(1);
                });
                
                // Adicionar listener de clique no box da nota para resetar para indefinido
                valueDisplay.style.cursor = 'pointer';
                valueDisplay.title = 'Clique para remover a nota';
                const resetNota = function() {
                    const currentSlider = document.getElementById('novaDiarioNotaDesempenho');
                    const currentDisplay = document.getElementById('novaDiarioNotaDesempenhoValue');
                    if (currentSlider && currentDisplay) {
                        currentSlider.value = '0';
                        currentSlider.dataset.touched = '0';
                        currentDisplay.textContent = '‚Äî';
                    }
                };
                // Remover listener anterior se existir
                const newValueDisplay = valueDisplay.cloneNode(true);
                valueDisplay.parentNode.replaceChild(newValueDisplay, valueDisplay);
                newValueDisplay.addEventListener('click', resetNota);
            }
        }
        
        function diarioModoAvancado_atualizarToggleVisual() {
            const checkbox = document.getElementById('toggleModoAvancado');
            const span = document.getElementById('toggleModoAvancadoSpan');
            const thumb = document.getElementById('toggleModoAvancadoThumb');
            
            if (!checkbox || !span || !thumb) return;
            
            const ativo = modoAvancado_getAtivo();
            checkbox.checked = ativo;
            
            if (ativo) {
                span.style.background = 'linear-gradient(135deg, rgba(0,206,209,0.2), rgba(0,206,209,0.3))';
                span.style.borderColor = 'rgba(0,206,209,0.5)';
                span.style.boxShadow = '0 0 20px rgba(0,206,209,0.15)';
                thumb.style.left = '24px';
                thumb.style.background = 'linear-gradient(145deg, #fff, rgba(0,206,209,0.8))';
            } else {
                span.style.background = 'rgba(255,255,255,0.1)';
                span.style.borderColor = 'rgba(255,255,255,0.1)';
                span.style.boxShadow = 'none';
                thumb.style.left = '3px';
                thumb.style.background = 'linear-gradient(145deg, #fff, #e8e8e8)';
            }
        }
        
        // ==================== FIM MODO AVAN√áADO ====================
        
        // Listar perfis existentes (descobrir via localStorage + lista expl√≠cita)
        window.vrvs_listarPerfis = function() {
            // Tentar lista expl√≠cita primeiro
            const listaRaw = localStorage.getItem('vrvs_perfis_lista');
            if (listaRaw) {
                try {
                    const lista = JSON.parse(listaRaw);
                    if (Array.isArray(lista) && lista.length > 0) {
                        // Garantir que DEFAULT est√° na lista
                        if (!lista.includes('DEFAULT')) {
                            lista.unshift('DEFAULT');
                        }
                        return lista.filter((p, i, arr) => arr.indexOf(p) === i); // Deduplicar
                    }
                } catch(e) {
                    console.warn('[PERFIS D1] Erro ao parsear lista:', e);
                }
            }
            
            // Fallback: descobrir perfis via chaves localStorage
            const perfisEncontrados = new Set(['DEFAULT']); // DEFAULT sempre existe
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                // Padr√£o: vrvs_PERFIL_dados, vrvs_PERFIL_historico, etc. (PERFIL em MAI√öSCULO)
                const match = key.match(/^vrvs_([A-Z0-9_]+)_(dados|historico|anotacoes|lembretes|diario|areas_custom)$/);
                if (match && match[1] !== 'DEFAULT') {
                    perfisEncontrados.add(match[1]);
                }
            });
            
            return Array.from(perfisEncontrados).sort();
        };
        
        // Salvar lista de perfis
        window.vrvs_salvarListaPerfis = function(perfis) {
            if (!Array.isArray(perfis) || perfis.length === 0) {
                console.warn('[PERFIS D1] Lista inv√°lida, n√£o salvando');
                return;
            }
            // Garantir DEFAULT sempre presente
            if (!perfis.includes('DEFAULT')) {
                perfis.unshift('DEFAULT');
            }
            // Deduplicar e ordenar
            const perfisUnicos = perfis.filter((p, i, arr) => arr.indexOf(p) === i);
            
            try {
                localStorage.setItem('vrvs_perfis_lista', JSON.stringify(perfisUnicos));
            } catch(e) {
                console.error('[PERFIS D1] Erro ao salvar lista de perfis:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Falha ao salvar lista de perfis', 'error');
            }
        };
        
        // Normalizar nome do perfil (A-Z0-9_, MAI√öSCULO)
        window.vrvs_normalizarNomePerfil = function(nome) {
            if (!nome || typeof nome !== 'string') return null;
            // Trim e converter para MAI√öSCULO
            let normalizado = nome.trim().toUpperCase();
            // Trocar espa√ßos por underscore
            normalizado = normalizado.replace(/\s+/g, '_');
            // Remover caracteres inv√°lidos (manter apenas A-Z0-9_)
            normalizado = normalizado.replace(/[^A-Z0-9_]/g, '');
            // N√£o pode come√ßar com n√∫mero
            if (/^[0-9]/.test(normalizado)) {
                return null;
            }
            return normalizado.length > 0 ? normalizado : null;
        };
        
        // Criar novo perfil
        window.vrvs_criarPerfil = function(nomeInput) {
            if (!nomeInput || typeof nomeInput !== 'string') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome do perfil √© obrigat√≥rio', 'error');
                return false;
            }
            
            // Normalizar nome (A-Z0-9_, MAI√öSCULO)
            const nome = window.vrvs_normalizarNomePerfil(nomeInput);
            if (!nome) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome inv√°lido. Use apenas letras, n√∫meros e underscore. N√£o pode come√ßar com n√∫mero.', 'error');
                return false;
            }
            
            // Validar tamanho
            if (nome.length > 30) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome muito longo (m√°ximo 30 caracteres)', 'error');
                return false;
            }
            
            // Validar √∫nico (case-insensitive j√° n√£o precisa, pois normalizamos para MAI√öSCULO)
            const perfisExistentes = window.vrvs_listarPerfis();
            if (perfisExistentes.includes(nome)) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è Perfil "${nome}" j√° existe`, 'error');
                return false;
            }
            
            // Adicionar √† lista
            perfisExistentes.push(nome);
            window.vrvs_salvarListaPerfis(perfisExistentes);
            
            // Criar datasets zerados (n√£o herdar nada)
            const datasets = ['dados', 'historico', 'anotacoes', 'lembretes', 'areas_custom'];
            datasets.forEach(baseKey => {
                const key = window.vrvs_keyOf(nome, baseKey);
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify([]));
                }
            });
            
            // Di√°rio zerado
            const diarioKey = window.vrvs_diarioKeyOf(nome);
            if (!localStorage.getItem(diarioKey)) {
                localStorage.setItem(diarioKey, JSON.stringify({entradas: [], schemaVersion: '1.0'}));
            }
            
            mostrarNotificacaoFeedback(`‚úÖ Perfil "${nome}" criado com sucesso!`);
            return true;
        };
        
        // Apagar perfil
        window.vrvs_apagarPerfil = function(perfil) {
            if (!perfil || typeof perfil !== 'string') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Perfil inv√°lido', 'error');
                return false;
            }
            
            // Travas
            if (perfil === 'DEFAULT') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o √© poss√≠vel apagar o perfil DEFAULT', 'error');
                return false;
            }
            
            const perfisExistentes = window.vrvs_listarPerfis();
            if (perfisExistentes.length <= 1) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o √© poss√≠vel apagar o √∫ltimo perfil', 'error');
                return false;
            }
            
            if (window.vrvs_perfilAtivo === perfil) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o √© poss√≠vel apagar o perfil ativo. Troque de perfil primeiro.', 'error');
                return false;
            }
            
            // Apagar todas as chaves do perfil
            const datasets = ['dados', 'historico', 'anotacoes', 'lembretes', 'areas_custom', 'diario'];
            datasets.forEach(baseKey => {
                const key = window.vrvs_keyOf(perfil, baseKey);
                try {
                    localStorage.removeItem(key);
                } catch(e) {
                    console.warn(`[PERFIS D1] Erro ao apagar ${key}:`, e);
                }
            });
            
            // Remover da lista
            const novaLista = perfisExistentes.filter(p => p !== perfil);
            window.vrvs_salvarListaPerfis(novaLista);
            
            mostrarNotificacaoFeedback(`‚úÖ Perfil "${perfil}" apagado com sucesso`);
            return true;
        };
        
        // PATCH D1: Inicializar lista de perfis se n√£o existir (migra√ß√£o) - DEPOIS de definir fun√ß√µes helper
        if (!localStorage.getItem('vrvs_perfis_lista')) {
            const perfisDescobertos = window.vrvs_listarPerfis();
            window.vrvs_salvarListaPerfis(perfisDescobertos);
        }
        
        // ==================== MODAL GERENCIAR PERFIS (P1.3) ====================
        
        window.abrirModalGerenciarPerfis = function() {
            const modal = document.getElementById('vrvsModalPerfis');
            if (!modal) return;
            
            // PATCH D1: Renderizar lista dinamicamente
            const listaContainer = document.getElementById('vrvsModalPerfisLista');
            if (listaContainer) {
                const perfis = window.vrvs_listarPerfis();
                const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
                let html = '';
                
                perfis.forEach(perfil => {
                    const isAtivo = perfil === perfilAtivo;
                    const isDefault = perfil === 'DEFAULT';
                    // PATCH P3: Usar displayName em vez de perfilId para exibi√ß√£o
                    const displayName = window.vrvs_getDisplayName ? window.vrvs_getDisplayName(perfil) : perfil;
                    // PATCH P3: Escapar HTML para seguran√ßa
                    const displayNameSafe = window.vrvs_escapeHTML ? window.vrvs_escapeHTML(displayName) : displayName;
                    // Escape robusto para onclick (backslash primeiro, depois aspas simples)
                    const perfilEsc = String(perfil).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                    
                    // P4: Usar classes CSS ao inv√©s de inline styles
                    const classeAtivo = isAtivo ? 'ativo' : '';
                    
                    html += `
                        <div class="perfil-item ${classeAtivo}">
                            <div class="perfil-item-info">
                                <span class="perfil-item-name">${displayNameSafe}</span>
                                ${isAtivo ? `
                                    <span class="badge-ativo">
                                        <span class="badge-ativo-dot"></span>
                                        ATIVO
                                    </span>
                                ` : ''}
                            </div>
                            <div class="perfil-item-actions">
                                ${!isAtivo ? `
                                    <button class="btn-perfil-action btn-perfil-ativar" onclick="trocarPerfil('${perfilEsc}')" title="Ativar perfil">‚ñ∂</button>
                                ` : ''}
                                <button class="btn-perfil-action btn-perfil-editar" onclick="vrvs_abrirEditarDisplayName('${perfilEsc}')" title="Editar nome">‚úèÔ∏è</button>
                                ${!isDefault && !isAtivo ? `
                                    <button class="btn-perfil-action btn-perfil-apagar" onclick="vrvs_confirmarApagarPerfil('${perfilEsc}')" title="Apagar perfil">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                listaContainer.innerHTML = html;
            }
            
            // Abrir modal
            modal.classList.add('active');
        };
        
        // PATCH D1: Modal auxiliar para criar perfil
        window.vrvs_abrirModalCriarPerfil = function() {
            const nomeInput = prompt('Digite o nome do novo perfil:\n\n(Ser√° convertido para MAI√öSCULO e espa√ßos ser√£o trocados por _)');
            if (nomeInput && nomeInput.trim()) {
                if (window.vrvs_criarPerfil(nomeInput.trim())) {
                    abrirModalGerenciarPerfis(); // Recarregar lista
                    renderConfig(); // Atualizar select tamb√©m
                }
            }
        };
        
        // PATCH D3: Helper de confirma√ß√£o simples (toast/overlay)
        window.vrvs_confirmToast = function(mensagem, onConfirm, onCancel) {
            // Remover toast/overlay anteriores se existirem
            const toastAnterior = document.getElementById('vrvs-confirm-toast');
            const overlayAnterior = document.getElementById('vrvs-confirm-overlay');
            if (toastAnterior) toastAnterior.remove();
            if (overlayAnterior) overlayAnterior.remove();
            
            // Criar overlay
            const overlay = document.createElement('div');
            overlay.id = 'vrvs-confirm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.6);
                z-index: 999997;
            `;
            
            // Criar toast
            const toast = document.createElement('div');
            toast.id = 'vrvs-confirm-toast';
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.95);
                border: 2px solid rgba(0,206,209,0.5);
                border-radius: 12px;
                padding: 24px;
                z-index: 999998;
                min-width: 280px;
                max-width: 90vw;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;
            
            toast.innerHTML = `
                <div style="color: rgba(255,255,255,0.9); font-size: 15px; margin-bottom: 20px; text-align: center; line-height: 1.4;">
                    ${mensagem}
                </div>
                <div style="display: flex; gap: 12px;">
                    <button id="vrvs-confirm-cancel" style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.9); padding: 10px; border-radius: 6px; font-size: 14px; cursor: pointer; touch-action: manipulation;">Cancelar</button>
                    <button id="vrvs-confirm-ok" style="flex: 1; background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.6); color: #EF4444; padding: 10px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; touch-action: manipulation;">Apagar</button>
                </div>
            `;
            
            // Fun√ß√£o fechar (remove toast E overlay)
            const fechar = () => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
            };
            
            // Append no DOM ANTES de bindar handlers
            document.body.appendChild(overlay);
            document.body.appendChild(toast);
            
            // Bindar handlers usando refer√™ncias locais (querySelector no toast j√° appendado)
            const btnCancel = toast.querySelector('#vrvs-confirm-cancel');
            const btnOk = toast.querySelector('#vrvs-confirm-ok');
            
            btnCancel.onclick = () => {
                fechar();
                if (onCancel) onCancel();
            };
            
            btnOk.onclick = () => {
                fechar();
                if (onConfirm) onConfirm();
            };
            
            // Clique no overlay cancela
            overlay.onclick = () => {
                fechar();
                if (onCancel) onCancel();
            };
        };
        
        // PATCH D3: Confirmar apagar perfil (com toast de confirma√ß√£o)
        window.vrvs_confirmarApagarPerfil = function(perfil) {
            window.vrvs_confirmToast(
                `Apagar o perfil "${perfil}"?<br><small style="color: rgba(255,255,255,0.6); display: block; margin-top: 8px;">Esta a√ß√£o √© irrevers√≠vel.</small>`,
                () => {
                    // Confirmou: apagar
                    if (window.vrvs_apagarPerfil(perfil)) {
                        abrirModalGerenciarPerfis(); // Recarregar lista
                        renderConfig(); // Atualizar select
                    }
                },
                () => {
                    // Cancelou: nada
                }
            );
        };
        
        // PATCH P3: Abrir modal para editar displayName de um perfil
        window.vrvs_abrirEditarDisplayName = function(perfilId) {
            if (!perfilId || typeof perfilId !== 'string') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Perfil inv√°lido', 'error');
                return;
            }
            
            const displayNames = window.vrvs_getDisplayNames();
            const displayNameAtual = displayNames[perfilId] || '';
            
            // PATCH P3: Prompt funciona mesmo se iPhone ignorar valor default
            const promptMsg = `Digite o nome de exibi√ß√£o para o perfil "${perfilId}":\n\n(Deixe vazio para remover o nome de exibi√ß√£o)\n(M√°ximo: 40 caracteres)`;
            
            // Tentar passar valor atual, mas n√£o depender dele
            const novoDisplayNameInput = prompt(promptMsg, displayNameAtual);
            
            if (novoDisplayNameInput === null) {
                // Usu√°rio cancelou prompt - sair silencioso
                return;
            }
            
            // Sanitiza√ß√£o leve (garantir string)
            let novoDisplayName = String(novoDisplayNameInput || '').trim();
            
            // Limite de caracteres
            if (novoDisplayName.length > 40) {
                novoDisplayName = novoDisplayName.substring(0, 40).trim();
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome truncado para 40 caracteres', 'warning');
            }
            
            // Atualizar displayNames
            const displayNamesAtualizado = { ...displayNames };
            
            if (!novoDisplayName || novoDisplayName.length === 0) {
                // Remover displayName (volta a exibir perfilId)
                delete displayNamesAtualizado[perfilId];
            } else {
                // Salvar novo displayName
                displayNamesAtualizado[perfilId] = novoDisplayName;
            }
            
            if (window.vrvs_setDisplayNames(displayNamesAtualizado)) {
                abrirModalGerenciarPerfis(); // Recarregar lista
                renderConfig(); // Atualizar select tamb√©m
                if (novoDisplayName && novoDisplayName.length > 0) {
                    mostrarNotificacaoFeedback(`‚úÖ Nome de exibi√ß√£o atualizado para "${novoDisplayName}"`);
                } else {
                    mostrarNotificacaoFeedback(`‚úÖ Nome de exibi√ß√£o removido`);
                }
            }
        };
        
        // PATCH D2: Modal auxiliar para renomear perfil
        window.vrvs_abrirRenomearPerfil = function(perfil) {
            const novoNomeInput = prompt(`Digite o novo nome para o perfil "${perfil}":\n\n(Ser√° convertido para MAI√öSCULO e espa√ßos ser√£o trocados por _)`);
            
            if (novoNomeInput === null) {
                // Usu√°rio cancelou prompt - sair silencioso
                return;
            }
            
            if (!novoNomeInput || !novoNomeInput.trim()) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome do perfil √© obrigat√≥rio', 'error');
                return;
            }
            
            if (window.vrvs_renomearPerfil(perfil, novoNomeInput.trim())) {
                abrirModalGerenciarPerfis(); // Recarregar lista
                renderConfig(); // Atualizar select tamb√©m
            }
        };
        
        // PATCH D2: Renomear perfil (copiar dados para novo nome)
        window.vrvs_renomearPerfil = function(perfilAntigo, novoNomeInput) {
            if (!perfilAntigo || typeof perfilAntigo !== 'string') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Perfil inv√°lido', 'error');
                return false;
            }
            
            // Travas
            if (perfilAntigo === 'DEFAULT') {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o √© poss√≠vel renomear o perfil DEFAULT', 'error');
                return false;
            }
            
            if (window.vrvs_perfilAtivo === perfilAntigo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o √© poss√≠vel renomear o perfil ativo. Troque de perfil primeiro.', 'error');
                return false;
            }
            
            // Normalizar novo nome
            const novoNome = window.vrvs_normalizarNomePerfil(novoNomeInput);
            if (!novoNome) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nome inv√°lido. Use apenas letras, n√∫meros e underscore.', 'error');
                return false;
            }
            
            // Verificar se novo nome j√° existe
            const perfisExistentes = window.vrvs_listarPerfis();
            if (perfisExistentes.includes(novoNome)) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è J√° existe um perfil chamado "${novoNome}"`, 'error');
                return false;
            }
            
            // Copiar dados dos datasets para o novo nome (com rollback seguro)
            const datasets = ['dados', 'historico', 'anotacoes', 'lembretes', 'areas_custom', 'diario'];
            const newKeysCriadas = []; // Rastrear chaves criadas para rollback
            
            for (const baseKey of datasets) {
                const oldKey = window.vrvs_keyOf(perfilAntigo, baseKey);
                const newKey = window.vrvs_keyOf(novoNome, baseKey);
                
                try {
                    const raw = localStorage.getItem(oldKey);
                    if (raw !== null) {
                        // Tentar copiar para novo nome
                        localStorage.setItem(newKey, raw);
                        newKeysCriadas.push(newKey); // Registrar para poss√≠vel rollback
                    }
                } catch(e) {
                    // Se falhar ao copiar qualquer dataset, fazer rollback completo
                    console.error(`[PERFIS D2] Erro ao copiar ${baseKey}:`, e);
                    
                    // Remover TODAS as chaves j√° criadas nesta fun√ß√£o
                    newKeysCriadas.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                        } catch(rollbackErr) {
                            console.warn(`[PERFIS D2] Erro no rollback de ${key}:`, rollbackErr);
                        }
                    });
                    
                    // N√ÉO remover nenhum oldKey (dados originais permanecem intactos)
                    // N√ÉO atualizar lista de perfis
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Falha ao renomear (armazenamento cheio?)', 'error');
                    return false;
                }
            }
            
            // S√≥ chega aqui se TODOS os datasets foram copiados com sucesso
            // Agora remover chaves antigas (best-effort)
            datasets.forEach(baseKey => {
                const oldKey = window.vrvs_keyOf(perfilAntigo, baseKey);
                try {
                    localStorage.removeItem(oldKey);
                } catch(e) {
                    console.warn(`[PERFIS D2] Erro ao remover ${oldKey}:`, e);
                    // N√£o abortar se falhar remover (dados j√° est√£o copiados)
                }
            });
            
            // Atualizar lista de perfis (preservar ordem, substituir antigo por novo)
            const novaLista = perfisExistentes.map(p => p === perfilAntigo ? novoNome : p);
            window.vrvs_salvarListaPerfis(novaLista);
            
            mostrarNotificacaoFeedback(`‚úÖ Perfil "${perfilAntigo}" renomeado para "${novoNome}"`);
            return true;
        };
        
        window.fecharModalGerenciarPerfis = function() {
            const modal = document.getElementById('vrvsModalPerfis');
            if (modal) {
                modal.classList.remove('active');
            }
        };
        
        function vrvs_getConfig() {
            if (window.vrvs_config && typeof window.vrvs_config === 'object') return window.vrvs_config;
            let cfg = {};
            const raw = localStorage.getItem('vrvs_config');
            if (raw) {
                try { cfg = JSON.parse(raw) || {}; } catch(e) { cfg = {}; }
            }
            window.vrvs_config = cfg;
            return cfg;
        }
        
        function vrvs_saveConfig() {
            try {
                localStorage.setItem('vrvs_config', JSON.stringify(window.vrvs_config || {}));
                return true;
            } catch(e) {
                alert('Erro ao salvar configura√ß√£o. Seus dados N√ÉO foram apagados.\n\nDetalhe: ' + (e && e.message ? e.message : e));
                return false;
            }
        }
        
        function vrvs_isDiarioEnabled() {
            // ESCAPE HATCH: Di√°rio sempre vis√≠vel (Config ser√° refeita depois)
            return true;
        }
        
        function vrvs_applyDiarioVisibility() {
            const enabled = vrvs_isDiarioEnabled();
            const tab = document.getElementById('tabDiario');
            if (tab) tab.style.display = enabled ? '' : 'none';
            try { renderTarefas(); } catch(e) {}
        }
        
        function vrvs_setDiarioEnabled(enabled) {
            const cfg = vrvs_getConfig();
            cfg.diario = cfg.diario || {};
            cfg.diario.enabled = !!enabled;
            window.vrvs_config = cfg;
            if (!vrvs_saveConfig()) return;
            vrvs_applyDiarioVisibility();
        }
        
        function toggleDiario(enabled) {
            // ESCAPE HATCH: NO-OP (Di√°rio sempre vis√≠vel, Config ser√° refeita depois)
            return;
        }
        
        function desligarTudoDiario() {
            desmarcarTodasRevisoes();
            try { showSection('config'); } catch(e) {}
        }
        
        function ligarTudoDiario() {
            marcarTodasRevisoes();
        }
        
        function salvarDadosManualmente() {
            try {
                // Salvar todos os dados no localStorage
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                
                mostrarNotificacaoFeedback('‚úÖ Todos os dados salvos com sucesso!');
            } catch (e) {
                mostrarNotificacaoFeedback('‚ùå Erro ao salvar: ' + e.message, 'error');
            }
        }
        
        function dados2CSV(arr) {
            if (arr.length === 0) return '';
            // Uni√£o de todas as chaves para garantir todas as colunas
            const headerSet = new Set();
            arr.forEach(obj => {
                if (obj) Object.keys(obj).forEach(k => headerSet.add(k));
            });
            // Garantir que observacoes e sugestao est√£o sempre presentes
            headerSet.add('observacoes');
            headerSet.add('sugestao');
            const headers = Array.from(headerSet);
            
            const rows = arr.map(obj => headers.map(h => {
                const val = (obj && obj[h] != null) ? obj[h] : '';
                const strVal = String(val);
                // Escapar aspas duplas
                const escaped = strVal.replace(/"/g, '""');
                // Se cont√©m v√≠rgula, quebra de linha ou aspas, precisa estar entre aspas
                if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) {
                    return `"${escaped}"`;
                }
                return escaped;
            }).join(','));
            return [headers.join(','), ...rows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // ==================== NAVEGA√á√ÉO ====================
        
        function showSection(sectionId, evt) {
            if (typeof __vrvsMark === 'function') __vrvsMark(4); // Antes de montar/renderizar a UI principal
            
            // S6-NAV-FIX2: Cancelar RAF pendente da busca ao trocar de aba
            if (window.diarioBuscaRAF !== null) {
                cancelAnimationFrame(window.diarioBuscaRAF);
                window.diarioBuscaRAF = null;
            }
            
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // HOTFIX S6-DIARIO-TRAVA: Marcar aba ativa de forma event-safe (iOS/PWA)
            const e = evt || null;
            const tabEl = (e && e.currentTarget) ? e.currentTarget :
                          (e && e.target && e.target.closest) ? e.target.closest('.tab') :
                          null;
            
            if (tabEl) {
                tabEl.classList.add('active');
            } else {
                // Fallback: encontrar tab pelo onclick (m√≠nimo, sem refactor)
                const fallback = document.querySelector(`.tab[onclick*="showSection('${sectionId}')"]`) ||
                                 document.querySelector(`.tab[onclick*="showSection(\\"${sectionId}\\")"]`);
                if (fallback) fallback.classList.add('active');
            }
            
            // PACOTE A: Atualizar labels de perfil ativo quando abrir aba Backup
            if (sectionId === 'backup') {
                atualizarLabelsPerfilAtivo();
            }
            
            if (sectionId === 'dados') renderDados();
            if (sectionId === 'tarefa') {
                renderTarefas();
            }
            if (sectionId === 'agenda') renderAgendaUnificada();
            if (sectionId === 'stats') updateStats();
            if (sectionId === 'historico') renderHistorico();
            if (sectionId === 'pendencias') renderPendencias();
            if (sectionId === 'caderno') {
                renderCadernoV2();
            }
            if (sectionId === 'diario') {
                // Verificar se Di√°rio est√° habilitado
                if (!vrvs_isDiarioEnabled()) {
                    alert('Di√°rio est√° desabilitado. Ative em Configura√ß√µes para usar.');
                    showSection('config');
                    return;
                }
                
                // Lazy-load: garantir que di√°rio est√° carregado antes de renderizar
                if (!window.diario) {
                    carregarDiario();
                }
                
                // S6-NAV-FIX2: Limpar setTimeout pendente antes de criar novo
                if (window.diarioChipVrvs3pTimeout !== null) {
                    clearTimeout(window.diarioChipVrvs3pTimeout);
                    window.diarioChipVrvs3pTimeout = null;
                }
                
                renderDiario();
                // Atualizar chip VRVS 3P quando abrir aba Di√°rio
                window.diarioChipVrvs3pTimeout = setTimeout(() => {
                    atualizarChipVrvs3p();
                    window.diarioChipVrvs3pTimeout = null; // Limpar ap√≥s executar
                }, 50);
            }
            if (sectionId === 'analises') {
                atualizarSelectsAnalise();
                // Garantir que di√°rio est√° carregado antes de calcular an√°lises
                if (!window.diario) {
                    carregarDiario();
                }
                atualizarAnalises();
            }
            // Novas se√ß√µes consolidadas
            if (sectionId === 'analytics') {
                // Garantir que di√°rio est√° carregado antes de renderizar Analytics
                if (!window.diario) {
                    carregarDiario();
                }
                // Garantir que a vista inicial seja renderizada
                if (!window.vistaAnalytics) window.vistaAnalytics = 'resumo';
                renderAnalytics();
            }
            if (sectionId === 'backup') {
                // Nada especial para renderizar
            }
            if (sectionId === 'mindmaps') {
                mindmaps_renderLista();
            }
            if (sectionId === 'ajuda') {
                renderAjuda();
            }
            if (sectionId === 'config') {
                renderConfig();
            }
        }
        
        // ==================== AN√ÅLISES DETALHADAS ====================
        
        function atualizarSelectsAnalise() {
            // Atualizar select de √°reas usando helper centralizado
            const areaSelect = document.getElementById('analiseFiltroArea');
            const areas = getAreasDisponiveisDoPerfilAtivo();
            areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
            areas.forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
            
            // Atualizar select de temas baseado na √°rea selecionada
            atualizarSelectTemaAnalise();
        }
        
        function atualizarSelectTemaAnalise() {
            const temaSelect = document.getElementById('analiseFiltroTema');
            const areaSelecionada = document.getElementById('analiseFiltroArea').value;
            
            let temasFiltrados = dados.filter(t => t.status !== 'Suspenso');
            if (areaSelecionada) {
                temasFiltrados = temasFiltrados.filter(t => t.area === areaSelecionada);
            }
            
            const temas = [...new Set(temasFiltrados.map(t => `${t.area} - ${t.tema}`))].sort();
            temaSelect.innerHTML = '<option value="">Todos os temas</option>';
            temas.forEach(tema => {
                temaSelect.innerHTML += `<option value="${tema}">${tema}</option>`;
            });
        }
        
        function atualizarAnalises() {
            calcularAnalises();
        }
        
        // Vari√°vel global para controlar visibilidade das an√°lises de tempo
        window.analisesTempoVisiveis = false;
        
        function toggleAnalisesTempo() {
            window.analisesTempoVisiveis = !window.analisesTempoVisiveis;
            const toggleText = document.getElementById('toggleAnalisesTempoText');
            const analiseTempoDiv = document.getElementById('analiseTempo');
            
            if (toggleText) {
                toggleText.textContent = window.analisesTempoVisiveis ? '‚è±Ô∏è Ocultar An√°lises de Tempo' : '‚è±Ô∏è Mostrar An√°lises de Tempo';
            }
            
            if (analiseTempoDiv) {
                analiseTempoDiv.style.display = window.analisesTempoVisiveis ? 'block' : 'none';
            }
            
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function calcularAnalisesTempo() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico (mesma l√≥gica de calcularAnalises)
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseTempo').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">‚è±Ô∏è</div><div>Nenhum dado de tempo encontrado</div></div>';
                return;
            }
            
            // Calcular m√©dias de tempo
            const sessoesComTempo = historicoFiltrado.filter(h => h.tempo && h.tempo > 0);
            const tempoMedioSessao = sessoesComTempo.length > 0
                ? Math.round(sessoesComTempo.reduce((sum, h) => sum + (h.tempo || 0), 0) / sessoesComTempo.length)
                : 0;
            
            // Tempo m√©dio em quest√µes
            const sessoesComTempoQuestoes = historicoFiltrado.filter(h => h.tempoQuestoes && h.tempoQuestoes > 0);
            const tempoMedioQuestoes = sessoesComTempoQuestoes.length > 0
                ? Math.round(sessoesComTempoQuestoes.reduce((sum, h) => sum + (h.tempoQuestoes || 0), 0) / sessoesComTempoQuestoes.length)
                : 0;
            
            // Tempo m√©dio em flashcards
            const sessoesComTempoFlashcards = historicoFiltrado.filter(h => h.tempoFlashcards && h.tempoFlashcards > 0);
            const tempoMedioFlashcards = sessoesComTempoFlashcards.length > 0
                ? Math.round(sessoesComTempoFlashcards.reduce((sum, h) => sum + (h.tempoFlashcards || 0), 0) / sessoesComTempoFlashcards.length)
                : 0;
            
            // M√©dia de intervalos por sess√£o
            const sessoesComIntervalos = historicoFiltrado.filter(h => h.numeroIntervalos && h.numeroIntervalos > 0);
            const mediaIntervalosPorSessao = sessoesComIntervalos.length > 0
                ? (sessoesComIntervalos.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0) / sessoesComIntervalos.length).toFixed(1)
                : '0';
            
            // Tempo m√©dio de cada intervalo
            const intervalosIndividuais = [];
            historicoFiltrado.forEach(h => {
                if (h.intervalos && h.tempoIntervalo && h.numeroIntervalos) {
                    const numIntervalos = parseInt(h.numeroIntervalos) || 0;
                    const tempoTotalIntervalos = parseInt(h.tempoIntervalo) || 0;
                    if (numIntervalos > 0 && tempoTotalIntervalos > 0) {
                        intervalosIndividuais.push(tempoTotalIntervalos / numIntervalos);
                    }
                }
            });
            const tempoMedioIntervalo = intervalosIndividuais.length > 0
                ? Math.round(intervalosIndividuais.reduce((sum, t) => sum + t, 0) / intervalosIndividuais.length)
                : 0;
            
            // Renderizar an√°lises de tempo
            const html = `
                <div style="background: rgba(0,206,209,0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 16px;">‚è±Ô∏è AN√ÅLISES DE TEMPO</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioSessao} min</div>
                            <div class="stat-label">Tempo M√©dio por Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioQuestoes} min</div>
                            <div class="stat-label">Tempo M√©dio em Quest√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioFlashcards} min</div>
                            <div class="stat-label">Tempo M√©dio em Flashcards</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${mediaIntervalosPorSessao}</div>
                            <div class="stat-label">M√©dia de Intervalos/Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioIntervalo} min</div>
                            <div class="stat-label">Tempo M√©dio por Intervalo</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analiseTempo').innerHTML = html;
        }
        
        function calcularAnalises() {
            // Calcular m√©tricas VRVS 3P primeiro (garantir que di√°rio est√° carregado)
            let htmlVrvs3p = '';
            
            // Garantir que window.diario existe (se n√£o, inicializar vazio)
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            // Sempre calcular estat√≠sticas (mesmo se vazio)
            let stats = {};
            try {
                stats = calcularEstatisticasVrvs3p(window.diario, hojeStr()) || {};
            } catch (e) {
                console.error('[VRVS3P] Erro ao calcular estat√≠sticas:', e);
                stats = { totalAtivos: 0, totalHoje: 0, totalAtrasadas: 0 };
            }
            const faixa = (stats && stats.retencaoGlobal !== null && stats.retencaoGlobal !== undefined) ? classificarFaixaRetencao(stats.retencaoGlobal) : 'nenhum';
            const mensagem = mensagemRetencao((stats && stats.retencaoGlobal) ? stats.retencaoGlobal : 0, stats || {});
            
            // Sempre renderizar painel (mesmo se vazio)
            htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card" style="background: rgba(0,206,209,0.05); border: 1px solid rgba(0,206,209,0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 18px; font-weight: 600;">üß† Sa√∫de do Di√°rio VRVS 3P</h3>
                        
                        ${stats.totalAtivos > 0 ? `
                            <div class="vrvs3p-saude-bloco">
                                ${stats.totalRevisados > 0 ? `
                                <div class="vrvs3p-progress-wrapper" style="margin-bottom: 20px;">
                                    <div class="vrvs3p-progress-bar" style="width: 100%; height: 24px; background: rgba(5,25,30,0.8); border-radius: 12px; overflow: hidden; position: relative;">
                                        <div class="vrvs3p-progress-fill vrvs3p-progress-fill--${faixa}" style="width: ${stats.retencaoGlobalPct}%; height: 100%; background: ${faixa === 'alta' ? 'linear-gradient(90deg, #22c55e, #16a34a)' : faixa === 'media' ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 'linear-gradient(90deg, #dc3545, #b91c1c)'}; transition: width 0.3s ease;"></div>
                                    </div>
                                    <div class="vrvs3p-progress-label" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                        <span class="vrvs3p-progress-percent" style="font-size: 16px; font-weight: 600; color: var(--turquesa-light);">${stats.retencaoGlobalPct}%</span>
                                        <span class="vrvs3p-progress-status" style="font-size: 13px; color: rgba(255,255,255,0.7);">‚Ä¢ ${faixa === 'alta' ? 'Alta' : faixa === 'media' ? 'M√©dia' : 'Baixa'}</span>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="vrvs3p-contagem-linha" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; font-size: 13px; color: rgba(255,255,255,0.8);">
                                    ${stats.totalRevisados > 0 ? `<span><strong style="color: var(--turquesa-light);">${stats.totalRevisados}</strong> revisados</span>` : ''}
                                    ${stats.totalNovos > 0 ? `<span>‚Ä¢ <strong style="color: var(--turquesa-light);">${stats.totalNovos}</strong> novos</span>` : ''}
                                    <span>‚Ä¢ <strong style="color: var(--cobre-light);">${stats.totalHoje}</strong> para revisar hoje</span>
                                    ${stats.totalAtrasadas > 0 ? `<span>‚Ä¢ <strong style="color: #dc3545">${stats.totalAtrasadas}</strong> atrasados</span>` : ''}
                                </div>
                                
                                ${stats.totalRevisados === 0 ? `
                                <div class="vrvs3p-mensagem" style="padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border-left: 3px solid var(--turquesa-light); font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 20px;">
                                    Sem revis√µes ainda ‚Äî ${stats.totalNovos} novos aguardando 1¬™ revis√£o
                                </div>
                                ` : `
                                
                                <div class="vrvs3p-mensagem" style="padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border-left: 3px solid var(--turquesa-light); font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 20px;">
                                    ${(mensagem && typeof mensagem === 'object' && mensagem.emoji && mensagem.texto) ? `${mensagem.emoji} ${mensagem.texto}` : (mensagem || '')}
                                </div>
                                `}
                            </div>
                            
                            ${stats.porArea.length > 0 ? `
                                <div class="vrvs3p-subpainel" style="margin-top: 24px;">
                                    <h4 style="color: var(--turquesa-light); margin-bottom: 16px; font-size: 15px; font-weight: 600;">üìä Reten√ß√£o por √°rea</h4>
                                    <ul class="vrvs3p-area-lista" style="list-style: none; padding: 0; margin: 0;">
                                        ${stats.porArea.map(item => {
                                            const faixaArea = classificarFaixaRetencao(item.retencao);
                                            const corBarra = faixaArea === 'alta' ? '#22c55e' : faixaArea === 'media' ? '#f59e0b' : '#dc3545';
                                            const emoji = faixaArea === 'alta' ? 'üü¢' : faixaArea === 'media' ? 'üü°' : 'üî¥';
                                            return `
                                                <li style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(0,206,209,0.1);">
                                                    <span style="flex: 0 0 140px; font-size: 13px; color: rgba(255,255,255,0.9);">${item.area}</span>
                                                    <div style="flex: 1; height: 20px; background: rgba(5,25,30,0.8); border-radius: 10px; overflow: hidden; position: relative;">
                                                        <div style="width: ${item.retencaoPct}%; height: 100%; background: ${corBarra}; transition: width 0.3s ease;"></div>
                                                    </div>
                                                    <span style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9);">${item.retencaoPct}%</span>
                                                    <span style="flex: 0 0 30px; text-align: center; font-size: 14px;">${emoji}</span>
                                                </li>
                                            `;
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="vrvs3p-maturidade" style="margin-top: 24px;">
                                <h4 style="color: var(--turquesa-light); margin-bottom: 16px; font-size: 15px; font-weight: 600;">üìà Maturidade dos t√≥picos</h4>
                                <div class="vrvs3p-maturidade-barra" style="display: flex; height: 32px; border-radius: 8px; overflow: hidden; margin-bottom: 12px;">
                                    ${stats.maturidade.novos > 0 ? `<div style="flex: ${stats.maturidade.novos}; background: linear-gradient(90deg, #dc3545, #b91c1c); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.novos}</div>` : ''}
                                    ${stats.maturidade.fixando > 0 ? `<div style="flex: ${stats.maturidade.fixando}; background: linear-gradient(90deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.fixando}</div>` : ''}
                                    ${stats.maturidade.maduros > 0 ? `<div style="flex: ${stats.maturidade.maduros}; background: linear-gradient(90deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.maduros}</div>` : ''}
                                    ${stats.maturidade.consolidados > 0 ? `<div style="flex: ${stats.maturidade.consolidados}; background: linear-gradient(90deg, #059669, #047857); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${stats.maturidade.consolidados}</div>` : ''}
                                </div>
                                <div class="vrvs3p-maturidade-legenda" style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: rgba(255,255,255,0.7);">
                                    ${stats.maturidade.novos > 0 ? `<span>üî¥ ${stats.maturidade.novos} novos</span>` : ''}
                                    ${stats.maturidade.fixando > 0 ? `<span>üü° ${stats.maturidade.fixando} fixando</span>` : ''}
                                    ${stats.maturidade.maduros > 0 ? `<span>üü¢ ${stats.maturidade.maduros} maduros</span>` : ''}
                                    ${stats.maturidade.consolidados > 0 ? `<span>üíé ${stats.maturidade.consolidados} consolidados</span>` : ''}
                                </div>
                                <p style="margin-top: 12px; font-size: 11px; color: rgba(255,255,255,0.5); font-style: italic;">
                                    üéØ Meta: migrar t√≥picos para est√°gios mais altos ao longo das semanas.
                                </p>
                            </div>
                            
                            <p class="vrvs3p-disclaimer" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(0,206,209,0.2); font-size: 11px; color: rgba(255,255,255,0.5); font-style: italic; text-align: center;">
                                Estimativa baseada no modelo VRVS 3P. N√£o √© nota ‚Äî √© um mapa para orientar seu esfor√ßo.
                            </p>
                        ` : `
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üìî</div>
                                <div style="font-size: 15px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">Nenhum t√≥pico ativo</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Cadastre entradas pelo Di√°rio e marque "Incluir nas revis√µes programadas"</div>
                            </div>
                        `}
                    </section>
                `;
            
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                // Filtrar por √°rea
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                // Filtrar por tema
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                // Filtrar por per√≠odo
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            // Sempre inserir painel VRVS 3P, mesmo se n√£o houver hist√≥rico
            const resultadosContainer = document.getElementById('analiseResultados');
            if (!resultadosContainer) return;
            
            if (historicoFiltrado.length === 0) {
                resultadosContainer.innerHTML = htmlVrvs3p + '<div class="empty-state"><div class="empty-icon">üìä</div><div>Nenhum dado encontrado para os filtros selecionados</div></div>';
                return;
            }
            
            // Calcular estat√≠sticas
            const totalSessoes = historicoFiltrado.length;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoFiltrado.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            const totalMinutos = historicoFiltrado.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            const totalMinutosResto = totalMinutos % 60;
            
            // Calcular quest√µes
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            const taxaAcertoQuestoes = totalQuestoesTotal > 0 
                ? Math.round((totalQuestoesAcertos / totalQuestoesTotal) * 100)
                : 0;
            
            // Calcular flashcards
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            // Calcular intervalos
            const totalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0);
            const tempoTotalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.tempoIntervalo) || 0), 0);
            
            // Agrupar por √°rea (se n√£o filtrado por √°rea espec√≠fica)
            let porArea = {};
            if (!areaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema && tema.area) {
                        if (!porArea[tema.area]) {
                            porArea[tema.area] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porArea[tema.area].sessoes++;
                        porArea[tema.area].tempo += h.tempo || 0;
                        porArea[tema.area].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porArea[tema.area].questoes.acertos += parseInt(match[1]);
                                porArea[tema.area].questoes.total += parseInt(match[2]);
                            }
                        }
                        porArea[tema.area].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porArea).forEach(area => {
                    porArea[area].rendimento = porArea[area].sessoes > 0 
                        ? Math.round((porArea[area].rendimento / porArea[area].sessoes) * 100)
                        : 0;
                    porArea[area].tempoHoras = Math.round(porArea[area].tempo / 60);
                });
            }
            
            // Agrupar por tema (se n√£o filtrado por tema espec√≠fico)
            let porTema = {};
            if (!temaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema) {
                        const temaKey = `${tema.area} - ${tema.tema}`;
                        if (!porTema[temaKey]) {
                            porTema[temaKey] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porTema[temaKey].sessoes++;
                        porTema[temaKey].tempo += h.tempo || 0;
                        porTema[temaKey].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porTema[temaKey].questoes.acertos += parseInt(match[1]);
                                porTema[temaKey].questoes.total += parseInt(match[2]);
                            }
                        }
                        porTema[temaKey].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porTema).forEach(temaKey => {
                    porTema[temaKey].rendimento = porTema[temaKey].sessoes > 0 
                        ? Math.round((porTema[temaKey].rendimento / porTema[temaKey].sessoes) * 100)
                        : 0;
                    porTema[temaKey].tempoHoras = Math.round(porTema[temaKey].tempo / 60);
                });
            }
            
            // Renderizar resultados
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHoras}h${totalMinutosResto > 0 ? ' ' + totalMinutosResto + 'm' : ''}</div>
                        <div class="stat-label">Tempo Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoesTotal > 0 ? totalQuestoesAcertos + '/' + totalQuestoesTotal : '0'}</div>
                        <div class="stat-label">Quest√µes (${taxaAcertoQuestoes}% acerto)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalIntervalos}</div>
                        <div class="stat-label">Intervalos (${Math.round(tempoTotalIntervalos)} min)</div>
                    </div>
                </div>
            `;
            
            // Detalhamento por √°rea (com temas colaps√°veis)
            if (!areaFiltro && Object.keys(porArea).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìä Detalhamento por √Årea:</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th style="width: 30px;"></th><th>√Årea</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porArea).sort().forEach((area, index) => {
                    const stats = porArea[area];
                    const temasDaArea = Object.keys(porTema).filter(t => t.startsWith(area + ' - '));
                    
                    html += '<tr style="background: rgba(0,206,209,0.15); cursor: pointer;" onclick="toggleTemasArea(\'' + area.replace(/'/g, "\\'") + '\')">';
                    html += `<td style="text-align: center; color: var(--turquesa-light); font-weight: bold;">${temasDaArea.length > 0 ? '‚ñ∂' : ''}</td>`;
                    html += `<td><strong style="color: var(--turquesa-light);">${area}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                    
                    // Temas da √°rea (inicialmente ocultos)
                    if (temasDaArea.length > 0) {
                        html += `<tr id="temas-${area.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: none;">`;
                        html += '<td colspan="7" style="padding: 0; background: rgba(0,0,0,0.3);">';
                        html += '<table style="width: 100%; margin: 0;"><tbody>';
                        
                        temasDaArea.forEach(temaKey => {
                            const temaStats = porTema[temaKey];
                            const temaNome = temaKey.replace(area + ' - ', '');
                            html += '<tr style="border-top: 1px solid rgba(0,206,209,0.2);">';
                            html += `<td style="padding-left: 40px; color: rgba(0,206,209,0.8); font-weight: 500;">${temaNome}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.sessoes}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.tempoHoras}h</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.rendimento}%</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.questoes.total > 0 ? temaStats.questoes.acertos + '/' + temaStats.questoes.total + ' (' + Math.round((temaStats.questoes.acertos / temaStats.questoes.total) * 100) + '%)' : '-'}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.flashcards > 0 ? temaStats.flashcards.toLocaleString() : '-'}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></td></tr>';
                    }
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema (apenas quando filtrar por √°rea espec√≠fica)
            if (areaFiltro && !temaFiltro && Object.keys(porTema).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìö Temas da √Årea "' + areaFiltro + '":</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th>Tema</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porTema).filter(t => t.startsWith(areaFiltro + ' - ')).sort().forEach(temaKey => {
                    const stats = porTema[temaKey];
                    const temaNome = temaKey.replace(areaFiltro + ' - ', '');
                    html += '<tr>';
                    html += `<td><strong style="color: var(--turquesa-light);">${temaNome}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema quando filtrado por tema espec√≠fico (n√£o mostrar, j√° est√° no resumo geral)
            
            // Inserir painel VRVS 3P no topo dos resultados
            document.getElementById('analiseResultados').innerHTML = htmlVrvs3p + html;
            
            // Se an√°lises de tempo est√£o vis√≠veis, recalcular
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function filtrarAnaliseSemanaAtual() {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            
            document.getElementById('analiseDataInicio').value = inicioSemana.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimSemana.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function filtrarAnaliseMesAtual() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('analiseDataInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimMes.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function limparFiltrosAnalise() {
            document.getElementById('analiseFiltroArea').value = '';
            document.getElementById('analiseFiltroTema').value = '';
            document.getElementById('analiseDataInicio').value = '';
            document.getElementById('analiseDataFim').value = '';
            atualizarSelectsAnalise();
            atualizarAnalises();
        }
        
        // Fun√ß√£o para expandir/colapsar temas de uma √°rea
        function toggleTemasArea(area) {
            const areaId = 'temas-' + area.replace(/[^a-zA-Z0-9]/g, '-');
            const row = document.getElementById(areaId);
            if (!row) return;
            
            const isVisible = row.style.display !== 'none';
            row.style.display = isVisible ? 'none' : 'table-row';
            
            // Atualizar √≠cone
            const areaRow = row.previousElementSibling;
            if (areaRow) {
                const iconCell = areaRow.querySelector('td:first-child');
                if (iconCell) {
                    iconCell.textContent = isVisible ? '‚ñ∂' : '‚ñº';
                }
            }
        }
        
        // ==================== CRON√îMETRO DA SESS√ÉO ====================
        
        let cronometroInterval = null;
        let cronometroSegundos = 0;
        let cronometroRodando = false;
        let intervaloAtivo = false;
        let intervaloSegundos = 0;
        let intervaloInterval = null;
        let tempoTotalIntervalo = 0; // Tempo total de intervalo acumulado (n√£o conta no estudo)
        let cronometroInicioTimestamp = null; // Timestamp de quando o cron√¥metro foi iniciado (para rodar em segundo plano)
        let intervalosIndividuais = []; // Array para armazenar cada intervalo individualmente [{tempo: segundos, inicio: timestamp}, ...]
        let intervaloInicioTimestamp = null; // Timestamp de quando o intervalo atual come√ßou
        
        // Restaurar cron√¥metro do localStorage se existir
        function restaurarCronometro() {
            const salvo = localStorage.getItem('vrvs_cronometro');
            if (salvo) {
                try {
                    const dados = JSON.parse(salvo);
                    if (dados.timestamp) {
                        // Calcular tempo decorrido desde que foi salvo (BASEADO EM TIMESTAMP)
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - dados.timestamp) / 1000);
                        
                        // Atualizar valores
                        cronometroSegundos = dados.segundos + tempoDecorrido;
                        tempoTotalIntervalo = dados.tempoIntervalo || 0;
                        intervalosIndividuais = dados.intervalosIndividuais || []; // Restaurar intervalos individuais
                        intervaloInicioTimestamp = dados.intervaloInicioTimestamp || null;
                        
                        // Se estava em intervalo, restaurar estado do intervalo
                        if (dados.intervaloAtivo) {
                            intervaloAtivo = true;
                            intervaloSegundos = dados.intervaloSegundos + tempoDecorrido;
                            document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                            document.getElementById('tempoIntervalo').style.display = 'block';
                            document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                            
                            // Reiniciar intervalo timer
                            if (intervaloInterval) {
                                clearInterval(intervaloInterval);
                            }
                            intervaloInterval = setInterval(() => {
                                intervaloSegundos++;
                                document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                            }, 1000);
                        }
                        
                        // Se estava rodando, reiniciar contagem COM TIMESTAMP PRECISO
                        if (dados.rodando && !cronometroRodando) {
                            cronometroRodando = true;
                            cronometroInicioTimestamp = dados.timestamp; // Usar timestamp original
                            localStorage.setItem('vrvs_cronometro_timestamp', String(dados.timestamp));
                            localStorage.setItem('vrvs_cronometro_segundos', String(dados.segundos));
                            iniciarCronometroContagem();
                            document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                        }
                        
                        atualizarDisplayCronometro();
                    }
                } catch (e) {
                    console.log('Erro ao restaurar cron√¥metro:', e);
                }
            }
        }
        
        // Salvar estado do cron√¥metro
        function salvarEstadoCronometro() {
            if (cronometroRodando || intervaloAtivo) {
                // CR√çTICO: Salvar timestamp original, n√£o atualizar
                const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                
                localStorage.setItem('vrvs_cronometro', JSON.stringify({
                    rodando: cronometroRodando,
                    segundos: segundosOriginais ? parseInt(segundosOriginais) : cronometroSegundos,
                    timestamp: timestampOriginal ? parseInt(timestampOriginal) : cronometroInicioTimestamp || Date.now(),
                    tempoIntervalo: tempoTotalIntervalo,
                    intervaloAtivo: intervaloAtivo,
                    intervaloSegundos: intervaloSegundos,
                    intervalosIndividuais: intervalosIndividuais, // Salvar array de intervalos individuais
                    intervaloInicioTimestamp: intervaloInicioTimestamp
                }));
            } else {
                localStorage.removeItem('vrvs_cronometro');
            }
        }
        
        // Iniciar contagem do cron√¥metro
        function iniciarCronometroContagem() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            
            // CR√çTICO: Manter timestamp original se j√° existe, sen√£o criar novo
            let timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
            let segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
            
            if (!timestampOriginal) {
                // Primeira vez iniciando
                cronometroInicioTimestamp = Date.now();
                timestampOriginal = String(cronometroInicioTimestamp);
                segundosOriginais = String(cronometroSegundos);
            } else {
                // Continuando contagem - usar timestamp original
                cronometroInicioTimestamp = parseInt(timestampOriginal);
            }
            
            // Salvar no localStorage
            localStorage.setItem('vrvs_cronometro_timestamp', timestampOriginal);
            localStorage.setItem('vrvs_cronometro_segundos', segundosOriginais);
            
            // Atualizar display periodicamente (mas c√°lculo sempre baseado em timestamp)
            cronometroInterval = setInterval(() => {
                atualizarDisplayCronometro();
            }, 100); // Atualizar a cada 100ms para maior precis√£o visual
            
            cronometroRodando = true;
            salvarEstadoCronometro();
        }
        
        // Fun√ß√£o para calcular tempo decorrido baseado em timestamp (n√£o depende de intervalos)
        function calcularTempoDecorrido() {
            const timestampSalvo = localStorage.getItem('vrvs_cronometro_timestamp');
            const segundosSalvos = parseInt(localStorage.getItem('vrvs_cronometro_segundos') || '0');
            
            if (timestampSalvo && cronometroRodando) {
                const agora = Date.now();
                const tempoDecorrido = Math.floor((agora - parseInt(timestampSalvo)) / 1000);
                return segundosSalvos + tempoDecorrido;
            }
            return cronometroSegundos;
        }
        
        function formatarTempoCronometro(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }
        
        function formatarIntervaloMinutos(segundos) {
            const minutos = Math.floor(segundos / 60);
            return minutos > 0 ? `${minutos} min` : '0 min';
        }
        
        function atualizarDisplayCronometro() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando
            if (cronometroRodando) {
                cronometroSegundos = calcularTempoDecorrido();
            }
            
            document.getElementById('cronometroDisplay').textContent = formatarTempoCronometro(cronometroSegundos);
            // Atualizar display de tempo total de intervalo acumulado
            if (tempoTotalIntervalo > 0) {
                document.getElementById('tempoIntervaloTotal').style.display = 'block';
                document.getElementById('tempoIntervaloTotalDisplay').textContent = formatarIntervaloMinutos(tempoTotalIntervalo);
            } else {
                document.getElementById('tempoIntervaloTotal').style.display = 'none';
            }
        }
        
        function toggleCronometro() {
            if (intervaloAtivo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Termine o intervalo primeiro!', 'error');
                return;
            }
            
            if (cronometroRodando) {
                // Pausar - calcular tempo final baseado em timestamp
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                
                // Calcular tempo final preciso
                cronometroSegundos = calcularTempoDecorrido();
                
                cronometroRodando = false;
                cronometroInicioTimestamp = null;
                localStorage.removeItem('vrvs_cronometro_timestamp');
                
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                salvarEstadoCronometro();
                atualizarDisplayCronometro();
            } else {
                // Iniciar - salvar timestamp preciso
                cronometroInicioTimestamp = Date.now();
                localStorage.setItem('vrvs_cronometro_timestamp', String(cronometroInicioTimestamp));
                localStorage.setItem('vrvs_cronometro_segundos', String(cronometroSegundos));
                
                iniciarCronometroContagem();
                document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        }
        
        function pausarCronometro() {
            if (cronometroRodando) {
                toggleCronometro();
            }
        }
        
        function iniciarIntervalo() {
            if (!cronometroRodando && cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Inicie o cron√¥metro primeiro!', 'error');
                return;
            }
            
            if (intervaloAtivo) {
                // Finalizar intervalo - calcular tempo baseado em timestamp e salvar individualmente
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                // Calcular tempo preciso do intervalo baseado em timestamp
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                // Salvar intervalo individual
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal; // Acumular tempo de intervalo
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
                
                document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'none';
                atualizarDisplayCronometro(); // Atualizar display com tempo acumulado
                salvarEstadoCronometro(); // Salvar estado atualizado
                mostrarNotificacaoFeedback(`‚úÖ Intervalo finalizado (${formatarTempoCronometro(tempoIntervaloFinal)} - Total: ${formatarTempoCronometro(tempoTotalIntervalo)})`);
            } else {
                // Iniciar intervalo (pausa o cron√¥metro mas n√£o conta)
                intervaloAtivo = true;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = Date.now(); // Salvar timestamp de in√≠cio do intervalo
                
                document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'block';
                
                intervaloInterval = setInterval(() => {
                    // Calcular baseado em timestamp para maior precis√£o
                    if (intervaloInicioTimestamp) {
                        const agora = Date.now();
                        intervaloSegundos = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                    } else {
                        intervaloSegundos++;
                    }
                    document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                }, 100);
                
                // Pausar cron√¥metro durante intervalo
                if (cronometroRodando) {
                    clearInterval(cronometroInterval);
                    cronometroInterval = null;
                    cronometroRodando = false;
                    document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                }
                
                salvarEstadoCronometro(); // Salvar estado quando inicia intervalo
            }
        }
        
        function resetCronometro() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
            }
            if (intervaloInterval) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
            }
            cronometroRodando = false;
            intervaloAtivo = false;
            cronometroSegundos = 0;
            intervaloSegundos = 0;
            tempoTotalIntervalo = 0; // Resetar tempo total de intervalo
            intervalosIndividuais = []; // Resetar array de intervalos individuais
            intervaloInicioTimestamp = null;
            cronometroInicioTimestamp = null;
            atualizarDisplayCronometro();
            document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
            document.getElementById('tempoIntervalo').style.display = 'none';
            localStorage.removeItem('vrvs_cronometro'); // Limpar do localStorage
            localStorage.removeItem('vrvs_cronometro_timestamp');
            localStorage.removeItem('vrvs_cronometro_segundos');
        }
        
        // Fun√ß√£o para encerrar sess√£o e mostrar modal
        function encerrarSessao() {
            // Pausar cron√¥metro se estiver rodando para calcular tempo final preciso
            if (cronometroRodando) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                cronometroSegundos = calcularTempoDecorrido();
                cronometroRodando = false;
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            }
            
            // Finalizar intervalo ativo se houver
            if (intervaloAtivo) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal;
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
            }
            
            if (cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è O cron√¥metro n√£o est√° rodando!', 'error');
                return;
            }
            
            // Preencher dados do modal
            document.getElementById('modalTempoTotal').textContent = formatarTempoCronometro(cronometroSegundos);
            document.getElementById('modalNumIntervalos').textContent = intervalosIndividuais.length;
            document.getElementById('modalTempoIntervalos').textContent = formatarIntervaloMinutos(tempoTotalIntervalo);
            
            // Limpar campos do modal
            document.getElementById('modalTempoQuestoes').value = '';
            document.getElementById('modalQuantQuestoes').value = '';
            document.getElementById('modalTempoFlashcards').value = '';
            document.getElementById('modalQuantFlashcards').value = '';
            
            // CORRE√á√ÉO: Tentar ler valores dos campos de tempo da tarefa ativa (se houver)
            const temaAtivo = document.getElementById('feedbackTema').value;
            if (temaAtivo) {
                const camposTempo = document.querySelector(`.campos-tempo[data-tema-id="${temaAtivo}"]`);
                if (camposTempo) {
                    const tempoQuestoesInput = camposTempo.querySelector('.tempo-questoes');
                    const quantQuestoesInput = camposTempo.querySelector('.quant-questoes');
                    const tempoFlashcardsInput = camposTempo.querySelector('.tempo-flashcards');
                    const quantFlashcardsInput = camposTempo.querySelector('.quant-flashcards');
                    
                    if (tempoQuestoesInput && tempoQuestoesInput.value) {
                        document.getElementById('modalTempoQuestoes').value = tempoQuestoesInput.value;
                    }
                    if (quantQuestoesInput && quantQuestoesInput.value) {
                        document.getElementById('modalQuantQuestoes').value = quantQuestoesInput.value;
                    }
                    if (tempoFlashcardsInput && tempoFlashcardsInput.value) {
                        document.getElementById('modalTempoFlashcards').value = tempoFlashcardsInput.value;
                    }
                    if (quantFlashcardsInput && quantFlashcardsInput.value) {
                        document.getElementById('modalQuantFlashcards').value = quantFlashcardsInput.value;
                    }
                }
            }
            
            // Mostrar modal
            document.getElementById('encerrarSessaoModal').classList.add('active');
        }
        
        function closeEncerrarSessaoModal() {
            document.getElementById('encerrarSessaoModal').classList.remove('active');
        }
        
        function preencherDadosSessao() {
            const tempoQuestoes = parseInt(document.getElementById('modalTempoQuestoes').value) || 0;
            const quantQuestoes = parseInt(document.getElementById('modalQuantQuestoes').value) || 0;
            const tempoFlashcards = parseInt(document.getElementById('modalTempoFlashcards').value) || 0;
            const quantFlashcards = parseInt(document.getElementById('modalQuantFlashcards').value) || 0;
            
            // Preencher campos do formul√°rio
            const tempoTotal = tempoQuestoes + tempoFlashcards;
            if (tempoTotal > 0) {
                document.getElementById('feedbackTempo').value = tempoTotal;
            }
            
            // Preencher quest√µes (formato: acertos/total)
            if (quantQuestoes > 0) {
                document.getElementById('feedbackQuestoes').value = quantQuestoes + '/' + quantQuestoes;
            }
            
            // Preencher flashcards
            if (quantFlashcards > 0) {
                document.getElementById('feedbackFlashcards').value = quantFlashcards;
            }
            
            // Preencher intervalo se houver
            const numeroIntervalos = intervalosIndividuais.length;
            if (numeroIntervalos > 0) {
                const temposIntervalos = intervalosIndividuais.map(i => formatarTempoCronometro(i.tempo)).join(', ');
                document.getElementById('feedbackNumeroIntervalos').value = numeroIntervalos;
                document.getElementById('feedbackIntervalos').value = temposIntervalos;
            }
            
            // Guardar valores no modal para uso posterior (atrav√©s de atributos data)
            const modal = document.getElementById('encerrarSessaoModal');
            modal.dataset.tempoQuestoes = tempoQuestoes;
            modal.dataset.quantQuestoes = quantQuestoes;
            modal.dataset.tempoFlashcards = tempoFlashcards;
            modal.dataset.quantFlashcards = quantFlashcards;
            
            // Fechar modal
            closeEncerrarSessaoModal();
            
            // Scroll para o formul√°rio
            document.getElementById('feedbackForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function obterTempoCronometroMinutos() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando (n√£o depende de intervalos)
            const segundosPrecisos = cronometroRodando ? calcularTempoDecorrido() : cronometroSegundos;
            return Math.floor(segundosPrecisos / 60);
        }
        
        function obterTempoIntervaloMinutos() {
            return Math.floor(tempoTotalIntervalo / 60);
        }
        
        // ==================== LEMBRETES E ANOTA√á√ïES ====================
        
        function calcularProximaDataLembrete(lembrete) {
            if (lembrete.periodicidade === 'pontual') {
                return null; // N√£o tem pr√≥xima data
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const dataInicial = new Date(lembrete.dataInicial + 'T00:00:00');
            const ultimaData = lembrete.ultimaData ? new Date(lembrete.ultimaData + 'T00:00:00') : dataInicial;
            
            let proximaData = new Date(ultimaData);
            
            switch(lembrete.periodicidade) {
                case 'diaria':
                    proximaData.setDate(proximaData.getDate() + 1);
                    break;
                case 'semanal':
                    proximaData.setDate(proximaData.getDate() + 7);
                    break;
                case 'quinzenal':
                    proximaData.setDate(proximaData.getDate() + 15);
                    break;
                case 'mensal':
                    proximaData.setMonth(proximaData.getMonth() + 1);
                    break;
            }
            
            return proximaData.toISOString().split('T')[0];
        }
        
        function renderLembretes() {
            const container = document.getElementById('lembretesContainer');
            if (!container) return;
            
            const hoje = obterYMDLocal();
            
            // Separar lembretes ativos e conclu√≠dos
            const lembretesAtivos = lembretes.filter(l => !l.concluido && (!l.proximaData || l.proximaData <= hoje));
            const lembretesFuturos = lembretes.filter(l => !l.concluido && l.proximaData && l.proximaData > hoje);
            const lembretesConcluidos = lembretes.filter(l => l.concluido);
            
            if (lembretes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìå</div><div>Nenhum lembrete cadastrado</div></div>';
                return;
            }
            
            let html = '';
            
            // Lembretes ativos (para hoje)
            if (lembretesAtivos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: var(--turquesa-light); margin-bottom: 10px;">üìå Para Hoje</h3>';
                html += lembretesAtivos.map(l => {
                    const proximaDataFormatada = l.proximaData ? formatarData(l.proximaData) : 'Pontual';
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade === 'pontual' ? 'Pontual' : l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.periodicidade !== 'pontual' ? `<button class="btn-edit" onclick="marcarLembreteConcluido(${l.id})" title="Marcar como conclu√≠do">‚úÖ</button>` : ''}
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes futuros
            if (lembretesFuturos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ Pr√≥ximos</h3>';
                html += lembretesFuturos.map(l => {
                    const proximaDataFormatada = formatarData(l.proximaData);
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes conclu√≠dos (opcional, pode ser ocultado)
            if (lembretesConcluidos.length > 0 && false) { // Desabilitado por enquanto
                html += '<div><h3 style="color: rgba(255,255,255,0.3); margin-bottom: 10px;">‚úÖ Conclu√≠dos</h3>';
                html += lembretesConcluidos.map(l => {
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.5;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="text-decoration: line-through; color: rgba(255,255,255,0.3);">${l.titulo}</div>
                                </div>
                                <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function marcarLembreteConcluido(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            
            if (lembrete.periodicidade === 'pontual') {
                lembrete.concluido = true;
            } else {
                // Atualizar √∫ltima data e calcular pr√≥xima
                const hoje = obterYMDLocal();
                lembrete.ultimaData = hoje;
                lembrete.proximaData = calcularProximaDataLembrete(lembrete);
            }
            
            localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('‚úÖ Lembrete atualizado!');
        }
        
        function deletarLembrete(id) {
            if (!confirm('Tem certeza que deseja deletar este lembrete?')) return;
            
            lembretes = lembretes.filter(l => l.id !== id);
            localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('üóëÔ∏è Lembrete deletado!');
        }
        
        // ==================== CADERNO DE ANOTA√á√ïES ====================
        
        function migrarAnotacoesParaHotTopics() {
            // Migra√ß√£o segura: adicionar campo hotTopics sem perder dados
            // S3P: Removido backup autom√°tico do boot (causava QUOTA loop no iPhone PWA)
            // Backup deve ser manual via aba Backup. Migra√ß√£o √© idempotente e segura sem backup.
            const anotacoesAtuais = JSON.parse(localStorage.getItem(window.vrvs_key('anotacoes')) || '[]');
            
            let atualizadas = false;
            const anotacoesMigradas = anotacoesAtuais.map(a => {
                if (a.hotTopics === undefined) {
                    a.hotTopics = ''; // Campo novo, vazio por padr√£o
                    atualizadas = true;
                }
                return a;
            });
            
            if (atualizadas) {
                validarAntesDeSalvar('anotacoes', anotacoesMigradas);
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoesMigradas));
                anotacoes = anotacoesMigradas;
                console.log(`[MIGRA√á√ÉO] Campo hotTopics adicionado.`);
            }
        }
        
        function obterOuCriarAnotacao(temaId) {
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (!anotacao) {
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) return null;
                
                anotacao = {
                    id: Date.now(),
                    temaId: temaId,
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    hotTopics: '', // Campo novo
                    ultimaAtualizacao: new Date().toISOString().split('T')[0]
                };
                anotacoes.push(anotacao);
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
            }
            return anotacao;
        }
        
        function navegarParaAnotacao(temaId) {
            // Criar anota√ß√£o se n√£o existir
            obterOuCriarAnotacao(temaId);
            
            // Encontrar a √°rea do tema
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            // Filtrar caderno para mostrar apenas a √°rea do tema
            const filtroArea = document.getElementById('cadernoFiltroArea');
            if (filtroArea) {
                filtroArea.value = tema.area;
            }
            
            // Mostrar se√ß√£o caderno primeiro
            showSection('caderno');
            
            // Renderizar caderno filtrado (renderCadernoV2 n√£o depende de cadernoFiltroTema)
            setTimeout(() => {
                renderCadernoV2();
                
                // Scroll para anota√ß√£o ap√≥s renderizar
            setTimeout(() => {
                const elemento = document.querySelector(`[data-tema-id="${temaId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    elemento.style.background = 'rgba(0,206,209,0.2)';
                    setTimeout(() => {
                        elemento.style.background = '';
                    }, 2000);
                }
                }, 300);
            }, 100);
        }
        
        function atualizarSelectsLembrete() {
            const select = document.getElementById('lembreteTemaId');
            if (!select) return;
            
            select.innerHTML = '<option value="">Nenhum (lembrete geral)</option>';
            
            dados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.area} - ${t.tema}`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectsCaderno() {
            const selectArea = document.getElementById('cadernoFiltroArea');
            const selectTema = document.getElementById('cadernoFiltroTema');
            
            if (selectArea) {
                // Usar helper centralizado para obter todas as √°reas dispon√≠veis
                const areas = getAreasDisponiveisDoPerfilAtivo();
                selectArea.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    selectArea.appendChild(option);
                });
            }
            
            // Resetar select de tema para desabilitado
            if (selectTema) {
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
            }
        }
        
        function atualizarSelectTemaPorArea() {
            const selectTema = document.getElementById('cadernoFiltroTema');
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            if (!selectTema) return;
            
            if (!filtroArea) {
                // Se n√£o h√° √°rea selecionada, desabilitar select de tema
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
                return;
            }
            
            // Habilitar e popular com temas da √°rea selecionada
            selectTema.disabled = false;
            selectTema.innerHTML = '<option value="">Todos os temas desta √°rea</option>';
            
            const temasFiltrados = dados.filter(t => t.area === filtroArea);
            
            temasFiltrados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.tema; // Mostrar apenas o nome do tema, sem repetir √°rea
                selectTema.appendChild(option);
            });
        }
        
        function filtrarCaderno() {
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            
            renderCaderno(filtroArea, filtroTema);
        }
        
        function renderCaderno(filtroArea = '', filtroTema = '') {
            const container = document.getElementById('cadernoContainer');
            if (!container) return;
            
            // CR√çTICO: Recarregar anota√ß√µes do localStorage antes de renderizar
            try {
                const anotacoesSalvas = localStorage.getItem(window.vrvs_key('anotacoes'));
                if (anotacoesSalvas) {
                    anotacoes = JSON.parse(anotacoesSalvas);
                }
            } catch (e) {
                console.error('[RENDER CADERNO] Erro ao carregar anota√ß√µes:', e);
            }
            
            let anotacoesFiltradas = anotacoes;
            
            if (filtroArea) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => a.area === filtroArea);
            }
            
            if (filtroTema) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => String(a.temaId) === String(filtroTema));
            }
            
            // Agrupar por √°rea
            const anotacoesPorArea = {};
            anotacoesFiltradas.forEach(a => {
                // CORRE√á√ÉO: S√≥ mostrar anota√ß√µes que t√™m conte√∫do OU temaId v√°lido correspondente a um tema
                const tema = dados.find(t => String(t.id) === String(a.temaId));
                if (!tema) {
                    console.warn(`[RENDER CADERNO] Anota√ß√£o sem tema correspondente: temaId=${a.temaId}, tema="${a.tema}"`);
                    return; // Pular anota√ß√µes sem tema correspondente
                }
                
                // Atualizar √°rea e tema da anota√ß√£o com dados do tema (garantir consist√™ncia)
                a.area = tema.area;
                a.tema = tema.tema;
                
                if (!anotacoesPorArea[a.area]) {
                    anotacoesPorArea[a.area] = [];
                }
                anotacoesPorArea[a.area].push(a);
            });
            
            if (anotacoesFiltradas.length === 0 || Object.keys(anotacoesPorArea).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma anota√ß√£o encontrada</div></div>';
                return;
            }
            
            let html = '';
            
            Object.keys(anotacoesPorArea).sort().forEach(area => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 18px;">üìö ${area}</h3>`;
                
                // Ordenar temas dentro da √°rea alfabeticamente (como sugerido pelo Opus)
                anotacoesPorArea[area].sort((a, b) => {
                    const temaA = a.tema || '';
                    const temaB = b.tema || '';
                    return temaA.localeCompare(temaB, 'pt-BR', { sensitivity: 'base' });
                }).forEach(anotacao => {
                    const tema = dados.find(t => String(t.id) === String(anotacao.temaId));
                    if (!tema) return;
                    
                    html += `
                        <div class="task-item" style="margin-bottom: 20px;" data-tema-id="${anotacao.temaId}">
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                    üìù ${anotacao.tema}
                                </div>
                                <div style="font-size: 11px; color: rgba(0,206,209,0.6); margin-bottom: 10px;">
                                    √öltima atualiza√ß√£o: ${formatarData(anotacao.ultimaAtualizacao)}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: var(--cobre-light); margin-bottom: 5px; display: block; font-weight: 600;">üî• Hot Topics (pontos de prova)</label>
                                <textarea 
                                    id="hotTopics_${anotacao.temaId}" 
                                    class="form-input" 
                                    rows="3" 
                                    style="width: 100%; font-family: inherit; resize: vertical; background: rgba(255,127,80,0.05); border: 1px solid rgba(255,127,80,0.3); border-radius: 6px; padding: 10px;"
                                    placeholder="Digite pontos importantes do tema..."
                                    onblur="salvarAnotacao(${anotacao.temaId})"
                                >${((anotacao.hotTopics || '')).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: rgba(0,206,209,0.8); margin-bottom: 5px; display: block;">üìù Anota√ß√µes Gerais</label>
                                <textarea 
                                    id="anotacao_${anotacao.temaId}" 
                                    class="form-input" 
                                    rows="6" 
                                    style="width: 100%; font-family: inherit; resize: vertical;"
                                    placeholder="Digite suas anota√ß√µes aqui..."
                                    onblur="salvarAnotacao(${anotacao.temaId})"
                                >${(anotacao.conteudo || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-edit" onclick="salvarAnotacao(${anotacao.temaId})" title="Salvar">üíæ</button>
                                <button class="btn-edit" onclick="limparAnotacao(${anotacao.temaId})" title="Limpar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function salvarAnotacao(temaId) {
            const textarea = document.getElementById(`anotacao_${temaId}`);
            const hotTopicsTextarea = document.getElementById(`hotTopics_${temaId}`);
            if (!textarea) return;
            
            const anotacao = obterOuCriarAnotacao(temaId);
            if (!anotacao) return;
            
            anotacao.conteudo = textarea.value.trim();
            anotacao.hotTopics = hotTopicsTextarea ? hotTopicsTextarea.value.trim() : '';
            anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
            
            localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
            
            // Atualizar renderiza√ß√£o
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            renderCaderno(filtroArea, filtroTema);
        }
        
        function limparAnotacao(temaId) {
            if (!confirm('Tem certeza que deseja limpar esta anota√ß√£o?')) return;
            
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (anotacao) {
                anotacao.conteudo = '';
                anotacao.hotTopics = '';
                anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
                localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                
                const textarea = document.getElementById(`anotacao_${temaId}`);
                const hotTopicsTextarea = document.getElementById(`hotTopics_${temaId}`);
                if (textarea) textarea.value = '';
                if (hotTopicsTextarea) hotTopicsTextarea.value = '';
                
                mostrarNotificacaoFeedback('üóëÔ∏è Anota√ß√£o limpa!');
                
                const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
                const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
                renderCaderno(filtroArea, filtroTema);
            }
        }
        
        // ==================== INICIALIZA√á√ÉO ====================
        
        // Garantir carregamento da logo no MacBook
        function garantirLogoCarregada() {
            const logoImg = document.querySelector('.splash-logo');
            if (!logoImg) return;
            
            // For√ßar recarregamento com timestamp √∫nico para evitar cache
            const timestamp = new Date().getTime();
            const logoPath = './logo.png?v=' + timestamp;
            const logoFallback = './logo.jpeg?v=' + timestamp;
            
            // Criar nova imagem para testar
            const testImg = new Image();
            testImg.onload = function() {
                logoImg.src = logoPath;
            };
            testImg.onerror = function() {
                // Tentar fallback
                const testFallback = new Image();
                testFallback.onload = function() {
                    logoImg.src = logoFallback;
                };
                testFallback.onerror = function() {
                    console.warn('Logo n√£o encontrada, usando fallback');
                };
                testFallback.src = logoFallback;
            };
            testImg.src = logoPath;
        }
        
        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', garantirLogoCarregada);
        } else {
            garantirLogoCarregada();
        }
        
        // ==================== SISTEMA DE TUTORIAL E AJUDA ====================
        
        const passosTutorial = [
            {
                titulo: "üéØ Bem-vindo ao VRVS!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Ol√°! Este √© o <strong>VRVS</strong> - seu sistema de gest√£o de estudos.</p>
                    <p style="margin-bottom: 15px;">Vou te mostrar rapidamente como usar cada funcionalidade.</p>
                    <p style="color: rgba(0,206,209,0.8);">üì± Dica: Voc√™ pode instalar como app no seu celular!</p>
                `
            },
            {
                titulo: "üìä Banco de Dados",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Aqui voc√™:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚úÖ Adiciona novos temas para estudar</li>
                        <li>‚úÖ Define √°rea, status e prioridade</li>
                        <li>‚úÖ Visualiza todos seus temas</li>
                        <li>‚úÖ Edita ou remove temas</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">√â a base de tudo!</p>
                `
            },
            {
                titulo: "üìã Tarefas do Dia",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Tarefas de hoje e atrasadas:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üéØ Mostra o que voc√™ precisa estudar HOJE</li>
                        <li>üîÑ Revis√µes VRVS 3P do dia (cards para revisar)</li>
                        <li>‚è±Ô∏è Op√ß√£o de registrar tempo por atividade</li>
                        <li>üí° Diretrizes personalizadas para cada tema</li>
                        <li>üî• Hot Topics aparecem quando expandir um tema</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° Comece sempre pela aba Tarefas para ver o que precisa fazer hoje!</p>
                `
            },
            {
                titulo: "üìÖ Agenda",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Timeline dos pr√≥ximos dias:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìÜ Filtre por per√≠odo (semana, m√™s)</li>
                        <li>üîç Visualize o que vem pela frente</li>
                        <li>üìå Organize suas revis√µes</li>
                    </ul>
                `
            },
            {
                titulo: "üìî Di√°rio de Aprendizados",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Registre o que voc√™ aprendeu:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìù Anote aprendizados no formato pergunta/resposta</li>
                        <li>üîÑ Marque "VRVS 3P" para virar card de revis√£o</li>
                        <li>üìÖ Cards aparecem automaticamente para revisar depois</li>
                        <li>üß† Sistema de revis√£o espa√ßada (quanto mais acerta, mais tempo at√© pr√≥xima revis√£o)</li>
                        <li>üîç <strong style="color: var(--turquesa-light);">NOVO:</strong> Zoom em imagens (pergunta e resposta) com gestos de pinch e pan</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° O Di√°rio √© onde voc√™ transforma estudo em mem√≥ria de longo prazo!</p>
                `
            },
            {
                titulo: "üîÑ Sistema VRVS 3P (Revis√£o Espa√ßada)",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Como funciona a revis√£o espa√ßada:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìù Voc√™ cria uma anota√ß√£o no Di√°rio e marca "VRVS 3P"</li>
                        <li>üìÖ No dia seguinte, o card aparece para revisar</li>
                        <li>üß† Voc√™ tenta lembrar a resposta (recall ativo)</li>
                        <li>‚úÖ Responde: <strong style="color: #dc3545;">ESQUECI</strong>, <strong style="color: #f59e0b;">LEMBREI</strong> ou <strong style="color: #22c55e;">F√ÅCIL</strong></li>
                        <li>üìà Sistema agenda pr√≥xima revis√£o baseado na sua resposta</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° Quanto mais voc√™ acerta, mais tempo at√© a pr√≥xima revis√£o. √â ci√™ncia aplicada!</p>
                `
            },
            {
                titulo: "üí¨ Feedback de Sess√£o",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Registre cada sess√£o de estudos:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚è±Ô∏è Use o cron√¥metro integrado</li>
                        <li>üìä Avalie seu rendimento (0-100%)</li>
                        <li>‚ùì Registre quest√µes e flashcards</li>
                        <li>üìù Adicione observa√ß√µes</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° O sistema calcula automaticamente quando voc√™ deve revisar cada tema!</p>
                `
            },
            {
                titulo: "üìà Estat√≠sticas e An√°lises",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Acompanhe seu progresso:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìä Gr√°ficos de performance</li>
                        <li>‚è±Ô∏è An√°lises de tempo (opcional)</li>
                        <li>üìâ Identifica√ß√£o de pontos fracos</li>
                        <li>üéØ M√©tricas por √°rea e tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìù Caderno e Hot Topics",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Anota√ß√µes detalhadas por tema:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üî• Hot Topics: pontos-chave que sempre caem em prova</li>
                        <li>üìù Anota√ß√µes detalhadas por tema</li>
                        <li>üìã Hot Topics aparecem na aba Tarefas quando expandir um tema</li>
                        <li>üí° Use para revisar rapidamente antes de estudar</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° Preencha os Hot Topics ‚Äî eles ajudam muito na hora de estudar!</p>
                `
            },
            {
                titulo: "üë§ Perfis e Organiza√ß√£o",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Organize seus estudos em perfis separados:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üë§ Crie m√∫ltiplos perfis para diferentes projetos</li>
                        <li>‚úèÔ∏è Personalize o nome de exibi√ß√£o de cada perfil</li>
                        <li>üîÑ Troque entre perfis facilmente</li>
                        <li>üíæ Cada perfil tem seus pr√≥prios dados isolados</li>
                        <li>üì§ Exporte/importe backup por perfil</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° Use perfis diferentes para organizar estudos de diferentes √°reas ou projetos!</p>
                `
            },
            {
                titulo: "üìå Extras e Backup",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Outras funcionalidades:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üì§ Exportar backup completo (JSON)</li>
                        <li>üì• Importar backup</li>
                        <li>üìä An√°lises e gr√°ficos de progresso</li>
                        <li>üìà Painel de sa√∫de VRVS 3P</li>
                        <li>üîç Zoom em imagens do Di√°rio (pergunta e resposta)</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üíæ Tudo √© salvo localmente no seu navegador! Fa√ßa backup regularmente.</p>
                `
            },
            {
                titulo: "‚úÖ Pronto para come√ßar!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Agora voc√™ conhece todas as funcionalidades!</p>
                    <p style="margin-bottom: 15px;"><strong>Fluxo di√°rio recomendado:</strong></p>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>üìã Abra a aba <strong>Tarefas</strong> e veja o que precisa fazer hoje</li>
                        <li>üîÑ Revise os cards VRVS 3P (se houver)</li>
                        <li>üìö Estude um tema e anote aprendizados no <strong>Di√°rio</strong></li>
                        <li>üí¨ Registre a sess√£o no <strong>Feedback</strong></li>
                    </ol>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üí° O sistema calcula tudo automaticamente. Voc√™ s√≥ precisa usar consistentemente!</p>
                    <p style="margin-top: 10px; color: var(--turquesa-light);">‚ùì D√∫vidas? Use o bot√£o de ajuda no canto da tela ou consulte o manual completo!</p>
                `
            }
        ];
        
        let passoAtual = 0;
        
        function iniciarTutorial() {
            passoAtual = 0;
            mostrarPassoTutorial();
            document.getElementById('tutorialModal').style.display = 'flex';
        }
        
        function mostrarPassoTutorial() {
            const passo = passosTutorial[passoAtual];
            document.getElementById('tutorialTitulo').textContent = passo.titulo;
            document.getElementById('tutorialConteudo').innerHTML = passo.conteudo;
            document.getElementById('tutorialProgresso').textContent = `Passo ${passoAtual + 1} de ${passosTutorial.length}`;
            
            // Atualizar bot√µes
            document.getElementById('btnAnterior').style.display = passoAtual === 0 ? 'none' : 'block';
            document.getElementById('btnProximo').textContent = passoAtual === passosTutorial.length - 1 ? 'Finalizar ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function tutorialProximo() {
            if (passoAtual < passosTutorial.length - 1) {
                passoAtual++;
                mostrarPassoTutorial();
            } else {
                finalizarTutorial();
            }
        }
        
        function tutorialAnterior() {
            if (passoAtual > 0) {
                passoAtual--;
                mostrarPassoTutorial();
            }
        }
        
        function pularTutorial() {
            if (confirm('Tem certeza que deseja pular o tutorial?')) {
                finalizarTutorial();
            }
        }
        
        function fecharTutorial() {
            finalizarTutorial();
        }
        
        function finalizarTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            localStorage.setItem('vrvs_tutorial_completo', 'true');
        }
        
        function ocultarBotaoTutorial() {
            const container = document.getElementById('btnAjudaFlutuanteContainer');
            if (container) {
                container.style.display = 'none';
                localStorage.setItem('vrvs_tutorial_oculto', 'true');
            }
        }
        
        // Verificar se o bot√£o deve estar oculto ao carregar
        window.addEventListener('DOMContentLoaded', function() {
            const tutorialOculto = localStorage.getItem('vrvs_tutorial_oculto');
            if (tutorialOculto === 'true') {
                const container = document.getElementById('btnAjudaFlutuanteContainer');
                if (container) {
                    container.style.display = 'none';
                }
            }
        });
        
        // ==================== V√çDEO ANIMADO TUTORIAL ====================
        
        const slidesVideo = [
            {
                titulo: "üß† Bem-vindo ao VRVS",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">üß†</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Sistema de Gest√£o de Estudos</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Uma plataforma completa para organizar seus estudos, acompanhar seu progresso e melhorar seu desempenho.
                    </p>
                `
            },
            {
                titulo: "üìä Organize seus Temas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Adicione e Organize</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Cadastre seus temas por √°rea, defina prioridades e datas. Tudo organizado em um s√≥ lugar.
                    </p>
                `
            },
            {
                titulo: "üìã Tarefas do Dia",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">O que Estudar Hoje?</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Veja suas tarefas do dia e receba diretrizes personalizadas para cada tema. Registre o tempo gasto em quest√µes e flashcards.
                    </p>
                `
            },
            {
                titulo: "üí¨ Registre suas Sess√µes",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üí¨</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Acompanhe seu Progresso</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Use o cron√¥metro integrado, registre seu rendimento, quest√µes e flashcards. Tudo salvo automaticamente.
                    </p>
                `
            },
            {
                titulo: "üìà An√°lises Detalhadas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìà</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Veja seu Desempenho</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Gr√°ficos, estat√≠sticas por √°rea, an√°lises de tempo. Identifique seus pontos fortes e fracos.
                    </p>
                `
            },
            {
                titulo: "‚úÖ Pronto para Come√ßar!",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">‚úÖ</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Comece Agora</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Adicione seus primeiros temas e comece a estudar de forma mais organizada e eficiente.
                    </p>
                `
            }
        ];
        
        let slideAtualVideo = 0;
        
        function mostrarSlideVideo() {
            const slide = slidesVideo[slideAtualVideo];
            document.getElementById('videoSlide').innerHTML = slide.conteudo;
            document.getElementById('videoProgresso').textContent = `${slideAtualVideo + 1} / ${slidesVideo.length}`;
            
            document.getElementById('btnVideoAnterior').style.display = slideAtualVideo === 0 ? 'none' : 'block';
            document.getElementById('btnVideoProximo').textContent = slideAtualVideo === slidesVideo.length - 1 ? 'Fim ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function videoProximo() {
            if (slideAtualVideo < slidesVideo.length - 1) {
                slideAtualVideo++;
                mostrarSlideVideo();
            }
        }
        
        function videoAnterior() {
            if (slideAtualVideo > 0) {
                slideAtualVideo--;
                mostrarSlideVideo();
            }
        }
        
        // Inicializar v√≠deo ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            mostrarSlideVideo();
        });
        
        // ==================== FAQ INTELIGENTE ====================
        
        const faqRespostas = {
            adicionar: {
                titulo: "Como adicionar um tema?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üìä Dados</strong><br>
                    2. Preencha o formul√°rio no topo:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea (ex: Ortopedia)<br>
                       &nbsp;&nbsp;‚Ä¢ Tema (ex: Fraturas do √∫mero)<br>
                       &nbsp;&nbsp;‚Ä¢ Status, Prioridade, Data<br>
                    3. Clique em <strong>üíæ SALVAR</strong><br><br>
                    Pronto! O tema aparecer√° na tabela abaixo.
                `
            },
            feedback: {
                titulo: "Como registrar uma sess√£o?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üí¨ Feedback</strong><br>
                    2. Use o <strong>‚è±Ô∏è Cron√¥metro</strong> durante o estudo<br>
                    3. Ao terminar, clique em <strong>Encerrar Sess√£o</strong><br>
                    4. Preencha:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea e Tema estudado<br>
                       &nbsp;&nbsp;‚Ä¢ Tempo, rendimento<br>
                       &nbsp;&nbsp;‚Ä¢ Quest√µes e flashcards<br>
                       &nbsp;&nbsp;‚Ä¢ Observa√ß√µes<br>
                    5. Clique em <strong>SALVAR FEEDBACK</strong><br><br>
                    Seus dados s√£o salvos automaticamente!
                `
            },
            agenda: {
                titulo: "Como usar a agenda?",
                texto: `
                    <strong>A agenda mostra suas pr√≥ximas revis√µes:</strong><br><br>
                    ‚Ä¢ Filtre por per√≠odo usando os campos de data<br>
                    ‚Ä¢ Clique em <strong>Semana Atual</strong> para ver os pr√≥ximos 7 dias<br>
                    ‚Ä¢ Cada tema mostra: √°rea, prioridade, rendimento<br>
                    ‚Ä¢ A data de agenda √© definida ao adicionar/editar o tema<br><br>
                    <strong>Dica:</strong> Use para planejar sua semana de estudos!
                `
            },
            stats: {
                titulo: "Como ver estat√≠sticas?",
                texto: `
                    <strong>V√°rias formas de analisar seus dados:</strong><br><br>
                    üìà <strong>Aba Gr√°ficos:</strong> Visualiza√ß√µes gerais<br>
                    üîç <strong>Aba An√°lises:</strong> Dados detalhados por √°rea/tema<br>
                    ‚è±Ô∏è <strong>An√°lises de Tempo:</strong> Clique no bot√£o para mostrar<br>
                    üìú <strong>Aba Hist√≥rico:</strong> Todas as sess√µes registradas<br><br>
                    Use os filtros para focar em per√≠odos espec√≠ficos!
                `
            },
            backup: {
                titulo: "Como fazer backup?",
                texto: `
                    <strong>Seus dados j√° s√£o salvos automaticamente!</strong><br><br>
                    Mas voc√™ pode fazer backup extra:<br><br>
                    1. V√° para a aba <strong>üì§ Exportar</strong><br>
                    2. Clique em <strong>üìä Baixar DADOS.csv</strong><br>
                    3. Ou <strong>üìú Baixar HISTORICO.csv</strong><br><br>
                    Os arquivos CSV podem ser abertos no Excel ou Google Sheets.<br><br>
                    <strong>Importante:</strong> Dados ficam no navegador. Se limpar cache, pode perder tudo!
                `
            }
        };
        
        function mostrarResposta(tipo) {
            const resposta = faqRespostas[tipo];
            document.getElementById('perguntaAssistente').value = resposta.titulo;
            document.getElementById('textoResposta').innerHTML = resposta.texto;
            document.getElementById('respostaAssistente').style.display = 'block';
            
            // Scroll suave at√© a resposta
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function responderDuvida() {
            const pergunta = document.getElementById('perguntaAssistente').value.toLowerCase();
            let resposta = '';
            
            // Sistema simples de palavras-chave
            if (pergunta.includes('adicionar') || pergunta.includes('novo') || pergunta.includes('criar') || pergunta.includes('tema')) {
                resposta = faqRespostas.adicionar.texto;
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registrar') || pergunta.includes('cron√¥metro')) {
                resposta = faqRespostas.feedback.texto;
            } else if (pergunta.includes('agenda') || pergunta.includes('timeline') || pergunta.includes('pr√≥xim')) {
                resposta = faqRespostas.agenda.texto;
            } else if (pergunta.includes('estat√≠stica') || pergunta.includes('gr√°fico') || pergunta.includes('an√°lise') || pergunta.includes('performance')) {
                resposta = faqRespostas.stats.texto;
            } else if (pergunta.includes('backup') || pergunta.includes('exportar') || pergunta.includes('salvar') || pergunta.includes('perder')) {
                resposta = faqRespostas.backup.texto;
            } else if (pergunta.includes('tempo') || pergunta.includes('quest√µes') || pergunta.includes('flashcard')) {
                resposta = `
                    <strong>Registrando tempo por atividade:</strong><br><br>
                    1. Na aba <strong>üìã Tarefas</strong> ou <strong>üìÖ Agenda</strong><br>
                    2. Clique no bot√£o <strong>‚è±Ô∏è Mostrar Tempos</strong><br>
                    3. Preencha os campos opcionais de cada tema<br>
                    4. Os dados ser√£o inclu√≠dos nas an√°lises<br><br>
                    Voc√™ tamb√©m pode registrar no Feedback de Sess√£o!
                `;
            } else if (pergunta.includes('como') || pergunta.includes('usar') || pergunta.includes('funciona')) {
                resposta = `
                    <strong>N√£o encontrei uma resposta espec√≠fica.</strong><br><br>
                    Tente uma destas op√ß√µes:<br>
                    ‚Ä¢ Clique nos bot√µes de perguntas frequentes acima<br>
                    ‚Ä¢ Inicie o <strong>Tour Guiado</strong> no topo da p√°gina<br>
                    ‚Ä¢ Seja mais espec√≠fico na pergunta<br><br>
                    <strong>Exemplos de perguntas:</strong><br>
                    "Como adicionar tema?"<br>
                    "Como fazer backup?"<br>
                    "Como ver estat√≠sticas?"
                `;
            } else {
                resposta = `
                    <strong>Desculpe, n√£o entendi sua d√∫vida.</strong><br><br>
                    Clique em uma das <strong>Perguntas Frequentes</strong> acima ou<br>
                    inicie o <strong>üöÄ Tour Guiado</strong> para conhecer a plataforma!
                `;
            }
            
            document.getElementById('textoResposta').innerHTML = resposta;
            document.getElementById('respostaAssistente').style.display = 'block';
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Enter para buscar resposta
        document.addEventListener('DOMContentLoaded', function() {
            const inputPergunta = document.getElementById('perguntaAssistente');
            if (inputPergunta) {
                inputPergunta.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        responderDuvida();
                    }
                });
            }
        });
        
        // ==================== MIGRA√á√ïES E INICIALIZA√á√ïES ====================
        
        // Executar migra√ß√µes na inicializa√ß√£o
        migrarAnotacoesParaHotTopics();
        
        // ==================== PERFIS MVP (P1.4-A1) ====================
        // trocarPerfil agora recarrega todos os datasets (n√£o s√≥ di√°rio)
        window.trocarPerfil = function(novoPerfil) {
            if (!novoPerfil || novoPerfil === window.vrvs_perfilAtivo) {
                return;
            }
            
            // Salvar todos os dados do perfil atual
            try {
                // Salvar dados (via fun√ß√£o existente se houver, sen√£o direto)
                if (typeof salvarDadosManualmente === 'function') {
                    salvarDadosManualmente();
                } else {
                    // Fallback: salvar diretamente
                    localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                    localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                    localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
                    localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
                }
                // Salvar √°reas customizadas
                localStorage.setItem(window.vrvs_key('areas_custom'), JSON.stringify(window.vrvsAreasCustom || []));
                // Salvar di√°rio
                salvarDiario();
            } catch(e) {
                console.warn('[PERFIL] Erro ao salvar antes de trocar:', e);
            }
            
            // Trocar perfil
            window.vrvs_perfilAtivo = novoPerfil;
            localStorage.setItem('vrvs_perfil_ativo', novoPerfil);
            
            // Recarregar todos os dados do novo perfil (com fallback legacy se DEFAULT)
            // Helper para recarregar um dataset
            function recarregarDataset(baseKey, defaultValue = []) {
                const key = window.vrvs_key(baseKey);
                let raw = localStorage.getItem(key);
                let result = null;
                if (raw !== null) {
                    result = (typeof window.safeParseLS === 'function') ? window.safeParseLS(key, defaultValue, 4 * 1024 * 1024) : safeJSONFromLS(key, defaultValue);
                }
                if ((result === null || !Array.isArray(result)) && novoPerfil === 'DEFAULT') {
                    const legacyRaw = localStorage.getItem(`vrvs_${baseKey}`);
                    if (legacyRaw !== null) {
                        result = (typeof window.safeParseLS === 'function') ? window.safeParseLS(`vrvs_${baseKey}`, defaultValue, 4 * 1024 * 1024) : safeJSONFromLS(`vrvs_${baseKey}`, defaultValue);
                    }
                }
                return (result && Array.isArray(result)) ? result : defaultValue;
            }
            
            // Recarregar datasets
            dados = recarregarDataset('dados', []);
            historico = recarregarDataset('historico', []);
            anotacoes = recarregarDataset('anotacoes', []);
            lembretes = recarregarDataset('lembretes', []);
            
            // Recarregar √°reas customizadas
            let areasCustomRaw = localStorage.getItem(window.vrvs_key('areas_custom'));
            let novasAreasCustom = null;
            if (areasCustomRaw !== null) {
                novasAreasCustom = (typeof window.safeParseLS === 'function') ? window.safeParseLS(window.vrvs_key('areas_custom'), [], 4 * 1024 * 1024) : safeJSONFromLS(window.vrvs_key('areas_custom'), []);
            }
            if ((novasAreasCustom === null || !Array.isArray(novasAreasCustom)) && novoPerfil === 'DEFAULT') {
                const legacyRaw = localStorage.getItem('vrvs_areas_custom');
                if (legacyRaw !== null) {
                    novasAreasCustom = (typeof window.safeParseLS === 'function') ? window.safeParseLS('vrvs_areas_custom', [], 4 * 1024 * 1024) : safeJSONFromLS('vrvs_areas_custom', []);
                }
            }
            if (!novasAreasCustom || !Array.isArray(novasAreasCustom)) novasAreasCustom = [];
            novasAreasCustom = novasAreasCustom
                .map(a => String(a).trim())
                .filter(a => a.length > 0)
                .filter((a, i, arr) => arr.indexOf(a) === i)
                .sort();
            window.vrvsAreasCustom = novasAreasCustom;
            
            // Espelhar em window.*
            window.dados = dados;
            window.historico = historico;
            window.anotacoes = anotacoes;
            window.lembretes = lembretes;
            
            // Recarregar di√°rio
            carregarDiario();
            
            // PACOTE A: Atualizar labels de perfil ativo ap√≥s trocar perfil (ap√≥s recarregar tudo)
            atualizarLabelsPerfilAtivo();
            
            // Re-renderizar se√ß√µes vis√≠veis
            const diarioSection = document.getElementById('diario');
            if (diarioSection && diarioSection.style.display !== 'none') {
                renderDiario();
            }
            
            const tarefaSection = document.getElementById('tarefa');
            if (tarefaSection && tarefaSection.style.display !== 'none') {
                if (typeof renderTarefas === 'function') {
                    renderTarefas();
                }
            }
            
            const cadernoSection = document.getElementById('caderno');
            if (cadernoSection && cadernoSection.style.display !== 'none') {
                if (typeof renderCadernoV2 === 'function') {
                    renderCadernoV2();
                } else if (typeof renderCaderno === 'function') {
                    renderCaderno();
                }
            }
            
            const dadosSection = document.getElementById('dados');
            if (dadosSection && dadosSection.style.display !== 'none') {
                if (typeof renderDados === 'function') {
                    renderDados();
                }
            }
            
            // Atualizar chip VRVS 3P e indicadores
            if (typeof atualizarChipVrvs3p === 'function') {
                atualizarChipVrvs3p();
            }
            
            // Atualizar selects de √°rea
            if (typeof atualizarTodosSelectsArea === 'function') {
                // Recarregar selects com novas √°reas customizadas
                window.vrvsAreasCustom.forEach(area => {
                    atualizarTodosSelectsArea(area);
                });
            }
            
            // Atualizar select na Config
            const selectPerfil = document.getElementById('perfilAtivoSelect');
            if (selectPerfil) {
                selectPerfil.value = novoPerfil;
            }
            
            // Feedback ao usu√°rio
            if (typeof mostrarNotificacaoFeedback === 'function') {
                // PATCH P1: Usar displayName atualizado em vez de ID direto
                const nomeExibicao = window.vrvs_getDisplayName ? window.vrvs_getDisplayName(novoPerfil) : novoPerfil;
                mostrarNotificacaoFeedback(`‚úÖ Perfil alterado para: ${nomeExibicao}`, 'success');
            }
        };
        
        // Inicializar estrutura do Di√°rio se n√£o existir
        function inicializarDiario() {
            const diarioExistente = localStorage.getItem(window.vrvs_diarioKey());
            if (diarioExistente) return;
            
            const diarioInicial = {
                schemaVersion: 1,
                entradas: []  // S3K: Corrigir para usar "entradas" (schema atual)
            };
            
            localStorage.setItem(window.vrvs_diarioKey(), JSON.stringify(diarioInicial));
            console.log('[DI√ÅRIO] Estrutura inicializada');
        }
        
        inicializarDiario();
        
        // ==================== WINDOW ONLOAD ====================
        
        window.onload = function() {
            // Garantir logo novamente ap√≥s carregamento completo
            garantirLogoCarregada();
            
            // Restaurar cron√¥metro se estava rodando antes
            restaurarCronometro();
            
            // Inicializar configura√ß√µes e aplicar visibilidade do Di√°rio
            vrvs_getConfig();
            vrvs_applyDiarioVisibility();
            // Inicializar VRVS_BUILD na UI
            if (typeof VRVS_BUILD !== 'undefined') {
                renderConfig();
            }
            
            // Suporte a hash #mindmaps na URL
            if (window.location.hash === '#mindmaps') {
                setTimeout(() => {
                    showSection('mindmaps');
                }, 100);
            }
            
            // Renderizar UI do Modo Avan√ßado ao carregar
            if (typeof diarioModoAvancado_renderUI === 'function') {
                diarioModoAvancado_renderUI();
            }
            
            // Atualizar toggle visual ao carregar
            if (typeof diarioModoAvancado_atualizarToggleVisual === 'function') {
                diarioModoAvancado_atualizarToggleVisual();
            }
            
            // Verificar se √© primeira vez e mostrar tutorial
            const tutorialCompleto = localStorage.getItem('vrvs_tutorial_completo');
            if (!tutorialCompleto) {
                setTimeout(() => {
                    if (confirm('üëã Primeira vez aqui? Gostaria de fazer um tour r√°pido pela plataforma?')) {
                        iniciarTutorial();
                    } else {
                        localStorage.setItem('vrvs_tutorial_completo', 'true');
                    }
                }, 1000);
            }
            
            // Page Visibility API - Detectar quando aba sai/volta ao foco
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Aba saiu de foco - salvar estado atual (funciona offline)
                    if (cronometroRodando || intervaloAtivo) {
                        salvarEstadoCronometro();
                        console.log('üì± Aba em segundo plano - cron√¥metro continua contando');
                    }
                } else {
                    // Aba voltou ao foco - restaurar e calcular tempo decorrido BASEADO EM TIMESTAMP ORIGINAL
                    const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                    const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                    
                    if (timestampOriginal && segundosOriginais) {
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - parseInt(timestampOriginal)) / 1000);
                        
                        // Atualizar cron√¥metro principal baseado no timestamp original
                        cronometroSegundos = parseInt(segundosOriginais) + tempoDecorrido;
                        
                        // Restaurar outros dados
                        const salvo = localStorage.getItem('vrvs_cronometro');
                        if (salvo) {
                            try {
                                const dados = JSON.parse(salvo);
                                tempoTotalIntervalo = dados.tempoIntervalo || 0;
                                
                                // Se estava em intervalo, atualizar intervalo tamb√©m
                                if (dados.intervaloAtivo) {
                                    intervaloAtivo = true;
                                    const intervaloOriginal = dados.intervaloSegundos || 0;
                                    intervaloSegundos = intervaloOriginal + tempoDecorrido;
                                    
                                    // Reiniciar timer do intervalo se necess√°rio
                                    if (intervaloInterval) {
                                        clearInterval(intervaloInterval);
                                    }
                                    intervaloInterval = setInterval(() => {
                                        // Calcular baseado em timestamp para intervalo tamb√©m
                                        const agoraIntervalo = Date.now();
                                        const tempoDecorridoIntervalo = Math.floor((agoraIntervalo - parseInt(timestampOriginal)) / 1000);
                                        intervaloSegundos = intervaloOriginal + tempoDecorridoIntervalo;
                                        document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                                    }, 100);
                                    
                                    document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                                    document.getElementById('tempoIntervalo').style.display = 'block';
                                    document.getElementById('tempoIntervaloDisplay').textContent = formatarIntervaloMinutos(intervaloSegundos);
                                }
                                
                                // Se estava rodando, garantir que continue rodando
                                if (dados.rodando && !cronometroRodando) {
                                    cronometroInicioTimestamp = parseInt(timestampOriginal);
                                    iniciarCronometroContagem();
                                    document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                                } else if (dados.rodando && cronometroRodando) {
                                    // J√° est√° rodando, apenas atualizar display
                                    atualizarDisplayCronometro();
                                }
                                
                                console.log('üì± Aba voltou ao foco - cron√¥metro atualizado (+' + tempoDecorrido + 's)');
                            } catch (e) {
                                console.log('Erro ao restaurar:', e);
                            }
                        }
                    }
                }
            });
            
            // Tamb√©m salvar antes de fechar a p√°gina
            window.addEventListener('beforeunload', function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            });
            
            // Salvar periodicamente enquanto est√° rodando (a cada 30 segundos)
            setInterval(function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            }, 30000); // Salvar a cada 30 segundos
            
            // ==================== SISTEMA DE ATUALIZA√á√ÉO AUTOM√ÅTICA ====================
            const APP_VERSION = '5.3';
            const SW_VERSION = 'vrvs-v5.3.49-fix-ajustes-1230-20251230-2005';
            
            // Changelog das atualiza√ß√µes
            const CHANGELOG = {
                '5.3': {
                    titulo: 'üéâ Grande Refatora√ß√£o - Interface Renovada!',
                    data: '12 de Dezembro de 2025',
                    mudancas: [
                        {
                            icone: 'üìä',
                            titulo: '10 Abas Consolidadas',
                            descricao: 'Reduzimos de 16 para 10 abas, organizando melhor a navega√ß√£o. Agora √© mais f√°cil encontrar o que precisa!'
                        },
                        {
                            icone: 'üìì',
                            titulo: 'Caderno V2 - √Åreas Colaps√°veis',
                            descricao: 'O Caderno agora organiza temas por √°rea, com √°reas que podem ser expandidas/colapsadas. Visualiza√ß√£o mais limpa e organizada!'
                        },
                        {
                            icone: 'üî•',
                            titulo: 'Hot Topics em Destaque',
                            descricao: 'Hot Topics agora aparecem em preview no Caderno, destacados com cor especial. Exporte todos em HTML para revis√£o!'
                        },
                        {
                            icone: 'üìà',
                            titulo: 'An√°lises Unificado',
                            descricao: 'Todas as an√°lises em um s√≥ lugar: Resumo, Gr√°ficos e Hist√≥rico. Navegue entre as vistas facilmente!'
                        },
                        {
                            icone: '‚ûï',
                            titulo: 'Cadastro Integrado',
                            descricao: 'Adicionar novo tema agora √© mais r√°pido - tudo em um modal dentro da aba Dados!'
                        },
                        {
                            icone: 'üìÖ',
                            titulo: 'Agenda Unificada',
                            descricao: 'Timeline e Pend√™ncias agora est√£o juntas. Use o toggle para alternar entre as vistas!'
                        }
                    ]
                },
                '5.2': {
                    titulo: 'Di√°rio de Aprendizados',
                    data: '11 de Dezembro de 2025',
                    mudancas: [
                        {
                            icone: 'üìî',
                            titulo: 'Novo Sistema de Di√°rio',
                            descricao: 'Registre seus aprendizados e pontos esquecidos diariamente, organizados por data e tema!'
                        }
                    ]
                }
            };
            
            // Registrar Service Worker para funcionamento offline
            if ('serviceWorker' in navigator) {
                // S3O: Migra√ß√£o - unregister SW antigo com querystring
                (async function() {
                    try {
                        const reg = await navigator.serviceWorker.getRegistration('./');
                        if (reg && reg.active) {
                            const scriptURL = reg.active.scriptURL || '';
                            // Se SW antigo tem querystring ou URL diferente, unregister
                            if (scriptURL.includes('?v=') || !scriptURL.endsWith('/sw.js')) {
                                console.log('üîÑ Removendo SW antigo com URL vari√°vel:', scriptURL);
                                await reg.unregister();
                                // Limpar caches antigos relacionados
                                try {
                                    const cacheNames = await caches.keys();
                                    const oldCaches = cacheNames.filter(name => name.startsWith('vrvs-') && name !== 'vrvs-v5.3.169-s3o-fix-sw-scripturl-20260125-0000');
                                    await Promise.all(oldCaches.map(name => caches.delete(name)));
                                } catch(e) {}
                                // Reload apenas uma vez ap√≥s unregister
                                if (!window.__vrvsSwMigrated) {
                                    window.__vrvsSwMigrated = true;
                                    setTimeout(() => window.location.reload(), 500);
                                    return; // N√£o continuar registro neste ciclo
                                }
                            }
                        }
                        // S3O: Continuar com registro apenas se migra√ß√£o n√£o fez reload
                        registerServiceWorker();
                    } catch(e) {
                        // Ignorar erros de migra√ß√£o, continuar com registro
                        registerServiceWorker();
                    }
                })();
                
                // S3O: Fun√ß√£o de registro separada para evitar duplica√ß√£o
                function registerServiceWorker() {
                    // S3O: URL est√°vel (sem querystring) para evitar conflito iOS
                    const SW_URL = './sw.js';
                    
                    // For√ßar reload quando Service Worker atualizar (ANTES de registrar)
                    let reloading = false;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (reloading) return;
                        reloading = true;
                        console.log('üîÑ Service Worker atualizado, recarregando...');
                        window.location.reload();
                    });
                    
                    navigator.serviceWorker.register(SW_URL, { scope: './' }).then((registration) => {
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // S3O: For√ßar update sem mudar URL
                    try {
                        registration.update().catch(() => {}); // Ignorar erros de update
                    } catch(e) {}
                    
                    // Se j√° h√° worker esperando, for√ßar ativa√ß√£o
                    if (registration.waiting) {
                        console.log('‚ö†Ô∏è Service Worker esperando, for√ßando ativa√ß√£o...');
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                    
                    // Detectar quando h√° nova vers√£o dispon√≠vel
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ Nova vers√£o do Service Worker detectada!');
                        
                        if (!newWorker) return;
                        
                        newWorker.addEventListener('statechange', () => {
                            console.log('üîÑ Estado do SW:', newWorker.state);
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // H√° vers√£o antiga ativa, for√ßar skip
                                    console.log('‚ö†Ô∏è Vers√£o antiga ativa, for√ßando skip...');
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                } else {
                                    // Primeira instala√ß√£o
                                    console.log('‚úÖ Primeira instala√ß√£o do SW');
                                }
                            }
                            if (newWorker.state === 'activated') {
                                console.log('‚úÖ Service Worker ativado!');
                            }
                        });
                    });
                    
                    // Verificar atualiza√ß√µes periodicamente (a cada 30 segundos - mais agressivo)
                    setInterval(() => {
                        registration.update();
                    }, 30000);
                    
                    // Verificar atualiza√ß√µes tamb√©m quando app volta ao foco
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            registration.update();
                        }
                    });
                    
                    // Escutar mensagens do Service Worker
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'SW_ACTIVATED') {
                            console.log('üîÑ Service Worker ativado, recarregando...', event.data.cacheName);
                            window.location.reload();
                        }
                    });
                    
                    // Expor fun√ß√£o global para atualiza√ß√£o manual
                    window.forcarAtualizacaoSW = function() {
                        if (!registration) {
                            alert('Service Worker n√£o registrado ainda.');
                            return;
                        }
                        console.log('üîÑ For√ßando atualiza√ß√£o manual do Service Worker...');
                        registration.update().then(() => {
                            if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                alert('Nova vers√£o encontrada! O app ser√° recarregado em instantes.');
                            } else {
                                alert('Voc√™ j√° est√° na vers√£o mais recente!');
                            }
                        }).catch(err => {
                            console.error('Erro ao atualizar:', err);
                            alert('Erro ao verificar atualiza√ß√µes. Tente novamente.');
                        });
                    };
                    
                    // Limpar caches antigos ao iniciar
                    if ('caches' in window) {
                        caches.keys().then((cacheNames) => {
                                cacheNames.forEach((cacheName) => {
                                if (!cacheName.includes('v5.3') && cacheName.startsWith('vrvs-')) {
                                    console.log('üóëÔ∏è Removendo cache antigo:', cacheName);
                                    caches.delete(cacheName);
                                }
                            });
                        });
                    }
                }).catch((error) => {
                    console.error('‚ö†Ô∏è Erro ao registrar Service Worker:', error);
                });
                } // Fim da fun√ß√£o registerServiceWorker()
            }
            
            // Fun√ß√£o para mostrar notifica√ß√£o de atualiza√ß√£o
            function mostrarNotificacaoAtualizacao() {
                const notificacao = document.createElement('div');
                notificacao.id = 'notificacaoAtualizacao';
                notificacao.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, var(--cobre-main), var(--cobre-dark));
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(255, 127, 80, 0.4);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    animation: slideInRight 0.3s ease;
                `;
                notificacao.innerHTML = `
                    <span>üîÑ Nova vers√£o dispon√≠vel!</span>
                    <button onclick="atualizarApp()" style="
                        background: white;
                        color: var(--cobre-main);
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                    ">Atualizar Agora</button>
                `;
                document.body.appendChild(notificacao);
                
                // Auto-remover ap√≥s 10 segundos se n√£o clicar
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => notificacao.remove(), 300);
                    }
                }, 10000);
            }
            
            // Fun√ß√£o para for√ßar atualiza√ß√£o do app
            window.atualizarApp = function() {
                // Salvar vers√£o anterior para mostrar changelog ap√≥s reload
                const versaoAnterior = localStorage.getItem('vrvs_versao_anterior') || '5.0';
                localStorage.setItem('vrvs_versao_anterior', APP_VERSION);
                localStorage.setItem('vrvs_mostrar_changelog', 'true');
                
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then((registrations) => {
                        registrations.forEach((registration) => {
                            if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    
                    // Limpar todos os caches
                    if ('caches' in window) {
                        caches.keys().then((cacheNames) => {
                            return Promise.all(cacheNames.map(name => caches.delete(name)));
                        }).then(() => {
                            console.log('‚úÖ Cache limpo! Recarregando...');
                            window.location.reload(true);
                        });
                    } else {
                        window.location.reload(true);
                    }
                } else {
                    window.location.reload(true);
                }
            };
            
            // Verificar se deve mostrar changelog ap√≥s atualiza√ß√£o
            function verificarChangelogAposAtualizacao() {
                const mostrarChangelog = localStorage.getItem('vrvs_mostrar_changelog');
                if (mostrarChangelog === 'true') {
                    localStorage.removeItem('vrvs_mostrar_changelog');
                    const versaoAnterior = localStorage.getItem('vrvs_versao_anterior') || '5.0';
                    mostrarModalAtualizacao(APP_VERSION, versaoAnterior);
                }
            }
            
            // Mostrar modal de atualiza√ß√£o
            function mostrarModalAtualizacao(versaoAtual, versaoAnterior) {
                const changelog = CHANGELOG[versaoAtual];
                if (!changelog) return;
                
                const modal = document.getElementById('modalAtualizacao');
                const titulo = document.getElementById('atualizacaoTitulo');
                const conteudo = document.getElementById('atualizacaoConteudo');
                
                titulo.textContent = changelog.titulo;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                            Vers√£o ${versaoAtual} ‚Ä¢ ${changelog.data}
                        </div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                            O que mudou nesta vers√£o:
                        </div>
                `;
                
                changelog.mudancas.forEach((mudanca, index) => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px; border-left: 3px solid var(--turquesa-main);">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="font-size: 24px;">${mudanca.icone}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px; font-size: 14px;">
                                        ${mudanca.titulo}
                                    </div>
                                    <div style="font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.5;">
                                        ${mudanca.descricao}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                conteudo.innerHTML = html;
                
                modal.classList.add('active');
            }
            
            function fecharModalAtualizacao() {
                document.getElementById('modalAtualizacao').classList.remove('active');
            }
            
            function iniciarTutorialAtualizacao() {
                fecharModalAtualizacao();
                setTimeout(() => {
                    iniciarTutorialNovidades();
                }, 300);
            }
            
            // Tutorial espec√≠fico das novidades
            function iniciarTutorialNovidades() {
                const passosNovidades = [
                    {
                        titulo: 'üìä 10 Abas Consolidadas',
                        conteudo: `
                            <p style="margin-bottom: 15px;">A navega√ß√£o foi simplificada! Agora temos apenas <strong>10 abas</strong> organizadas em grupos:</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">üìö ESTUDO (uso di√°rio)</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìã Tarefa</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìù Feedback</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìî Di√°rio</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìì Caderno</div>
                                <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 10px;">üìÖ PLANEJAMENTO</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">‚Ä¢ üìÖ Agenda</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìä Dados</div>
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">üìà AN√ÅLISE</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 10px;">‚Ä¢ üìà An√°lises</div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìì Caderno V2 - √Åreas Colaps√°veis',
                        conteudo: `
                            <p style="margin-bottom: 15px;">O <strong>Caderno</strong> foi completamente renovado!</p>
                            <ul style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li><strong>√Åreas colaps√°veis:</strong> Clique no cabe√ßalho da √°rea para expandir/colapsar</li>
                                <li><strong>Preview de Hot Topics:</strong> Veja seus Hot Topics destacados em cada tema</li>
                                <li><strong>Visualiza√ß√£o limpa:</strong> Apenas temas com conte√∫do aparecem destacados</li>
                                <li><strong>Edi√ß√£o r√°pida:</strong> Clique no √≠cone ‚úèÔ∏è para editar anota√ß√µes</li>
                            </ul>
                            <div style="background: rgba(255,127,80,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--cobre-main);">
                                <div style="font-size: 12px; color: var(--cobre-light);">
                                    üí° <strong>Dica:</strong> Use Hot Topics para anotar os pontos que mais caem na prova!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìà An√°lises Unificado',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Todas as an√°lises agora est√£o em um s√≥ lugar!</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">4 Vistas Dispon√≠veis:</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìä <strong>Resumo:</strong> M√©tricas principais em cards</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìà <strong>Gr√°ficos:</strong> Visualiza√ß√µes de performance</div>
                                <!-- Detalhado temporariamente removido -->
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px;">üìú <strong>Hist√≥rico:</strong> Todas as sess√µes registradas</div>
                            </div>
                            <p style="font-size: 12px; color: rgba(255,255,255,0.6);">Use os bot√µes de sub-navega√ß√£o para alternar entre as vistas!</p>
                        `
                    },
                    {
                        titulo: '‚ûï Cadastro Integrado',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Adicionar novos temas ficou mais r√°pido!</p>
                            <ol style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li>V√° na aba <strong>üìä Dados</strong></li>
                                <li>Clique no bot√£o <strong>‚ûï Novo Tema</strong> no topo</li>
                                <li>Preencha √°rea, tema e prioridade</li>
                                <li>Salve - pronto! Uma anota√ß√£o vazia ser√° criada automaticamente</li>
                            </ol>
                            <div style="background: rgba(0,206,209,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--turquesa-main);">
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                    ‚ú® N√£o precisa mais ir em uma aba separada para cadastrar!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: 'üìÖ Agenda Unificada',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Timeline e Pend√™ncias agora est√£o juntas!</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--turquesa-light); margin-bottom: 10px;">Use o Toggle para alternar:</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px; margin-bottom: 5px;">üìÖ <strong>Timeline:</strong> Veja seu cronograma completo</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-left: 10px;">üîî <strong>Atrasados:</strong> Veja apenas o que est√° pendente</div>
                            </div>
                            <p style="font-size: 12px; color: rgba(255,255,255,0.6);">Tudo em um s√≥ lugar, mais organizado!</p>
                        `
                    },
                    {
                        titulo: 'üî• Exporta√ß√£o Hot Topics HTML',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Nova funcionalidade: exporte todos os seus Hot Topics em um arquivo HTML bonito!</p>
                            <ol style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                <li>V√° na aba <strong>üìì Caderno</strong></li>
                                <li>Clique no bot√£o <strong>üî• Exportar HTML</strong> no topo</li>
                                <li>Um arquivo HTML ser√° baixado com todos os Hot Topics</li>
                                <li>Abra no navegador para revisar ou imprimir</li>
                            </ol>
                            <div style="background: rgba(255,127,80,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--cobre-main);">
                                <div style="font-size: 12px; color: var(--cobre-light);">
                                    üí° Perfeito para revis√£o antes da prova!
                                </div>
                            </div>
                        `
                    },
                    {
                        titulo: '‚úÖ Pronto para usar!',
                        conteudo: `
                            <p style="margin-bottom: 15px;">Essas s√£o as principais mudan√ßas da vers√£o ${APP_VERSION}!</p>
                            <p style="margin-bottom: 15px;">Explore as novas funcionalidades e aproveite a interface mais organizada.</p>
                            <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
                                    üí° <strong>Dica:</strong> Se tiver d√∫vidas, use a aba <strong>‚ùì Ajuda</strong> para ver tutoriais e FAQ atualizados!
                                </div>
                            </div>
                        `
                    }
                ];
                
                // Usar o sistema de tutorial existente, mas com passos diferentes
                passosTutorial = passosNovidades;
                passoAtual = 0;
                mostrarPassoTutorial();
                document.getElementById('tutorialModal').style.display = 'flex';
            }
            
            // Detectar recovery
            if (window.location.search.includes('recovered=1')) {
                setTimeout(() => {
                    alert('‚úì Cache limpo com sucesso! O aplicativo foi recarregado.');
                    window.history.replaceState({}, '', window.location.pathname);
                }, 3000);
            }
            
            // For√ßar atualiza√ß√£o do Service Worker se detectar cache desatualizado
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => {
                        reg.update();
                    });
                });
            }
            
            // Splash Screen - Esconder ap√≥s carregar (executar apenas uma vez)
            if (!window.splashScreenRemovido) {
                window.splashScreenRemovido = true;
                if (typeof __vrvsMark === 'function') __vrvsMark(5); // No ponto mais pr√≥ximo de remover/ocultar splash
                if (typeof setBootStep === 'function') setBootStep(5);
                setTimeout(() => {
                    try {
                        const splash = document.getElementById('splashScreen');
                        if (splash && !splash.classList.contains('hidden')) {
                            splash.classList.add('fade-out');
                            if (document.body) {
                                document.body.classList.remove('splash-loading');
                            }
                            setTimeout(() => {
                                try {
                                    if (splash && !splash.classList.contains('hidden')) {
                                        splash.classList.add('hidden');
                                    }
                                } catch(e) {
                                    console.error('[SPLASH] Erro ao esconder splash:', e);
                                }
                            }, 800);
                        }
                    } catch(e) {
                        console.error('[SPLASH] Erro ao remover splash:', e);
                        // Fallback: tentar remover diretamente
                        try {
                            const splash = document.getElementById('splashScreen');
                            const body = document.body;
                            if (splash) splash.classList.add('hidden');
                            if (body) body.classList.remove('splash-loading');
                        } catch(e2) {
                            console.error('[SPLASH] Fallback tamb√©m falhou:', e2);
                        }
                    }
                }, 2500); // Mostrar por 2.5 segundos
            }
            
            // Inicializar campo de data com hoje (com verifica√ß√£o de seguran√ßa)
            const feedbackData = document.getElementById('feedbackData');
            if (feedbackData) {
                feedbackData.value = new Date().toISOString().split('T')[0];
            }
            
            // Inicializar data inicial do lembrete com hoje
            const lembreteDataInicial = document.getElementById('lembreteDataInicial');
            if (lembreteDataInicial) {
                lembreteDataInicial.value = new Date().toISOString().split('T')[0];
            }
            
            // Event listeners para filtros de agenda (com verifica√ß√£o de seguran√ßa)
            const agendaDataInicio = document.getElementById('agendaDataInicio');
            const agendaDataFim = document.getElementById('agendaDataFim');
            if (agendaDataInicio && !agendaDataInicio.dataset.listenerAdded) {
                agendaDataInicio.dataset.listenerAdded = 'true';
                agendaDataInicio.addEventListener('change', renderAgenda);
            }
            if (agendaDataFim && !agendaDataFim.dataset.listenerAdded) {
                agendaDataFim.dataset.listenerAdded = 'true';
                agendaDataFim.addEventListener('change', renderAgenda);
            }
            
            // CADASTRO FORM
            document.getElementById('cadastroForm').onsubmit = function(e) {
                e.preventDefault();
                // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
                const novaAreaInput = document.getElementById('novaAreaInput');
                let area = '';
                if (novaAreaInput && novaAreaInput.style.display !== 'none' && novaAreaInput.value.trim()) {
                    area = novaAreaInput.value.trim();
                } else {
                    area = document.getElementById('novaArea').value.trim();
                }
                
                // Validar que n√£o √© a op√ß√£o especial
                if (area === '__NOVA_AREA__' || !area) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                    return;
                }
                
                const tema = document.getElementById('novoTema').value.trim();
                const prioridade = parseInt(document.getElementById('novaPrioridade').value);
                const status = document.getElementById('novaStatus').value;
                const dataInicio = document.getElementById('novaDataInicio').value;
                
                const novoTema = {
                    id: Date.now(),
                    area: normalizeArea(area, tema),
                    tema: tema,
                    status: status,
                    prioridade: prioridade,
                    dificuldade: 'M√©dia',
                    rendimento: 0,
                    sessoes: 0,
                    ultEstudo: '',
                    agenda: dataInicio || '',
                    tempo: 0,
                    observacoes: '',
                    contador80: 0,
                    sugestao: ''
                };
                
                dados.push(novoTema);
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                this.reset();
                mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
                renderDados();
                updateFeedbackSelect();
                renderPendencias();
            };
            
            // FEEDBACK FORM - 100% FUNCIONANDO!
            document.getElementById('feedbackArea').addEventListener('change', updateFeedbackTemaSelect);
            document.getElementById('feedbackForm').onsubmit = function(e) {
                e.preventDefault();
                const temaId = document.getElementById('feedbackTema').value;
                // CORRE√á√ÉO: Usar data do formul√°rio (input feedbackData)
                const dataSessao = document.getElementById('feedbackData').value;
                if (!dataSessao) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione uma data para a sess√£o!', 'error');
                    return;
                }
                const rendimento = parseInt(document.getElementById('feedbackRendimento').value);
                const tempoInput = document.getElementById('feedbackTempo');
                // Usar tempo do cron√¥metro se dispon√≠vel, sen√£o usar o input
                const tempo = cronometroSegundos > 0 ? obterTempoCronometroMinutos() : (parseInt(tempoInput.value) || 0);
                const tempoIntervalo = obterTempoIntervaloMinutos(); // Tempo de intervalo em minutos
                // Se usar cron√¥metro, atualizar o campo de input tamb√©m
                if (cronometroSegundos > 0) {
                    tempoInput.value = tempo;
                }
                
                // Novos campos opcionais
                const numeroIntervalos = parseInt(document.getElementById('feedbackNumeroIntervalos').value) || 0;
                const intervalosTexto = document.getElementById('feedbackIntervalos').value.trim() || '';
                const questoesTexto = document.getElementById('feedbackQuestoes').value.trim() || '';
                const flashcards = parseInt(document.getElementById('feedbackFlashcards').value) || 0;
                
                // Extrair dados de quest√µes (formato: acertos/total)
                let tempoQuestoes = 0;
                let quantQuestoes = 0;
                let quantQuestoesAcertos = 0;
                if (questoesTexto && questoesTexto.includes('/')) {
                    const partes = questoesTexto.split('/');
                    quantQuestoesAcertos = parseInt(partes[0]) || 0;
                    quantQuestoes = parseInt(partes[1]) || 0;
                }
                // Tentar obter tempo de quest√µes do modal ou usar 0
                const modal = document.getElementById('encerrarSessaoModal');
                if (modal && modal.dataset.tempoQuestoes) {
                    tempoQuestoes = parseInt(modal.dataset.tempoQuestoes) || 0;
                }
                
                // Extrair dados de flashcards
                let tempoFlashcards = 0;
                let quantFlashcards = 0;
                if (flashcards > 0) {
                    quantFlashcards = flashcards;
                    if (modal && modal.dataset.tempoFlashcards) {
                        tempoFlashcards = parseInt(modal.dataset.tempoFlashcards) || 0;
                    }
                }
                
                const sugestao = document.getElementById('feedbackSugestao').value.trim();
                const obs = ''; // Campo removido - n√£o mais usado
                
                // CORRE√á√ÉO: Compara√ß√£o correta de IDs
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado! Selecione um m√≥dulo v√°lido.', 'error');
                    return;
                }
                
                // üîß CORRE√á√ÉO M√çNIMA: Salvar contador80 antes para usar no c√°lculo correto
                const contador80Antes = parseInt(tema.contador80) || 0;
                const sessoesAntes = tema.sessoes || 0;
                
                // Atualizar dados do tema
                tema.rendimento = rendimento / 100;
                tema.sessoes = (tema.sessoes || 0) + 1;
                tema.ultEstudo = dataSessao;
                
                // üîß CORRE√á√ÉO: Na segunda sess√£o, usar contador80 = 0 para o c√°lculo (primeira n√£o conta)
                tema.contador80 = (sessoesAntes === 1 ? 0 : contador80Antes);
                
                // Calcular pr√≥xima revis√£o ANTES de atualizar contador80
                // CORRE√á√ÉO: Passar dataSessao para calcular baseado na data do feedback, n√£o na data atual
                tema.agenda = calcularProximaRevisao(tema, dataSessao);
                
                // Atualizar contador80 ap√≥s calcular o intervalo
                if (rendimento >= 80) {
                    tema.contador80 = (sessoesAntes === 1 ? 0 : contador80Antes) + 1;
                } else {
                    tema.contador80 = 0;
                }
                tema.tempo = (tema.tempo || 0) + tempo;
                tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
                
                // Adicionar observa√ß√µes E sugest√£o
                let novaObs = '';
                if (obs) novaObs = `${dataSessao}: ${obs}`;
                
                // Adicionar novos dados √†s observa√ß√µes se preenchidos
                if (questoesTexto) {
                    novaObs += (novaObs ? ' | ' : '') + `Q${questoesTexto}`;
                }
                if (flashcards > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `FC${flashcards}`;
                }
                if (numeroIntervalos > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `Intervalos: ${numeroIntervalos} (${intervalosTexto || 'registrados'})`;
                }
                
                if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
                
                if (novaObs) {
                    tema.observacoes = tema.observacoes 
                        ? tema.observacoes + '\n' + novaObs
                        : novaObs;
                }
                
                // SALVAR SUGEST√ÉO NO TEMA
                tema.sugestao = sugestao || '';
                
                // ADICIONAR AO HIST√ìRICO
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(tema.area, tema.tema);
                historico.push({
                    id: Date.now(),
                    temaId: tema.id,
                    area: areaCorrigida,
                    tema: temaCorrigido,
                    rendimento: rendimento / 100,
                    tempo: tempo,
                    tempoIntervalo: tempoIntervalo || 0, // Tempo de intervalo em minutos
                    numeroIntervalos: numeroIntervalos, // N√∫mero de intervalos
                    intervalos: intervalosTexto, // Tempos de cada intervalo
                    tempoQuestoes: tempoQuestoes, // Tempo gasto em quest√µes (min)
                    quantQuestoes: quantQuestoes, // Quantidade total de quest√µes
                    quantQuestoesAcertos: quantQuestoesAcertos, // Quantidade de acertos
                    tempoFlashcards: tempoFlashcards, // Tempo gasto em flashcards (min)
                    quantFlashcards: quantFlashcards, // Quantidade de flashcards revisados
                    questoes: questoesTexto, // Quest√µes (acertos/total) - mantido para compatibilidade
                    flashcards: quantFlashcards, // Quantidade de flashcards - mantido para compatibilidade
                    data: dataSessao,
                    observacoes: '-', // Campo removido do formul√°rio
                    sugestao: sugestao || '-'
                });
                
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                localStorage.setItem(window.vrvs_key('historico'), JSON.stringify(historico));
                
                this.reset();
                document.getElementById('feedbackData').value = new Date().toISOString().split('T')[0];
                // Limpar campos opcionais tamb√©m
                document.getElementById('feedbackNumeroIntervalos').value = '0';
                document.getElementById('feedbackIntervalos').value = '';
                document.getElementById('feedbackQuestoes').value = '';
                document.getElementById('feedbackFlashcards').value = '';
                
                // Resetar cron√¥metro ap√≥s salvar (incluindo tempo de intervalo)
                resetCronometro();
                
                // NOTIFICA√á√ÉO DE SUCESSO!
                const proximaData = formatarData(tema.agenda);
                mostrarNotificacaoFeedback(`‚úÖ Performance registrada!<br>üìÖ Pr√≥xima revis√£o: ${proximaData}`);
                
                renderTarefas();
                renderAgenda();
                renderDados();
                renderHistorico();
                renderPendencias();
                updateStats();
            };
            
            // EDIT FORM
            document.getElementById('editForm').onsubmit = function(e) {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const tema = dados.find(t => String(t.id) === String(id));
                
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                    return;
                }
                
                // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
                const editAreaInput = document.getElementById('editAreaInput');
                let areaEdit = '';
                if (editAreaInput && editAreaInput.style.display !== 'none' && editAreaInput.value.trim()) {
                    areaEdit = editAreaInput.value.trim();
                } else {
                    areaEdit = document.getElementById('editArea').value.trim();
                }
                
                // Validar que n√£o √© a op√ß√£o especial
                if (areaEdit === '__NOVA_AREA__' || !areaEdit) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                    return;
                }
                
                // Atualizar √°rea do tema editado (normalizada)
                tema.area = normalizeArea(areaEdit);
                tema.tema = document.getElementById('editTema').value.trim();
                tema.prioridade = parseInt(document.getElementById('editPrioridade').value);
                const novoStatus = document.getElementById('editStatus').value;
                tema.status = novoStatus;
                
                // CORRE√á√ÉO: Se mudou para Conclu√≠do ou Suspenso, limpar agenda
                if (novoStatus === 'Conclu√≠do' || novoStatus === 'Suspenso') {
                    tema.agenda = '';
                } else {
                    // Recalcular agenda se necess√°rio
                    if (tema.sessoes > 0) {
                        tema.agenda = calcularProximaRevisao(tema);
                    }
                }
                
                localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
                
                closeEditModal();
                mostrarNotificacaoFeedback('‚úÖ Tema atualizado com sucesso!');
                
                renderDados();
                renderTarefas();
                renderAgenda();
                renderPendencias();
                updateFeedbackSelect();
            };
            
            // LEMBRETE FORM (null-check para evitar erro se elemento foi removido)
            const lembreteForm = document.getElementById('lembreteForm');
            if (lembreteForm) {
                lembreteForm.onsubmit = function(e) {
                    e.preventDefault();
                    const titulo = document.getElementById('lembreteTitulo').value.trim();
                    const descricao = document.getElementById('lembreteDescricao').value.trim();
                    const periodicidade = document.getElementById('lembretePeriodicidade').value;
                    const temaId = document.getElementById('lembreteTemaId').value;
                    const dataInicial = document.getElementById('lembreteDataInicial').value;
                    
                    const novoLembrete = {
                        id: Date.now(),
                        titulo: titulo,
                        descricao: descricao || '',
                        periodicidade: periodicidade,
                        temaId: temaId || null,
                        dataInicial: dataInicial,
                        proximaData: periodicidade === 'pontual' ? dataInicial : calcularProximaDataLembrete({
                            periodicidade: periodicidade,
                            dataInicial: dataInicial,
                            ultimaData: null
                        }),
                        ultimaData: null,
                        concluido: false
                    };
                    
                    lembretes.push(novoLembrete);
                    localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
                    
                    mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado com sucesso!');
                    
                    // Limpar formul√°rio
                    this.reset();
                    document.getElementById('lembreteDataInicial').value = new Date().toISOString().split('T')[0];
                    
                    renderLembretes();
                };
            }
            
            // Inicializa√ß√µes
            renderTarefas();
            renderAgenda();
            renderDados();
            renderPendencias();
            // REMOVIDO: inicializarEventListenersPendencias() - usando onclick inline agora
            updateFeedbackSelect();
            updateStats();
            renderHistorico();
            atualizarSelectsLembrete();
            renderLembretes();
            atualizarSelectsCaderno();
            renderCaderno();
            
            // Popular select de √°reas fixas no cadastro (incluir √°reas existentes para consist√™ncia)
            const novaAreaSelect = document.getElementById('novaArea');
            if (novaAreaSelect) {
                // Unir √°reas base do perfil + √°reas existentes nos dados (mesmo padr√£o do modal de edi√ß√£o)
                const areasExistentes = [...new Set(dados.map(t => t.area).filter(Boolean))];
                const areasCompletas = getAreasDisponiveisDoPerfilAtivo();
                
                novaAreaSelect.innerHTML = '<option value="">Selecione...</option>' + 
                    areasCompletas.map(area => `<option value="${area}">${area}</option>`).join('') +
                    '<option value="__NOVA_AREA__">‚ûï Adicionar Nova √Årea...</option>';
            }
            
            // Inicializar Di√°rio
            carregarDiario();
            renderDiario();
            
            // S3K: Limpar bootErr stale quando app inicia com sucesso
            try {
                if (typeof localStorage !== 'undefined') {
                    localStorage.removeItem('vrvs_last_boot_err');
                }
            } catch(e) {
                console.warn('[S3K] Erro ao limpar bootErr:', e);
            }
            
            // Garantir que bot√£o + Nova tenha texto branco vis√≠vel (corrige problema de heran√ßa do card-title)
            setTimeout(() => {
                const btnNova = document.getElementById('btnNovaDiario');
                if (btnNova) {
                    btnNova.style.setProperty('color', '#FFFFFF', 'important');
                    btnNova.style.setProperty('-webkit-text-fill-color', '#FFFFFF', 'important');
                    btnNova.style.setProperty('text-shadow', '0 1px 3px rgba(0,0,0,0.5)', 'important');
                }
            }, 100);
        };
        
        function atualizarTemasCadastro(areaSelecionada) {
            // Fun√ß√£o para atualizar temas no cadastro quando √°rea mudar (se necess√°rio no futuro)
            // Por enquanto, apenas placeholder
        }
        
        // ==================== DI√ÅRIO DE APRENDIZADOS ====================
        
        const DIARIO_SCHEMA_VERSION = '1.0';
        let modoDiario = 'recall'; // 'recall' ou 'respostas'
        
        // ==================== SRS - SISTEMA DE REVIS√ÉO ESPA√áADA ====================
        
        // Modo da aba do Di√°rio: 'lista' ou 'sessao'
        var abaDiarioAtiva = 'lista';
        
        // Modo da sess√£o: 'programado' (FSRS) ou 'livre'
        let modoSessaoDiario = 'programado';
        
        // Estado interno da sess√£o de flashcards do Di√°rio
        let sessaoDiario = {
            tipo: null,          // 'programado' | 'livre'
            filaIds: [],         // array de IDs de entradas
            indiceAtual: 0       // √≠ndice na fila
        };
        
        // Fun√ß√µes utilit√°rias de data
        function hojeStr() {
            return obterYMDLocal(); // 'YYYY-MM-DD' (timezone local)
        }
        
        // BUG D: Helpers de data local (timezone do dispositivo, n√£o UTC)
        function pad2(n) {
            return String(n).padStart(2, '0');
        }
        
        function dateStrLocal(d) {
            const x = new Date(d);
            return `${x.getFullYear()}-${pad2(x.getMonth() + 1)}-${pad2(x.getDate())}`;
        }
        
        function hojeStrLocal() {
            return dateStrLocal(new Date());
        }
        
        function ontemStrLocal() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return dateStrLocal(d);
        }
        
        function ontemStrUTC() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return d.toISOString().slice(0, 10);
        }
        
        function ymdFromAny(v) {
            if (!v) return '';
            const s = String(v);
            // se vier ISO com hora, corta
            return s.length >= 10 ? s.slice(0, 10) : s;
        }
        
        // Helper para formatar texto do Di√°rio preservando quebras de linha
        // P4: Normalizar texto preservando quebras (retorna texto puro, n√£o HTML)
        function normalizarTextoDiario(texto) {
            if (!texto) return '';
            
            // Normalizar quebras de linha (Windows \r\n, Mac antigo \r, Unicode)
            let normalizado = String(texto)
                .replace(/\r\n/g, '\n') // Windows
                .replace(/\r/g, '\n')   // Mac antigo
                .replace(/\u2028/g, '\n') // Line Separator (Unicode)
                .replace(/\u2029/g, '\n') // Paragraph Separator (Unicode)
                .replace(/\u0085/g, '\n'); // Next Line (Unicode)
            
            // P3: Remover whitespace inicial (causa primeira linha centralizada/deslocada)
            normalizado = normalizado.replace(/^\s+/, '');
            
            return normalizado;
        }
        
        // P4: Formatar texto para exibi√ß√£o (mant√©m compatibilidade, mas prepara para textContent)
        function formatarTextoDiario(texto) {
            // P4: Retornar texto normalizado (ser√° usado com textContent + CSS pre-wrap)
            return normalizarTextoDiario(texto);
        }
        
        function addDias(dateStr, dias) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + dias);
            return d.toISOString().split('T')[0];
        }
        
        function diffEmDias(data1, data2) {
            // data1 e data2 em 'YYYY-MM-DD'
            // retornar data2 - data1 em dias
            const d1 = new Date(data1);
            const d2 = new Date(data2);
            const diffTime = d2 - d1;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // ==================== VRVS 3P - CONSTANTES E FUN√á√ïES AUXILIARES ====================
        
        // Intervalos de est√°gio VRVS 3P (em dias)
        const VRVS3P_STAGE_INTERVALS = [1, 2, 4, 7, 12, 20, 35, 60, 90, 135, 200];
        const VRVS3P_MAX_STAGE = VRVS3P_STAGE_INTERVALS.length - 1; // 10
        
        // Reten√ß√£o estimada por est√°gio (0-10, 0-based como c√≥digo atual)
        const VRVS3P_RETENCAO_POR_ESTAGIO = [
            0.40, // √≠ndice 0 = est√°gio 0 (novo)
            0.55, // √≠ndice 1 = est√°gio 1
            0.65, // √≠ndice 2 = est√°gio 2
            0.72, // √≠ndice 3 = est√°gio 3
            0.78, // √≠ndice 4 = est√°gio 4
            0.83, // √≠ndice 5 = est√°gio 5
            0.88, // √≠ndice 6 = est√°gio 6
            0.92, // √≠ndice 7 = est√°gio 7
            0.95, // √≠ndice 8 = est√°gio 8
            0.97, // √≠ndice 9 = est√°gio 9
            0.98  // √≠ndice 10 = est√°gio 10 (m√°ximo)
        ];
        
        // Obter reten√ß√£o estimada por est√°gio (mant√©m compatibilidade 0-based)
        function obterRetencaoPorEstagio(estagio) {
            const estagioClamped = Math.min(Math.max(estagio || 0, 0), 10);
            return VRVS3P_RETENCAO_POR_ESTAGIO[estagioClamped];
        }
        
        // Classificar faixa de reten√ß√£o (para cores)
        function classificarFaixaRetencao(pct) {
            // pct em 0-1
            if (pct < 0.65) return 'baixa';    // vermelho
            if (pct < 0.80) return 'media';    // √¢mbar
            return 'alta';                     // verde (>= 0.80)
        }
        
        // Mapear repeticoes antigas para est√°gio inicial (migra√ß√£o)
        function mapearRepeticoesParaEstagio(repeticoes) {
            const r = repeticoes || 0;
            if (r <= 0) return 0;
            if (r === 1) return 1;
            if (r === 2) return 2;
            if (r === 3) return 3;
            if (r === 4) return 4;
            return 5; // 5+ vai pro est√°gio 5
        }
        
        // Normalizar qualidade de resposta (blindar entrada)
        function normalizarQualidade(qualidade) {
            if (typeof qualidade === 'number') {
                if (qualidade === 0) return 'esqueci';
                if (qualidade === 1) return 'lembrei';
                if (qualidade === 2) return 'facil';
            }
            if (typeof qualidade === 'string') {
                const q = qualidade.toLowerCase();
                if (q === 'esqueci' || q === 'lembrei' || q === 'facil') return q;
            }
            // fallback seguro: trata como 'esqueci'
            return 'esqueci';
        }
        
        // Inicializar SRS VRVS 3P para nova entrada
        function inicializarSrsVRVS3P(hojeStr) {
            const hoje = hojeStr || hojeStr();
            const intervalo = VRVS3P_STAGE_INTERVALS[0]; // 1 dia
            
            return {
                engine: 'VRVS_FSRS3_v1',
                    ativo: true,
                estagio: 0,
                intervalo: intervalo,
                ultimaRevisaoData: hoje,
                proximaRevisao: addDias(hoje, intervalo),
                ultimaResposta: null,
                    repeticoes: 0,
                facilidade: 2.3,
                historicoRespostas: []
            };
        }
        
        // Atualizar SRS VRVS 3P ap√≥s resposta
        function atualizarSRS_VRVS3P(entrada, resposta) {
            if (!entrada || !entrada.srs || !entrada.srs.ativo) return;
            
            const srs = entrada.srs;
            const hoje = hojeStr();
            let estagio = srs.estagio ?? 0;
            
            // VRVS3P TRANSPAR√äNCIA 01: Capturar est√°gio antes das transi√ß√µes (para hist√≥rico)
            const estagioAntes = estagio;
            
            // Transi√ß√µes de est√°gio conforme resposta
            if (resposta === 'esqueci') {
                if (estagio <= 1) {
                    estagio = 0;
            } else {
                    estagio = estagio - 2;
                }
            } else if (resposta === 'lembrei') {
                estagio = Math.min(estagio + 1, VRVS3P_MAX_STAGE);
            } else if (resposta === 'facil') {
                estagio = Math.min(estagio + 2, VRVS3P_MAX_STAGE);
            } else {
                // resposta inv√°lida ‚Üí n√£o faz nada
                return;
            }
            
            const intervalo = VRVS3P_STAGE_INTERVALS[estagio];
            
            // Atualizar campos do SRS
            srs.estagio = estagio;
            srs.intervalo = intervalo;
            srs.ultimaResposta = resposta;
            srs.ultimaRevisaoData = hoje;
            srs.proximaRevisao = addDias(hoje, intervalo);
            srs.repeticoes = (srs.repeticoes || 0) + 1;
            
            // Atualizar facilidade (opcional, para futuro)
            const fAtual = srs.facilidade ?? 2.3;
            let fNova = fAtual;
            if (resposta === 'esqueci') fNova = fAtual - 0.15;
            if (resposta === 'facil') fNova = fAtual + 0.05;
            srs.facilidade = Math.max(1.3, Math.min(fNova, 3.0));
            
            // VRVS3P TRANSPAR√äNCIA 01: Popular historicoRespostas
            if (!Array.isArray(srs.historicoRespostas)) {
                srs.historicoRespostas = [];
            }
            
            srs.historicoRespostas.push({
                data: hoje,
                resposta: resposta,
                estagioAntes: estagioAntes,
                estagioDepois: estagio,
                intervalo: intervalo,
                facilidade: srs.facilidade,
                timestamp: Date.now()
            });
            
            // Limitar hist√≥rico a √∫ltimos 100 registros (evitar crescimento infinito)
            if (srs.historicoRespostas.length > 100) {
                srs.historicoRespostas = srs.historicoRespostas.slice(-100);
            }
            
            // Garantir que engine est√° definido
            if (!srs.engine) {
                srs.engine = 'VRVS_FSRS3_v1';
            }
        }
        
        // Migrar SRS antigo para VRVS 3P (idempotente)
        function migrarSRSParaVRVS3P() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return;
            
            let migradas = 0;
            window.diario.entradas.forEach(entrada => {
                const srs = entrada.srs;
                if (!srs) return;
                
                // Se j√° est√° na nova vers√£o, n√£o mexe
                if (srs.engine === 'VRVS_FSRS3_v1' && typeof srs.estagio === 'number') {
                    return;
                }
                
                // Migrar: mapear repeticoes ‚Üí estagio
                const estagio = mapearRepeticoesParaEstagio(srs.repeticoes || 0);
                srs.estagio = estagio;
                srs.intervalo = VRVS3P_STAGE_INTERVALS[estagio];
                srs.engine = 'VRVS_FSRS3_v1';
                
                // Garantir facilidade default
                if (typeof srs.facilidade !== 'number') {
                    srs.facilidade = 2.3;
                }
                
                // Se n√£o tem ultimaRevisaoData, usar proximaRevisao como refer√™ncia
                if (!srs.ultimaRevisaoData && srs.proximaRevisao) {
                    // Estimar data da √∫ltima revis√£o baseado no intervalo atual
                    const hoje = hojeStr();
                    const intervaloAtual = srs.intervalo || VRVS3P_STAGE_INTERVALS[estagio];
                    srs.ultimaRevisaoData = addDias(srs.proximaRevisao, -intervaloAtual);
                }
                
                // Garantir historicoRespostas existe
                if (!Array.isArray(srs.historicoRespostas)) {
                    srs.historicoRespostas = [];
                }
                
                migradas++;
            });
            
            if (migradas > 0) {
                salvarDiario(); // Salvar ap√≥s migra√ß√£o
            }
        }
        
        // Estimar reten√ß√£o te√≥rica (para Painel de Reten√ß√£o - Fase 4)
        function estimarRetencao(intervalo, diasDesdeRevisao) {
            // k calibrado pro VRVS 3P (pode ajustar depois)
            const k = 0.1625; // -ln(0.85)
            const x = diasDesdeRevisao / Math.max(intervalo, 1);
            const r = Math.exp(-k * x);
            return Math.max(0, Math.min(1, r));
        }
        
        // Classificar status de revis√£o (em-dia / pendente / atrasado)
        function classificarStatusRevisao(entrada, hojeStr) {
            if (!entrada.srs || !entrada.srs.ativo) return 'inativo';
            
            const hoje = hojeStr || hojeStr();
            const proximaRevisao = entrada.srs.proximaRevisao;
            if (!proximaRevisao) return 'inativo';
            
            const diff = diffEmDias(proximaRevisao, hoje); // hoje - proximaRevisao
            
            if (diff < 0) return 'em-dia';        // ainda n√£o venceu
            if (diff <= entrada.srs.intervalo) return 'pendente'; // leve atraso
            return 'atrasado';                    // muito atrasado
        }
        
        // Mensagem pedag√≥gica baseada em reten√ß√£o global e stats completos
        function mensagemRetencao(retencaoGlobal, stats) {
            // Se stats √© n√∫mero (compatibilidade com chamadas antigas), tratar como totalAtivos
            const totalAtivos = typeof stats === 'number' ? stats : (stats && stats.totalAtivos ? stats.totalAtivos : 0);
            const pendentesHoje = typeof stats === 'object' && stats ? (stats.totalHoje || 0) : 0;
            const atrasados = typeof stats === 'object' && stats ? (stats.totalAtrasadas || 0) : 0;
            const pct = (typeof retencaoGlobal === 'number' ? retencaoGlobal : 0) * 100;
            const temPendencias = (pendentesHoje > 0) || (atrasados > 0);
            
            if (!totalAtivos) {
                return {
                    emoji: '‚ú®',
                    texto: 'Nenhum t√≥pico ativo ainda. Crie entradas no Di√°rio marcando VRVS 3P.',
                    classe: 'neutro'
                };
            }
            
            // Sem pend√™ncias: considerar reten√ß√£o global
            if (!temPendencias) {
                if (pct >= 80) {
                    return {
                        emoji: 'üéØ',
                        texto: 'Excelente ‚Äî em dia e com √≥tima reten√ß√£o.',
                        classe: 'alta'
                    };
                } else if (pct >= 65) {
                    return {
                        emoji: '‚ö°',
                        texto: 'Voc√™ est√° em dia; reten√ß√£o moderada; mantenha o ritmo.',
                        classe: 'media'
                    };
                } else {
                    return {
                        emoji: 'üìö',
                        texto: 'Voc√™ est√° em dia, mas a reten√ß√£o global est√° baixa. Continue revisando para subir a reten√ß√£o.',
                        classe: 'baixa'
                    };
                }
            }
            
            // Com pend√™ncias (hoje ou atrasadas) - N√ÉO pode dizer "tudo em dia"
            if (atrasados > 0) {
                var textoAtrasados = 'Voc√™ tem ' + pendentesHoje + ' t√≥picos para hoje (' + atrasados + ' atrasados). Priorize limpar hoje.';
                return {
                    emoji: '‚è∞',
                    texto: textoAtrasados,
                    classe: 'baixa'
                };
            }
            
            // S√≥ pendentes de hoje (sem atrasados)
            var textoHoje = 'Voc√™ tem ' + pendentesHoje + ' t√≥picos para hoje. Priorize limpar hoje.';
            return {
                emoji: 'üß†',
                texto: textoHoje,
                classe: 'baixa'
            };
        }
        
        // Calcular estat√≠sticas agregadas do Di√°rio VRVS 3P
        function calcularEstatisticasVrvs3p(diario, hojeStrParam) {
            // Se hojeStrParam n√£o foi passado, usar fun√ß√£o hojeStr() ou calcular diretamente
            let hoje;
            if (hojeStrParam) {
                hoje = hojeStrParam;
            } else if (typeof hojeStr === 'function') {
                hoje = hojeStr();
            } else {
                hoje = new Date().toISOString().split('T')[0];
            }
            
            // Inicializar estrutura de retorno
            const stats = {
                totalAtivos: 0,
                totalHoje: 0,
                totalAtrasadas: 0,
                retencaoGlobal: null,
                retencaoGlobalPct: null,
                porArea: [],
                maturidade: {
                    novos: 0,      // est√°gios 0-1
                    fixando: 0,    // est√°gios 2-3
                    maduros: 0,    // est√°gios 4-6
                    consolidados: 0 // est√°gios 7-10
                }
            };
            
            // Validar entrada
            if (!diario || !Array.isArray(diario.entradas) || diario.entradas.length === 0) {
                return stats;
            }
            
            // Filtrar apenas entradas ativas com SRS
            const entradasAtivas = diario.entradas.filter(e => 
                e.srs && 
                e.srs.ativo === true &&
                e.srs.engine === 'VRVS_FSRS3_v1'
            );
            
            stats.totalAtivos = entradasAtivas.length;
            
            if (stats.totalAtivos === 0) {
                return stats;
            }
            
            // Separar novos (nunca revisados) dos revisados
            const entradasNovas = entradasAtivas.filter(e => {
                const srs = e.srs;
                return (srs.repeticoes || 0) === 0 && !srs.ultimaResposta;
            });
            const entradasRevisadas = entradasAtivas.filter(e => {
                const srs = e.srs;
                return (srs.repeticoes || 0) > 0 || !!srs.ultimaResposta;
            });
            
            stats.totalRevisados = entradasRevisadas.length;
            stats.totalNovos = entradasNovas.length;
            
            // Contar t√≥picos para hoje e atrasados (todas as entradas ativas)
            let somaRetencao = 0;
            let contagemRetencao = 0;
            const porAreaMap = {};
            
            // Calcular reten√ß√£o APENAS com entradas revisadas
            entradasRevisadas.forEach(entrada => {
                const srs = entrada.srs;
                const estagio = srs.estagio || 0;
                const proximaRevisao = srs.proximaRevisao || hoje;
                
                // Contar para hoje
                if (proximaRevisao <= hoje) {
                    stats.totalHoje++;
                    
                    // Se muito atrasado (mais que 1 intervalo)
                    const diff = diffEmDias(proximaRevisao, hoje);
                    if (diff > (srs.intervalo || 1)) {
                        stats.totalAtrasadas++;
                    }
                }
                
                // Calcular reten√ß√£o estimada por est√°gio
                const retencaoEstagio = obterRetencaoPorEstagio(estagio);
                somaRetencao += retencaoEstagio;
                contagemRetencao++;
                
                // Agrupar por √°rea
                const area = entrada.area || 'Outros';
                if (!porAreaMap[area]) {
                    porAreaMap[area] = {
                        area: area,
                        total: 0,
                        somaRetencao: 0,
                        hoje: 0,
                        atrasadas: 0
                    };
                }
                porAreaMap[area].total++;
                porAreaMap[area].somaRetencao += retencaoEstagio;
                if (proximaRevisao <= hoje) {
                    porAreaMap[area].hoje++;
                    const diff = diffEmDias(proximaRevisao, hoje);
                    if (diff > (srs.intervalo || 1)) {
                        porAreaMap[area].atrasadas++;
                    }
                }
                
                // Classificar maturidade
                if (estagio <= 1) {
                    stats.maturidade.novos++;
                } else if (estagio <= 3) {
                    stats.maturidade.fixando++;
                } else if (estagio <= 6) {
                    stats.maturidade.maduros++;
                } else {
                    stats.maturidade.consolidados++;
                }
            });
            
            // Calcular reten√ß√£o global (apenas com revisados)
            if (contagemRetencao > 0) {
                stats.retencaoGlobal = somaRetencao / contagemRetencao;
                stats.retencaoGlobalPct = Math.round(stats.retencaoGlobal * 100);
            } else {
                // Se n√£o h√° revisados, reten√ß√£o √© null (n√£o exibir)
                stats.retencaoGlobal = null;
                stats.retencaoGlobalPct = null;
            }
            
            // Contar para hoje e atrasados (todas as entradas ativas)
            entradasAtivas.forEach(entrada => {
                const srs = entrada.srs;
                const proximaRevisao = srs.proximaRevisao || hoje;
                
                // Contar para hoje
                if (proximaRevisao <= hoje) {
                    stats.totalHoje++;
                    
                    // Se muito atrasado (mais que 1 intervalo)
                    const diff = diffEmDias(proximaRevisao, hoje);
                    if (diff > (srs.intervalo || 1)) {
                        stats.totalAtrasadas++;
                    }
                }
                
                // Classificar maturidade
                const estagio = srs.estagio || 0;
                if (estagio <= 1) {
                    stats.maturidade.novos++;
                } else if (estagio <= 3) {
                    stats.maturidade.fixando++;
                } else if (estagio <= 6) {
                    stats.maturidade.maduros++;
                } else {
                    stats.maturidade.consolidados++;
                }
            });
            
            // Processar reten√ß√£o por √°rea
            stats.porArea = Object.keys(porAreaMap).map(area => {
                const item = porAreaMap[area];
                const retencaoMedia = item.total > 0 ? item.somaRetencao / item.total : 0;
                return {
                    area: area,
                    total: item.total,
                    retencao: retencaoMedia,
                    retencaoPct: Math.round(retencaoMedia * 100),
                    hoje: item.hoje,
                    atrasadas: item.atrasadas
                };
            }).sort((a, b) => b.retencao - a.retencao); // Ordenar por reten√ß√£o (maior primeiro)
            
            return stats;
        }
        
        // ==================== FIM VRVS 3P AUXILIARES ====================
        
        // Inicializar SRS em uma entrada (compatibilidade + VRVS 3P)
        function inicializarSrsEntrada(entrada) {
            const hoje = hojeStr();
            if (!entrada.srs) {
                // Nova entrada: usar VRVS 3P padr√£o
                entrada.srs = inicializarSrsVRVS3P(hoje);
            } else {
                // Entrada existente: garantir campos b√°sicos e compatibilidade
                if (typeof entrada.srs.ativo !== 'boolean') entrada.srs.ativo = true;
                if (!entrada.srs.proximaRevisao) entrada.srs.proximaRevisao = hoje;
                if (typeof entrada.srs.repeticoes !== 'number') entrada.srs.repeticoes = 0;
                if (!('ultimaResposta' in entrada.srs)) entrada.srs.ultimaResposta = null;
                
                // Garantir campos VRVS 3P se n√£o existirem (ser√° migrado depois se necess√°rio)
                if (!entrada.srs.engine) {
                    // Se n√£o tem engine, ainda n√£o foi migrado - ser√° migrado em migrarSRSParaVRVS3P()
                } else if (entrada.srs.engine === 'VRVS_FSRS3_v1') {
                    // J√° migrado: garantir campos VRVS 3P
                    if (typeof entrada.srs.estagio !== 'number') entrada.srs.estagio = 0;
                    if (typeof entrada.srs.intervalo !== 'number') entrada.srs.intervalo = VRVS3P_STAGE_INTERVALS[0];
                    if (!entrada.srs.ultimaRevisaoData) entrada.srs.ultimaRevisaoData = hoje;
                    if (typeof entrada.srs.facilidade !== 'number') entrada.srs.facilidade = 2.3;
                    if (!Array.isArray(entrada.srs.historicoRespostas)) entrada.srs.historicoRespostas = [];
                }
            }
        }
        
        // Inicializar SRS em todas as entradas carregadas
        function inicializarSrsEmTodasEntradas() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return;
            window.diario.entradas.forEach(inicializarSrsEntrada);
        }
        
        // Selecionar entradas programadas para HOJE (modo FSRS)
        // Fun√ß√µes auxiliares para ordena√ß√£o hier√°rquica de prioridades VRVS
        function ultimaRespostaFoiEsqueciOntem(entrada, ontem) {
            if (!entrada.srs || !entrada.srs.historicoRespostas) return false;
            
            // Buscar respostas de ontem
            const respostasOntem = entrada.srs.historicoRespostas.filter(r => {
                if (!r.data) return false;
                const dataResposta = normalizarYMDGlobal(r.data);
                return dataResposta === ontem;
            });
            
            if (respostasOntem.length === 0) return false;
            
            // √öltima resposta de ontem foi "esqueci"?
            const ultima = respostasOntem[respostasOntem.length - 1];
            return ultima.resposta === 'esqueci';
        }
        
        function obterNotaPior(entrada) {
            if (!entrada.srs || !entrada.srs.ultimaResposta) return 2; // Default: "lembrei"
            
            const resposta = entrada.srs.ultimaResposta.toLowerCase();
            if (resposta === 'esqueci') return 1; // Pior
            if (resposta === 'lembrei') return 2; // M√©dia
            if (resposta === 'facil') return 3; // Melhor
            
            return 2; // Fallback
        }
        
        function compararPrioridadeVRVS(a, b) {
            const hoje = hojeStrLocal();
            const ontem = ontemStrLocal();
            
            // PRIORIDADE 1: Criados ontem
            const dataA = obterDataCriacaoGlobal(a) || normalizarYMDGlobal(a.data || a.criadoEm) || '0000-00-00';
            const dataB = obterDataCriacaoGlobal(b) || normalizarYMDGlobal(b.data || b.criadoEm) || '0000-00-00';
            const aCriadoOntem = dataA === ontem;
            const bCriadoOntem = dataB === ontem;
            if (aCriadoOntem !== bCriadoOntem) {
                return aCriadoOntem ? -1 : 1; // a primeiro se criado ontem
            }
            
            // PRIORIDADE 2: Esquecidos na sess√£o anterior (ontem)
            const aEsquecidoOntem = ultimaRespostaFoiEsqueciOntem(a, ontem);
            const bEsquecidoOntem = ultimaRespostaFoiEsqueciOntem(b, ontem);
            if (aEsquecidoOntem !== bEsquecidoOntem) {
                return aEsquecidoOntem ? -1 : 1; // a primeiro se esquecido ontem
            }
            
            // PRIORIDADE 3: Pior nota (esqueci < lembrei < facil)
            const notaA = obterNotaPior(a);
            const notaB = obterNotaPior(b);
            if (notaA !== notaB) {
                return notaA - notaB; // menor = pior = primeiro
            }
            
            // PRIORIDADE 4: Mais antigos
            if (dataA !== dataB) {
                return dataA.localeCompare(dataB); // mais antigo primeiro
            }
            
            // PRIORIDADE 5: Menos revis√µes
            const revisoesA = a.srs?.repeticoes || 0;
            const revisoesB = b.srs?.repeticoes || 0;
            return revisoesA - revisoesB; // menos revis√µes primeiro
        }
        
        function getEntradasParaRevisarHojeDiario(filtros) {
            if (!vrvs_isDiarioEnabled()) return [];
            if (!window.diario || !Array.isArray(window.diario.entradas)) return [];
            
            // P1 FIX: Usar data local (timezone do dispositivo, n√£o UTC)
            const hoje = hojeStrLocal();
            
            const resultado = window.diario.entradas.filter(e => {
                // Usar helpers unificados (PATCH 3)
                if (!isSrsActive(e)) return false;
                if (!isDueToday(e, hoje)) return false;
                
                // P1 FIX: Normalizar √°rea tamb√©m (como tema)
                if (filtros.area) {
                    const areaNorm = normalizarTema(e.area);
                    const filtroAreaNorm = normalizarTema(filtros.area);
                    if (areaNorm !== filtroAreaNorm) return false;
                }
                
                // P1: Filtrar por tema usando normaliza√ß√£o (permite varia√ß√µes de case/acentos)
                if (filtros.tema) {
                    const temaNormalizado = normalizarTema(e.tema);
                    const filtroTemaNormalizado = normalizarTema(filtros.tema);
                    if (temaNormalizado !== filtroTemaNormalizado) return false;
                }
                return true;
            });
            
            // Log de debug (FASE 2)
            if (resultado.length > 0) {
                console.log('[VRVS3P-DEBUG] getEntradasParaRevisarHojeDiario:', {
                    total: resultado.length,
                    filtros: filtros,
                    detalhes: resultado.map(e => ({
                        topico: e.topico?.substring(0, 40),
                        proximaRevisao: e.srs?.proximaRevisao
                    }))
                });
            }
            
            return resultado;
        }
        
        // Selecionar entradas para TREINO LIVRE
        function getEntradasTreinoLivreDiario(filtros) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return [];
            return window.diario.entradas.filter(e => {
                const bateArea = !filtros.area || e.area === filtros.area;
                const bateTema = !filtros.tema || e.tema === filtros.tema;
                const bateFonte = !filtros.fonte || filtros.fonte === 'todas' || isSrsActive(e);
                
                // Ajuste 2: Filtro "esquecidos" (robusto: case-insensitive + fallback)
                const bateEsquecidos = !filtros.esquecidos || 
                    (e.srs && e.srs.ativo && String(e.srs.ultimaResposta || '').toLowerCase() === 'esqueci');
                
                return bateArea && bateTema && bateFonte && bateEsquecidos;
            });
        }
        
        // Fun√ß√£o de agendamento com 3 bot√µes (Esqueci / Lembrei / F√°cil) - VRVS 3P
        function registrarRespostaSrsDiario(entrada, qualidade) {
            if (!entrada || !entrada.srs || !entrada.srs.ativo) return;
            
            // Normalizar qualidade e atualizar usando VRVS 3P
            const resposta = normalizarQualidade(qualidade);
            atualizarSRS_VRVS3P(entrada, resposta);
        }
        
        // ==================== SISTEMA DE RASTREAMENTO VRVS 3P (FASE 2) ====================
        
        // Hist√≥rico de execu√ß√µes do algoritmo (√∫ltimas 50)
        window.__VRVS3P_HISTORICO = window.__VRVS3P_HISTORICO || [];
        window.__VRVS3P_CONTADOR = window.__VRVS3P_CONTADOR || { total: 0, porResposta: { esqueci: 0, lembrei: 0, facil: 0 } };
        
        // Backup da fun√ß√£o original
        const atualizarSRS_VRVS3P_ORIGINAL = atualizarSRS_VRVS3P;
        window.atualizarSRS_VRVS3P_ORIGINAL = atualizarSRS_VRVS3P_ORIGINAL; // Backup para refer√™ncia
        
        // Fun√ß√£o wrapper para rastrear execu√ß√µes
        function atualizarSRS_VRVS3P_RASTREADO(entrada, resposta) {
            const inicio = performance.now();
            const estadoAntes = entrada.srs ? JSON.parse(JSON.stringify(entrada.srs)) : null;
            
            // Executar algoritmo original
            atualizarSRS_VRVS3P_ORIGINAL(entrada, resposta);
            
            const fim = performance.now();
            const estadoDepois = entrada.srs ? JSON.parse(JSON.stringify(entrada.srs)) : null;
            
            // Registrar execu√ß√£o
            const registro = {
                timestamp: Date.now(),
                entradaId: entrada.id,
                topico: entrada.topico?.substring(0, 50) || '(sem t√≥pico)',
                area: entrada.area,
                tema: entrada.tema,
                resposta: resposta,
                estadoAntes: estadoAntes,
                estadoDepois: estadoDepois,
                tempoExecucao: fim - inicio,
                proximaRevisaoAntes: estadoAntes?.proximaRevisao,
                proximaRevisaoDepois: estadoDepois?.proximaRevisao,
                estagioAntes: estadoAntes?.estagio,
                estagioDepois: estadoDepois?.estagio
            };
            
            // Adicionar ao hist√≥rico (manter apenas √∫ltimas 50)
            window.__VRVS3P_HISTORICO.push(registro);
            if (window.__VRVS3P_HISTORICO.length > 50) {
                window.__VRVS3P_HISTORICO.shift();
            }
            
            // Atualizar contador
            window.__VRVS3P_CONTADOR.total++;
            if (window.__VRVS3P_CONTADOR.porResposta[resposta] !== undefined) {
                window.__VRVS3P_CONTADOR.porResposta[resposta]++;
            }
            
            // Log estruturado
            console.log('[VRVS3P-DEBUG] Algoritmo executado:', {
                topico: registro.topico,
                resposta: resposta,
                estagio: `${estadoAntes?.estagio ?? 'N/A'} ‚Üí ${estadoDepois?.estagio ?? 'N/A'}`,
                proximaRevisao: `${registro.proximaRevisaoAntes || 'N/A'} ‚Üí ${registro.proximaRevisaoDepois || 'N/A'}`,
                tempo: `${(fim - inicio).toFixed(2)}ms`
            });
            
            return registro;
        }
        
        // ==================== FERRAMENTA DE DEBUG VRVS 3P (FASE 1) ====================
        
        window.debugVRVS3P = {
            // Inspecionar entrada espec√≠fica
            inspecionar: function(textoTopico) {
                const entrada = window.diario?.entradas?.find(e => 
                    e.topico && e.topico.includes(textoTopico)
                );
                if (!entrada) {
                    console.log('‚ùå Entrada n√£o encontrada');
                    return null;
                }
            const hoje = hojeStr();
                const devidaHoje = entrada.atencao || 
                    (entrada.srs?.ativo && entrada.srs.proximaRevisao && entrada.srs.proximaRevisao <= hoje);
                
                console.table({
                    'T√≥pico': entrada.topico?.substring(0, 60),
                    '√Årea': entrada.area,
                    'Tema': entrada.tema,
                    'Aten√ß√£o': entrada.atencao ? '‚ö†Ô∏è SIM' : '‚ùå N√ÉO',
                    'VRVS 3P Ativo': entrada.srs?.ativo ? '‚úÖ SIM' : '‚ùå N√ÉO',
                    'Pr√≥xima Revis√£o': entrada.srs?.proximaRevisao || 'N/A',
                    'Est√°gio': entrada.srs?.estagio ?? 'N/A',
                    'Intervalo': entrada.srs?.intervalo ?? 'N/A',
                    'Repeti√ß√µes': entrada.srs?.repeticoes ?? 0,
                    'Devida Hoje': devidaHoje ? '‚ö†Ô∏è SIM' : '‚ùå N√ÉO',
                    'Data Cria√ß√£o': entrada.data || 'N/A'
                });
                return entrada;
            },
            
            // Comparar entrada com outras do mesmo tema
            compararTema: function(textoTopico) {
                const entrada = window.diario?.entradas?.find(e => 
                    e.topico && e.topico.includes(textoTopico)
                );
                if (!entrada) {
                    console.log('‚ùå Entrada n√£o encontrada');
                    return null;
                }
                
                const mesmoTema = window.diario.entradas.filter(e => 
                    e.area === entrada.area && e.tema === entrada.tema
                );
                
                console.log(`üìä Compara√ß√£o: ${entrada.area} ‚Ä¢ ${entrada.tema}`);
                console.log(`Total de entradas no tema: ${mesmoTema.length}`);
                
                const comparacao = mesmoTema.map(e => ({
                    'T√≥pico': e.topico?.substring(0, 40),
                    'Aten√ß√£o': e.atencao ? '‚ö†Ô∏è' : '‚ùå',
                    'VRVS 3P': e.srs?.ativo ? '‚úÖ' : '‚ùå',
                    'Pr√≥xima Revis√£o': e.srs?.proximaRevisao || 'N/A',
                    'Est√°gio': e.srs?.estagio ?? 'N/A'
                }));
                
                console.table(comparacao);
                
                // An√°lise de diferen√ßas
                const comAtencao = mesmoTema.filter(e => e.atencao).length;
                const comVRVS3P = mesmoTema.filter(e => e.srs?.ativo).length;
                const devidasHoje = mesmoTema.filter(e => {
                    const hoje = hojeStr();
                    return e.atencao || (e.srs?.ativo && e.srs.proximaRevisao && e.srs.proximaRevisao <= hoje);
                }).length;
                
                console.log('\nüìà An√°lise do tema:');
                console.log(`  - Com aten√ß√£o: ${comAtencao}/${mesmoTema.length}`);
                console.log(`  - Com VRVS 3P ativo: ${comVRVS3P}/${mesmoTema.length}`);
                console.log(`  - Devidas hoje: ${devidasHoje}/${mesmoTema.length}`);
                
                return { entrada, mesmoTema, comparacao };
            },
            
            // Listar todas entradas com VRVS 3P ativo
            listarAtivas: function() {
                if (!window.diario?.entradas) {
                    console.log('‚ùå Di√°rio n√£o carregado');
                    return [];
                }
                const ativas = window.diario.entradas.filter(e => e.srs?.ativo);
                console.log(`‚úÖ Total: ${ativas.length} entradas ativas`);
                console.table(ativas.map(e => ({
                    'T√≥pico': e.topico?.substring(0, 50),
                    '√Årea': e.area,
                    'Tema': e.tema,
                    'Pr√≥xima Revis√£o': e.srs?.proximaRevisao,
                    'Est√°gio': e.srs?.estagio,
                    'Intervalo': e.srs?.intervalo
                })));
                return ativas;
            },
            
            // Verificar entradas devidas hoje
            devidasHoje: function() {
                if (!window.diario?.entradas) {
                    console.log('‚ùå Di√°rio n√£o carregado');
                    return [];
                }
                const hoje = hojeStr();
                const devidas = window.diario.entradas.filter(e => {
                    if (e.atencao) return true;
                    if (e.srs?.ativo && e.srs.proximaRevisao) {
                        return e.srs.proximaRevisao <= hoje;
                    }
                    return false;
                });
                console.log(`‚ö†Ô∏è Total: ${devidas.length} entradas devidas hoje`);
                console.table(devidas.map(e => ({
                    'T√≥pico': e.topico?.substring(0, 50),
                    '√Årea': e.area,
                    'Tema': e.tema,
                    'Motivo': e.atencao ? '‚ö†Ô∏è Aten√ß√£o manual' : 'üìÖ VRVS 3P devido',
                    'Pr√≥xima Revis√£o': e.srs?.proximaRevisao || 'N/A'
                })));
                return devidas;
            },
            
            // Comparar sess√£o vs listagem (FASE 4)
            compararSessaoListagem: function() {
                if (!window.diario?.entradas) {
                    console.log('‚ùå Di√°rio n√£o carregado');
                    return null;
                }
                
                const hoje = hojeStr();
                
                // L√≥gica da SESS√ÉO (getEntradasParaRevisarHojeDiario)
                const sessao = window.diario.entradas.filter(e => {
                    if (!e.srs || !e.srs.ativo) return false;
                    const due = e.srs.proximaRevisao || hoje;
                    return due <= hoje;
                });
                
                // L√≥gica da LISTAGEM (renderListaDiario)
                const listagem = window.diario.entradas.filter(e => {
                    if (e.atencao) return true;
                    if (e.srs && e.srs.ativo && e.srs.proximaRevisao) {
                        return e.srs.proximaRevisao <= hoje;
                    }
                    return false;
                });
                
                // Encontrar diferen√ßas
                const apenasSessao = sessao.filter(e => !listagem.find(l => l.id === e.id));
                const apenasListagem = listagem.filter(e => !sessao.find(s => s.id === e.id));
                
                console.log('üîç Compara√ß√£o Sess√£o vs Listagem:');
                console.log(`  Sess√£o: ${sessao.length} entradas`);
                console.log(`  Listagem: ${listagem.length} entradas`);
                console.log(`  Apenas na Sess√£o: ${apenasSessao.length}`);
                console.log(`  Apenas na Listagem: ${apenasListagem.length}`);
                
                if (apenasListagem.length > 0) {
                    console.log('\n‚ö†Ô∏è Entradas que aparecem APENAS na Listagem (prov√°vel causa do bug):');
                    console.table(apenasListagem.map(e => ({
                        'T√≥pico': e.topico?.substring(0, 50),
                        '√Årea': e.area,
                        'Tema': e.tema,
                        'Aten√ß√£o': e.atencao ? '‚ö†Ô∏è SIM' : '‚ùå N√ÉO',
                        'VRVS 3P': e.srs?.ativo ? '‚úÖ SIM' : '‚ùå N√ÉO',
                        'Pr√≥xima Revis√£o': e.srs?.proximaRevisao || 'N/A'
                    })));
                }
                
                return {
                    sessao,
                    listagem,
                    apenasSessao,
                    apenasListagem,
                    inconsistencia: apenasListagem.length > 0 || apenasSessao.length > 0
                };
            },
            
            // Verificar performance (FASE 3)
            performance: function() {
                const inicio = performance.now();
                const ativas = window.diario?.entradas?.filter(e => e.srs?.ativo) || [];
                const fim = performance.now();
                
                const total = window.diario?.entradas?.length || 0;
                const tempoFiltro = fim - inicio;
                
                // Estimar tempo de processamento completo
                const tempoEstimadoCompleto = (tempoFiltro / total) * ativas.length;
                
                console.log('‚ö° Performance VRVS 3P:');
                console.log(`  Total entradas: ${total}`);
                console.log(`  Entradas ativas: ${ativas.length} (${Math.round(ativas.length/total*100)}%)`);
                console.log(`  Tempo de filtro: ${tempoFiltro.toFixed(2)}ms`);
                console.log(`  Tempo estimado processamento completo: ${tempoEstimadoCompleto.toFixed(2)}ms`);
                
                // Verificar hist√≥rico de execu√ß√µes
                const historico = window.__VRVS3P_HISTORICO || [];
                if (historico.length > 0) {
                    const tempoMedio = historico.reduce((sum, r) => sum + r.tempoExecucao, 0) / historico.length;
                    const tempoMaximo = Math.max(...historico.map(r => r.tempoExecucao));
                    console.log(`  Tempo m√©dio por atualiza√ß√£o: ${tempoMedio.toFixed(2)}ms`);
                    console.log(`  Tempo m√°ximo: ${tempoMaximo.toFixed(2)}ms`);
                    console.log(`  Total de execu√ß√µes rastreadas: ${historico.length}`);
                }
                
                // Verificar contador
                const contador = window.__VRVS3P_CONTADOR || { total: 0 };
                console.log(`  Total de atualiza√ß√µes: ${contador.total}`);
                
                return {
                    total,
                    ativas: ativas.length,
                    tempoFiltro,
                    tempoEstimadoCompleto,
                    historico: historico.length,
                    contador: contador.total
                };
            },
            
            // Hist√≥rico de execu√ß√µes (FASE 2)
            historico: function(limite = 10) {
                const historico = window.__VRVS3P_HISTORICO || [];
                const ultimas = historico.slice(-limite);
                
                console.log(`üìú √öltimas ${ultimas.length} execu√ß√µes do algoritmo:`);
                console.table(ultimas.map(r => ({
                    'Hora': new Date(r.timestamp).toLocaleTimeString('pt-BR'),
                    'T√≥pico': r.topico,
                    'Resposta': r.resposta,
                    'Est√°gio': `${r.estagioAntes ?? 'N/A'} ‚Üí ${r.estagioDepois ?? 'N/A'}`,
                    'Pr√≥xima Revis√£o': `${r.proximaRevisaoAntes || 'N/A'} ‚Üí ${r.proximaRevisaoDepois || 'N/A'}`,
                    'Tempo': `${r.tempoExecucao.toFixed(2)}ms`
                })));
                
                return ultimas;
            },
            
            // Validar algoritmo (FASE 2)
            validar: function() {
                console.log('üî¨ Valida√ß√£o do Algoritmo VRVS 3P:');
                
                // Verificar constantes
                const intervalos = VRVS3P_STAGE_INTERVALS;
                const maxStage = VRVS3P_MAX_STAGE;
                
                console.log(`  Intervalos definidos: ${intervalos.length} est√°gios`);
                console.log(`  Est√°gio m√°ximo: ${maxStage}`);
                console.log(`  Intervalos: [${intervalos.join(', ')}]`);
                
                // Verificar se todas as entradas ativas t√™m estrutura correta
                const ativas = window.diario?.entradas?.filter(e => e.srs?.ativo) || [];
                const problemas = [];
                
                ativas.forEach(e => {
                    if (!e.srs.estagio && e.srs.estagio !== 0) {
                        problemas.push({ entrada: e.topico?.substring(0, 30), problema: 'Est√°gio ausente' });
                    }
                    if (!e.srs.intervalo && e.srs.intervalo !== 0) {
                        problemas.push({ entrada: e.topico?.substring(0, 30), problema: 'Intervalo ausente' });
                    }
                    if (e.srs.estagio > maxStage) {
                        problemas.push({ entrada: e.topico?.substring(0, 30), problema: `Est√°gio inv√°lido: ${e.srs.estagio} > ${maxStage}` });
                    }
                    if (!e.srs.proximaRevisao) {
                        problemas.push({ entrada: e.topico?.substring(0, 30), problema: 'Pr√≥xima revis√£o ausente' });
                    }
                });
                
                if (problemas.length > 0) {
                    console.warn(`  ‚ö†Ô∏è Encontrados ${problemas.length} problemas:`);
                    console.table(problemas);
            } else {
                    console.log('  ‚úÖ Todas as entradas ativas t√™m estrutura correta');
                }
                
                // Testar c√°lculo manual
                console.log('\n  üß™ Teste de c√°lculo manual:');
                const hoje = hojeStr();
                const testeEstagio = 3;
                const intervaloEsperado = intervalos[testeEstagio];
                const proximaEsperada = addDias(hoje, intervaloEsperado);
                console.log(`    Est√°gio ${testeEstagio} ‚Üí Intervalo: ${intervaloEsperado} dias ‚Üí Pr√≥xima: ${proximaEsperada}`);
                
                return {
                    intervalos: intervalos.length,
                    maxStage,
                    ativas: ativas.length,
                    problemas: problemas.length,
                    valido: problemas.length === 0
                };
            },
            
            // Teste unit√°rio simples (FASE 2)
            testar: function() {
                console.log('üß™ Teste Unit√°rio do Algoritmo VRVS 3P:');
                
                // Criar entrada de teste
                const entradaTeste = {
                    id: 'teste-' + Date.now(),
                    area: 'Teste',
                    tema: 'Teste',
                    topico: 'T√≥pico de teste',
                    srs: {
                        ativo: true,
                        estagio: 2,
                        intervalo: 4,
                        proximaRevisao: hojeStr(),
                        repeticoes: 0,
                        facilidade: 2.3,
                        engine: 'VRVS_FSRS3_v1'
                    }
                };
                
                const testes = [
                    { resposta: 'esqueci', estagioEsperado: 0, descricao: 'Esqueci (est√°gio 2 ‚Üí 0)' },
                    { resposta: 'lembrei', estagioEsperado: 3, descricao: 'Lembrei (est√°gio 2 ‚Üí 3)' },
                    { resposta: 'facil', estagioEsperado: 4, descricao: 'F√°cil (est√°gio 2 ‚Üí 4)' }
                ];
                
                const resultados = [];
                
                testes.forEach((teste, idx) => {
                    // Resetar entrada
                    entradaTeste.srs.estagio = 2;
                    entradaTeste.srs.intervalo = 4;
                    entradaTeste.srs.proximaRevisao = hojeStr();
                    
                    // Executar
                    atualizarSRS_VRVS3P(entradaTeste, teste.resposta);
                    
                    // Verificar
                    const passou = entradaTeste.srs.estagio === teste.estagioEsperado;
                    resultados.push({
                        teste: teste.descricao,
                        esperado: teste.estagioEsperado,
                        obtido: entradaTeste.srs.estagio,
                        passou: passou ? '‚úÖ' : '‚ùå',
                        intervalo: entradaTeste.srs.intervalo
                    });
                });
                
                console.table(resultados);
                
                const todosPassaram = resultados.every(r => r.passou === '‚úÖ');
                console.log(todosPassaram ? '‚úÖ Todos os testes passaram!' : '‚ùå Alguns testes falharam');
                
                return { resultados, todosPassaram };
            },
            
            // Resumo completo
            resumo: function() {
                console.log('üìä RESUMO COMPLETO VRVS 3P:');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                this.performance();
                console.log('');
                
                const devidas = this.devidasHoje();
                console.log('');
                
                const comparacao = this.compararSessaoListagem();
                console.log('');
                
                const validacao = this.validar();
                
                return {
                    performance: this.performance(),
                    devidasHoje: devidas.length,
                    comparacao,
                    validacao
                };
            }
        };
        
        // ==================== HELPERS VRVS 3P (PATCH 3) ====================
        
        // Predicates unificados para evitar inconsist√™ncias
        function isSrsActive(entrada) {
            return entrada && entrada.srs && entrada.srs.ativo === true;
        }
        
        function isDueToday(entrada, hoje) {
            if (!isSrsActive(entrada)) return false;
            const due = entrada.srs.proximaRevisao || hoje;
            return due <= hoje;
        }
        
        function isAttention(entrada) {
            // PATCH 4: Descontinuado - sempre retorna false (legado removido)
            return false;
        }
        
        function isUpcoming(entrada, hoje, dias = 3) {
            // PATCH 4: Entradas com SRS ativo cuja proximaRevisao est√° nos pr√≥ximos N dias (excluindo hoje)
            if (!isSrsActive(entrada)) return false;
            const proxima = entrada.srs.proximaRevisao;
            if (!proxima) return false;
            const hojeDate = new Date(hoje);
            const proximaDate = new Date(proxima);
            const limiteDate = new Date(hoje);
            limiteDate.setDate(limiteDate.getDate() + dias);
            // Pr√≥xima revis√£o > hoje E <= hoje + dias
            return proximaDate > hojeDate && proximaDate <= limiteDate;
        }
        
        // ==================== FIM SRS ====================
        
        function carregarDiario() {
            try {
                const diarioSalvo = localStorage.getItem(window.vrvs_diarioKey());
                if (diarioSalvo) {
                    // S3K: Migra√ß√£o de schema (array antigo, entries, entradas)
                    let diarioParsed;
                    try {
                        diarioParsed = JSON.parse(diarioSalvo);
                    } catch(e) {
                        console.error('[DI√ÅRIO] Erro ao parsear:', e);
                        diarioParsed = null;
                    }
                    
                    let diarioMigrado = null;
                    
                    // FORMATO ANTIGO 1: Array direto [...]
                    if (Array.isArray(diarioParsed)) {
                        diarioMigrado = { 
                            entradas: diarioParsed, 
                            schemaVersion: DIARIO_SCHEMA_VERSION 
                        };
                    }
                    // FORMATO ANTIGO 2: Objeto com entries (sem entradas)
                    else if (diarioParsed && Array.isArray(diarioParsed.entries) && !Array.isArray(diarioParsed.entradas)) {
                        diarioMigrado = { 
                            ...diarioParsed, 
                            entradas: diarioParsed.entries,
                            schemaVersion: DIARIO_SCHEMA_VERSION 
                        };
                        // Remover entries antigo para evitar confus√£o
                        delete diarioMigrado.entries;
                    }
                    // FORMATO NOVO OK: Objeto com entradas
                    else if (diarioParsed && Array.isArray(diarioParsed.entradas)) {
                        diarioMigrado = diarioParsed;
                        // Garantir schemaVersion se n√£o existir
                        if (!diarioMigrado.schemaVersion) {
                            diarioMigrado.schemaVersion = DIARIO_SCHEMA_VERSION;
                        }
                    }
                    // Fallback: criar estrutura vazia
                    else {
                        diarioMigrado = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                    }
                    
                    window.diario = diarioMigrado;
                    inicializarSrsEmTodasEntradas();
                    migrarSRSParaVRVS3P();
                    
                    // S3K: Salvar migra√ß√£o APENAS se migrou e tem dados
                    if (diarioMigrado && diarioMigrado.entradas && diarioMigrado.entradas.length > 0) {
                        // Verificar se realmente migrou (array ou entries -> entradas)
                        const migrou = Array.isArray(diarioParsed) || 
                                      (diarioParsed && Array.isArray(diarioParsed.entries) && !Array.isArray(diarioParsed.entradas));
                        if (migrou) {
                            try {
                                localStorage.setItem(window.vrvs_diarioKey(), JSON.stringify(diarioMigrado));
                                console.log('[DI√ÅRIO S3K] Migra√ß√£o salva:', diarioMigrado.entradas.length, 'entradas');
                            } catch(e) {
                                console.warn('[DI√ÅRIO S3K] Erro ao salvar migra√ß√£o (quota?):', e);
                            }
                        }
                    }
                } else {
                    window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                    inicializarSrsEmTodasEntradas(); // Seguro mesmo vazio
                }
                // Atualizar chip VRVS 3P e indicadores ap√≥s carregar (PATCH 2)
                atualizarChipVrvs3p();
            } catch (e) {
                console.error('[DI√ÅRIO] Erro ao carregar:', e);
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
                inicializarSrsEmTodasEntradas(); // Seguro mesmo em erro
                atualizarChipVrvs3p();
            }
        }
        
        function salvarDiario() {
            try {
                window.diario.schemaVersion = DIARIO_SCHEMA_VERSION;
                localStorage.setItem(window.vrvs_diarioKey(), JSON.stringify(window.diario));
            } catch (e) {
                console.error('[DI√ÅRIO] Erro ao salvar:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar di√°rio!', 'error');
            }
        }
        
        // Alias para compatibilidade (usado em marcarTodasRevisoes/desmarcarTodasRevisoes)
        if (typeof window.salvarDiarioLS !== 'function') {
            window.salvarDiarioLS = function() { salvarDiario(); };
        }
        
        function setModoDiario(modo) {
            modoDiario = modo;
            
            const btnRecall = document.getElementById('modoRecall');
            const btnRespostas = document.getElementById('modoRespostas');
            const btnRanking = document.getElementById('modoRanking');
            
            // Resetar todos para inativo (usar classes, n√£o inline)
            [btnRecall, btnRespostas, btnRanking].forEach(btn => {
                if (btn) {
                    btn.classList.remove('nivel-2-turquesa', 'nivel-2-ambar', 'nivel-3-ambar', 'active');
                    btn.classList.add('modo-inativo');
                }
            });
            
            // Aplicar estado ativo conforme modo (usar classes)
            if (modo === 'recall' && btnRecall) {
                btnRecall.classList.remove('modo-inativo');
                btnRecall.classList.add('nivel-2-turquesa', 'active');
            } else if (modo === 'respostas' && btnRespostas) {
                btnRespostas.classList.remove('modo-inativo');
                btnRespostas.classList.add('nivel-2-turquesa', 'active');
            } else if (modo === 'ranking' && btnRanking) {
                btnRanking.classList.remove('modo-inativo');
                btnRanking.classList.add('nivel-2-ambar', 'active');
            }
            
            // Renderizar conte√∫do conforme modo
            if (modo === 'ranking') {
                renderRanking();
            } else {
                renderDiario();
            }
        }
        
        // Auto-resize para textarea do T√≥pico
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight + 4) + 'px';
        }
        
        function abrirNovaEntradaDiario() {
            // Limpar flag de edi√ß√£o da sess√£o
            window.editandoDaSessao = false;
            
            // B1-FIX: Resetar flag de imagem ao abrir modal para nova entrada
            if (typeof diario_limparImagemModal === 'function') {
                diario_limparImagemModal();
            }
            window.diario_imagemNovaSelecionada = false; // Garantir estado limpo
            
            // Limpar campos
            document.getElementById('novaDiarioId').value = '';
            document.getElementById('novaDiarioTopico').value = '';
            document.getElementById('novaDiarioResposta').value = '';
            document.getElementById('novaDiarioAtencao').checked = false;
            
            // PATCH 4: Ocultar bot√£o de excluir ao criar nova entrada
            const btnExcluirWrapper = document.getElementById('btnExcluirEntradaWrapper');
            if (btnExcluirWrapper) {
                btnExcluirWrapper.style.display = 'none';
            }
            
            // Renderizar box do Modo Avan√ßado (null = nova entrada, limpa campos)
            diarioModoAvancado_renderBoxDesempenho(null);
            
            // Reabilitar selects (caso tenham sido desabilitados)
            const areaSelect = document.getElementById('novaDiarioArea');
            const temaSelect = document.getElementById('novaDiarioTema');
            if (areaSelect) {
                areaSelect.disabled = false;
                areaSelect.title = '';
            }
            if (temaSelect) {
                temaSelect.disabled = false;
                temaSelect.title = '';
            }
            
            // Definir data padr√£o (hoje)
            const hoje = obterYMDLocal();
            const dataInput = document.getElementById('novaDiarioData');
            if (dataInput) {
                dataInput.value = hoje;
            }
            
            // Configurar auto-resize no campo T√≥pico
            const topicoInput = document.getElementById('novaDiarioTopico');
            if (topicoInput) {
                autoResizeTextarea(topicoInput);
                // Remover listener antigo se existir e adicionar novo
                topicoInput.removeEventListener('input', topicoInput._autoResizeHandler);
                topicoInput._autoResizeHandler = function() {
                    autoResizeTextarea(this);
                };
                topicoInput.addEventListener('input', topicoInput._autoResizeHandler);
            }
            
            // Popular select de √°reas usando helper centralizado
            if (areaSelect) {
                const areasExistentes = getAreasDisponiveisDoPerfilAtivo();
                areaSelect.innerHTML = '<option value="">Selecione...</option>';
                areasExistentes.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                areaSelect.value = ''; // Limpar sele√ß√£o
            }
            
            // Limpar select de temas
            if (temaSelect) {
                temaSelect.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
            }
            
            // Mostrar modal
            document.getElementById('modalNovaDiario').classList.add('active');
        }
        
        function atualizarTemasDiario(areaSelecionada) {
            const temaSelect = document.getElementById('novaDiarioTema');
            if (!temaSelect || !areaSelecionada) {
                if (temaSelect) {
                    temaSelect.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                }
                return;
            }
            
            // Filtrar temas da √°rea selecionada
            const temasDaArea = dados
                .filter(t => t.area === areaSelecionada && t.status !== 'Suspenso')
                .map(t => t.tema)
                .filter((tema, index, self) => self.indexOf(tema) === index) // Remover duplicatas
                .sort();
            
            // Popular select
            temaSelect.innerHTML = '<option value="">Selecione...</option>';
            temasDaArea.forEach(tema => {
                const option = document.createElement('option');
                option.value = tema;
                option.textContent = tema;
                temaSelect.appendChild(option);
            });
        }
        
        function fecharModalDiario() {
            document.getElementById('modalNovaDiario').classList.remove('active');
            // B1: Limpar imagem da resposta ao fechar modal
            if (typeof diario_limparImagemModal === 'function') {
                diario_limparImagemModal();
            }
            // MP1: Limpar imagem da pergunta ao fechar modal
            if (typeof diario_limparImagemPerguntaModal === 'function') {
                diario_limparImagemPerguntaModal();
            }
            
            // Limpar flag de edi√ß√£o da sess√£o e reabilitar selects
            if (window.editandoDaSessao) {
                window.editandoDaSessao = false;
                const areaSelect = document.getElementById('novaDiarioArea');
                const temaSelect = document.getElementById('novaDiarioTema');
                if (areaSelect) {
                    areaSelect.disabled = false;
                    areaSelect.title = '';
                }
                if (temaSelect) {
                    temaSelect.disabled = false;
                    temaSelect.title = '';
                }
            }
        }
        
        async function salvarEntradaDiario() {
            // S3M: Hardening - garantir que window.diario existe e est√° v√°lido
            const _SV = (typeof DIARIO_SCHEMA_VERSION !== 'undefined') ? DIARIO_SCHEMA_VERSION : '1.0';
            if (!window.diario || typeof window.diario !== 'object') window.diario = { entradas: [], schemaVersion: _SV };
            if (!Array.isArray(window.diario.entradas)) window.diario.entradas = [];
            if (!window.diario.schemaVersion) window.diario.schemaVersion = _SV;
            
            try {
                const entradaId = document.getElementById('novaDiarioId')?.value;
                const veioDaSessao = window.editandoDaSessao === true;
                
                const areaSelect = document.getElementById('novaDiarioArea');
                const temaSelect = document.getElementById('novaDiarioTema');
                
                // Se for edi√ß√£o e veio da sess√£o, usar valores originais da entrada para √°rea/tema
                let area, tema;
                if (entradaId && veioDaSessao) {
                    const entradaOriginal = window.diario.entradas.find(e => String(e.id) === entradaId);
                    if (entradaOriginal) {
                        // Usar valores originais da entrada (campos est√£o desabilitados)
                        area = entradaOriginal.area || '';
                        tema = entradaOriginal.tema || '';
                    } else {
                        // Fallback: ler dos campos mesmo desabilitados
                        area = areaSelect?.value.trim() || '';
                        tema = temaSelect?.value.trim() || '';
                    }
                } else {
                    // Edi√ß√£o normal ou nova entrada: ler dos campos
                    area = areaSelect?.value.trim() || '';
                    tema = temaSelect?.value.trim() || '';
                }
                
                const topico = document.getElementById('novaDiarioTopico')?.value.trim();
                const resposta = document.getElementById('novaDiarioResposta')?.value.trim();
                // PATCH 4: Checkbox agora controla APENAS VRVS 3P (n√£o atencao)
                const incluirVRVS3P = document.getElementById('novaDiarioAtencao')?.checked || false;
            const dataInput = document.getElementById('novaDiarioData');
            const data = dataInput ? dataInput.value : obterYMDLocal();
            
                // Valida√ß√£o: √°rea e tema s√£o obrigat√≥rios
            if (!area || !tema || !topico) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha pelo menos √Årea, Tema e T√≥pico!', 'error');
                    // SEMPRE limpar flag e fechar modal mesmo em erro
                    window.editandoDaSessao = false;
                return;
            }
            
            const hoje = obterYMDLocal();
            
            // B1: Gerar ID √∫nico UMA vez (para entrada e keys)
            const id = entradaId ? Number(entradaId) : Date.now();
            
            // B1: Processar imagem da RESPOSTA se houver
            let imagemData = null;
            // MP1: Processar imagem da PERGUNTA se houver
            let imagemPerguntaData = null;
            // B1-FIX: S√≥ gerar imagemData se usu√°rio realmente selecionou nova imagem
            if (typeof diario_imagemNovaSelecionada !== 'undefined' && diario_imagemNovaSelecionada === true &&
                typeof diario_imagemBlobAtual !== 'undefined' && diario_imagemBlobAtual && 
                typeof diario_imagemMetadataAtual !== 'undefined' && diario_imagemMetadataAtual) {
                try {
                    // Gerar thumbnail
                    const thumbBlob = await diario_gerarThumbnail(diario_imagemBlobAtual);
                    
                    // Salvar imagem completa e thumbnail no IndexedDB (usar ID √∫nico)
                    const fullKey = `diario:${id}:full`;
                    const thumbKey = `diario:${id}:thumb`;
                    
                    await b0Img_putBlob(fullKey, diario_imagemBlobAtual);
                    await b0Img_putBlob(thumbKey, thumbBlob);
                    
                    // Criar objeto imagem para salvar no data model
                    imagemData = {
                        thumbKey: thumbKey,
                        fullKey: fullKey,
                        tipo: diario_imagemMetadataAtual.tipo,
                        tamanho: diario_imagemMetadataAtual.tamanho,
                        largura: diario_imagemMetadataAtual.largura,
                        altura: diario_imagemMetadataAtual.altura,
                        dataAdicao: hoje
                    };
                    
                } catch (error) {
                    // PATCH: S√≥ mostrar toast se realmente havia tentativa de salvar imagem
                    if (typeof diario_imagemNovaSelecionada !== 'undefined' && diario_imagemNovaSelecionada === true &&
                        typeof diario_imagemBlobAtual !== 'undefined' && diario_imagemBlobAtual) {
                        mostrarNotificacaoFeedback(`‚ö†Ô∏è Erro ao salvar imagem: ${error.message}`, 'error');
                    }
                    // Continuar salvando entrada mesmo se imagem falhar
                }
            } else if (typeof diario_imagemRemovida !== 'undefined' && diario_imagemRemovida && entradaId) {
                // Se flag de remo√ß√£o est√° true e √© edi√ß√£o, remover imagem antiga
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (entrada && entrada.imagem) {
                    try {
                        if (entrada.imagem.fullKey) await b0Img_deleteKey(entrada.imagem.fullKey);
                        if (entrada.imagem.thumbKey) await b0Img_deleteKey(entrada.imagem.thumbKey);
                    } catch (error) {
                        console.error('Erro ao remover imagem:', error);
                        // Continuar salvando entrada mesmo se remo√ß√£o falhar
                    }
                    imagemData = null; // Marcar para remover do data model
                }
            }
            
            // MP1: Processar imagem da PERGUNTA se houver
            if (typeof diario_imagemPerguntaNovaSelecionada !== 'undefined' && diario_imagemPerguntaNovaSelecionada === true &&
                typeof diario_imagemPerguntaBlobAtual !== 'undefined' && diario_imagemPerguntaBlobAtual && 
                typeof diario_imagemPerguntaMetadataAtual !== 'undefined' && diario_imagemPerguntaMetadataAtual) {
                try {
                    // Gerar thumbnail
                    const thumbBlob = await diario_gerarThumbnail(diario_imagemPerguntaBlobAtual);
                    
                    // Salvar imagem completa e thumbnail no IndexedDB (usar ID √∫nico com sufixo :pergunta)
                    const fullKey = `diario:${id}:pergunta:full`;
                    const thumbKey = `diario:${id}:pergunta:thumb`;
                    
                    await b0Img_putBlob(fullKey, diario_imagemPerguntaBlobAtual);
                    await b0Img_putBlob(thumbKey, thumbBlob);
                    
                    // Criar objeto imagem para salvar no data model
                    imagemPerguntaData = {
                        thumbKey: thumbKey,
                        fullKey: fullKey,
                        tipo: diario_imagemPerguntaMetadataAtual.tipo,
                        tamanho: diario_imagemPerguntaMetadataAtual.tamanho,
                        largura: diario_imagemPerguntaMetadataAtual.largura,
                        altura: diario_imagemPerguntaMetadataAtual.altura,
                        dataAdicao: hoje
                    };
                    
                } catch (error) {
                    if (typeof diario_imagemPerguntaNovaSelecionada !== 'undefined' && diario_imagemPerguntaNovaSelecionada === true &&
                        typeof diario_imagemPerguntaBlobAtual !== 'undefined' && diario_imagemPerguntaBlobAtual) {
                        mostrarNotificacaoFeedback(`‚ö†Ô∏è Erro ao salvar imagem da pergunta: ${error.message}`, 'error');
                    }
                    // Continuar salvando entrada mesmo se imagem falhar
                }
            } else if (typeof diario_imagemPerguntaRemovida !== 'undefined' && diario_imagemPerguntaRemovida && entradaId) {
                // Se flag de remo√ß√£o est√° true e √© edi√ß√£o, remover imagem antiga da pergunta
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (entrada && entrada.imagemPergunta) {
                    try {
                        if (entrada.imagemPergunta.fullKey) await b0Img_deleteKey(entrada.imagemPergunta.fullKey);
                        if (entrada.imagemPergunta.thumbKey) await b0Img_deleteKey(entrada.imagemPergunta.thumbKey);
                    } catch (error) {
                        console.error('Erro ao remover imagem da pergunta:', error);
                    }
                    imagemPerguntaData = null; // Marcar para remover do data model
                }
            }
            
            // B1-FIX: Resetar flag ap√≥s processar (sucesso ou falha)
            window.diario_imagemNovaSelecionada = false;
            // MP1: Resetar flag da pergunta ap√≥s processar
            window.diario_imagemPerguntaNovaSelecionada = false;
            
            // Salvar nota e observa√ß√£o do Modo Avan√ßado (BUG 3 CORRIGIDO: s√≥ salva se touched)
            let notaDesempenho = null;
            let obsDesempenho = null;
            
            if (modoAvancado_getAtivo()) {
                const slider = document.getElementById('novaDiarioNotaDesempenho');
                const obs = document.getElementById('novaDiarioObsDesempenho');
                
                // BUG 3: S√≥ salvar se usu√°rio mexeu no slider
                if (slider && slider.dataset.touched === '1') {
                    const nota = parseFloat(slider.value);
                    if (!isNaN(nota) && nota >= 0 && nota <= 10) {
                        notaDesempenho = nota;
                    }
                }
                
                if (obs && obs.value.trim()) {
                    obsDesempenho = obs.value.trim();
                }
            }
            
            if (entradaId) {
                // Editar entrada existente
                const entrada = window.diario.entradas.find(e => String(e.id) === entradaId);
                if (entrada) {
                    // Se veio da sess√£o, s√≥ atualizar topico e resposta (√°rea/tema desabilitados)
                    if (veioDaSessao === true) {
                        entrada.topico = topico;
                        entrada.resposta = resposta;
                        entrada.ultimaAtualizacao = hoje;
                        // Modo Avan√ßado: atualizar nota/obs mesmo vindo da sess√£o
                        entrada.notaDesempenho = notaDesempenho;
                        entrada.obsDesempenho = obsDesempenho;
                        // N√ÉO mexer em √°rea, tema, atencao, data
                        // N√ÉO resetar SRS (manter est√°gio, intervalo, proximaRevisao, historicoRespostas)
                        
                        // S1-FIX: Atualizar imagem se houver nova sele√ß√£o ou remo√ß√£o (reutilizar l√≥gica do bloco else)
                        if (imagemData) {
                            // Nova imagem: remover antiga APENAS se keys forem diferentes
                            if (entrada.imagem) {
                                // S1-FIX: Comparar keys antes de deletar (prevenir auto-delete)
                                const keysDiferentes = entrada.imagem.fullKey !== imagemData.fullKey || 
                                                       entrada.imagem.thumbKey !== imagemData.thumbKey;
                                
                                if (keysDiferentes) {
                                    // Keys diferentes: deletar antigas antes de salvar novas
                                    try {
                                        if (entrada.imagem.fullKey) await b0Img_deleteKey(entrada.imagem.fullKey);
                                        if (entrada.imagem.thumbKey) await b0Img_deleteKey(entrada.imagem.thumbKey);
                                    } catch (error) {
                                        console.error('Erro ao remover imagem antiga:', error);
                                    }
                                }
                                // Se keys forem iguais, n√£o deletar (putBlob j√° sobrescreveu)
                            }
                            entrada.imagem = imagemData;
                        } else if (typeof diario_imagemRemovida !== 'undefined' && diario_imagemRemovida) {
                            // Flag expl√≠cita: remover imagem
                            if (entrada.imagem) {
                                try {
                                    if (entrada.imagem.fullKey) await b0Img_deleteKey(entrada.imagem.fullKey);
                                    if (entrada.imagem.thumbKey) await b0Img_deleteKey(entrada.imagem.thumbKey);
                                } catch (error) {
                                    console.error('Erro ao remover imagem:', error);
                                }
                            }
                            entrada.imagem = null;
                        } else {
                            // S1-FIX: Se n√£o tem imagemData e flag n√£o est√° true, MANTER imagem existente
                            // N√£o fazer nada - entrada.imagem j√° est√° preservado
                        }
                        
                        // MP1: Atualizar imagem da PERGUNTA se houver nova sele√ß√£o ou remo√ß√£o
                        if (imagemPerguntaData) {
                            // Nova imagem: remover antiga APENAS se keys forem diferentes
                            if (entrada.imagemPergunta) {
                                const keysDiferentes = entrada.imagemPergunta.fullKey !== imagemPerguntaData.fullKey || 
                                                       entrada.imagemPergunta.thumbKey !== imagemPerguntaData.thumbKey;
                                
                                if (keysDiferentes) {
                                    try {
                                        if (entrada.imagemPergunta.fullKey) await b0Img_deleteKey(entrada.imagemPergunta.fullKey);
                                        if (entrada.imagemPergunta.thumbKey) await b0Img_deleteKey(entrada.imagemPergunta.thumbKey);
                                    } catch (error) {
                                        console.error('Erro ao remover imagem antiga da pergunta:', error);
                                    }
                                }
                            }
                            entrada.imagemPergunta = imagemPerguntaData;
                        } else if (typeof diario_imagemPerguntaRemovida !== 'undefined' && diario_imagemPerguntaRemovida) {
                            // Flag expl√≠cita: remover imagem da pergunta
                            if (entrada.imagemPergunta) {
                                try {
                                    if (entrada.imagemPergunta.fullKey) await b0Img_deleteKey(entrada.imagemPergunta.fullKey);
                                    if (entrada.imagemPergunta.thumbKey) await b0Img_deleteKey(entrada.imagemPergunta.thumbKey);
                                } catch (error) {
                                    console.error('Erro ao remover imagem da pergunta:', error);
                                }
                            }
                            entrada.imagemPergunta = null;
                        } else {
                            // Se n√£o tem imagemPerguntaData e flag n√£o est√° true, MANTER imagem existente
                            // N√£o fazer nada - entrada.imagemPergunta j√° est√° preservado
                        }
                    } else {
                        // Edi√ß√£o normal da Lista: atualizar tudo
                    // BUG C: Normalizar quebras de linha Unicode antes de salvar
                    const respostaNormalizada = String(resposta || '')
                        .replace(/\u2028/g, '\n')
                        .replace(/\u2029/g, '\n')
                        .replace(/\u0085/g, '\n');
                    entrada.area = area;
                    entrada.tema = tema;
                    entrada.topico = topico;
                    entrada.resposta = respostaNormalizada;
                    // Modo Avan√ßado: atualizar nota/obs
                    entrada.notaDesempenho = notaDesempenho;
                    entrada.obsDesempenho = obsDesempenho;
                    // PATCH 4: N√£o setar atencao (legado removido)
                    entrada.data = data; // Usar data do campo
                    entrada.ultimaAtualizacao = hoje;
                    // B1: Atualizar imagem usando flag expl√≠cita
                    if (imagemData) {
                        // Nova imagem: remover antiga APENAS se keys forem diferentes
                        if (entrada.imagem) {
                            // B1-FIX: Comparar keys antes de deletar (prevenir auto-delete)
                            const keysDiferentes = entrada.imagem.fullKey !== imagemData.fullKey || 
                                                   entrada.imagem.thumbKey !== imagemData.thumbKey;
                            
                            if (keysDiferentes) {
                                // Keys diferentes: deletar antigas antes de salvar novas
                                try {
                                    if (entrada.imagem.fullKey) await b0Img_deleteKey(entrada.imagem.fullKey);
                                    if (entrada.imagem.thumbKey) await b0Img_deleteKey(entrada.imagem.thumbKey);
                                } catch (error) {
                                    console.error('Erro ao remover imagem antiga:', error);
                                }
                            }
                            // Se keys forem iguais, n√£o deletar (putBlob j√° sobrescreveu)
                        }
                        entrada.imagem = imagemData;
                    } else if (typeof diario_imagemRemovida !== 'undefined' && diario_imagemRemovida) {
                        // Flag expl√≠cita: remover imagem
                        if (entrada.imagem) {
                            try {
                                if (entrada.imagem.fullKey) await b0Img_deleteKey(entrada.imagem.fullKey);
                                if (entrada.imagem.thumbKey) await b0Img_deleteKey(entrada.imagem.thumbKey);
                            } catch (error) {
                                console.error('Erro ao remover imagem:', error);
                            }
                        }
                        entrada.imagem = null;
                    } else {
                        // B1-FIX: Se n√£o tem imagemData e flag n√£o est√° true, MANTER imagem existente
                        // N√£o fazer nada - entrada.imagem j√° est√° preservado
                        if (!entrada.imagem) {
                            entrada.imagem = null;
                        }
                    }
                    
                    // MP1: Atualizar imagem da PERGUNTA se houver nova sele√ß√£o ou remo√ß√£o
                    if (imagemPerguntaData) {
                        // Nova imagem: remover antiga APENAS se keys forem diferentes
                        if (entrada.imagemPergunta) {
                            const keysDiferentes = entrada.imagemPergunta.fullKey !== imagemPerguntaData.fullKey || 
                                                   entrada.imagemPergunta.thumbKey !== imagemPerguntaData.thumbKey;
                            
                            if (keysDiferentes) {
                                try {
                                    if (entrada.imagemPergunta.fullKey) await b0Img_deleteKey(entrada.imagemPergunta.fullKey);
                                    if (entrada.imagemPergunta.thumbKey) await b0Img_deleteKey(entrada.imagemPergunta.thumbKey);
                                } catch (error) {
                                    console.error('Erro ao remover imagem antiga da pergunta:', error);
                                }
                            }
                        }
                        entrada.imagemPergunta = imagemPerguntaData;
                    } else if (typeof diario_imagemPerguntaRemovida !== 'undefined' && diario_imagemPerguntaRemovida) {
                        // Flag expl√≠cita: remover imagem da pergunta
                        if (entrada.imagemPergunta) {
                            try {
                                if (entrada.imagemPergunta.fullKey) await b0Img_deleteKey(entrada.imagemPergunta.fullKey);
                                if (entrada.imagemPergunta.thumbKey) await b0Img_deleteKey(entrada.imagemPergunta.thumbKey);
                            } catch (error) {
                                console.error('Erro ao remover imagem da pergunta:', error);
                            }
                        }
                        entrada.imagemPergunta = null;
                    } else {
                        // Se n√£o tem imagemPerguntaData e flag n√£o est√° true, MANTER imagem existente
                        // N√£o fazer nada - entrada.imagemPergunta j√° est√° preservado
                        if (!entrada.imagemPergunta) {
                            entrada.imagemPergunta = null;
                        }
                    }
                        
                        // PATCH 4: Gerenciar SRS conforme checkbox (APENAS VRVS 3P, n√£o atencao)
                        if (incluirVRVS3P) {
                            // Se marcado e n√£o tem SRS, criar; se j√° tem, garantir que est√° ativo
                            if (!entrada.srs) {
                                entrada.srs = inicializarSrsVRVS3P(hoje);
                            } else {
                                entrada.srs.ativo = true;
                                // Garantir campos VRVS 3P se n√£o existirem
                                if (!entrada.srs.engine || entrada.srs.engine !== 'VRVS_FSRS3_v1') {
                                    // Migrar se necess√°rio (ser√° feito na pr√≥xima carga, mas garantir aqui tamb√©m)
                                    if (!entrada.srs.engine) {
                                        const estagio = mapearRepeticoesParaEstagio(entrada.srs.repeticoes || 0);
                                        entrada.srs.estagio = estagio;
                                        entrada.srs.intervalo = VRVS3P_STAGE_INTERVALS[estagio];
                                        entrada.srs.engine = 'VRVS_FSRS3_v1';
                                        if (typeof entrada.srs.facilidade !== 'number') entrada.srs.facilidade = 2.3;
                                        if (!Array.isArray(entrada.srs.historicoRespostas)) entrada.srs.historicoRespostas = [];
                                        if (!entrada.srs.ultimaRevisaoData) entrada.srs.ultimaRevisaoData = hoje;
                                    }
                                }
                            }
                        } else {
                            // Se desmarcado, desativar SRS (mas n√£o deletar para manter hist√≥rico)
                            if (entrada.srs) {
                                entrada.srs.ativo = false;
                            }
                        }
                    }
                }
            } else {
                // Nova entrada
                // BUG C: Normalizar quebras de linha Unicode antes de salvar
                const respostaNormalizada = String(resposta || '')
                    .replace(/\u2028/g, '\n')
                    .replace(/\u2029/g, '\n')
                    .replace(/\u0085/g, '\n');
                const novaEntrada = {
                    id: id,  // B1: Usar ID √∫nico gerado acima (n√£o Date.now() novamente)
                    data: data, // Usar data do campo
                    area: area,
                    tema: tema,
                    topico: topico,
                    resposta: respostaNormalizada,
                    // Modo Avan√ßado: adicionar nota/obs
                    notaDesempenho: notaDesempenho,
                    obsDesempenho: obsDesempenho,
                    // PATCH 4: N√£o setar atencao (legado removido)
                    criadoEm: hoje,
                    ultimaAtualizacao: hoje,
                    imagem: imagemData || null,  // B1: Adicionar campo imagem (RESPOSTA)
                    imagemPergunta: imagemPerguntaData || null  // MP1: Adicionar campo imagem (PERGUNTA)
                };
                
                // PATCH 4: Se checkbox marcado, inicializar SRS VRVS 3P; sen√£o, n√£o criar SRS
                if (incluirVRVS3P) {
                    novaEntrada.srs = inicializarSrsVRVS3P(hoje);
                } else {
                    // N√£o criar SRS se checkbox n√£o marcado
                    novaEntrada.srs = null;
                }
                
                window.diario.entradas.push(novaEntrada);
            }
            
            salvarDiario();
            
            // B1: Limpar imagem ap√≥s salvar
            if (typeof diario_limparImagemModal === 'function') {
                diario_limparImagemModal();
            }
            // MP1: Limpar imagem da pergunta ap√≥s salvar
            if (typeof diario_limparImagemPerguntaModal === 'function') {
                diario_limparImagemPerguntaModal();
            }
                
                // Verificar se veio da sess√£o (j√° declarado acima, apenas usar)
                const veioDaSessaoFlag = veioDaSessao;
                
                // Limpar flag
                window.editandoDaSessao = false;
                
                // Fechar modal antes de renderizar (evita conflito visual)
            fecharModalDiario();
                
                // S3: Salvar ID da entrada editada antes de re-renderizar
                const entradaIdSalva = entradaId || id; // Usar ID da entrada salva
                window.diario_lastSavedId = entradaIdSalva; // Guardar globalmente
                
                // Pequeno delay para garantir que modal fechou antes de renderizar (especialmente mobile)
                setTimeout(() => {
                    if (veioDaSessaoFlag) {
                        // Treino Livre: re-renderizar runner correto e recarregar thumbnail
                        const tlAtivo = !!(window.treinoLivreEstado?.ativo && window.treinoLivreFila && Number.isInteger(window.treinoLivreEstado?.indiceAtual));

                        if (tlAtivo) {
                            renderTreinoLivreRunner();

                            const indice = window.treinoLivreEstado.indiceAtual;
                            const entradaAtual = window.treinoLivreFila && window.treinoLivreFila[indice];

                            if (entradaAtual && entradaAtual.id) {
                                setTimeout(() => {
                                    diario_carregarThumbnailUnico(
                                        entradaAtual.id,
                                        null,
                                        `tl-thumb-img-${entradaAtual.id}`,
                                        `tl-thumb-wrap-${entradaAtual.id}`
                                    );
                                }, 50);
                            }

                        } else {
                            // Sess√£o programada (comportamento atual)
                            const entradaAtual = getEntradaAtualSessao();
                            if (entradaAtual) {
                                renderSessaoDiario(entradaAtual);
                            }
                        }
                    } else {
                        // Edi√ß√£o normal: renderizar lista completa
                        
                        // S3-FIX: Capturar estado antes de re-renderizar
                        const diarioContainer = document.getElementById('diarioContainer');
                        const scrollEl = document.scrollingElement || document.documentElement;
                        const scrollTopAntes = scrollEl ? scrollEl.scrollTop : 0;
                        const gruposAbertosAntes = new Set();
                        
                        if (diarioContainer) {
                            diarioContainer.querySelectorAll('.area-content:not(.collapsed)[id^="area-content-"]').forEach(el => {
                                const id = el.id.replace('area-content-', '');
                                if (id) gruposAbertosAntes.add(id);
                            });
                        }
                        
                        // S3-FIX: Helper local para abrir grupo
                        const ensureOpen = (id) => {
                            const content = document.getElementById('area-content-' + id);
                            const header = document.querySelector("div[onclick=\"toggleAreaCaderno('" + id + "')\"]");
                            
                            if (content) {
                                content.classList.remove('collapsed');
                                if (content.style.display === 'none') {
                                    content.style.display = '';
                                }
                            }
                            
                            if (header) {
                                header.classList.remove('collapsed');
                                const t = header.querySelector('.area-header-toggle');
                                if (t) {
                                    t.textContent = '‚ñ≤';
                                }
                            }
                        };
                        
                        renderDiario();
                        
                        // S3-FIX: Restaurar grupos abertos imediatamente ap√≥s renderizar
                        gruposAbertosAntes.forEach(ensureOpen);
                        
                        // S3-FIX: Ap√≥s renderizar, voltar para o card salvo (abrindo ancestrais antes)
                        if (window.diario_lastSavedId) {
                            setTimeout(() => {
                                // Reabrir grupos capturados (garante layout)
                                gruposAbertosAntes.forEach(ensureOpen);
                                
                                const cardElement = document.querySelector(`[data-diario-id="${window.diario_lastSavedId}"]`);
                                
                                if (cardElement) {
                                    // Abrir ancestrais colapsados do card antes de scrollIntoView
                                    let p = cardElement.closest('.area-content');
                                    while (p) {
                                        if (p.classList.contains('collapsed') && p.id.startsWith('area-content-')) {
                                            const pid = p.id.replace('area-content-', '');
                                            if (pid) ensureOpen(pid);
                                        }
                                        p = p.parentElement ? p.parentElement.closest('.area-content') : null;
                                    }
                                    
                                    // S√≥ ent√£o fazer scrollIntoView
                                    cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                } else {
                                    // Fallback: restaurar scroll anterior
                                    if (scrollEl) scrollEl.scrollTop = scrollTopAntes;
                                }
                                
                                // Limpar flag ap√≥s usar
                                window.diario_lastSavedId = null;
                            }, 100); // Delay para garantir DOM pronto
                        } else {
                            // Se n√£o h√° lastSavedId, restaurar scroll anterior
                            setTimeout(() => {
                                if (scrollEl) scrollEl.scrollTop = scrollTopAntes;
                            }, 100);
                        }
                    }
                    // Atualizar chip VRVS 3P e indicadores ap√≥s salvar (PATCH 2)
                    atualizarChipVrvs3p();
            mostrarNotificacaoFeedback('‚úÖ Entrada salva com sucesso!');
                }, 50);
            } catch (error) {
                console.error('[DI√ÅRIO] Erro ao salvar entrada:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao salvar entrada. Verifique o console.', 'error');
                // SEMPRE limpar flag e fechar modal mesmo em erro
                window.editandoDaSessao = false;
                fecharModalDiario();
            }
        }
        
        function salvarEContinuarDiario() {
            salvarEntradaDiario();
            setTimeout(() => {
                abrirNovaEntradaDiario();
            }, 300);
        }
        
        // PATCH 2: Atualizar indicadores VRVS 3P no cabe√ßalho
        // PATCH 4: Substitu√≠do contador "aten√ß√£o" por "pr√≥ximas"
        function atualizarIndicadoresDiario() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            
            const hoje = hojeStr();
            const entradas = window.diario.entradas || [];
            
            // Contar usando helpers unificados (PATCH 3)
            const countAtivos = entradas.filter(e => isSrsActive(e)).length;
            const countHoje = entradas.filter(e => isDueToday(e, hoje)).length;
            // PATCH 4: Substitu√≠do countAtencao por countProximas
            const countProximas = entradas.filter(e => isUpcoming(e, hoje, 3)).length;
            
            // Atualizar elementos HTML
            const elAtivos = document.getElementById('diarioCountAtivos');
            const elHoje = document.getElementById('diarioCountHoje');
            const elProximas = document.getElementById('diarioCountProximas');
            
            if (elAtivos) elAtivos.textContent = countAtivos;
            if (elHoje) elHoje.textContent = countHoje;
            if (elProximas) elProximas.textContent = countProximas;
        }
        
        // Atualizar chip VRVS 3P no Di√°rio
        function atualizarChipVrvs3p() {
            const chip = document.getElementById('vrvs3p-chip-diario');
            const chipText = document.getElementById('vrvs3p-chip-text');
            if (!chip || !chipText) return;
            
            // Garantir que window.diario existe (se n√£o, inicializar vazio)
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            const hoje = hojeStr();
            const stats = calcularEstatisticasVrvs3p(window.diario || { entradas: [] }, hoje);
            
            let texto;
            
            if (!stats || stats.totalAtivos === 0) {
                // Nenhum t√≥pico ativo
                texto = 'üß† Nenhum ativo';
            } else {
                const totalAtivos = stats.totalAtivos || 0;
                const pendentesHoje = stats.totalHoje || 0;
                const atrasados = stats.totalAtrasadas || 0;
                
                if (pendentesHoje === 0 && atrasados === 0) {
                    // Tudo em dia: nenhum hoje, nenhum atrasado
                    texto = `üß† ${totalAtivos} ativos ¬∑ ‚úÖ em dia`;
                } else {
                    // Formato padr√£o
                    texto = `üß† ${totalAtivos} ativos ¬∑ ${pendentesHoje} hoje`;
                    if (atrasados > 0) {
                        texto += ` ¬∑ ${atrasados} ‚ö†Ô∏è`;
                    }
                }
            }
            
            chipText.textContent = texto;
            chip.style.display = 'inline-flex';
            
            // PATCH 2: Atualizar indicadores tamb√©m
            atualizarIndicadoresDiario();
        }
        
        // Navegar para painel VRVS 3P
        function irParaPainelVrvs3p() {
            // Ir para aba Analytics (n√£o analises)
            showSection('analytics');
            // Garantir que est√° na sub-aba Resumo
            setTimeout(() => {
                setVistaAnalytics('resumo');
                // Scroll at√© o painel ap√≥s renderizar e expandir se estiver colapsado
                setTimeout(() => {
                    const painel = document.getElementById('painel-vrvs3p');
                    if (painel) {
                        // Se estiver colapsado, expandir antes de fazer scroll
                        if (painel.classList.contains('vrvs3p-collapsed')) {
                            togglePainelVrvs3p();
                        }
                        painel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.warn('[VRVS3P] Painel n√£o encontrado ap√≥s navega√ß√£o');
                    }
                }, 200);
            }, 100);
        }
        
        // Toggle do painel VRVS 3P (colaps√°vel)
        function togglePainelVrvs3p() {
            const painel = document.getElementById('painel-vrvs3p');
            const body = painel ? painel.querySelector('.vrvs3p-body') : null;
            const caret = painel ? painel.querySelector('.vrvs3p-caret') : null;
            
            if (painel && body) {
                // P2: Preservar scroll antes do toggle (usar padr√£o do Di√°rio que funciona)
                const scrollEl = document.scrollingElement || document.documentElement;
                const scrollTopAntes = scrollEl ? scrollEl.scrollTop : 0;
                
                painel.classList.toggle('vrvs3p-collapsed');
                
                // Rotacionar caret
                if (caret) {
                    if (painel.classList.contains('vrvs3p-collapsed')) {
                        caret.style.transform = 'rotate(-90deg)';
                    } else {
                        caret.style.transform = 'rotate(0deg)';
                    }
                }
                
                // P2: Restaurar scroll ap√≥s toggle (usar padr√£o do Di√°rio: setTimeout direto, atribui√ß√£o direta)
                setTimeout(() => {
                    if (scrollEl) scrollEl.scrollTop = scrollTopAntes;
                }, 100);
                
                // P2: Rede de seguran√ßa (iOS pode aplicar scroll autom√°tico depois)
                setTimeout(() => {
                    if (scrollEl) scrollEl.scrollTop = scrollTopAntes;
                }, 250);
            }
        }
        
        function renderDiario() {
            // Renderizar UI do Modo Avan√ßado (badge + bot√£o ranking)
            diarioModoAvancado_renderUI();
            
            // Se modo √© ranking e modo avan√ßado est√° ativo, renderizar ranking
            if (modoDiario === 'ranking' && modoAvancado_getAtivo()) {
                renderRanking();
                return;
            }
            
            // AJUSTE EXTRA: Garantir que "Revisar Hoje" aparece quando n√£o est√° em ranking
            const revisarHoje = document.getElementById('diarioRevisarHoje');
            if (revisarHoje) revisarHoje.style.display = '';
            
            // S6-NAV-FIX2: Prevenir m√∫ltiplas renderiza√ß√µes simult√¢neas
            if (window.diarioRenderando) {
                return; // J√° est√° renderizando, ignorar chamada
            }
            
            window.diarioRenderando = true;
            
            try {
                const container = document.getElementById('diarioContainer');
                if (!container) {
                    window.diarioRenderando = false;
                    return;
                }
            
            // Atualizar chip VRVS 3P e indicadores (PATCH 2)
            atualizarChipVrvs3p();
            
            if (!window.diario || !window.diario.entradas || window.diario.entradas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada no di√°rio ainda</div><div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.5);">Clique em "+ Nova" para adicionar</div></div>';
                
                // Esconder se√ß√£o "Revisar Hoje"
                const revisarHoje = document.getElementById('diarioRevisarHoje');
                if (revisarHoje) revisarHoje.style.display = 'none';
                
                window.diarioRenderando = false; // S6-NAV-FIX2: Liberar flag antes de return
                return;
            }
            
            const filtroVista = document.getElementById('filtroDiarioVista')?.value || 'data';
            const filtroArea = document.getElementById('filtroDiarioArea')?.value || '';
            const filtroData = document.getElementById('filtroDiarioData')?.value || '';
            
            // Atualizar select de √°reas
            const areaSelect = document.getElementById('filtroDiarioArea');
            if (areaSelect) {
                const areas = [...new Set(window.diario.entradas.map(e => e.area))].sort();
                areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
                });
                if (filtroArea) areaSelect.value = filtroArea;
            }
            
            // Filtrar entradas
            let entradasFiltradas = window.diario.entradas;
            
            if (filtroArea) {
                entradasFiltradas = entradasFiltradas.filter(e => e.area === filtroArea);
            }
            
            if (filtroData) {
                entradasFiltradas = entradasFiltradas.filter(e => e.data === filtroData);
            }
            
            // PATCH 1: Remover bloco separado "Revisar Hoje" - tudo fica agrupado por tema
            // N√£o criar bloco separado, n√£o remover entradas da lista principal
            const hoje = hojeStr();
            
            // Esconder se√ß√£o "Revisar Hoje" (n√£o ser√° mais usada)
            const revisarHoje = document.getElementById('diarioRevisarHoje');
            if (revisarHoje) {
                revisarHoje.style.display = 'none';
            }
            
            // HOTFIX S6-DIARIO-TRAVA: Remover limparBuscaDiario() que causava loop recursivo
            // A busca deve ser limpa apenas quando o usu√°rio explicitamente limpar ou mudar filtros
            // N√£o limpar automaticamente ao renderizar para evitar loop infinito
            
            // PATCH: Capturar estado de grupos abertos ANTES de renderizar
            const gruposAbertosAntes = new Set();
            if (container) {
                container.querySelectorAll('.area-content:not(.collapsed)[id^="area-content-"]').forEach(el => {
                    const id = el.id.replace('area-content-', '');
                    if (id) gruposAbertosAntes.add(id);
                });
            }
            
            if (filtroVista === 'data') {
                renderDiarioPorData(entradasFiltradas, container, gruposAbertosAntes);
            } else {
                renderDiarioPorTema(entradasFiltradas, container, gruposAbertosAntes);
            }
            
            // PATCH: Restaurar grupos abertos ap√≥s renderizar
            requestAnimationFrame(() => {
                gruposAbertosAntes.forEach(id => {
                    const content = document.getElementById('area-content-' + id);
                    const header = document.querySelector("div[onclick=\"toggleAreaCaderno('" + id + "')\"]");
                    if (content) {
                        content.classList.remove('collapsed');
                        if (content.style.display === 'none') {
                            content.style.display = '';
                        }
                    }
                    if (header) {
                        header.classList.remove('collapsed');
                        const t = header.querySelector('.area-header-toggle');
                        if (t) {
                            t.textContent = '‚ñ≤';
                        }
                    }
                });
            });
            } finally {
                // S6-NAV-FIX2: Sempre liberar flag, mesmo em caso de erro
                window.diarioRenderando = false;
            }
        }
        
        function renderRanking() {
            const container = document.getElementById('diarioContainer');
            if (!container) return;
            
            if (!modoAvancado_getAtivo()) {
                container.innerHTML = '<div class="empty-state">Modo Avan√ßado desativado</div>';
                return;
            }
            
            const revisarHoje = document.getElementById('diarioRevisarHoje');
            if (revisarHoje) revisarHoje.style.display = 'none';
            
            const entradas = window.diario?.entradas || [];
            const ordem = modoAvancado_getRankingOrdem();
            
            // BUG 1 CORRIGIDO: nota 0 √© v√°lida
            const comNota = entradas.filter(e => typeof e.notaDesempenho === 'number' && !isNaN(e.notaDesempenho));
            const semNota = entradas.filter(e => e.notaDesempenho == null || typeof e.notaDesempenho !== 'number' || isNaN(e.notaDesempenho));
            
            // AJUSTE OPCIONAL: remover || 0 do sort (comNota j√° filtra numbers v√°lidos)
            comNota.sort((a, b) => {
                return ordem === 'asc' ? a.notaDesempenho - b.notaDesempenho : b.notaDesempenho - a.notaDesempenho;
            });
            
            // BUG 2 CORRIGIDO: spread operator correto
            const todasOrdenadas = [...comNota, ...semNota];
            
            if (todasOrdenadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada encontrada</div></div>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,184,77,0.05); border-radius: 10px; border: 1px solid rgba(255,184,77,0.2);">
                    <h4 style="color: rgba(255,184,77,0.9); font-size: 14px; margin: 0; display: flex; align-items: center; gap: 8px;">üèÜ Desempenho por Caso</h4>
                    <button onclick="modoAvancado_toggleRankingOrdem()" style="font-size: 11px; color: rgba(255,255,255,0.6); background: rgba(0,0,0,0.3); padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; touch-action: manipulation;">
                        ${ordem === 'asc' ? '‚Üë Pior ‚Üí Melhor' : '‚Üì Melhor ‚Üí Pior'}
                    </button>
                </div>
            `;
            
            todasOrdenadas.forEach((entrada, idx) => {
                const posicao = idx + 1;
                const nota = entrada.notaDesempenho;
                const temNota = typeof nota === 'number' && !isNaN(nota);
                const notaStr = temNota ? nota.toFixed(1) : '‚Äî';
                
                // Determinar faixa (usar classes CSS)
                let faixaClass = '';
                
                if (temNota) {
                    if (nota < 5) {
                        faixaClass = 'faixa-baixa';
                    } else if (nota >= 5 && nota < 7) {
                        faixaClass = 'faixa-media';
                    } else {
                        faixaClass = 'faixa-alta';
                    }
                }
                
                // Parse seguro de data
                const dataEntrada = entrada.data || entrada.ultimaAtualizacao || obterYMDLocal();
                const hoje = obterYMDLocal();
                const diasAtras = calcularDiasEntreDatas(dataEntrada, hoje);
                const diasStr = diasAtras === 0 ? 'hoje' : diasAtras === 1 ? 'h√° 1 dia' : `h√° ${diasAtras} dias`;
                
                html += `
                    <div onclick="editarEntradaDiario('${entrada.id}')" class="${faixaClass}" style="display: flex; gap: 14px; align-items: flex-start; padding: 18px; border-radius: 18px; margin-bottom: 12px; cursor: pointer; touch-action: manipulation;">
                        <div class="rank-badge" style="width: 36px; height: 36px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 800; flex-shrink: 0;">
                            ${posicao}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h5 style="font-size: 15px; font-weight: 600; margin: 0 0 4px 0; color: rgba(255,255,255,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${vrvs_escapeHTML(entrada.topico || 'Sem t√≠tulo')}</h5>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: ${entrada.obsDesempenho ? '6px' : '0'};">
                                ${vrvs_escapeHTML(entrada.area || '')} ‚Ä¢ ${vrvs_escapeHTML(entrada.tema || '')} ‚Ä¢ ${diasStr}
                            </div>
                            ${entrada.obsDesempenho ? `<div class="obs-desempenho">‚ö† ${vrvs_escapeHTML(entrada.obsDesempenho)}</div>` : ''}
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <div class="nota-display" style="font-size: 26px; font-weight: 800; line-height: 1;">
                                ${notaStr}
                            </div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">nota</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderDiarioPorData(entradas, container, gruposAbertosAntes = new Set()) {
            /* === PATCH 2 - ORDENA√á√ÉO POR DATA (31/12/2025) === */
            const parseData = (entrada) => {
                try {
                    const d = entrada.criadoEm || entrada.data || '1970-01-01';
                    const t = new Date(d).getTime();
                    return Number.isFinite(t) ? t : 0;
                } catch (e) {
                    return 0;
                }
            };
            const entradasOrdenadas = [...entradas].sort((a, b) => parseData(b) - parseData(a));
            entradas = entradasOrdenadas; // <- importante: garante uso da lista ordenada
            /* === FIM PATCH 2 === */
            
            // Agrupar por data (usar entradasOrdenadas) - manter ordem dentro de cada grupo
            const porData = {};
            entradasOrdenadas.forEach(e => {
                if (!porData[e.data]) porData[e.data] = [];
                porData[e.data].push(e);
            });
            
            /* === PATCH ORDENA√á√ÉO COM DESEMPATE POR ID (31/12/2025) === */
            const cmp = (a, b) => {
                const diff = parseData(b) - parseData(a);
                if (diff !== 0) return diff;
                return (Number(b.id) || 0) - (Number(a.id) || 0); // desempate: mais novo primeiro
            };
            // ordena cada grupo por "mais recente"
            Object.keys(porData).forEach(k => porData[k].sort(cmp));
            /* === FIM PATCH DESEMPATE === */
            
            // Ordenar grupos por criadoEm da primeira entrada (mais recente primeiro)
            const datasOrdenadas = Object.keys(porData).sort((a, b) => {
                // Pegar primeira entrada de cada grupo (j√° est√° ordenada por criadoEm)
                const primeiraA = porData[a][0];
                const primeiraB = porData[b][0];
                return parseData(primeiraB) - parseData(primeiraA); // Mais recente primeiro
            });
            
            if (datasOrdenadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada encontrada</div></div>';
                return;
            }
            
            let html = '';
            datasOrdenadas.forEach((data, idx) => {
                const dataId = `diario-data-${data.replace(/-/g, '')}`;
                const estaAberta = gruposAbertosAntes.has(dataId);
                html += `<div style="margin-bottom: 24px;">
                    <div class="area-header ${estaAberta ? '' : 'collapsed'}" onclick="toggleAreaCaderno('${dataId}')" style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìÖ ${formatarDataCompleta(data)}</span>
                            <span class="area-header-count">${porData[data].length} entrada${porData[data].length > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">${estaAberta ? '‚ñ≤' : '‚ñº'}</span>
                    </div>
                    <div class="area-content ${estaAberta ? '' : 'collapsed'}" id="area-content-${dataId}">
                        ${porData[data].map(e => renderEntradaDiario(e)).join('')}
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            // B2: Carregar thumbnails ap√≥s renderizar
            setTimeout(() => diario_carregarThumbnails(), 100);
        }
        
        function renderDiarioPorTema(entradas, container, gruposAbertosAntes = new Set()) {
            /* === PATCH 2 - ORDENA√á√ÉO POR DATA (31/12/2025) === */
            const parseData = (entrada) => {
                try {
                    const d = entrada.criadoEm || entrada.data || '1970-01-01';
                    const t = new Date(d).getTime();
                    return Number.isFinite(t) ? t : 0;
                } catch (e) {
                    return 0;
                }
            };
            const entradasOrdenadas = [...entradas].sort((a, b) => parseData(b) - parseData(a));
            entradas = entradasOrdenadas; // <- importante: garante uso da lista ordenada
            /* === FIM PATCH 2 === */
            
            // CORRE√á√ÉO: Agrupar primeiro por √ÅREA, depois por TEMA dentro de cada √°rea
            // A1b: Dedupe por nome normalizado (case/acentos) para evitar duplica√ß√£o
            // BUG A2: Dedupe singular/plural usando normalizarTemaKey
            // PATCH 2: Manter ordem de entradasOrdenadas dentro de cada grupo
            const porArea = {};
            entradasOrdenadas.forEach(e => {
                // BUG A2: Usar normalizarTemaKey para agrupamento (singulariza "fraturas" -> "fratura")
                const temaKey = normalizarTemaKey(e.tema) || String(e.id); // Fallback para ID se tema vazio
                
                // HOTFIX: Usar √°rea ORIGINAL como chave (n√£o normalizada) para evitar quebra
                // TODO: Reimplementar normaliza√ß√£o de √°rea de forma segura ap√≥s estabilizar
                const areaKey = e.area;
                if (!porArea[areaKey]) porArea[areaKey] = {};
                
                // Se j√° existe tema com mesma chave normalizada na √°rea, agrupar
                if (!porArea[areaKey][temaKey]) {
                    porArea[areaKey][temaKey] = {
                        temaOriginal: e.tema, // Primeiro tema encontrado (ser√° substitu√≠do se houver plural)
                        variantes: [], // BUG A2: Armazenar todas as variantes originais
                        entradas: []
                    };
                }
                // BUG A2: Armazenar variante original
                if (!porArea[areaKey][temaKey].variantes.includes(e.tema)) {
                    porArea[areaKey][temaKey].variantes.push(e.tema);
                }
                porArea[areaKey][temaKey].entradas.push(e);
            });
            
            // BUG A2: Escolher temaOriginal preferindo plural ap√≥s agrupamento
            Object.keys(porArea).forEach(areaKey => {
                Object.keys(porArea[areaKey]).forEach(temaKey => {
                    const grupo = porArea[areaKey][temaKey];
                    // Procurar variante que come√ßa com "Fraturas" (case-insensitive)
                    const variantePlural = grupo.variantes.find(v => 
                        v.toLowerCase().trim().startsWith('fraturas')
                    );
                    if (variantePlural) {
                        grupo.temaOriginal = variantePlural; // Preferir plural
                    }
                    // Sen√£o, manter primeiro temaOriginal (j√° definido acima)
                });
            });
            
            const areasOrdenadas = Object.keys(porArea).sort();
            
            if (areasOrdenadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma entrada encontrada</div></div>';
                return;
            }
            
            let html = '';
            areasOrdenadas.forEach(areaKey => {
                // HOTFIX: areaKey agora √© a √°rea original (n√£o normalizada), ent√£o usar diretamente
                const areaId = `diario-area-${areaKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const temasDaArea = Object.keys(porArea[areaKey]).sort();
                
                // HOTFIX: Verificar se porArea[areaKey] existe e tem temas antes de acessar
                if (!porArea[areaKey] || temasDaArea.length === 0) {
                    console.warn('[DI√ÅRIO] √Årea sem temas:', areaKey);
                    return; // Pular esta √°rea se estiver vazia
                }
                
                const totalEntradasArea = temasDaArea.reduce((sum, temaKey) => {
                    if (!porArea[areaKey][temaKey]) return sum;
                    return sum + (porArea[areaKey][temaKey].entradas?.length || 0);
                }, 0);
                
                // Box da √ÅREA (colaps√°vel)
                const areaEstaAberta = gruposAbertosAntes.has(areaId);
                html += `<div style="margin-bottom: 24px;">
                    <div class="area-header ${areaEstaAberta ? '' : 'collapsed'}" onclick="toggleAreaCaderno('${areaId}')" style="cursor: pointer; padding: 8px 0; margin-bottom: 8px;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìÅ ${areaKey}</span>
                            <span class="area-header-count">${totalEntradasArea} entrada${totalEntradasArea > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">${areaEstaAberta ? '‚ñ≤' : '‚ñº'}</span>
                    </div>
                    <div class="area-content ${areaEstaAberta ? '' : 'collapsed'}" id="area-content-${areaId}">`;
                
                // Temas dentro da √°rea (tamb√©m colaps√°veis) - ordenar por temaOriginal
                const temasOrdenados = temasDaArea.sort((a, b) => {
                    const temaA = porArea[areaKey][a]?.temaOriginal || '';
                    const temaB = porArea[areaKey][b]?.temaOriginal || '';
                    return temaA.localeCompare(temaB, 'pt-BR');
                });
                
                temasOrdenados.forEach(temaKey => {
                    const grupoTema = porArea[areaKey][temaKey];
                    if (!grupoTema || !grupoTema.entradas) {
                        console.warn('[DI√ÅRIO] Grupo tema inv√°lido:', areaKey, temaKey);
                        return; // Pular se grupo inv√°lido
                    }
                    
                    const temaOriginal = grupoTema.temaOriginal || temaKey;
                    const temaId = `diario-tema-${areaKey.replace(/[^a-zA-Z0-9]/g, '-')}-${temaKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    
                    /* === PATCH ORDENA√á√ÉO COM DESEMPATE POR ID (31/12/2025) === */
                    const cmp = (a, b) => {
                        const diff = parseData(b) - parseData(a);
                        if (diff !== 0) return diff;
                        return (Number(b.id) || 0) - (Number(a.id) || 0); // desempate: mais novo primeiro
                    };
                    grupoTema.entradas.sort(cmp);
                    /* === FIM PATCH DESEMPATE === */
                    
                    const temaEstaAberto = gruposAbertosAntes.has(temaId);
                    html += `
                        <div style="margin-bottom: 16px; margin-left: 12px;">
                            <div class="area-header ${temaEstaAberto ? '' : 'collapsed'}" onclick="toggleAreaCaderno('${temaId}')" style="cursor: pointer; padding: 6px 0; margin-bottom: 6px;">
                                <div class="area-header-left">
                                    <span class="area-header-title">üìÑ ${temaOriginal}</span>
                                    <span class="area-header-count">${grupoTema.entradas.length} entrada${grupoTema.entradas.length > 1 ? 's' : ''}</span>
                        </div>
                        <span class="area-header-toggle">${temaEstaAberto ? '‚ñ≤' : '‚ñº'}</span>
                    </div>
                    <div class="area-content ${temaEstaAberto ? '' : 'collapsed'}" id="area-content-${temaId}">
                                ${grupoTema.entradas.map(e => renderEntradaDiario(e)).join('')}
                    </div>
                </div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            // B2: Carregar thumbnails ap√≥s renderizar
            setTimeout(() => diario_carregarThumbnails(), 100);
        }
        
        function renderEntradaDiario(entrada) {
            const mostrarResposta = modoDiario === 'respostas';
            const hoje = hojeStr();
            
            // PATCH 1: Chips visuais (s√≥ mostrar os que se aplicam)
            // PATCH 4: Removido chip ‚ö†Ô∏è (legado atencao)
            const chips = [];
            if (isSrsActive(entrada)) {
                chips.push('<span style="font-size: 14px;" title="VRVS 3P ativo">üß†</span>');
            }
            if (isDueToday(entrada, hoje)) {
                chips.push('<span style="font-size: 14px;" title="Para revisar hoje">‚è∞</span>');
            }
            const chipsHTML = chips.length > 0 ? `<div style="display: flex; gap: 4px; align-items: center; margin-bottom: 4px;">${chips.join('')}</div>` : '';
            
            return `
                <div class="diario-entrada-card" data-diario-id="${entrada.id}" data-busca-topico="${(entrada.topico || '').toLowerCase()}" data-busca-tema="${(entrada.tema || '').toLowerCase()}" data-busca-area="${(entrada.area || '').toLowerCase()}" style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 14px; margin-bottom: 12px; border: 1px solid rgba(255,127,80,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 4px;">
                                ${entrada.area} ‚Ä¢ ${entrada.tema}
                            </div>
                            ${chipsHTML}
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobre-light); margin-bottom: 8px; display: block; border-bottom: 1px solid rgba(0, 206, 209, 0.2); padding-bottom: 8px; white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-word;">‚ùì ${formatarTextoDiario(entrada.topico)}</div>
                            ${entrada.imagemPergunta && entrada.imagemPergunta.thumbKey ? `<div id="diario-img-pergunta-thumb-${entrada.id}" style="margin-top: 8px; margin-bottom: 8px; cursor: pointer;" onclick="diario_abrirViewerImagemPergunta(${entrada.id})"><img id="diario-img-pergunta-${entrada.id}" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="toggleRevisaoDiario(${entrada.id}, this)" class="btn-toggle-revisao" data-entrada-id="${entrada.id}" title="${entrada.srs && entrada.srs.ativo ? 'Desativar revis√£o' : 'Ativar revis√£o'}" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: rgba(255, 255, 255, 0.9); cursor: pointer; font-size: 12px; padding: 4px 8px; transition: all 0.2s;">${entrada.srs && entrada.srs.ativo ? '‚úÖ ON' : '‚ö™ OFF'}</button>
                            <button onclick="(async () => { await editarEntradaDiario(${entrada.id}); })()" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 14px; padding: 4px 8px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${mostrarResposta && entrada.resposta ? `
                        <div style="background: rgba(0,206,209,0.1); border-left: 3px solid var(--turquesa-main); padding: 10px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                            <span style="font-size: 13px;">‚úÖ</span><br>
                            <span style="white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-word;">${formatarTextoDiario(entrada.resposta)}</span>
                            ${entrada.imagem && entrada.imagem.thumbKey ? `<div id="diario-img-thumb-${entrada.id}" style="margin-top: 12px; cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})"><img id="diario-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                        </div>
                    ` : mostrarResposta ? `
                        <div style="color: rgba(255,255,255,0.5); font-size: 12px; font-style: italic; margin-top: 8px;">
                            (Sem resposta ainda)
                        </div>
                        ${entrada.imagem && entrada.imagem.thumbKey ? `<div id="diario-img-thumb-${entrada.id}" style="margin-top: 12px; cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})"><img id="diario-img-${entrada.id}" src="" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" onerror="this.style.display='none';" /></div>` : ''}
                    ` : `
                        <button onclick="toggleRespostaIndividual(${entrada.id})" style="background: rgba(0,206,209,0.15); border: 1px solid rgba(0,206,209,0.3); color: var(--turquesa-light); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px;">
                            üëÅÔ∏è Ver Resposta
                        </button>
                        <div id="resposta_${entrada.id}" style="display: none; background: rgba(0,206,209,0.1); border-left: 3px solid var(--turquesa-main); padding: 10px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                            <span style="font-size: 13px;">‚úÖ</span><br>
                            <span style="white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-word;">${entrada.resposta ? formatarTextoDiario(entrada.resposta) : '(Sem resposta ainda)'}</span>
                            ${entrada.imagem && entrada.imagem.thumbKey ? `<div id="diario-img-thumb-${entrada.id}" style="margin-top: 12px; cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})"><img id="diario-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                        </div>
                    `}
                    ${gerarBadgeSRS(entrada)}
                </div>
            `;
        }
        
        // B2: Carregar thumbnails ap√≥s renderizar
        async function diario_carregarThumbnails() {
            const cards = document.querySelectorAll('[data-diario-id]');
            for (const card of cards) {
                const entradaId = card.getAttribute('data-diario-id');
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (!entrada) continue;
                
                // Carregar imagem da RESPOSTA (existente)
                const imgElement = document.getElementById(`diario-img-${entradaId}`);
                if (imgElement && imgElement.dataset.loaded !== '1') {
                    if (entrada.imagem && entrada.imagem.thumbKey) {
                        try {
                            const thumbBlob = await b0Img_getBlob(entrada.imagem.thumbKey);
                            if (thumbBlob) {
                                const thumbURL = URL.createObjectURL(thumbBlob);
                                imgElement.src = thumbURL;
                                imgElement.dataset.loaded = '1';
                                imgElement.style.display = 'block';
                                imgElement.onerror = () => {
                                    URL.revokeObjectURL(thumbURL);
                                    imgElement.style.display = 'none';
                                    imgElement.dataset.loaded = '';
                                };
                            }
                        } catch (error) {
                            console.error('Erro ao carregar thumbnail resposta:', error);
                            imgElement.style.display = 'none';
                            imgElement.dataset.loaded = '';
                        }
                    } else {
                        imgElement.style.display = 'none';
                    }
                }
                
                // Carregar imagem da PERGUNTA (novo)
                const imgPerguntaElement = document.getElementById(`diario-img-pergunta-${entradaId}`);
                if (imgPerguntaElement && imgPerguntaElement.dataset.loaded !== '1') {
                    if (entrada.imagemPergunta && entrada.imagemPergunta.thumbKey) {
                        try {
                            const thumbBlob = await b0Img_getBlob(entrada.imagemPergunta.thumbKey);
                            if (thumbBlob) {
                                const thumbURL = URL.createObjectURL(thumbBlob);
                                imgPerguntaElement.src = thumbURL;
                                imgPerguntaElement.dataset.loaded = '1';
                                imgPerguntaElement.style.display = 'block';
                                imgPerguntaElement.onerror = () => {
                                    URL.revokeObjectURL(thumbURL);
                                    imgPerguntaElement.style.display = 'none';
                                    imgPerguntaElement.dataset.loaded = '';
                                };
                            }
                        } catch (error) {
                            console.error('Erro ao carregar thumbnail pergunta:', error);
                            imgPerguntaElement.style.display = 'none';
                            imgPerguntaElement.dataset.loaded = '';
                        }
                    } else {
                        imgPerguntaElement.style.display = 'none';
                    }
                }
            }
        }
        
        // S4: Busca no Di√°rio (t√≥pico + tema + √°rea)
        // S3E: REMOVIDO: usar window.diarioBuscaTimeout (evita TDZ) - declarado globalmente cedo
        // S3D: REMOVIDO: usar window.diarioBuscaRAF (evita TDZ) - declarado globalmente cedo
        // S3E: REMOVIDO: usar window.diarioChipVrvs3pTimeout (evita TDZ) - declarado globalmente cedo
        // S3E: REMOVIDO: usar window.diarioRenderando (evita TDZ) - declarado globalmente cedo
        
        function filtrarDiarioPorBusca() {
            const buscaInput = document.getElementById('filtroDiarioBusca');
            const btnLimpar = document.getElementById('btnLimparBuscaDiario');
            const resultadosDiv = document.getElementById('diarioBuscaResultados');
            const contadorEl = document.getElementById('diarioBuscaContador');
            
            if (!buscaInput) return;
            
            const termo = buscaInput.value.trim().toLowerCase();
            
            // Mostrar/ocultar bot√£o limpar
            if (btnLimpar) {
                btnLimpar.style.display = termo ? 'inline-block' : 'none';
            }
            
            // Debounce 200ms
            clearTimeout(window.diarioBuscaTimeout);
            window.diarioBuscaTimeout = setTimeout(() => {
                if (!termo) {
                    // S4-MICRO: termo vazio (backspace) deve normalizar 100% sem trocar vista
                    if (resultadosDiv) resultadosDiv.style.display = 'none';
                    
                    // Re-render completo para desfazer wrappers/grupos ocultados pela busca
                    if (typeof renderDiario === 'function') {
                        renderDiario();
                    } else {
                        // fallback ultra m√≠nimo: mostrar todos os cards (se renderDiario n√£o existir por algum motivo)
                        document.querySelectorAll('.diario-entrada-card').forEach(c => c.style.display = '');
                        document.querySelectorAll('.diario-data-group, .area-content').forEach(g => g.style.display = '');
                    }
                    return;
                }
                
                // Filtrar cards
                const cards = document.querySelectorAll('.diario-entrada-card');
                let contador = 0;
                
                cards.forEach(card => {
                    const topico = card.getAttribute('data-busca-topico') || '';
                    const tema = card.getAttribute('data-busca-tema') || '';
                    const area = card.getAttribute('data-busca-area') || '';
                    const textoCompleto = `${topico} ${tema} ${area}`;
                    
                    if (textoCompleto.includes(termo)) {
                        card.style.display = '';
                        contador++;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // S4-FIX2: Esconder grupos sem cards vis√≠veis E EXPANDIR (usando toggleAreaCaderno) dos grupos que cont√™m cards vis√≠veis
                // S6-NAV-FIX2: Armazenar ID do RAF para permitir cancelamento
                window.diarioBuscaRAF = requestAnimationFrame(() => {
                    // Helper local para abrir grupo usando mecanismo oficial
                    const ensureGrupoAberto = (id) => {
                        const content = document.getElementById(`area-content-${id}`);
                        if (!content) return;
                        if (content.classList.contains('collapsed')) {
                            if (typeof toggleAreaCaderno === 'function') {
                                toggleAreaCaderno(id);
                            } else {
                                content.classList.remove('collapsed');
                            }
                        }
                    };
                    
                    // Coletar IDs ancestrais a partir dos cards realmente vis√≠veis
                    const idsParaAbrir = new Set();
                    document.querySelectorAll('.diario-entrada-card').forEach(card => {
                        if (card.style.display === 'none') return;
                        let p = card.closest('.area-content');
                        while (p) {
                            if (p.id && p.id.startsWith('area-content-')) {
                                idsParaAbrir.add(p.id.replace('area-content-', ''));
                            }
                            p = p.parentElement ? p.parentElement.closest('.area-content') : null;
                        }
                    });
                    
                    // Abrir grupos ancestrais dos cards vis√≠veis
                    idsParaAbrir.forEach(ensureGrupoAberto);
                    
                    // Esconder/mostrar grupos pelo wrapper correto
                    const grupos = document.querySelectorAll('.area-content[id^="area-content-"]');
                    grupos.forEach(content => {
                        const totalCards = content.querySelectorAll('.diario-entrada-card').length;
                        const visiveis = Array.from(content.querySelectorAll('.diario-entrada-card')).filter(card => card.style.display !== 'none').length;
                        
                        if (totalCards > 0 && visiveis === 0) {
                            // Esconder wrapper pai que cont√©m header+content
                            const wrapper = content.parentElement;
                            if (wrapper && wrapper.style) {
                                wrapper.style.display = 'none';
                            }
                            // Se n√£o for o wrapper correto, esconder tamb√©m o header irm√£o
                            const header = content.previousElementSibling;
                            if (header && header.classList.contains('area-header')) {
                                header.style.display = 'none';
                            }
                        } else {
                            // Mostrar wrapper e header
                            const wrapper = content.parentElement;
                            if (wrapper && wrapper.style) {
                                wrapper.style.display = '';
                            }
                            const header = content.previousElementSibling;
                            if (header && header.classList.contains('area-header')) {
                                header.style.display = '';
                            }
                        }
                    });
                    window.diarioBuscaRAF = null; // S6-NAV-FIX2: Limpar ap√≥s executar
                });
                
                // Atualizar contador
                if (resultadosDiv) {
                    if (contador > 0) {
                        resultadosDiv.style.display = 'block';
                        if (contadorEl) contadorEl.textContent = contador;
                    } else {
                        resultadosDiv.style.display = 'block';
                        if (contadorEl) contadorEl.textContent = '0';
                    }
                }
            }, 200);
        }
        
        function limparBuscaDiario() {
            const buscaInput = document.getElementById('filtroDiarioBusca');
            if (buscaInput) {
                buscaInput.value = '';
                filtrarDiarioPorBusca();
            }
        }
        
        // B2S: Helper para carregar thumbnail √∫nico (sess√µes)
        async function diario_carregarThumbnailUnico(entradaId, thumbKey, imgElId, wrapElId) {
            const imgElement = document.getElementById(imgElId);
            const wrapElement = document.getElementById(wrapElId);
            
            if (!imgElement || !wrapElement) return;
            
            // Se j√° carregado, n√£o recarregar
            if (imgElement.dataset.loaded === '1') return;
            
            // Fallback: se thumbKey vazio, tentar buscar da entrada
            let thumbKeyFinal = thumbKey;
            if (!thumbKeyFinal && entradaId) {
                const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                if (entrada && entrada.imagem && entrada.imagem.thumbKey) {
                    thumbKeyFinal = entrada.imagem.thumbKey;
                }
            }
            
            // Se ainda n√£o tem thumbKey, esconder wrapper e retornar
            if (!thumbKeyFinal) {
                wrapElement.hidden = true;
                return;
            }
            
            try {
                const thumbBlob = await b0Img_getBlob(thumbKeyFinal);
                if (!thumbBlob) {
                    wrapElement.hidden = true;
                    return;
                }
                
                // Revogar URL antiga se existir
                if (imgElement.src && imgElement.src.startsWith('blob:')) {
                    URL.revokeObjectURL(imgElement.src);
                }
                
                const thumbURL = URL.createObjectURL(thumbBlob);
                imgElement.src = thumbURL;
                imgElement.dataset.loaded = '1';
                imgElement.style.display = 'block';
                wrapElement.hidden = false;
                
                imgElement.onerror = () => {
                    URL.revokeObjectURL(thumbURL);
                    imgElement.style.display = 'none';
                    wrapElement.hidden = true;
                    imgElement.dataset.loaded = '';
                };
            } catch (error) {
                console.error('Erro ao carregar thumbnail:', error);
                wrapElement.hidden = true;
                imgElement.dataset.loaded = '';
            }
        }
        
        // B3: Viewer de imagem (ampliar ao clicar)
        async function diario_abrirViewerImagem(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (!entrada || !entrada.imagem || !entrada.imagem.fullKey) return;
            
            try {
                const fullBlob = await b0Img_getBlob(entrada.imagem.fullKey);
                if (!fullBlob) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
                    return;
                }
                
                const fullURL = URL.createObjectURL(fullBlob);
                
                // Estado do zoom/pan
                let scale = 1;
                let tx = 0;
                let ty = 0;
                
                let baseW = 0;
                let baseH = 0;
                
                let isPanning = false;
                let startX = 0, startY = 0;
                let startTX = 0, startTY = 0;
                
                let isPinching = false;
                let initialPinchDistance = 0;
                let initialPinchScale = 1;
                let initialPinchCenterX = 0;
                let initialPinchCenterY = 0;
                let initialPinchTX = 0;
                let initialPinchTY = 0;
                
                let lastTapTime = 0;
                let lastTapX = 0;
                let lastTapY = 0;
                
                // Criar overlay
                const overlay = document.createElement('div');
                overlay.id = 'diario-viewer-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    overflow: hidden;
                `;
                
                // Imagem ampliada
                const img = document.createElement('img');
                img.src = fullURL;
                img.style.cssText = `
                    max-width: 95%;
                    max-height: 95%;
                    object-fit: contain;
                    border-radius: 8px;
                    user-select: none;
                    -webkit-user-select: none;
                    -webkit-touch-callout: none;
                    transform-origin: center center;
                `;
                
                // Helpers
                const aplicarTransform = () => {
                    img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
                };
                
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                
                const clampPan = () => {
                    const o = overlay.getBoundingClientRect();
                    const maxX = Math.max(0, (baseW * scale - o.width) / 2);
                    const maxY = Math.max(0, (baseH * scale - o.height) / 2);
                    tx = clamp(tx, -maxX, maxX);
                    ty = clamp(ty, -maxY, maxY);
                };
                
                const resetZoom = () => {
                    scale = 1;
                    tx = 0;
                    ty = 0;
                    aplicarTransform();
                };
                
                const zoomAt = (clientX, clientY, nextScale) => {
                    const o = overlay.getBoundingClientRect();
                    const x = clientX - o.left;
                    const y = clientY - o.top;
                    
                    // mover "em dire√ß√£o" ao ponto tocado
                    scale = nextScale;
                    tx = (o.width / 2 - x) * (scale - 1);
                    ty = (o.height / 2 - y) * (scale - 1);
                    
                    clampPan();
                    aplicarTransform();
                };
                
                const calcularDistancia = (t1, t2) => {
                    const dx = t1.clientX - t2.clientX;
                    const dy = t1.clientY - t2.clientY;
                    return Math.hypot(dx, dy);
                };
                
                const calcularCentro = (t1, t2) => {
                    return {
                        x: (t1.clientX + t2.clientX) / 2,
                        y: (t1.clientY + t2.clientY) / 2
                    };
                };
                
                // Medir tamanho base ap√≥s carregar
                img.onload = () => {
                    requestAnimationFrame(() => {
                        const r = img.getBoundingClientRect();
                        baseW = r.width || baseW;
                        baseH = r.height || baseH;
                        aplicarTransform();
                    });
                };
                
                // Touch handlers
                img.addEventListener('touchstart', (e) => {
                    if (!e.touches) return;
                    
                    // Pinch gesture (2 toques)
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        isPanning = false;
                        isPinching = true;
                        
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        initialPinchDistance = calcularDistancia(t1, t2);
                        initialPinchScale = scale;
                        const centro = calcularCentro(t1, t2);
                        initialPinchCenterX = centro.x;
                        initialPinchCenterY = centro.y;
                        initialPinchTX = tx;
                        initialPinchTY = ty;
                        
                        img.style.transition = 'none';
                        return;
                    }
                    
                    // Single touch (double-tap ou pan)
                    if (e.touches.length !== 1) return;
                    
                    const t = e.touches[0];
                    const now = Date.now();
                    const dt = now - lastTapTime;
                    const dx = Math.abs(t.clientX - lastTapX);
                    const dy = Math.abs(t.clientY - lastTapY);
                    
                    // double-tap
                    if (dt < 300 && dx < 40 && dy < 40) {
                        e.preventDefault();
                        lastTapTime = 0;
                        
                        if (scale === 1) {
                            zoomAt(t.clientX, t.clientY, 2.5);
                        } else {
                            resetZoom();
                        }
                        return;
                    }
                    
                    lastTapTime = now;
                    lastTapX = t.clientX;
                    lastTapY = t.clientY;
                    
                    // pan s√≥ se estiver ampliado
                    if (scale > 1) {
                        e.preventDefault();
                        isPanning = true;
                        isPinching = false;
                        startX = t.clientX;
                        startY = t.clientY;
                        startTX = tx;
                        startTY = ty;
                        img.style.transition = 'none';
                    }
                }, { passive: false });
                
                img.addEventListener('touchmove', (e) => {
                    if (!e.touches) return;
                    
                    // Pinch gesture (2 toques)
                    if (e.touches.length === 2 && isPinching) {
                        e.preventDefault();
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        const currentDistance = calcularDistancia(t1, t2);
                        
                        if (initialPinchDistance > 0) {
                            const scaleFactor = currentDistance / initialPinchDistance;
                            scale = Math.max(1, Math.min(5, initialPinchScale * scaleFactor));
                            
                            // Ajustar translate para manter o ponto de zoom fixo
                            const o = overlay.getBoundingClientRect();
                            const centro = calcularCentro(t1, t2);
                            const deltaX = centro.x - initialPinchCenterX;
                            const deltaY = centro.y - initialPinchCenterY;
                            
                            tx = initialPinchTX + deltaX;
                            ty = initialPinchTY + deltaY;
                            
                            clampPan();
                            aplicarTransform();
                        }
                        return;
                    }
                    
                    // Pan gesture (1 toque)
                    if (!isPanning || scale <= 1 || e.touches.length !== 1) return;
                    e.preventDefault();
                    const t = e.touches[0];
                    tx = startTX + (t.clientX - startX);
                    ty = startTY + (t.clientY - startY);
                    clampPan();
                    aplicarTransform();
                }, { passive: false });
                
                img.addEventListener('touchend', (e) => {
                    if (isPinching && (!e.touches || e.touches.length < 2)) {
                        isPinching = false;
                        img.style.transition = '';
                    }
                    if (isPanning && (!e.touches || e.touches.length === 0)) {
                        isPanning = false;
                        img.style.transition = '';
                    }
                });
                
                // Bot√£o fechar
                const btnFechar = document.createElement('button');
                btnFechar.textContent = '‚úï';
                btnFechar.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    z-index: 10001;
                `;
                
                const fechar = () => {
                    try { URL.revokeObjectURL(fullURL); } catch(e) {}
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                };
                
                btnFechar.onclick = (e) => {
                    e.stopPropagation();
                    fechar();
                };
                
                // Overlay click: fecha se zoom == 1, reseta zoom se zoom > 1
                overlay.addEventListener('click', (e) => {
                    if (e.target !== overlay) return;
                    if (scale > 1) {
                        resetZoom();
                    } else {
                        fechar();
                    }
                });
                
                img.onclick = (e) => e.stopPropagation();
                
                overlay.appendChild(img);
                overlay.appendChild(btnFechar);
                document.body.appendChild(overlay);
                
            } catch (error) {
                console.error('Erro ao abrir viewer:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
            }
        }
        
        // B2S: Garantir que fun√ß√£o est√° no escopo global (backup)
        if (typeof window.diario_abrirViewerImagem === 'undefined') {
            window.diario_abrirViewerImagem = diario_abrirViewerImagem;
        }
        
        function toggleRespostaIndividual(entradaId) {
            const respostaDiv = document.getElementById(`resposta_${entradaId}`);
            if (respostaDiv) {
                const estavaOculta = respostaDiv.style.display === 'none';
                respostaDiv.style.display = respostaDiv.style.display === 'none' ? 'block' : 'none';
                
                // B2-FIX-2: Carregar thumbnail quando resposta √© mostrada pela primeira vez
                if (estavaOculta) {
                    setTimeout(() => {
                        const imgElement = document.getElementById(`diario-img-${entradaId}`);
                        if (imgElement && imgElement.dataset.loaded !== '1') {
                            // Thumbnail ainda n√£o foi carregado
                            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
                            if (entrada && entrada.imagem && entrada.imagem.thumbKey) {
                                (async () => {
                                    try {
                                        const thumbBlob = await b0Img_getBlob(entrada.imagem.thumbKey);
                                        if (thumbBlob) {
                                            const thumbURL = URL.createObjectURL(thumbBlob);
                                            imgElement.src = thumbURL;
                                            imgElement.dataset.loaded = '1'; // Marcar como carregado
                                            imgElement.style.display = 'block'; // B2-FIX-2: For√ßar exibi√ß√£o
                                            imgElement.onerror = () => {
                                                URL.revokeObjectURL(thumbURL);
                                                imgElement.style.display = 'none';
                                                imgElement.dataset.loaded = ''; // Limpar flag em caso de erro
                                            };
                                        }
                                    } catch (error) {
                                        console.error('Erro ao carregar thumbnail:', error);
                                        imgElement.style.display = 'none';
                                        imgElement.dataset.loaded = ''; // Limpar flag em caso de erro
                                    }
                                })();
                            }
                        }
                    }, 50);
                }
            }
        }
        
        function toggleRespostaTreinoFim(entradaId) {
            const respostaDiv = document.getElementById(`resposta_treino_${entradaId}`);
            if (respostaDiv) {
                const estavaOculta = respostaDiv.style.display === 'none';
                respostaDiv.style.display = respostaDiv.style.display === 'none' ? 'block' : 'none';
                
                // T1b: Carregar thumbnail quando resposta √© mostrada pela primeira vez (padr√£o Di√°rio)
                if (estavaOculta) {
                    setTimeout(() => {
                        const imgElement = document.getElementById(`treino-img-${entradaId}`);
                        if (imgElement && imgElement.dataset.loaded !== '1') {
                            const entrada =
                                (window.treinoLivreFimDados && Array.isArray(window.treinoLivreFimDados.fila))
                                    ? window.treinoLivreFimDados.fila.find(e => String(e.id) === String(entradaId))
                                    : (window.diario && Array.isArray(window.diario.entradas))
                                        ? window.diario.entradas.find(e => String(e.id) === String(entradaId))
                                        : null;
                            
                            if (entrada && entrada.imagem && entrada.imagem.thumbKey) {
                                (async () => {
                                    try {
                                        const thumbBlob = await b0Img_getBlob(entrada.imagem.thumbKey);
                                        if (thumbBlob) {
                                            const thumbURL = URL.createObjectURL(thumbBlob);
                                            
                                            // guard m√≠nimo anti-stale (sem refactor): se saiu do DOM, revoga e aborta
                                            if (!imgElement.isConnected) {
                                                URL.revokeObjectURL(thumbURL);
                                                return;
                                            }
                                            
                                            imgElement.src = thumbURL;
                                            imgElement.dataset.loaded = '1';
                                            imgElement.style.display = 'block';
                                            imgElement.onerror = () => {
                                                URL.revokeObjectURL(thumbURL);
                                                imgElement.style.display = 'none';
                                                imgElement.dataset.loaded = '';
                                            };
                                        }
                                    } catch (error) {
                                        console.error('Erro ao carregar thumbnail (p√≥s-treino):', error);
                                        imgElement.style.display = 'none';
                                        imgElement.dataset.loaded = '';
                                    }
                                })();
                            }
                        }
                    }, 50);
                }
            }
        }
        
        // P2D: Helper para escolher quem est√° rolando (sem adivinhar)
        // Agora recebe btnEl para encontrar o container correto (area-content ou diarioContainer)
        function diario_getPrimaryScroller(btnEl) {
            const docEl = document.scrollingElement || document.documentElement;
            
            // P2D-FIX: Se btnEl existe, procurar primeiro no area-content pai (pasta colaps√°vel)
            if (btnEl) {
                let cur = btnEl.parentElement;
                while (cur && cur !== document.body && cur !== document.documentElement) {
                    try {
                        const st = window.getComputedStyle(cur);
                        const oy = st.overflowY;
                        const isScrollable = (oy === 'auto' || oy === 'scroll') && 
                                           (cur.scrollHeight > cur.clientHeight + 1);
                        if (isScrollable && cur.classList.contains('area-content')) {
                            return cur; // Encontrou o area-content com scroll
                        }
                    } catch (e) {}
                    cur = cur.parentElement;
                }
            }
            
            // Fallback: verificar diarioContainer
            const cont = document.getElementById('diarioContainer');
            const contScrollable = cont && (cont.scrollHeight > cont.clientHeight + 1);
            
            if (contScrollable) return cont;
            
            // √öltimo fallback: documento inteiro
            return docEl;
        }
        
        // PATCH 3: Toggle revis√£o ON/OFF na lista do Di√°rio
        function toggleRevisaoDiario(entradaId, btnEl) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (!entrada) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Entrada n√£o encontrada!', 'error');
                return;
            }
            
            // Garantir que srs existe
            if (!entrada.srs) {
                const hoje = obterYMDLocal();
                entrada.srs = inicializarSrsVRVS3P(hoje);
            }
            
            // P2D: √¢ncora visual ‚Äî manter o item clicado no mesmo lugar da tela
            const scrollerAntes = diario_getPrimaryScroller(btnEl);
            const scrollTopAntes = scrollerAntes ? scrollerAntes.scrollTop : 0;
            const yAntes = btnEl ? btnEl.getBoundingClientRect().top : null;
            
            // Toggle: inverter estado atual
            entrada.srs.ativo = !entrada.srs.ativo;
            
            // Persistir imediatamente
            salvarDiario();
            
            // Re-renderizar lista para atualizar bot√£o
            renderDiario();
            
            const restoreByAnchor = () => {
                // P2D-FIX: Buscar bot√£o depois do render para encontrar o scroller correto
                const btnDepois = document.querySelector(`.btn-toggle-revisao[data-entrada-id="${entradaId}"]`);
                const scroller = diario_getPrimaryScroller(btnDepois);
                if (!scroller) return;
                
                // Prefer√™ncia: √¢ncora (mais est√°vel em iOS)
                if (yAntes != null) {
                    const btnDepois = document.querySelector(`.btn-toggle-revisao[data-entrada-id="${entradaId}"]`);
                    if (btnDepois) {
                        const yDepois = btnDepois.getBoundingClientRect().top;
                        const delta = yDepois - yAntes;
                        if (Number.isFinite(delta) && Math.abs(delta) > 0.5) {
                            scroller.scrollTop = scroller.scrollTop + delta;
                            return;
                        }
                    }
                }
                
                // Fallback: n√∫mero bruto (se n√£o achar o bot√£o depois do render)
                scroller.scrollTop = scrollTopAntes;
            };
            
            // 3 fases curtas pra vencer reflow tardio / thumbnails no iOS
            requestAnimationFrame(restoreByAnchor);
            setTimeout(restoreByAnchor, 140);
            setTimeout(restoreByAnchor, 380);
            
            // Feedback visual
            const status = entrada.srs.ativo ? 'ativada' : 'desativada';
            mostrarNotificacaoFeedback(`‚úÖ Revis√£o ${status}`, 'success');
        }
        
        // PATCH 4: Confirmar exclus√£o de entrada do Di√°rio
        function confirmarExcluirEntradaDiario() {
            const entradaId = document.getElementById('novaDiarioId')?.value;
            if (!entradaId) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: ID n√£o encontrado!', 'error');
                return;
            }
            
            // Armazenar ID globalmente para uso no modal de confirma√ß√£o
            window.entradaDiarioParaExcluir = entradaId;
            
            // Buscar entrada para mostrar preview no modal
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (entrada) {
                // Atualizar modal com preview
                const preview = document.getElementById('previewExclusaoDiario');
                if (preview) {
                    preview.textContent = `"${entrada.topico || '(Sem t√≥pico)'}"`;
                }
            }
            
            // Abrir modal de confirma√ß√£o
            const modal = document.getElementById('modalConfirmarExclusaoDiario');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        // PATCH 4: Executar exclus√£o ap√≥s confirma√ß√£o
        function executarExcluirEntradaDiario() {
            const entradaId = window.entradaDiarioParaExcluir;
            if (!entradaId) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro: ID n√£o encontrado!', 'error');
                fecharModalConfirmarExclusaoDiario();
                return;
            }
            
            // Buscar entrada
            const indice = window.diario.entradas.findIndex(e => String(e.id) === String(entradaId));
            if (indice === -1) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Entrada n√£o encontrada!', 'error');
                fecharModalConfirmarExclusaoDiario();
                return;
            }
            
            // Remover do array
            window.diario.entradas.splice(indice, 1);
            
            // Persistir
            salvarDiario();
            
            // Fechar modais
            fecharModalConfirmarExclusaoDiario();
            fecharModalDiario();
            
            // Re-renderizar lista
            renderDiario();
            
            // Feedback
            mostrarNotificacaoFeedback('‚úÖ Card exclu√≠do', 'success');
            
            // Limpar vari√°vel global
            window.entradaDiarioParaExcluir = null;
        }
        
        // PATCH 4: Fechar modal de confirma√ß√£o
        function fecharModalConfirmarExclusaoDiario() {
            const modal = document.getElementById('modalConfirmarExclusaoDiario');
            if (modal) {
                modal.classList.remove('active');
            }
            window.entradaDiarioParaExcluir = null;
        }
        
        // Editar entrada a partir da sess√£o (desabilita √°rea/tema)
        async function editarEntradaSessaoDiario() {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual) return;
            
            // CR√çTICO: Marcar flag ANTES de chamar editarEntradaDiario
            // Isso garante que a fun√ß√£o sabe que veio da sess√£o
            window.editandoDaSessao = true;
            
            // Usar fun√ß√£o existente de edi√ß√£o
            await editarEntradaDiario(entradaAtual.id);
        }
        
        async function editarEntradaDiario(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (!entrada) {
                console.error('[DEBUG VRVS3P] Entrada n√£o encontrada:', entradaId);
                return;
            }
            
            // CR√çTICO: Verificar flag ANTES de qualquer coisa
            // Se n√£o foi setada explicitamente por editarEntradaSessaoDiario(), assumir que veio da Lista
            const veioDaSessao = window.editandoDaSessao === true;
            
            // Se n√£o veio da sess√£o, garantir que flag est√° false (pode ter ficado true de edi√ß√£o anterior)
            if (!veioDaSessao) {
                window.editandoDaSessao = false;
            }
            
            document.getElementById('novaDiarioId').value = entrada.id;
            const dataInput = document.getElementById('novaDiarioData');
            if (dataInput) {
                dataInput.value = entrada.data || obterYMDLocal();
            }
            
            // Popular select de √°reas com TODAS as √°reas existentes (√°reas base do perfil + √°reas dos dados + √°rea da entrada)
            const areaSelect = document.getElementById('novaDiarioArea');
            if (areaSelect) {
                // Coletar todas as √°reas: √°reas base do perfil + √°reas dos dados + √°rea da entrada atual
                const areasDosDados = [...new Set(dados.map(t => t.area).filter(a => a))];
                const areasExistentes = [...new Set([...getAreasDisponiveisDoPerfilAtivo(), entrada.area].filter(a => a))].sort();
                
                areaSelect.innerHTML = '<option value="">Selecione...</option>';
                areasExistentes.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                
                // CR√çTICO: Setar valor ANTES de desabilitar
                areaSelect.value = entrada.area || '';
                
                // Se veio da sess√£o, desabilitar √°rea/tema (mas valor j√° est√° setado)
                if (veioDaSessao) {
                    areaSelect.disabled = true;
                    areaSelect.title = 'Editar √°rea/tema apenas pela Lista';
                } else {
                    areaSelect.disabled = false;
                    areaSelect.title = '';
                }
            }
            
            // Atualizar temas baseado na √°rea selecionada
            if (entrada.area) {
            atualizarTemasDiario(entrada.area);
            }
            
            // Selecionar tema ap√≥s popular select (com timeout maior para garantir que temas foram populados)
            setTimeout(() => {
                const temaSelect = document.getElementById('novaDiarioTema');
                if (temaSelect) {
                    // Verificar se tema existe nas options antes de setar
                    const temaExiste = Array.from(temaSelect.options).some(opt => opt.value === entrada.tema);
                    
                    if (temaExiste) {
                        temaSelect.value = entrada.tema || '';
                    } else {
                        // Tentar novamente ap√≥s mais um delay (mobile pode ser mais lento)
                        setTimeout(() => {
                            temaSelect.value = entrada.tema || '';
                        }, 100);
                    }
                    
                    // Se veio da sess√£o, desabilitar tema tamb√©m (mas valor j√° est√° setado)
                    if (veioDaSessao) {
                        temaSelect.disabled = true;
                        temaSelect.title = 'Editar √°rea/tema apenas pela Lista';
                    } else {
                        temaSelect.disabled = false;
                        temaSelect.title = '';
                    }
                }
            }, 150); // Aumentado para 150ms para garantir que temas foram populados (mobile pode ser mais lento)
            
            document.getElementById('novaDiarioTopico').value = entrada.topico;
            document.getElementById('novaDiarioResposta').value = entrada.resposta || '';
            // PATCH 4: Marcar checkbox APENAS se entrada tem SRS ativo (n√£o usar atencao legado)
            const temSrsAtivo = entrada.srs && entrada.srs.ativo;
            document.getElementById('novaDiarioAtencao').checked = temSrsAtivo || false;
            
            // Renderizar box do Modo Avan√ßado com dados da entrada
            diarioModoAvancado_renderBoxDesempenho(entrada);
            
            // B1: Carregar imagem se houver
            if (entrada.imagem && entrada.imagem.thumbKey) {
                try {
                    // Carregar thumbnail para preview
                    const thumbBlob = await b0Img_getBlob(entrada.imagem.thumbKey);
                    if (thumbBlob) {
                        const thumbURL = URL.createObjectURL(thumbBlob);
                        const thumbImg = document.getElementById('novaDiarioImagemThumb');
                        const preview = document.getElementById('novaDiarioImagemPreview');
                        const btnAdd = document.getElementById('novaDiarioImagemBtn');
                        if (thumbImg) {
                            thumbImg.src = thumbURL;
                            // B1-FIX: MICRO-FIX onerror/onload (evitar memory leak e usar ev correto)
                            // PATCH: S√≥ adicionar handler se src √© v√°lido (blob URL)
                            if (thumbImg.src && thumbImg.src.startsWith('blob:')) {
                                thumbImg.onerror = (ev) => {
                                    URL.revokeObjectURL(thumbURL);
                                    diario_handleImageError(ev);
                                };
                            }
                            thumbImg.onload = () => {
                                // N√£o revogar aqui, apenas quando remover ou erro
                            };
                        }
                        if (preview) preview.style.display = 'block';
                        if (btnAdd) btnAdd.style.display = 'none';
                        
                        // B1-FIX: Carregar blob completo para viewer, mas N√ÉO marcar como nova sele√ß√£o
                        if (entrada.imagem.fullKey) {
                            try {
                                const fullBlob = await b0Img_getBlob(entrada.imagem.fullKey);
                                if (fullBlob) {
                                    window.diario_imagemBlobAtual = fullBlob;
                                    window.diario_imagemMetadataAtual = entrada.imagem;
                                    window.diario_imagemRemovida = false;
                                    window.diario_imagemNovaSelecionada = false; // B1-FIX: N√ÉO √© nova sele√ß√£o
                                } else {
                                    // Se blob n√£o encontrado
                                    window.diario_imagemBlobAtual = null;
                                    window.diario_imagemMetadataAtual = null;
                                    window.diario_imagemRemovida = true;
                                    window.diario_imagemNovaSelecionada = false;
                                }
                            } catch (error) {
                                console.error('Erro ao carregar blob completo:', error);
                                window.diario_imagemBlobAtual = null;
                                window.diario_imagemMetadataAtual = entrada.imagem;
                                window.diario_imagemRemovida = false;
                                window.diario_imagemNovaSelecionada = false;
                            }
                        } else {
                            window.diario_imagemBlobAtual = null;
                            window.diario_imagemMetadataAtual = entrada.imagem;
                            window.diario_imagemRemovida = false;
                            window.diario_imagemNovaSelecionada = false;
                        }
                        
                        // Atualizar indicador visual
                        const statusEl = document.getElementById('novaDiarioImagemStatus');
                        if (statusEl) {
                            const tamanhoKB = entrada.imagem.tamanho ? Math.round(entrada.imagem.tamanho / 1024) : '?';
                            statusEl.textContent = `üì∑ imagem: OK (${tamanhoKB}KB)`;
                            statusEl.style.color = 'rgba(0,206,209,0.8)';
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar imagem:', error);
                    // Continuar sem imagem se falhar
                    window.diario_imagemNovaSelecionada = false;
                }
            } else {
                // Limpar imagem se n√£o houver
                if (typeof diario_limparImagemModal === 'function') {
                    diario_limparImagemModal();
                }
                // PATCH: Reset defensivo de src para evitar onerror
                const thumbImg = document.getElementById('novaDiarioImagemThumb');
                if (thumbImg) {
                    thumbImg.src = '';
                    thumbImg.onerror = null; // Remover handler se existir
                }
            }
            
            // MP1: Carregar imagem da PERGUNTA se houver
            if (entrada.imagemPergunta && entrada.imagemPergunta.thumbKey) {
                try {
                    // Carregar thumbnail para preview
                    const thumbBlob = await b0Img_getBlob(entrada.imagemPergunta.thumbKey);
                    if (thumbBlob) {
                        const thumbURL = URL.createObjectURL(thumbBlob);
                        const thumbImg = document.getElementById('novaDiarioImagemPerguntaThumb');
                        const preview = document.getElementById('novaDiarioImagemPerguntaPreview');
                        const btnAdd = document.getElementById('novaDiarioImagemPerguntaBtn');
                        if (thumbImg) {
                            thumbImg.src = thumbURL;
                            if (thumbImg.src && thumbImg.src.startsWith('blob:')) {
                                thumbImg.onerror = (ev) => {
                                    URL.revokeObjectURL(thumbURL);
                                    diario_handleImageErrorPergunta(ev);
                                };
                            }
                            thumbImg.onload = () => {
                                // N√£o revogar aqui
                            };
                        }
                        if (preview) preview.style.display = 'block';
                        if (btnAdd) btnAdd.style.display = 'none';
                        
                        // Carregar blob completo para viewer, mas N√ÉO marcar como nova sele√ß√£o
                        if (entrada.imagemPergunta.fullKey) {
                            try {
                                const fullBlob = await b0Img_getBlob(entrada.imagemPergunta.fullKey);
                                if (fullBlob) {
                                    window.diario_imagemPerguntaBlobAtual = fullBlob;
                                    window.diario_imagemPerguntaMetadataAtual = entrada.imagemPergunta;
                                    window.diario_imagemPerguntaRemovida = false;
                                    window.diario_imagemPerguntaNovaSelecionada = false;
                                } else {
                                    window.diario_imagemPerguntaBlobAtual = null;
                                    window.diario_imagemPerguntaMetadataAtual = null;
                                    window.diario_imagemPerguntaRemovida = true;
                                    window.diario_imagemPerguntaNovaSelecionada = false;
                                }
                            } catch (error) {
                                console.error('Erro ao carregar blob completo da pergunta:', error);
                                window.diario_imagemPerguntaBlobAtual = null;
                                window.diario_imagemPerguntaMetadataAtual = entrada.imagemPergunta;
                                window.diario_imagemPerguntaRemovida = false;
                                window.diario_imagemPerguntaNovaSelecionada = false;
                            }
                        } else {
                            window.diario_imagemPerguntaBlobAtual = null;
                            window.diario_imagemPerguntaMetadataAtual = entrada.imagemPergunta;
                            window.diario_imagemPerguntaRemovida = false;
                            window.diario_imagemPerguntaNovaSelecionada = false;
                        }
                        
                        // Atualizar indicador visual
                        const statusEl = document.getElementById('novaDiarioImagemPerguntaStatus');
                        if (statusEl) {
                            const tamanhoKB = entrada.imagemPergunta.tamanho ? Math.round(entrada.imagemPergunta.tamanho / 1024) : '?';
                            statusEl.textContent = `üì∑ imagem: OK (${tamanhoKB}KB)`;
                            statusEl.style.color = 'rgba(0,206,209,0.8)';
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar imagem da pergunta:', error);
                    // Continuar sem imagem se falhar
                    window.diario_imagemPerguntaNovaSelecionada = false;
                }
            } else {
                // Limpar imagem da pergunta se n√£o houver
                if (typeof diario_limparImagemPerguntaModal === 'function') {
                    diario_limparImagemPerguntaModal();
                }
                // Reset defensivo de src para evitar onerror
                const thumbImg = document.getElementById('novaDiarioImagemPerguntaThumb');
                if (thumbImg) {
                    thumbImg.src = '';
                    thumbImg.onerror = null;
                }
            }
            
            // PATCH 4: Mostrar/ocultar bot√£o de excluir conforme √© edi√ß√£o ou nova entrada
            const btnExcluirWrapper = document.getElementById('btnExcluirEntradaWrapper');
            if (btnExcluirWrapper) {
                btnExcluirWrapper.style.display = entradaId ? 'block' : 'none';
            }
            
            // Mostrar modal
            document.getElementById('modalNovaDiario').classList.add('active');
        }
        
        // ==================== SRS - CONTROLE DE ABA E MODO ====================
        
        // Fun√ß√£o para mudar aba do Di√°rio
        function setAbaDiario(aba) {
            abaDiarioAtiva = aba; // 'lista' ou 'sessao'
            const tabLista = document.getElementById('diarioTabLista');
            const tabSessao = document.getElementById('diarioTabSessao');
            const containerLista = document.getElementById('diarioListaWrapper');
            const containerSessao = document.getElementById('diarioSessaoWrapper');
            
            if (tabLista && tabSessao && containerLista && containerSessao) {
                if (aba === 'lista') {
                    tabLista.classList.add('active');
                    tabSessao.classList.remove('active');
                    containerLista.style.display = 'block';
                    containerSessao.style.display = 'none';
                    // Re-renderizar a lista normal
                    renderDiario();
                } else {
                    tabSessao.classList.add('active');
                    tabLista.classList.remove('active');
                    containerLista.style.display = 'none';
                    containerSessao.style.display = 'block';
                    // P1 FIX: Usar fun√ß√£o placeholder sem side-effects (GPT)
                    renderSessaoDiarioVazia();
                }
            }
        }
        
        // Fun√ß√£o para mudar o tipo de sess√£o (programado x livre)
        function setModoSessaoDiario(modo) {
            modoSessaoDiario = modo; // 'programado' ou 'livre'
            const btnProgramado = document.getElementById('sessaoDiarioProgramado');
            const btnLivre = document.getElementById('sessaoDiarioLivre');
            
            if (btnProgramado && btnLivre) {
                if (modo === 'programado') {
                    btnProgramado.classList.add('active');
                    btnLivre.classList.remove('active');
                } else {
                    btnLivre.classList.add('active');
                    btnProgramado.classList.remove('active');
                }
            }
            
            // Limpar hist√≥rico ao mudar modo
            window.sessaoProgramadaHistorico = [];
            // Reiniciar sess√£o quando modo muda
            iniciarSessaoDiario(modo);
        }
        
        // P1: Fun√ß√£o para limpar filtro da sess√£o e voltar para fila geral
        function limparFiltroSessaoDiario() {
            window.filtrosSessaoDiario = null;
            // Reiniciar sess√£o com fila geral
            iniciarSessaoDiario(sessaoDiario.tipo || modoSessaoDiario);
        }
        
        // P1: Fun√ß√£o placeholder para renderizar tela vazia sem side-effects (GPT)
        function renderSessaoDiarioVazia() {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            const tipo = sessaoDiario?.tipo || modoSessaoDiario;
            if (tipo === 'programado') {
                const temFiltro = window.filtrosSessaoDiario && (window.filtrosSessaoDiario.area || window.filtrosSessaoDiario.tema);
                const filtroArea = window.filtrosSessaoDiario?.area || '';
                const filtroTema = window.filtrosSessaoDiario?.tema || '';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div>${temFiltro ? `üìã Sem t√≥picos deste tema para hoje` : `‚úÖ Voc√™ n√£o tem nenhum t√≥pico do Di√°rio <strong>programado para hoje</strong> com os filtros atuais.`}</div>
                        ${temFiltro ? `
                            <div style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.6);">
                                Filtrado: <strong>${filtroArea ? filtroArea + ' ‚Ä¢ ' : ''}${filtroTema}</strong>
                            </div>
                            <button class="btn btn-small" onclick="limparFiltroSessaoDiario()" style="margin-top: 12px;">
                                üîÅ Ver tudo (hoje)
                            </button>
                        ` : `
                            <button class="btn btn-small" onclick="setModoSessaoDiario('livre')" style="margin-top: 12px;">
                                üîÅ Fazer treino livre mesmo assim
                            </button>
                        `}
                    </div>
                `;
            } else {
                // Treino Livre: mostrar configura√ß√£o
                container.innerHTML = `
                    <div class="empty-state">
                        <div>Nenhuma sess√£o iniciada.</div>
                        <div style="margin-top: 12px;">Escolha <b>Revis√£o programada</b> ou <b>Treino livre</b>.</div>
                    </div>
                `;
            }
        }
        
        // Inicializar a sess√£o de Di√°rio
        function iniciarSessaoDiario(tipo) {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                renderSessaoDiario(null);
                return;
            }
            
            // Guardar tipo
            sessaoDiario = sessaoDiario || {};
            sessaoDiario.tipo = tipo;
            
            if (tipo === 'programado') {
                // P1 v2 OPUS: Se h√° fila pr√©-montada da Tarefa, usar diretamente
                if (window.sessaoFiltradaPreMontada && 
                    window.sessaoFiltradaPreMontada.filaIds && 
                    window.sessaoFiltradaPreMontada.filaIds.length > 0) {
                    
                    sessaoDiario.filaIds = window.sessaoFiltradaPreMontada.filaIds;
                    
                    // S5-UX: Filtrar cards pulados hoje (skipToday) tamb√©m para sess√£o pr√©-montada
                    const skipKey = getSkipKeyHoje();
                    const skipSet = lerSkipHojeSet(skipKey);
                    sessaoDiario.skipKeyHoje = skipKey;
                    sessaoDiario.filaIds = (sessaoDiario.filaIds || []).filter(id => !skipSet.has(String(id)));
                    
                    sessaoDiario.indiceAtual = 0;
                    
                    // Manter filtros para UI (mostrar "Filtrado: X")
                    window.filtrosSessaoDiario = {
                        area: window.sessaoFiltradaPreMontada.area,
                        tema: window.sessaoFiltradaPreMontada.tema,
                        origem: 'tarefa'
                    };
                    
                    // Limpar fila pr√©-montada ap√≥s usar
                    window.sessaoFiltradaPreMontada = null;
                    
                    // P1 FIX: Verificar se getEntradaAtualSessao() retorna null antes de renderizar
                    const entradaAtual = getEntradaAtualSessao();
                    if (entradaAtual) {
                        renderSessaoDiario(entradaAtual);
                    } else {
                        // Se n√£o encontrou entrada, renderizar vazio mas com filtro ativo
                        renderSessaoDiario(null);
                    }
                    return; // IMPORTANTE: sair aqui, n√£o continuar montando fila
                }
                
                // Fluxo normal (sess√£o global ou filtros da UI)
                let filtros = {
                    area: null,
                    tema: null
                };
                
                // Se houver filtros de sess√£o vindos da aba Tarefas, eles t√™m prioridade
                if (window.filtrosSessaoDiario) {
                    filtros.area = window.filtrosSessaoDiario.area || null;
                    filtros.tema = window.filtrosSessaoDiario.tema || null;
                }
                
                const entradas = getEntradasParaRevisarHojeDiario(filtros);
                
                // Ordena√ß√£o hier√°rquica de prioridades VRVS:
                // 1. Criados ontem (sempre primeiro)
                // 2. Esquecidos na sess√£o anterior (ontem)
                // 3. Pior nota (esqueci < lembrei < facil)
                // 4. Mais antigos
                // 5. Menos revis√µes
                const entradasOrdenadas = [...entradas].sort(compararPrioridadeVRVS);
                sessaoDiario.filaIds = entradasOrdenadas.map(e => e.id);
                
                // S5-UX: Filtrar cards pulados hoje (skipToday)
                const skipKey = getSkipKeyHoje();
                const skipSet = lerSkipHojeSet(skipKey);
                sessaoDiario.skipKeyHoje = skipKey;
                sessaoDiario.filaIds = (sessaoDiario.filaIds || []).filter(id => !skipSet.has(String(id)));
                
                sessaoDiario.indiceAtual = 0;
                
                if (!sessaoDiario.filaIds.length) {
                    renderSessaoDiario(null);
                } else {
                    renderSessaoDiario(getEntradaAtualSessao());
                }
            } else {
                // Treino Livre: TL-1/TL-2
                // Se runner est√° ativo, mostrar runner
                if (window.treinoLivreEstado?.ativo) {
                    renderTreinoLivreRunner();
                    return;
                }
                // Se j√° h√° fila montada, mostra confirma√ß√£o; sen√£o, mostra configura√ß√£o
                if (window.treinoLivreFila && window.treinoLivreFila.length > 0) {
                    renderSessaoDiario(null); // Vai mostrar confirma√ß√£o
                } else {
                    renderSessaoDiario(null); // Vai mostrar configura√ß√£o
                }
            }
        }
        
        function getEntradaAtualSessao() {
            if (!sessaoDiario || !Array.isArray(sessaoDiario.filaIds)) return null;
            const id = sessaoDiario.filaIds[sessaoDiario.indiceAtual];
            return (window.diario.entradas || []).find(e => String(e.id) === String(id)) || null;
        }
        
        // Hist√≥rico de cards j√° respondidos na Sess√£o Programada (read-only, m√°ximo 10)
        if (!window.sessaoProgramadaHistorico) {
            window.sessaoProgramadaHistorico = [];
        }
        
        // ==================== SRS - UI DA SESS√ÉO ====================
        
        // Fun√ß√£o para renderizar a sess√£o dentro do <div id="diarioSessao">
        function renderSessaoDiario(entradaAtual) {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            // Se nenhum card na fila
            if (!entradaAtual) {
                // Limpar hist√≥rico ao sair da sess√£o
                window.sessaoProgramadaHistorico = [];
                
                // P1 FIX: N√ÉO limpar filtros se estiver iniciando sess√£o filtrada da Tarefa (OPUS Ponto 2)
                const estaIniciandoSessaoFiltrada = window.filtrosSessaoDiario && 
                                                     window.filtrosSessaoDiario.origem === 'tarefa';
                if (!estaIniciandoSessaoFiltrada) {
                    // Limpar filtros da sess√£o quando terminar
                    window.filtrosSessaoDiario = null;
                }
                
                const tipo = sessaoDiario.tipo || modoSessaoDiario;
                if (tipo === 'programado') {
                    // P1: Verificar se h√° filtro ativo
                    const temFiltro = window.filtrosSessaoDiario && (window.filtrosSessaoDiario.area || window.filtrosSessaoDiario.tema);
                    const filtroArea = window.filtrosSessaoDiario?.area || '';
                    const filtroTema = window.filtrosSessaoDiario?.tema || '';
                    
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>${temFiltro ? `üìã Sem t√≥picos deste tema para hoje` : `‚úÖ Voc√™ n√£o tem nenhum t√≥pico do Di√°rio <strong>programado para hoje</strong> com os filtros atuais.`}</div>
                            ${temFiltro ? `
                                <div style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.6);">
                                    Filtrado: <strong>${filtroArea ? filtroArea + ' ‚Ä¢ ' : ''}${filtroTema}</strong>
                                </div>
                                <button class="btn btn-small" onclick="limparFiltroSessaoDiario()" style="margin-top: 12px;">
                                    üîÅ Ver tudo (hoje)
                                </button>
                            ` : `
                                <button class="btn btn-small" onclick="setModoSessaoDiario('livre')" style="margin-top: 12px;">
                                    üîÅ Fazer treino livre mesmo assim
                                </button>
                            `}
                        </div>
                    `;
                } else {
                    // TL-1: Treino Livre - mostrar configura√ß√£o ou confirma√ß√£o
                    if (window.treinoLivreFila && window.treinoLivreFila.length > 0) {
                        // Fila j√° montada: mostrar confirma√ß√£o
                        renderConfirmacaoTreinoLivre(window.treinoLivreFila);
                    } else {
                        // Sem fila: mostrar configura√ß√£o
                        renderConfigTreinoLivre();
                    }
                }
                return;
            }
            
            const indice = sessaoDiario.indiceAtual + 1;
            const total = sessaoDiario.filaIds.length;
            const isPrimeiro = sessaoDiario.indiceAtual === 0;
            const historicoVazio = !window.sessaoProgramadaHistorico || window.sessaoProgramadaHistorico.length === 0;
            const podeVerAnterior = sessaoDiario.tipo === 'programado' && !isPrimeiro && !historicoVazio;
            
            // P1: Verificar se h√° filtro ativo para mostrar na UI
            const temFiltro = sessaoDiario.tipo === 'programado' && window.filtrosSessaoDiario && (window.filtrosSessaoDiario.area || window.filtrosSessaoDiario.tema);
            const filtroArea = window.filtrosSessaoDiario?.area || '';
            const filtroTema = window.filtrosSessaoDiario?.tema || '';
            
            // Por padr√£o, resposta escondida at√© clicar
            container.innerHTML = `
                ${sessaoDiario.tipo === 'programado' ? `
                <div class="sessao-programada-nav-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="sessao-nav-anterior" onclick="voltarCardAnteriorSessao()" ${!podeVerAnterior ? 'disabled' : ''} style="background: ${!podeVerAnterior ? 'transparent' : 'rgba(0, 206, 209, 0.1)'}; border: 1px solid rgba(0, 206, 209, ${!podeVerAnterior ? '0.2' : '0.4'}); color: rgba(0, 206, 209, ${!podeVerAnterior ? '0.4' : '0.9'}); font-size: 13px; padding: 10px 14px; border-radius: 8px; cursor: ${!podeVerAnterior ? 'not-allowed' : 'pointer'}; min-height: 44px; font-weight: 500; transition: all 0.2s ease;">
                            ‚Üê Anterior
                        </button>
                        <button class="sessao-nav-proximo" onclick="proximoCardSessaoDiario()" style="background: rgba(0, 206, 209, 0.1); border: 1px solid rgba(0, 206, 209, 0.4); color: rgba(0, 206, 209, 0.9); font-size: 13px; padding: 10px 14px; border-radius: 8px; cursor: pointer; min-height: 44px; font-weight: 500; transition: all 0.2s ease;">
                            Pr√≥ximo ‚Üí
                        </button>
                    </div>
                    <span class="sessao-nav-progresso" style="font-size: 14px; color: rgba(0, 206, 209, 0.7);">${indice} / ${total}</span>
                </div>
                ${temFiltro ? `
                <div style="background: rgba(255,127,80,0.1); border: 1px solid rgba(255,127,80,0.3); border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">
                        üìã Filtrado: <strong style="color: var(--cobre-light);">${filtroArea ? filtroArea + ' ‚Ä¢ ' : ''}${filtroTema}</strong>
                    </span>
                    <button onclick="limparFiltroSessaoDiario()" style="background: transparent; border: 1px solid rgba(255,127,80,0.5); color: var(--cobre-light); font-size: 11px; padding: 4px 10px; border-radius: 4px; cursor: pointer;">
                        Ver tudo (hoje)
                    </button>
                </div>
                ` : ''}
                ` : ''}
                <div class="diario-sessao-card" style="display:flex; flex-direction:column; align-items:stretch !important; justify-content:flex-start !important; text-align:left !important;">
                    <div class="diario-sessao-meta">
                        <span>${entradaAtual.area} ‚Ä¢ ${entradaAtual.tema}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                        ${gerarBadgeSRS(entradaAtual)}
                        ${sessaoDiario.tipo !== 'programado' ? `<span>${indice} / ${total}</span>` : ''}
                            <button onclick="(async () => { await editarEntradaSessaoDiario(); })()" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 16px; padding: 4px 8px; display: flex; align-items: center;" title="Editar pergunta/resposta">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div class="diario-sessao-topico" style="width:100% !important; display:block !important; text-align:left !important; align-self:stretch !important; white-space:pre-wrap !important; overflow-wrap:anywhere !important; word-wrap:break-word !important; justify-content:flex-start !important; align-items:flex-start !important;">‚ùì ${formatarTextoDiario(entradaAtual.topico)}</div>
                    ${entradaAtual.imagemPergunta && entradaAtual.imagemPergunta.thumbKey ? `<div id="sessao-pergunta-thumb-wrap-${entradaAtual.id}" style="margin-top: 8px; margin-bottom: 8px; cursor: pointer;" onclick="diario_abrirViewerImagemPergunta(${entradaAtual.id})"><img id="sessao-pergunta-thumb-img-${entradaAtual.id}" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                    <div id="diarioSessaoRespostaWrapper" class="diario-sessao-resposta" hidden>
                        <div class="diario-sessao-resposta-inner" data-resposta="${entradaAtual.resposta ? 'true' : 'false'}">
                            ${entradaAtual.resposta ? '' : '<em>(Sem resposta cadastrada)</em>'}
                        </div>
                        <div id="sd-thumb-wrap-${entradaAtual.id}" style="margin-top: 12px;" hidden><img id="sd-thumb-img-${entradaAtual.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3); cursor: pointer;" onclick="diario_abrirViewerImagem(${entradaAtual.id})" /></div>
                    </div>
                    <div class="diario-sessao-acoes" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-start;">
                        <button class="btn btn-small" onclick="mostrarRespostaSessaoDiario()">
                            üîç MOSTRAR RESPOSTA
                        </button>
                    </div>
                    <div class="diario-sessao-botoes-qualidade">
                        <button class="btn btn-esqueci btn-danger" onclick="responderSessaoDiario('esqueci')" title="N√£o lembrei ou errei. Vou revisar em breve.">‚ùå ESQUECI</button>
                        <button class="btn btn-lembrei" onclick="responderSessaoDiario('lembrei')" title="Lembrei, mas precisei pensar. Progresso normal.">üëç LEMBREI</button>
                        <button class="btn btn-facil btn-sucesso" onclick="responderSessaoDiario('facil')" title="Veio na hora! Posso esperar mais pra revisar.">üòå F√ÅCIL</button>
                    </div>
                    <div class="diario-sessao-opcoes-container">
                        <div class="diario-sessao-opcoes-row">
                            <button class="sessao-opcao-btn sessao-opcao-pular" onclick="pularSessaoDiario()">
                                ‚è≠Ô∏è Pular
                            </button>
                            <button class="sessao-opcao-btn sessao-opcao-desativar" onclick="desativarSessaoDiarioAtual()">
                                üö´ N√£o revisar mais
                            </button>
                        </div>
                        <button class="sessao-opcao-btn sessao-opcao-excluir" onclick="excluirEntradaDiarioAtual()">
                            üóëÔ∏è Excluir este t√≥pico
                        </button>
                    </div>
                </div>
            `;
            
            // PATCH B: Carregar thumbnail da PERGUNTA na sess√£o programada
            if (entradaAtual && entradaAtual.id && entradaAtual.imagemPergunta && entradaAtual.imagemPergunta.thumbKey) {
                setTimeout(() => {
                    diario_carregarThumbnailUnico(
                        entradaAtual.id,
                        entradaAtual.imagemPergunta.thumbKey,
                        `sessao-pergunta-thumb-img-${entradaAtual.id}`,
                        `sessao-pergunta-thumb-wrap-${entradaAtual.id}`
                    );
                }, 50);
            }
        }
        
        // ==================== TL-1: TREINO LIVRE CUSTOMIZADO ====================
        
        // Inicializar configura√ß√£o padr√£o do Treino Livre
        if (typeof window.treinoLivreConfig === 'undefined') {
            window.treinoLivreConfig = {
                periodo: 'todos',   // 'todos' | 'hoje' | 'ontem' | 'ultimos3' | 'ultimos7' | 'custom'
                dataDe: null,       // YYYY-MM-DD (custom)
                dataAte: null,      // YYYY-MM-DD (custom)
                area: null,          // null = "Todas"
                tema: null,          // null = "Todos"
                quantidade: 10,      // 5, 10, 20, 30
                modoAvaliacao: false // Modo Avalia√ß√£o (TL-3)
            };
        } else {
            // Garantir defaults sem quebrar config antiga
            window.treinoLivreConfig.periodo = window.treinoLivreConfig.periodo || 'todos';
            if (typeof window.treinoLivreConfig.dataDe === 'undefined') window.treinoLivreConfig.dataDe = null;
            if (typeof window.treinoLivreConfig.dataAte === 'undefined') window.treinoLivreConfig.dataAte = null;
        }
        
        // Carregar configura√ß√£o de avalia√ß√£o do localStorage
        if (typeof window.treinoLivreAvaliacaoConfig === 'undefined') {
            try {
                const saved = localStorage.getItem('vrvs_avaliacao_config');
                if (saved) {
                    window.treinoLivreAvaliacaoConfig = JSON.parse(saved);
                } else {
                    window.treinoLivreAvaliacaoConfig = {
                        naosei: 20,
                        entre2: 50,
                        acertaria: 90,
                        dominado: 100,
                        preset: 'prova_teot'
                    };
                }
            } catch (e) {
                // Fallback para valores default
                window.treinoLivreAvaliacaoConfig = {
                    naosei: 20,
                    entre2: 50,
                    acertaria: 90,
                    dominado: 100,
                    preset: 'prova_teot'
                };
            }
        }
        
        // ==================== HELPERS GLOBAIS PARA DATAS (P1) ====================
        // Fun√ß√µes auxiliares globais para normaliza√ß√£o de datas (reutiliz√°veis)
        function ymdDeDateGlobal(d) {
            const ano = d.getFullYear();
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const dia = String(d.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }
        
        // P2: Helper para obter YYYY-MM-DD usando data LOCAL (n√£o UTC)
        function obterYMDLocal() {
            const d = new Date();
            const ano = d.getFullYear();
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const dia = String(d.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }
        
        function normalizarYMDGlobal(valor) {
            if (!valor) return null;
            // Timestamp num√©rico (number ou string num√©rica)
            const asNum = Number(valor);
            if (Number.isFinite(asNum) && asNum > 1000000000000) {
                return ymdDeDateGlobal(new Date(asNum));
            }
            // String tipo "YYYY-MM-DD" ou "YYYY-MM-DDTHH:MM..."
            const s = String(valor);
            const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
            return m ? m[1] : null;
        }
        
        function obterDataCriacaoGlobal(entrada) {
            // Prioridade 1: criadoEm
            const c1 = normalizarYMDGlobal(entrada && entrada.criadoEm);
            if (c1) return c1;
            // Prioridade 2: data
            const c2 = normalizarYMDGlobal(entrada && entrada.data);
            if (c2) return c2;
            // Prioridade 3: derivar do id se for timestamp
            const c3 = normalizarYMDGlobal(entrada && entrada.id);
            if (c3) return c3;
            return null;
        }
        
        // ==================== FILTRO POR PER√çODO (TREINO LIVRE) ====================
        // Compara datas como inteiro YYYYMMDD para evitar bugs de timezone (iOS etc.)
        function filtrarTreinoLivrePorPeriodo(entradas, config) {
            const periodo = (config && config.periodo) ? config.periodo : 'todos';
            if (periodo === 'todos') return entradas;

            function dataParaInteiro(dataStr) {
                if (!dataStr) return null;
                const m = String(dataStr).match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (!m) return null;
                return parseInt(`${m[1]}${m[2]}${m[3]}`, 10);
            }

            function ymdDeDate(d) {
                const ano = d.getFullYear();
                const mes = String(d.getMonth() + 1).padStart(2, '0');
                const dia = String(d.getDate()).padStart(2, '0');
                return `${ano}-${mes}-${dia}`;
            }

            function hojeStr() {
                return ymdDeDate(new Date());
            }

            function subtrairDias(dataStr, dias) {
                // Meio-dia reduz chance de edge DST
                const base = new Date(String(dataStr).slice(0, 10) + 'T12:00:00');
                base.setDate(base.getDate() - dias);
                return ymdDeDate(base);
            }

            // Normaliza qualquer fonte em YYYY-MM-DD (aceita YYYY-MM-DD..., timestamp num√©rico, etc.)
            function normalizarYMD(valor) {
                if (!valor) return null;

                // Timestamp num√©rico (number ou string num√©rica)
                const asNum = Number(valor);
                if (Number.isFinite(asNum) && asNum > 1000000000000) {
                    return ymdDeDate(new Date(asNum));
                }

                // String tipo "YYYY-MM-DD" ou "YYYY-MM-DDTHH:MM..."
                const s = String(valor);
                const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
                if (m) return m[1];

                return null;
            }

            function obterDataCriacao(entrada) {
                // Prioridade 1: criadoEm
                const c1 = normalizarYMD(entrada && entrada.criadoEm);
                if (c1) return c1;

                // Prioridade 2: data
                const c2 = normalizarYMD(entrada && entrada.data);
                if (c2) return c2;

                // Prioridade 3: derivar do id se for timestamp
                const c3 = normalizarYMD(entrada && entrada.id);
                if (c3) return c3;

                return null;
            }

            const hoje = hojeStr();
            let dataInicio = null;
            let dataFim = null;

            switch (periodo) {
                case 'hoje':
                    dataInicio = hoje; dataFim = hoje;
                    break;
                case 'ontem':
                    dataInicio = subtrairDias(hoje, 1);
                    dataFim = subtrairDias(hoje, 1);
                    break;
                case 'ultimos3':
                    dataInicio = subtrairDias(hoje, 2); // inclui hoje
                    dataFim = hoje;
                    break;
                case 'ultimos7':
                    dataInicio = subtrairDias(hoje, 6); // inclui hoje
                    dataFim = hoje;
                    break;
                case 'custom':
                    dataInicio = normalizarYMD(config.dataDe) || null;
                    dataFim = normalizarYMD(config.dataAte) || null;
                    break;
                default:
                    return entradas;
            }

            const inicioInt = dataParaInteiro(dataInicio);
            const fimInt = dataParaInteiro(dataFim);

            return entradas.filter(e => {
                const dc = obterDataCriacao(e);
                if (!dc) return false;

                const di = dataParaInteiro(dc);
                if (!di) return false;

                if (inicioInt && di < inicioInt) return false;
                if (fimInt && di > fimInt) return false;
                return true;
            });
        }

        function contarEntradasDisponiveisTreinoLivre() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return 0;

            const config = window.treinoLivreConfig || {};
            const filtros = {
                area: config.area || null,
                tema: config.tema || null,
                fonte: 'srs', // manter comportamento atual (n√£o mexer em flag/atencao aqui)
                esquecidos: config.esquecidos || false // Ajuste 2: incluir filtro esquecidos
            };

            let entradas = getEntradasTreinoLivreDiario(filtros);
            entradas = filtrarTreinoLivrePorPeriodo(entradas, config);
            return entradas.length;
        }
        
        // Ajuste 2: Contar cards marcados como esquecidos
        function contarEsquecidosTreinoLivre() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) return 0;
            
            return window.diario.entradas.filter(e => 
                e.srs && e.srs.ativo && String(e.srs.ultimaResposta || '').toLowerCase() === 'esqueci'
            ).length;
        }

        // Renderizar painel de configura√ß√£o do Treino Livre
        function renderConfigTreinoLivre() {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            // Obter √°reas e temas dispon√≠veis
            const entradas = window.diario.entradas || [];
            const areas = [...new Set(entradas.map(e => e.area).filter(a => a))].sort();
            const areaSelecionada = window.treinoLivreConfig.area;
            const temas = areaSelecionada 
                ? [...new Set(entradas.filter(e => e.area === areaSelecionada).map(e => e.tema).filter(t => t))].sort()
                : [];
            
            const quantidade = window.treinoLivreConfig.quantidade || 10;
            
            container.innerHTML = `
                <div class="treino-livre-config">
                    <div style="margin-bottom: 16px;">
                        <label style="display:block; font-size:14px; color: rgba(255,255,255,0.9); margin-bottom:8px;">Criados em:</label>
                        <select id="treinoLivrePeriodo"
                            onchange="window.treinoLivreConfig.periodo = this.value; renderConfigTreinoLivre();"
                            style="width:100%; padding:12px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color:white; font-size:14px;">
                            <option value="todos" ${(window.treinoLivreConfig.periodo || 'todos') === 'todos' ? 'selected' : ''}>Todo o per√≠odo</option>
                            <option value="hoje" ${window.treinoLivreConfig.periodo === 'hoje' ? 'selected' : ''}>üìÖ Hoje</option>
                            <option value="ontem" ${window.treinoLivreConfig.periodo === 'ontem' ? 'selected' : ''}>üìÖ Ontem</option>
                            <option value="ultimos3" ${window.treinoLivreConfig.periodo === 'ultimos3' ? 'selected' : ''}>üìÖ √öltimos 3 dias</option>
                            <option value="ultimos7" ${window.treinoLivreConfig.periodo === 'ultimos7' ? 'selected' : ''}>üìÖ √öltimos 7 dias</option>
                            <option value="custom" ${window.treinoLivreConfig.periodo === 'custom' ? 'selected' : ''}>üìÖ Personalizado...</option>
                        </select>
                    </div>

                    ${window.treinoLivreConfig.periodo === 'custom' ? `
                    <div style="margin-bottom: 16px; display:flex; gap:12px;">
                        <div style="flex:1;">
                            <label style="display:block; font-size:12px; color: rgba(255,255,255,0.7); margin-bottom:4px;">De:</label>
                            <input type="date" id="treinoLivreDataDe" value="${window.treinoLivreConfig.dataDe || ''}"
                                onchange="window.treinoLivreConfig.dataDe = this.value; renderConfigTreinoLivre();"
                                style="width:100%; padding:10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color:white; font-size:14px;">
                        </div>
                        <div style="flex:1;">
                            <label style="display:block; font-size:12px; color: rgba(255,255,255,0.7); margin-bottom:4px;">At√©:</label>
                            <input type="date" id="treinoLivreDataAte" value="${window.treinoLivreConfig.dataAte || ''}"
                                onchange="window.treinoLivreConfig.dataAte = this.value; renderConfigTreinoLivre();"
                                style="width:100%; padding:10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color:white; font-size:14px;">
                        </div>
                    </div>
                    ` : ''}

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">√Årea:</label>
                        <select id="treinoLivreArea" onchange="atualizarTemasTreinoLivre(this.value); window.treinoLivreConfig.area = this.value || null; renderConfigTreinoLivre();" style="width: 100%; padding: 12px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            <option value="">Todas as √°reas</option>
                            ${areas.map(a => `<option value="${a}" ${a === areaSelecionada ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Tema:</label>
                        <select id="treinoLivreTema" onchange="window.treinoLivreConfig.tema = this.value || null;" ${!areaSelecionada ? 'disabled' : ''} style="width: 100%; padding: 12px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px; ${!areaSelecionada ? 'opacity: 0.5;' : ''}">
                            <option value="">Todos os temas</option>
                            ${temas.map(t => `<option value="${t}" ${t === window.treinoLivreConfig.tema ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Quantidade:</label>
                        <select id="treinoLivreQuantidade" onchange="window.treinoLivreConfig.quantidade = parseInt(this.value) || 9999;" style="width: 100%; padding: 12px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            <option value="5" ${quantidade === 5 ? 'selected' : ''}>5 itens</option>
                            <option value="10" ${quantidade === 10 ? 'selected' : ''}>10 itens</option>
                            <option value="20" ${quantidade === 20 ? 'selected' : ''}>20 itens</option>
                            <option value="30" ${quantidade === 30 ? 'selected' : ''}>30 itens</option>
                            <option value="50" ${quantidade === 50 ? 'selected' : ''}>50 itens</option>
                            <option value="9999" ${quantidade === 9999 || quantidade > 50 ? 'selected' : ''}>üìö Todos</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.9); cursor: pointer;">
                            <input type="checkbox" id="treinoLivreModoAvaliacao" onchange="window.treinoLivreConfig.modoAvaliacao = this.checked; renderConfigTreinoLivre();" ${window.treinoLivreConfig.modoAvaliacao ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                            <span>üìä Modo Avalia√ß√£o</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; margin-left: 26px;">
                            Gera score 0-100% para autoavalia√ß√£o
                        </div>
                        ${window.treinoLivreConfig.modoAvaliacao ? `
                        <div style="margin-top: 8px; margin-left: 26px;">
                            <a href="#" onclick="event.preventDefault(); abrirConfigAvaliacao(); return false;" style="color: var(--turquesa-light); font-size: 12px; text-decoration: none;">‚öôÔ∏è Config. avan√ßada</a>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,159,64,0.1); border-radius: 8px; border: 1px solid rgba(255,159,64,0.3);">
                        <label style="display: block; font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 12px;">Tipo de treino:</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.9); cursor: pointer;">
                                <input type="radio" name="treinoLivreTipo" value="todos" onchange="window.treinoLivreConfig.esquecidos = false; renderConfigTreinoLivre();" ${!window.treinoLivreConfig.esquecidos ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                <span>‚óã Todos os cards</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.9); cursor: pointer;">
                                <input type="radio" name="treinoLivreTipo" value="esquecidos" onchange="window.treinoLivreConfig.esquecidos = true; renderConfigTreinoLivre();" ${window.treinoLivreConfig.esquecidos ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                <span>‚óè Apenas esquecidos (VRVS 3P)</span>
                            </label>
                        </div>
                        ${window.treinoLivreConfig.esquecidos ? `
                        <div style="margin-top: 12px; padding: 8px; background: rgba(255,159,64,0.1); border-radius: 6px;">
                            <span style="font-size: 13px; color: rgba(255,255,255,0.8);">
                                üìä <strong style="color: #FF9F40;">${contarEsquecidosTreinoLivre()}</strong> cards marcados como esquecido
                            </span>
                        </div>
                        ` : ''}
                        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px; margin-left: 26px;">
                            Cards da √∫ltima revis√£o programada onde voc√™ marcou 'Esqueci'
                        </div>
                    </div>
                    
                    <div style="margin-bottom:16px; padding:12px; background: rgba(0,206,209,0.05); border-radius:8px; text-align:center;">
                        <span style="font-size:14px; color: rgba(255,255,255,0.8);">
                            üî¢ <strong style="color: var(--turquesa-light);">${contarEntradasDisponiveisTreinoLivre()}</strong> entradas dispon√≠veis
                        </span>
                    </div>
                    
                    <button class="btn" onclick="montarTreinoLivre()" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600; ${window.treinoLivreConfig.esquecidos && contarEsquecidosTreinoLivre() === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${window.treinoLivreConfig.esquecidos && contarEsquecidosTreinoLivre() === 0 ? 'disabled' : ''}>
                        ${window.treinoLivreConfig.esquecidos && contarEsquecidosTreinoLivre() === 0 ? 'üéâ Nenhum card esquecido!' : '‚ñ∂ Iniciar Treino'}
                    </button>
                </div>
            `;
        }
        
        // ==================== TL-2: TREINO LIVRE RUNNER ====================
        
        // Iniciar runner do Treino Livre
        function iniciarTreinoLivre() {
            if (!window.treinoLivreFila || window.treinoLivreFila.length === 0) {
                renderConfigTreinoLivre();
                return;
            }
            
            // Criar estado m√≠nimo do runner
            window.treinoLivreEstado = {
                ativo: true,
                indiceAtual: 0
            };
            
            // P2: Inicializar controle de resposta mostrada no modo normal
            window.treinoLivreRespostaMostrada = {};
            
            // A1: Limpar snapshot de detalhes ao iniciar novo treino
            window.treinoLivreFimDados = null;
            
            // Se Modo Avalia√ß√£o ativo, criar estado de avalia√ß√£o
            if (window.treinoLivreConfig.modoAvaliacao) {
                window.treinoLivreAvaliacao = {
                    notas: {},
                    respostaMostrada: {},
                    config: window.treinoLivreAvaliacaoConfig || {
                        naosei: 20,
                        entre2: 50,
                        acertaria: 90,
                        dominado: 100
                    }
                };
                // Criar hist√≥rico de avalia√ß√µes para permitir desfazer/voltar
                window.treinoLivreHistoricoAvaliacoes = [];
            }
            
            renderTreinoLivreRunner();
        }
        
        // Renderizar runner do Treino Livre
        function renderTreinoLivreRunner() {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            if (!window.treinoLivreEstado?.ativo || !window.treinoLivreFila || window.treinoLivreFila.length === 0) {
                // Estado inv√°lido: limpar e voltar para confirma√ß√£o
                window.treinoLivreEstado = null;
                setModoSessaoDiario('livre');
                return;
            }
            
            const indice = window.treinoLivreEstado.indiceAtual;
            const total = window.treinoLivreFila.length;
            const entradaAtual = window.treinoLivreFila[indice];
            
            if (!entradaAtual) {
                // Entrada n√£o encontrada: limpar e voltar
                window.treinoLivreEstado = null;
                setModoSessaoDiario('livre');
                return;
            }
            
            const indiceExibicao = indice + 1; // 1-indexed para exibi√ß√£o
            const isPrimeiro = indice === 0;
            const isUltimo = indice === total - 1;
            
            // Verificar se Modo Avalia√ß√£o est√° ativo
            const modoAvaliacao = window.treinoLivreConfig.modoAvaliacao && window.treinoLivreAvaliacao;
            
            container.innerHTML = `
                <div class="treino-livre-runner-wrapper">
                    <div class="treino-livre-header">
                        <div class="treino-livre-header-left">
                            <button class="treino-livre-sair" onclick="${modoAvaliacao ? 'confirmarSairAvaliacao()' : 'sairTreinoLivre()'}" title="Sair do treino">
                                ‚Üê
                            </button>
                        </div>
                        <div class="treino-livre-header-center">
                            <div class="treino-livre-header-title">${modoAvaliacao ? 'AVALIA√á√ÉO' : 'TREINO LIVRE'}</div>
                            <div class="treino-livre-header-subtitle">${modoAvaliacao ? entradaAtual.tema : '(somente leitura)'}</div>
                        </div>
                        <div class="treino-livre-progresso">${indiceExibicao} / ${total}</div>
                    </div>
                    
                    ${modoAvaliacao ? renderTreinoLivreAvaliacao(entradaAtual, indice, total) : renderTreinoLivreCard(entradaAtual)}
                    
                    <div class="treino-livre-navegacao">
                        <button onclick="treinoLivreAnterior()" ${isPrimeiro && (!modoAvaliacao || !window.treinoLivreHistoricoAvaliacoes?.length) ? 'disabled' : ''} style="min-height: 44px;">
                            ‚Üê Anterior
                        </button>
                        <button onclick="${isUltimo ? 'encerrarTreinoLivre()' : 'treinoLivreProximo()'}" style="min-height: 44px;">
                            ${isUltimo ? 'Encerrar' : 'Pr√≥ximo ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
            
            // FIX: Ao navegar (re-render), se a resposta j√° est√° mostrada e h√° imagem, recarregar thumbnail
            try {
                if (entradaAtual && entradaAtual.id && entradaAtual.imagem) {
                    const chave = String(entradaAtual.id);

                    // modo normal (resposta j√° mostrada)
                    const respJaMostradaNormal =
                        window.treinoLivreRespostaMostrada &&
                        window.treinoLivreRespostaMostrada[chave] === true;

                    // modo avalia√ß√£o (resposta j√° mostrada)
                    const respJaMostradaAvaliacao =
                        modoAvaliacao &&
                        window.treinoLivreAvaliacao &&
                        window.treinoLivreAvaliacao.respostaMostrada &&
                        window.treinoLivreAvaliacao.respostaMostrada[indice] === true;

                    if (respJaMostradaNormal || respJaMostradaAvaliacao) {
                        setTimeout(() => {
                            diario_carregarThumbnailUnico(
                                entradaAtual.id,
                                null,
                                `tl-thumb-img-${entradaAtual.id}`,
                                `tl-thumb-wrap-${entradaAtual.id}`
                            );
                        }, 50);
                    }
                }
                
                // PATCH C: Carregar thumbnail da PERGUNTA (modo normal OU avalia√ß√£o)
                if (entradaAtual && entradaAtual.id && entradaAtual.imagemPergunta && entradaAtual.imagemPergunta.thumbKey) {
                    const prefix = modoAvaliacao ? 'tl-avaliacao' : 'tl';
                    setTimeout(() => {
                        diario_carregarThumbnailUnico(
                            entradaAtual.id,
                            entradaAtual.imagemPergunta.thumbKey,
                            `${prefix}-pergunta-thumb-img-${entradaAtual.id}`,
                            `${prefix}-pergunta-thumb-wrap-${entradaAtual.id}`
                        );
                    }, 50);
                }
            } catch (e) {}
        }
        
        // PATCH C: Helpers √∫nicos para renderizar imagem da pergunta (evita duplica√ß√£o e esquecimentos)
        function renderImagemPerguntaThumbnail(entrada, contextoPrefix) {
            if (!entrada || !entrada.imagemPergunta || !entrada.imagemPergunta.thumbKey) {
                return '';
            }
            return `<div id="${contextoPrefix}-pergunta-thumb-wrap-${entrada.id}" style="margin-top: 8px; margin-bottom: 8px; cursor: pointer;" onclick="diario_abrirViewerImagemPergunta(${entrada.id})"><img id="${contextoPrefix}-pergunta-thumb-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>`;
        }
        
        function posRenderImagemPergunta(entradaId, thumbKey, contextoPrefix) {
            if (!entradaId || !thumbKey) return;
            setTimeout(() => {
                diario_carregarThumbnailUnico(
                    entradaId,
                    thumbKey,
                    `${contextoPrefix}-pergunta-thumb-img-${entradaId}`,
                    `${contextoPrefix}-pergunta-thumb-wrap-${entradaId}`
                );
            }, 50);
        }
        
        // Renderizar card do Treino Livre (reutiliza CSS da Sess√£o Programada)
        function renderTreinoLivreCard(entrada) {
            // P2 v2: Verificar se resposta j√° foi mostrada neste card (usar entrada.id)
            const chave = String(entrada.id);
            const respostaJaMostrada = window.treinoLivreRespostaMostrada && window.treinoLivreRespostaMostrada[chave] === true;
            
            return `
                <div class="diario-sessao-card" style="display:flex; flex-direction:column; align-items:stretch !important; justify-content:flex-start !important; text-align:left !important;">
                    <div class="diario-sessao-meta">
                        <span>${entrada.area} ‚Ä¢ ${entrada.tema}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${gerarBadgeSRS(entrada)}
                            <button onclick="(async () => { await editarEntradaTreinoLivre(); })()" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 16px; padding: 4px 8px; display: flex; align-items: center;" title="Editar pergunta/resposta">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div class="diario-sessao-topico" style="width:100% !important; display:block !important; text-align:left !important; align-self:stretch !important; white-space:pre-wrap !important; overflow-wrap:anywhere !important; word-wrap:break-word !important; justify-content:flex-start !important; align-items:flex-start !important;">‚ùì ${formatarTextoDiario(entrada.topico)}</div>
                    ${renderImagemPerguntaThumbnail(entrada, 'tl')}
                    <div id="treinoLivreRespostaWrapper" class="diario-sessao-resposta" ${respostaJaMostrada ? '' : 'hidden'}>
                        <div class="diario-sessao-resposta-inner" data-resposta-texto="${entrada.resposta ? 'true' : 'false'}">${respostaJaMostrada && entrada.resposta ? formatarTextoDiario(entrada.resposta) : (entrada.resposta ? '' : '<em>(Sem resposta cadastrada)</em>')}</div>
                        <div id="tl-thumb-wrap-${entrada.id}" style="margin-top: 12px;" hidden><img id="tl-thumb-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3); cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})" /></div>
                    </div>
                    ${!respostaJaMostrada ? `
                    <div class="treino-livre-toggle-container" style="margin: 16px 0; text-align: center; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-start;">
                        <button id="treinoLivreToggleBtn" class="btn btn-small" onclick="toggleRespostaTreinoLivre()" style="min-height: 44px;">
                            üëÅÔ∏è MOSTRAR RESPOSTA
                        </button>
                    </div>
                    ` : `
                    <div class="treino-livre-toggle-container" style="margin: 16px 0; text-align: center;">
                        <button id="treinoLivreToggleBtn" class="btn btn-small" onclick="toggleRespostaTreinoLivre()" style="min-height: 44px;">
                            üôà OCULTAR RESPOSTA
                        </button>
                    </div>
                    `}
                </div>
            `;
        }
        
        // ==================== TL-3: RENDERIZA√á√ÉO COM AVALIA√á√ÉO ====================
        
        // Renderizar card do Treino Livre com avalia√ß√£o (TL-3)
        function renderTreinoLivreAvaliacao(entrada, indice, total) {
            const avaliacao = window.treinoLivreAvaliacao;
            const respostaJaMostrada = avaliacao.respostaMostrada[indice] === true;
            const notaAtual = avaliacao.notas[indice] !== undefined ? avaliacao.notas[indice] : null;
            const config = avaliacao.config;
            
            return `
                <div class="diario-sessao-card" style="display:flex; flex-direction:column; align-items:stretch !important; justify-content:flex-start !important; text-align:left !important;">
                    <div class="diario-sessao-meta">
                        <span>${entrada.area} ‚Ä¢ ${entrada.tema}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${gerarBadgeSRS(entrada)}
                            <button onclick="(async () => { await editarEntradaTreinoLivre(); })()" style="background: transparent; border: none; color: rgba(0,206,209,0.7); cursor: pointer; font-size: 16px; padding: 4px 8px; display: flex; align-items: center;" title="Editar pergunta/resposta">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div class="diario-sessao-topico" style="width:100% !important; display:block !important; text-align:left !important; align-self:stretch !important; white-space:pre-wrap !important; overflow-wrap:anywhere !important; word-wrap:break-word !important; justify-content:flex-start !important; align-items:flex-start !important;">‚ùì ${formatarTextoDiario(entrada.topico)}</div>
                    ${renderImagemPerguntaThumbnail(entrada, 'tl-avaliacao')}
                    <div id="treinoLivreRespostaWrapper" class="diario-sessao-resposta" ${respostaJaMostrada ? '' : 'hidden'}>
                        <div class="diario-sessao-resposta-inner" data-resposta-texto="${entrada.resposta ? 'true' : 'false'}">${respostaJaMostrada && entrada.resposta ? formatarTextoDiario(entrada.resposta) : (entrada.resposta ? '' : '<em>(Sem resposta cadastrada)</em>')}</div>
                        <div id="tl-thumb-wrap-${entrada.id}" style="margin-top: 12px;" hidden><img id="tl-thumb-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3); cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})" /></div>
                    </div>
                    ${!respostaJaMostrada ? `
                    <div class="treino-livre-toggle-container" style="margin: 16px 0; text-align: center; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-start;">
                        <button id="treinoLivreToggleBtn" class="btn btn-small" onclick="mostrarRespostaAvaliacao(${indice})" style="min-height: 44px;">
                            üëÅÔ∏è MOSTRAR RESPOSTA
                        </button>
                    </div>
                    ` : `
                    <div style="margin: 16px 0;">
                        <div style="text-align: center; font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px;">Na prova, voc√™ teria...</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <button class="avaliacao-btn" onclick="avaliarTreinoLivre(${indice}, ${config.naosei})" style="padding: 12px; min-height: 44px; border-radius: 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #EF4444; font-size: 13px; font-weight: 600; cursor: pointer;">
                                ‚ùå N√ÉO SEI<br><span style="font-size: 11px; opacity: 0.9;">chutaria</span>
                            </button>
                            <button class="avaliacao-btn" onclick="avaliarTreinoLivre(${indice}, ${config.entre2})" style="padding: 12px; min-height: 44px; border-radius: 8px; background: rgba(255,159,64,0.2); border: 1px solid rgba(255,159,64,0.4); color: #FF9F40; font-size: 13px; font-weight: 600; cursor: pointer;">
                                üé≤ ENTRE 2<br><span style="font-size: 11px; opacity: 0.8;">50/50</span>
                            </button>
                            <button class="avaliacao-btn" onclick="avaliarTreinoLivre(${indice}, ${config.acertaria})" style="padding: 12px; min-height: 44px; border-radius: 8px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); color: #22c55e; font-size: 13px; font-weight: 600; cursor: pointer;">
                                ‚úÖ ACERTARIA<br><span style="font-size: 11px; opacity: 0.8;">alta conf.</span>
                            </button>
                            <button class="avaliacao-btn" onclick="avaliarTreinoLivre(${indice}, ${config.dominado})" style="padding: 12px; min-height: 44px; border-radius: 8px; background: rgba(0,206,209,0.2); border: 1px solid rgba(0,206,209,0.4); color: var(--turquesa-light); font-size: 13px; font-weight: 600; cursor: pointer;">
                                ‚≠ê DOMINADO<br><span style="font-size: 11px; opacity: 0.8;">explicaria</span>
                            </button>
                        </div>
                        <div style="text-align: center;">
                            <button class="link-btn" onclick="pularAvaliacaoTreinoLivre(${indice})" style="font-size: 13px; min-height: 44px; padding: 8px;">
                                ‚è≠Ô∏è PULAR
                            </button>
                        </div>
                    </div>
                    `}
                </div>
            `;
        }
        
        // Mostrar resposta na avalia√ß√£o
        function mostrarRespostaAvaliacao(indice) {
            if (!window.treinoLivreAvaliacao) return;
            
            // Setar estado e deixar o re-render preencher via template
            window.treinoLivreAvaliacao.respostaMostrada[indice] = true;
            renderTreinoLivreRunner();
            
            // PATCH 2: Carregar thumbnail ap√≥s mostrar resposta
            const entrada = window.treinoLivreFila && window.treinoLivreFila[indice];
            if (entrada && entrada.id) {
                setTimeout(() => {
                    diario_carregarThumbnailUnico(
                        entrada.id,
                        null, // Loader busca da entrada via fallback
                        `tl-thumb-img-${entrada.id}`,
                        `tl-thumb-wrap-${entrada.id}`
                    );
                }, 50);
                
                // PATCH B: Carregar thumbnail da PERGUNTA tamb√©m na avalia√ß√£o
                if (entrada.imagemPergunta && entrada.imagemPergunta.thumbKey) {
                    setTimeout(() => {
                        diario_carregarThumbnailUnico(
                            entrada.id,
                            entrada.imagemPergunta.thumbKey,
                            `tl-avaliacao-pergunta-thumb-img-${entrada.id}`,
                            `tl-avaliacao-pergunta-thumb-wrap-${entrada.id}`
                        );
                    }, 50);
                }
            }
        }
        
        // Toggle mostrar/esconder resposta no Treino Livre (modo normal)
        function toggleRespostaTreinoLivre() {
            const wrapper = document.getElementById('treinoLivreRespostaWrapper');
            if (!wrapper) return;
            
            // P2 v2: Usar atributo hidden + entrada.id
            const indice = window.treinoLivreEstado?.indiceAtual;
            const entradaAtual = window.treinoLivreFila && indice !== undefined ? window.treinoLivreFila[indice] : null;
            const chave = entradaAtual ? String(entradaAtual.id) : null;
            const inner = wrapper.querySelector('.diario-sessao-resposta-inner');
            const btn = document.getElementById('treinoLivreToggleBtn');
            
            // Se est√° escondida, mostrar
            if (wrapper.hidden) {
                wrapper.hidden = false;
                
                // P2 v2: Registrar que resposta foi mostrada neste card (usar entrada.id)
                if (chave) {
                    if (!window.treinoLivreRespostaMostrada) {
                        window.treinoLivreRespostaMostrada = {};
                    }
                    window.treinoLivreRespostaMostrada[chave] = true;
                }
                
                // Preencher resposta se ainda n√£o foi preenchida
                if (inner && inner.getAttribute('data-resposta-texto') === 'true') {
                    if (entradaAtual && entradaAtual.resposta && !inner.textContent.trim()) {
                        inner.textContent = formatarTextoDiario(entradaAtual.resposta);
                    }
                }
                
                // B2S-FIX: Carregar thumbnail quando resposta √© mostrada (com setTimeout)
                if (entradaAtual && entradaAtual.id) {
                    setTimeout(() => {
                        diario_carregarThumbnailUnico(
                            entradaAtual.id,
                            null, // Loader busca da entrada via fallback
                            `tl-thumb-img-${entradaAtual.id}`,
                            `tl-thumb-wrap-${entradaAtual.id}`
                        );
                    }, 50);
                }
                
                if (btn) btn.textContent = 'üôà OCULTAR RESPOSTA';
            } else {
                // Esconder
                wrapper.hidden = true;
                
                // P2 v2: Registrar que resposta foi escondida (usar entrada.id)
                if (chave && window.treinoLivreRespostaMostrada) {
                    window.treinoLivreRespostaMostrada[chave] = false;
                }
                
                if (btn) btn.textContent = 'üëÅÔ∏è MOSTRAR RESPOSTA';
            }
        }
        
        // S1-EXT: Editar entrada durante Treino Livre (reutiliza pipeline de sess√£o)
        async function editarEntradaTreinoLivre() {
            const indice = window.treinoLivreEstado?.indiceAtual;
            if (indice === undefined || !window.treinoLivreFila) return;
            
            const entradaAtual = window.treinoLivreFila[indice];
            if (!entradaAtual) return;
            
            // CR√çTICO: Marcar flag ANTES de chamar editarEntradaDiario
            // Isso garante que a fun√ß√£o sabe que veio da sess√£o (Treino Livre)
            window.editandoDaSessao = true;
            
            // Usar fun√ß√£o existente de edi√ß√£o (mesma da Sess√£o de Revis√£o)
            await editarEntradaDiario(entradaAtual.id);
        }
        
        // Avaliar card
        function avaliarTreinoLivre(indice, nota) {
            if (!window.treinoLivreAvaliacao) return;
            
            // Salvar snapshot no hist√≥rico ANTES de avan√ßar (permite desfazer)
            if (!window.treinoLivreHistoricoAvaliacoes) {
                window.treinoLivreHistoricoAvaliacoes = [];
            }
            
            const snapshot = {
                indice: window.treinoLivreEstado.indiceAtual,
                nota: window.treinoLivreAvaliacao.notas[indice],
                respostaMostrada: window.treinoLivreAvaliacao.respostaMostrada[indice] === true
            };
            
            window.treinoLivreHistoricoAvaliacoes.push(snapshot);
            // Limitar hist√≥rico a √∫ltimos 10
            window.treinoLivreHistoricoAvaliacoes = window.treinoLivreHistoricoAvaliacoes.slice(-10);
            
            window.treinoLivreAvaliacao.notas[indice] = nota;
            treinoLivreProximo();
        }
        
        // Pular avalia√ß√£o
        function pularAvaliacaoTreinoLivre(indice) {
            if (!window.treinoLivreAvaliacao) return;
            
            // Salvar snapshot no hist√≥rico ANTES de avan√ßar (permite desfazer)
            if (!window.treinoLivreHistoricoAvaliacoes) {
                window.treinoLivreHistoricoAvaliacoes = [];
            }
            
            const snapshot = {
                indice: window.treinoLivreEstado.indiceAtual,
                nota: window.treinoLivreAvaliacao.notas[indice],
                respostaMostrada: window.treinoLivreAvaliacao.respostaMostrada[indice] === true
            };
            
            window.treinoLivreHistoricoAvaliacoes.push(snapshot);
            // Limitar hist√≥rico a √∫ltimos 10
            window.treinoLivreHistoricoAvaliacoes = window.treinoLivreHistoricoAvaliacoes.slice(-10);
            
            window.treinoLivreAvaliacao.notas[indice] = null;
            treinoLivreProximo();
        }
        
        // Confirmar sair da avalia√ß√£o
        function confirmarSairAvaliacao() {
            const avaliacao = window.treinoLivreAvaliacao;
            if (!avaliacao) {
                sairTreinoLivre();
                return;
            }
            
            const nAvaliados = Object.keys(avaliacao.notas).filter(i => avaliacao.notas[i] !== null && avaliacao.notas[i] !== undefined).length;
            const total = window.treinoLivreFila ? window.treinoLivreFila.length : 0;
            
            if (!confirm(`Sair da avalia√ß√£o?\n\nVoc√™ avaliou ${nAvaliados} de ${total} cards.\nO progresso ser√° perdido.`)) {
                return;
            }
            
            window.treinoLivreAvaliacao = null;
            sairTreinoLivre();
        }
        
        // Navega√ß√£o: Pr√≥ximo
        function treinoLivreProximo() {
            if (!window.treinoLivreEstado?.ativo || !window.treinoLivreFila) return;
            
            const total = window.treinoLivreFila.length;
            if (window.treinoLivreEstado.indiceAtual < total - 1) {
                window.treinoLivreEstado.indiceAtual++;
                renderTreinoLivreRunner();
            }
        }
        
        // Navega√ß√£o: Anterior
        function treinoLivreAnterior() {
            if (!window.treinoLivreEstado?.ativo) return;
            
            const modoAvaliacao = window.treinoLivreConfig.modoAvaliacao && window.treinoLivreAvaliacao;
            
            // Se Modo Avalia√ß√£o ativo e tem hist√≥rico, restaurar do hist√≥rico
            if (modoAvaliacao && window.treinoLivreHistoricoAvaliacoes && window.treinoLivreHistoricoAvaliacoes.length > 0) {
                // Pegar √∫ltimo snapshot do hist√≥rico
                const snapshot = window.treinoLivreHistoricoAvaliacoes[window.treinoLivreHistoricoAvaliacoes.length - 1];
                
                // Restaurar estado
                window.treinoLivreEstado.indiceAtual = snapshot.indice;
                window.treinoLivreAvaliacao.notas[snapshot.indice] = snapshot.nota;
                window.treinoLivreAvaliacao.respostaMostrada[snapshot.indice] = snapshot.respostaMostrada;
                
                // Remover snapshot do hist√≥rico (j√° foi restaurado)
                window.treinoLivreHistoricoAvaliacoes.pop();
                
                renderTreinoLivreRunner();
            } else if (window.treinoLivreEstado.indiceAtual > 0) {
                // Navega√ß√£o normal (sem Modo Avalia√ß√£o ou sem hist√≥rico)
                window.treinoLivreEstado.indiceAtual--;
                renderTreinoLivreRunner();
            }
        }
        
        // Sair do runner (volta para confirma√ß√£o/config)
        function sairTreinoLivre() {
            window.treinoLivreEstado = null;
            window.treinoLivreAvaliacao = null; // Limpar avalia√ß√£o
            window.treinoLivreHistoricoAvaliacoes = null; // Limpar hist√≥rico
            window.treinoLivreRespostaMostrada = null; // P2: Limpar estado de resposta mostrada
            window.treinoLivreFimDados = null; // A1: Limpar snapshot de detalhes
            setModoSessaoDiario('livre');
        }
        
        // Encerrar treino (mostra tela final)
        function encerrarTreinoLivre() {
            if (!window.treinoLivreFila) return;
            
            const total = window.treinoLivreFila.length;
            const modoAvaliacao = window.treinoLivreConfig.modoAvaliacao && window.treinoLivreAvaliacao;
            
            // Se Modo Avalia√ß√£o, calcular feedback antes de renderizar
            let resultado = null;
            if (modoAvaliacao) {
                resultado = calcularFeedbackTL3();
            }
            
            // PATCH 3: Criar snapshot ANTES de limpar (para detalhes por card + ver respostas)
            // Sempre criar snapshot, tanto para avalia√ß√£o quanto para treino normal
            if (window.treinoLivreFila && window.treinoLivreFila.length > 0) {
                window.treinoLivreFimDados = window.treinoLivreFimDados || {};
                window.treinoLivreFimDados.fila = [...window.treinoLivreFila]; // c√≥pia do array
                window.treinoLivreFimDados.modo = modoAvaliacao ? 'avaliacao' : 'normal';
                
                // Se Modo Avalia√ß√£o, incluir notas e config
                if (modoAvaliacao && window.treinoLivreAvaliacao) {
                    window.treinoLivreFimDados.notas = { ...window.treinoLivreAvaliacao.notas };
                    window.treinoLivreFimDados.config = { ...window.treinoLivreAvaliacao.config };
                }
            }
            
            window.treinoLivreEstado = null;
            window.treinoLivreAvaliacao = null; // Limpar avalia√ß√£o
            window.treinoLivreRespostaMostrada = null; // P2: Limpar estado de resposta mostrada
            renderTreinoLivreFim(total, resultado);
        }
        
        // Calcular feedback TL-3
        function calcularFeedbackTL3() {
            if (!window.treinoLivreAvaliacao || !window.treinoLivreFila) {
                return null;
            }
            
            const notas = window.treinoLivreFila.map((e, i) => window.treinoLivreAvaliacao.notas[i]);
            const avaliados = notas.filter(n => n !== null && n !== undefined);
            const nTotal = notas.length;
            const nAvaliados = avaliados.length;
            
            if (nAvaliados === 0) {
                return {
                    score: null,
                    motivo: 'Nenhum card avaliado',
                    breakdown: { total: nTotal, avaliados: 0 }
                };
            }
            
            // C√°lculo: m√©dia simples dos avaliados
            const soma = avaliados.reduce((a, b) => a + b, 0);
            const score = Math.round(soma / nAvaliados);
            
            // Cobertura
            const cobertura = Math.round(100 * nAvaliados / nTotal);
            
            // Breakdown
            const config = window.treinoLivreAvaliacao.config;
            const breakdown = {
                total: nTotal,
                avaliados: nAvaliados,
                cobertura: cobertura,
                dominado: avaliados.filter(n => n === config.dominado).length,
                acertaria: avaliados.filter(n => n === config.acertaria).length,
                entre2: avaliados.filter(n => n === config.entre2).length,
                naosei: avaliados.filter(n => n === config.naosei).length,
                pulados: nTotal - nAvaliados
            };
            
            // Avisos
            const avisos = [];
            if (nAvaliados < 5) avisos.push('Poucos cards avaliados');
            if (cobertura < 60) avisos.push('Cobertura baixa');
            
            return { score, breakdown, avisos };
        }
        
        // A1: Obter cards ordenados por nota (pior desempenho primeiro)
        function obterCardsOrdenadosPorNota() {
            if (!window.treinoLivreFimDados) return [];
            
            const { fila, notas, config } = window.treinoLivreFimDados;
            
            return fila
                .map((entrada, indice) => ({
                    entrada: entrada,
                    indice: indice,
                    nota: notas[indice] || null,
                    notaTexto: obterTextoNota(notas[indice], config)
                }))
                .sort((a, b) => {
                    // Ordenar: menor nota primeiro (pior desempenho primeiro)
                    // null (pulados) vai pro final
                    if (a.nota === null && b.nota === null) return 0;
                    if (a.nota === null) return 1; // null vai pro final
                    if (b.nota === null) return -1;
                    return a.nota - b.nota; // ASC: menor primeiro
                });
        }
        
        // A1: Helper para obter texto da nota
        function obterTextoNota(nota, config) {
            if (nota === null || nota === undefined) return '‚è≠Ô∏è Pulado';
            if (nota === config.naosei) return '‚ùå N√ÉO SEI';
            if (nota === config.entre2) return 'üé≤ ENTRE 2';
            if (nota === config.acertaria) return '‚úÖ ACERTARIA';
            if (nota === config.dominado) return '‚≠ê DOMINADO';
            return `Nota: ${nota}`;
        }
        
        // A1: Toggle detalhes por card (fun√ß√£o global para onclick)
        window.toggleDetalhesTreinoFim = function() {
            const container = document.getElementById('treinoDetalhesBox');
            const btn = document.getElementById('btnToggleDetalhes');
            if (!container || !btn) return;
            
            const estaVisivel = container.style.display !== 'none';
            
            if (estaVisivel) {
                // Fechar
                container.style.display = 'none';
                btn.textContent = 'üìã Ver detalhes por card';
            } else {
                // Abrir: renderizar lista se ainda n√£o foi renderizada
                if (!container.hasAttribute('data-renderizado')) {
                    const cards = obterCardsOrdenadosPorNota();
                    if (cards.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Nenhum detalhe dispon√≠vel</div>';
                    } else {
                        // A1-PRO: Container com cards colaps√°veis (<details><summary>)
                        let html = '<div id="treinoFimDetalhes" style="max-height: 60vh; overflow-y: auto;">';
                        cards.forEach((item) => {
                            const { entrada, nota, notaTexto } = item;
                            // A1-PRO: Cor da borda baseada na nota (aplicada via data-nota + inline style)
                            const corStatus = nota === null ? 'rgba(255,255,255,0.3)' : nota <= 50 ? 'rgba(255,100,100,0.6)' : nota <= 90 ? 'rgba(255,200,100,0.6)' : 'rgba(100,255,100,0.6)';
                            html += `
                                <details class="card-resultado" data-nota="${nota !== null ? nota : 'null'}" style="border-left-color: ${corStatus};">
                                    <summary class="card-resultado-header">
                                        <div class="card-resultado-nota">
                                            <strong>${notaTexto}</strong> ${nota !== null ? `(${nota}%)` : ''}
                                        </div>
                                        <div class="card-resultado-meta">
                                            ${escapeHtml(entrada.area || '')} ‚Ä¢ ${escapeHtml(entrada.tema || '')}
                                        </div>
                                    </summary>
                                    <div class="card-resultado-conteudo">
                                        <div class="card-resultado-pergunta">
                                            ${entrada.topico ? escapeHtml(entrada.topico) : '(Sem t√≥pico)'}
                                        </div>
                                        ${entrada.imagemPergunta && entrada.imagemPergunta.thumbKey ? `<div id="resultado-pergunta-thumb-wrap-${entrada.id}" style="margin-top: 8px; margin-bottom: 8px; cursor: pointer;" onclick="diario_abrirViewerImagemPergunta(${entrada.id})"><img id="resultado-pergunta-thumb-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                                        <button onclick="toggleRespostaTreinoFim(${entrada.id})" style="background: rgba(0,206,209,0.15); border: 1px solid rgba(0,206,209,0.3); color: var(--turquesa-light); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px;">
                                            üëÅÔ∏è Ver Resposta
                                        </button>
                                        <div id="resposta_treino_${entrada.id}" style="display: none; background: rgba(0,206,209,0.1); border-left: 3px solid var(--turquesa-main); padding: 10px; border-radius: 6px; margin-top: 12px; font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                                            <span style="font-size: 13px;">‚úÖ</span><br>
                                            <span style="white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-word;">${entrada.resposta ? formatarTextoDiario(entrada.resposta) : '(Sem resposta ainda)'}</span>
                                            ${entrada.imagem && entrada.imagem.thumbKey ? `<div id="treino-img-thumb-${entrada.id}" style="margin-top: 12px; cursor: pointer;" onclick="diario_abrirViewerImagem(${entrada.id})"><img id="treino-img-${entrada.id}" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);" /></div>` : ''}
                                        </div>
                                    </div>
                                </details>
                            `;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                        
                        // ALVO A: Carregar thumbnails das imagens da pergunta
                        cards.forEach((item) => {
                            const { entrada } = item;
                            if (entrada && entrada.id && entrada.imagemPergunta && entrada.imagemPergunta.thumbKey) {
                                setTimeout(() => {
                                    diario_carregarThumbnailUnico(
                                        entrada.id,
                                        entrada.imagemPergunta.thumbKey,
                                        `resultado-pergunta-thumb-img-${entrada.id}`,
                                        `resultado-pergunta-thumb-wrap-${entrada.id}`
                                    );
                                }, 50);
                            }
                        });
                    }
                    container.setAttribute('data-renderizado', 'true');
                }
                container.style.display = 'block';
                btn.textContent = 'üëÅÔ∏è Ocultar detalhes';
            }
        };
        
        // Renderizar tela final do Treino Livre
        function renderTreinoLivreFim(total, resultado) {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            // Se Modo Avalia√ß√£o e tem resultado, mostrar resultado completo
            if (resultado && resultado.score !== null) {
                const { score, breakdown, avisos } = resultado;
                const primeiroCard = window.treinoLivreFila[0];
                
                container.innerHTML = `
                    <div class="treino-livre-fim">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 20px; font-weight: 600; color: var(--turquesa-light); margin-bottom: 8px;">üìä RESULTADO DA AVALIA√á√ÉO</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">${primeiroCard.tema}</div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 48px; font-weight: bold; color: var(--turquesa-light); margin-bottom: 8px;">${score}%</div>
                            <div style="width: 100%; height: 24px; background: rgba(5,25,30,0.8); border-radius: 12px; overflow: hidden; margin-bottom: 12px;">
                                <div style="width: ${score}%; height: 100%; background: linear-gradient(90deg, var(--turquesa-main), var(--turquesa-light)); transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(20,35,45,0.6); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--turquesa-light); margin-bottom: 12px;">üìã Detalhes:</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                                <div>Total: ${breakdown.total} cards</div>
                                <div>Avaliados: ${breakdown.avaliados} (${breakdown.cobertura}%)</div>
                                <div style="margin-top: 12px;">
                                    <div>‚≠ê Dominado: ${breakdown.dominado}</div>
                                    <div>‚úÖ Acertaria: ${breakdown.acertaria}</div>
                                    <div>üé≤ Entre 2: ${breakdown.entre2}</div>
                                    <div>‚ùå N√£o sei: ${breakdown.naosei}</div>
                                    ${breakdown.pulados > 0 ? `<div>‚è≠Ô∏è Pulados: ${breakdown.pulados}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${avisos.length > 0 ? `
                        <div style="background: rgba(255,159,64,0.1); border: 1px solid rgba(255,159,64,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #FF9F40;">
                                ‚ö†Ô∏è ${avisos.join(' ‚Äî ')} ‚Äî resultado pode n√£o ser representativo.
                            </div>
                        </div>
                        ` : ''}
                        
                        
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 20px; font-style: italic;">
                            Anote o score e registre manualmente na aba Feedback, se quiser.
                        </div>
                        
                        ${window.treinoLivreFimDados && window.treinoLivreFimDados.modo === 'avaliacao' ? `
                        <button id="btnToggleDetalhes" class="btn" onclick="window.toggleDetalhesTreinoFim()" style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 12px; background: rgba(0, 206, 209, 0.2); border: 1px solid var(--turquesa-main);">
                            üìã Ver detalhes por card
                        </button>
                        <div id="treinoDetalhesBox" style="display: none; margin-bottom: 12px;"></div>
                        ` : ''}
                        
                        <button class="btn" onclick="sairTreinoLivre()" style="width: 100%; padding: 12px; font-size: 14px;">
                            Voltar ao Di√°rio
                        </button>
                    </div>
                `;
                return;
            }
            
            // Se nenhum avaliado, mostrar mensagem espec√≠fica
            if (resultado && resultado.score === null) {
                container.innerHTML = `
                    <div class="treino-livre-fim">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 20px; font-weight: 600; color: var(--turquesa-light); margin-bottom: 8px;">üìä RESULTADO DA AVALIA√á√ÉO</div>
                        </div>
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <div style="font-size: 16px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Nenhum card avaliado</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
                                Voc√™ pulou todos os ${total} cards.<br>
                                N√£o √© poss√≠vel calcular um score.
                            </div>
                        </div>
                        <button class="btn" onclick="sairTreinoLivre()" style="width: 100%; padding: 12px; font-size: 14px;">
                            Voltar ao Di√°rio
                        </button>
                    </div>
                `;
                return;
            }
            
            // Tela final normal (TL-2)
            container.innerHTML = `
                <div class="treino-livre-fim">
                    <div class="treino-livre-fim-titulo">‚úì Treino conclu√≠do</div>
                    <div class="treino-livre-fim-detalhe">${total} itens revisados</div>
                    <div class="treino-livre-fim-disclaimer">(nenhuma altera√ß√£o salva)</div>
                    
                    
                    <button class="btn" onclick="sairTreinoLivre()" style="padding: 12px 24px; font-size: 14px;">
                        Voltar ao Di√°rio
                    </button>
                </div>
            `;
        }
        
        // ==================== FIM TL-2 ====================
        
        // Atualizar dropdown de temas baseado na √°rea selecionada
        function atualizarTemasTreinoLivre(area) {
            window.treinoLivreConfig.area = area || null;
            if (!area) {
                window.treinoLivreConfig.tema = null;
            }
            const temaSelect = document.getElementById('treinoLivreTema');
            if (temaSelect) {
                temaSelect.disabled = !area;
            }
        }
        
        // Montar fila do Treino Livre baseado na configura√ß√£o
        function montarTreinoLivre() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma entrada encontrada no Di√°rio.', 'error');
                return;
            }
            
            const config = window.treinoLivreConfig;
            
            // Ajuste 2: Modo "Esquecidos" n√£o precisa de filtro de per√≠odo/tema
            const modoEsquecidos = !!config.esquecidos || config.tipoTreino === 'esquecidos' || config.apenasEsquecidos === true;
            
            // Valida√ß√£o: Modo Avalia√ß√£o requer tema espec√≠fico OU filtro por per√≠odo (exceto modo Esquecidos)
            // PATCH C: "Todo o per√≠odo" (todos) √© filtro v√°lido, n√£o deve bloquear
            if (config.modoAvaliacao && !modoEsquecidos && !config.tema && !config.periodo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Para usar Modo Avalia√ß√£o, selecione um tema espec√≠fico ou filtre por per√≠odo.', 'error');
                return;
            }

            // Valida√ß√£o: Per√≠odo personalizado requer pelo menos uma data
            if (config.periodo === 'custom' && !config.dataDe && !config.dataAte) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Para per√≠odo personalizado, preencha pelo menos uma data.', 'error');
                return;
            }

            // Valida√ß√£o: Datas invertidas no per√≠odo personalizado
            if (config.periodo === 'custom' && config.dataDe && config.dataAte) {
                const deInt = parseInt(String(config.dataDe).slice(0,10).replace(/-/g,''), 10);
                const ateInt = parseInt(String(config.dataAte).slice(0,10).replace(/-/g,''), 10);
                if (deInt > ateInt) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è A data "De" n√£o pode ser posterior √† data "At√©".', 'error');
                    return;
                }
            }
            
            // Ajuste 2: Verificar se filtro "esquecidos" est√° ativo
            const filtros = {
                area: config.area || null,
                tema: config.tema || null,
                fonte: 'srs',  // Treino Livre sempre usa apenas VRVS 3P ativo
                esquecidos: config.esquecidos || false // Ajuste 2: novo filtro
            };
            
            // Obter entradas filtradas
            let entradas = getEntradasTreinoLivreDiario(filtros);
            
            // Ajuste 2: Valida√ß√£o se filtro "esquecidos" est√° ativo mas n√£o h√° esquecidos
            if (config.esquecidos) {
                const totalEsquecidos = contarEsquecidosTreinoLivre();
                if (totalEsquecidos === 0) {
                    mostrarNotificacaoFeedback('üéâ Nenhum card marcado como "esqueci". Parab√©ns!', 'success');
                    return;
                }
            }
            
            // Aplicar filtro de per√≠odo
            entradas = filtrarTreinoLivrePorPeriodo(entradas, config);

            // Feedback se per√≠odo n√£o tem entradas
            if (entradas.length === 0 && config.periodo !== 'todos') {
                const msgs = {
                    hoje: 'Nenhuma entrada criada hoje.',
                    ontem: 'Nenhuma entrada criada ontem.',
                    ultimos3: 'Nenhuma entrada nos √∫ltimos 3 dias.',
                    ultimos7: 'Nenhuma entrada nos √∫ltimos 7 dias.',
                    custom: 'Nenhuma entrada no per√≠odo selecionado.'
                };
                mostrarNotificacaoFeedback('‚ö†Ô∏è ' + (msgs[config.periodo] || 'Nenhuma entrada encontrada.'), 'error');
                return;
            }
            
            // P1: Ordenar: mais recentes primeiro + ordem de inser√ß√£o dentro do mesmo dia
            // Usar decorate-sort-undecorate para garantir chave est√°vel
            // Reutilizar fun√ß√µes auxiliares globais: obterDataCriacaoGlobal() e normalizarYMDGlobal()
            const entradasComChaves = entradas.map((entrada, indiceOriginal) => {
                // Chave prim√°ria: dia (YYYY-MM-DD) - usar obterDataCriacaoGlobal() existente
                const chaveDia = obterDataCriacaoGlobal(entrada) || normalizarYMDGlobal(entrada.data || entrada.criadoEm) || '0000-00-00';
                
                // Chave secund√°ria: ordem de inser√ß√£o (did√°tica)
                let chaveInsercao;
                // Prioridade 1: Date.parse(criadoEm) se existir e for v√°lido
                if (entrada.criadoEm) {
                    const parsed = Date.parse(entrada.criadoEm);
                    if (!isNaN(parsed) && isFinite(parsed)) {
                        chaveInsercao = parsed;
                    } else {
                        // Prioridade 2: parseInt(String(id), 10) - N√ÉO usar Number(id)
                        if (entrada.id) {
                            const parsedId = parseInt(String(entrada.id), 10);
                            chaveInsercao = (!isNaN(parsedId) && isFinite(parsedId)) ? parsedId : indiceOriginal;
                        } else {
                            chaveInsercao = indiceOriginal;
                        }
                    }
                } else {
                    // Prioridade 2: parseInt(String(id), 10) - N√ÉO usar Number(id)
                    if (entrada.id) {
                        const parsedId = parseInt(String(entrada.id), 10);
                        chaveInsercao = (!isNaN(parsedId) && isFinite(parsedId)) ? parsedId : indiceOriginal;
                    } else {
                        // Prioridade 3: √≠ndice original (fallback para estabilidade)
                        chaveInsercao = indiceOriginal;
                    }
                }
                
                return {
                    entrada: entrada,
                    chaveDia: chaveDia,
                    chaveInsercao: chaveInsercao,
                    indiceOriginal: indiceOriginal
                };
            });
            
            // Ordenar por chave composta
            entradasComChaves.sort((a, b) => {
                // Primeira chave: dia (mais recente primeiro - string compare reverso)
                if (b.chaveDia !== a.chaveDia) {
                    return b.chaveDia.localeCompare(a.chaveDia); // '2026-01-03' > '2026-01-02'
                }
                
                // Segunda chave: ordem de inser√ß√£o (menor = mais antigo = aparece depois)
                const diffInsercao = a.chaveInsercao - b.chaveInsercao;
                if (diffInsercao !== 0) return diffInsercao;
                
                // Fallback: manter ordem original se tudo mais empatar
                return a.indiceOriginal - b.indiceOriginal;
            });
            
            // Extrair entradas ordenadas
            entradas = entradasComChaves.map(item => item.entrada);
            
            // Cortar para quantidade solicitada
            const quantidadeSolicitada = config.quantidade || 10;
            const quantidadeReal = Math.min(quantidadeSolicitada, entradas.length);
            const fila = entradas.slice(0, quantidadeReal);
            
            // Salvar fila em mem√≥ria (READ-ONLY)
            window.treinoLivreFila = fila;
            
            // Mostrar confirma√ß√£o
            renderConfirmacaoTreinoLivre(fila);
        }
        
        // Renderizar tela de confirma√ß√£o do Treino Livre
        function renderConfirmacaoTreinoLivre(fila) {
            const container = document.getElementById('diarioSessao');
            if (!container) return;
            
            const total = fila.length;
            
            container.innerHTML = `
                <div class="treino-livre-confirmacao">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 600; color: var(--turquesa-light); margin-bottom: 8px;">
                            ‚úÖ Treino montado: ${total} itens
                        </div>
                        ${total < window.treinoLivreConfig.quantidade ? 
                            `<div style="font-size: 12px; color: rgba(255,255,255,0.7);">Solicitado: ${window.treinoLivreConfig.quantidade}, dispon√≠vel: ${total}</div>` 
                            : ''}
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="window.treinoLivreFila = []; renderConfigTreinoLivre();" style="flex: 1; padding: 12px;">
                            üîÑ Remontar
                        </button>
                        <button class="btn" onclick="iniciarTreinoLivre()" style="flex: 1; padding: 12px;">
                            ${window.treinoLivreConfig.modoAvaliacao ? '‚ñ∂Ô∏è INICIAR AVALIA√á√ÉO' : '‚ñ∂Ô∏è Iniciar Treino'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== TL-3: CONFIG AVAN√áADA ====================
        
        // Abrir modal de Config Avan√ßada
        function abrirConfigAvaliacao() {
            const config = window.treinoLivreAvaliacaoConfig;
            let modal = document.getElementById('modalConfigAvaliacao');
            
            if (!modal) {
                // Criar modal se n√£o existir
                criarModalConfigAvaliacao();
                modal = document.getElementById('modalConfigAvaliacao');
            }
            
            // Preencher valores atuais
            document.getElementById('configAvaliacaoNaosei').value = config.naosei;
            document.getElementById('configAvaliacaoEntre2').value = config.entre2;
            document.getElementById('configAvaliacaoAcertaria').value = config.acertaria;
            document.getElementById('configAvaliacaoDominado').value = config.dominado;
            document.getElementById('configAvaliacaoPreset').value = config.preset || 'prova_teot';
            
            modal.style.display = 'flex';
        }
        
        // Criar HTML do modal
        function criarModalConfigAvaliacao() {
            const modalHTML = `
                <div id="modalConfigAvaliacao" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: linear-gradient(135deg, rgba(10,31,40,0.95), rgba(26,47,53,0.95)); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(0,206,209,0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--turquesa-light); font-size: 18px; margin: 0;">‚öôÔ∏è Valores da Avalia√ß√£o</h3>
                            <button onclick="document.getElementById('modalConfigAvaliacao').style.display = 'none';" style="background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">‚úï</button>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Preset:</label>
                            <select id="configAvaliacaoPreset" onchange="aplicarPresetAvaliacao(this.value)" style="width: 100%; padding: 10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                                <option value="prova_teot">Prova TEOT (padr√£o)</option>
                                <option value="binario">Bin√°rio</option>
                                <option value="conservador">Conservador</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">‚ùå N√ÉO SEI:</label>
                                <input type="number" id="configAvaliacaoNaosei" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">üé≤ ENTRE 2:</label>
                                <input type="number" id="configAvaliacaoEntre2" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">‚úÖ ACERTARIA:</label>
                                <input type="number" id="configAvaliacaoAcertaria" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">‚≠ê DOMINADO:</label>
                                <input type="number" id="configAvaliacaoDominado" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(20,35,45,0.6); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; color: white; font-size: 14px;">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 16px; padding: 12px; background: rgba(255,159,64,0.1); border-radius: 8px; border: 1px solid rgba(255,159,64,0.2);">
                            ‚ö†Ô∏è Valores devem ser 0-100 e crescentes (N√ÉO SEI < ENTRE 2 < ACERTARIA < DOMINADO)
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="restaurarPresetAvaliacao()" style="flex: 1; padding: 12px; min-height: 44px;">Restaurar padr√£o</button>
                            <button class="btn" onclick="salvarConfigAvaliacao()" style="flex: 1; padding: 12px; min-height: 44px;">Salvar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Aplicar preset
        function aplicarPresetAvaliacao(preset) {
            const presets = {
                prova_teot: { naosei: 20, entre2: 50, acertaria: 90, dominado: 100 },
                binario: { naosei: 0, entre2: 50, acertaria: 50, dominado: 100 },
                conservador: { naosei: 10, entre2: 40, acertaria: 80, dominado: 100 }
            };
            
            const valores = presets[preset] || presets.prova_teot;
            document.getElementById('configAvaliacaoNaosei').value = valores.naosei;
            document.getElementById('configAvaliacaoEntre2').value = valores.entre2;
            document.getElementById('configAvaliacaoAcertaria').value = valores.acertaria;
            document.getElementById('configAvaliacaoDominado').value = valores.dominado;
        }
        
        // Restaurar preset padr√£o
        function restaurarPresetAvaliacao() {
            aplicarPresetAvaliacao('prova_teot');
            document.getElementById('configAvaliacaoPreset').value = 'prova_teot';
        }
        
        // Validar configura√ß√£o
        function validarConfigAvaliacao(valores) {
            const erros = [];
            
            // Valores entre 0 e 100
            if (valores.naosei < 0 || valores.naosei > 100) erros.push('N√ÉO SEI deve estar entre 0 e 100');
            if (valores.entre2 < 0 || valores.entre2 > 100) erros.push('ENTRE 2 deve estar entre 0 e 100');
            if (valores.acertaria < 0 || valores.acertaria > 100) erros.push('ACERTARIA deve estar entre 0 e 100');
            if (valores.dominado < 0 || valores.dominado > 100) erros.push('DOMINADO deve estar entre 0 e 100');
            
            // Ordem crescente
            if (valores.naosei >= valores.entre2) erros.push('N√ÉO SEI deve ser menor que ENTRE 2');
            if (valores.entre2 >= valores.acertaria) erros.push('ENTRE 2 deve ser menor que ACERTARIA');
            if (valores.acertaria >= valores.dominado) erros.push('ACERTARIA deve ser menor que DOMINADO');
            
            return erros;
        }
        
        // Salvar configura√ß√£o
        function salvarConfigAvaliacao() {
            const valores = {
                naosei: parseInt(document.getElementById('configAvaliacaoNaosei').value),
                entre2: parseInt(document.getElementById('configAvaliacaoEntre2').value),
                acertaria: parseInt(document.getElementById('configAvaliacaoAcertaria').value),
                dominado: parseInt(document.getElementById('configAvaliacaoDominado').value),
                preset: document.getElementById('configAvaliacaoPreset').value
            };
            
            // Valida√ß√£o
            const erros = validarConfigAvaliacao(valores);
            if (erros.length > 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è ' + erros.join(' '), 'error');
                return;
            }
            
            // Salvar
            window.treinoLivreAvaliacaoConfig = valores;
            localStorage.setItem('vrvs_avaliacao_config', JSON.stringify(valores));
            
            // Fechar modal
            document.getElementById('modalConfigAvaliacao').style.display = 'none';
            mostrarNotificacaoFeedback('‚úÖ Configura√ß√£o salva', 'success');
        }
        
        // Mostrar resposta (apenas altera CSS)
        function mostrarRespostaSessaoDiario() {
            const wrapper = document.getElementById('diarioSessaoRespostaWrapper');
            if (wrapper) {
                // P2 v2: Usar atributo hidden
                wrapper.hidden = false;
                // P4: Usar textContent em vez de innerHTML para fidelidade ao editor
                const inner = wrapper.querySelector('.diario-sessao-resposta-inner');
                if (inner && inner.getAttribute('data-resposta') === 'true') {
                    const entradaAtual = getEntradaAtualSessao();
                    if (entradaAtual && entradaAtual.resposta) {
                        inner.textContent = normalizarTextoDiario(entradaAtual.resposta);
                    }
                }
                
                // B2S-FIX: Carregar thumbnail quando resposta √© mostrada (com setTimeout)
                const entradaAtual = getEntradaAtualSessao();
                if (entradaAtual && entradaAtual.id) {
                    // PATCH B: Carregar thumbnail da PERGUNTA tamb√©m na sess√£o programada
                    if (entradaAtual.imagemPergunta && entradaAtual.imagemPergunta.thumbKey) {
                        setTimeout(() => {
                            diario_carregarThumbnailUnico(
                                entradaAtual.id,
                                entradaAtual.imagemPergunta.thumbKey,
                                `sessao-pergunta-thumb-img-${entradaAtual.id}`,
                                `sessao-pergunta-thumb-wrap-${entradaAtual.id}`
                            );
                        }, 50);
                    }
                    
                    setTimeout(() => {
                        diario_carregarThumbnailUnico(
                            entradaAtual.id,
                            null, // Loader busca da entrada via fallback
                            `sd-thumb-img-${entradaAtual.id}`,
                            `sd-thumb-wrap-${entradaAtual.id}`
                        );
                    }, 50);
                }
            }
        }
        
        // Avan√ßar card ap√≥s resposta "valendo"
        function responderSessaoDiario(qualidade) {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual) return;
            
            // BUG B: Se for sess√£o programada, salvar action com deep clone SRS ANTES de atualizar
            if (sessaoDiario.tipo === 'programado') {
                const action = {
                    tipo: 'avaliacao',
                    entradaId: entradaAtual.id,
                    srsAntes: entradaAtual.srs ? JSON.parse(JSON.stringify(entradaAtual.srs)) : null, // deep clone
                    indiceAntes: sessaoDiario.indiceAtual,
                    timestamp: Date.now()
                };
                window.sessaoProgramadaHistorico.push(action);
                // Limitar hist√≥rico a √∫ltimos 10
                if (window.sessaoProgramadaHistorico.length > 10) {
                    window.sessaoProgramadaHistorico = window.sessaoProgramadaHistorico.slice(-10);
                }
            }
            
            // Se for sess√£o programada, aplica agendamento
            if (sessaoDiario.tipo === 'programado') {
                // Usar vers√£o rastreada para debug
                if (typeof atualizarSRS_VRVS3P_RASTREADO !== 'undefined') {
                    atualizarSRS_VRVS3P_RASTREADO(entradaAtual, normalizarQualidade(qualidade));
                } else {
                registrarRespostaSrsDiario(entradaAtual, qualidade);
                }
                salvarDiario(); // j√° existe; apenas reutilizar
                // Atualizar chip VRVS 3P e indicadores ap√≥s registrar resposta (PATCH 2)
                atualizarChipVrvs3p();
            }
            
            // Avan√ßar na fila
            sessaoDiario.indiceAtual++;
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                // Acabou
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // S5-UX: Helpers para skipToday (por data local, sem UTC)
        function getDataLocalYYYYMMDD(d = new Date()) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getSkipKeyHoje() {
            return `vrvs_skip_cards_${getDataLocalYYYYMMDD(new Date())}`;
        }

        function lerSkipHojeSet(skipKey) {
            try {
                const arr = JSON.parse(localStorage.getItem(skipKey) || '[]');
                return new Set(arr.map(x => String(x)));
            } catch(e) {
                return new Set();
            }
        }

        function gravarSkipHojeSet(skipKey, setIds) {
            try {
                localStorage.setItem(skipKey, JSON.stringify(Array.from(setIds)));
            } catch(e) {}
        }

        // S5-UX: Navegar para pr√≥ximo card (sem registrar resposta/VRVS)
        function proximoCardSessaoDiario() {
            if (!sessaoDiario || !Array.isArray(sessaoDiario.filaIds)) return;
            
            const entradaAtual = typeof getEntradaAtualSessao === 'function' ? getEntradaAtualSessao() : null;
            
            // Registrar no hist√≥rico (programado) para permitir "Anterior" desfazer
            if (sessaoDiario.tipo === 'programado' && entradaAtual) {
                window.sessaoProgramadaHistorico = window.sessaoProgramadaHistorico || [];
                window.sessaoProgramadaHistorico.push({
                    tipo: 'proximo',
                    entradaId: entradaAtual.id,
                    indiceAntes: sessaoDiario.indiceAtual,
                    timestamp: Date.now()
                });
                // Limitar hist√≥rico a √∫ltimos 10
                if (window.sessaoProgramadaHistorico.length > 10) {
                    window.sessaoProgramadaHistorico.shift();
                }
            }
            
            // Avan√ßar √≠ndice
            sessaoDiario.indiceAtual++;
            
            // Renderizar pr√≥ximo ou fim da sess√£o
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }

        // S5-UX: Pular card com confirm + skipToday (remove da sess√£o hoje, volta amanh√£)
        function pularSessaoDiario() {
            const entradaAtual = typeof getEntradaAtualSessao === 'function' ? getEntradaAtualSessao() : null;
            if (!sessaoDiario || !entradaAtual || !Array.isArray(sessaoDiario.filaIds)) return;
            
            // S5-UX: Confirmar antes de pular
            const ok = confirm('Pular este card por hoje?\n\nEle sai da sess√£o de hoje e volta amanh√£.');
            if (!ok) return;
            
            // Adicionar ao skipToday (localStorage por data local)
            const skipKey = sessaoDiario.skipKeyHoje || getSkipKeyHoje();
            const skipSet = lerSkipHojeSet(skipKey);
            skipSet.add(String(entradaAtual.id));
            gravarSkipHojeSet(skipKey, skipSet);
            
            // Remover imediatamente da sess√£o de hoje
            const removedIndex = sessaoDiario.indiceAtual;
            sessaoDiario.filaIds.splice(removedIndex, 1);
            
            // Registrar hist√≥rico (programado) para permitir "Anterior" desfazer o pulo
            if (sessaoDiario.tipo === 'programado') {
                window.sessaoProgramadaHistorico = window.sessaoProgramadaHistorico || [];
                window.sessaoProgramadaHistorico.push({
                    tipo: 'pulo',
                    entradaId: entradaAtual.id,
                    indiceAntes: removedIndex,
                    removedIndex: removedIndex,
                    skipKey: skipKey,
                    timestamp: Date.now()
                });
                // Limitar hist√≥rico a √∫ltimos 10
                if (window.sessaoProgramadaHistorico.length > 10) {
                    window.sessaoProgramadaHistorico.shift();
                }
            }
            
            // Renderizar pr√≥ximo (mesmo √≠ndice, pois removemos o atual)
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // Desativar card da revis√£o (srs.ativo = false)
        function desativarSessaoDiarioAtual() {
            const entradaAtual = getEntradaAtualSessao();
            if (!entradaAtual || !entradaAtual.srs) return;
            
            // Confirma√ß√£o antes de desativar
            const preview = (entradaAtual.topico || '').substring(0, 50) + ((entradaAtual.topico || '').length > 50 ? '...' : '');
            const confirmar = confirm(`üö´ N√ÉO REVISAR MAIS ESTE CARD?\n\nT√≥pico: "${preview}"\n√Årea: ${entradaAtual.area || 'N/A'}\nTema: ${entradaAtual.tema || 'N/A'}\n\nEste card ser√° removido da revis√£o programada.`);
            
            if (!confirmar) return;
            
            entradaAtual.srs.ativo = false;
            salvarDiario();
            // Atualizar chip VRVS 3P ap√≥s desativar
            atualizarChipVrvs3p();
            
            // Remover da fila atual
            sessaoDiario.filaIds.splice(sessaoDiario.indiceAtual, 1);
            if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                renderSessaoDiario(null);
            } else {
                renderSessaoDiario(getEntradaAtualSessao());
            }
        }
        
        // Marcar todas as entradas do Di√°rio para revis√£o (ativar SRS)
        function marcarTodasRevisoes() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma entrada encontrada no Di√°rio.', 'error');
                return;
            }
            
            const hoje = hojeStr();
            let contador = 0;
            
            window.diario.entradas.forEach(entrada => {
                // Se n√£o tem SRS, criar; se j√° tem, ativar
                if (!entrada.srs) {
                    entrada.srs = inicializarSrsVRVS3P(hoje);
                    contador++;
                } else if (!entrada.srs.ativo) {
                    entrada.srs.ativo = true;
                    contador++;
                }
            });
            
            // Salvar e renderizar
            salvarDiarioLS();
            renderDiario();
            renderTarefas();
            
            setTimeout(() => {
                if (contador === 0) {
                    mostrarNotificacaoFeedback('‚ÑπÔ∏è Nada mudou: todas as entradas j√° estavam com revis√£o ativa.', 'success');
                } else {
                    mostrarNotificacaoFeedback(`‚úÖ Revis√µes ativadas em ${contador} entrada(s).`, 'success');
                }
            }, 50);
        }
        
        // Desmarcar todas as entradas do Di√°rio para revis√£o (desativar SRS, mas manter hist√≥rico)
        function desmarcarTodasRevisoes() {
            if (!window.diario || !Array.isArray(window.diario.entradas)) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma entrada encontrada no Di√°rio.', 'error');
                return;
            }
            
            let contador = 0;
            
            window.diario.entradas.forEach(entrada => {
                if (entrada.srs && entrada.srs.ativo) {
                    entrada.srs.ativo = false;
                    contador++;
                }
            });
            
            // Salvar e renderizar
            salvarDiarioLS();
            renderDiario();
            renderTarefas();
            
            setTimeout(() => {
                if (contador === 0) {
                    mostrarNotificacaoFeedback('‚ÑπÔ∏è Nada mudou: n√£o havia entradas com revis√£o ativa.', 'success');
                } else {
                    mostrarNotificacaoFeedback(`‚úÖ Revis√µes desativadas em ${contador} entrada(s).`, 'success');
                }
            }, 50);
        }
        
        // Excluir entrada atual do Di√°rio permanentemente
        function excluirEntradaDiarioAtual() {
            const entrada = getEntradaAtualSessao();
            if (!entrada) return;
            
            // Confirma√ß√£o com detalhes do t√≥pico
            const preview = (entrada.topico || '').substring(0, 50) + ((entrada.topico || '').length > 50 ? '...' : '');
            const confirmar = confirm(`‚ö†Ô∏è EXCLUIR PERMANENTEMENTE?\n\nT√≥pico: "${preview}"\n√Årea: ${entrada.area || 'N/A'}\nTema: ${entrada.tema || 'N/A'}\n\nEsta a√ß√£o n√£o pode ser desfeita.`);
            
            if (!confirmar) return;
            
            // Remover da lista de entradas
            const index = window.diario.entradas.findIndex(e => String(e.id) === String(entrada.id));
            if (index > -1) {
                window.diario.entradas.splice(index, 1);
                salvarDiario();
                
                // Remover da fila da sess√£o atual
                if (sessaoDiario && Array.isArray(sessaoDiario.filaIds)) {
                    const filaIndex = sessaoDiario.filaIds.indexOf(entrada.id);
                    if (filaIndex > -1) {
                        sessaoDiario.filaIds.splice(filaIndex, 1);
                    }
                    
                    // Ajustar √≠ndice se necess√°rio
                    if (sessaoDiario.indiceAtual >= sessaoDiario.filaIds.length) {
                        sessaoDiario.indiceAtual = Math.max(0, sessaoDiario.filaIds.length - 1);
                    }
                }
                
                mostrarNotificacaoFeedback('üóëÔ∏è T√≥pico exclu√≠do permanentemente.', 'success');
                
                // Atualizar contadores com delay para garantir sincronismo visual
                setTimeout(() => {
                    renderDiario();
                    atualizarChipVrvs3p();
                }, 300);
                
                // Avan√ßar para pr√≥ximo card ou finalizar sess√£o
                if (sessaoDiario.filaIds.length === 0) {
                    renderSessaoDiario(null);
                } else {
                    renderSessaoDiario(getEntradaAtualSessao());
                }
            }
        }
        
        // BUG B: Voltar para card anterior e permitir REAVALIAR (undo SRS real)
        function voltarCardAnteriorSessao() {
            if (!window.sessaoProgramadaHistorico || window.sessaoProgramadaHistorico.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è N√£o h√° a√ß√£o anterior para desfazer.', 'error');
                return;
            }
            
            // Pop √∫ltimo action do hist√≥rico
            const action = window.sessaoProgramadaHistorico.pop();
            
            if (!action || !action.entradaId) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è A√ß√£o anterior inv√°lida.', 'error');
                return;
            }
            
            // S5-UX: Tratar desfazer pulo (remover do skipToday e reinserir na fila)
            if (action.tipo === 'pulo') {
                try {
                    const key = action.skipKey || sessaoDiario.skipKeyHoje || getSkipKeyHoje();
                    const set = lerSkipHojeSet(key);
                    set.delete(String(action.entradaId));
                    gravarSkipHojeSet(key, set);
                } catch(e) {
                    console.error('Erro ao remover do skipToday:', e);
                }
                
                if (Array.isArray(sessaoDiario.filaIds)) {
                    const idx = (typeof action.removedIndex === 'number') ? action.removedIndex : action.indiceAntes;
                    sessaoDiario.filaIds.splice(idx, 0, action.entradaId);
                    sessaoDiario.indiceAtual = idx;
                    
                    const entrada = window.diario.entradas.find(e => String(e.id) === String(action.entradaId));
                    if (entrada) {
                        renderSessaoDiario(entrada);
                        return;
                    }
                }
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao desfazer pulo.', 'error');
                return;
            }
            
            // Encontrar entrada no di√°rio
            const entrada = window.diario.entradas.find(e => String(e.id) === String(action.entradaId));
            if (!entrada) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Entrada n√£o encontrada no di√°rio.', 'error');
                return;
            }
            
            // BUG B: Restaurar SRS se foi avalia√ß√£o
            if (action.tipo === 'avaliacao' && action.srsAntes !== null) {
                entrada.srs = JSON.parse(JSON.stringify(action.srsAntes)); // deep clone
            }
            
            // Restaurar √≠ndice (para 'proximo' e 'avaliacao')
            sessaoDiario.indiceAtual = Math.max(0, action.indiceAntes);
            
            // Salvar di√°rio com SRS restaurado (se necess√°rio)
            if (action.tipo === 'avaliacao') {
                salvarDiario();
            }
            
            // Atualizar chip VRVS 3P ap√≥s restaurar
            atualizarChipVrvs3p();
            
            // Renderizar card anterior COM bot√µes ativos (n√£o read-only)
            renderSessaoDiario(entrada);
        }
        
        // ==================== FIM SRS UI ====================
        
        function toggleAtencaoDiario(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (entrada) {
                entrada.atencao = !entrada.atencao;
                entrada.ultimaAtualizacao = new Date().toISOString().split('T')[0];
                salvarDiario();
                renderDiario();
                // Atualizar chip VRVS 3P ap√≥s alterar aten√ß√£o
                atualizarChipVrvs3p();
            }
        }
        
        function formatarDataCompleta(dataStr) {
            const data = new Date(dataStr + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const ontem = new Date(hoje);
            ontem.setDate(ontem.getDate() - 1);
            
            if (dataStr === hoje.toISOString().split('T')[0]) {
                return 'Hoje';
            } else if (dataStr === ontem.toISOString().split('T')[0]) {
                return 'Ontem';
            } else {
                return data.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }
        
        // ==================== NOVAS FUN√á√ïES - REFATORA√á√ÉO v2.0 ====================
        
        // ==================== MODAL NOVA √ÅREA ====================
        
        function abrirModalNovaArea() {
            try {
                const inputNome = document.getElementById('inputNovaAreaNome');
                const modal = document.getElementById('modalNovaArea');
                
                if (!modal) {
                    console.error('[BUG FIX] Modal modalNovaArea n√£o encontrado!');
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao abrir modal de nova √°rea.', 'error');
                    return;
                }
                
                if (inputNome) {
                    inputNome.value = '';
                }
                
                modal.classList.add('active');
            } catch (e) {
                console.error('[BUG FIX] Erro ao abrir modal nova √°rea:', e);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao abrir modal de nova √°rea.', 'error');
            }
        }
        
        function fecharModalNovaArea() {
            document.getElementById('modalNovaArea').classList.remove('active');
        }
        
        function salvarNovaArea(event) {
            event.preventDefault();
            const nomeArea = document.getElementById('inputNovaAreaNome').value.trim();
            
            if (!nomeArea) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Digite um nome para a √°rea!', 'error');
                return;
            }
            
            // Normalizar √°rea
            const areaNormalizada = normalizarArea(nomeArea);
            
            // Verificar se j√° existe usando helper centralizado
            const areasExistentes = getAreasDisponiveisDoPerfilAtivo();
            if (areasExistentes.includes(areaNormalizada)) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è A √°rea "${areaNormalizada}" j√° existe!`, 'error');
                return;
            }
            
            // P4: Salvar √°rea customizada no localStorage
            if (!window.vrvsAreasCustom) window.vrvsAreasCustom = [];
            window.vrvsAreasCustom.push(areaNormalizada);
            window.vrvsAreasCustom = window.vrvsAreasCustom
                .filter((a, i, arr) => arr.indexOf(a) === i) // Deduplicar
                .sort();
            localStorage.setItem(window.vrvs_key('areas_custom'), JSON.stringify(window.vrvsAreasCustom));
            
            // Atualizar TODOS os selects de √°rea na plataforma
            atualizarTodosSelectsArea(areaNormalizada);
            
            // Fechar modal e mostrar sucesso
            fecharModalNovaArea();
            mostrarNotificacaoFeedback(`‚úÖ √Årea "${areaNormalizada}" adicionada com sucesso! Agora est√° dispon√≠vel em todas as abas.`);
        }
        
        // PATCH A: Helper para obter √°reas base (fixas) do perfil ativo
        function getAreasBaseDoPerfil() {
            // SEMPRE retorna [] - plataforma livre, sem √°reas fixas
            return [];
        }
        
        // PATCH A: Helper √∫nico para obter todas as √°reas dispon√≠veis do perfil ativo
        function getAreasDisponiveisDoPerfilAtivo() {
            const areasBase = getAreasBaseDoPerfil();
            const areasDados = dados.map(t => t.area).filter(a => a && a.trim());
            const areasCustom = window.vrvsAreasCustom || [];
            return [...new Set([...areasBase, ...areasCustom, ...areasDados])].sort();
        }
        
        // P4: Helper centralizado para obter lista completa de √°reas dispon√≠veis
        // DEPRECATED: Usar getAreasDisponiveisDoPerfilAtivo() em vez desta fun√ß√£o
        function obterListaAreasDisponiveis() {
            const areasDados = dados.map(t => t.area).filter(a => a && a.trim());
            const areasCustom = window.vrvsAreasCustom || [];
            return [...new Set([...areasCustom, ...areasDados])].sort();
        }
        
        // Fun√ß√£o centralizada para atualizar TODOS os selects de √°rea
        function atualizarTodosSelectsArea(novaArea) {
            // Lista de todos os selects que precisam ser atualizados
            const selectsArea = [
                'modalCadastroArea',  // Modal cadastro tema (corrigido: era 'modalNovaArea' incorreto)
                'editArea',           // Modal edi√ß√£o tema
                'novaArea',           // Formul√°rio cadastro (aba Dados)
                'feedbackArea',        // Formul√°rio Feedback
                'novaDiarioArea',      // Formul√°rio Di√°rio
                'analiseFiltroArea',  // Filtro An√°lises
                'filtroDiarioArea',    // Filtro Di√°rio
                'cadernoFiltroArea'    // Filtro Caderno
            ];
            
            // Obter todas as √°reas existentes usando helper centralizado
            const areasCompletas = getAreasDisponiveisDoPerfilAtivo();
            // Se novaArea n√£o estiver na lista, adicionar temporariamente para atualiza√ß√£o
            if (novaArea && !areasCompletas.includes(novaArea)) {
                areasCompletas.push(novaArea);
                areasCompletas.sort();
            }
            
            // Atualizar cada select
            selectsArea.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const valorAtual = select.value; // Preservar valor selecionado
                const primeiroOption = select.options[0]?.value === '' ? '<option value="">Selecione...</option>' : 
                                      (select.options[0]?.value === 'Todas as √°reas' ? '<option value="">Todas as √°reas</option>' : '');
                
                select.innerHTML = primeiroOption + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                
                // Restaurar valor selecionado se ainda existir
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    select.value = valorAtual;
                }
            });
            
            // Chamar fun√ß√µes espec√≠ficas que dependem de √°reas
            updateFeedbackSelect(); // Atualiza feedbackArea
            atualizarSelectsAnalise(); // Atualiza analiseFiltroArea
            atualizarSelectsCaderno(); // Atualiza cadernoFiltroArea
            
            // Atualizar selects do Di√°rio manualmente (usando areasCompletas j√° criada acima)
            // Atualizar select de √°rea do formul√°rio de nova entrada do Di√°rio
            const novaDiarioArea = document.getElementById('novaDiarioArea');
            if (novaDiarioArea) {
                const valorAtual = novaDiarioArea.value;
                novaDiarioArea.innerHTML = '<option value="">Selecione...</option>' + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    novaDiarioArea.value = valorAtual;
                    atualizarTemasDiario(valorAtual);
                }
            }
            
            // Atualizar filtro de √°rea do Di√°rio
            const filtroDiarioArea = document.getElementById('filtroDiarioArea');
            if (filtroDiarioArea) {
                const valorAtual = filtroDiarioArea.value;
                filtroDiarioArea.innerHTML = '<option value="">Todas as √°reas</option>' + 
                    areasCompletas.map(a => `<option value="${a}">${a}</option>`).join('');
                if (valorAtual && areasCompletas.includes(valorAtual)) {
                    filtroDiarioArea.value = valorAtual;
                }
            }
            
            // Trigger change events para atualizar depend√™ncias
            selectsArea.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && select.value) {
                    select.dispatchEvent(new Event('change'));
                }
            });
        }
        
        // ==================== MODAL CADASTRO ====================
        
        // P4.2: Helper para separar √°reas por origem (usa vari√°veis globais)
        // P4.4 Android: Heur√≠stica para detectar aparelho "zerado" (n√£o mostra AREAS_FIXAS)
        function obterAreasPorOrigem() {
            // Plataforma livre - sem √°reas fixas
            // Fonte 1: √Åreas padr√£o (removido - sempre vazio)
            const padrao = [];
            
            // Fonte 2: √Åreas custom (criadas pelo usu√°rio neste dispositivo)
            // Usar window.vrvsAreasCustom (j√° carregado no boot, linha ~4400)
            const customRaw = window.vrvsAreasCustom || [];
            const custom = customRaw.map(a => String(a).trim()).filter(Boolean);
            
            // Fonte 3: √Åreas detectadas em temas existentes (que n√£o est√£o em padr√£o nem custom)
            // Usar dados global (j√° carregado no boot, linha ~4387)
            const todasAreasDados = dadosArray
                .map(t => t.area)
                .filter(a => a && String(a).trim())
                .map(a => String(a).trim()); // Android Acentos: Display exatamente como salvo (sem normaliza√ß√£o)
            
            // Normalizar para compara√ß√£o case-insensitive (evitar "Ombro" vs "ombro")
            const padraoNormalizado = new Set(padrao.map(a => a.toLowerCase()));
            const customNormalizado = new Set(custom.map(a => a.toLowerCase()));
            
            // Filtrar detectadas: n√£o est√° em padr√£o nem custom (case-insensitive)
            const detectadas = [...new Set(todasAreasDados)].filter(a => {
                const aLower = a.toLowerCase();
                return !padraoNormalizado.has(aLower) && !customNormalizado.has(aLower);
            });
            
            return { 
                padrao: padrao.sort(), 
                custom: custom.sort(), 
                detectadas: detectadas.sort() 
            };
        }
        
        // Helper simples para escape HTML (prevenir XSS em nomes de √°rea)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function abrirModalCadastro() {
            // Popular select de √°reas usando helper centralizado
            const selectArea = document.getElementById('modalCadastroArea');
            if (!selectArea) {
                console.error('[BUG FIX] Select modalCadastroArea n√£o encontrado!');
                return;
            }
            
            // P0: Perfis n√£o-DEFAULT n√£o devem mostrar √°reas padr√£o
            const perfilAtivo = window.vrvs_perfilAtivo || 'DEFAULT';
            const areasBase = getAreasBaseDoPerfil();
            const areasCustom = (window.vrvsAreasCustom || []).map(a => String(a).trim()).filter(Boolean).sort();
            
            let html = '<option value="">Selecione...</option>';
            
            // Grupo 1: √Åreas padr√£o (s√≥ DEFAULT tem)
            if (areasBase.length > 0) {
                html += '<optgroup label="√Åreas padr√£o">';
                areasBase.forEach(a => {
                    const areaDisplay = String(a).trim();
                    const textoExibido = escapeHtml(areaDisplay);
                    html += `<option value="${escapeHtml(areaDisplay)}">${textoExibido}</option>`;
                });
                html += '</optgroup>';
            }
            
            // Grupo 2: √Åreas criadas neste perfil
            if (areasCustom.length > 0) {
                html += '<optgroup label="Minhas √°reas">';
                areasCustom.forEach(a => {
                    const areaDisplay = String(a).trim();
                    const textoExibido = escapeHtml(areaDisplay);
                    html += `<option value="${escapeHtml(areaDisplay)}">${textoExibido}</option>`;
                });
                html += '</optgroup>';
            }
            
            selectArea.innerHTML = html;
            
            // Limpar campos
            const temaInput = document.getElementById('modalNovoTema');
            const prioridadeInput = document.getElementById('modalNovaPrioridade');
            const dataInput = document.getElementById('modalNovaDataInicio');
            
            if (temaInput) temaInput.value = '';
            if (prioridadeInput) prioridadeInput.value = '3';
            if (dataInput) dataInput.value = '';
            
            const modal = document.getElementById('modalCadastro');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('[BUG FIX] Modal modalCadastro n√£o encontrado!');
            }
        }
        
        function fecharModalCadastro() {
            document.getElementById('modalCadastro').classList.remove('active');
        }
        
        function salvarNovoTemaModal(event) {
            event.preventDefault();
            
            // Pegar √°rea do input se estiver vis√≠vel, sen√£o do select
            const modalNovaAreaInput = document.getElementById('modalNovaAreaInput');
            let area = '';
            if (modalNovaAreaInput && modalNovaAreaInput.style.display !== 'none' && modalNovaAreaInput.value.trim()) {
                area = modalNovaAreaInput.value.trim();
            } else {
                const selectArea = document.getElementById('modalCadastroArea');
                if (selectArea) {
                    area = selectArea.value.trim();
                }
            }
            
            // Validar que n√£o √© a op√ß√£o especial
            if (area === '__NOVA_AREA__' || !area) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione ou adicione uma √°rea v√°lida!', 'error');
                return;
            }
            
            const tema = document.getElementById('modalNovoTema').value.trim();
            const prioridade = parseInt(document.getElementById('modalNovaPrioridade').value) || 3;
            const dataInicio = document.getElementById('modalNovaDataInicio').value;
            
            if (!area || !tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha √°rea e tema!', 'error');
                return;
            }
            
            // Verificar duplicata
            const duplicado = dados.find(t => 
                t.area.toLowerCase() === area.toLowerCase() && 
                t.tema.toLowerCase() === tema.toLowerCase()
            );
            
            if (duplicado) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema j√° existe!', 'error');
                return;
            }
            
            const novoTema = {
                id: Date.now(),
                area: area,
                tema: tema,
                status: 'Planejado',
                prioridade: prioridade,
                rendimento: 0,
                sessoes: 0,
                tempo: 0,
                agenda: dataInicio || '',
                ultimoEstudo: ''
            };
            
            dados.push(novoTema);
            localStorage.setItem(window.vrvs_key('dados'), JSON.stringify(dados));
            
            // Criar anota√ß√£o vazia para o tema
            const novaAnotacao = {
                id: Date.now() + 1,
                temaId: String(novoTema.id),
                area: area,
                tema: tema,
                conteudo: '',
                hotTopics: '',
                ultimaAtualizacao: ''
            };
            anotacoes.push(novaAnotacao);
            localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
            
            fecharModalCadastro();
            renderDadosTable();
            mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
        }
        
        // ==================== MODAL EDITAR ANOTA√á√ÉO ====================
        
        function fecharModalAnotacao() {
            document.getElementById('modalEditarAnotacao').classList.remove('active');
        }
        
        function editarAnotacaoModal(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            
            if (!tema) return;
            
            // Preencher modal
            document.getElementById('editAnotacaoTemaId').value = temaId;
            document.getElementById('editAnotacaoTema').textContent = tema.tema;
            document.getElementById('editAnotacaoArea').textContent = tema.area;
            document.getElementById('editAnotacaoHotTopics').value = anotacao?.hotTopics || '';
            document.getElementById('editAnotacaoConteudo').value = anotacao?.conteudo || '';
            
            document.getElementById('modalEditarAnotacao').classList.add('active');
        }
        
        function salvarAnotacaoModal() {
            const temaId = document.getElementById('editAnotacaoTemaId').value;
            const hotTopics = document.getElementById('editAnotacaoHotTopics').value.trim();
            const conteudo = document.getElementById('editAnotacaoConteudo').value.trim();
            
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            
            if (!anotacao) {
                anotacao = {
                    id: Date.now(),
                    temaId: String(temaId),
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    hotTopics: '',
                    ultimaAtualizacao: ''
                };
                anotacoes.push(anotacao);
            }
            
            anotacao.hotTopics = hotTopics;
            anotacao.conteudo = conteudo;
            anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
            
            localStorage.setItem(window.vrvs_key('anotacoes'), JSON.stringify(anotacoes));
            
            document.getElementById('modalEditarAnotacao').classList.remove('active');
            renderCadernoV2();
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
        }
        
        // ==================== CADERNO V2 ====================
        
        function renderCadernoV2() {
            const container = document.getElementById('cadernoAreasContainer');
            if (!container) return;
            
            // Recarregar anota√ß√µes
            try {
                const anotacoesSalvas = localStorage.getItem(window.vrvs_key('anotacoes'));
                if (anotacoesSalvas) {
                    anotacoes = JSON.parse(anotacoesSalvas);
                }
            } catch (e) {
                console.error('[CADERNO] Erro ao carregar anota√ß√µes:', e);
            }
            
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            // Popular select de √°reas
            const selectArea = document.getElementById('cadernoFiltroArea');
            if (selectArea && selectArea.options.length <= 1) {
                const areasUnicas = [...new Set(dados.map(t => t.area))].sort();
                areasUnicas.forEach(area => {
                    const opt = document.createElement('option');
                    opt.value = area;
                    opt.textContent = area;
                    selectArea.appendChild(opt);
                });
            }
            
            // Agrupar temas por √°rea com dedupe por nome normalizado
            const areaGroups = {};
            
            dados.forEach(tema => {
                if (tema.status === 'Suspenso') return;
                if (filtroArea && tema.area !== filtroArea) return;
                
                if (!areaGroups[tema.area]) {
                    areaGroups[tema.area] = new Map(); // Usar Map para dedupe por chave normalizada
                }
                
                // Buscar anota√ß√£o do tema
                const anotacao = anotacoes.find(a => String(a.temaId) === String(tema.id));
                
                // Chave normalizada para dedupe
                const temaNormalizado = normalizarTema(tema.tema);
                const chaveDedupe = temaNormalizado || String(tema.id); // Fallback para ID se tema vazio
                
                // Se j√° existe tema com mesmo nome normalizado, manter o primeiro (por ID menor ou ordem)
                if (!areaGroups[tema.area].has(chaveDedupe)) {
                    areaGroups[tema.area].set(chaveDedupe, {
                        temaId: tema.id,
                        tema: tema.tema,
                        area: tema.area,
                        conteudo: anotacao?.conteudo || '',
                        hotTopics: anotacao?.hotTopics || '',
                        ultimaAtualizacao: anotacao?.ultimaAtualizacao || ''
                    });
                } else {
                    // Tema duplicado detectado - manter o primeiro, logar warning
                    const existente = areaGroups[tema.area].get(chaveDedupe);
                    if (existente.temaId !== tema.id) {
                        console.warn('[CADERNO] Tema duplicado detectado:', tema.tema, 'vs', existente.tema, '- mantendo primeiro');
                    }
                }
            });
            
            // Converter Maps para arrays para compatibilidade com c√≥digo existente
            Object.keys(areaGroups).forEach(area => {
                areaGroups[area] = Array.from(areaGroups[area].values());
            });
            
            if (Object.keys(areaGroups).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìì</div><div>Nenhum tema encontrado</div></div>';
                return;
            }
            
            // Ordenar √°reas
            const areasOrdenadas = Object.keys(areaGroups).sort();
            
            let html = '';
            
            areasOrdenadas.forEach(area => {
                const temas = areaGroups[area];
                const temasComConteudo = temas.filter(t => t.conteudo || t.hotTopics).length;
                const areaId = area.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                
                html += `
                    <div class="area-section" data-area="${area}">
                        <div class="area-header collapsed" onclick="toggleAreaCaderno('${areaId}')">
                            <div class="area-header-left">
                                <span class="area-header-title">üìÅ ${area}</span>
                                <span class="area-header-count">${temasComConteudo}/${temas.length}</span>
                            </div>
                            <span class="area-header-toggle">‚ñº</span>
                        </div>
                        <div class="area-content collapsed" id="area-content-${areaId}">
                            <div class="tema-list">
                `;
                
                // Ordenar temas alfabeticamente
                temas.sort((a, b) => a.tema.localeCompare(b.tema, 'pt-BR'));
                
                temas.forEach(tema => {
                    const temHotTopics = tema.hotTopics && tema.hotTopics.trim();
                    const temConteudo = tema.conteudo && tema.conteudo.trim();
                    
                    let itemClass = 'tema-item';
                    if (temHotTopics) itemClass += ' has-hottopics';
                    else if (temConteudo) itemClass += ' has-content';
                    
                    const temaIdStr = String(tema.temaId);
                    const conteudoId = `tema-conteudo-${temaIdStr}`;
                    
                    // TAREFA 1: Remover truncamento - usar texto completo sempre
                    // No Caderno, o objetivo √© ver o conte√∫do completo, n√£o preview
                    const hotTopicsCompleto = temHotTopics ? tema.hotTopics : '';
                    const conteudoCompleto = temConteudo ? tema.conteudo : '';
                    
                    html += `
                        <div class="${itemClass}" data-tema-id="${temaIdStr}">
                            <div class="tema-item-header" onclick="toggleTemaCaderno('${temaIdStr}')">
                                <span class="tema-item-name">üìù ${tema.tema}</span>
                                <div class="tema-item-actions">
                                    ${tema.ultimaAtualizacao ? `<span class="tema-item-date">${formatarData(tema.ultimaAtualizacao)}</span>` : ''}
                                    <button class="tema-item-btn" onclick="event.stopPropagation(); editarAnotacaoModal(${tema.temaId})" title="Editar">‚úèÔ∏è</button>
                                </div>
                            </div>
                            <div id="${conteudoId}" class="tema-item-conteudo collapsed">
                                ${temHotTopics ? `
                            <div class="hottopics-preview">
                                        <div class="hottopics-label">üî• Hot Topics</div>
                                        <div class="hottopics-text">${escapeHtmlCaderno(hotTopicsCompleto).replace(/\n/g, '<br>')}</div>
                            </div>
                                ` : ''}
                                ${temConteudo ? `
                                    <div class="conteudo-preview">
                                        <div class="conteudo-label">üßæ Anota√ß√µes</div>
                                        <div class="conteudo-text">${escapeHtmlCaderno(conteudoCompleto).replace(/\n/g, '<br>')}</div>
                                    </div>
                                ` : ''}
                                ${!temHotTopics && !temConteudo ? `
                                    <div class="conteudo-vazio">
                                        <em>Sem conte√∫do registrado para este tema.</em>
                                    </div>
                                ` : ''}
                            </div>
                            </div>
                        `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleTemaCaderno(temaId) {
            const conteudo = document.getElementById(`tema-conteudo-${temaId}`);
            if (!conteudo) return;
            
            const isCollapsed = conteudo.classList.contains('collapsed');
            if (isCollapsed) {
                conteudo.classList.remove('collapsed');
                conteudo.style.display = 'block';
                // TAREFA 1: Remover limita√ß√£o de altura - permitir conte√∫do completo
                // Usar scrollHeight real ou valor muito alto para n√£o limitar
                const scrollHeight = conteudo.scrollHeight || 0;
                // Usar valor muito alto (9999px) para garantir que conte√∫do completo seja vis√≠vel
                conteudo.style.maxHeight = Math.max(scrollHeight + 100, 9999) + 'px';
                conteudo.style.overflow = 'visible'; // Garantir que conte√∫do n√£o √© cortado
            } else {
                conteudo.classList.add('collapsed');
                conteudo.style.maxHeight = '0px';
                conteudo.style.display = 'none';
            }
        }
        
        
        function toggleAreaCaderno(areaId) {
            const header = document.querySelector(`[onclick="toggleAreaCaderno('${areaId}')"]`);
            const content = document.getElementById(`area-content-${areaId}`);
            
            if (header && content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                
                // CORRE√á√ÉO: Remover display: none inline se existir
                if (content.style.display === 'none') {
                    content.style.display = '';
                }
                
                // Se est√° expandindo, usar max-height generoso ou remover limite
                if (!content.classList.contains('collapsed')) {
                    // CORRE√á√ÉO: Usar scrollHeight + margem OU valor generoso (70vh)
                    const scrollHeight = content.scrollHeight;
                    const viewportHeight = window.innerHeight;
                    const maxHeightVH = Math.min(scrollHeight + 100, viewportHeight * 0.7); // 70% da viewport ou scrollHeight + margem
                    content.style.maxHeight = maxHeightVH + 'px';
                } else {
                    content.style.maxHeight = '0';
                }
            }
        }
        
        function escapeHtmlCaderno(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        // BUG A: Normalizar tema para dedupe (remove espa√ßos, acentos, caracteres especiais e invis√≠veis)
        function normalizarTema(tema) {
            if (!tema) return '';
            return String(tema)
                .trim()
                .replace(/\u00A0/g, ' ') // BUG A: Substituir NBSP por espa√ßo
                .replace(/[\u200B-\u200D\uFEFF]/g, '') // BUG A: Remover zero-width (ZWS, ZWNJ, ZWJ, BOM)
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacr√≠ticos
                .replace(/\(s\)/g, '') // Remove (s) opcional
                .replace(/[^\w\s]/g, '') // Remove caracteres especiais
                .replace(/\s+/g, ' '); // Normaliza espa√ßos m√∫ltiplos
        }
        
        // BUG A2: Normalizar chave de tema para agrupamento (singular/plural)
        function normalizarTemaKey(tema) {
            if (!tema) return '';
            let base = normalizarTema(tema);
            // Regra m√≠nima de canonicidade: singularizar "fraturas" para "fratura"
            base = base.replace(/^fraturas\b/, 'fratura');
            return base;
        }
        
        // ==================== AGENDA UNIFICADA ====================
        
        // S3G: REMOVIDO ‚Äî usar window.vistaAgenda (evita TDZ no boot) - declarado globalmente cedo
        
        function setVistaAgenda(vista) {
            window.vistaAgenda = vista;
            
            // Atualizar bot√µes
            document.getElementById('btnTimeline').classList.toggle('active', vista === 'timeline');
            document.getElementById('btnAtrasados').classList.toggle('active', vista === 'atrasados');
            
            // Mostrar/esconder filtros
            const filtros = document.getElementById('agendaFiltros');
            if (filtros) {
                filtros.style.display = vista === 'timeline' ? 'flex' : 'none';
            }
            
            renderAgendaUnificada();
        }
        
        function renderAgendaUnificada() {
            const container = document.getElementById('agendaContainer');
            if (!container) return;
            
            if (window.vistaAgenda === 'atrasados') {
                renderAgendaAtrasados();
            } else {
                renderAgenda();
                // Adicionar se√ß√£o de Lembretes ap√≥s a timeline
                const lembretesHTML = renderLembretesAgenda();
                if (lembretesHTML) {
                    container.innerHTML += lembretesHTML;
                }
            }
        }
        
        function renderLembretesAgenda() {
            if (!lembretes || lembretes.length === 0) return '';
            
            const hoje = obterYMDLocal();
            const lembretesAtivos = lembretes.filter(l => !l.concluido && (!l.proximaData || l.proximaData <= hoje));
            const lembretesFuturos = lembretes.filter(l => !l.concluido && l.proximaData && l.proximaData > hoje);
            
            let html = '<div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(0,206,209,0.3);">';
            html += '<h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìå Lembretes</h3>';
            
            // Formul√°rio para adicionar lembrete
            html += `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(0,206,209,0.05); border: 1px solid rgba(0,206,209,0.2); border-radius: 8px;">
                    <form id="lembreteFormAgenda" onsubmit="adicionarLembreteAgenda(event)">
                        <div class="form-group">
                            <label class="form-label">T√≠tulo do Lembrete</label>
                            <input type="text" class="form-input" id="lembreteTituloAgenda" placeholder="Ex: Revisar vias de acesso" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o (opcional)</label>
                            <textarea class="form-input" id="lembreteDescricaoAgenda" rows="2" placeholder="Detalhes..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Periodicidade</label>
                            <select class="form-select" id="lembretePeriodicidadeAgenda" required>
                                <option value="pontual">Pontual</option>
                                <option value="diaria">Di√°ria</option>
                                <option value="semanal">Semanal</option>
                                <option value="mensal">Mensal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-input" id="lembreteDataAgenda" required>
                        </div>
                        <button type="submit" class="btn">‚ûï Adicionar Lembrete</button>
                    </form>
                </div>
            `;
            
            // Lista de lembretes
            if (lembretesAtivos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: var(--cobre-light); margin-bottom: 10px; font-size: 14px;">üìå Para Hoje</h4>';
                html += lembretesAtivos.map(l => {
                    const proximaDataFormatada = l.proximaData ? formatarData(l.proximaData) : 'Pontual';
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade === 'pontual' ? 'Pontual' : l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.periodicidade !== 'pontual' ? `<button class="btn-edit" onclick="marcarLembreteConcluido(${l.id})" title="Marcar como conclu√≠do">‚úÖ</button>` : ''}
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            if (lembretesFuturos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: rgba(0,206,209,0.7); margin-bottom: 10px; font-size: 14px;">üìÖ Pr√≥ximos</h4>';
                html += lembretesFuturos.map(l => {
                    const proximaDataFormatada = formatarData(l.proximaData);
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function adicionarLembreteAgenda(event) {
            event.preventDefault();
            const titulo = document.getElementById('lembreteTituloAgenda').value.trim();
            const descricao = document.getElementById('lembreteDescricaoAgenda').value.trim();
            const periodicidade = document.getElementById('lembretePeriodicidadeAgenda').value;
            const dataInicial = document.getElementById('lembreteDataAgenda').value;
            
            if (!titulo || !dataInicial) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Preencha t√≠tulo e data inicial.', 'error');
                return;
            }
            
            const novoLembrete = {
                id: Date.now(),
                titulo,
                descricao,
                periodicidade,
                dataInicial,
                proximaData: periodicidade === 'pontual' ? null : dataInicial,
                concluido: false
            };
            
            lembretes.push(novoLembrete);
            localStorage.setItem(window.vrvs_key('lembretes'), JSON.stringify(lembretes));
            
            document.getElementById('lembreteFormAgenda').reset();
            renderAgendaUnificada();
            mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado!', 'success');
        }
        
        // Helper: Obter n√∫mero de sess√µes de um tema
        function obterNumeroSessoesTema(t) {
            if (typeof t.totalSessoes === 'number') return t.totalSessoes;
            if (typeof t.sessoes === 'number') return t.sessoes;
            return 0;
        }
        
        // Helper: Renderizar card de tema atrasado
        function renderCardTemaAtrasadoHTML(t) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const diasAtraso = Math.floor((hoje - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
            const sugestao = obterSugestaoTema ? obterSugestaoTema(t) : '';
            const rendPct = Math.round((t.rendimento || 0) * 100);
            const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
            const dataFormatada = formatarDataBR ? formatarDataBR(t.agenda) : t.agenda;
            const tipo = calcularTipoRevisao ? calcularTipoRevisao(t) : '';
            const numSessoes = obterNumeroSessoesTema(t);
            
            return `
                <div class="task-item priority-${t.prioridade || 3}" style="margin-bottom: 12px;">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-meta">
                            <span class="task-date-atraso" style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                üìÖ ${dataFormatada} ‚Ä¢ ‚ö†Ô∏è ${diasAtraso} dias atrasado
                            </span>
                        </div>
                    </div>
                    <div class="task-body">
                        <div class="task-tags">
                            <span class="task-tag-area">üìö ${t.area || ''}</span>
                            <span class="task-tag-rendimento" style="color: ${rendColor};">
                                üìä ${rendPct}%
                            </span>
                            <span class="task-tag-sessoes" style="color: rgba(255,255,255,0.7);">
                                üì¢ ${numSessoes} sess√µes
                            </span>
                            ${tipo ? `<span class="task-tag-tipo">${tipo}</span>` : ''}
                        </div>
                        ${sugestao ? `
                        <div class="task-suggestion">
                            <div class="task-suggestion-label">Diretriz</div>
                            <div class="task-suggestion-text">${sugestao}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Fun√ß√£o para colapso leve por √°rea em Atrasados
        function toggleAtrasadosArea(areaId) {
            const conteudo = document.getElementById(`atrasados-conteudo-${areaId}`);
            if (!conteudo) return;
            
            const isCollapsed = conteudo.classList.contains('collapsed');
            if (isCollapsed) {
                conteudo.classList.remove('collapsed');
                conteudo.style.display = 'block';
            } else {
                conteudo.classList.add('collapsed');
                conteudo.style.display = 'none';
            }
        }
        
        function renderAgendaAtrasados() {
            const container = document.getElementById('agendaContainer');
            if (!container) return;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const hojeStr = hoje.toISOString().split('T')[0];
            
            // 1) Filtrar apenas temas atrasados e n√£o conclu√≠dos
            const atrasados = dados.filter(t => {
                if (!t || !t.agenda) return false;
                if (t.status === 'Conclu√≠do') return false;
                if (typeof dataValida === 'function' && !dataValida(t.agenda)) return false;
                return t.agenda < hojeStr;
            });
            
            if (!atrasados.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div>Nenhuma atividade atrasada na Agenda.</div>
                    </div>
                `;
                return;
            }
            
            // 2) Agrupar atrasados por √°rea
            const porArea = {};
            atrasados.forEach(t => {
                const area = t.area || 'Outros';
                if (!porArea[area]) porArea[area] = [];
                porArea[area].push(t);
            });
            
            // 3) Gerar HTML
            let html = '';
            Object.keys(porArea).sort().forEach(area => {
                const temas = porArea[area];
                
                // Ordenar temas desta √°rea:
                // 1) por n√∫mero de sess√µes (crescente)
                // 2) em caso de empate, por data (mais antigo primeiro)
                temas.sort((a, b) => {
                    const sa = obterNumeroSessoesTema(a);
                    const sb = obterNumeroSessoesTema(b);
                    if (sa !== sb) return sa - sb;
                    return a.agenda.localeCompare(b.agenda);
                });
                
                const areaId = area.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                const totalTemas = temas.length;
                
                html += `
                    <div class="atrasados-area" id="atrasados-area-${areaId}" style="margin-bottom: 16px; border-radius: 10px; overflow: hidden;">
                        <div class="atrasados-area-header" onclick="toggleAtrasadosArea('${areaId}')" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: rgba(255,159,64,0.15); border: 1px solid rgba(255,159,64,0.3); border-left: 3px solid var(--cobre-main); color: var(--cobre-light); cursor: pointer;">
                            <span class="atrasados-area-nome" style="font-weight: 600; font-size: 14px;">üìÅ ${area}</span>
                            <span class="atrasados-area-badge" style="font-size: 12px; padding: 2px 8px; border-radius: 999px; background: rgba(255,127,80,0.3); color: #FFE4C4;">${totalTemas} atrasado${totalTemas > 1 ? 's' : ''}</span>
                        </div>
                        <div class="atrasados-area-conteudo" id="atrasados-conteudo-${areaId}" style="padding: 8px 10px 12px; background: rgba(0,0,0,0.15);">
                            ${temas.map(renderCardTemaAtrasadoHTML).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== AN√ÅLISES ====================
        
        // S3G: REMOVIDO ‚Äî usar window.vistaAnalytics (evita TDZ no boot) - declarado globalmente cedo
        
        function setVistaAnalytics(vista) {
            window.vistaAnalytics = vista;
            
            // Atualizar bot√µes
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                if (btn.id && btn.id.startsWith('btnAnalytics')) {
                    btn.classList.remove('active');
                }
            });
            
            // Mapear vista para ID do bot√£o corretamente
            const vistaMap = {
                'resumo': 'Resumo',
                'graficos': 'Graficos',
                'detalhado': 'Detalhado',
                'historico': 'Historico'
            };
            
            const btnId = `btnAnalytics${vistaMap[vista] || vista.charAt(0).toUpperCase() + vista.slice(1)}`;
            const btnAtivo = document.getElementById(btnId);
            if (btnAtivo) {
                btnAtivo.classList.add('active');
            } else {
                console.warn('[ANALYTICS] Bot√£o n√£o encontrado para vista:', vista, 'ID esperado:', btnId);
            }
            
            renderAnalytics();
        }
        
        function renderAnalytics() {
            const container = document.getElementById('analyticsContainer');
            if (!container) {
                console.error('[ANALYTICS] Container n√£o encontrado!');
                return;
            }
            
            // Garantir que vistaAnalytics tenha um valor v√°lido
            if (!window.vistaAnalytics) window.vistaAnalytics = 'resumo';
            
            console.log('[ANALYTICS] Renderizando vista:', window.vistaAnalytics);
            
            switch(window.vistaAnalytics) {
                case 'resumo':
                    renderAnalyticsResumo(container);
                    break;
                case 'graficos':
                    renderAnalyticsGraficos(container);
                    break;
                // case 'detalhado':
                //     renderAnalyticsDetalhado(container);
                //     break;
                // Temporariamente removido - precisa reimplementa√ß√£o (campos h.questoes/flashcards n√£o existem)
                case 'historico':
                    renderAnalyticsHistorico(container);
                    break;
                default:
                    console.warn('[ANALYTICS] Vista desconhecida:', window.vistaAnalytics, '- usando resumo');
                    window.vistaAnalytics = 'resumo';
                    renderAnalyticsResumo(container);
                    break;
            }
        }
        
        function renderAnalyticsResumo(container) {
            // Filtrar hist√≥rico de temas suspensos (igual ao c√≥digo antigo que funcionava)
            const historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                return tema && tema.status !== 'Suspenso';
            });
            
            // Calcular estat√≠sticas usando hist√≥rico ATIVO
            const totalTemas = dados.filter(t => t.status !== 'Suspenso').length;
            const totalSessoes = historicoAtivo.length;
            const rendimentoMedio = historicoAtivo.length > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / historicoAtivo.length) * 100)
                : 0;
            
            // CORRE√á√ÉO: Usar hist√≥rico para calcular tempo total, n√£o dados
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const horasTotal = Math.round(totalMinutos / 60);
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes) - C√ìDIGO ID√äNTICO AO ANTIGO
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            let questoesEncontradas = 0;
            historicoAtivo.forEach((h, idx) => {
                if (h.questoes) {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: questoes="${h.questoes}"`);
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                        questoesEncontradas++;
                        console.log(`[DEBUG RESUMO] Match encontrado: ${match[1]}/${match[2]}`);
                    } else {
                        console.log(`[DEBUG RESUMO] Match N√ÉO encontrado para: "${h.questoes}"`);
                    }
                } else {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: h.questoes √© ${h.questoes} (tipo: ${typeof h.questoes})`);
                }
            });
            console.log(`[DEBUG RESUMO] Total de sess√µes com quest√µes: ${questoesEncontradas}/${historicoAtivo.length}`);
            
            // Calcular flashcards totais - C√ìDIGO ID√äNTICO AO ANTIGO
            let flashcardsEncontrados = 0;
            const totalFlashcards = historicoAtivo.reduce((sum, h, idx) => {
                const val = parseInt(h.flashcards) || 0;
                if (val > 0) {
                    console.log(`[DEBUG RESUMO] Sess√£o ${idx}: flashcards=${h.flashcards} (valor: ${val})`);
                    flashcardsEncontrados++;
                }
                return sum + val;
            }, 0);
            console.log(`[DEBUG RESUMO] Total de sess√µes com flashcards: ${flashcardsEncontrados}/${historicoAtivo.length}`);
            
            const totalQuestoes = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular m√©tricas VRVS 3P para o painel
            let htmlVrvs3p = '';
            if (!window.diario) {
                window.diario = { entradas: [], schemaVersion: DIARIO_SCHEMA_VERSION };
            }
            if (!Array.isArray(window.diario.entradas)) {
                window.diario.entradas = [];
            }
            
            let statsVrvs3p = {};
            try {
                statsVrvs3p = calcularEstatisticasVrvs3p(window.diario, hojeStr()) || {};
            } catch (e) {
                console.error('[VRVS3P] Erro ao calcular estat√≠sticas:', e);
                statsVrvs3p = { totalAtivos: 0, totalHoje: 0, totalAtrasadas: 0 };
            }
            const faixaVrvs3p = (statsVrvs3p && statsVrvs3p.retencaoGlobal !== null && statsVrvs3p.retencaoGlobal !== undefined) ? classificarFaixaRetencao(statsVrvs3p.retencaoGlobal) : 'nenhum';
            const mensagemVrvs3p = mensagemRetencao((statsVrvs3p && statsVrvs3p.retencaoGlobal) ? statsVrvs3p.retencaoGlobal : 0, statsVrvs3p || {});
            
            // Montar painel VRVS 3P colaps√°vel (vers√£o refinada para Resumo)
            // SEMPRE renderizar painel (mesmo se vazio)
            const faixaTexto = faixaVrvs3p === 'alta' ? 'Alta' : faixaVrvs3p === 'media' ? 'M√©dia' : 'Baixa';
            const resumoHeader = (statsVrvs3p && statsVrvs3p.totalAtivos > 0 && statsVrvs3p.retencaoGlobalPct !== null)
                ? `${statsVrvs3p.retencaoGlobalPct}% ¬∑ ${statsVrvs3p.totalAtivos} ativos ¬∑ ${statsVrvs3p.totalHoje || 0} hoje ¬∑ ${statsVrvs3p.totalAtrasadas || 0} atrasados ¬∑ ${faixaTexto}`
                : (statsVrvs3p && statsVrvs3p.totalAtivos > 0)
                ? `${statsVrvs3p.totalAtivos} ativos ¬∑ ${statsVrvs3p.totalHoje || 0} hoje ¬∑ ${statsVrvs3p.totalAtrasadas || 0} atrasados`
                : 'Nenhum t√≥pico ativo ainda';
            
            if (statsVrvs3p && statsVrvs3p.totalAtivos > 0) {
                const classeBarra = faixaVrvs3p === 'alta' ? 'alta' : faixaVrvs3p === 'media' ? 'media' : 'baixa';
                // Usar classe da mensagem se dispon√≠vel, sen√£o usar faixa de reten√ß√£o
                const classeMensagem = (mensagemVrvs3p && mensagemVrvs3p.classe) ? mensagemVrvs3p.classe : (faixaVrvs3p === 'alta' ? 'alta' : faixaVrvs3p === 'media' ? 'media' : 'baixa');
                htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card vrvs3p-collapsed">
                        <button type="button" class="vrvs3p-header" onclick="togglePainelVrvs3p()">
                            <span class="vrvs3p-title">üß† SA√öDE DO DI√ÅRIO VRVS 3P</span>
                            <div class="vrvs3p-header-right">
                                <span class="vrvs3p-summary">${resumoHeader}</span>
                                <span class="vrvs3p-caret">‚ñæ</span>
                            </div>
                        </button>
                        <div class="vrvs3p-body">
                            ${statsVrvs3p.retencaoGlobalPct !== null ? `
                                <div class="vrvs3p-barra-container">
                                    <div class="vrvs3p-barra-track">
                                        <div class="vrvs3p-barra-fill ${classeBarra}" style="width: ${statsVrvs3p.retencaoGlobalPct}%;"></div>
                                    </div>
                                    <div class="vrvs3p-barra-label">
                                        <span class="vrvs3p-barra-percent">${statsVrvs3p.retencaoGlobalPct}%</span>
                                        <span class="vrvs3p-barra-status">${faixaTexto}</span>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="vrvs3p-metricas">
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor">${statsVrvs3p.totalAtivos}</span>
                                    <span class="vrvs3p-metrica-label">ativos</span>
                                </div>
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor">${statsVrvs3p.totalHoje}</span>
                                    <span class="vrvs3p-metrica-label">para hoje</span>
                                </div>
                                <div class="vrvs3p-metrica">
                                    <span class="vrvs3p-metrica-valor" style="color: ${statsVrvs3p.totalAtrasadas > 0 ? '#dc3545' : 'rgba(255,255,255,0.8)'}">${statsVrvs3p.totalAtrasadas}</span>
                                    <span class="vrvs3p-metrica-label">atrasados</span>
                                </div>
                            </div>
                            <div class="vrvs3p-mensagem-box ${classeMensagem}">
                                <div class="vrvs3p-mensagem-text">
                                    <span class="vrvs3p-mensagem-emoji">${(mensagemVrvs3p && typeof mensagemVrvs3p === 'object' && mensagemVrvs3p.emoji) ? mensagemVrvs3p.emoji : '‚ú®'}</span>
                                    <span>${(mensagemVrvs3p && typeof mensagemVrvs3p === 'object' && mensagemVrvs3p.texto) ? mensagemVrvs3p.texto : (mensagemVrvs3p || '')}</span>
                                </div>
                            </div>
                            <div class="vrvs3p-disclaimer">Estimativa VRVS 3P ¬∑ N√£o √© nota, √© mapa de esfor√ßo</div>
                        </div>
                    </section>
                `;
            } else {
                const mensagemVazia = mensagemRetencao(0, statsVrvs3p || {});
                htmlVrvs3p = `
                    <section id="painel-vrvs3p" class="vrvs3p-card vrvs3p-collapsed">
                        <button type="button" class="vrvs3p-header" onclick="togglePainelVrvs3p()">
                            <span class="vrvs3p-title">üß† SA√öDE DO DI√ÅRIO VRVS 3P</span>
                            <div class="vrvs3p-header-right">
                                <span class="vrvs3p-summary">Nenhum t√≥pico ativo ainda</span>
                                <span class="vrvs3p-caret">‚ñæ</span>
                            </div>
                        </button>
                        <div class="vrvs3p-body">
                            <div class="vrvs3p-mensagem-box">
                                <div class="vrvs3p-mensagem-text">
                                    <span class="vrvs3p-mensagem-emoji">${(mensagemVazia && typeof mensagemVazia === 'object' && mensagemVazia.emoji) ? mensagemVazia.emoji : '‚ú®'}</span>
                                    <span>${(mensagemVazia && typeof mensagemVazia === 'object' && mensagemVazia.texto) ? mensagemVazia.texto : (mensagemVazia || '')}</span>
                                </div>
                            </div>
                            <div class="vrvs3p-disclaimer">Estimativa VRVS 3P ¬∑ N√£o √© nota, √© mapa de esfor√ßo</div>
                        </div>
                    </section>
                `;
            }
            
            container.innerHTML = htmlVrvs3p + `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalTemas}</div>
                        <div class="stat-label">M√≥dulos Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes Totais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${horasTotal}h</div>
                        <div class="stat-label">Tempo Investido</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoes}</div>
                        <div class="stat-label">Quest√µes Resolvidas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                </div>
                
                <!-- Filtro de per√≠odo -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,206,209,0.05); border-radius: 8px;">
                    <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ An√°lise por Per√≠odo</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="date" class="form-input" id="analyticsDataInicio" style="flex: 1; min-width: 120px;">
                        <input type="date" class="form-input" id="analyticsDataFim" style="flex: 1; min-width: 120px;">
                        <button class="btn btn-small" onclick="gerarRelatorioAnalytics()">Gerar</button>
                    </div>
                    <div id="analyticsRelatorioResultado" style="margin-top: 15px;"></div>
                </div>
            `;
        }
        
        function renderAnalyticsGraficos(container) {
            // Destruir gr√°ficos antigos se existirem ANTES de criar novos
            // CORRE√á√ÉO: Destruir apenas inst√¢ncias Analytics, n√£o Stats
            if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
            if (chartLinhaAnalyticsInst) { 
                try {
                    chartLinhaAnalyticsInst.destroy(); 
                } catch(e) {
                    console.warn('[ANALYTICS] Erro ao destruir gr√°fico linha:', e);
                }
                chartLinhaAnalyticsInst = null; 
            }
            if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
            
            // Criar HTML com abas colaps√°veis para gr√°ficos
            container.innerHTML = `
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-barras')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìä Performance por √Årea</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-barras">
                    <canvas id="chartBarrasAnalytics" width="400" height="150"></canvas>
                </div>
                </div>
                
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-linha')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üìà Evolu√ß√£o Temporal</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-linha">
                        <div id="chartLinhaControlesAnalytics" class="chart-toggles"></div>
                    <canvas id="chartLinhaAnalytics" width="400" height="150"></canvas>
                </div>
                </div>
                
                <div class="area-section" style="margin-bottom: 20px;">
                    <div class="area-header collapsed" onclick="toggleAreaCaderno('analytics-radar')" style="cursor: pointer;">
                        <div class="area-header-left">
                            <span class="area-header-title">üéØ Radar de Compet√™ncias</span>
                        </div>
                        <span class="area-header-toggle">‚ñº</span>
                    </div>
                    <div class="area-content collapsed" id="area-content-analytics-radar">
                    <canvas id="chartRadarAnalytics" width="400" height="200"></canvas>
                    </div>
                </div>
            `;
            
            // Renderizar gr√°ficos usando os IDs espec√≠ficos da aba Analytics
            // CORRE√á√ÉO: Aguardar Chart.js estar dispon√≠vel e DOM estar pronto
            const tentarRenderizarGraficos = () => {
                if (typeof Chart === 'undefined') {
                    console.warn('[ANALYTICS GRAFICOS] Chart.js n√£o est√° dispon√≠vel ainda, tentando novamente...');
                    setTimeout(tentarRenderizarGraficos, 100);
                    return;
                }
                
                const canvasBarras = document.getElementById('chartBarrasAnalytics');
                const canvasLinha = document.getElementById('chartLinhaAnalytics');
                const canvasRadar = document.getElementById('chartRadarAnalytics');
                
                if (!canvasBarras || !canvasLinha || !canvasRadar) {
                    console.warn('[ANALYTICS GRAFICOS] Canvas n√£o encontrado, tentando novamente...');
                    setTimeout(tentarRenderizarGraficos, 100);
                    return;
                }
                
                console.log('[ANALYTICS GRAFICOS] Renderizando gr√°ficos...');
                renderChartBarras('chartBarrasAnalytics');
                
                // Renderizar controles de toggle para gr√°fico de linha (Analytics)
                renderChartLinhaControlesAnalytics();
                renderChartLinha('chartLinhaAnalytics');
                
                renderChartRadar('chartRadarAnalytics');
            };
            
            requestAnimationFrame(() => {
                setTimeout(tentarRenderizarGraficos, 50);
            });
        }
        
        function renderAnalyticsDetalhado(container) {
            // CORRE√á√ÉO: Incluir todos os elementos HTML necess√°rios (filtros, selects)
            container.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--turquesa-light); font-size: 14px; font-weight: 600;">üîç An√°lises por √Årea e Tema</span>
                    <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px;">
                        <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar An√°lises de Tempo</span>
                    </button>
                </div>
                
                <!-- FILTROS -->
                <div style="margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Filtrar por √Årea</label>
                        <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                            <option value="">Todas as √°reas</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Filtrar por Tema</label>
                        <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                            <option value="">Todos os temas</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Per√≠odo</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                            <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">üìÖ Semana Atual</button>
                        <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">üìÜ M√™s Atual</button>
                        <button class="btn btn-small" onclick="limparFiltrosAnalise()">üóëÔ∏è Limpar Filtros</button>
                    </div>
                </div>
                
                <!-- RESULTADOS -->
                <div id="analiseResultados" style="margin-top: 20px;">
                    <!-- Resultados ser√£o renderizados aqui por calcularAnalises() -->
                </div>
                
                <!-- AN√ÅLISES DE TEMPO (toggle) -->
                <div id="analiseTempo" style="display: none; margin-top: 20px;">
                    <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                </div>
            `;
            
            // Popular selects e calcular an√°lises
            setTimeout(() => {
                atualizarSelectsAnalise();
                atualizarAnalises();
            }, 100);
        }
        
        function renderAnalyticsHistorico(container) {
            // Renderizar hist√≥rico com estrutura completa da tabela
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <span style="color: var(--turquesa-light); font-size: 14px;">üìú Hist√≥rico de Sess√µes</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tema</th>
                                <th>√Årea</th>
                                <th>Rend.</th>
                                <th>Tempo</th>
                                <th>Diretriz</th>
                            </tr>
                        </thead>
                        <tbody id="historicoTableBodyAnalytics">
                            <!-- Conte√∫do ser√° preenchido por renderHistoricoAnalytics() -->
                        </tbody>
                    </table>
                </div>
            `;
            
            // Chamar fun√ß√£o de hist√≥rico espec√≠fica para Analytics ap√≥s DOM estar pronto
            // CORRE√á√ÉO: Aguardar DOM estar pronto e tentar m√∫ltiplas vezes se necess√°rio
            const tentarRenderizarHistorico = () => {
                const tbody = document.getElementById('historicoTableBodyAnalytics');
                if (!tbody) {
                    console.warn('[ANALYTICS HISTORICO] Tbody n√£o encontrado, tentando novamente...');
                    setTimeout(tentarRenderizarHistorico, 100);
                    return;
                }
                console.log('[ANALYTICS HISTORICO] Renderizando hist√≥rico...');
                renderHistoricoAnalytics();
            };
            
            requestAnimationFrame(() => {
                setTimeout(tentarRenderizarHistorico, 50);
            });
        }
        
        function renderHistoricoAnalytics() {
            const tbody = document.getElementById('historicoTableBodyAnalytics');
            if (!tbody) {
                console.warn('[RENDER HISTORICO ANALYTICS] Tbody n√£o encontrado!');
                return;
            }
            
            console.log('[RENDER HISTORICO ANALYTICS] Total de registros no hist√≥rico:', historico.length);
            
            // Filtrar hist√≥rico inv√°lido
            const historicoFiltrado = historico.filter(h => {
                if (!h.area || !h.tema) return false;
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                return true;
            });
            
            console.log('[RENDER HISTORICO ANALYTICS] Registros ap√≥s filtro:', historicoFiltrado.length);
            
            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                // Unificar observa√ß√µes e sugest√£o em uma √∫nica coluna "Diretriz"
                const diretriz = [
                    h.observacoes && h.observacoes !== '-' ? h.observacoes : '',
                    h.sugestao && h.sugestao !== '-' ? h.sugestao : ''
                ].filter(s => s.trim() !== '').join(' ') || '-';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${diretriz}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function gerarRelatorioAnalytics() {
            const dataInicio = document.getElementById('analyticsDataInicio')?.value;
            const dataFim = document.getElementById('analyticsDataFim')?.value;
            const container = document.getElementById('analyticsRelatorioResultado');
            
            if (!dataInicio || !dataFim) {
                container.innerHTML = '<div style="color: var(--cobre-light);">‚ö†Ô∏è Selecione as datas</div>';
                return;
            }
            
            // Filtrar hist√≥rico pelo per√≠odo
            const historicoFiltrado = historico.filter(h => {
                const data = h.data;
                return data >= dataInicio && data <= dataFim;
            });
            
            if (historicoFiltrado.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6);">Nenhuma sess√£o encontrada no per√≠odo.</div>';
                return;
            }
            
            const totalSessoes = historicoFiltrado.length;
            const rendMedio = Math.round(historicoFiltrado.reduce((a, h) => a + (h.rendimento || 0), 0) / totalSessoes * 100);
            const tempoTotal = historicoFiltrado.reduce((a, h) => a + (h.tempo || 0), 0);
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes) - C√ìDIGO ID√äNTICO AO ANTIGO
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            
            // Calcular flashcards totais - C√ìDIGO ID√äNTICO AO ANTIGO
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            const totalQuestoes = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalSessoes}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Sess√µes</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${rendMedio}%</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Performance</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${Math.round(tempoTotal/60)}h</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Tempo</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalQuestoes}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Quest√µes</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,206,209,0.1); border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: #00FFE0;">${totalFlashcards.toLocaleString()}</div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">Flashcards</div>
                    </div>
                </div>
            `;
        }
        
        // ==================== AJUDA ====================
        
        // S3G: REMOVIDO ‚Äî usar window.vistaAjuda (evita TDZ no boot) - declarado globalmente cedo
        
        function setVistaAjuda(vista) {
            window.vistaAjuda = vista;
            
            // Atualizar bot√µes
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                if (btn.id && btn.id.startsWith('btnAjuda')) {
                    btn.classList.remove('active');
                }
            });
            
            const btnAtivo = document.getElementById(`btnAjuda${vista.charAt(0).toUpperCase() + vista.slice(1)}`);
            if (btnAtivo) btnAtivo.classList.add('active');
            
            renderAjuda();
        }
        
        function renderAjuda() {
            const container = document.getElementById('ajudaContainer');
            if (!container) return;
            
            switch(window.vistaAjuda) {
                case 'tutorial':
                    renderAjudaTutorial(container);
                    break;
                case 'faq':
                    renderAjudaFaq(container);
                    break;
            }
        }
        
        function renderAjudaTutorial(container) {
            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado</h3>
                    <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                        Um guia passo a passo por todas as funcionalidades, incluindo o sistema VRVS 3P
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(0,206,209,0.1), rgba(13,148,136,0.05)); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Guia R√°pido</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìã Tarefa</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Veja o que estudar hoje baseado na revis√£o espa√ßada. Revise cards VRVS 3P e escolha temas para estudar.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìî Di√°rio</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Anote aprendizados no formato pergunta/resposta. Marque "VRVS 3P" para virar card de revis√£o espa√ßada.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üîÑ VRVS 3P</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Sistema de revis√£o espa√ßada. Cards aparecem automaticamente para revisar. Quanto mais acerta, mais tempo at√© pr√≥xima revis√£o.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìù Feedback</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Registre suas sess√µes de estudo com tempo, performance e quest√µes. Sistema calcula quando revisar.</div>
                        </div>
                        <div>
                            <div style="color: var(--cobre-light); font-weight: 600; margin-bottom: 5px;">üìì Caderno</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Registre Hot Topics (pontos de prova) e anota√ß√µes por tema. Hot Topics aparecem na aba Tarefas.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Box Modo Avan√ßado removido - agora est√° na aba Di√°rio -->
                
                <div style="background: linear-gradient(135deg, rgba(255,127,80,0.1), rgba(255,127,80,0.05)); border-radius: 8px; padding: 20px; border-left: 3px solid var(--cobre-main);">
                    <h3 style="color: var(--cobre-light); font-size: 16px; margin-bottom: 15px;">üí° Fluxo Di√°rio Recomendado</h3>
                    <ol style="margin-left: 20px; line-height: 1.8; font-size: 13px; color: rgba(255,255,255,0.8);">
                        <li>Abra a aba <strong>Tarefas</strong> e veja o que precisa fazer hoje</li>
                        <li>Revise os cards VRVS 3P (se houver)</li>
                        <li>Estude um tema e anote aprendizados no <strong>Di√°rio</strong></li>
                        <li>Registre a sess√£o no <strong>Feedback</strong></li>
                    </ol>
                    <p style="margin-top: 15px; font-size: 12px; color: rgba(255,255,255,0.7);">üí° O sistema calcula tudo automaticamente. Voc√™ s√≥ precisa usar consistentemente!</p>
                </div>
            `;
        }
        
        // ==================== B0 SPIKE ‚Äî VALIDA√á√ÉO T√âCNICA DE IMAGENS ====================
        
        // Abrir/criar IndexedDB
        async function b0Img_openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('vrvs_images', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('diario')) {
                        db.createObjectStore('diario');
                    }
                };
            });
        }
        
        // Salvar blob no IndexedDB
        async function b0Img_putBlob(key, blob) {
            const db = await b0Img_openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['diario'], 'readwrite');
                const store = transaction.objectStore('diario');
                const request = store.put(blob, key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => {
                    if (request.error.name === 'QuotaExceededError') {
                        reject(new Error('Quota de armazenamento esgotada'));
                    } else {
                        reject(request.error);
                    }
                };
            });
        }
        
        // Obter blob do IndexedDB
        async function b0Img_getBlob(key) {
            const db = await b0Img_openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['diario'], 'readonly');
                const store = transaction.objectStore('diario');
                const request = store.get(key);
                
                request.onsuccess = () => {
                    if (request.result) {
                        resolve(request.result);
                    } else {
                        reject(new Error(`Blob n√£o encontrado: ${key}`));
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // Deletar key do IndexedDB
        async function b0Img_deleteKey(key) {
            const db = await b0Img_openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['diario'], 'readwrite');
                const store = transaction.objectStore('diario');
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // Listar todas as keys de teste
        async function b0Img_listTestKeys(prefix = 'teste:') {
            const db = await b0Img_openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['diario'], 'readonly');
                const store = transaction.objectStore('diario');
                const request = store.getAllKeys();
                
                request.onsuccess = () => {
                    const allKeys = request.result;
                    const testKeys = allKeys.filter(key => String(key).startsWith(prefix));
                    resolve(testKeys);
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // B0-A: Criar e salvar blobs sint√©ticos
        async function b0Img_runA() {
            const btnA = document.getElementById('b0Img_btnA');
            const status = document.getElementById('b0Img_status');
            const btnB = document.getElementById('b0Img_btnB');
            const btnLimpar = document.getElementById('b0Img_btnLimpar');
            
            // Desabilitar bot√µes durante teste
            btnA.disabled = true;
            btnB.disabled = true;
            btnLimpar.disabled = true;
            btnA.textContent = '‚è≥ Testando B0-A...';
            
            const runId = Date.now();
            const keys = [];
            const quantidade = 10;
            const tamanhoBytes = 300 * 1024; // 300KB
            
            try {
                status.textContent = 'Status: Criando blobs sint√©ticos...';
                
                // Criar blobs (SEM crypto.getRandomValues para n√£o medir CPU)
                const blobs = [];
                for (let i = 0; i < quantidade; i++) {
                    const dados = new Uint8Array(tamanhoBytes);
                    // Zerar array (n√£o usar crypto.getRandomValues)
                    dados.fill(0);
                    const blob = new Blob([dados], { type: 'image/jpeg' });
                    blobs.push(blob);
                }
                
                status.textContent = 'Status: Salvando blobs no IndexedDB...';
                const inicioSalvar = performance.now();
                
                // Salvar cada blob
                for (let i = 0; i < blobs.length; i++) {
                    const key = `teste:a:${runId}:${i}`;
                    keys.push(key);
                    await b0Img_putBlob(key, blobs[i]);
                }
                
                const tempoSalvar = ((performance.now() - inicioSalvar) / 1000).toFixed(2);
                
                status.textContent = 'Status: Carregando blobs do IndexedDB...';
                const inicioCarregar = performance.now();
                
                // Carregar e validar
                let sucessoCarregar = 0;
                for (const key of keys) {
                    const blob = await b0Img_getBlob(key);
                    if (blob && blob.size >= 100 * 1024 && blob.size <= 500 * 1024) {
                        sucessoCarregar++;
                    }
                }
                
                const tempoCarregar = ((performance.now() - inicioCarregar) / 1000).toFixed(2);
                const tamanhoTotalMB = ((keys.length * tamanhoBytes) / (1024 * 1024)).toFixed(2);
                
                const resultado = {
                    tipo: 'B0-A',
                    sucesso: true,
                    gravadas: keys.length,
                    carregadas: sucessoCarregar,
                    tamanhoTotal: tamanhoTotalMB,
                    tempoSalvar: tempoSalvar,
                    tempoCarregar: tempoCarregar,
                    keys: keys
                };
                
                b0Img_renderReport(resultado);
                
            } catch (error) {
                const resultado = {
                    tipo: 'B0-A',
                    sucesso: false,
                    erro: error.message,
                    gravadas: keys.length,
                    keys: keys
                };
                b0Img_renderReport(resultado);
            } finally {
                // Reabilitar bot√µes
                btnA.disabled = false;
                btnB.disabled = false;
                btnLimpar.disabled = false;
                btnA.textContent = 'üß™ B0-A (Blobs Sint√©ticos)';
            }
        }
        
        // B0-B: Criar e salvar JPEG real via canvas
        async function b0Img_runB() {
            const btnB = document.getElementById('b0Img_btnB');
            const status = document.getElementById('b0Img_status');
            const btnA = document.getElementById('b0Img_btnA');
            const btnLimpar = document.getElementById('b0Img_btnLimpar');
            
            // Desabilitar bot√µes durante teste
            btnA.disabled = true;
            btnB.disabled = true;
            btnLimpar.disabled = true;
            btnB.textContent = '‚è≥ Testando B0-B...';
            
            const runId = Date.now();
            const keys = [];
            const quantidade = 10;
            
            try {
                status.textContent = 'Status: Criando imagens via canvas...';
                
                const inicioSalvar = performance.now();
                
                // Criar e salvar cada imagem
                for (let i = 0; i < quantidade; i++) {
                    const blob = await b0Img_criarJPEGViaCanvas(1280, 960);
                    
                    if (blob.size > 500 * 1024) {
                        throw new Error(`Imagem ${i} muito grande: ${(blob.size / 1024).toFixed(2)}KB`);
                    }
                    
                    const key = `teste:b:${runId}:${i}`;
                    keys.push(key);
                    await b0Img_putBlob(key, blob);
                }
                
                const tempoSalvar = ((performance.now() - inicioSalvar) / 1000).toFixed(2);
                
                status.textContent = 'Status: Carregando imagens do IndexedDB...';
                const inicioCarregar = performance.now();
                
                // Carregar e validar
                let sucessoCarregar = 0;
                let tamanhoTotal = 0;
                for (const key of keys) {
                    const blob = await b0Img_getBlob(key);
                    if (blob && blob.size >= 100 * 1024 && blob.size <= 500 * 1024) {
                        sucessoCarregar++;
                        tamanhoTotal += blob.size;
                    }
                }
                
                const tempoCarregar = ((performance.now() - inicioCarregar) / 1000).toFixed(2);
                const tamanhoTotalMB = (tamanhoTotal / (1024 * 1024)).toFixed(2);
                
                const resultado = {
                    tipo: 'B0-B',
                    sucesso: true,
                    gravadas: keys.length,
                    carregadas: sucessoCarregar,
                    tamanhoTotal: tamanhoTotalMB,
                    tempoSalvar: tempoSalvar,
                    tempoCarregar: tempoCarregar,
                    keys: keys
                };
                
                b0Img_renderReport(resultado);
                
            } catch (error) {
                const resultado = {
                    tipo: 'B0-B',
                    sucesso: false,
                    erro: error.message,
                    gravadas: keys.length,
                    keys: keys
                };
                b0Img_renderReport(resultado);
            } finally {
                // Reabilitar bot√µes
                btnA.disabled = false;
                btnB.disabled = false;
                btnLimpar.disabled = false;
                btnB.textContent = 'üß™ B0-B (Canvas JPEG)';
            }
        }
        
        // Criar JPEG via canvas
        async function b0Img_criarJPEGViaCanvas(largura = 1280, altura = 960) {
            const canvas = document.createElement('canvas');
            canvas.width = largura;
            canvas.height = altura;
            const ctx = canvas.getContext('2d');
            
            // Preencher fundo branco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, largura, altura);
            
            // Desenhar texto/grade simples (simular foto de resumo)
            ctx.fillStyle = '#000000';
            ctx.font = '24px Arial';
            ctx.fillText('Teste de Imagem VRVS', 50, 50);
            ctx.fillText('Resumo/Classifica√ß√£o', 50, 100);
            
            // Desenhar grade simples
            ctx.strokeStyle = '#CCCCCC';
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(50, 150 + i * 80);
                ctx.lineTo(largura - 50, 150 + i * 80);
                ctx.stroke();
            }
            
            // Converter para JPEG blob
            return new Promise((resolve, reject) => {
                canvas.toBlob((blob) => {
                    if (!blob) {
                        reject(new Error('toBlob retornou null'));
                    } else {
                        resolve(blob);
                    }
                }, 'image/jpeg', 0.85); // Qualidade 85%
            });
        }
        
        // Renderizar relat√≥rio na tela
        function b0Img_renderReport(resultado) {
            const status = document.getElementById('b0Img_status');
            const btnCopy = document.getElementById('b0Img_btnCopy');
            const reportText = document.getElementById('b0Img_reportText');
            
            let texto = '';
            
            if (resultado.sucesso) {
                texto = `‚úÖ ${resultado.tipo} conclu√≠do!\n\n`;
                texto += `Imagens gravadas: ${resultado.gravadas}/${resultado.gravadas}\n`;
                texto += `Imagens carregadas: ${resultado.carregadas}/${resultado.gravadas}\n`;
                texto += `Tamanho total: ~${resultado.tamanhoTotal} MB\n`;
                texto += `Tempo de salvamento: ${resultado.tempoSalvar}s\n`;
                texto += `Tempo de carregamento: ${resultado.tempoCarregar}s\n\n`;
                texto += `Status: Sucesso`;
            } else {
                texto = `‚ùå ${resultado.tipo} falhou\n\n`;
                texto += `Motivo: ${resultado.erro || 'Erro desconhecido'}\n`;
                if (resultado.gravadas > 0) {
                    texto += `Imagens gravadas antes da falha: ${resultado.gravadas}\n`;
                }
                texto += `\nStatus: Falha`;
            }
            
            status.textContent = texto;
            
            // Gerar texto copi√°vel
            let textoCopiavel = `B0 SPIKE - ${resultado.tipo}\n`;
            textoCopiavel += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
            textoCopiavel += `\n${texto}`;
            if (resultado.keys && resultado.keys.length > 0) {
                textoCopiavel += `\n\nKeys geradas: ${resultado.keys.length}\n`;
                textoCopiavel += resultado.keys.slice(0, 5).join('\n');
                if (resultado.keys.length > 5) {
                    textoCopiavel += `\n... e mais ${resultado.keys.length - 5} keys`;
                }
            }
            
            reportText.value = textoCopiavel;
            btnCopy.style.display = 'block';
            reportText.style.display = 'block';
        }
        
        // Copiar relat√≥rio para clipboard
        async function b0Img_copyReport() {
            const reportText = document.getElementById('b0Img_reportText');
            
            try {
                await navigator.clipboard.writeText(reportText.value);
                const btnCopy = document.getElementById('b0Img_btnCopy');
                const textoOriginal = btnCopy.textContent;
                btnCopy.textContent = '‚úÖ Copiado!';
                setTimeout(() => {
                    btnCopy.textContent = textoOriginal;
                }, 2000);
            } catch (error) {
                // Fallback: selecionar textarea
                reportText.select();
                reportText.setSelectionRange(0, 99999);
                document.execCommand('copy');
                const btnCopy = document.getElementById('b0Img_btnCopy');
                btnCopy.textContent = '‚úÖ Copiado (fallback)!';
                setTimeout(() => {
                    btnCopy.textContent = 'üìã Copiar relat√≥rio';
                }, 2000);
            }
        }
        
        // Limpar teste (remover todas as keys de teste)
        async function b0Img_limparTeste() {
            const btnLimpar = document.getElementById('b0Img_btnLimpar');
            const status = document.getElementById('b0Img_status');
            
            btnLimpar.disabled = true;
            btnLimpar.textContent = '‚è≥ Limpando...';
            
            try {
                const keys = await b0Img_listTestKeys('teste:');
                
                if (keys.length === 0) {
                    status.textContent = 'Status: Nenhuma imagem de teste encontrada.';
                    return;
                }
                
                for (const key of keys) {
                    await b0Img_deleteKey(key);
                }
                
                status.textContent = `‚úÖ ${keys.length} imagens de teste removidas.`;
                
                // Limpar UI
                const btnCopy = document.getElementById('b0Img_btnCopy');
                const reportText = document.getElementById('b0Img_reportText');
                btnCopy.style.display = 'none';
                reportText.style.display = 'none';
                
            } catch (error) {
                status.textContent = `‚ö†Ô∏è Erro ao limpar teste: ${error.message}`;
            } finally {
                btnLimpar.disabled = false;
                btnLimpar.textContent = 'üóëÔ∏è Limpar teste';
            }
        }
        
        // ==================== FIM B0 SPIKE ====================
        
        // ==================== B1 ‚Äî FUN√á√ïES DE IMAGEM DO DI√ÅRIO ====================
        
        // Vari√°veis globais para controle de imagem no modal
        window.diario_imagemBlobAtual = null;
        window.diario_imagemMetadataAtual = null;
        window.diario_imagemRemovida = false;
        window.diario_imagemNovaSelecionada = false; // B1-FIX: Flag para distinguir nova sele√ß√£o vs carregamento
        
        // MP1: Vari√°veis globais para imagem da PERGUNTA
        window.diario_imagemPerguntaNovaSelecionada = false;
        window.diario_imagemPerguntaBlobAtual = null;
        window.diario_imagemPerguntaMetadataAtual = null;
        window.diario_imagemPerguntaRemovida = false;
        
        // Processar imagem selecionada
        async function diario_processarImagem(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const btnAdd = document.getElementById('novaDiarioImagemBtn');
            const preview = document.getElementById('novaDiarioImagemPreview');
            const thumbImg = document.getElementById('novaDiarioImagemThumb');
            const inputFile = document.getElementById('novaDiarioImagem');
            
            if (!btnAdd || !preview || !thumbImg || !inputFile) return;
            
            // Desabilitar bot√£o durante processamento
            btnAdd.disabled = true;
            btnAdd.textContent = '‚è≥ Processando...';
            
            try {
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    throw new Error('Arquivo deve ser uma imagem');
                }
                
                // Validar tamanho (limite: 10MB antes de compress√£o)
                const MAX_SIZE_BEFORE_COMPRESSION = 10 * 1024 * 1024;
                if (file.size > MAX_SIZE_BEFORE_COMPRESSION) {
                    throw new Error('Imagem muito grande (m√°x. 10MB antes de compress√£o)');
                }
                
                // Carregar imagem
                const img = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error('Erro ao carregar imagem'));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                    reader.readAsDataURL(file);
                });
                
                // Processar imagem (redimensionar e comprimir)
                const processedBlob = await diario_processarImagemAdaptativa(img, file.type);
                
                if (!processedBlob) {
                    throw new Error('Erro ao processar imagem');
                }
                
                // Validar tamanho final (limite: 2MB ap√≥s compress√£o)
                const MAX_SIZE_AFTER_COMPRESSION = 2 * 1024 * 1024;
                if (processedBlob.size > MAX_SIZE_AFTER_COMPRESSION) {
                    throw new Error('Imagem ainda muito grande ap√≥s compress√£o (m√°x. 2MB)');
                }
                
                // Criar preview thumbnail
                const thumbBlob = await diario_gerarThumbnail(processedBlob);
                const thumbURL = URL.createObjectURL(thumbBlob);
                
                thumbImg.src = thumbURL;
                // B1-FIX: MICRO-FIX onerror (usar ev correto)
                thumbImg.onerror = (ev) => {
                    URL.revokeObjectURL(thumbURL);
                    diario_handleImageError(ev);
                };
                // B1-FIX: onload para evitar memory leak (revogar quando imagem carregar com sucesso)
                thumbImg.onload = () => {
                    // N√£o revogar aqui, apenas quando remover ou erro
                    // URL ser√° revogada em diario_limparImagemModal() ou diario_removerImagem()
                };
                
                preview.style.display = 'block';
                btnAdd.style.display = 'none';
                
                // Armazenar blob e metadata
                window.diario_imagemBlobAtual = processedBlob;
                window.diario_imagemMetadataAtual = {
                    tipo: file.type,
                    tamanho: processedBlob.size,
                    largura: img.width,
                    altura: img.height
                };
                window.diario_imagemRemovida = false;
                window.diario_imagemNovaSelecionada = true; // B1-FIX: Usu√°rio selecionou nova imagem
                
                // Atualizar indicador visual
                const statusEl = document.getElementById('novaDiarioImagemStatus');
                if (statusEl) {
                    const tamanhoKB = Math.round(processedBlob.size / 1024);
                    statusEl.textContent = `üì∑ imagem: OK (${tamanhoKB}KB)`;
                    statusEl.style.color = 'rgba(0,206,209,0.8)';
                }
                
                mostrarNotificacaoFeedback('‚úÖ Imagem processada com sucesso!', 'success');
                
            } catch (error) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è Erro ao processar imagem: ${error.message}`, 'error');
                // Limpar input
                inputFile.value = '';
                // Limpar preview se houver
                if (preview) preview.style.display = 'none';
                if (btnAdd) btnAdd.style.display = 'block';
            } finally {
                // Reabilitar bot√£o
                btnAdd.disabled = false;
                btnAdd.textContent = 'üì∑ Adicionar imagem';
            }
        }
        
        // Processar imagem com compress√£o adaptativa
        async function diario_processarImagemAdaptativa(img, tipoOriginal) {
            const MAX_WIDTH = 1920;
            const MAX_HEIGHT = 1920;
            const TARGET_SIZE = 1.5 * 1024 * 1024; // 1.5MB alvo
            const MIN_QUALITY = 0.3;
            
            let width = img.width;
            let height = img.height;
            
            // Redimensionar se necess√°rio
            if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                width = Math.round(width * ratio);
                height = Math.round(height * ratio);
            }
            
            // Criar canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Compress√£o adaptativa: tentar diferentes qualidades
            let quality = 0.85;
            let blob = null;
            
            while (quality >= MIN_QUALITY) {
                blob = await new Promise((resolve) => {
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                });
                
                if (!blob) break;
                
                if (blob.size <= TARGET_SIZE) {
                    break; // Tamanho aceit√°vel
                }
                
                // Reduzir qualidade e tentar novamente
                quality -= 0.1;
                
                // Se ainda n√£o cabe, reduzir dimens√µes
                if (quality < MIN_QUALITY && blob.size > TARGET_SIZE) {
                    width = Math.round(width * 0.9);
                    height = Math.round(height * 0.9);
                    canvas.width = width;
                    canvas.height = height;
                    ctx.clearRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    quality = 0.85; // Resetar qualidade
                }
            }
            
            return blob;
        }
        
        // P1 DEBUG START - Instrumenta√ß√£o visual do caret (remov√≠vel)
        let p1DebugCaretAtivo = false;
        
        function toggleP1DebugCaret() {
            p1DebugCaretAtivo = !p1DebugCaretAtivo;
            const pill = document.getElementById('p1-debug-caret-pill');
            const btn = document.getElementById('p1-debug-toggle');
            
            if (pill) {
                if (p1DebugCaretAtivo) {
                    pill.classList.add('active');
                    if (btn) {
                        btn.textContent = 'üêû Debug ON';
                        btn.style.background = 'rgba(0, 206, 209, 0.4)';
                    }
                } else {
                    pill.classList.remove('active');
                    pill.textContent = '';
                    if (btn) {
                        btn.textContent = 'üêû Debug Caret';
                        btn.style.background = 'rgba(0, 206, 209, 0.2)';
                    }
                }
            }
        }
        
        function atualizarP1DebugCaret(el) {
            if (!p1DebugCaretAtivo || !el) return;
            
            const pill = document.getElementById('p1-debug-caret-pill');
            if (!pill) return;
            
            const computed = window.getComputedStyle(el);
            const parent = el.parentElement;
            const parentComputed = parent ? window.getComputedStyle(parent) : null;
            const grandParent = parent?.parentElement;
            const grandParentComputed = grandParent ? window.getComputedStyle(grandParent) : null;
            
            const info = `
<span class="p1-debug-label">ID:</span><span class="p1-debug-value">${el.id || 'N/A'}</span><br>
<span class="p1-debug-label">font-size:</span><span class="p1-debug-value">${computed.fontSize}</span><br>
<span class="p1-debug-label">line-height:</span><span class="p1-debug-value">${computed.lineHeight}</span><br>
<span class="p1-debug-label">transform:</span><span class="p1-debug-value">${computed.transform === 'none' ? 'none' : computed.transform}</span><br>
<span class="p1-debug-label">parent backdrop-filter:</span><span class="p1-debug-value">${parentComputed?.backdropFilter || 'none'}</span><br>
<span class="p1-debug-label">parent overflow:</span><span class="p1-debug-value">${parentComputed?.overflow || 'none'}</span><br>
<span class="p1-debug-label">grandparent backdrop-filter:</span><span class="p1-debug-value">${grandParentComputed?.backdropFilter || 'none'}</span><br>
<span class="p1-debug-label">grandparent transform:</span><span class="p1-debug-value">${grandParentComputed?.transform === 'none' ? 'none' : grandParentComputed?.transform || 'none'}</span>
            `.trim();
            
            pill.innerHTML = info;
        }
        
        // Adicionar listeners quando modal abrir
        document.addEventListener('DOMContentLoaded', () => {
            const topico = document.getElementById('novaDiarioTopico');
            const resposta = document.getElementById('novaDiarioResposta');
            
            if (topico) {
                topico.addEventListener('focus', () => atualizarP1DebugCaret(topico));
                topico.addEventListener('blur', () => {
                    const pill = document.getElementById('p1-debug-caret-pill');
                    if (pill && p1DebugCaretAtivo) {
                        pill.innerHTML = '<span class="p1-debug-label">‚Äî</span>';
                    }
                });
            }
            
            if (resposta) {
                resposta.addEventListener('focus', () => atualizarP1DebugCaret(resposta));
                resposta.addEventListener('blur', () => {
                    const pill = document.getElementById('p1-debug-caret-pill');
                    if (pill && p1DebugCaretAtivo) {
                        pill.innerHTML = '<span class="p1-debug-label">‚Äî</span>';
                    }
                });
            }
        });
        // P1 DEBUG END
        
        // Gerar thumbnail (200x200px m√°ximo)
        async function diario_gerarThumbnail(blob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const MAX_THUMB_SIZE = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_THUMB_SIZE || height > MAX_THUMB_SIZE) {
                        const ratio = Math.min(MAX_THUMB_SIZE / width, MAX_THUMB_SIZE / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((thumbBlob) => {
                        if (thumbBlob) {
                            resolve(thumbBlob);
                        } else {
                            reject(new Error('Erro ao gerar thumbnail'));
                        }
                    }, 'image/jpeg', 0.8);
                };
                img.onerror = () => reject(new Error('Erro ao carregar imagem para thumbnail'));
                img.src = URL.createObjectURL(blob);
            });
        }
        
        // Remover imagem
        function diario_removerImagem() {
            const preview = document.getElementById('novaDiarioImagemPreview');
            const thumbImg = document.getElementById('novaDiarioImagemThumb');
            const btnAdd = document.getElementById('novaDiarioImagemBtn');
            const inputFile = document.getElementById('novaDiarioImagem');
            
            // B1-FIX: desarmar handlers antes de mexer em src/revoke (evita toast fora de contexto)
            if (thumbImg) {
                thumbImg.onerror = null;
                thumbImg.onload = null;
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            
            if (preview) preview.style.display = 'none';
            if (btnAdd) btnAdd.style.display = 'block';
            if (inputFile) inputFile.value = '';
            if (thumbImg) thumbImg.src = '';
            
            // Limpar vari√°veis globais
            window.diario_imagemBlobAtual = null;
            window.diario_imagemMetadataAtual = null;
            window.diario_imagemRemovida = true; // Flag expl√≠cita
            window.diario_imagemNovaSelecionada = false; // B1-FIX: Resetar flag
            
            // Atualizar indicador visual
            const statusEl = document.getElementById('novaDiarioImagemStatus');
            if (statusEl) {
                statusEl.textContent = 'üì∑ imagem: ‚Äî';
                statusEl.style.color = 'rgba(255,255,255,0.6)';
            }
        }
        
        // MP1: Processar imagem da PERGUNTA selecionada
        async function diario_processarImagemPergunta(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const btnAdd = document.getElementById('novaDiarioImagemPerguntaBtn');
            const preview = document.getElementById('novaDiarioImagemPerguntaPreview');
            const thumbImg = document.getElementById('novaDiarioImagemPerguntaThumb');
            const inputFile = document.getElementById('novaDiarioImagemPergunta');
            
            if (!btnAdd || !preview || !thumbImg || !inputFile) return;
            
            // Desabilitar bot√£o durante processamento
            btnAdd.disabled = true;
            btnAdd.textContent = '‚è≥ Processando...';
            
            try {
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    throw new Error('Arquivo deve ser uma imagem');
                }
                
                // Validar tamanho (limite: 10MB antes de compress√£o)
                const MAX_SIZE_BEFORE_COMPRESSION = 10 * 1024 * 1024;
                if (file.size > MAX_SIZE_BEFORE_COMPRESSION) {
                    throw new Error('Imagem muito grande (m√°x. 10MB antes de compress√£o)');
                }
                
                // Carregar imagem
                const img = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error('Erro ao carregar imagem'));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                    reader.readAsDataURL(file);
                });
                
                // Processar imagem (redimensionar e comprimir)
                const processedBlob = await diario_processarImagemAdaptativa(img, file.type);
                
                if (!processedBlob) {
                    throw new Error('Erro ao processar imagem');
                }
                
                // Validar tamanho final (limite: 2MB ap√≥s compress√£o)
                const MAX_SIZE_AFTER_COMPRESSION = 2 * 1024 * 1024;
                if (processedBlob.size > MAX_SIZE_AFTER_COMPRESSION) {
                    throw new Error('Imagem ainda muito grande ap√≥s compress√£o (m√°x. 2MB)');
                }
                
                // Criar preview thumbnail
                const thumbBlob = await diario_gerarThumbnail(processedBlob);
                const thumbURL = URL.createObjectURL(thumbBlob);
                
                thumbImg.src = thumbURL;
                thumbImg.onerror = (ev) => {
                    URL.revokeObjectURL(thumbURL);
                    diario_handleImageErrorPergunta(ev);
                };
                thumbImg.onload = () => {
                    // N√£o revogar aqui, apenas quando remover ou erro
                };
                
                preview.style.display = 'block';
                btnAdd.style.display = 'none';
                
                // Armazenar blob e metadata
                window.diario_imagemPerguntaBlobAtual = processedBlob;
                window.diario_imagemPerguntaMetadataAtual = {
                    tipo: file.type,
                    tamanho: processedBlob.size,
                    largura: img.width,
                    altura: img.height
                };
                window.diario_imagemPerguntaRemovida = false;
                window.diario_imagemPerguntaNovaSelecionada = true;
                
                // Atualizar indicador visual
                const statusEl = document.getElementById('novaDiarioImagemPerguntaStatus');
                if (statusEl) {
                    const tamanhoKB = Math.round(processedBlob.size / 1024);
                    statusEl.textContent = `üì∑ imagem: OK (${tamanhoKB}KB)`;
                    statusEl.style.color = 'rgba(0,206,209,0.8)';
                }
                
                mostrarNotificacaoFeedback('‚úÖ Imagem processada com sucesso!', 'success');
                
            } catch (error) {
                mostrarNotificacaoFeedback(`‚ö†Ô∏è Erro ao processar imagem: ${error.message}`, 'error');
                // Limpar input
                inputFile.value = '';
                // Limpar preview se houver
                if (preview) preview.style.display = 'none';
                if (btnAdd) btnAdd.style.display = 'block';
            } finally {
                // Reabilitar bot√£o
                btnAdd.disabled = false;
                btnAdd.textContent = 'üì∑ Adicionar imagem';
            }
        }
        
        // MP1: Remover imagem da PERGUNTA
        function diario_removerImagemPergunta() {
            const preview = document.getElementById('novaDiarioImagemPerguntaPreview');
            const thumbImg = document.getElementById('novaDiarioImagemPerguntaThumb');
            const btnAdd = document.getElementById('novaDiarioImagemPerguntaBtn');
            const inputFile = document.getElementById('novaDiarioImagemPergunta');
            
            // B1-FIX: desarmar handlers antes de mexer em src/revoke
            if (thumbImg) {
                thumbImg.onerror = null;
                thumbImg.onload = null;
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            
            if (preview) preview.style.display = 'none';
            if (btnAdd) btnAdd.style.display = 'block';
            if (inputFile) inputFile.value = '';
            if (thumbImg) thumbImg.src = '';
            
            // Limpar vari√°veis globais
            window.diario_imagemPerguntaBlobAtual = null;
            window.diario_imagemPerguntaMetadataAtual = null;
            window.diario_imagemPerguntaRemovida = true;
            window.diario_imagemPerguntaNovaSelecionada = false;
            
            // Atualizar indicador visual
            const statusEl = document.getElementById('novaDiarioImagemPerguntaStatus');
            if (statusEl) {
                statusEl.textContent = 'üì∑ imagem: ‚Äî';
                statusEl.style.color = 'rgba(255,255,255,0.6)';
            }
        }
        
        // MP1: Limpar imagem da PERGUNTA do modal (ao fechar)
        function diario_limparImagemPerguntaModal() {
            const preview = document.getElementById('novaDiarioImagemPerguntaPreview');
            const thumbImg = document.getElementById('novaDiarioImagemPerguntaThumb');
            const btnAdd = document.getElementById('novaDiarioImagemPerguntaBtn');
            const inputFile = document.getElementById('novaDiarioImagemPergunta');
            
            // B1-FIX: desarmar handlers antes de mexer em src/revoke
            if (thumbImg) {
                thumbImg.onerror = null;
                thumbImg.onload = null;
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            
            if (preview) preview.style.display = 'none';
            if (btnAdd) btnAdd.style.display = 'block';
            if (inputFile) inputFile.value = '';
            if (thumbImg) thumbImg.src = '';
            
            // Limpar vari√°veis globais
            window.diario_imagemPerguntaBlobAtual = null;
            window.diario_imagemPerguntaMetadataAtual = null;
            window.diario_imagemPerguntaRemovida = false;
            window.diario_imagemPerguntaNovaSelecionada = false;
            
            // Atualizar indicador visual
            const statusEl = document.getElementById('novaDiarioImagemPerguntaStatus');
            if (statusEl) {
                statusEl.textContent = 'üì∑ imagem: ‚Äî';
                statusEl.style.color = 'rgba(255,255,255,0.6)';
            }
        }
        
        // MP1: Handler de erro de imagem da PERGUNTA
        function diario_handleImageErrorPergunta(event) {
            const thumbImg = event.target;
            if (!thumbImg || !thumbImg.src || thumbImg.src === '' || thumbImg.src === 'data:' || 
                (!thumbImg.src.startsWith('blob:') && !thumbImg.src.startsWith('http') && !thumbImg.src.startsWith('data:'))) {
                return;
            }
            
            if (thumbImg && thumbImg.id === 'novaDiarioImagemPerguntaThumb') {
                const modal = document.getElementById('modalNovaDiario');
                if (!modal || !modal.classList.contains('active')) {
                    return;
                }
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
            diario_removerImagemPergunta();
        }
        
        // MP1: Abrir viewer de imagem da PERGUNTA
        async function diario_abrirViewerImagemPergunta(entradaId) {
            const entrada = window.diario.entradas.find(e => String(e.id) === String(entradaId));
            if (!entrada || !entrada.imagemPergunta || !entrada.imagemPergunta.fullKey) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Imagem n√£o encontrada', 'error');
                return;
            }
            
            try {
                // PATCH P2: Usar imagemPergunta.fullKey (igual resposta usa imagem.fullKey)
                const fullBlob = await b0Img_getBlob(entrada.imagemPergunta.fullKey);
                if (!fullBlob) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
                    return;
                }
                
                const fullURL = URL.createObjectURL(fullBlob);
                
                // Estado do zoom/pan
                let scale = 1;
                let tx = 0;
                let ty = 0;
                
                let baseW = 0;
                let baseH = 0;
                
                let isPanning = false;
                let startX = 0, startY = 0;
                let startTX = 0, startTY = 0;
                
                let isPinching = false;
                let initialPinchDistance = 0;
                let initialPinchScale = 1;
                let initialPinchCenterX = 0;
                let initialPinchCenterY = 0;
                let initialPinchTX = 0;
                let initialPinchTY = 0;
                
                let lastTapTime = 0;
                let lastTapX = 0;
                let lastTapY = 0;
                
                // Criar overlay (ID √∫nico para n√£o conflitar com viewer da resposta)
                const overlay = document.createElement('div');
                overlay.id = 'diario-viewer-overlay-pergunta';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    overflow: hidden;
                `;
                
                // Imagem ampliada
                const img = document.createElement('img');
                img.src = fullURL;
                img.style.cssText = `
                    max-width: 95%;
                    max-height: 95%;
                    object-fit: contain;
                    border-radius: 8px;
                    user-select: none;
                    -webkit-user-select: none;
                    -webkit-touch-callout: none;
                    transform-origin: center center;
                `;
                
                // Helpers
                const aplicarTransform = () => {
                    img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
                };
                
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                
                const clampPan = () => {
                    const o = overlay.getBoundingClientRect();
                    const maxX = Math.max(0, (baseW * scale - o.width) / 2);
                    const maxY = Math.max(0, (baseH * scale - o.height) / 2);
                    tx = clamp(tx, -maxX, maxX);
                    ty = clamp(ty, -maxY, maxY);
                };
                
                const resetZoom = () => {
                    scale = 1;
                    tx = 0;
                    ty = 0;
                    aplicarTransform();
                };
                
                const zoomAt = (clientX, clientY, nextScale) => {
                    const o = overlay.getBoundingClientRect();
                    const x = clientX - o.left;
                    const y = clientY - o.top;
                    
                    // mover "em dire√ß√£o" ao ponto tocado
                    scale = nextScale;
                    tx = (o.width / 2 - x) * (scale - 1);
                    ty = (o.height / 2 - y) * (scale - 1);
                    
                    clampPan();
                    aplicarTransform();
                };
                
                const calcularDistancia = (t1, t2) => {
                    const dx = t1.clientX - t2.clientX;
                    const dy = t1.clientY - t2.clientY;
                    return Math.hypot(dx, dy);
                };
                
                const calcularCentro = (t1, t2) => {
                    return {
                        x: (t1.clientX + t2.clientX) / 2,
                        y: (t1.clientY + t2.clientY) / 2
                    };
                };
                
                // Medir tamanho base ap√≥s carregar
                img.onload = () => {
                    requestAnimationFrame(() => {
                        const r = img.getBoundingClientRect();
                        baseW = r.width || baseW;
                        baseH = r.height || baseH;
                        aplicarTransform();
                    });
                };
                
                // Touch handlers
                img.addEventListener('touchstart', (e) => {
                    if (!e.touches) return;
                    
                    // Pinch gesture (2 toques)
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        isPanning = false;
                        isPinching = true;
                        
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        initialPinchDistance = calcularDistancia(t1, t2);
                        initialPinchScale = scale;
                        const centro = calcularCentro(t1, t2);
                        initialPinchCenterX = centro.x;
                        initialPinchCenterY = centro.y;
                        initialPinchTX = tx;
                        initialPinchTY = ty;
                        
                        img.style.transition = 'none';
                        return;
                    }
                    
                    // Single touch (double-tap ou pan)
                    if (e.touches.length !== 1) return;
                    
                    const t = e.touches[0];
                    const now = Date.now();
                    const dt = now - lastTapTime;
                    const dx = Math.abs(t.clientX - lastTapX);
                    const dy = Math.abs(t.clientY - lastTapY);
                    
                    // double-tap
                    if (dt < 300 && dx < 40 && dy < 40) {
                        e.preventDefault();
                        lastTapTime = 0;
                        
                        if (scale === 1) {
                            zoomAt(t.clientX, t.clientY, 2.5);
                        } else {
                            resetZoom();
                        }
                        return;
                    }
                    
                    lastTapTime = now;
                    lastTapX = t.clientX;
                    lastTapY = t.clientY;
                    
                    // pan s√≥ se estiver ampliado
                    if (scale > 1) {
                        e.preventDefault();
                        isPanning = true;
                        isPinching = false;
                        startX = t.clientX;
                        startY = t.clientY;
                        startTX = tx;
                        startTY = ty;
                        img.style.transition = 'none';
                    }
                }, { passive: false });
                
                img.addEventListener('touchmove', (e) => {
                    if (!e.touches) return;
                    
                    // Pinch gesture (2 toques)
                    if (e.touches.length === 2 && isPinching) {
                        e.preventDefault();
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        const currentDistance = calcularDistancia(t1, t2);
                        
                        if (initialPinchDistance > 0) {
                            const scaleFactor = currentDistance / initialPinchDistance;
                            scale = Math.max(1, Math.min(5, initialPinchScale * scaleFactor));
                            
                            // Ajustar translate para manter o ponto de zoom fixo
                            const o = overlay.getBoundingClientRect();
                            const centro = calcularCentro(t1, t2);
                            const deltaX = centro.x - initialPinchCenterX;
                            const deltaY = centro.y - initialPinchCenterY;
                            
                            tx = initialPinchTX + deltaX;
                            ty = initialPinchTY + deltaY;
                            
                            clampPan();
                            aplicarTransform();
                        }
                        return;
                    }
                    
                    // Pan gesture (1 toque)
                    if (!isPanning || scale <= 1 || e.touches.length !== 1) return;
                    e.preventDefault();
                    const t = e.touches[0];
                    tx = startTX + (t.clientX - startX);
                    ty = startTY + (t.clientY - startY);
                    clampPan();
                    aplicarTransform();
                }, { passive: false });
                
                img.addEventListener('touchend', (e) => {
                    if (isPinching && (!e.touches || e.touches.length < 2)) {
                        isPinching = false;
                        img.style.transition = '';
                    }
                    if (isPanning && (!e.touches || e.touches.length === 0)) {
                        isPanning = false;
                        img.style.transition = '';
                    }
                });
                
                // Bot√£o fechar
                const btnFechar = document.createElement('button');
                btnFechar.textContent = '‚úï';
                btnFechar.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    z-index: 10001;
                `;
                
                const fechar = () => {
                    try { URL.revokeObjectURL(fullURL); } catch(e) {}
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                };
                
                btnFechar.onclick = (e) => {
                    e.stopPropagation();
                    fechar();
                };
                
                // Overlay click: fecha se zoom == 1, reseta zoom se zoom > 1
                overlay.addEventListener('click', (e) => {
                    if (e.target !== overlay) return;
                    if (scale > 1) {
                        resetZoom();
                    } else {
                        fechar();
                    }
                });
                
                img.onclick = (e) => e.stopPropagation();
                
                overlay.appendChild(img);
                overlay.appendChild(btnFechar);
                document.body.appendChild(overlay);
                
            } catch (error) {
                console.error('Erro ao abrir viewer da pergunta:', error);
                mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
            }
        }
        
        // MP1: Fechar viewer de imagem da PERGUNTA
        function diario_fecharViewerImagemPergunta() {
            const viewerModal = document.getElementById('diario-viewer-imagem-pergunta');
            if (viewerModal) {
                const imgElement = document.getElementById('diario-viewer-imagem-pergunta-img');
                if (imgElement) {
                    // PATCH C: Desarmar onerror antes de limpar src (evita toast incorreto)
                    imgElement.onerror = null;
                    imgElement.onload = null;
                    
                    if (imgElement.src && imgElement.src.startsWith('blob:')) {
                        URL.revokeObjectURL(imgElement.src);
                    }
                    imgElement.src = '';
                }
                viewerModal.classList.remove('active');
            }
        }
        
        // Limpar imagem do modal (ao fechar)
        function diario_limparImagemModal() {
            const preview = document.getElementById('novaDiarioImagemPreview');
            const thumbImg = document.getElementById('novaDiarioImagemThumb');
            const btnAdd = document.getElementById('novaDiarioImagemBtn');
            const inputFile = document.getElementById('novaDiarioImagem');
            
            // B1-FIX: desarmar handlers antes de mexer em src/revoke (evita toast fora de contexto)
            if (thumbImg) {
                thumbImg.onerror = null;
                thumbImg.onload = null;
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            
            if (preview) preview.style.display = 'none';
            if (btnAdd) btnAdd.style.display = 'block';
            if (inputFile) inputFile.value = '';
            if (thumbImg) thumbImg.src = '';
            
            // Limpar vari√°veis globais
            window.diario_imagemBlobAtual = null;
            window.diario_imagemMetadataAtual = null;
            window.diario_imagemRemovida = false;
            window.diario_imagemNovaSelecionada = false; // B1-FIX: Resetar flag
            
            // Atualizar indicador visual
            const statusEl = document.getElementById('novaDiarioImagemStatus');
            if (statusEl) {
                statusEl.textContent = 'üì∑ imagem: ‚Äî';
                statusEl.style.color = 'rgba(255,255,255,0.6)';
            }
        }
        
        // Handler de erro de imagem
        function diario_handleImageError(event) {
            const thumbImg = event.target;
            // PATCH: Guard clause - s√≥ processar se existe imagem v√°lida (URL v√°lida)
            if (!thumbImg || !thumbImg.src || thumbImg.src === '' || thumbImg.src === 'data:' || 
                (!thumbImg.src.startsWith('blob:') && !thumbImg.src.startsWith('http') && !thumbImg.src.startsWith('data:'))) {
                return; // N√£o disparar toast se n√£o h√° imagem v√°lida
            }
            
            // B1-FIX: se o modal do Di√°rio n√£o est√° ativo, ignorar erro (evento stale/cleanup)
            if (thumbImg && thumbImg.id === 'novaDiarioImagemThumb') {
                const modal = document.getElementById('modalNovaDiario');
                if (!modal || !modal.classList.contains('active')) {
                    return;
                }
            }
            
            if (thumbImg && thumbImg.src && thumbImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(thumbImg.src);
            }
            mostrarNotificacaoFeedback('‚ö†Ô∏è Erro ao carregar imagem', 'error');
            diario_removerImagem();
        }
        
        // B1-FIX: Adicionar handler onerror para elemento HTML inline ap√≥s DOM carregar
        if (typeof window !== 'undefined') {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    const thumbImgInline = document.getElementById('novaDiarioImagemThumb');
                    // PATCH 1: S√≥ adicionar handler se elemento existe E tem src v√°lido
                    if (thumbImgInline && !thumbImgInline.onerror && thumbImgInline.src && thumbImgInline.src.startsWith('blob:')) {
                        thumbImgInline.onerror = (ev) => {
                            if (thumbImgInline.src && thumbImgInline.src.startsWith('blob:')) {
                                URL.revokeObjectURL(thumbImgInline.src);
                            }
                            diario_handleImageError(ev);
                        };
                    }
                });
            } else {
                // DOM j√° carregado
                const thumbImgInline = document.getElementById('novaDiarioImagemThumb');
                // PATCH 1: S√≥ adicionar handler se elemento existe E tem src v√°lido
                if (thumbImgInline && !thumbImgInline.onerror && thumbImgInline.src && thumbImgInline.src.startsWith('blob:')) {
                    thumbImgInline.onerror = (ev) => {
                        if (thumbImgInline.src && thumbImgInline.src.startsWith('blob:')) {
                            URL.revokeObjectURL(thumbImgInline.src);
                        }
                        diario_handleImageError(ev);
                    };
                }
            }
        }
        
        // ==================== FIM B1 ‚Äî FUN√á√ïES DE IMAGEM DO DI√ÅRIO ====================
        
        function renderAjudaFaq(container) {
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <input type="text" id="perguntaAssistenteAjuda" class="form-input" placeholder="Digite sua d√∫vida..." style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="responderDuvidaAjuda()">üîç Buscar Resposta</button>
                </div>
                <div id="respostaAssistenteAjuda" style="display: none; margin-bottom: 20px;"></div>
                
                <h4 style="color: var(--turquesa-light); margin-bottom: 15px;">üìö Perguntas Frequentes</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('adicionar')" style="text-align: left;">‚ùì Como adicionar um tema?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('feedback')" style="text-align: left;">‚ùì Como registrar uma sess√£o?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('agenda')" style="text-align: left;">‚ùì Como usar a agenda?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('backup')" style="text-align: left;">‚ùì Como fazer backup?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('hottopics')" style="text-align: left;">‚ùì O que s√£o Hot Topics?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('caderno')" style="text-align: left;">‚ùì Como usar o Caderno V2?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('analytics')" style="text-align: left;">‚ùì Como usar An√°lises?</button>
                    <button class="btn btn-small" onclick="mostrarRespostaAjuda('exportar')" style="text-align: left;">‚ùì Como exportar Hot Topics em HTML?</button>
                </div>
                <div id="respostaFaqAjuda" style="margin-top: 20px;"></div>
            `;
        }
        
        function forcarAtualizacaoApp() {
            if ('serviceWorker' in navigator && window.forcarAtualizacaoSW) {
                window.forcarAtualizacaoSW();
            } else {
                alert('Service Worker n√£o dispon√≠vel. Recarregando p√°gina...');
                window.location.reload(true);
            }
        }
        
        // === FUN√á√ïES DIAGN√ìSTICO/RESET (2025-01-01) ===
        const APP_BUILD = "20260126-2140";
        const APP_BUILD_CACHE = "vrvs-v5.3.174-splash-bottomlines-wrap-20260126-2140";
        
        async function diagnosticoApp() {
            let info = `üìã DIAGN√ìSTICO DO APP\n\n`;
            info += `APP_BUILD: ${APP_BUILD}\n`;
            info += `CACHE_NAME LOCAL: ${APP_BUILD_CACHE}\n\n`;
            
            if ('serviceWorker' in navigator) {
                const controller = navigator.serviceWorker.controller;
                info += `Service Worker Controller: ${controller ? controller.scriptURL : 'null'}\n`;
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        info += `Registration Active: ${registration.active ? registration.active.scriptURL : 'null'}\n`;
                        info += `Registration Waiting: ${registration.waiting ? registration.waiting.scriptURL : 'null'}\n`;
                    }
                } catch (e) {
                    info += `Erro ao obter registration: ${e.message}\n`;
                }
                
                try {
                    const cacheNames = await window.caches.keys();
                    info += `\nCaches encontrados (${cacheNames.length}):\n`;
                    cacheNames.forEach(c => info += `  - ${c}\n`);
                } catch (e) {
                    info += `Erro ao listar caches: ${e.message}\n`;
                }
                
                try {
                    const swResponse = await fetch('./sw.js?ts=' + Date.now(), { cache: 'no-store' });
                    const swText = await swResponse.text();
                    const cacheMatch = swText.match(/const CACHE_NAME\s*=\s*["']([^"']+)["']/);
                    info += `\nCACHE_NAME ONLINE: ${cacheMatch ? cacheMatch[1] : 'N√ÉO ENCONTRADO'}\n`;
                } catch (e) {
                    info += `\nErro ao buscar sw.js online: ${e.message}\n`;
                }
            } else {
                info += `Service Worker n√£o dispon√≠vel\n`;
            }
            
            alert(info);
        }
        
        async function resetAppShell() {
            if (!confirm('üßπ Reset App Shell\n\nIsso vai:\n- Desregistrar Service Worker\n- Limpar todos os caches\n- Recarregar o app\n\nDados do localStorage N√ÉO ser√£o apagados.\n\nContinuar?')) {
                return;
            }
            
            try {
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r => r.unregister()));
                }
                
                const cacheKeys = await window.caches.keys();
                await Promise.all(cacheKeys.map(k => window.caches.delete(k)));
                
                alert('‚úÖ App Shell resetado! Recarregando...');
                location.href = location.pathname + '?reset=' + Date.now();
            } catch (e) {
                alert('‚ùå Erro ao resetar: ' + e.message);
            }
        }
        
        function toggleFerramentasConfig() {
            const content = document.getElementById('ferramentasConfigContent');
            const toggle = document.getElementById('ferramentasConfigToggle');
            if (!content || !toggle) return;
            
            const isVisible = content.style.display !== 'none';
            content.style.display = isVisible ? 'none' : 'block';
            toggle.textContent = isVisible ? '‚ñº Expandir' : '‚ñ≤ Recolher';
        }
        
        function toggleBackupConfig() {
            const content = document.getElementById('backupConfigContent');
            const toggle = document.getElementById('backupConfigToggle');
            if (!content || !toggle) return;
            
            const isVisible = content.style.display !== 'none';
            content.style.display = isVisible ? 'none' : 'block';
            toggle.textContent = isVisible ? '‚ñº Expandir' : '‚ñ≤ Recolher';
        }
        // === FIM FUN√á√ïES DIAGN√ìSTICO/RESET ===
        
        function mostrarRespostaAjuda(tipo) {
            const container = document.getElementById('respostaFaqAjuda');
            const respostas = {
                'adicionar': 'V√° em <b>Dados</b> e clique no bot√£o <b>‚ûï Novo Tema</b> no topo. Preencha a √°rea, tema e prioridade no modal que abrir.',
                'feedback': 'V√° em <b>Feedback</b>, selecione o tema, preencha data, performance e tempo (opcional), e clique em Salvar.',
                'agenda': 'A <b>Agenda</b> mostra seus estudos programados. Use o toggle no topo para alternar entre <b>Timeline</b> (cronograma completo) ou <b>Atrasados</b> (pend√™ncias).',
                'backup': 'V√° em <b>Backup</b> e clique nos bot√µes para exportar seus dados em CSV. Para restaurar, use a se√ß√£o Importar na mesma aba.',
                'hottopics': '<b>Hot Topics</b> s√£o os pontos mais importantes de cada tema - aqueles que caem com frequ√™ncia na prova. Anote-os no <b>Caderno</b> no campo destacado em laranja.',
                'caderno': 'O <b>Caderno V2</b> organiza temas por √°rea. Clique no cabe√ßalho da √°rea para expandir/colapsar. Hot Topics aparecem destacados. Clique em ‚úèÔ∏è para editar.',
                'analytics': '<b>An√°lises</b> unifica todas as an√°lises em um s√≥ lugar. Use os bot√µes de sub-navega√ß√£o para alternar entre Resumo, Gr√°ficos e Hist√≥rico.',
                'exportar': 'No <b>Caderno</b>, clique no bot√£o <b>üî• Exportar HTML</b> no topo. Um arquivo HTML ser√° baixado com todos os seus Hot Topics organizados por √°rea.'
            };
            
            container.innerHTML = `
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--turquesa-light);">
                    <div style="font-size: 14px; color: var(--text-light); line-height: 1.6;">${respostas[tipo] || 'Resposta n√£o encontrada.'}</div>
                </div>
            `;
        }
        
        function responderDuvidaAjuda() {
            const pergunta = document.getElementById('perguntaAssistenteAjuda')?.value?.toLowerCase() || '';
            const container = document.getElementById('respostaAssistenteAjuda');
            
            if (!pergunta.trim()) {
                container.style.display = 'none';
                return;
            }
            
            let resposta = 'N√£o encontrei uma resposta espec√≠fica. Tente explorar as perguntas frequentes abaixo.';
            
            if (pergunta.includes('tema') || pergunta.includes('adicionar') || pergunta.includes('cadastr')) {
                resposta = 'Para adicionar um tema, v√° em <b>Dados</b> e clique em <b>‚ûï Novo Tema</b>.';
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registr')) {
                resposta = 'Para registrar uma sess√£o, v√° em <b>Feedback</b> e preencha os dados da sua sess√£o de estudo.';
            } else if (pergunta.includes('backup') || pergunta.includes('export') || pergunta.includes('salvar')) {
                resposta = 'Para fazer backup, v√° em <b>Backup</b> e exporte seus dados em CSV.';
            } else if (pergunta.includes('hot') || pergunta.includes('prova') || pergunta.includes('importante')) {
                resposta = 'Use <b>Hot Topics</b> no <b>Caderno</b> para anotar os pontos mais importantes de cada tema. Voc√™ pode exportar todos em HTML!';
            } else if (pergunta.includes('caderno') || pergunta.includes('anota√ß√£o')) {
                resposta = 'O <b>Caderno V2</b> organiza temas por √°rea. Clique no cabe√ßalho da √°rea para expandir/colapsar. Hot Topics aparecem destacados em laranja.';
            } else if (pergunta.includes('analytics') || pergunta.includes('an√°lise') || pergunta.includes('gr√°fico')) {
                resposta = 'V√° em <b>An√°lises</b> e use os bot√µes de sub-navega√ß√£o para alternar entre Resumo, Gr√°ficos e Hist√≥rico.';
            } else if (pergunta.includes('export') || pergunta.includes('html')) {
                resposta = 'No <b>Caderno</b>, clique no bot√£o <b>üî• Exportar HTML</b> no topo para baixar todos os Hot Topics em um arquivo HTML.';
            }
            
            container.innerHTML = `
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--turquesa-light);">
                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                    <div style="font-size: 14px; color: var(--text-light); line-height: 1.6;">${resposta}</div>
                </div>
            `;
            container.style.display = 'block';
        }
        
        // ==================== EXPORTA√á√ÉO HOT TOPICS HTML ====================
        
        function exportarHotTopicsHTML(areaFiltro = null) {
            // Filtrar anota√ß√µes que t√™m hot topics
            let anotacoesComHotTopics = anotacoes.filter(a => a.hotTopics && a.hotTopics.trim());
            
            if (anotacoesComHotTopics.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum Hot Topic encontrado!', 'error');
                return;
            }
            
            // Aplicar filtro de √°rea se especificado
            if (areaFiltro) {
                anotacoesComHotTopics = anotacoesComHotTopics.filter(a => a.area === areaFiltro);
            }
            
            if (anotacoesComHotTopics.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum Hot Topic para esta √°rea!', 'error');
                return;
            }
            
            // Agrupar por √°rea
            const porArea = {};
            anotacoesComHotTopics.forEach(a => {
                if (!porArea[a.area]) porArea[a.area] = [];
                porArea[a.area].push(a);
            });
            
            // Gerar HTML
            const dataGeracao = new Date().toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Hot Topics TEOT 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 0 auto; }
        header {
            text-align: center;
            padding: 30px 0 40px;
            border-bottom: 2px solid rgba(0, 206, 209, 0.3);
            margin-bottom: 30px;
        }
        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #00FFE0, #FF9F40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .subtitle { color: rgba(0, 206, 209, 0.8); font-size: 14px; }
        .area { margin-bottom: 40px; }
        .area-title {
            color: #00CED1;
            font-size: 20px;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 206, 209, 0.3);
            margin-bottom: 20px;
        }
        .tema {
            background: rgba(20, 35, 45, 0.6);
            border: 1px solid rgba(255, 159, 64, 0.3);
            border-left: 4px solid #FF9F40;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .tema-title {
            color: #FFB84D;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .hot-topics {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.8;
        }
        footer {
            text-align: center;
            padding: 40px 0 20px;
            border-top: 1px solid rgba(0, 206, 209, 0.2);
            margin-top: 40px;
        }
        .footer-text { color: rgba(255, 255, 255, 0.5); font-size: 12px; }
        .footer-logo { color: #00CED1; font-weight: 700; margin-top: 10px; }
        @media print {
            body { background: white; color: #1a1a1a; }
            .tema { border: 1px solid #ccc; break-inside: avoid; }
            .area-title { color: #0d9488; }
            .tema-title { color: #b8701f; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• Hot Topics TEOT 2026</h1>
            <p class="subtitle">Gerado em ${dataGeracao}</p>
        </header>
        
        ${Object.keys(porArea).sort().map(area => `
            <div class="area">
                <h2 class="area-title">üìÅ ${area}</h2>
                ${porArea[area].sort((a, b) => a.tema.localeCompare(b.tema, 'pt-BR')).map(anotacao => `
                    <div class="tema">
                        <div class="tema-title">üìù ${anotacao.tema}</div>
                        <div class="hot-topics">${anotacao.hotTopics.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')}</div>
                    </div>
                `).join('')}
            </div>
        `).join('')}
        
        <footer>
            <p class="footer-text">Documento gerado automaticamente</p>
            <p class="footer-logo">üß† VRVS CIRCUIT TECH</p>
        </footer>
    </div>
</body>
</html>`;
            
            // Download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const nomeArquivo = areaFiltro 
                ? `HOT_TOPICS_${areaFiltro.replace(/\s+/g, '_').toUpperCase()}_${new Date().toISOString().split('T')[0]}.html`
                : `HOT_TOPICS_COMPLETO_${new Date().toISOString().split('T')[0]}.html`;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacaoFeedback(`‚úÖ ${anotacoesComHotTopics.length} Hot Topics exportados!`);
        }
        
        // ==================== EXPORTA√á√ÉO DI√ÅRIO CSV ====================
        
        function exportarDiarioCSV() {
            if (!window.diario || !window.diario.entradas || window.diario.entradas.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhuma entrada no di√°rio!', 'error');
                return;
            }
            
            const headers = ['id', 'data', 'area', 'tema', 'topico', 'resposta', 'atencao', 'criadoEm', 'ultimaAtualizacao', 'srsAtivo', 'srsProximaRevisao', 'srsRepeticoes', 'srsUltimaResposta'];
            let csv = headers.join(',') + '\n';
            
            window.diario.entradas.forEach(e => {
                // Garantir que SRS est√° inicializado antes de exportar
                if (!e.srs) {
                    inicializarSrsEntrada(e);
                }
                
                const linha = [
                    e.id,
                    e.data,
                    `"${(e.area || '').replace(/"/g, '""')}"`,
                    `"${(e.tema || '').replace(/"/g, '""')}"`,
                    `"${(e.topico || '').replace(/"/g, '""')}"`,
                    `"${(e.resposta || '').replace(/"/g, '""')}"`,
                    e.atencao ? 'true' : 'false',
                    e.criadoEm || '',
                    e.ultimaAtualizacao || '',
                    e.srs ? (e.srs.ativo ? 'true' : 'false') : 'true',
                    e.srs ? (e.srs.proximaRevisao || '') : '',
                    e.srs ? (e.srs.repeticoes || 0) : 0,
                    e.srs ? (e.srs.ultimaResposta || '') : ''
                ];
                csv += linha.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DIARIO_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacaoFeedback('‚úÖ Di√°rio exportado!');
        }
        
        // ==================== INICIALIZA√á√ÉO ATUALIZADA ====================
        
        // Sobrescrever initApp para incluir novas renderiza√ß√µes (se existir)
        if (typeof initApp !== 'undefined') {
            const initAppOriginal = initApp;
            initApp = function() {
                initAppOriginal();
            
                // Renderizar novas abas se estiverem ativas
                setTimeout(() => {
                    if (document.getElementById('analyticsContainer')) {
                        renderAnalytics();
                    }
                    if (document.getElementById('ajudaContainer')) {
                        renderAjuda();
                    }
                    if (document.getElementById('cadernoAreasContainer')) {
                        renderCadernoV2();
                    }
                }, 500);
            };
        }
        
        // Atualizar build tag dinamicamente no header
        document.addEventListener('DOMContentLoaded', function() {
            const buildTagEl = document.getElementById('buildTag');
            if (buildTagEl) {
                // Build tag j√° est√° no HTML, apenas garantir que est√° vis√≠vel
                buildTagEl.textContent = '[build: 5e4b588]';
                buildTagEl.style.display = 'none'; // P1: Ocultar build tag
            }
        });
        
        // ========================================
        // RAW FASE 2 - Visualiza√ß√£o VRVS 3P
        // ========================================
        
        /**
         * Gera as estrelas baseado no est√°gio (0-5)
         * @param {number} estagio - Est√°gio atual (0-5)
         * @returns {string} String de estrelas
         */
        function gerarEstrelasVRVS(estagio) {
            const total = 5;
            const cheias = Math.min(Math.max(estagio || 0, 0), total);
            return '‚òÖ'.repeat(cheias) + '‚òÜ'.repeat(total - cheias);
        }
        
        /**
         * Calcula taxa de acerto do hist√≥rico de respostas
         * @param {Array} historicoRespostas - Array de respostas
         * @returns {Object|null} {taxa, acertos, total} ou null se vazio
         */
        function calcularTaxaAcertoVRVS(historicoRespostas) {
            if (!historicoRespostas || historicoRespostas.length === 0) {
                return null;
            }
            
            const acertos = historicoRespostas.filter(r => 
                r.resposta === 'lembrei' || r.resposta === 'facil'
            ).length;
            
            return {
                taxa: Math.round((acertos / historicoRespostas.length) * 100),
                acertos: acertos,
                total: historicoRespostas.length
            };
        }
        
        /**
         * Formata timestamp para data leg√≠vel
         * @param {number} timestamp - Timestamp em ms
         * @returns {string} Data formatada (DD/MM)
         */
        function formatarDataSRS(timestamp) {
            if (!timestamp) return '--';
            const d = new Date(timestamp);
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }
        
        /**
         * Gera o HTML do badge SRS para o card do Di√°rio
         * @param {Object} entrada - Entrada do di√°rio com srs
         * @returns {string} HTML do badge ou string vazia
         */
        function gerarBadgeSRS(entrada) {
            // S√≥ exibe se SRS est√° ativo
            if (!entrada.srs || !entrada.srs.ativo) {
                return '';
            }
            
            const estagio = entrada.srs.estagio || 0;
            const estrelas = gerarEstrelasVRVS(estagio);
            const taxaInfo = calcularTaxaAcertoVRVS(entrada.srs.historicoRespostas);
            
            let taxaTexto = '';
            if (taxaInfo) {
                taxaTexto = `<span class="srs-taxa">${taxaInfo.taxa}%</span>`;
            }
            
            // ESCAPE: entrada.id pode conter caracteres especiais
            const entradaIdEscapado = String(entrada.id || '').replace(/'/g, "\\'");
            
            return `
                <div class="srs-badge srs-estagio-${estagio}" 
                     onclick="if(event) event.stopPropagation(); abrirModalSRS('${entradaIdEscapado}')"
                     title="Clique para ver hist√≥rico">
                    <span class="srs-estrelas">${estrelas}</span>
                    ${taxaTexto}
                    <span class="srs-icone-detalhe">üìä</span>
                </div>
            `;
        }
        
        /**
         * Abre o modal com hist√≥rico detalhado da entrada
         * @param {string|number} entradaId - ID da entrada do di√°rio
         */
        function abrirModalSRS(entradaId) {
            try {
                // Buscar entrada no di√°rio (tolerar {entradas:[]} OU [] direto)
                const raw = localStorage.getItem(window.vrvs_diarioKey()) || '{"entradas":[]}';
                const parsed = JSON.parse(raw);
                const entradas = Array.isArray(parsed) ? parsed : (parsed.entradas || []);
                
                const entrada = entradas.find(e => String(e.id) === String(entradaId));
                
                if (!entrada || !entrada.srs) {
                    console.warn('Entrada n√£o encontrada ou sem SRS:', entradaId);
                    return;
                }
                
                const srs = entrada.srs;
                const estagio = srs.estagio || 0;
                const estrelas = gerarEstrelasVRVS(estagio);
                const taxaInfo = calcularTaxaAcertoVRVS(srs.historicoRespostas);
                
                // Construir HTML do resumo
                let resumoHTML = `
                    <div class="srs-resumo">
                        <div class="srs-resumo-item">
                            <div class="srs-resumo-label">Est√°gio</div>
                            <div class="srs-resumo-valor estrelas">${estrelas}</div>
                        </div>
                        <div class="srs-resumo-item">
                            <div class="srs-resumo-label">Taxa de Acerto</div>
                            <div class="srs-resumo-valor">${taxaInfo ? taxaInfo.taxa + '%' : '--'}</div>
                        </div>
                        <div class="srs-resumo-item">
                            <div class="srs-resumo-label">Revis√µes</div>
                            <div class="srs-resumo-valor">${taxaInfo ? taxaInfo.total : 0}</div>
                        </div>
                        <div class="srs-resumo-item">
                            <div class="srs-resumo-label">Facilidade</div>
                            <div class="srs-resumo-valor">${(srs.facilidade || 2.5).toFixed(2)}</div>
                        </div>
                        <div class="srs-resumo-item full-width">
                            <div class="srs-resumo-label">Pr√≥xima Revis√£o</div>
                            <div class="srs-resumo-valor">${srs.proximaRevisao || '--'}</div>
                        </div>
                    </div>
                `;
                
                // Construir HTML do hist√≥rico
                let historicoHTML = '';
                if (srs.historicoRespostas && srs.historicoRespostas.length > 0) {
                    // Ordenar por timestamp decrescente (mais recente primeiro)
                    const historicoOrdenado = [...srs.historicoRespostas].sort((a, b) => 
                        (b.timestamp || 0) - (a.timestamp || 0)
                    );
                    
                    // Limitar a 20 mais recentes na visualiza√ß√£o
                    const historicoLimitado = historicoOrdenado.slice(0, 20);
                    
                    historicoHTML = `
                        <div class="srs-historico-titulo">Hist√≥rico de Revis√µes</div>
                        <div class="srs-historico-lista">
                            ${historicoLimitado.map(h => {
                                const emoji = h.resposta === 'esqueci' ? '‚ùå' : 
                                              h.resposta === 'lembrei' ? 'üëç' : 'üòå';
                                const label = h.resposta === 'esqueci' ? 'Esqueci' : 
                                              h.resposta === 'lembrei' ? 'Lembrei' : 'F√°cil';
                                // ESCAPE: validar resposta antes de usar em classe CSS
                                const respostaClasse = (h.resposta === 'esqueci' || h.resposta === 'lembrei' || h.resposta === 'facil') 
                                    ? h.resposta 
                                    : 'esqueci';
                                return `
                                    <div class="srs-historico-item">
                                        <span class="srs-historico-data">${formatarDataSRS(h.timestamp)}</span>
                                        <span class="srs-historico-resposta ${respostaClasse}">${emoji} ${label}</span>
                                        <span class="srs-historico-transicao">‚≠ê${h.estagioAntes || 0}‚Üí${h.estagioDepois || 0}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${historicoOrdenado.length > 20 ? 
                            `<p style="text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 12px;">
                                Mostrando 20 de ${historicoOrdenado.length} revis√µes
                            </p>` : ''
                        }
                    `;
                } else {
                    historicoHTML = `
                        <div class="srs-historico-vazio">
                            Nenhuma revis√£o registrada ainda
                        </div>
                    `;
                }
                
                // Preencher e abrir modal
                document.getElementById('modalSRSBody').innerHTML = resumoHTML + historicoHTML;
                document.getElementById('modalHistoricoSRS').classList.add('active');
                
                // Prevenir scroll do body
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Erro ao abrir modal SRS:', error);
            }
        }
        
        /**
         * Fecha o modal de hist√≥rico SRS
         * @param {Event} event - Evento de clique (opcional)
         */
        function fecharModalSRS(event) {
            // Se clicou no overlay (fora do content), fecha
            if (event && event.target !== event.currentTarget) {
                return;
            }
            
            document.getElementById('modalHistoricoSRS').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modalHistoricoSRS');
                if (modal && modal.classList.contains('active')) {
                    fecharModalSRS();
                }
            }
        });
    </script>
    
    <!-- Modal Hist√≥rico SRS - RAW FASE 2 -->
    <div id="modalHistoricoSRS" class="modal-srs-overlay" onclick="if(event) event.stopPropagation(); fecharModalSRS(event)">
        <div class="modal-srs-content" onclick="if(event) event.stopPropagation()">
            <div class="modal-srs-header">
                <h3>üìä Desempenho VRVS 3P</h3>
                <button class="modal-srs-close" onclick="fecharModalSRS()">&times;</button>
            </div>
            <div class="modal-srs-body" id="modalSRSBody">
                <!-- Preenchido dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Console Visual para Debug no iPhone -->
    <div id="vrvsConsole" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); color: #0f0; font-family: 'Courier New', monospace; font-size: 11px; z-index: 99999; max-height: 50vh; overflow-y: auto; border-top: 2px solid #0f0; padding: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <strong style="color: #0f0;">üîç CONSOLE DEBUG</strong>
            <div>
                <button onclick="vrvsConsoleClear()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; margin-right: 5px; cursor: pointer; font-size: 10px;">Limpar</button>
                <button onclick="vrvsConsoleToggle()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; cursor: pointer; font-size: 10px;">Fechar</button>
            </div>
        </div>
        <div id="vrvsConsoleContent" style="line-height: 1.4;"></div>
    </div>
    
    <!-- Bot√£o Flutuante para Abrir Console -->
    <!-- S3P: Lupa verde oculta por padr√£o (pode ser reativada via localStorage.setItem('vrvs_debug_enabled', 'true')) -->
    <button id="vrvsConsoleBtn" onclick="vrvsConsoleToggle()" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: rgba(0,255,0,0.8); color: #000; border: 2px solid #0f0; font-size: 20px; cursor: pointer; z-index: 99998; box-shadow: 0 2px 10px rgba(0,255,0,0.5);">üîç</button>
    
    <script>
        // Console Visual - Interceptar logs e erros
        (function() {
            const consoleContent = document.getElementById('vrvsConsoleContent');
            const consolePanel = document.getElementById('vrvsConsole');
            const consoleBtn = document.getElementById('vrvsConsoleBtn');
            let logCount = 0;
            const MAX_LOGS = 200;
            
            // S3P: Verificar se debug est√° habilitado (via localStorage)
            const debugEnabled = localStorage.getItem('vrvs_debug_enabled') === 'true';
            
            function addLog(type, args, color) {
                if (!consoleContent || !debugEnabled) return;
                
                logCount++;
                if (logCount > MAX_LOGS) {
                    const firstLog = consoleContent.firstChild;
                    if (firstLog) firstLog.remove();
                }
                
                const time = new Date().toLocaleTimeString();
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch(e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                const logEl = document.createElement('div');
                logEl.style.color = color || '#0f0';
                logEl.style.marginBottom = '4px';
                logEl.style.wordBreak = 'break-word';
                logEl.innerHTML = `<span style="color: #666;">[${time}]</span> <span style="color: ${color || '#0f0'};">[${type}]</span> ${escapeHtml(message)}`;
                
                consoleContent.appendChild(logEl);
                consoleContent.scrollTop = consoleContent.scrollHeight;
                
                // S3P: Mostrar bot√£o se houver erros (apenas se debug estiver habilitado)
                if (consoleBtn && (type === 'ERROR' || type === 'WARN')) {
                    consoleBtn.style.display = 'block';
                    consoleBtn.style.background = 'rgba(255,0,0,0.8)';
                    consoleBtn.style.borderColor = '#f00';
                }
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // S3P: Mostrar bot√£o apenas se debug estiver habilitado
            if (debugEnabled && consoleBtn) {
                consoleBtn.style.display = 'block';
            }
            
            // Interceptar console.log
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (debugEnabled) addLog('LOG', args, '#0f0');
            };
            
            // Interceptar console.error
            const originalError = console.error;
            console.error = function(...args) {
                originalError.apply(console, args);
                if (debugEnabled) addLog('ERROR', args, '#f00');
            };
            
            // Interceptar console.warn
            const originalWarn = console.warn;
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (debugEnabled) addLog('WARN', args, '#ff0');
            };
            
            // Interceptar window errors
            window.addEventListener('error', function(e) {
                if (!debugEnabled) return;
                const errorMsg = e.message || String(e);
                const source = e.filename || e.sourceURL || '??';
                const line = e.lineno || e.line || '??';
                addLog('ERROR', [`${errorMsg} @ ${source}:${line}`], '#f00');
            });
            
            // Interceptar promise rejections
            window.addEventListener('unhandledrejection', function(e) {
                if (!debugEnabled) return;
                const reason = e.reason ? (e.reason.message || String(e.reason)) : 'Unknown';
                addLog('ERROR', [`Promise rejection: ${reason}`], '#f00');
            });
            
            // Fun√ß√£o para abrir/fechar console
            window.vrvsConsoleToggle = function() {
                if (!debugEnabled) {
                    alert('Debug n√£o est√° habilitado. Para ativar, execute no console:\nlocalStorage.setItem("vrvs_debug_enabled", "true");\nE recarregue a p√°gina.');
                    return;
                }
                if (consolePanel.style.display === 'none') {
                    consolePanel.style.display = 'block';
                    consoleBtn.textContent = '‚úï';
                } else {
                    consolePanel.style.display = 'none';
                    consoleBtn.textContent = 'üîç';
                }
            };
            
            // Fun√ß√£o para limpar console
            window.vrvsConsoleClear = function() {
                if (consoleContent) {
                    consoleContent.innerHTML = '';
                    logCount = 0;
                    if (consoleBtn) {
                        consoleBtn.style.background = 'rgba(0,255,0,0.8)';
                        consoleBtn.style.borderColor = '#0f0';
                    }
                }
            };
            
            // Log inicial apenas se debug estiver habilitado
            if (debugEnabled) {
                addLog('LOG', ['Console Debug ativado. Toque no bot√£o üîç para abrir/fechar.'], '#0f0');
            }
        })();
    </script>
</body>
</html>


