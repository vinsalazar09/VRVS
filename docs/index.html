<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#17121d">
    
    <!-- Favicon para MacBook e navegadores - m√∫ltiplos formatos e caminhos -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=3">
    <link rel="shortcut icon" href="./favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico?v=3" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="./logo.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="./logo.png?v=3">
    <link rel="icon" type="image/png" href="./logo.png?v=3">
    
    <!-- Apple Touch Icon para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="./logo.png?v=3">
    <link rel="apple-touch-icon" href="./logo.png?v=3">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VRVS">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üß† VRVS v5.1 ‚Äì Sistema de Gest√£o de Estudos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* CORES CIRCUIT TECH */
            --bg-dark: #0a1a1f;
            --bg-darker: #051015;
            
            /* TURQUESA TECH */
            --turquesa-neon: #00FFE0;
            --turquesa-light: #00CED1;
            --turquesa-main: #0d9488;
            --turquesa-dark: #0f766e;
            --turquesa-darker: #134e4a;
            
            /* √ÇMBAR COBRE TECH */
            --cobre-neon: #FFAA00;
            --cobre-light: #FFA366;
            --cobre-main: #FF7F50;
            --cobre-dark: #E55100;
            --cobre-darker: #B23A00;
            
            /* GLASSMORPHISM */
            --glass-bg: rgba(20, 35, 45, 0.4);
            --glass-border: rgba(255, 127, 80, 0.3);
            --text-light: rgba(255, 255, 255, 0.95);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-dark) !important;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* CIRCUIT BOARD BACKGROUND */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(13, 148, 136, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 127, 80, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 206, 209, 0.1) 0%, transparent 70%),
                var(--bg-dark);
            pointer-events: none;
            z-index: 1;
        }
        
        /* GRID CIRCUIT ANIMADO */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 206, 209, 0.15) 1px, transparent 1px),
                linear-gradient(rgba(255, 127, 80, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 127, 80, 0.05) 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 100px 100px, 100px 100px;
            pointer-events: none;
            z-index: 1;
            animation: gridPulse 6s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; transform: translate(0, 0); }
            50% { opacity: 0.6; transform: translate(-2px, -2px); }
        }
        
        .container {
            position: relative;
            z-index: 2;
            padding-bottom: 100px;
        }
        
        /* HEADER NEON TECH */
        .header {
            background: rgba(10, 26, 31, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 22px 20px;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, 
                var(--turquesa-main) 50%,
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            ) 1;
            animation: borderFlow 4s linear infinite;
        }
        
        @keyframes borderFlow {
            0% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 0%, var(--cobre-main) 25%, 
                var(--turquesa-main) 50%, var(--cobre-neon) 75%, var(--turquesa-neon) 100%); }
            100% { border-image-source: linear-gradient(90deg, 
                var(--turquesa-neon) 100%, var(--turquesa-neon) 0%, 
                var(--cobre-main) 25%, var(--turquesa-main) 50%, var(--cobre-neon) 75%); }
        }
        
        .header-title {
            background: linear-gradient(135deg, 
                var(--turquesa-neon) 0%, 
                var(--turquesa-light) 25%, 
                var(--cobre-light) 50%, 
                var(--cobre-neon) 75%,
                var(--turquesa-neon) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.5));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(255, 170, 0, 0.8));
                transform: scale(1.02);
            }
        }
        
        .header-subtitle {
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 206, 209, 0.7);
        }
        
        /* TABS GLASSMORPHISM - SEM SCROLL CORTADO */
        .tabs {
            display: flex;
            gap: 12px;
            padding: 20px 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(10, 26, 31, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--turquesa-light);
            border: 1px solid rgba(0, 206, 209, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .tab:hover {
            border-color: var(--cobre-main);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, 
                rgba(255, 127, 80, 0.2), 
                rgba(0, 206, 209, 0.2)
            );
            color: var(--cobre-light);
            border-color: var(--cobre-main);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.4),
                0 0 40px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* CONTENT SECTIONS */
        .content {
            padding: 20px 15px;
        }
        
        .section {
            display: none;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .section.active { display: block; }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        /* CARDS GLASSMORPHISM NEON - SEM HOVER MANCHADO */
        .card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(0, 206, 209, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .card-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 127, 80, 0.3);
        }
        
        /* FORM ELEMENTS NEON */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--turquesa-light);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(10, 26, 31, 0.6);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-light);
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--cobre-main);
            box-shadow: 
                0 0 20px rgba(255, 127, 80, 0.3),
                inset 0 0 20px rgba(255, 127, 80, 0.05);
            background: rgba(10, 26, 31, 0.8);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        /* BUTTONS NEON */
        .btn {
            width: 100%;
            background: linear-gradient(135deg, 
                var(--cobre-main) 0%, 
                var(--cobre-dark) 100%
            );
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(255, 127, 80, 0.4),
                0 0 30px rgba(255, 127, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 127, 80, 0.5),
                0 0 40px rgba(255, 127, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.3),
                rgba(0, 148, 136, 0.3)
            );
            box-shadow: 
                0 4px 15px rgba(0, 206, 209, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, 
                var(--cobre-dark) 0%, 
                var(--cobre-darker) 100%
            );
            margin-top: 12px;
        }
        
        .btn-small {
            width: auto;
            padding: 10px 16px;
            font-size: 11px;
        }
        
        .btn-edit {
            background: transparent;
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--turquesa-light);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-edit:hover {
            border-color: var(--cobre-main);
            color: var(--cobre-light);
            background: rgba(255, 127, 80, 0.1);
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 6px 10px;
            border-radius: 8px;
            color: #EF4444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #EF4444;
            transform: scale(1.1);
        }
        
        .btn-save-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 206, 209, 0.15);
            color: rgba(0, 206, 209, 0.8);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-save-floating:hover {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.25) 0%, rgba(0, 206, 209, 0.35) 100%);
            color: #00FFE0;
            border-color: rgba(0, 206, 209, 0.5);
            box-shadow: 0 4px 20px rgba(0, 206, 209, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-save-floating:active {
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.4) 0%, rgba(0, 206, 209, 0.5) 100%);
            color: #00FFE0;
            box-shadow: 0 6px 25px rgba(0, 206, 209, 0.5);
            transform: translateY(0) scale(0.98);
        }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.7),
                rgba(30, 50, 60, 0.5)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 127, 80, 0.1) 0%, 
                transparent 70%
            );
            animation: statPulse 4s ease-in-out infinite;
        }
        
        @keyframes statPulse {
            0%, 100% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(255, 127, 80, 0.5));
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(0, 206, 209, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* TASK ITEMS - CORES AJUSTADAS */
        .task-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item.priority-5 {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .task-item.priority-4 {
            border-color: var(--cobre-light);
            box-shadow: 0 0 20px rgba(255, 163, 102, 0.2);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .task-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--cobre-light);
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(255, 127, 80, 0.5);
        }
        
        .task-date {
            font-size: 11px;
            color: rgba(0, 206, 209, 0.7);
            font-weight: 600;
        }
        
        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .task-detail-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            padding: 4px 8px;
            background: rgba(0, 206, 209, 0.1);
            border-radius: 6px;
        }
        
        .task-tipo {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.2),
                rgba(13, 148, 136, 0.1)
            );
            color: var(--turquesa-light);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 10px;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .task-suggestion {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .task-suggestion::before {
            content: 'üí°';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            animation: lampadaBrilho 2s ease-in-out infinite;
        }
        
        @keyframes lampadaBrilho {
            0%, 100% { 
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 12px rgba(255, 255, 224, 0.6));
            }
            50% { 
                opacity: 0.9;
                filter: drop-shadow(0 0 12px rgba(255, 255, 0, 1)) drop-shadow(0 0 16px rgba(255, 255, 224, 0.8));
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .task-suggestion-label {
            color: var(--turquesa-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        .task-suggestion-text {
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
        }
        
        .campos-tempo {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 206, 209, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 206, 209, 0.2);
        }
        
        .campos-tempo.ativo {
            display: block;
        }
        
        .campo-tempo-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .campo-tempo-row:last-child {
            margin-bottom: 0;
        }
        
        .campo-tempo-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .campo-tempo-item label {
            font-size: 10px;
            color: rgba(0, 206, 209, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .campo-tempo-item input {
            padding: 6px 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 4px;
            color: var(--text-light);
        }
        
        .campo-tempo-item input:focus {
            outline: none;
            border-color: rgba(0, 206, 209, 0.6);
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0, 206, 209, 0.5);
            font-size: 15px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 20px rgba(0, 206, 209, 0.3));
        }
        
        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 13px;
        }
        
        .data-table th {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.1),
                rgba(13, 148, 136, 0.05)
            );
            color: var(--turquesa-light);
            padding: 12px 8px;
            font-weight: 700;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .data-table td {
            padding: 12px 8px;
            background: rgba(20, 35, 45, 0.3);
            border-top: 1px solid rgba(0, 206, 209, 0.1);
            border-bottom: 1px solid rgba(0, 206, 209, 0.1);
        }
        
        .data-table td:first-child {
            border-left: 1px solid rgba(0, 206, 209, 0.1);
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .data-table td:last-child {
            border-right: 1px solid rgba(0, 206, 209, 0.1);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .data-table tr:hover td {
            background: rgba(0, 206, 209, 0.05);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.1);
        }
        
        /* MESSAGES */
        #importMessage, #feedbackMessage {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
        }
        
        .message {
            background: linear-gradient(135deg,
                rgba(10, 26, 31, 0.95),
                rgba(20, 35, 45, 0.95)
            );
            backdrop-filter: blur(20px);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            animation: slideInMessage 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInMessage {
            from { 
                transform: translateX(120%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            border-left: 4px solid var(--turquesa-neon);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 206, 209, 0.3);
        }
        
        .message.error {
            border-left: 4px solid var(--cobre-main);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(255, 127, 80, 0.3);
        }
        
        /* NOTIFICATION ITEMS */
        .notification-item {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.6),
                rgba(30, 50, 60, 0.4)
            );
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-item.urgent {
            border-color: var(--cobre-main);
            background: linear-gradient(135deg,
                rgba(255, 127, 80, 0.1),
                rgba(229, 81, 0, 0.05)
            );
            box-shadow: 0 0 30px rgba(255, 127, 80, 0.2);
        }
        
        .notification-title {
            color: var(--cobre-light);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.5);
        }
        
        .notification-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        
        /* DATE RANGE CONTROLS */
        .date-range-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .date-range-controls .form-input {
            flex: 1;
        }
        
        /* EDIT DATE FORM */
        .edit-date-form {
            background: linear-gradient(135deg,
                rgba(0, 206, 209, 0.05),
                rgba(13, 148, 136, 0.02)
            );
            border: 1px solid rgba(0, 206, 209, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .edit-date-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .edit-date-row select {
            flex: 2;
        }
        
        .edit-date-row input {
            flex: 1;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg,
                rgba(20, 35, 45, 0.95),
                rgba(30, 50, 60, 0.95)
            );
            backdrop-filter: blur(20px);
            border: 1px solid var(--cobre-main);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlide {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            background: linear-gradient(135deg, 
                var(--turquesa-light) 0%, 
                var(--cobre-light) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            font-weight: 800;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--cobre-light);
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .modal-close:hover {
            transform: rotate(90deg);
        }
        
        /* SCROLL BAR CUSTOM */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                var(--turquesa-dark), 
                var(--cobre-dark)
            );
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                var(--turquesa-main), 
                var(--cobre-main)
            );
        }
        /* ==================== SPLASH SCREEN ==================== */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1a1f 0%, #051015 50%, #0a1a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }
        
        #splashScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        #splashScreen.hidden {
            display: none;
        }
        
        .splash-logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 224, 0.3));
            object-fit: contain;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--turquesa-neon);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 224, 0.5);
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .splash-subtitle {
            font-size: 14px;
            color: var(--turquesa-light);
            margin-bottom: 40px;
            opacity: 0.8;
        }
        
        .splash-loader {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .splash-loader::before,
        .splash-loader::after {
            content: '';
            position: absolute;
            border: 3px solid transparent;
            border-top-color: var(--turquesa-neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .splash-loader::before {
            width: 60px;
            height: 60px;
            animation-duration: 1s;
        }
        
        .splash-loader::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border-top-color: var(--cobre-light);
            animation-duration: 0.8s;
            animation-direction: reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .splash-progress {
            width: 200px;
            height: 3px;
            background: rgba(0, 206, 209, 0.2);
            border-radius: 10px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--turquesa-neon), var(--cobre-light));
            border-radius: 10px;
            width: 0%;
            animation: progressLoad 2s ease-out forwards;
            box-shadow: 0 0 10px rgba(0, 255, 224, 0.6);
        }
        
        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        body.splash-loading {
            overflow: hidden;
        }
    </style>
</head>
<body class="splash-loading">
    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <img src="./logo.png?v=3" alt="VRVS Logo" class="splash-logo" onerror="this.onerror=null; this.src='./logo.jpeg?v=3';">
        <div class="splash-title">VRVS</div>
        <div class="splash-subtitle">Sistema de Revis√£o e Performance</div>
        <div class="splash-loader"></div>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
    </div>
    
    <div id="importMessage"></div>
    <div id="feedbackMessage"></div>
    
    <!-- Bot√£o flutuante de salvar (sempre vis√≠vel) -->
    <button class="btn-save-floating" onclick="salvarDadosManualmente()" title="Salvar todos os dados">
        üíæ SALVAR
    </button>
    
    <!-- MODAL DE EDI√á√ÉO -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è EDITAR TEMA</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">√Årea</label>
                    <input type="text" class="form-input" id="editArea" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tema</label>
                    <input type="text" class="form-input" id="editTema" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-input" id="editPrioridade" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="Planejado">Planejado</option>
                        <option value="Em estudo">Em estudo</option>
                        <option value="Suspenso">Suspenso</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                </div>
                <button type="submit" class="btn">üíæ SALVAR ALTERA√á√ïES</button>
            </form>
        </div>
    </div>
    
    <!-- BOT√ÉO FLUTUANTE DE AJUDA -->
    <button id="btnAjudaFlutuante" onclick="showSection('tutorial')" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--turquesa-main), var(--turquesa-dark));
        border: 2px solid var(--turquesa-light);
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ‚ùì
    </button>
    
    <!-- MODAL TUTORIAL INTERATIVO -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="tutorialTitulo">üéØ Tour Guiado - VRVS</h2>
                <button class="modal-close" onclick="fecharTutorial()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="tutorialConteudo" style="min-height: 200px;">
                    <!-- Conte√∫do din√¢mico do tutorial -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-secondary" onclick="pularTutorial()">Pular Tutorial</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btnAnterior" onclick="tutorialAnterior()">‚óÄ Anterior</button>
                        <button class="btn" id="btnProximo" onclick="tutorialProximo()">Pr√≥ximo ‚ñ∂</button>
                    </div>
                </div>
                <div id="tutorialProgresso" style="margin-top: 15px; text-align: center; font-size: 12px; color: rgba(0,206,209,0.7);">
                    <!-- Passo X de Y -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL ENCERRAR SESS√ÉO -->
    <div id="encerrarSessaoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Resumo da Sess√£o</h2>
                <button class="modal-close" onclick="closeEncerrarSessaoModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,206,209,0.3);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo Total</div>
                            <div id="modalTempoTotal" style="font-size: 20px; font-weight: bold; color: #00FFE0;">00:00:00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Intervalos</div>
                            <div id="modalNumIntervalos" style="font-size: 20px; font-weight: bold; color: #00FFE0;">0</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è∏Ô∏è Tempo Total de Intervalos</div>
                        <div id="modalTempoIntervalos" style="font-size: 16px; font-weight: bold; color: #FFA366;">00:00:00</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">üìù Preencha os dados da sess√£o:</div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Tempo em Quest√µes (min)</label>
                        <input type="number" class="form-input" id="modalTempoQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">‚ùì Quantidade de Quest√µes</label>
                        <input type="number" class="form-input" id="modalQuantQuestoes" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">üÉè Tempo em Flashcards (min)</label>
                        <input type="number" class="form-input" id="modalTempoFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">üÉè Quantidade de Flashcards</label>
                        <input type="number" class="form-input" id="modalQuantFlashcards" min="0" placeholder="0" style="font-size: 14px;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="preencherDadosSessao()" style="flex: 1;">‚úÖ Preencher Formul√°rio</button>
                    <button class="btn btn-secondary" onclick="closeEncerrarSessaoModal()" style="flex: 1;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="header-title">üß† VRVS CIRCUIT TECH</div>
            <div class="header-subtitle">Sistema de Gest√£o de Estudos ‚Ä¢ v5.1</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showSection('dados')">üìä Dados</div>
            <div class="tab" onclick="showSection('cadastro')">‚ûï Cadastro</div>
            <div class="tab" onclick="showSection('feedback')">üìù Feedback</div>
            <div class="tab" onclick="showSection('tarefa')">üìã Tarefa</div>
            <div class="tab" onclick="showSection('agenda')">üìÖ Agenda</div>
            <div class="tab" onclick="showSection('pendencias')">üîî Pend√™ncias</div>
            <div class="tab" onclick="showSection('stats')">üìà Estat√≠sticas</div>
            <div class="tab" onclick="showSection('analises')">üîç An√°lises</div>
            <div class="tab" onclick="showSection('historico')">üìú Hist√≥rico</div>
            <div class="tab" onclick="showSection('lembretes')">üìå Lembretes</div>
            <div class="tab" onclick="showSection('caderno')">üìî Caderno</div>
            <div class="tab" onclick="showSection('relatorios')">üìä Relat√≥rios</div>
            <div class="tab" onclick="showSection('importar')">üì• Importar</div>
            <div class="tab" onclick="showSection('exportar')">üì§ Exportar</div>
            <div class="tab" onclick="showSection('tutorial')">‚ùì Tutorial</div>
        </div>
        
        <div class="content">
            <!-- DADOS -->
            <div id="dados" class="section active">
                <div class="card">
                    <div class="card-title">üìä BANCO DE DADOS</div>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="background: rgba(0, 206, 209, 0.15); color: rgba(0, 206, 209, 0.8); border: 1px solid rgba(0, 206, 209, 0.3); font-weight: 500;">
                            üíæ SALVAR DADOS AGORA
                        </button>
                        <div style="font-size: 11px; color: rgba(0,206,209,0.7);">
                            üí° Salva tudo automaticamente no navegador
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√Årea</th>
                                    <th>Tema</th>
                                    <th>Status</th>
                                    <th>Prior.</th>
                                    <th>Rend.</th>
                                    <th>Sess√µes</th>
                                    <th>√ölt.Estudo</th>
                                    <th>Agenda</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="dadosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- TAREFA -->
            <div id="tarefa" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìã MISS√ïES DO DIA</span>
                        <button class="btn btn-small" onclick="toggleCamposTempo()" style="font-size: 11px; padding: 6px 12px;">
                            <span id="toggleTempoText">‚è±Ô∏è Mostrar Tempos</span>
                        </button>
                    </div>
                    <div id="tarefasContainer"></div>
                </div>
            </div>
            
            <!-- AGENDA -->
            <div id="agenda" class="section">
                <div class="card">
                    <div class="card-title">üìÖ TIMELINE</div>
                    <div class="edit-date-row" style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="date" id="agendaDataInicio" class="form-input" style="flex: 1; max-width: 180px;">
                        <input type="date" id="agendaDataFim" class="form-input" style="flex: 1; max-width: 180px;">
                        <button class="btn btn-small" onclick="filtrarSemanaAtual()">üìÖ Semana Atual</button>
                        <button class="btn btn-small btn-secondary" onclick="renderAgenda()">Aplicar</button>
                    </div>
                    <div id="agendaContainer"></div>
                </div>
            </div>

            <!-- PEND√äNCIAS -->
            <div id="pendencias" class="section">
                <div class="card">
                    <div class="card-title">üîî ALERTAS DO SISTEMA</div>
                    <div id="pendenciasContainer"></div>
                </div>
            </div>
            
            <!-- CADASTRO -->
            <div id="cadastro" class="section">
                <div class="card">
                    <div class="card-title">‚ûï ADICIONAR TEMA</div>
                    <form id="cadastroForm">
                        <div class="form-group">
                            <label class="form-label">√Årea de Conhecimento</label>
                            <input type="text" class="form-input" id="novaArea" placeholder="Ex: Ombro e Cotovelo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tema Espec√≠fico</label>
                            <input type="text" class="form-input" id="novoTema" placeholder="Ex: Sd manguito rotador" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√≠vel de Prioridade</label>
                            <input type="number" class="form-input" id="novaPrioridade" min="1" max="5" value="3" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="novaStatus">
                                <option value="Planejado">Planejado</option>
                                <option value="Em estudo">Em estudo</option>
                                <option value="Suspenso">Suspenso</option>
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de In√≠cio</label>
                            <input type="date" class="form-input" id="novaDataInicio">
                        </div>
                        <button type="submit" class="btn">‚úÖ ADICIONAR TEMA</button>
                    </form>
                </div>
            </div>
            
            <!-- FEEDBACK -->
            <div id="feedback" class="section">
                <div class="card">
                    <div class="card-title">üìù REGISTRAR PERFORMANCE</div>
                    
                    <!-- CRON√îMETRO DA SESS√ÉO -->
                    <div id="cronometroContainer" style="margin-bottom: 20px; padding: 15px; background: rgba(0,206,209,0.1); border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 5px;">‚è±Ô∏è Tempo da Sess√£o</div>
                                <div id="cronometroDisplay" style="font-size: 28px; font-weight: bold; color: #00FFE0; font-family: 'Courier New', monospace;">00:00:00</div>
                                <div id="tempoIntervaloTotal" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                    ‚è∏Ô∏è Intervalo acumulado: <span id="tempoIntervaloTotalDisplay">00:00:00</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button id="cronometroToggle" class="btn btn-small" onclick="toggleCronometro()">‚è±Ô∏è Iniciar Cron√¥metro</button>
                                <button id="cronometroPausa" class="btn btn-small" onclick="pausarCronometro()">‚è∏Ô∏è Pausar</button>
                                <button id="cronometroIntervalo" class="btn btn-small" onclick="iniciarIntervalo()">‚è∏Ô∏è Intervalo</button>
                                <button id="cronometroReset" class="btn btn-small" onclick="resetCronometro()">üîÑ Resetar</button>
                                <button id="cronometroEncerrar" class="btn btn-small" onclick="encerrarSessao()" style="background: rgba(0,206,209,0.2); color: #00FFE0; border: 1px solid rgba(0,206,209,0.4);">‚úÖ Encerrar Sess√£o</button>
                            </div>
                            <div id="tempoIntervalo" style="font-size: 11px; color: rgba(255,165,0,0.7); margin-top: 5px; display: none;">
                                ‚è∏Ô∏è Em intervalo: <span id="tempoIntervaloDisplay">00:00:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label class="form-label">√Årea</label>
                            <select class="form-select" id="feedbackArea" onchange="updateFeedbackTemaSelect()">
                                <option value="">Selecione a √°rea...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√≥dulo Estudado</label>
                            <select class="form-select" id="feedbackTema" required>
                                <option value="">Selecione o m√≥dulo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data da Sess√£o</label>
                            <input type="date" class="form-input" id="feedbackData" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Performance (%)</label>
                            <input type="number" class="form-input" id="feedbackRendimento" min="0" max="100" placeholder="0-100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dura√ß√£o (min)</label>
                            <input type="number" class="form-input" id="feedbackTempo" min="0" placeholder="Minutos" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìä Intervalos (opcional)</label>
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                <input type="number" class="form-input" id="feedbackNumeroIntervalos" min="0" placeholder="N√∫mero de pausas" value="0">
                                <input type="text" class="form-input" id="feedbackIntervalos" placeholder="Ex: 00:05:00, 00:03:30" style="font-size: 12px;">
                            </div>
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Use o bot√£o "Encerrar Sess√£o" no cron√¥metro para preencher automaticamente
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‚ùì Quest√µes (opcional)</label>
                            <input type="text" class="form-input" id="feedbackQuestoes" placeholder="Ex: 15/20 (acertos/total)" pattern="[0-9]+/[0-9]+">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Formato: acertos/total (ex: 17/20)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üÉè Flashcards (opcional)</label>
                            <input type="number" class="form-input" id="feedbackFlashcards" min="0" placeholder="Quantidade revisada">
                            <div style="font-size: 11px; color: rgba(0,206,209,0.7); margin-top: 5px;">
                                üí° Quantidade de flashcards revisados na sess√£o
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diretriz Pr√≥xima Sess√£o</label>
                            <input type="text" class="form-input" id="feedbackSugestao" placeholder="Ex: Revisar flashcards + quest√µes">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Log da Sess√£o</label>
                            <textarea class="form-textarea" id="feedbackObs" placeholder="Ex: Q17/20 em 30min | FC8/10 em 15min"></textarea>
                        </div>
                        <button type="submit" class="btn">‚úÖ SALVAR PERFORMANCE</button>
                    </form>
                    <button class="btn btn-danger" onclick="desfazerUltimoFeedback()">‚Ü©Ô∏è DESFAZER √öLTIMO</button>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div id="stats" class="section">
                <div class="card">
                    <div class="card-title">üìä ANALYTICS</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTemas">0</div>
                            <div class="stat-label">M√≥dulos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSessoes">0</div>
                            <div class="stat-label">Sess√µes Totais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRendimento">0%</div>
                            <div class="stat-label">Performance M√©dia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTempo">0h</div>
                            <div class="stat-label">Tempo Investido</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statQuestoes">0</div>
                            <div class="stat-label">Quest√µes Resolvidas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statFlashcards">0</div>
                            <div class="stat-label">Flashcards Revisados</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìà VISUALIZA√á√ïES</div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartBarras" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartLinha" width="400" height="200"></canvas>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <canvas id="chartRadar" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- AN√ÅLISES DETALHADAS -->
            <div id="analises" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üîç AN√ÅLISES DETALHADAS</span>
                        <button class="btn btn-small" onclick="toggleAnalisesTempo()" style="font-size: 11px; padding: 6px 12px;">
                            <span id="toggleAnalisesTempoText">‚è±Ô∏è Mostrar An√°lises de Tempo</span>
                        </button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="analiseFiltroArea" onchange="atualizarSelectTemaAnalise(); atualizarAnalises();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="analiseFiltroTema" onchange="calcularAnalises()">
                                <option value="">Todos os temas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Per√≠odo</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="date" class="form-input" id="analiseDataInicio" onchange="atualizarAnalises()">
                                <input type="date" class="form-input" id="analiseDataFim" onchange="atualizarAnalises()">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-small" onclick="filtrarAnaliseSemanaAtual()">Semana Atual</button>
                                <button class="btn btn-small" onclick="filtrarAnaliseMesAtual()">M√™s Atual</button>
                                <button class="btn btn-small" onclick="limparFiltrosAnalise()">Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analiseResultados" style="margin-top: 30px;">
                        <!-- Resultados ser√£o renderizados aqui -->
                    </div>
                    
                    <div id="analiseTempo" style="display: none; margin-top: 30px;">
                        <!-- An√°lises de tempo ser√£o renderizadas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- HIST√ìRICO -->
            <div id="historico" class="section">
                <div class="card">
                    <div class="card-title">üìú REGISTRO COMPLETO</div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tema</th>
                                    <th>√Årea</th>
                                    <th>Rend.</th>
                                    <th>Tempo</th>
                                    <th>Observa√ß√µes</th>
                                    <th>Sugest√£o</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section">
                <div class="card">
                    <div class="card-title">üìä AN√ÅLISE POR PER√çODO</div>
                    <div class="date-range-controls">
                        <input type="date" class="form-input" id="relatorioDataInicio">
                        <input type="date" class="form-input" id="relatorioDataFim">
                        <button class="btn btn-small" onclick="gerarRelatorio()">Gerar</button>
                    </div>
                    <div id="relatorioResultado"></div>
                    <button class="btn btn-secondary" onclick="exportarRelatorioPeriodo()" style="display:none; margin-top: 20px;" id="btnExportarRelatorio">
                        üì• Exportar Per√≠odo
                    </button>
                </div>
            </div>
            
            <!-- IMPORTAR -->
            <div id="importar" class="section">
                <div class="card">
                    <div class="card-title">üì• IMPORTAR DADOS</div>
                    <div class="form-group">
                        <label class="form-label">Arquivo DADOS.csv</label>
                        <input type="file" class="form-input" id="importDados" accept=".csv">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Arquivo HISTORICO.csv</label>
                        <input type="file" class="form-input" id="importHistorico" accept=".csv">
                    </div>
                    <button class="btn" onclick="importarArquivos()">üì• PROCESSAR IMPORTA√á√ÉO</button>
                    <button class="btn btn-danger" onclick="limparTudo()">üóëÔ∏è RESET COMPLETO</button>
                </div>
            </div>
            
            <!-- EXPORTAR -->
            <div id="exportar" class="section">
                <div class="card">
                    <div class="card-title">üì§ BACKUP DE DADOS</div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="salvarDadosManualmente()" style="margin-bottom: 12px;">üíæ SALVAR DADOS AGORA</button>
                        <div style="font-size: 12px; color: rgba(0,206,209,0.7); margin-bottom: 20px;">
                            üí° Salva todos os dados no navegador (dados, hist√≥rico, lembretes, anota√ß√µes)
                        </div>
                    </div>
                    <div class="card-title" style="margin-top: 30px; margin-bottom: 15px; font-size: 14px;">üìä EXPORTAR PARA ARQUIVO</div>
                    <button class="btn btn-secondary" onclick="exportarDados()">üìä Baixar DADOS.csv</button>
                    <button class="btn btn-secondary" onclick="exportarHistorico()" style="margin-top: 12px;">üìú Baixar HISTORICO.csv</button>
                </div>
            </div>
            
            <!-- TUTORIAL E AJUDA -->
            <div id="tutorial" class="section">
                <div class="card">
                    <div class="card-title">‚ùì TUTORIAL E AJUDA</div>
                    
                    <!-- V√≠deo Tutorial -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìπ V√≠deo Explicativo</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2); text-align: center;">
                            <div id="videoTutorialContainer">
                                <div id="videoAnimado" style="background: linear-gradient(135deg, rgba(0,206,209,0.1), rgba(13,148,136,0.05)); border-radius: 8px; padding: 20px; min-height: 400px; position: relative; overflow: hidden;">
                                    <div id="videoSlide" style="text-align: center; padding: 20px;">
                                        <!-- Slides ser√£o inseridos aqui dinamicamente -->
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;">
                                        <button class="btn btn-small" onclick="videoAnterior()" id="btnVideoAnterior" style="font-size: 12px;">‚óÄ Anterior</button>
                                        <button class="btn btn-small" onclick="videoProximo()" id="btnVideoProximo" style="font-size: 12px;">Pr√≥ximo ‚ñ∂</button>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px; font-size: 12px; color: rgba(0,206,209,0.7);">
                                        <span id="videoProgresso">1 / 6</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tour Guiado -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üéØ Tour Guiado Interativo</h3>
                        <button class="btn" onclick="iniciarTutorial()">üöÄ Iniciar Tour da Plataforma</button>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                            Um guia passo a passo por todas as funcionalidades
                        </p>
                    </div>
                    
                    <!-- Assistente de D√∫vidas -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üí¨ Assistente de D√∫vidas</h3>
                        <div style="background: rgba(0,206,209,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.2);">
                            <input type="text" id="perguntaAssistente" class="form-input" placeholder="Digite sua d√∫vida aqui... Ex: Como adicionar um tema?" style="margin-bottom: 15px;">
                            <button class="btn btn-secondary" onclick="responderDuvida()">üîç Buscar Resposta</button>
                            <div id="respostaAssistente" style="margin-top: 20px; display: none;">
                                <div style="background: rgba(0,206,209,0.1); padding: 15px; border-radius: 6px; border-left: 3px solid var(--turquesa-light);">
                                    <div style="color: var(--turquesa-light); font-weight: bold; margin-bottom: 8px;">üí° Resposta:</div>
                                    <div id="textoResposta" style="color: var(--text-light); font-size: 14px; line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ R√°pido -->
                    <div>
                        <h3 style="color: var(--turquesa-light); font-size: 16px; margin-bottom: 15px;">üìö Perguntas Frequentes</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-small" onclick="mostrarResposta('adicionar')" style="text-align: left; justify-content: flex-start;">‚ùì Como adicionar um tema?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('feedback')" style="text-align: left; justify-content: flex-start;">‚ùì Como registrar uma sess√£o de estudos?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('agenda')" style="text-align: left; justify-content: flex-start;">‚ùì Como usar a agenda?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('stats')" style="text-align: left; justify-content: flex-start;">‚ùì Como ver minhas estat√≠sticas?</button>
                            <button class="btn btn-small" onclick="mostrarResposta('backup')" style="text-align: left; justify-content: flex-start;">‚ùì Como fazer backup dos dados?</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LEMBRETES -->
            <div id="lembretes" class="section">
                <div class="card">
                    <div class="card-title">üìå LEMBRETES E ANOTA√á√ïES</div>
                    <div style="margin-bottom: 20px;">
                        <form id="lembreteForm">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo do Lembrete</label>
                                <input type="text" class="form-input" id="lembreteTitulo" placeholder="Ex: Revisar vias de acesso do cotovelo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descri√ß√£o (opcional)</label>
                                <textarea class="form-input" id="lembreteDescricao" rows="3" placeholder="Detalhes adicionais..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Periodicidade</label>
                                <select class="form-select" id="lembretePeriodicidade" required>
                                    <option value="pontual">Pontual (apenas uma vez)</option>
                                    <option value="diaria">Di√°ria</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="quinzenal">Quinzenal (15 dias)</option>
                                    <option value="mensal">Mensal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vincular ao Tema (opcional)</label>
                                <select class="form-select" id="lembreteTemaId">
                                    <option value="">Nenhum (lembrete geral)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Inicial</label>
                                <input type="date" class="form-input" id="lembreteDataInicial" required>
                            </div>
                            <button type="submit" class="btn">‚ûï Adicionar Lembrete</button>
                        </form>
                    </div>
                    <div id="lembretesContainer"></div>
                </div>
            </div>
            
            <!-- CADERNO -->
            <div id="caderno" class="section">
                <div class="card">
                    <div class="card-title">üìî CADERNO DE ANOTA√á√ïES</div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Filtrar por √Årea</label>
                            <select class="form-select" id="cadernoFiltroArea" onchange="atualizarSelectTemaPorArea(); filtrarCaderno();">
                                <option value="">Todas as √°reas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filtrar por Tema</label>
                            <select class="form-select" id="cadernoFiltroTema" onchange="filtrarCaderno()" disabled>
                                <option value="">Selecione uma √°rea primeiro</option>
                            </select>
                        </div>
                    </div>
                    <div id="cadernoContainer"></div>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== DADOS E INICIALIZA√á√ÉO ====================
        // Fun√ß√£o para corrigir invers√£o √°rea‚Üîtema ANTES de carregar dados
        function fixAreaTemaObjeto(obj) {
            if (!obj) return obj;
            const area = String(obj.area || '');
            const tema = String(obj.tema || '');
            // Se √°rea est√° muito longa (>20) E tema cont√©m palavra-chave de √°rea, inverter
            const areaLikeKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'mao', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'pe', 'tornozelo', 'coluna', 'oncologia', 'tumores', 'mmss', 'mmii'];
            const temaPareceArea = areaLikeKeywords.some(k => tema.toLowerCase().includes(k));
            if (area.length > 20 && temaPareceArea) {
                const tmp = obj.area;
                obj.area = obj.tema;
                obj.tema = tmp;
            }
            return obj;
        }
        
        let dados = JSON.parse(localStorage.getItem('vrvs_dados') || '[]');
        let historico = JSON.parse(localStorage.getItem('vrvs_historico') || '[]');
        let lembretes = JSON.parse(localStorage.getItem('vrvs_lembretes') || '[]');
        let anotacoes = JSON.parse(localStorage.getItem('vrvs_anotacoes') || '[]'); // Anota√ß√µes por tema
        
        // Aplicar corre√ß√£o de invers√£o √°rea/tema nos dados carregados
        if (Array.isArray(dados)) {
            dados = dados.map(d => fixAreaTemaObjeto(d));
        }
        
        // Limpar dados corrompidos
        function limparDadosCorretos() {
            const dadosOriginais = dados.length;
            dados = dados.filter(t => {
                if (!t.area || t.area.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.area && t.area.toLowerCase().includes('sugest')) return false;
                if (!t.tema || t.tema.toLowerCase().includes('revisao ativa') || t.tema.toLowerCase().includes('revis√£o ativa')) return false;
                if (t.tema.length > 100) return false;
                if (t.tema.match(/^\d{4}-\d{2}-\d{2}/)) return false;
                if (t.tema.includes('Sugest√£o:') || t.tema.includes('sugest√£o:')) return false;
                if ((t.tema.match(/\|/g) || []).length > 2) return false;
                return true;
            });
            
            if (dados.length < dadosOriginais) {
                console.log(`üßπ Limpeza: removidos ${dadosOriginais - dados.length} registros corrompidos`);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            }
        }
        
        limparDadosCorretos();
        
        // Fun√ß√£o para limpar hist√≥rico inv√°lido (usada na inicializa√ß√£o e ap√≥s importa√ß√£o)
        function limparHistoricoInvalido() {
            const historicoOriginal = historico.length;
            
            historico = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historico.length < historicoOriginal) {
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                console.log(`üßπ Limpeza: removidos ${historicoOriginal - historico.length} registros inv√°lidos do hist√≥rico`);
            }
        }
        
        limparHistoricoInvalido(); // Limpar hist√≥rico inv√°lido na inicializa√ß√£o
        
        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function mostrarNotificacaoFeedback(mensagem, tipo = 'success') {
            const container = document.getElementById('feedbackMessage');
            container.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function extrairUltimaSugestao(observacoes) {
            if (!observacoes) return '';
            const linhas = observacoes.split('\n');
            for (let i = linhas.length - 1; i >= 0; i--) {
                const linha = linhas[i];
                if (linha.includes('Sugest√£o:') || linha.includes('sugest√£o:')) {
                    const partes = linha.split(/[Ss]ugest√£o:/);
                    if (partes.length > 1) {
                        return partes[1].trim().replace(/^\|/, '').replace(/\|$/, '').trim();
                    }
                }
            }
            return '';
        }
        
        function obterSugestaoTema(tema) {
            if (!tema) return '';
            if (tema.sugestao && tema.sugestao !== '-' && tema.sugestao.trim() !== '') {
                return tema.sugestao.trim();
            }
            return extrairUltimaSugestao(tema.observacoes);
        }

        function calcularTipoRevisao(tema) {
            const rend = tema.rendimento || 0;
            const sess = tema.sessoes || 0;
            
            if (sess === 0) return 'üÜï Primeira sess√£o';
            if (sess === 1) return '‚ö° Quest√µes/flashcards';
            if (rend < 0.50) return 'üìö Revisar teoria completa';
            if (rend < 0.60) return 'üìπ Aula + quest√µes';
            if (rend < 0.80) return 'üìñ Resumo + quest√µes';
            return '‚ö° Quest√µes/flashcards';
        }
        
        function normalizeArea(rawArea, tema) {
            if (!rawArea && !tema) return '';
            let area = String(rawArea || '').trim().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            const areaMap = {
                'trauma mmss': 'Trauma MMSS',
                'trauma membros superiores': 'Trauma MMSS',
                'trauma mmii': 'Trauma MMII',
                'trauma membros inferiores': 'Trauma MMII',
                'ombro e cotovelo': 'Ombro e Cotovelo',
                'ombro': 'Ombro e Cotovelo',
                'cotovelo': 'Ombro e Cotovelo',
                'mao': 'M√£o',
                'punho': 'M√£o',
                'joelho': 'Joelho',
                'quadril': 'Quadril',
                'pelve': 'Quadril',
                'pe e tornozelo': 'P√© e Tornozelo',
                'tornozelo': 'P√© e Tornozelo',
                'coluna': 'Coluna',
                'oncologia': 'Oncologia',
                'tumores': 'Oncologia'
            };
            
            if (areaMap[area]) return areaMap[area];
            return area.replace(/\b\w/g, m => m.toUpperCase());
        }
        
        function fixAreaTema(area, tema) {
            if (!area || !tema) return { area: area || '', tema: tema || '' };
            
            // Verificar se √°rea e tema est√£o invertidos
            // Se o "tema" parece ser uma √°rea (cont√©m palavras-chave de √°rea)
            const areaKeywords = ['trauma', 'ombro', 'cotovelo', 'm√£o', 'punho', 'joelho', 'quadril', 'pelve', 'p√©', 'tornozelo', 'coluna', 'oncologia', 'tumores'];
            const temaLower = String(tema).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Se tema cont√©m palavras-chave de √°rea e √°rea n√£o, provavelmente est√£o invertidos
            const temaEhArea = areaKeywords.some(keyword => temaLower.includes(keyword));
            const areaEhArea = areaKeywords.some(keyword => String(area).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(keyword));
            
            if (temaEhArea && !areaEhArea) {
                // Est√£o invertidos, trocar
                return { area: normalizeArea(tema, ''), tema: area };
            }
            
            return { area: normalizeArea(area, tema), tema: tema };
        }
        
        function dataValida(data) {
            if (!data || data === '-' || String(data).trim() === '') return false;
            try {
                const dt = new Date(data + 'T00:00:00');
                return !isNaN(dt.getTime());
            } catch (e) {
                return false;
            }
        }
        
        function formatarDataBR(data) {
            if (!dataValida(data)) return '-';
            try {
                return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            } catch (e) {
                return '-';
            }
        }
        
        function formatarData(dataStr) {
            // Mantida para compatibilidade - usa formatarDataBR internamente
            return formatarDataBR(dataStr);
        }
        
        function calcularProximaRevisao(tema, dataSessao = null) {
            // CORRE√á√ÉO: Conclu√≠do n√£o entra no algoritmo - retornar vazio
            if (tema.status === 'Conclu√≠do') {
                return '';
            }
            
            // CORRE√á√ÉO: Usar data da sess√£o se fornecida, sen√£o usar data atual
            const dataBase = dataSessao ? new Date(dataSessao + 'T00:00:00') : new Date();
            dataBase.setHours(0, 0, 0, 0);
            
            // CORRE√á√ÉO CR√çTICA: Se √© PRIMEIRA sess√£o (contador = 1 OU √∫ltima data = null), sempre +1 dia
            const sessoes = tema.sessoes || 0;
            const ultEstudo = tema.ultEstudo || null;
            
            if (sessoes === 0 || sessoes === 1 || !ultEstudo || ultEstudo === null || ultEstudo === '') {
                const proxima = new Date(dataBase);
                proxima.setDate(proxima.getDate() + 1);
                return proxima.toISOString().split('T')[0];
            }
            
            // SOMENTE ap√≥s segunda sess√£o em diante: aplicar algoritmo normal
            const rendimento = Math.round((tema.rendimento || 0) * 100);
            const prioridade = parseInt(tema.prioridade) || 3;
            const contador80 = parseInt(tema.contador80) || 0;
            let intervalo = 1;
            
            if (rendimento < 50) {
                intervalo = 1;
            } else if (rendimento >= 50 && rendimento < 80) {
                intervalo = 3;
            } else {
                if (contador80 === 0) intervalo = 7;
                else if (contador80 === 1) intervalo = 14;
                else if (contador80 === 2) intervalo = 30;
                else intervalo = 60;
                
                if (prioridade === 5 && intervalo > 30) {
                    intervalo = 30;
                }
            }
            
            const proxima = new Date(dataBase);
            proxima.setDate(proxima.getDate() + intervalo);
            return proxima.toISOString().split('T')[0];
        }

        // ==================== MODAL DE EDI√á√ÉO ====================
        
        function openEditModal(id) {
            const tema = dados.find(t => t.id == id);
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            document.getElementById('editId').value = tema.id;
            document.getElementById('editArea').value = tema.area;
            document.getElementById('editTema').value = tema.tema;
            document.getElementById('editPrioridade').value = tema.prioridade || 3;
            document.getElementById('editStatus').value = tema.status || 'Planejado';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ==================== RENDERIZA√á√ÉO DE COMPONENTES ====================
        
        function renderPendencias() {
            const hoje = new Date().toISOString().split('T')[0];
            const container = document.getElementById('pendenciasContainer');
            const notificacoes = [];
            
            const atrasadas = dados.filter(t => {
                if (!t.agenda || t.status === 'Conclu√≠do') return false;
                const diasAtraso = Math.floor((new Date(hoje) - new Date(t.agenda)) / (1000 * 60 * 60 * 24));
                return diasAtraso > 7;
            });
            
            if (atrasadas.length > 0) {
                notificacoes.push({
                    tipo: 'urgent',
                    titulo: `‚ö†Ô∏è ${atrasadas.length} m√≥dulos em atraso cr√≠tico`,
                    texto: atrasadas.map(t => `‚Ä¢ ${t.tema} (${Math.floor((new Date(hoje) - new Date(t.agenda)) / (1000 * 60 * 60 * 24))} dias)`).join('\n')
                });
            }
            
            const planejados = dados.filter(t => t.status === 'Planejado' && t.sessoes === 0);
            if (planejados.length > 0) {
                notificacoes.push({
                    tipo: 'normal',
                    titulo: `üìã ${planejados.length} m√≥dulos aguardando inicializa√ß√£o`,
                    texto: planejados.map(t => `‚Ä¢ ${t.tema}`).join('\n')
                });
            }
            
            const semData = historico.filter(h => !h.data || h.data === '-').length;
            if (semData > 0) {
                notificacoes.push({
                    tipo: 'normal',
                    titulo: `üìÖ ${semData} registros sem timestamp`,
                    texto: 'Acesse Hist√≥rico para corrigir datas'
                });
            }
            
            if (notificacoes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Sistema operacional</div></div>';
                return;
            }
            
            container.innerHTML = notificacoes.map(n => `
                <div class="notification-item ${n.tipo}">
                    <div class="notification-title">${n.titulo}</div>
                    <div class="notification-text" style="white-space: pre-line;">${n.texto}</div>
                </div>
            `).join('');
        }
        
        // Vari√°vel global para controlar visibilidade dos campos de tempo
        window.camposTempoVisiveis = false;
        
        function toggleCamposTempo() {
            window.camposTempoVisiveis = !window.camposTempoVisiveis;
            const toggleText = document.getElementById('toggleTempoText');
            if (toggleText) {
                toggleText.textContent = window.camposTempoVisiveis ? '‚è±Ô∏è Ocultar Tempos' : '‚è±Ô∏è Mostrar Tempos';
            }
            renderTarefas();
            renderAgenda();
        }
        
        function renderTarefas() {
            const hoje = new Date().toISOString().split('T')[0];
            
            const tarefas = dados.filter(t => {
                if (!t.agenda || !t.tema) return false;
                if (t.status !== 'Em estudo' && t.status !== 'Planejado') return false;
                if (!dataValida(t.agenda)) return false;
                return t.agenda <= hoje;
            });
            
            const container = document.getElementById('tarefasContainer');
            if (tarefas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma miss√£o pendente</div></div>';
                return;
            }
            
            tarefas.sort((a, b) => {
                if (a.agenda !== b.agenda) return a.agenda.localeCompare(b.agenda);
                return (b.prioridade || 0) - (a.prioridade || 0);
            });
            
            container.innerHTML = tarefas.map((t, index) => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const tipo = calcularTipoRevisao(t);
                const isHoje = t.agenda === hoje;
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-name">${t.tema} ${isHoje ? 'üéØ' : ''}</div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                        <div class="task-detail-item">üìÖ ${formatarDataBR(t.agenda)}</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderAgenda() {
            const hoje = new Date().toISOString().split('T')[0];
            
            // Per√≠odo: inputs ou default pr√≥ximos 7 dias
            const inputInicio = document.getElementById('agendaDataInicio');
            const inputFim = document.getElementById('agendaDataFim');
            let dataInicio = inputInicio && inputInicio.value ? inputInicio.value : '';
            let dataFim = inputFim && inputFim.value ? inputFim.value : '';
            
            if (!dataInicio || !dataFim) {
                const base = new Date();
                const start = new Date(base);
                const end = new Date(base);
                end.setDate(end.getDate() + 7);
                dataInicio = start.toISOString().split('T')[0];
                dataFim = end.toISOString().split('T')[0];
                if (inputInicio && !inputInicio.value) inputInicio.value = dataInicio;
                if (inputFim && !inputFim.value) inputFim.value = dataFim;
            }
            
            const agendadas = dados
                .filter(t => {
                    if (!t || !t.agenda || t.status === 'Conclu√≠do') return false;
                    if (!dataValida(t.agenda) || !dataValida(dataInicio) || !dataValida(dataFim)) return false;
                    return t.agenda >= dataInicio && t.agenda <= dataFim;
                })
                .sort((a, b) => a.agenda.localeCompare(b.agenda));
            
            const container = document.getElementById('agendaContainer');
            if (agendadas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div>Timeline vazia</div></div>';
                return;
            }
            
            container.innerHTML = agendadas.map(t => {
                const sugestao = obterSugestaoTema(t);
                const rendPct = Math.round((t.rendimento || 0) * 100);
                const rendColor = rendPct >= 80 ? '#00FFE0' : rendPct >= 50 ? '#FFA366' : '#EF4444';
                const dataFormatada = formatarDataBR(t.agenda);
                const tipo = calcularTipoRevisao(t);
                const camposTempoAtivo = window.camposTempoVisiveis || false;
                
                return `
                <div class="task-item priority-${t.prioridade || 3}">
                    <div class="task-header">
                        <div class="task-name">${t.tema}</div>
                        <div class="task-date">üìÖ ${dataFormatada}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail-item">üìö ${t.area}</div>
                        <div class="task-detail-item">‚≠ê Prior: ${t.prioridade || 3}</div>
                        <div class="task-detail-item" style="color: ${rendColor};">üìä ${rendPct}%</div>
                        <div class="task-detail-item">üì¢ ${t.sessoes || 0} sess√µes</div>
                    </div>
                    
                    ${tipo ? `<div class="task-tipo">${tipo}</div>` : ''}
                    
                    ${sugestao ? `
                    <div class="task-suggestion">
                        <div class="task-suggestion-label">Diretriz</div>
                        <div class="task-suggestion-text">${sugestao}</div>
                    </div>
                    ` : ''}
                    
                    <div class="campos-tempo ${camposTempoAtivo ? 'ativo' : ''}" data-tema-id="${t.id}">
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>‚ùì Tempo Quest√µes (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-questoes" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>‚ùì Qtd Quest√µes</label>
                                <input type="number" min="0" placeholder="0" class="quant-questoes" data-id="${t.id}">
                            </div>
                        </div>
                        <div class="campo-tempo-row">
                            <div class="campo-tempo-item">
                                <label>üÉè Tempo Flashcards (min)</label>
                                <input type="number" min="0" placeholder="0" class="tempo-flashcards" data-id="${t.id}">
                            </div>
                            <div class="campo-tempo-item">
                                <label>üÉè Qtd Flashcards</label>
                                <input type="number" min="0" placeholder="0" class="quant-flashcards" data-id="${t.id}">
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function filtrarSemanaAtual() {
            const hoje = new Date();
            const diaSemana = hoje.getDay(); // 0=Dom, 1=Seg, ...
            const segunda = new Date(hoje);
            const domingo = new Date(hoje);
            const offsetSeg = (diaSemana === 0 ? -6 : 1 - diaSemana);
            segunda.setDate(hoje.getDate() + offsetSeg);
            domingo.setDate(segunda.getDate() + 6);
            
            document.getElementById('agendaDataInicio').value = segunda.toISOString().split('T')[0];
            document.getElementById('agendaDataFim').value = domingo.toISOString().split('T')[0];
            renderAgenda();
        }
        
        function renderDados() {
            const tbody = document.getElementById('dadosTableBody');
            tbody.innerHTML = dados.map(t => {
                const ultEstudo = formatarDataBR(t.ultEstudo);
                const agenda = formatarDataBR(t.agenda);
                const rend = t.rendimento ? Math.round(t.rendimento * 100) + '%' : '-';
                const rendColor = t.rendimento >= 0.8 ? '#00FFE0' : t.rendimento >= 0.5 ? '#FFA366' : '#EF4444';
                
                return `
                    <tr>
                        <td style="color: rgba(0,206,209,0.8);">${t.area || '-'}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${t.tema || '-'}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.status || 'N√£o iniciado'}</td>
                        <td style="text-align: center; color: var(--cobre-main);">${t.prioridade || 3}</td>
                        <td style="text-align: center; color: ${rendColor};">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${t.sessoes || 0}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${ultEstudo}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">${agenda}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit" onclick="openEditModal(${t.id})" title="Editar">üîß</button>
                            <button class="btn-delete" onclick="deletarTema(${t.id})" title="Excluir tema permanentemente">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateFeedbackSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            
            // Obter √°reas √∫nicas
            const areas = [...new Set(dados.map(t => t.area).filter(a => a && a.trim()))].sort();
            areaSelect.innerHTML = '<option value="">Selecione a √°rea...</option>' +
                areas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Atualizar temas baseado na √°rea selecionada
            updateFeedbackTemaSelect();
        }
        
        function updateFeedbackTemaSelect() {
            const areaSelect = document.getElementById('feedbackArea');
            const temaSelect = document.getElementById('feedbackTema');
            const areaSelecionada = areaSelect.value;
            
            temaSelect.innerHTML = '<option value="">Selecione o m√≥dulo...</option>';
            
            if (!areaSelecionada) {
                // Se nenhuma √°rea selecionada, mostrar todos os temas
                temaSelect.innerHTML += dados.map(t => `<option value="${t.id}">${t.tema} (${t.area})</option>`).join('');
            } else {
                // Filtrar temas pela √°rea selecionada
                const temasFiltrados = dados.filter(t => t.area === areaSelecionada);
                temaSelect.innerHTML += temasFiltrados.map(t => `<option value="${t.id}">${t.tema}</option>`).join('');
            }
        }
        
        function deletarTema(temaId) {
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                return;
            }
            
            // Confirmar exclus√£o
            const confirmacao = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO: Excluir tema "${tema.tema}"?\n\n` +
                `Isso ir√° REMOVER PERMANENTEMENTE:\n` +
                `‚Ä¢ O tema dos dados\n` +
                `‚Ä¢ Todo o hist√≥rico relacionado\n` +
                `‚Ä¢ Lembretes vinculados\n` +
                `‚Ä¢ Anota√ß√µes do caderno\n\n` +
                `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
                `Confirmar exclus√£o?`
            );
            
            if (!confirmacao) return;
            
            // Contar quantos registros ser√£o removidos
            const historicoRelacionado = historico.filter(h => String(h.temaId) === String(temaId));
            const lembretesRelacionados = lembretes.filter(l => String(l.temaId) === String(temaId));
            const anotacoesRelacionadas = anotacoes.filter(a => String(a.temaId) === String(temaId));
            
            // Remover tema dos dados
            dados = dados.filter(t => String(t.id) !== String(temaId));
            
            // Remover hist√≥rico relacionado
            historico = historico.filter(h => String(h.temaId) !== String(temaId));
            
            // Remover lembretes relacionados
            lembretes = lembretes.filter(l => String(l.temaId) !== String(temaId));
            
            // Remover anota√ß√µes relacionadas
            anotacoes = anotacoes.filter(a => String(a.temaId) !== String(temaId));
            
            // Salvar tudo no localStorage
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            
            // Mostrar resumo do que foi removido
            const resumo = [
                `‚úÖ Tema removido`,
                historicoRelacionado.length > 0 ? `${historicoRelacionado.length} registro(s) de hist√≥rico` : '',
                lembretesRelacionados.length > 0 ? `${lembretesRelacionados.length} lembrete(s)` : '',
                anotacoesRelacionadas.length > 0 ? `${anotacoesRelacionadas.length} anota√ß√£o(√µes)` : ''
            ].filter(r => r).join('\n');
            
            mostrarNotificacaoFeedback(resumo);
            
            // Atualizar todas as visualiza√ß√µes
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            renderLembretes();
            renderCaderno();
        }
        
        function desfazerUltimoFeedback() {
            if (historico.length === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Nenhum feedback para desfazer!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Confirma revers√£o do √∫ltimo registro?')) {
                return;
            }
            
            const ultimaSessao = historico[historico.length - 1];
            
            // CORRE√á√ÉO: Buscar tema comparando IDs como strings
            const tema = dados.find(t => String(t.id) === String(ultimaSessao.temaId));
            
            if (!tema) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado!', 'error');
                return;
            }
            
            historico.pop();
            tema.sessoes = Math.max(0, (tema.sessoes || 1) - 1);
            tema.tempo = Math.max(0, (tema.tempo || 0) - (ultimaSessao.tempo || 0));
            
            const sessoesRestantes = historico.filter(h => String(h.temaId) === String(tema.id));
            
            if (sessoesRestantes.length > 0) {
                const somaRend = sessoesRestantes.reduce((sum, h) => sum + (h.rendimento || 0), 0);
                tema.rendimento = somaRend / sessoesRestantes.length;
                
                // Recalcular contador80
                let contador = 0;
                for (let i = sessoesRestantes.length - 1; i >= 0; i--) {
                    if ((sessoesRestantes[i].rendimento || 0) >= 0.8) {
                        contador++;
                    } else {
                        break;
                    }
                }
                tema.contador80 = contador;
                
                // Atualizar √∫ltima data e agenda
                const ultimaSessaoRestante = sessoesRestantes[sessoesRestantes.length - 1];
                tema.ultEstudo = ultimaSessaoRestante ? ultimaSessaoRestante.data : '';
                tema.agenda = calcularProximaRevisao(tema);
            } else {
                tema.rendimento = 0;
                tema.status = 'Planejado';
                tema.ultEstudo = '';
                tema.agenda = '';
                tema.contador80 = 0;
            }
            
            localStorage.setItem('vrvs_dados', JSON.stringify(dados));
            localStorage.setItem('vrvs_historico', JSON.stringify(historico));
            
            mostrarNotificacaoFeedback('‚úÖ Revers√£o executada com sucesso!');
            
            renderTarefas();
            renderAgenda();
            renderDados();
            renderHistorico();
            updateStats();
            renderPendencias();
        }

        function renderHistorico() {
            const tbody = document.getElementById('historicoTableBody');
            
            // CORRE√á√ÉO: Filtrar hist√≥rico inv√°lido (√°rea "Tema" e linhas sem dados v√°lidos)
            const historicoFiltrado = historico.filter(h => {
                // Remover linhas sem √°rea ou tema
                if (!h.area || !h.tema) return false;
                
                // CORRE√á√ÉO: Filtrar √°rea "Tema" que √© erro de importa√ß√£o
                if (h.area.toLowerCase() === 'tema' || h.tema.toLowerCase() === 'area') return false;
                
                // Aplicar fixAreaTema para verificar se ainda √© inv√°lido ap√≥s corre√ß√£o
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                if (!areaCorrigida || areaCorrigida.toLowerCase() === 'tema') return false;
                if (!temaCorrigido || temaCorrigido.toLowerCase() === 'area') return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: rgba(0,206,209,0.5);">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            const historicoOrdenado = [...historicoFiltrado].sort((a, b) => {
                if (!a.data || a.data === '-') return 1;
                if (!b.data || b.data === '-') return -1;
                return new Date(b.data) - new Date(a.data);
            });
            
            tbody.innerHTML = historicoOrdenado.map(h => {
                // CORRE√á√ÉO: Aplicar fixAreaTema para corrigir invers√µes
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(h.area, h.tema);
                
                const data = formatarDataBR(h.data);
                const rend = h.rendimento ? Math.round(h.rendimento * 100) + '%' : '-';
                const tempo = h.tempo ? h.tempo + ' min' : '-';
                let rendColor = '#9CA3AF';
                if (h.rendimento >= 0.8) rendColor = '#00FFE0';
                else if (h.rendimento >= 0.5) rendColor = '#FFA366';
                else if (h.rendimento > 0) rendColor = '#EF4444';
                
                return `
                    <tr>
                        <td style="color: ${!h.data || h.data === '-' ? '#EF4444' : 'rgba(0,206,209,0.6)'}; font-size: 11px;">${data}</td>
                        <td style="color: var(--cobre-light); font-weight: 600;">${temaCorrigido || '-'}</td>
                        <td style="color: rgba(0,206,209,0.8);">${areaCorrigida || '-'}</td>
                        <td style="text-align: center; color: ${rendColor}; font-weight: 600;">${rend}</td>
                        <td style="text-align: center; color: rgba(255,255,255,0.7);">${tempo}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${h.observacoes || '-'}</td>
                        <td style="color: rgba(255,255,255,0.7); font-size: 12px;">${h.sugestao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Defina per√≠odo completo!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= dataInicio && h.data <= dataFim;
            });
            
            if (sessoesNoPeriodo.length === 0) {
                document.getElementById('relatorioResultado').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Sem dados no per√≠odo</div></div>';
                document.getElementById('btnExportarRelatorio').style.display = 'none';
                return;
            }
            
            const totalSessoes = sessoesNoPeriodo.length;
            const totalTempo = sessoesNoPeriodo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const rendimentoMedio = Math.round((sessoesNoPeriodo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100);
            
            const porArea = {};
            sessoesNoPeriodo.forEach(h => {
                const area = h.area || 'Sem √°rea';
                if (!porArea[area]) {
                    porArea[area] = { sessoes: 0, tempo: 0, rendimento: 0 };
                }
                porArea[area].sessoes++;
                porArea[area].tempo += h.tempo || 0;
                porArea[area].rendimento += h.rendimento || 0;
            });
            
            const resultado = `
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 12px;">
                        An√°lise: ${formatarDataBR(dataInicio)} - ${formatarDataBR(dataFim)}
                    </h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalSessoes}</div>
                            <div class="stat-label">Sess√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(totalTempo / 60)}h</div>
                            <div class="stat-label">Tempo Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rendimentoMedio}%</div>
                            <div class="stat-label">Performance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(porArea).length}</div>
                            <div class="stat-label">√Åreas</div>
                        </div>
                    </div>
                    <h5 style="color: var(--turquesa-light); margin: 20px 0 12px;">Detalhamento por √Årea:</h5>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√Årea</th>
                                <th>Sess√µes</th>
                                <th>Tempo</th>
                                <th>Rendimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(porArea).map(([area, stats]) => `
                                <tr>
                                    <td style="color: var(--turquesa-light);">${area}</td>
                                    <td style="text-align: center;">${stats.sessoes}</td>
                                    <td style="text-align: center;">${stats.tempo} min</td>
                                    <td style="text-align: center;">${Math.round(stats.rendimento / stats.sessoes * 100)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('relatorioResultado').innerHTML = resultado;
            document.getElementById('btnExportarRelatorio').style.display = 'block';
            
            localStorage.setItem('relatorioPeriodo', JSON.stringify({ dataInicio, dataFim }));
        }

        function exportarRelatorioPeriodo() {
            const periodo = JSON.parse(localStorage.getItem('relatorioPeriodo') || '{}');
            if (!periodo.dataInicio || !periodo.dataFim) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Gere relat√≥rio primeiro!', 'error');
                return;
            }
            
            const sessoesNoPeriodo = historico.filter(h => {
                if (!dataValida(h.data)) return false;
                return h.data >= periodo.dataInicio && h.data <= periodo.dataFim;
            });
            
            const csv = dados2CSV(sessoesNoPeriodo);
            const filename = `VRVS_RELATORIO_${periodo.dataInicio}_${periodo.dataFim}.csv`;
            downloadCSV(csv, filename);
        }
        
        function updateStats() {
            // CORRE√á√ÉO: Suspenso n√£o aparece em estat√≠sticas
            const temasAtivos = dados.filter(t => t.status !== 'Suspenso');
            document.getElementById('statTemas').textContent = temasAtivos.length;
            
            // Filtrar hist√≥rico de temas suspensos
            const historicoAtivo = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                return tema && tema.status !== 'Suspenso';
            });
            
            const totalSessoes = historicoAtivo.length;
            document.getElementById('statSessoes').textContent = totalSessoes;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoAtivo.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            document.getElementById('statRendimento').textContent = rendimentoMedio + '%';
            const totalMinutos = historicoAtivo.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            document.getElementById('statTempo').textContent = totalHoras + 'h';
            
            // Calcular quest√µes totais (somar acertos de todas as quest√µes)
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoAtivo.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            document.getElementById('statQuestoes').textContent = totalQuestoesTotal > 0 
                ? `${totalQuestoesAcertos}/${totalQuestoesTotal}` 
                : '0';
            
            // Calcular flashcards totais
            const totalFlashcards = historicoAtivo.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            document.getElementById('statFlashcards').textContent = totalFlashcards.toLocaleString();
            
            renderChartBarras();
            renderChartLinha();
            renderChartRadar();
        }
        
        // ==================== GR√ÅFICOS POR √ÅREA! ====================
        
        const COLORS_PALETTE = [
            '#FFD700', '#FFA07A', '#F5DEB3', '#FF69B4', '#20B2AA', '#87CEEB',
            '#00FFE0', '#00CED1', '#FFA366', '#FF7F50', '#E55100', '#0d9488'
        ];
        let areaColorMap = {};
        let colorIndex = 0;
        
        function getColorForArea(area) {
            if (!areaColorMap[area]) {
                areaColorMap[area] = COLORS_PALETTE[colorIndex % COLORS_PALETTE.length];
                colorIndex++;
            }
            return areaColorMap[area];
        }
        
        let chartBarrasInst = null;
        let chartLinhaInst = null;
        let chartRadarInst = null;
        
        // GR√ÅFICO 1: Performance m√©dia POR √ÅREA
        function renderChartBarras() {
            const ctx = document.getElementById('chartBarras');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area: areaNormalizada } = fixAreaTema(h.area, h.tema);
                if (!areaNormalizada || areaNormalizada.trim() === '') return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (areaNormalizada.toLowerCase() === 'tema') return;
                
                if (!areaStats[areaNormalizada]) {
                    areaStats[areaNormalizada] = { total: 0, count: 0 };
                }
                areaStats[areaNormalizada].total += h.rendimento * 100;
                areaStats[areaNormalizada].count += 1;
            });
            
            const areaRendimento = [];
            for (let area in areaStats) {
                const media = Math.round(areaStats[area].total / areaStats[area].count);
                areaRendimento.push([area, media]);
            }
            const sorted = areaRendimento.sort((a, b) => b[1] - a[1]);
            
            if (sorted.length === 0) {
                if (chartBarrasInst) { chartBarrasInst.destroy(); chartBarrasInst = null; }
                return;
            }
            if (chartBarrasInst) { chartBarrasInst.destroy(); }
            
            const backgroundColors = sorted.map(s => getColorForArea(s[0]));
            
            chartBarrasInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Performance M√©dia (%)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Performance M√©dia por √Årea',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
        }
        
        // GR√ÅFICO 2: Evolu√ß√£o POR √ÅREA
        function renderChartLinha() {
            const ctx = document.getElementById('chartLinha');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areasSessoes = {};
            historico.forEach(h => {
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                if (!areasSessoes[area]) {
                    areasSessoes[area] = [];
                }
                areasSessoes[area].push({
                    rendimento: (h.rendimento || 0) * 100,
                    sessao: areasSessoes[area].length + 1
                });
            });
            
            const datasets = Object.entries(areasSessoes).map(([area, sessoes]) => {
                const color = getColorForArea(area);
                return {
                    label: area,
                    data: sessoes.map(s => ({ x: s.sessao, y: s.rendimento })),
                    borderColor: color,
                    backgroundColor: color + '33',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            if (datasets.length === 0) {
                if (chartLinhaInst) { chartLinhaInst.destroy(); chartLinhaInst = null; }
                return;
            }
            
            if (chartLinhaInst) { chartLinhaInst.destroy(); }
            chartLinhaInst = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: 'rgba(0,206,209,0.7)', font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o da Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const area = context[0].dataset.label;
                                    const sessao = context[0].parsed.x;
                                    return `${area} - Sess√£o ${sessao}`;
                                },
                                label: function(context) {
                                    return `Performance: ${Math.round(context.parsed.y)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'N√∫mero da Sess√£o',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', stepSize: 1 },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Rendimento (%)',
                                color: 'rgba(0,206,209,0.7)'
                            },
                            ticks: { color: 'rgba(0,206,209,0.7)', callback: val => val + '%' },
                            grid: { color: 'rgba(0,206,209,0.1)' }
                        }
                    }
                }
            });
        }
        
        // GR√ÅFICO 3: Radar POR √ÅREA
        function renderChartRadar() {
            const ctx = document.getElementById('chartRadar');
            if (!ctx) return;
            
            // AGRUPAR POR √ÅREA!!!
            const areaStats = {};
            historico.forEach(h => {
                if (!h.rendimento) return;
                // CORRE√á√ÉO: Filtrar hist√≥rico de temas Suspensos
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (tema && tema.status === 'Suspenso') return;
                
                const { area } = fixAreaTema(h.area, h.tema);
                if (!area) return;
                // CORRE√á√ÉO: Filtrar "Tema" que √© erro de importa√ß√£o
                if (area.toLowerCase() === 'tema') return;
                
                if (!areaStats[area]) {
                    areaStats[area] = { total: 0, count: 0 };
                }
                areaStats[area].total += h.rendimento * 100;
                areaStats[area].count += 1;
            });
            
            const areas = [];
            const rendimentos = [];
            for (let area in areaStats) {
                areas.push(area);
                rendimentos.push(Math.round(areaStats[area].total / areaStats[area].count));
            }
            
            if (areas.length === 0) {
                if (chartRadarInst) { chartRadarInst.destroy(); chartRadarInst = null; }
                return;
            }
            
            if (chartRadarInst) { chartRadarInst.destroy(); }
            chartRadarInst = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: areas,
                    datasets: [{
                        label: 'Performance M√©dia',
                        data: rendimentos,
                        borderColor: '#FFA500',
                        backgroundColor: 'rgba(255, 165, 0, 0.8)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#FFA500',
                        pointBorderColor: '#0a1a1f',
                        pointHoverBackgroundColor: '#FFA500',
                        pointHoverBorderColor: '#0a1a1f'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Mapa de Performance',
                            color: '#00CED1',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 26, 31, 0.9)',
                            borderColor: '#00CED1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'rgba(0,206,209,0.5)',
                                backdropColor: 'transparent',
                                stepSize: 20,
                                callback: val => val + '%'
                            },
                            grid: { color: 'rgba(0,206,209,0.2)' },
                            angleLines: { color: 'rgba(0,206,209,0.1)' },
                            pointLabels: {
                                color: 'rgba(0,206,209,0.8)',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== IMPORTA√á√ÉO/EXPORTA√á√ÉO ====================
        
        function limparTudo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Apagar TODOS os dados?')) return;
            if (!confirm('‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Opera√ß√£o irrevers√≠vel!')) return;
            
            localStorage.removeItem('vrvs_dados');
            localStorage.removeItem('vrvs_historico');
            localStorage.removeItem('ultimoBackup');
            dados = [];
            historico = [];
            
            renderDados();
            renderTarefas();
            renderAgenda();
            renderHistorico();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            
            mostrarNotificacaoFeedback('üóëÔ∏è Reset completo executado');
        }
        
        function importarArquivos() {
            const dadosFile = document.getElementById('importDados').files[0];
            const historicoFile = document.getElementById('importHistorico').files[0];
            
            if (!dadosFile && !historicoFile) {
                mostrarNotificacaoFeedback('‚ùå Selecione arquivo para importar!', 'error');
                return;
            }
            
            const promises = [];
            
            if (dadosFile) {
                promises.push(parseCSV(dadosFile).then(dadosCSV => {
                    dados = dadosCSV.map(t => {
                        if (!t.id) t.id = Date.now() + Math.random();
                        t.area = normalizeArea(t.area, t.tema);
                        if (t.rendimento > 1) t.rendimento = t.rendimento / 100;
                        t.prioridade = parseInt(t.prioridade) || 3;
                        t.sessoes = parseInt(t.sessoes) || 0;
                        t.tempo = parseInt(t.tempo) || 0;
                        t.contador80 = parseInt(t.contador80) || 0;
                        if (!t.sugestao || t.sugestao === '-') {
                            t.sugestao = extrairUltimaSugestao(t.observacoes);
                        }
                        delete t.tipoRevisao;
                        return t;
                    });
                    localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                    return 'dados';
                }));
            }
            
            if (historicoFile) {
                promises.push(parseCSV(historicoFile).then(historicoCSV => {
                    historico = historicoCSV.map(h => {
                        if (!h.id) h.id = Date.now() + Math.random();
                        h.area = normalizeArea(h.area, h.tema);
                        if (h.rendimento > 1) h.rendimento = h.rendimento / 100;
                        h.tempo = parseInt(h.tempo) || 0;
                        if (!h.data || h.data === '-') {
                            const obsMatch = (h.observacoes || '').match(/^(\d{4}-\d{2}-\d{2}):/);
                            if (obsMatch) {
                                h.data = obsMatch[1];
                            }
                        }
                        if (!h.sugestao || h.sugestao === '-') {
                            h.sugestao = extrairUltimaSugestao(h.observacoes);
                        }
                        return h;
                    });
                    localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                    return 'historico';
                }));
            }
            
            Promise.all(promises)
                .then(results => {
                    // CORRE√á√ÉO: Limpar hist√≥rico inv√°lido ap√≥s importa√ß√£o
                    limparHistoricoInvalido();
                    
                    const msg = results.map(r => r === 'dados' ? 'Dados' : 'Hist√≥rico').join(' e ');
                    mostrarNotificacaoFeedback(`‚úÖ ${msg} importados com sucesso!`);
                    document.getElementById('importDados').value = '';
                    document.getElementById('importHistorico').value = '';
                    renderDados();
                    renderTarefas();
                    renderAgenda();
                    renderHistorico();
                    renderPendencias();
                    updateFeedbackSelect();
                    updateStats();
                })
                .catch(error => {
                    mostrarNotificacaoFeedback(`‚ùå Erro: ${error.message}`, 'error');
                });
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = parseCSVText(text);
                        if (rows.length < 2) {
                            reject(new Error('Arquivo vazio ou inv√°lido'));
                            return;
                        }
                        const headers = rows[0];
                        const headersNormalizados = headers.map(h => 
                            h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').replace(/[()]/g, '').replace(/\./g, '')
                        );
                        const headerMap = {};
                        headersNormalizados.forEach((h, i) => { headerMap[h] = i; });
                        const getVal = (r, ...possiveisNomes) => {
                            for (const nome of possiveisNomes) {
                                const idx = headerMap[nome];
                                if (idx !== undefined && r[idx]) {
                                    return stripOuterQuotes(r[idx]);
                                }
                            }
                            return '';
                        };
                        const data = rows.slice(1).map((r, lineNum) => {
                            return {
                                id: getVal(r, 'id') || `${Date.now()}_${lineNum}`,
                                area: getVal(r, 'area', 'topico'),
                                tema: getVal(r, 'tema', 'assunto', 'titulo'),
                                status: getVal(r, 'status', 'estado') || 'N√£o iniciado',
                                prioridade: parseInt(getVal(r, 'prioridade', 'prior')) || 3,
                                dificuldade: getVal(r, 'dificuldade', 'dific') || 'M√©dia',
                                rendimento: (() => {
                                    const valStr = getVal(r, 'rendimento', 'rend');
                                    if (!valStr) return 0;
                                    const cleanStr = valStr.replace('%', '').replace(',', '.');
                                    const val = parseFloat(cleanStr) || 0;
                                    return val > 1 ? val / 100 : val;
                                })(),
                                sessoes: parseInt(getVal(r, 'sessoes', 'sessao')) || 0,
                                ultEstudo: getVal(r, 'ultestudo', 'ultest', 'ultimoestudo', 'ultimo_estudo'),
                                agenda: getVal(r, 'dataagenda', 'agenda', 'data_agenda'),
                                tempo: parseInt(getVal(r, 'tempomin', 'tempo')) || 0,
                                observacoes: getVal(r, 'observacoes', 'obs', 'observacao'),
                                contador80: parseInt(getVal(r, 'contador80')) || 0,
                                sugestao: getVal(r, 'sugestao', 'sugestoes'),
                                data: getVal(r, 'data'),
                                temaId: getVal(r, 'temaid')
                            };
                        }).filter(obj => obj.tema && obj.tema.trim() !== '');
                        resolve(data);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function parseCSVText(input) {
            let text = String(input || '').replace(/^\uFEFF/, '');
            const rows = [];
            let row = [];
            let cell = '';
            let i = 0;
            let inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    if (ch === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            cell += '"';
                            i += 2;
                        } else {
                            inQuotes = false;
                            i += 1;
                        }
                    } else {
                        cell += ch;
                        i += 1;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                        i += 1;
                    } else if (ch === ',') {
                        row.push(cell);
                        cell = '';
                        i += 1;
                    } else if (ch === '\r') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        if (text[i + 1] === '\n') i += 2; else i += 1;
                    } else if (ch === '\n') {
                        row.push(cell);
                        rows.push(row);
                        row = [];
                        cell = '';
                        i += 1;
                    } else {
                        cell += ch;
                        i += 1;
                    }
                }
            }
            row.push(cell);
            rows.push(row);
            return rows;
        }
        
        function stripOuterQuotes(s) {
            const str = String(s ?? '');
            if (str.length >= 2 && str[0] === '"' && str[str.length - 1] === '"') {
                return str.slice(1, -1).replace(/""/g, '"');
            }
            return str;
        }
        
        function exportarDados() {
            const csv = dados2CSV(dados);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_DADOS_${hoje}.csv`);
        }
        
        function exportarHistorico() {
            const csv = dados2CSV(historico);
            const hoje = new Date().toISOString().split('T')[0];
            downloadCSV(csv, `VRVS_HISTORICO_${hoje}.csv`);
        }
        
        function salvarDadosManualmente() {
            try {
                // Salvar todos os dados no localStorage
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                mostrarNotificacaoFeedback('‚úÖ Todos os dados salvos com sucesso!');
            } catch (e) {
                mostrarNotificacaoFeedback('‚ùå Erro ao salvar: ' + e.message, 'error');
            }
        }
        
        function dados2CSV(arr) {
            if (arr.length === 0) return '';
            // Uni√£o de todas as chaves para garantir todas as colunas
            const headerSet = new Set();
            arr.forEach(obj => {
                if (obj) Object.keys(obj).forEach(k => headerSet.add(k));
            });
            // Garantir que observacoes e sugestao est√£o sempre presentes
            headerSet.add('observacoes');
            headerSet.add('sugestao');
            const headers = Array.from(headerSet);
            
            const rows = arr.map(obj => headers.map(h => {
                const val = (obj && obj[h] != null) ? obj[h] : '';
                const strVal = String(val);
                // Escapar aspas duplas
                const escaped = strVal.replace(/"/g, '""');
                // Se cont√©m v√≠rgula, quebra de linha ou aspas, precisa estar entre aspas
                if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) {
                    return `"${escaped}"`;
                }
                return escaped;
            }).join(','));
            return [headers.join(','), ...rows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // ==================== NAVEGA√á√ÉO ====================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            if (sectionId === 'dados') renderDados();
            if (sectionId === 'tarefa') renderTarefas();
            if (sectionId === 'agenda') renderAgenda();
            if (sectionId === 'stats') updateStats();
            if (sectionId === 'historico') renderHistorico();
            if (sectionId === 'pendencias') renderPendencias();
            if (sectionId === 'lembretes') {
                atualizarSelectsLembrete();
                renderLembretes();
            }
            if (sectionId === 'caderno') {
                atualizarSelectsCaderno();
                renderCaderno();
            }
            if (sectionId === 'analises') {
                atualizarSelectsAnalise();
                atualizarAnalises();
            }
        }
        
        // ==================== AN√ÅLISES DETALHADAS ====================
        
        function atualizarSelectsAnalise() {
            // Atualizar select de √°reas
            const areaSelect = document.getElementById('analiseFiltroArea');
            const areas = [...new Set(dados.filter(t => t.status !== 'Suspenso').map(t => t.area))].sort();
            areaSelect.innerHTML = '<option value="">Todas as √°reas</option>';
            areas.forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
            
            // Atualizar select de temas baseado na √°rea selecionada
            atualizarSelectTemaAnalise();
        }
        
        function atualizarSelectTemaAnalise() {
            const temaSelect = document.getElementById('analiseFiltroTema');
            const areaSelecionada = document.getElementById('analiseFiltroArea').value;
            
            let temasFiltrados = dados.filter(t => t.status !== 'Suspenso');
            if (areaSelecionada) {
                temasFiltrados = temasFiltrados.filter(t => t.area === areaSelecionada);
            }
            
            const temas = [...new Set(temasFiltrados.map(t => `${t.area} - ${t.tema}`))].sort();
            temaSelect.innerHTML = '<option value="">Todos os temas</option>';
            temas.forEach(tema => {
                temaSelect.innerHTML += `<option value="${tema}">${tema}</option>`;
            });
        }
        
        function atualizarAnalises() {
            calcularAnalises();
        }
        
        // Vari√°vel global para controlar visibilidade das an√°lises de tempo
        window.analisesTempoVisiveis = false;
        
        function toggleAnalisesTempo() {
            window.analisesTempoVisiveis = !window.analisesTempoVisiveis;
            const toggleText = document.getElementById('toggleAnalisesTempoText');
            const analiseTempoDiv = document.getElementById('analiseTempo');
            
            if (toggleText) {
                toggleText.textContent = window.analisesTempoVisiveis ? '‚è±Ô∏è Ocultar An√°lises de Tempo' : '‚è±Ô∏è Mostrar An√°lises de Tempo';
            }
            
            if (analiseTempoDiv) {
                analiseTempoDiv.style.display = window.analisesTempoVisiveis ? 'block' : 'none';
            }
            
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function calcularAnalisesTempo() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico (mesma l√≥gica de calcularAnalises)
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseTempo').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">‚è±Ô∏è</div><div>Nenhum dado de tempo encontrado</div></div>';
                return;
            }
            
            // Calcular m√©dias de tempo
            const sessoesComTempo = historicoFiltrado.filter(h => h.tempo && h.tempo > 0);
            const tempoMedioSessao = sessoesComTempo.length > 0
                ? Math.round(sessoesComTempo.reduce((sum, h) => sum + (h.tempo || 0), 0) / sessoesComTempo.length)
                : 0;
            
            // Tempo m√©dio em quest√µes
            const sessoesComTempoQuestoes = historicoFiltrado.filter(h => h.tempoQuestoes && h.tempoQuestoes > 0);
            const tempoMedioQuestoes = sessoesComTempoQuestoes.length > 0
                ? Math.round(sessoesComTempoQuestoes.reduce((sum, h) => sum + (h.tempoQuestoes || 0), 0) / sessoesComTempoQuestoes.length)
                : 0;
            
            // Tempo m√©dio em flashcards
            const sessoesComTempoFlashcards = historicoFiltrado.filter(h => h.tempoFlashcards && h.tempoFlashcards > 0);
            const tempoMedioFlashcards = sessoesComTempoFlashcards.length > 0
                ? Math.round(sessoesComTempoFlashcards.reduce((sum, h) => sum + (h.tempoFlashcards || 0), 0) / sessoesComTempoFlashcards.length)
                : 0;
            
            // M√©dia de intervalos por sess√£o
            const sessoesComIntervalos = historicoFiltrado.filter(h => h.numeroIntervalos && h.numeroIntervalos > 0);
            const mediaIntervalosPorSessao = sessoesComIntervalos.length > 0
                ? (sessoesComIntervalos.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0) / sessoesComIntervalos.length).toFixed(1)
                : '0';
            
            // Tempo m√©dio de cada intervalo
            const intervalosIndividuais = [];
            historicoFiltrado.forEach(h => {
                if (h.intervalos && h.tempoIntervalo && h.numeroIntervalos) {
                    const numIntervalos = parseInt(h.numeroIntervalos) || 0;
                    const tempoTotalIntervalos = parseInt(h.tempoIntervalo) || 0;
                    if (numIntervalos > 0 && tempoTotalIntervalos > 0) {
                        intervalosIndividuais.push(tempoTotalIntervalos / numIntervalos);
                    }
                }
            });
            const tempoMedioIntervalo = intervalosIndividuais.length > 0
                ? Math.round(intervalosIndividuais.reduce((sum, t) => sum + t, 0) / intervalosIndividuais.length)
                : 0;
            
            // Renderizar an√°lises de tempo
            const html = `
                <div style="background: rgba(0,206,209,0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(0,206,209,0.3);">
                    <h4 style="color: var(--turquesa-light); margin-bottom: 20px; font-size: 16px;">‚è±Ô∏è AN√ÅLISES DE TEMPO</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioSessao} min</div>
                            <div class="stat-label">Tempo M√©dio por Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioQuestoes} min</div>
                            <div class="stat-label">Tempo M√©dio em Quest√µes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioFlashcards} min</div>
                            <div class="stat-label">Tempo M√©dio em Flashcards</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${mediaIntervalosPorSessao}</div>
                            <div class="stat-label">M√©dia de Intervalos/Sess√£o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${tempoMedioIntervalo} min</div>
                            <div class="stat-label">Tempo M√©dio por Intervalo</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analiseTempo').innerHTML = html;
        }
        
        function calcularAnalises() {
            const areaFiltro = document.getElementById('analiseFiltroArea').value;
            const temaFiltro = document.getElementById('analiseFiltroTema').value;
            const dataInicio = document.getElementById('analiseDataInicio').value;
            const dataFim = document.getElementById('analiseDataFim').value;
            
            // Filtrar hist√≥rico
            let historicoFiltrado = historico.filter(h => {
                const tema = dados.find(t => String(t.id) === String(h.temaId));
                if (!tema || tema.status === 'Suspenso') return false;
                
                // Filtrar por √°rea
                if (areaFiltro && tema.area !== areaFiltro) return false;
                
                // Filtrar por tema
                if (temaFiltro) {
                    const temaCompleto = `${tema.area} - ${tema.tema}`;
                    if (temaCompleto !== temaFiltro) return false;
                }
                
                // Filtrar por per√≠odo
                if (dataInicio && h.data < dataInicio) return false;
                if (dataFim && h.data > dataFim) return false;
                
                return true;
            });
            
            if (historicoFiltrado.length === 0) {
                document.getElementById('analiseResultados').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìä</div><div>Nenhum dado encontrado para os filtros selecionados</div></div>';
                return;
            }
            
            // Calcular estat√≠sticas
            const totalSessoes = historicoFiltrado.length;
            const rendimentoMedio = totalSessoes > 0 
                ? Math.round((historicoFiltrado.reduce((sum, h) => sum + (h.rendimento || 0), 0) / totalSessoes) * 100)
                : 0;
            const totalMinutos = historicoFiltrado.reduce((sum, h) => sum + (h.tempo || 0), 0);
            const totalHoras = Math.round(totalMinutos / 60);
            const totalMinutosResto = totalMinutos % 60;
            
            // Calcular quest√µes
            let totalQuestoesAcertos = 0;
            let totalQuestoesTotal = 0;
            historicoFiltrado.forEach(h => {
                if (h.questoes) {
                    const match = h.questoes.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalQuestoesAcertos += parseInt(match[1]);
                        totalQuestoesTotal += parseInt(match[2]);
                    }
                }
            });
            const taxaAcertoQuestoes = totalQuestoesTotal > 0 
                ? Math.round((totalQuestoesAcertos / totalQuestoesTotal) * 100)
                : 0;
            
            // Calcular flashcards
            const totalFlashcards = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.flashcards) || 0), 0);
            
            // Calcular intervalos
            const totalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.numeroIntervalos) || 0), 0);
            const tempoTotalIntervalos = historicoFiltrado.reduce((sum, h) => sum + (parseInt(h.tempoIntervalo) || 0), 0);
            
            // Agrupar por √°rea (se n√£o filtrado por √°rea espec√≠fica)
            let porArea = {};
            if (!areaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema && tema.area) {
                        if (!porArea[tema.area]) {
                            porArea[tema.area] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porArea[tema.area].sessoes++;
                        porArea[tema.area].tempo += h.tempo || 0;
                        porArea[tema.area].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porArea[tema.area].questoes.acertos += parseInt(match[1]);
                                porArea[tema.area].questoes.total += parseInt(match[2]);
                            }
                        }
                        porArea[tema.area].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porArea).forEach(area => {
                    porArea[area].rendimento = porArea[area].sessoes > 0 
                        ? Math.round((porArea[area].rendimento / porArea[area].sessoes) * 100)
                        : 0;
                    porArea[area].tempoHoras = Math.round(porArea[area].tempo / 60);
                });
            }
            
            // Agrupar por tema (se n√£o filtrado por tema espec√≠fico)
            let porTema = {};
            if (!temaFiltro) {
                historicoFiltrado.forEach(h => {
                    const tema = dados.find(t => String(t.id) === String(h.temaId));
                    if (tema) {
                        const temaKey = `${tema.area} - ${tema.tema}`;
                        if (!porTema[temaKey]) {
                            porTema[temaKey] = {
                                sessoes: 0,
                                tempo: 0,
                                rendimento: 0,
                                questoes: { acertos: 0, total: 0 },
                                flashcards: 0
                            };
                        }
                        porTema[temaKey].sessoes++;
                        porTema[temaKey].tempo += h.tempo || 0;
                        porTema[temaKey].rendimento += h.rendimento || 0;
                        
                        if (h.questoes) {
                            const match = h.questoes.match(/(\d+)\/(\d+)/);
                            if (match) {
                                porTema[temaKey].questoes.acertos += parseInt(match[1]);
                                porTema[temaKey].questoes.total += parseInt(match[2]);
                            }
                        }
                        porTema[temaKey].flashcards += parseInt(h.flashcards) || 0;
                    }
                });
                
                // Calcular m√©dias
                Object.keys(porTema).forEach(temaKey => {
                    porTema[temaKey].rendimento = porTema[temaKey].sessoes > 0 
                        ? Math.round((porTema[temaKey].rendimento / porTema[temaKey].sessoes) * 100)
                        : 0;
                    porTema[temaKey].tempoHoras = Math.round(porTema[temaKey].tempo / 60);
                });
            }
            
            // Renderizar resultados
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalSessoes}</div>
                        <div class="stat-label">Sess√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHoras}h${totalMinutosResto > 0 ? ' ' + totalMinutosResto + 'm' : ''}</div>
                        <div class="stat-label">Tempo Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${rendimentoMedio}%</div>
                        <div class="stat-label">Performance M√©dia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalQuestoesTotal > 0 ? totalQuestoesAcertos + '/' + totalQuestoesTotal : '0'}</div>
                        <div class="stat-label">Quest√µes (${taxaAcertoQuestoes}% acerto)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalFlashcards.toLocaleString()}</div>
                        <div class="stat-label">Flashcards Revisados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalIntervalos}</div>
                        <div class="stat-label">Intervalos (${Math.round(tempoTotalIntervalos)} min)</div>
                    </div>
                </div>
            `;
            
            // Detalhamento por √°rea (com temas colaps√°veis)
            if (!areaFiltro && Object.keys(porArea).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìä Detalhamento por √Årea:</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th style="width: 30px;"></th><th>√Årea</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porArea).sort().forEach((area, index) => {
                    const stats = porArea[area];
                    const temasDaArea = Object.keys(porTema).filter(t => t.startsWith(area + ' - '));
                    
                    html += '<tr style="background: rgba(0,206,209,0.15); cursor: pointer;" onclick="toggleTemasArea(\'' + area.replace(/'/g, "\\'") + '\')">';
                    html += `<td style="text-align: center; color: var(--turquesa-light); font-weight: bold;">${temasDaArea.length > 0 ? '‚ñ∂' : ''}</td>`;
                    html += `<td><strong style="color: var(--turquesa-light);">${area}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                    
                    // Temas da √°rea (inicialmente ocultos)
                    if (temasDaArea.length > 0) {
                        html += `<tr id="temas-${area.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: none;">`;
                        html += '<td colspan="7" style="padding: 0; background: rgba(0,0,0,0.3);">';
                        html += '<table style="width: 100%; margin: 0;"><tbody>';
                        
                        temasDaArea.forEach(temaKey => {
                            const temaStats = porTema[temaKey];
                            const temaNome = temaKey.replace(area + ' - ', '');
                            html += '<tr style="border-top: 1px solid rgba(0,206,209,0.2);">';
                            html += `<td style="padding-left: 40px; color: rgba(0,206,209,0.8); font-weight: 500;">${temaNome}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.sessoes}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.tempoHoras}h</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.rendimento}%</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.questoes.total > 0 ? temaStats.questoes.acertos + '/' + temaStats.questoes.total + ' (' + Math.round((temaStats.questoes.acertos / temaStats.questoes.total) * 100) + '%)' : '-'}</td>`;
                            html += `<td style="color: rgba(255,255,255,0.8);">${temaStats.flashcards > 0 ? temaStats.flashcards.toLocaleString() : '-'}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></td></tr>';
                    }
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema (apenas quando filtrar por √°rea espec√≠fica)
            if (areaFiltro && !temaFiltro && Object.keys(porTema).length > 0) {
                html += '<h5 style="color: var(--turquesa-light); margin: 30px 0 15px;">üìö Temas da √Årea "' + areaFiltro + '":</h5>';
                html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
                html += '<th>Tema</th><th>Sess√µes</th><th>Tempo</th><th>Performance</th><th>Quest√µes</th><th>Flashcards</th>';
                html += '</tr></thead><tbody>';
                
                Object.keys(porTema).filter(t => t.startsWith(areaFiltro + ' - ')).sort().forEach(temaKey => {
                    const stats = porTema[temaKey];
                    const temaNome = temaKey.replace(areaFiltro + ' - ', '');
                    html += '<tr>';
                    html += `<td><strong style="color: var(--turquesa-light);">${temaNome}</strong></td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.sessoes}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.tempoHoras}h</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.rendimento}%</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.questoes.total > 0 ? stats.questoes.acertos + '/' + stats.questoes.total + ' (' + Math.round((stats.questoes.acertos / stats.questoes.total) * 100) + '%)' : '-'}</td>`;
                    html += `<td style="color: rgba(255,255,255,0.9);">${stats.flashcards > 0 ? stats.flashcards.toLocaleString() : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            }
            
            // Detalhamento por tema quando filtrado por tema espec√≠fico (n√£o mostrar, j√° est√° no resumo geral)
            
            document.getElementById('analiseResultados').innerHTML = html;
            
            // Se an√°lises de tempo est√£o vis√≠veis, recalcular
            if (window.analisesTempoVisiveis) {
                calcularAnalisesTempo();
            }
        }
        
        function filtrarAnaliseSemanaAtual() {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            
            document.getElementById('analiseDataInicio').value = inicioSemana.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimSemana.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function filtrarAnaliseMesAtual() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('analiseDataInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('analiseDataFim').value = fimMes.toISOString().split('T')[0];
            atualizarAnalises();
        }
        
        function limparFiltrosAnalise() {
            document.getElementById('analiseFiltroArea').value = '';
            document.getElementById('analiseFiltroTema').value = '';
            document.getElementById('analiseDataInicio').value = '';
            document.getElementById('analiseDataFim').value = '';
            atualizarSelectsAnalise();
            atualizarAnalises();
        }
        
        // Fun√ß√£o para expandir/colapsar temas de uma √°rea
        function toggleTemasArea(area) {
            const areaId = 'temas-' + area.replace(/[^a-zA-Z0-9]/g, '-');
            const row = document.getElementById(areaId);
            if (!row) return;
            
            const isVisible = row.style.display !== 'none';
            row.style.display = isVisible ? 'none' : 'table-row';
            
            // Atualizar √≠cone
            const areaRow = row.previousElementSibling;
            if (areaRow) {
                const iconCell = areaRow.querySelector('td:first-child');
                if (iconCell) {
                    iconCell.textContent = isVisible ? '‚ñ∂' : '‚ñº';
                }
            }
        }
        
        // ==================== CRON√îMETRO DA SESS√ÉO ====================
        
        let cronometroInterval = null;
        let cronometroSegundos = 0;
        let cronometroRodando = false;
        let intervaloAtivo = false;
        let intervaloSegundos = 0;
        let intervaloInterval = null;
        let tempoTotalIntervalo = 0; // Tempo total de intervalo acumulado (n√£o conta no estudo)
        let cronometroInicioTimestamp = null; // Timestamp de quando o cron√¥metro foi iniciado (para rodar em segundo plano)
        let intervalosIndividuais = []; // Array para armazenar cada intervalo individualmente [{tempo: segundos, inicio: timestamp}, ...]
        let intervaloInicioTimestamp = null; // Timestamp de quando o intervalo atual come√ßou
        
        // Restaurar cron√¥metro do localStorage se existir
        function restaurarCronometro() {
            const salvo = localStorage.getItem('vrvs_cronometro');
            if (salvo) {
                try {
                    const dados = JSON.parse(salvo);
                    if (dados.timestamp) {
                        // Calcular tempo decorrido desde que foi salvo (BASEADO EM TIMESTAMP)
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - dados.timestamp) / 1000);
                        
                        // Atualizar valores
                        cronometroSegundos = dados.segundos + tempoDecorrido;
                        tempoTotalIntervalo = dados.tempoIntervalo || 0;
                        intervalosIndividuais = dados.intervalosIndividuais || []; // Restaurar intervalos individuais
                        intervaloInicioTimestamp = dados.intervaloInicioTimestamp || null;
                        
                        // Se estava em intervalo, restaurar estado do intervalo
                        if (dados.intervaloAtivo) {
                            intervaloAtivo = true;
                            intervaloSegundos = dados.intervaloSegundos + tempoDecorrido;
                            document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                            document.getElementById('tempoIntervalo').style.display = 'block';
                            document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                            
                            // Reiniciar intervalo timer
                            if (intervaloInterval) {
                                clearInterval(intervaloInterval);
                            }
                            intervaloInterval = setInterval(() => {
                                intervaloSegundos++;
                                document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                            }, 1000);
                        }
                        
                        // Se estava rodando, reiniciar contagem COM TIMESTAMP PRECISO
                        if (dados.rodando && !cronometroRodando) {
                            cronometroRodando = true;
                            cronometroInicioTimestamp = dados.timestamp; // Usar timestamp original
                            localStorage.setItem('vrvs_cronometro_timestamp', String(dados.timestamp));
                            localStorage.setItem('vrvs_cronometro_segundos', String(dados.segundos));
                            iniciarCronometroContagem();
                            document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                        }
                        
                        atualizarDisplayCronometro();
                    }
                } catch (e) {
                    console.log('Erro ao restaurar cron√¥metro:', e);
                }
            }
        }
        
        // Salvar estado do cron√¥metro
        function salvarEstadoCronometro() {
            if (cronometroRodando || intervaloAtivo) {
                // CR√çTICO: Salvar timestamp original, n√£o atualizar
                const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                
                localStorage.setItem('vrvs_cronometro', JSON.stringify({
                    rodando: cronometroRodando,
                    segundos: segundosOriginais ? parseInt(segundosOriginais) : cronometroSegundos,
                    timestamp: timestampOriginal ? parseInt(timestampOriginal) : cronometroInicioTimestamp || Date.now(),
                    tempoIntervalo: tempoTotalIntervalo,
                    intervaloAtivo: intervaloAtivo,
                    intervaloSegundos: intervaloSegundos,
                    intervalosIndividuais: intervalosIndividuais, // Salvar array de intervalos individuais
                    intervaloInicioTimestamp: intervaloInicioTimestamp
                }));
            } else {
                localStorage.removeItem('vrvs_cronometro');
            }
        }
        
        // Iniciar contagem do cron√¥metro
        function iniciarCronometroContagem() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            
            // CR√çTICO: Manter timestamp original se j√° existe, sen√£o criar novo
            let timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
            let segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
            
            if (!timestampOriginal) {
                // Primeira vez iniciando
                cronometroInicioTimestamp = Date.now();
                timestampOriginal = String(cronometroInicioTimestamp);
                segundosOriginais = String(cronometroSegundos);
            } else {
                // Continuando contagem - usar timestamp original
                cronometroInicioTimestamp = parseInt(timestampOriginal);
            }
            
            // Salvar no localStorage
            localStorage.setItem('vrvs_cronometro_timestamp', timestampOriginal);
            localStorage.setItem('vrvs_cronometro_segundos', segundosOriginais);
            
            // Atualizar display periodicamente (mas c√°lculo sempre baseado em timestamp)
            cronometroInterval = setInterval(() => {
                atualizarDisplayCronometro();
            }, 100); // Atualizar a cada 100ms para maior precis√£o visual
            
            cronometroRodando = true;
            salvarEstadoCronometro();
        }
        
        // Fun√ß√£o para calcular tempo decorrido baseado em timestamp (n√£o depende de intervalos)
        function calcularTempoDecorrido() {
            const timestampSalvo = localStorage.getItem('vrvs_cronometro_timestamp');
            const segundosSalvos = parseInt(localStorage.getItem('vrvs_cronometro_segundos') || '0');
            
            if (timestampSalvo && cronometroRodando) {
                const agora = Date.now();
                const tempoDecorrido = Math.floor((agora - parseInt(timestampSalvo)) / 1000);
                return segundosSalvos + tempoDecorrido;
            }
            return cronometroSegundos;
        }
        
        function formatarTempoCronometro(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }
        
        function atualizarDisplayCronometro() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando
            if (cronometroRodando) {
                cronometroSegundos = calcularTempoDecorrido();
            }
            
            document.getElementById('cronometroDisplay').textContent = formatarTempoCronometro(cronometroSegundos);
            // Atualizar display de tempo total de intervalo acumulado
            if (tempoTotalIntervalo > 0) {
                document.getElementById('tempoIntervaloTotal').style.display = 'block';
                document.getElementById('tempoIntervaloTotalDisplay').textContent = formatarTempoCronometro(tempoTotalIntervalo);
            } else {
                document.getElementById('tempoIntervaloTotal').style.display = 'none';
            }
        }
        
        function toggleCronometro() {
            if (intervaloAtivo) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Termine o intervalo primeiro!', 'error');
                return;
            }
            
            if (cronometroRodando) {
                // Pausar - calcular tempo final baseado em timestamp
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                
                // Calcular tempo final preciso
                cronometroSegundos = calcularTempoDecorrido();
                
                cronometroRodando = false;
                cronometroInicioTimestamp = null;
                localStorage.removeItem('vrvs_cronometro_timestamp');
                
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                salvarEstadoCronometro();
                atualizarDisplayCronometro();
            } else {
                // Iniciar - salvar timestamp preciso
                cronometroInicioTimestamp = Date.now();
                localStorage.setItem('vrvs_cronometro_timestamp', String(cronometroInicioTimestamp));
                localStorage.setItem('vrvs_cronometro_segundos', String(cronometroSegundos));
                
                iniciarCronometroContagem();
                document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        }
        
        function pausarCronometro() {
            if (cronometroRodando) {
                toggleCronometro();
            }
        }
        
        function iniciarIntervalo() {
            if (!cronometroRodando && cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è Inicie o cron√¥metro primeiro!', 'error');
                return;
            }
            
            if (intervaloAtivo) {
                // Finalizar intervalo - calcular tempo baseado em timestamp e salvar individualmente
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                // Calcular tempo preciso do intervalo baseado em timestamp
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                // Salvar intervalo individual
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal; // Acumular tempo de intervalo
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
                
                document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'none';
                atualizarDisplayCronometro(); // Atualizar display com tempo acumulado
                salvarEstadoCronometro(); // Salvar estado atualizado
                mostrarNotificacaoFeedback(`‚úÖ Intervalo finalizado (${formatarTempoCronometro(tempoIntervaloFinal)} - Total: ${formatarTempoCronometro(tempoTotalIntervalo)})`);
            } else {
                // Iniciar intervalo (pausa o cron√¥metro mas n√£o conta)
                intervaloAtivo = true;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = Date.now(); // Salvar timestamp de in√≠cio do intervalo
                
                document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                document.getElementById('tempoIntervalo').style.display = 'block';
                
                intervaloInterval = setInterval(() => {
                    // Calcular baseado em timestamp para maior precis√£o
                    if (intervaloInicioTimestamp) {
                        const agora = Date.now();
                        intervaloSegundos = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                    } else {
                        intervaloSegundos++;
                    }
                    document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                }, 100);
                
                // Pausar cron√¥metro durante intervalo
                if (cronometroRodando) {
                    clearInterval(cronometroInterval);
                    cronometroInterval = null;
                    cronometroRodando = false;
                    document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
                }
                
                salvarEstadoCronometro(); // Salvar estado quando inicia intervalo
            }
        }
        
        function resetCronometro() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
            }
            if (intervaloInterval) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
            }
            cronometroRodando = false;
            intervaloAtivo = false;
            cronometroSegundos = 0;
            intervaloSegundos = 0;
            tempoTotalIntervalo = 0; // Resetar tempo total de intervalo
            intervalosIndividuais = []; // Resetar array de intervalos individuais
            intervaloInicioTimestamp = null;
            cronometroInicioTimestamp = null;
            atualizarDisplayCronometro();
            document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            document.getElementById('cronometroIntervalo').textContent = '‚è∏Ô∏è Intervalo';
            document.getElementById('tempoIntervalo').style.display = 'none';
            localStorage.removeItem('vrvs_cronometro'); // Limpar do localStorage
            localStorage.removeItem('vrvs_cronometro_timestamp');
            localStorage.removeItem('vrvs_cronometro_segundos');
        }
        
        // Fun√ß√£o para encerrar sess√£o e mostrar modal
        function encerrarSessao() {
            // Pausar cron√¥metro se estiver rodando para calcular tempo final preciso
            if (cronometroRodando) {
                clearInterval(cronometroInterval);
                cronometroInterval = null;
                cronometroSegundos = calcularTempoDecorrido();
                cronometroRodando = false;
                document.getElementById('cronometroToggle').textContent = '‚è±Ô∏è Iniciar Cron√¥metro';
            }
            
            // Finalizar intervalo ativo se houver
            if (intervaloAtivo) {
                clearInterval(intervaloInterval);
                intervaloInterval = null;
                
                let tempoIntervaloFinal = intervaloSegundos;
                if (intervaloInicioTimestamp) {
                    const agora = Date.now();
                    tempoIntervaloFinal = Math.floor((agora - intervaloInicioTimestamp) / 1000);
                }
                
                intervalosIndividuais.push({
                    tempo: tempoIntervaloFinal,
                    inicio: intervaloInicioTimestamp || Date.now() - (tempoIntervaloFinal * 1000)
                });
                
                tempoTotalIntervalo += tempoIntervaloFinal;
                intervaloAtivo = false;
                intervaloSegundos = 0;
                intervaloInicioTimestamp = null;
            }
            
            if (cronometroSegundos === 0) {
                mostrarNotificacaoFeedback('‚ö†Ô∏è O cron√¥metro n√£o est√° rodando!', 'error');
                return;
            }
            
            // Preencher dados do modal
            document.getElementById('modalTempoTotal').textContent = formatarTempoCronometro(cronometroSegundos);
            document.getElementById('modalNumIntervalos').textContent = intervalosIndividuais.length;
            document.getElementById('modalTempoIntervalos').textContent = formatarTempoCronometro(tempoTotalIntervalo);
            
            // Limpar campos do modal
            document.getElementById('modalTempoQuestoes').value = '';
            document.getElementById('modalQuantQuestoes').value = '';
            document.getElementById('modalTempoFlashcards').value = '';
            document.getElementById('modalQuantFlashcards').value = '';
            
            // Mostrar modal
            document.getElementById('encerrarSessaoModal').classList.add('active');
        }
        
        function closeEncerrarSessaoModal() {
            document.getElementById('encerrarSessaoModal').classList.remove('active');
        }
        
        function preencherDadosSessao() {
            const tempoQuestoes = parseInt(document.getElementById('modalTempoQuestoes').value) || 0;
            const quantQuestoes = parseInt(document.getElementById('modalQuantQuestoes').value) || 0;
            const tempoFlashcards = parseInt(document.getElementById('modalTempoFlashcards').value) || 0;
            const quantFlashcards = parseInt(document.getElementById('modalQuantFlashcards').value) || 0;
            
            // Preencher campos do formul√°rio
            const tempoTotal = tempoQuestoes + tempoFlashcards;
            if (tempoTotal > 0) {
                document.getElementById('feedbackTempo').value = tempoTotal;
            }
            
            // Preencher quest√µes (formato: acertos/total)
            if (quantQuestoes > 0) {
                document.getElementById('feedbackQuestoes').value = quantQuestoes + '/' + quantQuestoes;
            }
            
            // Preencher flashcards
            if (quantFlashcards > 0) {
                document.getElementById('feedbackFlashcards').value = quantFlashcards;
            }
            
            // Preencher intervalo se houver
            const numeroIntervalos = intervalosIndividuais.length;
            if (numeroIntervalos > 0) {
                const temposIntervalos = intervalosIndividuais.map(i => formatarTempoCronometro(i.tempo)).join(', ');
                document.getElementById('feedbackNumeroIntervalos').value = numeroIntervalos;
                document.getElementById('feedbackIntervalos').value = temposIntervalos;
            }
            
            // Guardar valores no modal para uso posterior (atrav√©s de atributos data)
            const modal = document.getElementById('encerrarSessaoModal');
            modal.dataset.tempoQuestoes = tempoQuestoes;
            modal.dataset.quantQuestoes = quantQuestoes;
            modal.dataset.tempoFlashcards = tempoFlashcards;
            modal.dataset.quantFlashcards = quantFlashcards;
            
            // Fechar modal
            closeEncerrarSessaoModal();
            
            // Scroll para o formul√°rio
            document.getElementById('feedbackForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function obterTempoCronometroMinutos() {
            // CR√çTICO: Sempre calcular baseado em timestamp quando rodando (n√£o depende de intervalos)
            const segundosPrecisos = cronometroRodando ? calcularTempoDecorrido() : cronometroSegundos;
            return Math.floor(segundosPrecisos / 60);
        }
        
        function obterTempoIntervaloMinutos() {
            return Math.floor(tempoTotalIntervalo / 60);
        }
        
        // ==================== LEMBRETES E ANOTA√á√ïES ====================
        
        function calcularProximaDataLembrete(lembrete) {
            if (lembrete.periodicidade === 'pontual') {
                return null; // N√£o tem pr√≥xima data
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const dataInicial = new Date(lembrete.dataInicial + 'T00:00:00');
            const ultimaData = lembrete.ultimaData ? new Date(lembrete.ultimaData + 'T00:00:00') : dataInicial;
            
            let proximaData = new Date(ultimaData);
            
            switch(lembrete.periodicidade) {
                case 'diaria':
                    proximaData.setDate(proximaData.getDate() + 1);
                    break;
                case 'semanal':
                    proximaData.setDate(proximaData.getDate() + 7);
                    break;
                case 'quinzenal':
                    proximaData.setDate(proximaData.getDate() + 15);
                    break;
                case 'mensal':
                    proximaData.setMonth(proximaData.getMonth() + 1);
                    break;
            }
            
            return proximaData.toISOString().split('T')[0];
        }
        
        function renderLembretes() {
            const container = document.getElementById('lembretesContainer');
            if (!container) return;
            
            const hoje = new Date().toISOString().split('T')[0];
            
            // Separar lembretes ativos e conclu√≠dos
            const lembretesAtivos = lembretes.filter(l => !l.concluido && (!l.proximaData || l.proximaData <= hoje));
            const lembretesFuturos = lembretes.filter(l => !l.concluido && l.proximaData && l.proximaData > hoje);
            const lembretesConcluidos = lembretes.filter(l => l.concluido);
            
            if (lembretes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìå</div><div>Nenhum lembrete cadastrado</div></div>';
                return;
            }
            
            let html = '';
            
            // Lembretes ativos (para hoje)
            if (lembretesAtivos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: var(--turquesa-light); margin-bottom: 10px;">üìå Para Hoje</h3>';
                html += lembretesAtivos.map(l => {
                    const proximaDataFormatada = l.proximaData ? formatarData(l.proximaData) : 'Pontual';
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade === 'pontual' ? 'Pontual' : l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.periodicidade !== 'pontual' ? `<button class="btn-edit" onclick="marcarLembreteConcluido(${l.id})" title="Marcar como conclu√≠do">‚úÖ</button>` : ''}
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes futuros
            if (lembretesFuturos.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h3 style="color: rgba(0,206,209,0.7); margin-bottom: 10px;">üìÖ Pr√≥ximos</h3>';
                html += lembretesFuturos.map(l => {
                    const proximaDataFormatada = formatarData(l.proximaData);
                    const tema = l.temaId ? dados.find(t => String(t.id) === String(l.temaId)) : null;
                    const temaInfo = tema ? ` ‚Ä¢ üîó ${tema.area} - ${tema.tema}` : '';
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                        ${l.temaId ? `<a href="#" onclick="navegarParaAnotacao(${l.temaId}); return false;" style="color: var(--turquesa-light); text-decoration: none;">üìî</a> ` : ''}${l.titulo}
                                    </div>
                                    ${l.descricao ? `<div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">${l.descricao}</div>` : ''}
                                    <div style="font-size: 11px; color: rgba(0,206,209,0.6);">
                                        üìÖ ${proximaDataFormatada} ‚Ä¢ ${l.periodicidade.charAt(0).toUpperCase() + l.periodicidade.slice(1)}${temaInfo}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${l.temaId ? `<button class="btn-edit" onclick="navegarParaAnotacao(${l.temaId})" title="Ver anota√ß√µes">üìî</button>` : ''}
                                    <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Lembretes conclu√≠dos (opcional, pode ser ocultado)
            if (lembretesConcluidos.length > 0 && false) { // Desabilitado por enquanto
                html += '<div><h3 style="color: rgba(255,255,255,0.3); margin-bottom: 10px;">‚úÖ Conclu√≠dos</h3>';
                html += lembretesConcluidos.map(l => {
                    return `
                        <div class="task-item" style="margin-bottom: 10px; opacity: 0.5;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="text-decoration: line-through; color: rgba(255,255,255,0.3);">${l.titulo}</div>
                                </div>
                                <button class="btn-edit" onclick="deletarLembrete(${l.id})" title="Deletar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function marcarLembreteConcluido(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            
            if (lembrete.periodicidade === 'pontual') {
                lembrete.concluido = true;
            } else {
                // Atualizar √∫ltima data e calcular pr√≥xima
                const hoje = new Date().toISOString().split('T')[0];
                lembrete.ultimaData = hoje;
                lembrete.proximaData = calcularProximaDataLembrete(lembrete);
            }
            
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('‚úÖ Lembrete atualizado!');
        }
        
        function deletarLembrete(id) {
            if (!confirm('Tem certeza que deseja deletar este lembrete?')) return;
            
            lembretes = lembretes.filter(l => l.id !== id);
            localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
            renderLembretes();
            mostrarNotificacaoFeedback('üóëÔ∏è Lembrete deletado!');
        }
        
        // ==================== CADERNO DE ANOTA√á√ïES ====================
        
        function obterOuCriarAnotacao(temaId) {
            let anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (!anotacao) {
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) return null;
                
                anotacao = {
                    id: Date.now(),
                    temaId: temaId,
                    area: tema.area,
                    tema: tema.tema,
                    conteudo: '',
                    ultimaAtualizacao: new Date().toISOString().split('T')[0]
                };
                anotacoes.push(anotacao);
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            }
            return anotacao;
        }
        
        function navegarParaAnotacao(temaId) {
            // Criar anota√ß√£o se n√£o existir
            obterOuCriarAnotacao(temaId);
            
            // Encontrar a √°rea do tema
            const tema = dados.find(t => String(t.id) === String(temaId));
            if (!tema) return;
            
            // Filtrar caderno para mostrar apenas este tema
            document.getElementById('cadernoFiltroArea').value = tema.area;
            atualizarSelectTemaPorArea(); // Atualizar select de tema
            document.getElementById('cadernoFiltroTema').value = String(temaId);
            
            // Mostrar se√ß√£o caderno
            showSection('caderno');
            
            // Scroll para anota√ß√£o
            setTimeout(() => {
                const elemento = document.querySelector(`[data-tema-id="${temaId}"]`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    elemento.style.background = 'rgba(0,206,209,0.2)';
                    setTimeout(() => {
                        elemento.style.background = '';
                    }, 2000);
                }
            }, 100);
        }
        
        function atualizarSelectsLembrete() {
            const select = document.getElementById('lembreteTemaId');
            if (!select) return;
            
            select.innerHTML = '<option value="">Nenhum (lembrete geral)</option>';
            
            dados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.area} - ${t.tema}`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectsCaderno() {
            const selectArea = document.getElementById('cadernoFiltroArea');
            const selectTema = document.getElementById('cadernoFiltroTema');
            
            if (selectArea) {
                const areas = [...new Set(dados.map(t => t.area))].sort();
                selectArea.innerHTML = '<option value="">Todas as √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    selectArea.appendChild(option);
                });
            }
            
            // Resetar select de tema para desabilitado
            if (selectTema) {
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
            }
        }
        
        function atualizarSelectTemaPorArea() {
            const selectTema = document.getElementById('cadernoFiltroTema');
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            
            if (!selectTema) return;
            
            if (!filtroArea) {
                // Se n√£o h√° √°rea selecionada, desabilitar select de tema
                selectTema.innerHTML = '<option value="">Selecione uma √°rea primeiro</option>';
                selectTema.disabled = true;
                return;
            }
            
            // Habilitar e popular com temas da √°rea selecionada
            selectTema.disabled = false;
            selectTema.innerHTML = '<option value="">Todos os temas desta √°rea</option>';
            
            const temasFiltrados = dados.filter(t => t.area === filtroArea);
            
            temasFiltrados.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.tema; // Mostrar apenas o nome do tema, sem repetir √°rea
                selectTema.appendChild(option);
            });
        }
        
        function filtrarCaderno() {
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            
            renderCaderno(filtroArea, filtroTema);
        }
        
        function renderCaderno(filtroArea = '', filtroTema = '') {
            const container = document.getElementById('cadernoContainer');
            if (!container) return;
            
            // Garantir que todos os temas tenham anota√ß√£o
            dados.forEach(t => {
                obterOuCriarAnotacao(t.id);
            });
            
            let anotacoesFiltradas = anotacoes;
            
            if (filtroArea) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => a.area === filtroArea);
            }
            
            if (filtroTema) {
                anotacoesFiltradas = anotacoesFiltradas.filter(a => String(a.temaId) === String(filtroTema));
            }
            
            // Agrupar por √°rea
            const anotacoesPorArea = {};
            anotacoesFiltradas.forEach(a => {
                if (!anotacoesPorArea[a.area]) {
                    anotacoesPorArea[a.area] = [];
                }
                anotacoesPorArea[a.area].push(a);
            });
            
            if (anotacoesFiltradas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìî</div><div>Nenhuma anota√ß√£o encontrada</div></div>';
                return;
            }
            
            let html = '';
            
            Object.keys(anotacoesPorArea).sort().forEach(area => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 18px;">üìö ${area}</h3>`;
                
                anotacoesPorArea[area].forEach(anotacao => {
                    const tema = dados.find(t => String(t.id) === String(anotacao.temaId));
                    if (!tema) return;
                    
                    html += `
                        <div class="task-item" style="margin-bottom: 20px;" data-tema-id="${anotacao.temaId}">
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; color: var(--cobre-light); margin-bottom: 5px;">
                                    üìù ${anotacao.tema}
                                </div>
                                <div style="font-size: 11px; color: rgba(0,206,209,0.6); margin-bottom: 10px;">
                                    √öltima atualiza√ß√£o: ${formatarData(anotacao.ultimaAtualizacao)}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <textarea 
                                    id="anotacao_${anotacao.temaId}" 
                                    class="form-input" 
                                    rows="6" 
                                    style="width: 100%; font-family: inherit; resize: vertical;"
                                    placeholder="Digite suas anota√ß√µes aqui..."
                                    onblur="salvarAnotacao(${anotacao.temaId})"
                                >${anotacao.conteudo || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-edit" onclick="salvarAnotacao(${anotacao.temaId})" title="Salvar">üíæ</button>
                                <button class="btn-edit" onclick="limparAnotacao(${anotacao.temaId})" title="Limpar">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function salvarAnotacao(temaId) {
            const textarea = document.getElementById(`anotacao_${temaId}`);
            if (!textarea) return;
            
            const anotacao = obterOuCriarAnotacao(temaId);
            if (!anotacao) return;
            
            anotacao.conteudo = textarea.value.trim();
            anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
            
            localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
            mostrarNotificacaoFeedback('‚úÖ Anota√ß√£o salva!');
            
            // Atualizar renderiza√ß√£o
            const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
            const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
            renderCaderno(filtroArea, filtroTema);
        }
        
        function limparAnotacao(temaId) {
            if (!confirm('Tem certeza que deseja limpar esta anota√ß√£o?')) return;
            
            const anotacao = anotacoes.find(a => String(a.temaId) === String(temaId));
            if (anotacao) {
                anotacao.conteudo = '';
                anotacao.ultimaAtualizacao = new Date().toISOString().split('T')[0];
                localStorage.setItem('vrvs_anotacoes', JSON.stringify(anotacoes));
                
                const textarea = document.getElementById(`anotacao_${temaId}`);
                if (textarea) textarea.value = '';
                
                mostrarNotificacaoFeedback('üóëÔ∏è Anota√ß√£o limpa!');
                
                const filtroArea = document.getElementById('cadernoFiltroArea')?.value || '';
                const filtroTema = document.getElementById('cadernoFiltroTema')?.value || '';
                renderCaderno(filtroArea, filtroTema);
            }
        }
        
        // ==================== INICIALIZA√á√ÉO ====================
        
        // Garantir carregamento da logo no MacBook
        function garantirLogoCarregada() {
            const logoImg = document.querySelector('.splash-logo');
            if (!logoImg) return;
            
            // For√ßar recarregamento com timestamp √∫nico para evitar cache
            const timestamp = new Date().getTime();
            const logoPath = './logo.png?v=' + timestamp;
            const logoFallback = './logo.jpeg?v=' + timestamp;
            
            // Criar nova imagem para testar
            const testImg = new Image();
            testImg.onload = function() {
                logoImg.src = logoPath;
            };
            testImg.onerror = function() {
                // Tentar fallback
                const testFallback = new Image();
                testFallback.onload = function() {
                    logoImg.src = logoFallback;
                };
                testFallback.onerror = function() {
                    console.warn('Logo n√£o encontrada, usando fallback');
                };
                testFallback.src = logoFallback;
            };
            testImg.src = logoPath;
        }
        
        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', garantirLogoCarregada);
        } else {
            garantirLogoCarregada();
        }
        
        // ==================== SISTEMA DE TUTORIAL E AJUDA ====================
        
        const passosTutorial = [
            {
                titulo: "üéØ Bem-vindo ao VRVS!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Ol√°! Este √© o <strong>VRVS</strong> - seu sistema de gest√£o de estudos.</p>
                    <p style="margin-bottom: 15px;">Vou te mostrar rapidamente como usar cada funcionalidade.</p>
                    <p style="color: rgba(0,206,209,0.8);">üì± Dica: Voc√™ pode instalar como app no seu celular!</p>
                `
            },
            {
                titulo: "üìä Banco de Dados",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Aqui voc√™:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚úÖ Adiciona novos temas para estudar</li>
                        <li>‚úÖ Define √°rea, status e prioridade</li>
                        <li>‚úÖ Visualiza todos seus temas</li>
                        <li>‚úÖ Edita ou remove temas</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">√â a base de tudo!</p>
                `
            },
            {
                titulo: "üìã Miss√µes do Dia",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Tarefas de hoje e atrasadas:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üéØ Mostra o que voc√™ precisa estudar HOJE</li>
                        <li>‚è±Ô∏è Op√ß√£o de registrar tempo por atividade</li>
                        <li>üí° Diretrizes personalizadas para cada tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìÖ Agenda",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Timeline dos pr√≥ximos dias:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìÜ Filtre por per√≠odo (semana, m√™s)</li>
                        <li>üîç Visualize o que vem pela frente</li>
                        <li>üìå Organize suas revis√µes</li>
                    </ul>
                `
            },
            {
                titulo: "üí¨ Feedback de Sess√£o",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Registre cada sess√£o de estudos:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>‚è±Ô∏è Use o cron√¥metro integrado</li>
                        <li>üìä Avalie seu rendimento</li>
                        <li>‚ùì Registre quest√µes e flashcards</li>
                        <li>üìù Adicione observa√ß√µes</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">Todos os dados s√£o salvos automaticamente!</p>
                `
            },
            {
                titulo: "üìà Estat√≠sticas e An√°lises",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Acompanhe seu progresso:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìä Gr√°ficos de performance</li>
                        <li>‚è±Ô∏è An√°lises de tempo (opcional)</li>
                        <li>üìâ Identifica√ß√£o de pontos fracos</li>
                        <li>üéØ M√©tricas por √°rea e tema</li>
                    </ul>
                `
            },
            {
                titulo: "üìå Extras e Backup",
                conteudo: `
                    <p style="margin-bottom: 10px;"><strong>Outras funcionalidades:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>üìå Lembretes personalizados</li>
                        <li>üìî Caderno de anota√ß√µes</li>
                        <li>üì§ Exportar dados (CSV)</li>
                        <li>üì• Importar dados</li>
                    </ul>
                    <p style="margin-top: 15px; color: rgba(0,206,209,0.8);">üíæ Tudo √© salvo localmente no seu navegador!</p>
                `
            },
            {
                titulo: "‚úÖ Pronto para come√ßar!",
                conteudo: `
                    <p style="margin-bottom: 15px;">Agora voc√™ conhece todas as funcionalidades!</p>
                    <p style="margin-bottom: 15px;"><strong>Pr√≥ximos passos:</strong></p>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>Adicione seus primeiros temas na aba "Dados"</li>
                        <li>Configure a agenda</li>
                        <li>Comece a estudar e registre suas sess√µes</li>
                    </ol>
                    <p style="margin-top: 15px; color: var(--turquesa-light);">‚ùì D√∫vidas? Use o bot√£o de ajuda no canto da tela!</p>
                `
            }
        ];
        
        let passoAtual = 0;
        
        function iniciarTutorial() {
            passoAtual = 0;
            mostrarPassoTutorial();
            document.getElementById('tutorialModal').style.display = 'flex';
        }
        
        function mostrarPassoTutorial() {
            const passo = passosTutorial[passoAtual];
            document.getElementById('tutorialTitulo').textContent = passo.titulo;
            document.getElementById('tutorialConteudo').innerHTML = passo.conteudo;
            document.getElementById('tutorialProgresso').textContent = `Passo ${passoAtual + 1} de ${passosTutorial.length}`;
            
            // Atualizar bot√µes
            document.getElementById('btnAnterior').style.display = passoAtual === 0 ? 'none' : 'block';
            document.getElementById('btnProximo').textContent = passoAtual === passosTutorial.length - 1 ? 'Finalizar ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function tutorialProximo() {
            if (passoAtual < passosTutorial.length - 1) {
                passoAtual++;
                mostrarPassoTutorial();
            } else {
                finalizarTutorial();
            }
        }
        
        function tutorialAnterior() {
            if (passoAtual > 0) {
                passoAtual--;
                mostrarPassoTutorial();
            }
        }
        
        function pularTutorial() {
            if (confirm('Tem certeza que deseja pular o tutorial?')) {
                finalizarTutorial();
            }
        }
        
        function fecharTutorial() {
            finalizarTutorial();
        }
        
        function finalizarTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            localStorage.setItem('vrvs_tutorial_completo', 'true');
        }
        
        // ==================== V√çDEO ANIMADO TUTORIAL ====================
        
        const slidesVideo = [
            {
                titulo: "üß† Bem-vindo ao VRVS",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">üß†</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Sistema de Gest√£o de Estudos</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Uma plataforma completa para organizar seus estudos, acompanhar seu progresso e melhorar seu desempenho.
                    </p>
                `
            },
            {
                titulo: "üìä Organize seus Temas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Adicione e Organize</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Cadastre seus temas por √°rea, defina prioridades e datas. Tudo organizado em um s√≥ lugar.
                    </p>
                `
            },
            {
                titulo: "üìã Miss√µes do Dia",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">O que Estudar Hoje?</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Veja suas tarefas do dia e receba diretrizes personalizadas para cada tema. Registre o tempo gasto em quest√µes e flashcards.
                    </p>
                `
            },
            {
                titulo: "üí¨ Registre suas Sess√µes",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üí¨</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Acompanhe seu Progresso</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Use o cron√¥metro integrado, registre seu rendimento, quest√µes e flashcards. Tudo salvo automaticamente.
                    </p>
                `
            },
            {
                titulo: "üìà An√°lises Detalhadas",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px;">üìà</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Veja seu Desempenho</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Gr√°ficos, estat√≠sticas por √°rea, an√°lises de tempo. Identifique seus pontos fortes e fracos.
                    </p>
                `
            },
            {
                titulo: "‚úÖ Pronto para Come√ßar!",
                conteudo: `
                    <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">‚úÖ</div>
                    <h3 style="color: var(--turquesa-light); margin-bottom: 15px; font-size: 20px;">Comece Agora</h3>
                    <p style="color: rgba(255,255,255,0.8); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                        Adicione seus primeiros temas e comece a estudar de forma mais organizada e eficiente.
                    </p>
                `
            }
        ];
        
        let slideAtualVideo = 0;
        
        function mostrarSlideVideo() {
            const slide = slidesVideo[slideAtualVideo];
            document.getElementById('videoSlide').innerHTML = slide.conteudo;
            document.getElementById('videoProgresso').textContent = `${slideAtualVideo + 1} / ${slidesVideo.length}`;
            
            document.getElementById('btnVideoAnterior').style.display = slideAtualVideo === 0 ? 'none' : 'block';
            document.getElementById('btnVideoProximo').textContent = slideAtualVideo === slidesVideo.length - 1 ? 'Fim ‚úì' : 'Pr√≥ximo ‚ñ∂';
        }
        
        function videoProximo() {
            if (slideAtualVideo < slidesVideo.length - 1) {
                slideAtualVideo++;
                mostrarSlideVideo();
            }
        }
        
        function videoAnterior() {
            if (slideAtualVideo > 0) {
                slideAtualVideo--;
                mostrarSlideVideo();
            }
        }
        
        // Inicializar v√≠deo ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            mostrarSlideVideo();
        });
        
        // ==================== FAQ INTELIGENTE ====================
        
        const faqRespostas = {
            adicionar: {
                titulo: "Como adicionar um tema?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üìä Dados</strong><br>
                    2. Preencha o formul√°rio no topo:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea (ex: Ortopedia)<br>
                       &nbsp;&nbsp;‚Ä¢ Tema (ex: Fraturas do √∫mero)<br>
                       &nbsp;&nbsp;‚Ä¢ Status, Prioridade, Data<br>
                    3. Clique em <strong>üíæ SALVAR</strong><br><br>
                    Pronto! O tema aparecer√° na tabela abaixo.
                `
            },
            feedback: {
                titulo: "Como registrar uma sess√£o?",
                texto: `
                    <strong>Passo a passo:</strong><br><br>
                    1. V√° para a aba <strong>üí¨ Feedback</strong><br>
                    2. Use o <strong>‚è±Ô∏è Cron√¥metro</strong> durante o estudo<br>
                    3. Ao terminar, clique em <strong>Encerrar Sess√£o</strong><br>
                    4. Preencha:<br>
                       &nbsp;&nbsp;‚Ä¢ √Årea e Tema estudado<br>
                       &nbsp;&nbsp;‚Ä¢ Tempo, rendimento<br>
                       &nbsp;&nbsp;‚Ä¢ Quest√µes e flashcards<br>
                       &nbsp;&nbsp;‚Ä¢ Observa√ß√µes<br>
                    5. Clique em <strong>SALVAR FEEDBACK</strong><br><br>
                    Seus dados s√£o salvos automaticamente!
                `
            },
            agenda: {
                titulo: "Como usar a agenda?",
                texto: `
                    <strong>A agenda mostra suas pr√≥ximas revis√µes:</strong><br><br>
                    ‚Ä¢ Filtre por per√≠odo usando os campos de data<br>
                    ‚Ä¢ Clique em <strong>Semana Atual</strong> para ver os pr√≥ximos 7 dias<br>
                    ‚Ä¢ Cada tema mostra: √°rea, prioridade, rendimento<br>
                    ‚Ä¢ A data de agenda √© definida ao adicionar/editar o tema<br><br>
                    <strong>Dica:</strong> Use para planejar sua semana de estudos!
                `
            },
            stats: {
                titulo: "Como ver estat√≠sticas?",
                texto: `
                    <strong>V√°rias formas de analisar seus dados:</strong><br><br>
                    üìà <strong>Aba Gr√°ficos:</strong> Visualiza√ß√µes gerais<br>
                    üîç <strong>Aba An√°lises:</strong> Dados detalhados por √°rea/tema<br>
                    ‚è±Ô∏è <strong>An√°lises de Tempo:</strong> Clique no bot√£o para mostrar<br>
                    üìú <strong>Aba Hist√≥rico:</strong> Todas as sess√µes registradas<br><br>
                    Use os filtros para focar em per√≠odos espec√≠ficos!
                `
            },
            backup: {
                titulo: "Como fazer backup?",
                texto: `
                    <strong>Seus dados j√° s√£o salvos automaticamente!</strong><br><br>
                    Mas voc√™ pode fazer backup extra:<br><br>
                    1. V√° para a aba <strong>üì§ Exportar</strong><br>
                    2. Clique em <strong>üìä Baixar DADOS.csv</strong><br>
                    3. Ou <strong>üìú Baixar HISTORICO.csv</strong><br><br>
                    Os arquivos CSV podem ser abertos no Excel ou Google Sheets.<br><br>
                    <strong>Importante:</strong> Dados ficam no navegador. Se limpar cache, pode perder tudo!
                `
            }
        };
        
        function mostrarResposta(tipo) {
            const resposta = faqRespostas[tipo];
            document.getElementById('perguntaAssistente').value = resposta.titulo;
            document.getElementById('textoResposta').innerHTML = resposta.texto;
            document.getElementById('respostaAssistente').style.display = 'block';
            
            // Scroll suave at√© a resposta
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function responderDuvida() {
            const pergunta = document.getElementById('perguntaAssistente').value.toLowerCase();
            let resposta = '';
            
            // Sistema simples de palavras-chave
            if (pergunta.includes('adicionar') || pergunta.includes('novo') || pergunta.includes('criar') || pergunta.includes('tema')) {
                resposta = faqRespostas.adicionar.texto;
            } else if (pergunta.includes('feedback') || pergunta.includes('sess√£o') || pergunta.includes('registrar') || pergunta.includes('cron√¥metro')) {
                resposta = faqRespostas.feedback.texto;
            } else if (pergunta.includes('agenda') || pergunta.includes('timeline') || pergunta.includes('pr√≥xim')) {
                resposta = faqRespostas.agenda.texto;
            } else if (pergunta.includes('estat√≠stica') || pergunta.includes('gr√°fico') || pergunta.includes('an√°lise') || pergunta.includes('performance')) {
                resposta = faqRespostas.stats.texto;
            } else if (pergunta.includes('backup') || pergunta.includes('exportar') || pergunta.includes('salvar') || pergunta.includes('perder')) {
                resposta = faqRespostas.backup.texto;
            } else if (pergunta.includes('tempo') || pergunta.includes('quest√µes') || pergunta.includes('flashcard')) {
                resposta = `
                    <strong>Registrando tempo por atividade:</strong><br><br>
                    1. Na aba <strong>üìã Miss√µes</strong> ou <strong>üìÖ Agenda</strong><br>
                    2. Clique no bot√£o <strong>‚è±Ô∏è Mostrar Tempos</strong><br>
                    3. Preencha os campos opcionais de cada tema<br>
                    4. Os dados ser√£o inclu√≠dos nas an√°lises<br><br>
                    Voc√™ tamb√©m pode registrar no Feedback de Sess√£o!
                `;
            } else if (pergunta.includes('como') || pergunta.includes('usar') || pergunta.includes('funciona')) {
                resposta = `
                    <strong>N√£o encontrei uma resposta espec√≠fica.</strong><br><br>
                    Tente uma destas op√ß√µes:<br>
                    ‚Ä¢ Clique nos bot√µes de perguntas frequentes acima<br>
                    ‚Ä¢ Inicie o <strong>Tour Guiado</strong> no topo da p√°gina<br>
                    ‚Ä¢ Seja mais espec√≠fico na pergunta<br><br>
                    <strong>Exemplos de perguntas:</strong><br>
                    "Como adicionar tema?"<br>
                    "Como fazer backup?"<br>
                    "Como ver estat√≠sticas?"
                `;
            } else {
                resposta = `
                    <strong>Desculpe, n√£o entendi sua d√∫vida.</strong><br><br>
                    Clique em uma das <strong>Perguntas Frequentes</strong> acima ou<br>
                    inicie o <strong>üöÄ Tour Guiado</strong> para conhecer a plataforma!
                `;
            }
            
            document.getElementById('textoResposta').innerHTML = resposta;
            document.getElementById('respostaAssistente').style.display = 'block';
            document.getElementById('respostaAssistente').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Enter para buscar resposta
        document.addEventListener('DOMContentLoaded', function() {
            const inputPergunta = document.getElementById('perguntaAssistente');
            if (inputPergunta) {
                inputPergunta.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        responderDuvida();
                    }
                });
            }
        });
        
        // ==================== WINDOW ONLOAD ====================
        
        window.onload = function() {
            // Garantir logo novamente ap√≥s carregamento completo
            garantirLogoCarregada();
            
            // Restaurar cron√¥metro se estava rodando antes
            restaurarCronometro();
            
            // Verificar se √© primeira vez e mostrar tutorial
            const tutorialCompleto = localStorage.getItem('vrvs_tutorial_completo');
            if (!tutorialCompleto) {
                setTimeout(() => {
                    if (confirm('üëã Primeira vez aqui? Gostaria de fazer um tour r√°pido pela plataforma?')) {
                        iniciarTutorial();
                    } else {
                        localStorage.setItem('vrvs_tutorial_completo', 'true');
                    }
                }, 1000);
            }
            
            // Page Visibility API - Detectar quando aba sai/volta ao foco
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Aba saiu de foco - salvar estado atual (funciona offline)
                    if (cronometroRodando || intervaloAtivo) {
                        salvarEstadoCronometro();
                        console.log('üì± Aba em segundo plano - cron√¥metro continua contando');
                    }
                } else {
                    // Aba voltou ao foco - restaurar e calcular tempo decorrido BASEADO EM TIMESTAMP ORIGINAL
                    const timestampOriginal = localStorage.getItem('vrvs_cronometro_timestamp');
                    const segundosOriginais = localStorage.getItem('vrvs_cronometro_segundos');
                    
                    if (timestampOriginal && segundosOriginais) {
                        const agora = Date.now();
                        const tempoDecorrido = Math.floor((agora - parseInt(timestampOriginal)) / 1000);
                        
                        // Atualizar cron√¥metro principal baseado no timestamp original
                        cronometroSegundos = parseInt(segundosOriginais) + tempoDecorrido;
                        
                        // Restaurar outros dados
                        const salvo = localStorage.getItem('vrvs_cronometro');
                        if (salvo) {
                            try {
                                const dados = JSON.parse(salvo);
                                tempoTotalIntervalo = dados.tempoIntervalo || 0;
                                
                                // Se estava em intervalo, atualizar intervalo tamb√©m
                                if (dados.intervaloAtivo) {
                                    intervaloAtivo = true;
                                    const intervaloOriginal = dados.intervaloSegundos || 0;
                                    intervaloSegundos = intervaloOriginal + tempoDecorrido;
                                    
                                    // Reiniciar timer do intervalo se necess√°rio
                                    if (intervaloInterval) {
                                        clearInterval(intervaloInterval);
                                    }
                                    intervaloInterval = setInterval(() => {
                                        // Calcular baseado em timestamp para intervalo tamb√©m
                                        const agoraIntervalo = Date.now();
                                        const tempoDecorridoIntervalo = Math.floor((agoraIntervalo - parseInt(timestampOriginal)) / 1000);
                                        intervaloSegundos = intervaloOriginal + tempoDecorridoIntervalo;
                                        document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                                    }, 100);
                                    
                                    document.getElementById('cronometroIntervalo').textContent = '‚ñ∂Ô∏è Finalizar Intervalo';
                                    document.getElementById('tempoIntervalo').style.display = 'block';
                                    document.getElementById('tempoIntervaloDisplay').textContent = formatarTempoCronometro(intervaloSegundos);
                                }
                                
                                // Se estava rodando, garantir que continue rodando
                                if (dados.rodando && !cronometroRodando) {
                                    cronometroInicioTimestamp = parseInt(timestampOriginal);
                                    iniciarCronometroContagem();
                                    document.getElementById('cronometroToggle').textContent = '‚è∏Ô∏è Pausar';
                                } else if (dados.rodando && cronometroRodando) {
                                    // J√° est√° rodando, apenas atualizar display
                                    atualizarDisplayCronometro();
                                }
                                
                                console.log('üì± Aba voltou ao foco - cron√¥metro atualizado (+' + tempoDecorrido + 's)');
                            } catch (e) {
                                console.log('Erro ao restaurar:', e);
                            }
                        }
                    }
                }
            });
            
            // Tamb√©m salvar antes de fechar a p√°gina
            window.addEventListener('beforeunload', function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            });
            
            // Salvar periodicamente enquanto est√° rodando (a cada 30 segundos)
            setInterval(function() {
                if (cronometroRodando || intervaloAtivo) {
                    salvarEstadoCronometro();
                }
            }, 30000); // Salvar a cada 30 segundos
            
            // Registrar Service Worker para funcionamento offline
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' }).then((registration) => {
                    console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
                    
                    // Verificar atualiza√ß√µes periodicamente
                    setInterval(() => {
                        registration.update();
                    }, 60000); // Verificar a cada minuto
                    
                    // For√ßar atualiza√ß√£o ao carregar
                    registration.update();
                }).catch((error) => {
                    console.log('‚ö†Ô∏è Erro ao registrar Service Worker:', error);
                });
            }
            
            // Splash Screen - Esconder ap√≥s carregar
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.classList.add('fade-out');
                    document.body.classList.remove('splash-loading');
                    setTimeout(() => {
                        splash.classList.add('hidden');
                    }, 800);
                }
            }, 2500); // Mostrar por 2.5 segundos
            
            // Inicializar campo de data com hoje
            document.getElementById('feedbackData').value = new Date().toISOString().split('T')[0];
            
            // Inicializar data inicial do lembrete com hoje
            document.getElementById('lembreteDataInicial').value = new Date().toISOString().split('T')[0];
            
            // Event listeners para filtros de agenda
            document.getElementById('agendaDataInicio').addEventListener('change', renderAgenda);
            document.getElementById('agendaDataFim').addEventListener('change', renderAgenda);
            
            // CADASTRO FORM
            document.getElementById('cadastroForm').onsubmit = function(e) {
                e.preventDefault();
                const area = document.getElementById('novaArea').value.trim();
                const tema = document.getElementById('novoTema').value.trim();
                const prioridade = parseInt(document.getElementById('novaPrioridade').value);
                const status = document.getElementById('novaStatus').value;
                const dataInicio = document.getElementById('novaDataInicio').value;
                
                const novoTema = {
                    id: Date.now(),
                    area: normalizeArea(area, tema),
                    tema: tema,
                    status: status,
                    prioridade: prioridade,
                    dificuldade: 'M√©dia',
                    rendimento: 0,
                    sessoes: 0,
                    ultEstudo: '',
                    agenda: dataInicio || '',
                    tempo: 0,
                    observacoes: '',
                    contador80: 0,
                    sugestao: ''
                };
                
                dados.push(novoTema);
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                this.reset();
                mostrarNotificacaoFeedback('‚úÖ Tema adicionado com sucesso!');
                renderDados();
                updateFeedbackSelect();
                renderPendencias();
            };
            
            // FEEDBACK FORM - 100% FUNCIONANDO!
            document.getElementById('feedbackArea').addEventListener('change', updateFeedbackTemaSelect);
            document.getElementById('feedbackForm').onsubmit = function(e) {
                e.preventDefault();
                const temaId = document.getElementById('feedbackTema').value;
                // CORRE√á√ÉO: Usar data do formul√°rio (input feedbackData)
                const dataSessao = document.getElementById('feedbackData').value;
                if (!dataSessao) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Selecione uma data para a sess√£o!', 'error');
                    return;
                }
                const rendimento = parseInt(document.getElementById('feedbackRendimento').value);
                const tempoInput = document.getElementById('feedbackTempo');
                // Usar tempo do cron√¥metro se dispon√≠vel, sen√£o usar o input
                const tempo = cronometroSegundos > 0 ? obterTempoCronometroMinutos() : (parseInt(tempoInput.value) || 0);
                const tempoIntervalo = obterTempoIntervaloMinutos(); // Tempo de intervalo em minutos
                // Se usar cron√¥metro, atualizar o campo de input tamb√©m
                if (cronometroSegundos > 0) {
                    tempoInput.value = tempo;
                }
                
                // Novos campos opcionais
                const numeroIntervalos = parseInt(document.getElementById('feedbackNumeroIntervalos').value) || 0;
                const intervalosTexto = document.getElementById('feedbackIntervalos').value.trim() || '';
                const questoesTexto = document.getElementById('feedbackQuestoes').value.trim() || '';
                const flashcards = parseInt(document.getElementById('feedbackFlashcards').value) || 0;
                
                // Extrair dados de quest√µes (formato: acertos/total)
                let tempoQuestoes = 0;
                let quantQuestoes = 0;
                let quantQuestoesAcertos = 0;
                if (questoesTexto && questoesTexto.includes('/')) {
                    const partes = questoesTexto.split('/');
                    quantQuestoesAcertos = parseInt(partes[0]) || 0;
                    quantQuestoes = parseInt(partes[1]) || 0;
                }
                // Tentar obter tempo de quest√µes do modal ou usar 0
                const modal = document.getElementById('encerrarSessaoModal');
                if (modal && modal.dataset.tempoQuestoes) {
                    tempoQuestoes = parseInt(modal.dataset.tempoQuestoes) || 0;
                }
                
                // Extrair dados de flashcards
                let tempoFlashcards = 0;
                let quantFlashcards = 0;
                if (flashcards > 0) {
                    quantFlashcards = flashcards;
                    if (modal && modal.dataset.tempoFlashcards) {
                        tempoFlashcards = parseInt(modal.dataset.tempoFlashcards) || 0;
                    }
                }
                
                const sugestao = document.getElementById('feedbackSugestao').value.trim();
                const obs = document.getElementById('feedbackObs').value.trim();
                
                // CORRE√á√ÉO: Compara√ß√£o correta de IDs
                const tema = dados.find(t => String(t.id) === String(temaId));
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è M√≥dulo n√£o encontrado! Selecione um m√≥dulo v√°lido.', 'error');
                    return;
                }
                
                // Atualizar contador80
                if (rendimento >= 80) {
                    tema.contador80 = (tema.contador80 || 0) + 1;
                } else {
                    tema.contador80 = 0;
                }
                
                // Atualizar dados do tema
                tema.rendimento = rendimento / 100;
                tema.sessoes = (tema.sessoes || 0) + 1;
                tema.ultEstudo = dataSessao;
                // CORRE√á√ÉO: Passar dataSessao para calcular baseado na data do feedback, n√£o na data atual
                tema.agenda = calcularProximaRevisao(tema, dataSessao);
                tema.tempo = (tema.tempo || 0) + tempo;
                tema.status = tema.sessoes === 1 ? 'Em estudo' : tema.status;
                
                // Adicionar observa√ß√µes E sugest√£o
                let novaObs = '';
                if (obs) novaObs = `${dataSessao}: ${obs}`;
                
                // Adicionar novos dados √†s observa√ß√µes se preenchidos
                if (questoesTexto) {
                    novaObs += (novaObs ? ' | ' : '') + `Q${questoesTexto}`;
                }
                if (flashcards > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `FC${flashcards}`;
                }
                if (numeroIntervalos > 0) {
                    novaObs += (novaObs ? ' | ' : '') + `Intervalos: ${numeroIntervalos} (${intervalosTexto || 'registrados'})`;
                }
                
                if (sugestao) novaObs += (novaObs ? ' | ' : '') + `Sugest√£o: ${sugestao}`;
                
                if (novaObs) {
                    tema.observacoes = tema.observacoes 
                        ? tema.observacoes + '\n' + novaObs
                        : novaObs;
                }
                
                // SALVAR SUGEST√ÉO NO TEMA
                tema.sugestao = sugestao || '';
                
                // ADICIONAR AO HIST√ìRICO
                const { area: areaCorrigida, tema: temaCorrigido } = fixAreaTema(tema.area, tema.tema);
                historico.push({
                    id: Date.now(),
                    temaId: tema.id,
                    area: areaCorrigida,
                    tema: temaCorrigido,
                    rendimento: rendimento / 100,
                    tempo: tempo,
                    tempoIntervalo: tempoIntervalo || 0, // Tempo de intervalo em minutos
                    numeroIntervalos: numeroIntervalos, // N√∫mero de intervalos
                    intervalos: intervalosTexto, // Tempos de cada intervalo
                    tempoQuestoes: tempoQuestoes, // Tempo gasto em quest√µes (min)
                    quantQuestoes: quantQuestoes, // Quantidade total de quest√µes
                    quantQuestoesAcertos: quantQuestoesAcertos, // Quantidade de acertos
                    tempoFlashcards: tempoFlashcards, // Tempo gasto em flashcards (min)
                    quantFlashcards: quantFlashcards, // Quantidade de flashcards revisados
                    questoes: questoesTexto, // Quest√µes (acertos/total) - mantido para compatibilidade
                    flashcards: quantFlashcards, // Quantidade de flashcards - mantido para compatibilidade
                    data: dataSessao,
                    observacoes: obs || '-',
                    sugestao: sugestao || '-'
                });
                
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                localStorage.setItem('vrvs_historico', JSON.stringify(historico));
                
                this.reset();
                document.getElementById('feedbackData').value = new Date().toISOString().split('T')[0];
                // Limpar campos opcionais tamb√©m
                document.getElementById('feedbackNumeroIntervalos').value = '0';
                document.getElementById('feedbackIntervalos').value = '';
                document.getElementById('feedbackQuestoes').value = '';
                document.getElementById('feedbackFlashcards').value = '';
                
                // Resetar cron√¥metro ap√≥s salvar (incluindo tempo de intervalo)
                resetCronometro();
                
                // NOTIFICA√á√ÉO DE SUCESSO!
                const proximaData = formatarData(tema.agenda);
                mostrarNotificacaoFeedback(`‚úÖ Performance registrada!<br>üìÖ Pr√≥xima revis√£o: ${proximaData}`);
                
                renderTarefas();
                renderAgenda();
                renderDados();
                renderHistorico();
                renderPendencias();
                updateStats();
            };
            
            // EDIT FORM
            document.getElementById('editForm').onsubmit = function(e) {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const tema = dados.find(t => String(t.id) === String(id));
                
                if (!tema) {
                    mostrarNotificacaoFeedback('‚ö†Ô∏è Tema n√£o encontrado!', 'error');
                    return;
                }
                
                tema.area = normalizeArea(document.getElementById('editArea').value.trim());
                tema.tema = document.getElementById('editTema').value.trim();
                tema.prioridade = parseInt(document.getElementById('editPrioridade').value);
                const novoStatus = document.getElementById('editStatus').value;
                tema.status = novoStatus;
                
                // CORRE√á√ÉO: Se mudou para Conclu√≠do ou Suspenso, limpar agenda
                if (novoStatus === 'Conclu√≠do' || novoStatus === 'Suspenso') {
                    tema.agenda = '';
                } else {
                    // Recalcular agenda se necess√°rio
                    if (tema.sessoes > 0) {
                        tema.agenda = calcularProximaRevisao(tema);
                    }
                }
                
                localStorage.setItem('vrvs_dados', JSON.stringify(dados));
                
                closeEditModal();
                mostrarNotificacaoFeedback('‚úÖ Tema atualizado com sucesso!');
                
                renderDados();
                renderTarefas();
                renderAgenda();
                renderPendencias();
                updateFeedbackSelect();
            };
            
            // LEMBRETE FORM
            document.getElementById('lembreteForm').onsubmit = function(e) {
                e.preventDefault();
                const titulo = document.getElementById('lembreteTitulo').value.trim();
                const descricao = document.getElementById('lembreteDescricao').value.trim();
                const periodicidade = document.getElementById('lembretePeriodicidade').value;
                const temaId = document.getElementById('lembreteTemaId').value;
                const dataInicial = document.getElementById('lembreteDataInicial').value;
                
                const novoLembrete = {
                    id: Date.now(),
                    titulo: titulo,
                    descricao: descricao || '',
                    periodicidade: periodicidade,
                    temaId: temaId || null,
                    dataInicial: dataInicial,
                    proximaData: periodicidade === 'pontual' ? dataInicial : calcularProximaDataLembrete({
                        periodicidade: periodicidade,
                        dataInicial: dataInicial,
                        ultimaData: null
                    }),
                    ultimaData: null,
                    concluido: false
                };
                
                lembretes.push(novoLembrete);
                localStorage.setItem('vrvs_lembretes', JSON.stringify(lembretes));
                
                mostrarNotificacaoFeedback('‚úÖ Lembrete adicionado com sucesso!');
                
                // Limpar formul√°rio
                this.reset();
                document.getElementById('lembreteDataInicial').value = new Date().toISOString().split('T')[0];
                
                renderLembretes();
            };
            
            // Inicializa√ß√µes
            renderTarefas();
            renderAgenda();
            renderDados();
            renderPendencias();
            updateFeedbackSelect();
            updateStats();
            renderHistorico();
            atualizarSelectsLembrete();
            renderLembretes();
            atualizarSelectsCaderno();
            renderCaderno();
        };
    </script>
</body>
</html>
